<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional To-Do App</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Flatpickr for Date picking -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #5D5CDE;
            --secondary-color: #9897FF;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --info-color: #17A2B8;
            --dark-color: #343A40;
            --light-color: #F8F9FA;
            --gray-color: #6C757D;
            --white-color: #FFFFFF;
            --black-color: #000000;
            
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.25rem;
            --font-size-xl: 1.5rem;
            --font-size-xxl: 2rem;
        }
        
        .dark-mode {
            --primary-color: #6665e7;
            --secondary-color: #9897FF;
            --bg-color: #181818;
            --card-bg: #252525;
            --text-color: #FFFFFF;
            --border-color: #3A3A3A;
            --input-bg: #333333;
            --hover-color: #3A3A3A;
        }
        
        .light-mode {
            --primary-color: #5D5CDE;
            --secondary-color: #9897FF;
            --bg-color: #FFFFFF;
            --card-bg: #FFFFFF;
            --text-color: #333333;
            --border-color: #E5E5E5;
            --input-bg: #F5F5F5;
            --hover-color: #F5F5F5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color var(--transition-normal), 
                        color var(--transition-normal),
                        border-color var(--transition-normal);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Login & Registration Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .auth-card {
            width: 100%;
            max-width: 450px;
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 40px;
            text-align: center;
            animation: fadeIn 0.6s ease;
        }
        
        .auth-card h2 {
            margin-bottom: 30px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: var(--font-size-xl);
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .input-group input, 
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: all var(--transition-fast);
        }
        
        .input-group input:focus, 
        .input-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
            outline: none;
        }
        
        .auth-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            margin: 30px 0 20px;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(93, 92, 222, 0.4);
        }
        
        .auth-btn:active {
            transform: translateY(0);
        }
        
        /* Login button glow effect */
        .auth-btn::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 60%);
            transition: all 1.5s linear;
            transform: rotate(0deg);
        }
        
        .auth-btn:hover::before {
            transform: rotate(360deg);
        }
        
        .auth-link {
            margin-top: 20px;
            color: var(--text-color);
        }
        
        .auth-link a {
            color: #00008B;
            text-decoration: none;
            font-weight: 600;
            transition: all var(--transition-fast);
        }
        
        .auth-link a:hover {
            text-decoration: underline;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            cursor: pointer;
        }
        
        .logo h1 {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .task-timer {
            background-color: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: var(--radius-md);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-sm);
        }
        
        .timer-display {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .timer-actions {
            display: flex;
            gap: 5px;
        }
        
        .timer-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: transform var(--transition-fast);
        }
        
        .timer-btn:hover {
            transform: scale(1.1);
        }
        
        .mode-switcher {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: var(--font-size-lg);
            transition: transform var(--transition-fast);
        }
        
        .mode-switcher:hover {
            transform: scale(1.1);
        }
        
        .user-profile {
            position: relative;
        }
        
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            transition: transform var(--transition-fast);
        }
        
        .profile-img:hover {
            transform: scale(1.05);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--font-size-xs);
            font-weight: 600;
            cursor: pointer;
        }
        
        .status-indicator {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success-color);
            border: 2px solid var(--card-bg);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            width: 200px;
            z-index: 100;
            overflow: hidden;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .dropdown-item {
            padding: 12px 20px;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dropdown-item:hover {
            background-color: var(--hover-color);
        }
        
        .dropdown-item i {
            color: var(--primary-color);
            font-size: var(--font-size-md);
        }
        
        .notifications-panel {
            position: absolute;
            top: 50px;
            right: -100px;
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .notification-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .notification-item:hover {
            background-color: var(--hover-color);
        }
        
        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .notification-content {
            font-size: var(--font-size-sm);
            color: var(--text-color);
        }
        
        .notification-time {
            font-size: var(--font-size-xs);
            color: var(--gray-color);
            margin-top: 5px;
            text-align: right;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Task Summary Styles */
        .task-summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .total-tasks {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            text-align: center;
            border: 2px solid #000;
            animation: fadeIn 0.5s ease;
        }
        
        .total-tasks h3 {
            font-size: var(--font-size-lg);
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .total-tasks .count {
            font-size: var(--font-size-xxl);
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .tasks-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .status-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            text-align: center;
            transition: transform var(--transition-fast);
            animation: fadeIn 0.5s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .status-card h3 {
            font-size: var(--font-size-lg);
            margin-bottom: 15px;
        }
        
        .status-card .count {
            font-size: var(--font-size-xxl);
            font-weight: 700;
        }
        
        .completed-card {
            border-left: 5px solid var(--success-color);
        }
        
        .completed-card h3, .completed-card .count {
            color: var(--success-color);
        }
        
        .pending-card {
            border-left: 5px solid var(--warning-color);
        }
        
        .pending-card h3, .pending-card .count {
            color: var(--warning-color);
        }
        
        /* Task Section Styles */
        .task-section {
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .section-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: var(--radius-md);
            border: none;
            font-size: var(--font-size-sm);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-label {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .filter-select, .search-input {
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: all var(--transition-fast);
        }
        
        .filter-select:focus, .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
            outline: none;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding-left: 35px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='18' height='18'%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3Cpath d='M18.031 16.617l4.283 4.282-1.415 1.415-4.282-4.283A8.96 8.96 0 0 1 11 20c-4.968 0-9-4.032-9-9s4.032-9 9-9 9 4.032 9 9a8.96 8.96 0 0 1-1.969 5.617zm-2.006-.742A6.977 6.977 0 0 0 18 11c0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7a6.977 6.977 0 0 0 4.875-1.975l.15-.15z' fill='rgba(150,150,150,0.8)'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }
        
        .view-toggle {
            display: flex;
            gap: 5px;
            background-color: var(--input-bg);
            border-radius: var(--radius-md);
            padding: 3px;
            margin-left: auto;
        }
        
        .view-toggle button {
            background: none;
            border: none;
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-color);
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .undo-redo {
            display: flex;
            gap: 5px;
        }
        
        .undo-redo button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: var(--font-size-md);
            padding: 5px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        
        .undo-redo button:hover {
            background-color: var(--hover-color);
        }
        
        .undo-redo button:disabled {
            color: var(--gray-color);
            cursor: not-allowed;
        }
        
        /* Task List Styles */
        .tasks-container {
            margin-bottom: 30px;
        }
        
        .task-view {
            display: none;
        }
        
        .task-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .task-item {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 15px 20px;
            position: relative;
            cursor: grab;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            animation: fadeIn 0.3s ease;
            border-left: 5px solid var(--success-color);
        }
        
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .task-item.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }
        
        .task-item.expired {
            border-left-color: var(--danger-color);
        }
        
        .task-item.due-soon {
            border-left-color: var(--warning-color);
        }
        
        .task-item.completed {
            border-left-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .task-title-area {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .task-checkbox {
            min-width: 20px;
            min-height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }
        
        .task-checkbox.checked::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .task-title {
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
            font-size: var(--font-size-md);
        }
        
        .task-title.completed {
            text-decoration: line-through;
            color: var(--gray-color);
        }
        
        .task-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .task-badge {
            font-size: var(--font-size-xs);
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .badge-due-date {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info-color);
        }
        
        .badge-priority {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }
        
        .badge-priority.high {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .badge-priority.medium {
            background-color: rgba(253, 126, 20, 0.2);
            color: #FD7E14;
        }
        
        .badge-priority.low {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--gray-color);
        }
        
        .badge-category {
            background-color: rgba(93, 92, 222, 0.2);
            color: var(--primary-color);
        }
        
        .task-description {
            margin: 10px 0;
            color: var(--text-color);
            font-size: var(--font-size-sm);
        }
        
        .task-subtasks {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            font-size: var(--font-size-sm);
            color: var(--text-color);
        }
        
        .subtask-checkbox {
            min-width: 16px;
            min-height: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .subtask-checkbox.checked::after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 12px;
            font-weight: bold;
        }
        
        .subtask-title {
            margin: 0;
        }
        
        .subtask-title.completed {
            text-decoration: line-through;
            color: var(--gray-color);
        }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .task-timer-info {
            font-size: var(--font-size-xs);
            color: var(--gray-color);
        }
        
        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .task-btn {
            border: none;
            background: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: var(--font-size-sm);
            padding: 5px;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }
        
        .task-btn:hover {
            background-color: var(--hover-color);
        }
        
        .task-btn-play {
            color: var(--success-color);
        }
        
        .task-btn-pause {
            color: var(--warning-color);
        }
        
        .task-btn-view {
            color: var(--info-color);
        }
        
        .task-btn-edit {
            color: var(--primary-color);
        }
        
        .task-btn-share {
            color: var(--primary-color);
        }
        
        .task-btn-delete {
            color: var(--danger-color);
        }
        
        .multi-select-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 30px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            z-index: 90;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            animation: slideUp 0.3s forwards;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .multi-select-info {
            font-weight: 500;
        }
        
        .multi-select-actions {
            display: flex;
            gap: 10px;
        }
        
        .multi-btn {
            padding: 8px 16px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .multi-btn:hover {
            transform: translateY(-2px);
        }
        
        .multi-btn-complete {
            background-color: white;
            color: var(--success-color);
        }
        
        .multi-btn-delete {
            background-color: white;
            color: var(--danger-color);
        }
        
        .multi-btn-cancel {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        /* Graph View Styles */
        .graph-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .graph-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .graph-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Insights Styles */
        .insights-section {
            margin-bottom: 30px;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .insight-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            animation: fadeIn 0.5s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .insight-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .insight-value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-color);
        }
        
        .insight-description {
            font-size: var(--font-size-sm);
            color: var(--gray-color);
        }
        
        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 20px;
            animation: fadeIn 0.3s ease;
            display: none;
        }
        
        .popup {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: zoomIn 0.3s ease;
        }
        
        .popup-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--card-bg);
            z-index: 10;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .popup-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }
        
        .popup-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            color: var(--text-color);
            cursor: pointer;
            transition: transform var(--transition-fast);
        }
        
        .popup-close:hover {
            transform: scale(1.1);
        }
        
        .popup-body {
            padding: 20px;
        }
        
        .popup-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background-color: var(--card-bg);
            z-index: 10;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: all var(--transition-fast);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
            outline: none;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .sub-tasks-container {
            margin-top: 10px;
        }
        
        .sub-task-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .sub-task-input {
            flex: 1;
        }
        
        .remove-sub-task {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: transform var(--transition-fast);
        }
        
        .remove-sub-task:hover {
            transform: scale(1.1);
        }
        
        .add-sub-task {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        
        .add-sub-task:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 15px 20px;
            width: 300px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s forwards;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary-color);
        }
        
        .toast-success {
            border-left-color: var(--success-color);
        }
        
        .toast-warning {
            border-left-color: var(--warning-color);
        }
        
        .toast-danger {
            border-left-color: var(--danger-color);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        
        .toast-message {
            font-size: var(--font-size-sm);
            color: var(--gray-color);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: transform var(--transition-fast);
        }
        
        .toast-close:hover {
            transform: scale(1.1);
        }
        
        /* User Grid Styles */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .user-card {
            background-color: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            animation: fadeIn 0.5s ease;
        }
        
        .user-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }
        
        .user-name {
            font-weight: 600;
            font-size: var(--font-size-md);
            color: var(--text-color);
            margin: 0;
            text-align: center;
        }
        
        .user-email {
            font-size: var(--font-size-sm);
            color: var(--gray-color);
            margin: 0;
            text-align: center;
        }
        
        .user-role {
            font-size: var(--font-size-sm);
            color: var(--primary-color);
            font-weight: 500;
            background-color: rgba(93, 92, 222, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }
            
            .logo h1 {
                font-size: var(--font-size-lg);
            }
            
            .header-actions {
                gap: 10px;
            }
            
            .task-timer {
                padding: 5px 10px;
            }
            
            .timer-display {
                font-size: var(--font-size-sm);
            }
            
            .main-content {
                padding: 20px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
            }
            
            .view-toggle {
                margin-left: 0;
                width: 100%;
                justify-content: center;
            }
            
            .task-header {
                flex-direction: column;
            }
            
            .task-badges {
                justify-content: flex-start;
            }
            
            .task-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .multi-select-bar {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }
            
            .multi-select-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .auth-card {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body class="light-mode">
    <!-- Login Page -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <h2>Welcome to To-Do App</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="test@example.com" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" value="123456" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
                <p class="auth-link">Don't have an account? <a href="#" id="registerLink">Register now</a></p>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="logo" id="dashboardLink">
                <i class="fas fa-check-circle" style="font-size: 24px; color: var(--primary-color);"></i>
                <h1>To-Do App</h1>
            </div>
            
            <div class="header-actions">
                <div class="task-timer">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="timer-actions">
                        <button class="timer-btn" id="timerPlay"><i class="fas fa-play"></i></button>
                        <button class="timer-btn" id="timerPause"><i class="fas fa-pause"></i></button>
                    </div>
                </div>
                
                <button class="mode-switcher" id="modeSwitcher">
                    <i class="fas fa-sun"></i>
                </button>
                
                <div class="user-profile">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="profileImage">
                    <div class="notification-badge" id="notificationBadge">0</div>
                    <div class="status-indicator" id="statusIndicator"></div>
                    
                    <!-- Profile Dropdown -->
                    <div class="dropdown-menu" id="profileDropdown">
                        <div class="dropdown-item" id="viewProfileBtn">
                            <i class="fas fa-user"></i>
                            <span>View Profile</span>
                        </div>
                        <div class="dropdown-item" id="statusBtn">
                            <i class="fas fa-circle"></i>
                            <span>Set Status</span>
                        </div>
                        <div class="dropdown-item" id="switchModeBtn">
                            <i class="fas fa-moon"></i>
                            <span>Dark Mode</span>
                        </div>
                        <div class="dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                    
                    <!-- Notifications Panel -->
                    <div class="notifications-panel" id="notificationsPanel">
                        <div class="notification-header">
                            <span>Notifications</span>
                            <span id="markAllRead" style="font-size: 14px; cursor: pointer; color: var(--primary-color);">Mark all as read</span>
                        </div>
                        <div id="notificationsList">
                            <!-- Notifications will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Task Summary -->
            <div class="task-summary">
                <div class="total-tasks">
                    <h3>Total Tasks</h3>
                    <div class="count" id="totalTasksCount">0</div>
                </div>
                
                <div class="tasks-status">
                    <div class="status-card completed-card">
                        <h3>Completed Tasks</h3>
                        <div class="count" id="completedTasksCount">0</div>
                    </div>
                    
                    <div class="status-card pending-card">
                        <h3>Pending Tasks</h3>
                        <div class="count" id="pendingTasksCount">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Task Section -->
            <section class="task-section">
                <div class="section-header">
                    <h2 class="section-title">Tasks</h2>
                    
                    <div class="section-actions">
                        <button class="btn btn-success" id="addTaskBtn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                        
                        <button class="btn btn-primary" id="exportBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                        
                        <button class="btn btn-primary" id="importBtn">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                        
                        <button class="btn btn-outline" id="categoriesBtn">
                            <i class="fas fa-tags"></i> Categories
                        </button>
                        
                        <button class="btn btn-outline" id="usersBtn">
                            <i class="fas fa-users"></i> Users
                        </button>
                        
                        <div class="undo-redo">
                            <button id="undoBtn" disabled><i class="fas fa-undo"></i></button>
                            <button id="redoBtn" disabled><i class="fas fa-redo"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-group">
                        <span class="filter-label">Status:</span>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Category:</span>
                        <select class="filter-select" id="categoryFilter">
                            <option value="all">All</option>
                            <!-- Categories will be added dynamically -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Priority:</span>
                        <select class="filter-select" id="priorityFilter">
                            <option value="all">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Due Date:</span>
                        <select class="filter-select" id="dueDateFilter">
                            <option value="all">All</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <span class="filter-label">Sort By:</span>
                        <select class="filter-select" id="sortFilter">
                            <option value="dueDate-asc">Due Date (Earliest)</option>
                            <option value="dueDate-desc">Due Date (Latest)</option>
                            <option value="title-asc">Title (A-Z)</option>
                            <option value="title-desc">Title (Z-A)</option>
                            <option value="priority-desc">Priority (High to Low)</option>
                            <option value="priority-asc">Priority (Low to High)</option>
                        </select>
                    </div>
                    
                    <input type="text" class="search-input" id="searchInput" placeholder="Search tasks...">
                    
                    <div class="view-toggle">
                        <button class="active" id="listViewBtn">List</button>
                        <button id="graphViewBtn">Graph</button>
                    </div>
                </div>
                
                <div class="tasks-container">
                    <!-- List View -->
                    <div class="task-view active" id="listView">
                        <div class="task-list" id="taskList">
                            <!-- Tasks will be added dynamically -->
                        </div>
                    </div>
                    
                    <!-- Graph View -->
                    <div class="task-view" id="graphView">
                        <div class="graph-container">
                            <div class="graph-card">
                                <h3 class="graph-title">Tasks Progress Over Time</h3>
                                <div class="chart-container">
                                    <canvas id="tasksProgressChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="graph-card">
                                <h3 class="graph-title">Task Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="taskDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Multi Select Bar -->
                <div class="multi-select-bar" id="multiSelectBar">
                    <div class="multi-select-info">
                        <span id="selectedTasksCount">0</span> tasks selected
                    </div>
                    
                    <div class="multi-select-actions">
                        <button class="multi-btn multi-btn-complete" id="completeSelectedBtn">
                            <i class="fas fa-check"></i> Complete
                        </button>
                        
                        <button class="multi-btn multi-btn-delete" id="deleteSelectedBtn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        
                        <button class="multi-btn multi-btn-cancel" id="cancelSelectionBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Insights Section -->
            <section class="insights-section">
                <div class="section-header">
                    <h2 class="section-title">Insights</h2>
                </div>
                
                <div class="insights-grid">
                    <div class="insight-card">
                        <h3 class="insight-title">On-Time Completion Rate</h3>
                        <div class="insight-value" id="onTimeCompletionRate">0%</div>
                        <p class="insight-description">Percentage of tasks completed before due date</p>
                    </div>
                    
                    <div class="insight-card">
                        <h3 class="insight-title">Tasks Due Soon</h3>
                        <div class="insight-value" id="tasksDueSoon">0</div>
                        <p class="insight-description">Tasks due within the next 48 hours</p>
                    </div>
                    
                    <div class="insight-card">
                        <h3 class="insight-title">Expired Tasks</h3>
                        <div class="insight-value" id="expiredTasks">0</div>
                        <p class="insight-description">Tasks that have passed their due date</p>
                    </div>
                    
                    <div class="insight-card">
                        <h3 class="insight-title">Average Completion Time</h3>
                        <div class="insight-value" id="avgCompletionTime">0h</div>
                        <p class="insight-description">Average time spent on completed tasks</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Popups -->
    <!-- Registration Popup -->
    <div class="popup-overlay" id="registrationPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Create an Account</h3>
                <button class="popup-close" id="closeRegistrationPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <form id="registrationForm">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" name="regEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmEmail">Confirm Email</label>
                        <input type="email" id="confirmEmail" name="confirmEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" name="regPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="birthdate">Birthdate</label>
                        <input type="text" id="birthdate" name="birthdate" placeholder="Select Date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nationality">Nationality</label>
                        <select id="nationality" name="nationality" required>
                            <option value="">Select Country</option>
                            <!-- Countries will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select Role</option>
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelRegistration">Cancel</button>
                <button class="btn btn-success" id="createAccount">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Add Task Popup -->
    <div class="popup-overlay" id="addTaskPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title" id="taskPopupTitle">Add New Task</h3>
                <button class="popup-close" id="closeTaskPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" name="taskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" name="taskDescription"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" name="taskDueDate" placeholder="Select Date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" name="taskPriority" required>
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" name="taskCategory" required>
                            <!-- Categories will be added dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Sub-Tasks</label>
                        <div class="sub-tasks-container" id="subTasksContainer">
                            <!-- Sub-tasks will be added dynamically -->
                        </div>
                        <button type="button" class="add-sub-task" id="addSubTaskBtn">
                            <i class="fas fa-plus"></i> Add Sub-Task
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskNotes">Notes</label>
                        <textarea id="taskNotes" name="taskNotes"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelTask">Cancel</button>
                <button class="btn btn-success" id="saveTask">Create</button>
            </div>
        </div>
    </div>
    
    <!-- View Task Popup -->
    <div class="popup-overlay" id="viewTaskPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title" id="viewTaskTitle">Task Details</h3>
                <button class="popup-close" id="closeViewTaskPopup">&times;</button>
            </div>
            
            <div class="popup-body" id="viewTaskBody">
                <!-- Task details will be populated dynamically -->
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="closeViewTask">Close</button>
                <button class="btn btn-primary" id="editViewTask">Edit Task</button>
            </div>
        </div>
    </div>
    
    <!-- Share Task Popup -->
    <div class="popup-overlay" id="shareTaskPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Share Task</h3>
                <button class="popup-close" id="closeShareTaskPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label>Share with:</label>
                    <div id="shareUsersList" style="margin-top: 10px;">
                        <!-- Users will be added dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="shareMessage">Message (Optional)</label>
                    <textarea id="shareMessage" placeholder="Add a message..."></textarea>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelShare">Cancel</button>
                <button class="btn btn-success" id="confirmShare">Share</button>
            </div>
        </div>
    </div>
    
    <!-- Export Popup -->
    <div class="popup-overlay" id="exportPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Export Tasks</h3>
                <button class="popup-close" id="closeExportPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label for="exportFormat">Select Format</label>
                    <select id="exportFormat" name="exportFormat">
                        <option value="pdf">PDF</option>
                        <option value="json">JSON</option>
                        <option value="xlsx">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelExport">Cancel</button>
                <button class="btn btn-success" id="confirmExport">Export</button>
            </div>
        </div>
    </div>
    
    <!-- Import Popup -->
    <div class="popup-overlay" id="importPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Import Tasks</h3>
                <button class="popup-close" id="closeImportPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label for="importFile">Upload JSON File</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                
                <div class="form-group">
                    <label for="importUrl">Or Import from URL</label>
                    <input type="url" id="importUrl" placeholder="https://example.com/tasks.json">
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelImport">Cancel</button>
                <button class="btn btn-success" id="confirmImport">Import</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Popup -->
    <div class="popup-overlay" id="categoriesPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Manage Categories</h3>
                <button class="popup-close" id="closeCategoriesPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label for="newCategory">Add New Category</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategory" placeholder="Category name">
                        <button class="btn btn-success" id="addCategoryBtn" style="flex-shrink: 0;">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Current Categories</label>
                    <div id="categoriesList" style="margin-top: 10px;">
                        <!-- Categories will be added dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-primary" id="saveCategoriesBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Users Popup -->
    <div class="popup-overlay" id="usersPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">All Users</h3>
                <button class="popup-close" id="closeUsersPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="users-grid" id="usersGrid">
                    <!-- Users will be added dynamically -->
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="closeUsers">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Popup -->
    <div class="popup-overlay" id="profilePopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">User Profile</h3>
                <button class="popup-close" id="closeProfilePopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="position: relative; display: inline-block;">
                        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" id="profilePopupImage" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color);">
                        <input type="file" id="profileImageUpload" style="display: none;" accept="image/*">
                        <button id="changeProfileImage" style="position: absolute; bottom: 0; right: 0; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer;">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                </div>
                
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileName">Full Name</label>
                        <input type="text" id="profileName" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profilePhone">Phone</label>
                        <input type="tel" id="profilePhone" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileCountry">Country</label>
                        <input type="text" id="profileCountry" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileRole">Role</label>
                        <input type="text" id="profileRole" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="profileJoiningDate">Joining Date</label>
                        <input type="text" id="profileJoiningDate" readonly>
                    </div>
                </form>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="closeProfile">Close</button>
                <button class="btn btn-primary" id="editProfile">Edit Profile</button>
            </div>
        </div>
    </div>
    
    <!-- Status Popup -->
    <div class="popup-overlay" id="statusPopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Set Status</h3>
                <button class="popup-close" id="closeStatusPopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label>Select Status</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div class="status-option" data-status="online" style="padding: 15px; border-radius: var(--radius-md); background-color: rgba(40, 167, 69, 0.1); border: 2px solid #28A745; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; border-radius: 50%; background-color: #28A745;"></div>
                            <span>Online</span>
                        </div>
                        <div class="status-option" data-status="away" style="padding: 15px; border-radius: var(--radius-md); background-color: rgba(255, 193, 7, 0.1); border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; border-radius: 50%; background-color: #FFC107;"></div>
                            <span>Away</span>
                        </div>
                        <div class="status-option" data-status="busy" style="padding: 15px; border-radius: var(--radius-md); background-color: rgba(220, 53, 69, 0.1); border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; border-radius: 50%; background-color: #DC3545;"></div>
                            <span>Busy</span>
                        </div>
                        <div class="status-option" data-status="offline" style="padding: 15px; border-radius: var(--radius-md); background-color: rgba(108, 117, 125, 0.1); border: 2px solid transparent; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 15px; height: 15px; border-radius: 50%; background-color: #6C757D;"></div>
                            <span>Offline</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="statusMessage">Status Message (Optional)</label>
                    <input type="text" id="statusMessage" placeholder="What's on your mind?">
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelStatus">Cancel</button>
                <button class="btn btn-success" id="saveStatus">Save Status</button>
            </div>
        </div>
    </div>
    
    <!-- Date Range Picker Popup -->
    <div class="popup-overlay" id="dateRangePopup">
        <div class="popup">
            <div class="popup-header">
                <h3 class="popup-title">Select Date Range</h3>
                <button class="popup-close" id="closeDateRangePopup">&times;</button>
            </div>
            
            <div class="popup-body">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="text" id="startDate" placeholder="Select Start Date">
                </div>
                
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="text" id="endDate" placeholder="Select End Date">
                </div>
            </div>
            
            <div class="popup-footer">
                <button class="btn btn-outline" id="cancelDateRange">Cancel</button>
                <button class="btn btn-success" id="applyDateRange">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toasts will be added dynamically -->
    </div>
    
    <script>
        // Utility Functions
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function showToast(title, message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.remove();
            });
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function openPopup(popupId) {
            document.getElementById(popupId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }
        
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        // APP CLASSES
        class AppState {
            constructor() {
                this.users = [];
                this.currentUser = null;
                this.tasks = [];
                this.categories = ['Work', 'Personal', 'Shopping', 'Health', 'Education'];
                this.notifications = [];
                this.isTimerRunning = false;
                this.timerInterval = null;
                this.currentTimerTask = null;
                this.timerSeconds = 0;
                this.darkMode = false;
                this.userStatus = 'online';
                this.taskHistory = {
                    past: [],
                    future: []
                };
                this.selectedTasks = new Set();
                
                this.loadFromLocalStorage();
                this.initializeRandomData();
            }
            
            loadFromLocalStorage() {
                try {
                    if (localStorage.getItem('todoAppUsers')) {
                        this.users = JSON.parse(localStorage.getItem('todoAppUsers'));
                    }
                    
                    if (localStorage.getItem('todoAppTasks')) {
                        this.tasks = JSON.parse(localStorage.getItem('todoAppTasks'));
                    }
                    
                    if (localStorage.getItem('todoAppCategories')) {
                        this.categories = JSON.parse(localStorage.getItem('todoAppCategories'));
                    }
                    
                    if (localStorage.getItem('todoAppNotifications')) {
                        this.notifications = JSON.parse(localStorage.getItem('todoAppNotifications'));
                    }
                    
                    if (localStorage.getItem('todoAppDarkMode')) {
                        this.darkMode = JSON.parse(localStorage.getItem('todoAppDarkMode'));
                        if (this.darkMode) {
                            document.body.classList.remove('light-mode');
                            document.body.classList.add('dark-mode');
                        } else {
                            document.body.classList.remove('dark-mode');
                            document.body.classList.add('light-mode');
                        }
                    }
                } catch (e) {
                    console.error('Error loading from localStorage', e);
                }
            }
            
            saveToLocalStorage() {
                try {
                    localStorage.setItem('todoAppUsers', JSON.stringify(this.users));
                    localStorage.setItem('todoAppTasks', JSON.stringify(this.tasks));
                    localStorage.setItem('todoAppCategories', JSON.stringify(this.categories));
                    localStorage.setItem('todoAppNotifications', JSON.stringify(this.notifications));
                    localStorage.setItem('todoAppDarkMode', JSON.stringify(this.darkMode));
                } catch (e) {
                    console.error('Error saving to localStorage', e);
                    showToast('Storage Error', 'Failed to save data. Local storage may be full.', 'danger');
                }
            }
            
            initializeRandomData() {
                // Only add random data if there are no tasks
                if (this.tasks.length === 0) {
                    this.addRandomTasks();
                }
                
                // Only add random users if there are no users
                if (this.users.length === 0) {
                    this.addRandomUsers();
                }
            }
            
            addRandomTasks() {
                const taskTitles = [
                    'Complete project proposal',
                    'Review marketing materials',
                    'Prepare presentation for client',
                    'Update website content',
                    'Research new market trends',
                    'Schedule team meeting',
                    'Fix bug in checkout process',
                    'Create social media strategy',
                    'Call customer about feedback',
                    'Redesign landing page',
                    'Write blog post',
                    'Update product documentation'
                ];
                
                const taskDescriptions = [
                    'This task requires full attention to detail and needs to be completed by the deadline.',
                    'Review the materials carefully and provide comprehensive feedback.',
                    'Make sure to include all the key points and practice the presentation beforehand.',
                    'Update all necessary sections with the new content provided by the marketing team.',
                    'Focus on emerging trends in the industry and compile a detailed report.',
                    'Ensure all team members are available and prepare an agenda for the meeting.',
                    'Identify the root cause of the bug and implement a fix.',
                    'Develop a comprehensive strategy for all social media platforms.',
                    'Follow up on the customer feedback and address any concerns.',
                    'Create a more user-friendly and modern design for the landing page.',
                    'Write a 1000-word blog post on the specified topic.',
                    'Update all documentation to reflect the latest product changes.'
                ];
                
                const subtasks = [
                    ['Research market data', 'Create outline', 'Draft introduction', 'Add supporting evidence', 'Finalize conclusion'],
                    ['Check grammar and spelling', 'Verify facts and figures', 'Ensure branding consistency'],
                    ['Gather data', 'Create slides', 'Add visual elements', 'Practice delivery'],
                    ['Update text content', 'Replace images', 'Check links'],
                    ['Review industry publications', 'Analyze competitor strategies', 'Identify growth opportunities'],
                    ['Find suitable time slot', 'Book conference room', 'Prepare agenda', 'Send invitations'],
                    ['Reproduce the bug', 'Identify the cause', 'Implement fix', 'Test solution'],
                    ['Audit current performance', 'Set goals', 'Create content calendar', 'Define metrics'],
                    ['Prepare talking points', 'Document feedback', 'Create action plan'],
                    ['Create wireframes', 'Design mockup', 'Implement new design', 'Test usability'],
                    ['Research topic', 'Create outline', 'Write draft', 'Edit and proofread', 'Add images'],
                    ['Review current documentation', 'Identify outdated sections', 'Update content', 'Add examples']
                ];
                
                // Generate random tasks
                for (let i = 0; i < 12; i++) {
                    const now = new Date();
                    
                    // Generate a random due date (between today and 2 weeks from now)
                    const randomDays = Math.floor(Math.random() * 14) - 2; // Some tasks might be expired
                    const dueDate = new Date();
                    dueDate.setDate(now.getDate() + randomDays);
                    
                    // Generate random sub-tasks (some tasks have sub-tasks, some don't)
                    const hasSubtasks = Math.random() > 0.3;
                    const taskSubtasks = hasSubtasks 
                        ? subtasks[i % subtasks.length].map(title => ({
                            id: generateId(),
                            title,
                            completed: Math.random() > 0.5
                        })) 
                        : [];
                    
                    // Randomly determine if task is completed
                    const completed = Math.random() > 0.7;
                    
                    // Generate random time spent (between 0 and 4 hours)
                    const timeSpent = Math.floor(Math.random() * 14400);
                    
                    const task = {
                        id: generateId(),
                        title: taskTitles[i],
                        description: taskDescriptions[i % taskDescriptions.length],
                        dueDate: dueDate.toISOString(),
                        priority: ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
                        category: this.categories[Math.floor(Math.random() * this.categories.length)],
                        completed,
                        createdAt: new Date(now - Math.random() * 604800000).toISOString(), // Random creation date up to 1 week ago
                        completedAt: completed ? new Date(now - Math.random() * 86400000).toISOString() : null, // If completed, random completion date up to 1 day ago
                        subtasks: taskSubtasks,
                        notes: 'Additional notes for this task.',
                        timeSpent: timeSpent
                    };
                    
                    this.tasks.push(task);
                }
                
                this.saveToLocalStorage();
            }
            
            addRandomUsers() {
                const firstNames = ['John', 'Jane', 'Michael', 'Emily', 'David', 'Sarah', 'Robert', 'Lisa', 'William', 'Jessica'];
                const lastNames = ['Smith', 'Johnson', 'Williams', 'Jones', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor'];
                const countries = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Spain', 'Italy', 'Japan', 'Brazil'];
                const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
                
                // Add current user
                this.currentUser = {
                    id: generateId(),
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'test@example.com',
                    password: '123456',
                    birthdate: '1990-01-01',
                    nationality: 'United States',
                    role: 'Admin',
                    joiningDate: new Date().toISOString(),
                    phone: '+1 (555) 123-4567',
                    profileImage: 'https://randomuser.me/api/portraits/men/1.jpg'
                };
                
                this.users.push(this.currentUser);
                
                // Generate random users
                for (let i = 0; i < 9; i++) {
                    const gender = Math.random() > 0.5 ? 'men' : 'women';
                    const imageId = Math.floor(Math.random() * 70) + 1;
                    
                    const user = {
                        id: generateId(),
                        firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                        lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                        email: `user${i+1}@example.com`,
                        password: 'password123',
                        birthdate: `${1970 + Math.floor(Math.random() * 30)}-${Math.floor(Math.random() * 12) + 1}-${Math.floor(Math.random() * 28) + 1}`,
                        nationality: countries[Math.floor(Math.random() * countries.length)],
                        role: roles[Math.floor(Math.random() * roles.length)],
                        joiningDate: new Date(Date.now() - Math.random() * 31536000000).toISOString(), // Random date within last year
                        phone: `+1 (555) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                        profileImage: `https://randomuser.me/api/portraits/${gender}/${imageId}.jpg`
                    };
                    
                    this.users.push(user);
                }
                
                this.saveToLocalStorage();
            }
            
            addUser(userData) {
                const user = {
                    id: generateId(),
                    ...userData,
                    joiningDate: new Date().toISOString()
                };
                
                this.users.push(user);
                this.saveToLocalStorage();
                
                this.addNotification({
                    title: 'New User',
                    content: `${user.firstName} ${user.lastName} has joined.`,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                
                return user;
            }
            
            updateUser(userId, userData) {
                const index = this.users.findIndex(user => user.id === userId);
                if (index !== -1) {
                    this.users[index] = { ...this.users[index], ...userData };
                    
                    // If updating current user, also update currentUser
                    if (this.currentUser && this.currentUser.id === userId) {
                        this.currentUser = { ...this.currentUser, ...userData };
                    }
                    
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            login(email, password) {
                const user = this.users.find(u => u.email === email && u.password === password);
                if (user) {
                    this.currentUser = user;
                    return true;
                }
                return false;
            }
            
            logout() {
                this.currentUser = null;
            }
            
            saveTaskState() {
                const currentState = JSON.parse(JSON.stringify(this.tasks));
                this.taskHistory.past.push(currentState);
                this.taskHistory.future = []; // Clear redo history on new action
                
                // Limit history size
                if (this.taskHistory.past.length > 10) {
                    this.taskHistory.past.shift();
                }
            }
            
            undo() {
                if (this.taskHistory.past.length > 0) {
                    const currentState = JSON.parse(JSON.stringify(this.tasks));
                    this.taskHistory.future.push(currentState);
                    
                    this.tasks = this.taskHistory.past.pop();
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            redo() {
                if (this.taskHistory.future.length > 0) {
                    const currentState = JSON.parse(JSON.stringify(this.tasks));
                    this.taskHistory.past.push(currentState);
                    
                    this.tasks = this.taskHistory.future.pop();
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            addTask(taskData) {
                this.saveTaskState();
                
                const task = {
                    id: generateId(),
                    ...taskData,
                    createdAt: new Date().toISOString(),
                    completed: false,
                    completedAt: null,
                    timeSpent: 0
                };
                
                this.tasks.push(task);
                this.saveToLocalStorage();
                
                this.addNotification({
                    title: 'Task Created',
                    content: `New task "${task.title}" has been created.`,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                
                return task;
            }
            
            updateTask(taskId, taskData) {
                this.saveTaskState();
                
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    const oldTask = { ...this.tasks[index] };
                    
                    // Check if completing task
                    if (!oldTask.completed && taskData.completed) {
                        taskData.completedAt = new Date().toISOString();
                    } else if (oldTask.completed && !taskData.completed) {
                        taskData.completedAt = null;
                    }
                    
                    this.tasks[index] = { ...oldTask, ...taskData };
                    this.saveToLocalStorage();
                    
                    this.addNotification({
                        title: 'Task Updated',
                        content: `Task "${oldTask.title}" has been updated.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    return true;
                }
                return false;
            }
            
            deleteTask(taskId) {
                this.saveTaskState();
                
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    const deletedTask = this.tasks[index];
                    this.tasks.splice(index, 1);
                    this.saveToLocalStorage();
                    
                    this.addNotification({
                        title: 'Task Deleted',
                        content: `Task "${deletedTask.title}" has been deleted.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    return true;
                }
                return false;
            }
            
            deleteSelectedTasks() {
                if (this.selectedTasks.size > 0) {
                    this.saveTaskState();
                    
                    const taskIds = Array.from(this.selectedTasks);
                    const deletedCount = taskIds.length;
                    
                    this.tasks = this.tasks.filter(task => !taskIds.includes(task.id));
                    this.selectedTasks.clear();
                    this.saveToLocalStorage();
                    
                    this.addNotification({
                        title: 'Tasks Deleted',
                        content: `${deletedCount} tasks have been deleted.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    return deletedCount;
                }
                return 0;
            }
            
            completeSelectedTasks() {
                if (this.selectedTasks.size > 0) {
                    this.saveTaskState();
                    
                    const taskIds = Array.from(this.selectedTasks);
                    const completedCount = taskIds.length;
                    
                    taskIds.forEach(taskId => {
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task) {
                            task.completed = true;
                            task.completedAt = new Date().toISOString();
                        }
                    });
                    
                    this.selectedTasks.clear();
                    this.saveToLocalStorage();
                    
                    this.addNotification({
                        title: 'Tasks Completed',
                        content: `${completedCount} tasks have been marked as completed.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    return completedCount;
                }
                return 0;
            }
            
            toggleTaskSelection(taskId) {
                if (this.selectedTasks.has(taskId)) {
                    this.selectedTasks.delete(taskId);
                } else {
                    this.selectedTasks.add(taskId);
                }
                return this.selectedTasks.size;
            }
            
            clearTaskSelection() {
                this.selectedTasks.clear();
            }
            
            reorderTasks(fromIndex, toIndex) {
                this.saveTaskState();
                
                // Get copy of tasks array for reordering
                const tasks = [...this.tasks];
                
                // Get the task being moved
                const task = tasks[fromIndex];
                
                // Remove the task from the array
                tasks.splice(fromIndex, 1);
                
                // Insert the task at the new position
                tasks.splice(toIndex, 0, task);
                
                // Update the tasks array
                this.tasks = tasks;
                this.saveToLocalStorage();
            }
            
            addCategory(category) {
                if (!this.categories.includes(category)) {
                    this.categories.push(category);
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            deleteCategory(category) {
                const index = this.categories.indexOf(category);
                if (index !== -1) {
                    this.categories.splice(index, 1);
                    
                    // Update tasks that use this category
                    this.tasks.forEach(task => {
                        if (task.category === category) {
                            task.category = this.categories[0] || 'Uncategorized';
                        }
                    });
                    
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            addNotification(notification) {
                const newNotification = {
                    id: generateId(),
                    ...notification
                };
                
                this.notifications.unshift(newNotification);
                
                // Limit number of notifications
                if (this.notifications.length > 20) {
                    this.notifications.pop();
                }
                
                this.saveToLocalStorage();
                return newNotification;
            }
            
            markNotificationAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }
            
            markAllNotificationsAsRead() {
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
                this.saveToLocalStorage();
            }
            
            getUnreadNotificationCount() {
                return this.notifications.filter(n => !n.read).length;
            }
            
            startTimer(taskId) {
                if (this.isTimerRunning) {
                    this.pauseTimer();
                }
                
                this.currentTimerTask = taskId;
                this.isTimerRunning = true;
                
                this.timerInterval = setInterval(() => {
                    this.timerSeconds++;
                    
                    // Update task's time spent
                    if (this.currentTimerTask) {
                        const task = this.tasks.find(t => t.id === this.currentTimerTask);
                        if (task) {
                            task.timeSpent = (task.timeSpent || 0) + 1;
                        }
                    }
                    
                    // Update UI
                    document.getElementById('timerDisplay').textContent = formatTime(this.timerSeconds);
                }, 1000);
            }
            
            pauseTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                this.isTimerRunning = false;
                this.currentTimerTask = null;
                this.saveToLocalStorage();
            }
            
            resetTimer() {
                this.pauseTimer();
                this.timerSeconds = 0;
                document.getElementById('timerDisplay').textContent = formatTime(this.timerSeconds);
            }
            
            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                
                if (this.darkMode) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
                
                this.saveToLocalStorage();
                return this.darkMode;
            }
            
            setUserStatus(status) {
                this.userStatus = status;
                
                const statusIndicator = document.getElementById('statusIndicator');
                
                // Set status indicator color
                switch (status) {
                    case 'online':
                        statusIndicator.style.backgroundColor = 'var(--success-color)';
                        break;
                    case 'away':
                        statusIndicator.style.backgroundColor = 'var(--warning-color)';
                        break;
                    case 'busy':
                        statusIndicator.style.backgroundColor = 'var(--danger-color)';
                        break;
                    case 'offline':
                        statusIndicator.style.backgroundColor = 'var(--gray-color)';
                        break;
                }
                
                return status;
            }
            
            filterTasks({status, category, priority, dueDate, search, sort, dateRange}) {
                let filteredTasks = [...this.tasks];
                
                // Filter by status
                if (status !== 'all') {
                    filteredTasks = filteredTasks.filter(task => {
                        if (status === 'completed') return task.completed;
                        if (status === 'active') return !task.completed;
                        return true;
                    });
                }
                
                // Filter by category
                if (category !== 'all') {
                    filteredTasks = filteredTasks.filter(task => task.category === category);
                }
                
                // Filter by priority
                if (priority !== 'all') {
                    filteredTasks = filteredTasks.filter(task => task.priority === priority);
                }
                
                // Filter by due date
                if (dueDate !== 'all') {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        
                        if (dueDate === 'today') {
                            return taskDate >= today && taskDate < tomorrow;
                        } else if (dueDate === 'week') {
                            return taskDate >= weekStart && taskDate < weekEnd;
                        } else if (dueDate === 'month') {
                            return taskDate >= monthStart && taskDate <= monthEnd;
                        } else if (dueDate === 'custom' && dateRange) {
                            return taskDate >= new Date(dateRange.start) && 
                                   taskDate <= new Date(dateRange.end);
                        }
                        
                        return true;
                    });
                }
                
                // Filter by search
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredTasks = filteredTasks.filter(task => 
                        task.title.toLowerCase().includes(searchLower) || 
                        task.description.toLowerCase().includes(searchLower)
                    );
                }
                
                // Sort tasks
                if (sort) {
                    const [field, direction] = sort.split('-');
                    
                    filteredTasks.sort((a, b) => {
                        let comparison = 0;
                        
                        if (field === 'dueDate') {
                            comparison = new Date(a.dueDate) - new Date(b.dueDate);
                        } else if (field === 'title') {
                            comparison = a.title.localeCompare(b.title);
                        } else if (field === 'priority') {
                            const priorityValues = { high: 3, medium: 2, low: 1 };
                            comparison = priorityValues[a.priority] - priorityValues[b.priority];
                        }
                        
                        return direction === 'asc' ? comparison : -comparison;
                    });
                }
                
                return filteredTasks;
            }
            
            exportTasks(format) {
                const tasks = this.tasks;
                
                if (format === 'json') {
                    const jsonData = JSON.stringify(tasks, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    return { blob, filename: `tasks-${new Date().toISOString().slice(0, 10)}.json` };
                } 
                else if (format === 'csv') {
                    // Simple CSV export (header row + data rows)
                    const headers = ['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Status', 'Created At'];
                    
                    const rows = [headers.join(',')];
                    tasks.forEach(task => {
                        const row = [
                            `"${task.title.replace(/"/g, '""')}"`,
                            `"${task.description.replace(/"/g, '""')}"`,
                            formatDate(task.dueDate),
                            task.priority,
                            task.category,
                            task.completed ? 'Completed' : 'Active',
                            formatDate(task.createdAt)
                        ];
                        rows.push(row.join(','));
                    });
                    
                    const csvData = rows.join('\n');
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    return { blob, filename: `tasks-${new Date().toISOString().slice(0, 10)}.csv` };
                }
                else if (format === 'xlsx') {
                    // Create workbook with a worksheet
                    const workbook = XLSX.utils.book_new();
                    
                    // Create data array with headers
                    const data = [
                        ['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Status', 'Created At']
                    ];
                    
                    // Add task data
                    tasks.forEach(task => {
                        data.push([
                            task.title,
                            task.description,
                            formatDate(task.dueDate),
                            task.priority,
                            task.category,
                            task.completed ? 'Completed' : 'Active',
                            formatDate(task.createdAt)
                        ]);
                    });
                    
                    // Convert data to worksheet
                    const worksheet = XLSX.utils.aoa_to_sheet(data);
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
                    
                    // Generate XLSX file
                    const excelData = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    return { blob, filename: `tasks-${new Date().toISOString().slice(0, 10)}.xlsx` };
                }
                else if (format === 'pdf') {
                    // Create PDF document
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(18);
                    doc.text('Tasks List', 14, 20);
                    
                    // Add creation date
                    doc.setFontSize(10);
                    doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 30);
                    
                    // Create table data
                    const headers = [['Title', 'Due Date', 'Priority', 'Category', 'Status']];
                    const rows = tasks.map(task => [
                        task.title.substring(0, 30) + (task.title.length > 30 ? '...' : ''),
                        formatDate(task.dueDate),
                        task.priority,
                        task.category,
                        task.completed ? 'Completed' : 'Active'
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        head: headers,
                        body: rows,
                        startY: 40,
                        margin: { left: 14, right: 14 },
                        styles: { overflow: 'ellipsize' },
                        columnStyles: {
                            0: { cellWidth: 60 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 30 },
                            3: { cellWidth: 30 },
                            4: { cellWidth: 30 }
                        }
                    });
                    
                    // Generate PDF blob
                    const pdfData = doc.output('arraybuffer');
                    const blob = new Blob([pdfData], { type: 'application/pdf' });
                    return { blob, filename: `tasks-${new Date().toISOString().slice(0, 10)}.pdf` };
                }
                
                return null;
            }
            
            importTasks(tasksData) {
                try {
                    const importedTasks = JSON.parse(tasksData);
                    
                    // Validate imported data
                    if (!Array.isArray(importedTasks)) {
                        throw new Error('Invalid data format. Expected an array of tasks.');
                    }
                    
                    // Save current state for undo
                    this.saveTaskState();
                    
                    // Generate new IDs to avoid conflicts
                    const importCount = importedTasks.length;
                    importedTasks.forEach(task => {
                        // Check if has minimum required fields
                        if (!task.title || !task.dueDate) {
                            throw new Error('Invalid task data. Missing required fields.');
                        }
                        
                        // Generate new ID
                        task.id = generateId();
                        
                        // Add to tasks
                        this.tasks.push(task);
                    });
                    
                    this.saveToLocalStorage();
                    
                    this.addNotification({
                        title: 'Tasks Imported',
                        content: `${importCount} tasks have been imported.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    return importCount;
                    
                } catch (error) {
                    console.error('Import error:', error);
                    throw error;
                }
            }
            
            // Analytics methods
            getTasksStats() {
                const now = new Date();
                const totalTasks = this.tasks.length;
                const completedTasks = this.tasks.filter(t => t.completed).length;
                const pendingTasks = totalTasks - completedTasks;
                
                // Calculate tasks due soon (within 48 hours)
                const dueSoon = this.tasks.filter(task => {
                    if (task.completed) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    const timeDiff = dueDate - now;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    return hoursDiff > 0 && hoursDiff <= 48;
                }).length;
                
                // Calculate expired tasks
                const expired = this.tasks.filter(task => {
                    if (task.completed) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    return dueDate < now;
                }).length;
                
                // Calculate on-time completion rate
                const completedOnTime = this.tasks.filter(task => {
                    if (!task.completed || !task.completedAt) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    const completedDate = new Date(task.completedAt);
                    
                    return completedDate <= dueDate;
                }).length;
                
                const onTimeRate = totalTasks > 0 ? 
                    Math.round((completedOnTime / totalTasks) * 100) : 0;
                
                // Calculate average completion time (in hours)
                const completedTimes = this.tasks
                    .filter(task => task.completed && task.timeSpent)
                    .map(task => task.timeSpent);
                
                const avgCompletionTime = completedTimes.length > 0 ?
                    Math.round(completedTimes.reduce((sum, time) => sum + time, 0) / completedTimes.length / 3600 * 10) / 10 :
                    0;
                
                return {
                    totalTasks,
                    completedTasks,
                    pendingTasks,
                    dueSoon,
                    expired,
                    onTimeRate,
                    avgCompletionTime
                };
            }
            
            getTasksProgressData() {
                // Group tasks by month/week for trend chart
                const now = new Date();
                const sixMonthsAgo = new Date(now);
                sixMonthsAgo.setMonth(now.getMonth() - 6);
                
                // Create array of last 6 months
                const months = [];
                for (let i = 0; i < 6; i++) {
                    const date = new Date(now);
                    date.setMonth(now.getMonth() - i);
                    months.unshift(`${date.toLocaleString('default', { month: 'short' })} ${date.getFullYear()}`);
                }
                
                // Count completed and pending tasks for each month
                const completedByMonth = Array(6).fill(0);
                const pendingByMonth = Array(6).fill(0);
                
                this.tasks.forEach(task => {
                    const createdDate = new Date(task.createdAt);
                    if (createdDate >= sixMonthsAgo) {
                        // Find month index
                        const monthYearStr = `${createdDate.toLocaleString('default', { month: 'short' })} ${createdDate.getFullYear()}`;
                        const monthIndex = months.indexOf(monthYearStr);
                        
                        if (monthIndex !== -1) {
                            if (task.completed) {
                                completedByMonth[monthIndex]++;
                            } else {
                                pendingByMonth[monthIndex]++;
                            }
                        }
                    }
                });
                
                return {
                    labels: months,
                    datasets: [
                        {
                            label: 'Completed',
                            data: completedByMonth,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgb(40, 167, 69)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending',
                            data: pendingByMonth,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgb(255, 193, 7)',
                            borderWidth: 1
                        }
                    ]
                };
            }
            
            getTaskDistributionData() {
                const stats = this.getTasksStats();
                
                return {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [stats.completedTasks, stats.pendingTasks],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)'
                        ],
                        borderColor: [
                            'rgb(40, 167, 69)',
                            'rgb(255, 193, 7)'
                        ],
                        borderWidth: 1
                    }]
                };
            }
        }
        
        // INITIALIZE APP
        const app = new AppState();
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Dark Mode
            if (app.darkMode) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                document.getElementById('modeSwitcher').innerHTML = '<i class="fas fa-moon"></i>';
                document.getElementById('switchModeBtn').innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.getElementById('modeSwitcher').innerHTML = '<i class="fas fa-sun"></i>';
                document.getElementById('switchModeBtn').innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            }
            
            // Check system preference for dark mode
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                if (!app.darkMode) {
                    app.toggleDarkMode();
                }
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    if (!app.darkMode) {
                        app.toggleDarkMode();
                    }
                } else {
                    if (app.darkMode) {
                        app.toggleDarkMode();
                    }
                }
            });
            
            // Set user status
            app.setUserStatus('online');
            
            // Initialize date pickers
            flatpickr('#birthdate', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
            
            flatpickr('#taskDueDate', {
                dateFormat: 'Y-m-d',
                minDate: 'today'
            });
            
            flatpickr('#startDate', {
                dateFormat: 'Y-m-d'
            });
            
            flatpickr('#endDate', {
                dateFormat: 'Y-m-d'
            });
            
            // Fetch countries for nationality dropdown
            fetch('https://restcountries.com/v3.1/all')
                .then(response => response.json())
                .then(data => {
                    const nationalitySelect = document.getElementById('nationality');
                    
                    // Sort countries by name
                    data.sort((a, b) => {
                        const nameA = a.name.common.toUpperCase();
                        const nameB = b.name.common.toUpperCase();
                        if (nameA < nameB) return -1;
                        if (nameA > nameB) return 1;
                        return 0;
                    });
                    
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        nationalitySelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching countries:', error);
                    // Fallback: add a few common countries
                    const countries = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Spain', 'Italy', 'Japan', 'Brazil'];
                    
                    const nationalitySelect = document.getElementById('nationality');
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        nationalitySelect.appendChild(option);
                    });
                });
            
            // Initialize categories
            updateCategorySelectors();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize notification badge
            updateNotificationBadge();
        });
        
        // EVENT LISTENERS
        function setupEventListeners() {
            // Login Form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Registration
            document.getElementById('registerLink').addEventListener('click', showRegistration);
            document.getElementById('closeRegistrationPopup').addEventListener('click', () => closePopup('registrationPopup'));
            document.getElementById('cancelRegistration').addEventListener('click', () => closePopup('registrationPopup'));
            document.getElementById('createAccount').addEventListener('click', handleRegistration);
            
            // Dashboard Link
            document.getElementById('dashboardLink').addEventListener('click', () => {
                document.getElementById('listViewBtn').click();
            });
            
            // User Profile Dropdown
            document.getElementById('profileImage').addEventListener('click', toggleProfileDropdown);
            document.getElementById('notificationBadge').addEventListener('click', toggleNotificationsPanel);
            
            // Profile Dropdown Actions
            document.getElementById('viewProfileBtn').addEventListener('click', showProfile);
            document.getElementById('statusBtn').addEventListener('click', showStatusPopup);
            document.getElementById('switchModeBtn').addEventListener('click', handleDarkModeToggle);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Mark All Notifications as Read
            document.getElementById('markAllRead').addEventListener('click', markAllNotificationsAsRead);
            
            // Mode Switcher
            document.getElementById('modeSwitcher').addEventListener('click', handleDarkModeToggle);
            
            // Timer Buttons
            document.getElementById('timerPlay').addEventListener('click', () => {
                app.startTimer();
                showToast('Timer Started', 'Task timer has been started.');
            });
            
            document.getElementById('timerPause').addEventListener('click', () => {
                app.pauseTimer();
                showToast('Timer Paused', 'Task timer has been paused.');
            });
            
            // Task Actions
            document.getElementById('addTaskBtn').addEventListener('click', showAddTaskPopup);
            document.getElementById('closeTaskPopup').addEventListener('click', () => closePopup('addTaskPopup'));
            document.getElementById('cancelTask').addEventListener('click', () => closePopup('addTaskPopup'));
            document.getElementById('saveTask').addEventListener('click', handleSaveTask);
            document.getElementById('addSubTaskBtn').addEventListener('click', addSubTaskField);
            
            // View Task Popup
            document.getElementById('closeViewTaskPopup').addEventListener('click', () => closePopup('viewTaskPopup'));
            document.getElementById('closeViewTask').addEventListener('click', () => closePopup('viewTaskPopup'));
            document.getElementById('editViewTask').addEventListener('click', () => {
                closePopup('viewTaskPopup');
                const taskId = document.getElementById('viewTaskTitle').dataset.taskId;
                showEditTaskPopup(taskId);
            });
            
            // Share Task Popup
            document.getElementById('closeShareTaskPopup').addEventListener('click', () => closePopup('shareTaskPopup'));
            document.getElementById('cancelShare').addEventListener('click', () => closePopup('shareTaskPopup'));
            document.getElementById('confirmShare').addEventListener('click', handleShareTask);
            
            // Export/Import
            document.getElementById('exportBtn').addEventListener('click', () => openPopup('exportPopup'));
            document.getElementById('closeExportPopup').addEventListener('click', () => closePopup('exportPopup'));
            document.getElementById('cancelExport').addEventListener('click', () => closePopup('exportPopup'));
            document.getElementById('confirmExport').addEventListener('click', handleExportTasks);
            
            document.getElementById('importBtn').addEventListener('click', () => openPopup('importPopup'));
            document.getElementById('closeImportPopup').addEventListener('click', () => closePopup('importPopup'));
            document.getElementById('cancelImport').addEventListener('click', () => closePopup('importPopup'));
            document.getElementById('confirmImport').addEventListener('click', handleImportTasks);
            
            // Categories
            document.getElementById('categoriesBtn').addEventListener('click', () => openPopup('categoriesPopup'));
            document.getElementById('closeCategoriesPopup').addEventListener('click', () => closePopup('categoriesPopup'));
            document.getElementById('addCategoryBtn').addEventListener('click', handleAddCategory);
            document.getElementById('saveCategoriesBtn').addEventListener('click', () => {
                closePopup('categoriesPopup');
                renderTaskList(); // Update task list to reflect category changes
                updateCategorySelectors(); // Update category dropdowns
                showToast('Categories Saved', 'Your categories have been updated.');
            });
            
            // Users
            document.getElementById('usersBtn').addEventListener('click', () => {
                showUsers();
                openPopup('usersPopup');
            });
            document.getElementById('closeUsersPopup').addEventListener('click', () => closePopup('usersPopup'));
            document.getElementById('closeUsers').addEventListener('click', () => closePopup('usersPopup'));
            
            // Profile
            document.getElementById('closeProfilePopup').addEventListener('click', () => closePopup('profilePopup'));
            document.getElementById('closeProfile').addEventListener('click', () => closePopup('profilePopup'));
            document.getElementById('editProfile').addEventListener('click', toggleProfileEditing);
            document.getElementById('changeProfileImage').addEventListener('click', () => {
                document.getElementById('profileImageUpload').click();
            });
            document.getElementById('profileImageUpload').addEventListener('change', handleProfileImageChange);
            
            // Status
            document.getElementById('closeStatusPopup').addEventListener('click', () => closePopup('statusPopup'));
            document.getElementById('cancelStatus').addEventListener('click', () => closePopup('statusPopup'));
            document.getElementById('saveStatus').addEventListener('click', handleSaveStatus);
            
            // Select status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    // Remove active class from all options
                    document.querySelectorAll('.status-option').forEach(opt => {
                        opt.style.borderColor = 'transparent';
                    });
                    
                    // Add active class to selected option
                    e.currentTarget.style.borderColor = e.currentTarget.querySelector('div').style.backgroundColor;
                });
            });
            
            // View Toggle
            document.getElementById('listViewBtn').addEventListener('click', () => switchView('listView'));
            document.getElementById('graphViewBtn').addEventListener('click', () => switchView('graphView'));
            
            // Undo/Redo
            document.getElementById('undoBtn').addEventListener('click', handleUndo);
            document.getElementById('redoBtn').addEventListener('click', handleRedo);
            
            // Multi Select Actions
            document.getElementById('completeSelectedBtn').addEventListener('click', handleCompleteSelected);
            document.getElementById('deleteSelectedBtn').addEventListener('click', handleDeleteSelected);
            document.getElementById('cancelSelectionBtn').addEventListener('click', handleCancelSelection);
            
            // Filters
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('priorityFilter').addEventListener('change', applyFilters);
            document.getElementById('dueDateFilter').addEventListener('change', handleDueDateFilter);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
            
            // Date Range
            document.getElementById('closeDateRangePopup').addEventListener('click', () => closePopup('dateRangePopup'));
            document.getElementById('cancelDateRange').addEventListener('click', () => closePopup('dateRangePopup'));
            document.getElementById('applyDateRange').addEventListener('click', handleApplyDateRange);
        }
        
        // EVENT HANDLERS
        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (app.login(email, password)) {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                
                // Update profile image
                if (app.currentUser.profileImage) {
                    document.getElementById('profileImage').src = app.currentUser.profileImage;
                    document.getElementById('profilePopupImage').src = app.currentUser.profileImage;
                }
                
                // Initialize dashboard
                initializeDashboard();
                
                showToast('Login Successful', 'Welcome to your To-Do App!');
            } else {
                showToast('Login Failed', 'Invalid email or password. Please try again.', 'danger');
            }
        }
        
        function showRegistration(e) {
            e.preventDefault();
            openPopup('registrationPopup');
        }
        
        function handleRegistration() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('regEmail').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthdate = document.getElementById('birthdate').value;
            const nationality = document.getElementById('nationality').value;
            const role = document.getElementById('role').value;
            
            // Validate fields
            if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                showToast('Registration Error', 'Please fill in all fields.', 'danger');
                return;
            }
            
            if (email !== confirmEmail) {
                showToast('Registration Error', 'Emails do not match.', 'danger');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Registration Error', 'Passwords do not match.', 'danger');
                return;
            }
            
            // Check if email already exists
            if (app.users.some(user => user.email === email)) {
                showToast('Registration Error', 'Email already in use.', 'danger');
                return;
            }
            
            // Create user
            const userData = {
                firstName,
                lastName,
                email,
                password,
                birthdate,
                nationality,
                role,
                profileImage: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 70) + 1}.jpg`,
                phone: '+1 (555) 123-4567' // Default phone
            };
            
            app.addUser(userData);
            
            closePopup('registrationPopup');
            showToast('Registration Successful', 'You can now log in with your new account.', 'success');
        }
        
        function handleLogout() {
            app.logout();
            app.pauseTimer();
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('authContainer').style.display = 'flex';
            
            // Reset forms
            document.getElementById('loginForm').reset();
            document.getElementById('registrationForm').reset();
            
            // Close dropdowns
            document.getElementById('profileDropdown').style.display = 'none';
            document.getElementById('notificationsPanel').style.display = 'none';
            
            showToast('Logged Out', 'You have been logged out successfully.');
        }
        
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            const notificationsPanel = document.getElementById('notificationsPanel');
            
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
                notificationsPanel.style.display = 'none';
            }
        }
        
        function toggleNotificationsPanel() {
            const notificationsPanel = document.getElementById('notificationsPanel');
            const dropdown = document.getElementById('profileDropdown');
            
            if (notificationsPanel.style.display === 'block') {
                notificationsPanel.style.display = 'none';
            } else {
                notificationsPanel.style.display = 'block';
                dropdown.style.display = 'none';
                renderNotifications();
            }
        }
        
        function showProfile() {
            document.getElementById('profileDropdown').style.display = 'none';
            
            // Populate profile form
            document.getElementById('profileName').value = `${app.currentUser.firstName} ${app.currentUser.lastName}`;
            document.getElementById('profileEmail').value = app.currentUser.email;
            document.getElementById('profilePhone').value = app.currentUser.phone || '';
            document.getElementById('profileCountry').value = app.currentUser.nationality;
            document.getElementById('profileRole').value = app.currentUser.role;
            document.getElementById('profileJoiningDate').value = formatDate(app.currentUser.joiningDate);
            
            // Set profile image
            document.getElementById('profilePopupImage').src = app.currentUser.profileImage;
            
            // Disable editing by default
            toggleProfileEditing(false);
            
            openPopup('profilePopup');
        }
        
        function toggleProfileEditing(enable = true) {
            const isEdit = typeof enable === 'boolean' ? enable : true;
            
            const inputs = ['profileName', 'profileEmail', 'profilePhone'];
            
            inputs.forEach(inputId => {
                document.getElementById(inputId).readOnly = !isEdit;
            });
            
            const editButton = document.getElementById('editProfile');
            
            if (isEdit) {
                editButton.textContent = 'Save Changes';
                editButton.removeEventListener('click', toggleProfileEditing);
                editButton.addEventListener('click', saveProfileChanges);
            } else {
                editButton.textContent = 'Edit Profile';
                editButton.removeEventListener('click', saveProfileChanges);
                editButton.addEventListener('click', toggleProfileEditing);
            }
        }
        
        function saveProfileChanges() {
            const fullName = document.getElementById('profileName').value.split(' ');
            const firstName = fullName[0];
            const lastName = fullName.slice(1).join(' ');
            const email = document.getElementById('profileEmail').value;
            const phone = document.getElementById('profilePhone').value;
            
            app.updateUser(app.currentUser.id, {
                firstName,
                lastName,
                email,
                phone
            });
            
            toggleProfileEditing(false);
            document.getElementById('profileName').value = `${firstName} ${lastName}`;
            
            showToast('Profile Updated', 'Your profile has been updated successfully.');
        }
        
        function handleProfileImageChange(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    document.getElementById('profilePopupImage').src = event.target.result;
                    document.getElementById('profileImage').src = event.target.result;
                    
                    app.updateUser(app.currentUser.id, {
                        profileImage: event.target.result
                    });
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function showStatusPopup() {
            document.getElementById('profileDropdown').style.display = 'none';
            openPopup('statusPopup');
            
            // Select current status
            document.querySelectorAll('.status-option').forEach(option => {
                option.style.borderColor = 'transparent';
                
                if (option.dataset.status === app.userStatus) {
                    option.style.borderColor = option.querySelector('div').style.backgroundColor;
                }
            });
        }
        
        function handleSaveStatus() {
            const selectedStatus = document.querySelector('.status-option[style*="border-color"]')?.dataset.status || 'online';
            const statusMessage = document.getElementById('statusMessage').value;
            
            app.setUserStatus(selectedStatus);
            
            closePopup('statusPopup');
            showToast('Status Updated', `Your status is now set to ${selectedStatus}.`);
        }
        
        function handleDarkModeToggle() {
            document.getElementById('profileDropdown').style.display = 'none';
            
            const isDarkMode = app.toggleDarkMode();
            const modeSwitcherIcon = document.getElementById('modeSwitcher');
            const switchModeBtn = document.getElementById('switchModeBtn');
            
            if (isDarkMode) {
                modeSwitcherIcon.innerHTML = '<i class="fas fa-moon"></i>';
                switchModeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            } else {
                modeSwitcherIcon.innerHTML = '<i class="fas fa-sun"></i>';
                switchModeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            }
        }
        
        function showAddTaskPopup() {
            document.getElementById('taskPopupTitle').textContent = 'Add New Task';
            document.getElementById('saveTask').textContent = 'Create';
            
            // Reset form
            document.getElementById('taskForm').reset();
            document.getElementById('taskId').value = '';
            document.getElementById('subTasksContainer').innerHTML = '';
            
            openPopup('addTaskPopup');
            
            // Focus on the title field
            setTimeout(() => {
                document.getElementById('taskTitle').focus();
            }, 100);
        }
        
        function showEditTaskPopup(taskId) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found.', 'danger');
                return;
            }
            
            document.getElementById('taskPopupTitle').textContent = 'Edit Task';
            document.getElementById('saveTask').textContent = 'Save Changes';
            
            // Populate form
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskNotes').value = task.notes || '';
            
            // Set due date
            const dueDate = task.dueDate ? new Date(task.dueDate) : new Date();
            const dueDateInstance = flatpickr('#taskDueDate', {
                dateFormat: 'Y-m-d',
                defaultDate: dueDate
            });
            dueDateInstance.setDate(dueDate);
            
            // Set priority and category
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskCategory').value = task.category;
            
            // Add subtasks
            document.getElementById('subTasksContainer').innerHTML = '';
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    addSubTaskField(subtask);
                });
            }
            
            openPopup('addTaskPopup');
            
            // Focus on the title field
            setTimeout(() => {
                document.getElementById('taskTitle').focus();
            }, 100);
        }
        
        function addSubTaskField(subtask = null) {
            const container = document.getElementById('subTasksContainer');
            const subtaskId = subtask ? subtask.id : generateId();
            
            const subTaskDiv = document.createElement('div');
            subTaskDiv.className = 'sub-task-item';
            subTaskDiv.innerHTML = `
                <input type="text" class="sub-task-input" value="${subtask ? subtask.title : ''}" placeholder="Sub-task title">
                <input type="hidden" value="${subtaskId}">
                <input type="checkbox" ${subtask && subtask.completed ? 'checked' : ''} title="Mark as completed">
                <button type="button" class="remove-sub-task" title="Remove sub-task">&times;</button>
            `;
            
            // Add event listener to remove button
            subTaskDiv.querySelector('.remove-sub-task').addEventListener('click', function() {
                subTaskDiv.remove();
            });
            
            container.appendChild(subTaskDiv);
        }
        
        function handleSaveTask() {
            const taskId = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;
            const category = document.getElementById('taskCategory').value;
            const notes = document.getElementById('taskNotes').value;
            
            // Validate required fields
            if (!title || !dueDate || !priority || !category) {
                showToast('Error', 'Please fill in all required fields.', 'danger');
                return;
            }
            
            // Get subtasks
            const subtasks = [];
            document.querySelectorAll('.sub-task-item').forEach(item => {
                const title = item.querySelector('.sub-task-input').value.trim();
                if (title) {
                    subtasks.push({
                        id: item.querySelector('input[type="hidden"]').value,
                        title: title,
                        completed: item.querySelector('input[type="checkbox"]').checked
                    });
                }
            });
            
            const taskData = {
                title,
                description,
                dueDate: new Date(dueDate).toISOString(),
                priority,
                category,
                notes,
                subtasks
            };
            
            if (taskId) {
                // Update existing task
                app.updateTask(taskId, taskData);
                showToast('Task Updated', 'The task has been updated successfully.');
            } else {
                // Add new task
                app.addTask(taskData);
                showToast('Task Created', 'The task has been created successfully.');
            }
            
            closePopup('addTaskPopup');
            renderTaskList();
            updateTaskSummary();
            updateTaskInsights();
            renderGraphs();
        }
        
        function handleViewTask(taskId) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found.', 'danger');
                return;
            }
            
            const viewTaskTitle = document.getElementById('viewTaskTitle');
            const viewTaskBody = document.getElementById('viewTaskBody');
            
            viewTaskTitle.textContent = task.title;
            viewTaskTitle.dataset.taskId = task.id;
            
            const dueDateFormatted = formatDate(task.dueDate);
            const createdAtFormatted = formatDate(task.createdAt);
            const completedAtFormatted = task.completedAt ? formatDate(task.completedAt) : 'Not completed';
            
            const priorityClass = task.priority === 'high' ? 'badge-priority high' : 
                              task.priority === 'medium' ? 'badge-priority medium' : 
                              'badge-priority low';
            
            const subtasksHtml = task.subtasks && task.subtasks.length > 0 ? 
                `<div class="form-group">
                    <label>Sub-Tasks:</label>
                    <ul style="list-style: none; padding-left: 0;">
                        ${task.subtasks.map(subtask => `
                            <li style="display: flex; align-items: center; margin-bottom: 8px; padding: 8px; background-color: var(--input-bg); border-radius: var(--radius-sm);">
                                <div style="width: 16px; height: 16px; border: 2px solid var(--primary-color); border-radius: 3px; margin-right: 10px; position: relative; flex-shrink: 0;">
                                    ${subtask.completed ? '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center; color: var(--primary-color); font-weight: bold;">✓</div>' : ''}
                                </div>
                                <span style="${subtask.completed ? 'text-decoration: line-through; color: var(--gray-color);' : ''}">${subtask.title}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>` : '';
            
            const timeSpentFormatted = task.timeSpent ? formatTime(task.timeSpent) : '00:00:00';
            
            viewTaskBody.innerHTML = `
                <div class="form-group">
                    <label>Description:</label>
                    <p>${task.description || 'No description provided.'}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div class="form-group">
                        <label>Due Date:</label>
                        <p>${dueDateFormatted}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Priority:</label>
                        <p><span class="${priorityClass}" style="font-size: 100%; text-transform: capitalize;">${task.priority}</span></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Category:</label>
                        <p><span class="badge-category" style="font-size: 100%;">${task.category}</span></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Status:</label>
                        <p><span class="badge-${task.completed ? 'success' : 'warning'}" style="background-color: ${task.completed ? 'rgba(40, 167, 69, 0.2)' : 'rgba(255, 193, 7, 0.2)'}; color: ${task.completed ? 'var(--success-color)' : 'var(--warning-color)'}; padding: 3px 8px; border-radius: 12px; font-weight: 500;">${task.completed ? 'Completed' : 'Active'}</span></p>
                    </div>
                    
                    <div class="form-group">
                        <label>Created:</label>
                        <p>${createdAtFormatted}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Completed:</label>
                        <p>${completedAtFormatted}</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Time Spent:</label>
                        <p>${timeSpentFormatted}</p>
                    </div>
                </div>
                
                ${subtasksHtml}
                
                ${task.notes ? `
                <div class="form-group">
                    <label>Notes:</label>
                    <p>${task.notes}</p>
                </div>
                ` : ''}
            `;
            
            openPopup('viewTaskPopup');
        }
        
        function handleDeleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                app.deleteTask(taskId);
                renderTaskList();
                updateTaskSummary();
                updateTaskInsights();
                renderGraphs();
                showToast('Task Deleted', 'The task has been deleted successfully.');
            }
        }
        
        function showShareTaskPopup(taskId) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found.', 'danger');
                return;
            }
            
            // Store task ID in the popup
            document.getElementById('confirmShare').dataset.taskId = taskId;
            
            // Populate users list
            const usersListElement = document.getElementById('shareUsersList');
            usersListElement.innerHTML = '';
            
            app.users.forEach(user => {
                if (user.id !== app.currentUser.id) {
                    const userDiv = document.createElement('div');
                    userDiv.style.display = 'flex';
                    userDiv.style.alignItems = 'center';
                    userDiv.style.margin = '10px 0';
                    userDiv.style.padding = '10px';
                    userDiv.style.borderRadius = 'var(--radius-md)';
                    userDiv.style.backgroundColor = 'var(--input-bg)';
                    
                    userDiv.innerHTML = `
                        <input type="checkbox" id="share-${user.id}" value="${user.id}" style="margin-right: 10px;">
                        <img src="${user.profileImage}" alt="${user.firstName}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                        <label for="share-${user.id}" style="cursor: pointer;">${user.firstName} ${user.lastName} (${user.role})</label>
                    `;
                    
                    usersListElement.appendChild(userDiv);
                }
            });
            
            openPopup('shareTaskPopup');
        }
        
        function handleShareTask() {
            const taskId = document.getElementById('confirmShare').dataset.taskId;
            const task = app.tasks.find(t => t.id === taskId);
            const message = document.getElementById('shareMessage').value;
            
            // Get selected users
            const selectedUsers = [];
            document.querySelectorAll('#shareUsersList input[type="checkbox"]:checked').forEach(checkbox => {
                selectedUsers.push(checkbox.value);
            });
            
            if (selectedUsers.length === 0) {
                showToast('Error', 'Please select at least one user to share with.', 'danger');
                return;
            }
            
            // In a real app, this would send the task to these users.
            // For now, we'll just show a notification.
            showToast('Task Shared', `Task "${task.title}" has been shared with ${selectedUsers.length} user(s).`);
            
            // Add a notification about the share
            app.addNotification({
                title: 'Task Shared',
                content: `You shared task "${task.title}" with ${selectedUsers.length} user(s).`,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            updateNotificationBadge();
            closePopup('shareTaskPopup');
        }
        
        function handleTaskTimer(taskId, action) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found.', 'danger');
                return;
            }
            
            if (action === 'play') {
                if (app.currentTimerTask && app.currentTimerTask !== taskId) {
                    const currentTask = app.tasks.find(t => t.id === app.currentTimerTask);
                    showToast('Timer Alert', `Timer paused for task "${currentTask.title}". Now tracking time for "${task.title}".`, 'warning');
                }
                
                app.startTimer(taskId);
                showToast('Timer Started', `Now tracking time for task "${task.title}".`);
                
                // Update the play/pause button for the task
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    const playButton = taskElement.querySelector('.task-btn-play');
                    const pauseButton = taskElement.querySelector('.task-btn-pause');
                    
                    playButton.style.display = 'none';
                    pauseButton.style.display = 'inline-block';
                }
                
            } else if (action === 'pause') {
                app.pauseTimer();
                showToast('Timer Paused', `Time tracking paused for task "${task.title}".`);
                
                // Alert with time spent
                const timeSpent = task.timeSpent ? formatTime(task.timeSpent) : '00:00:00';
                alert(`Time spent on task "${task.title}": ${timeSpent}`);
                
                // Update the play/pause button for the task
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    const playButton = taskElement.querySelector('.task-btn-play');
                    const pauseButton = taskElement.querySelector('.task-btn-pause');
                    
                    playButton.style.display = 'inline-block';
                    pauseButton.style.display = 'none';
                }
            }
            
            renderTaskList();
        }
        
        function handleToggleTaskCompletion(taskId) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found.', 'danger');
                return;
            }
            
            // Toggle task completion
            app.updateTask(taskId, { completed: !task.completed });
            
            renderTaskList();
            updateTaskSummary();
            updateTaskInsights();
            renderGraphs();
            
            showToast('Task Updated', `Task "${task.title}" marked as ${task.completed ? 'active' : 'completed'}.`);
        }
        
        function handleToggleSubtaskCompletion(taskId, subtaskId) {
            const task = app.tasks.find(t => t.id === taskId);
            
            if (!task || !task.subtasks) {
                return;
            }
            
            const subtaskIndex = task.subtasks.findIndex(st => st.id === subtaskId);
            
            if (subtaskIndex !== -1) {
                const updatedSubtasks = [...task.subtasks];
                updatedSubtasks[subtaskIndex].completed = !updatedSubtasks[subtaskIndex].completed;
                
                app.updateTask(taskId, { subtasks: updatedSubtasks });
                renderTaskList();
            }
        }
        
        function handleExportTasks() {
            const format = document.getElementById('exportFormat').value;
            
            try {
                const result = app.exportTasks(format);
                
                if (result) {
                    // Create a download link
                    const url = URL.createObjectURL(result.blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = result.filename;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showToast('Export Successful', `Tasks exported as ${format.toUpperCase()} file.`);
                } else {
                    showToast('Export Error', 'Failed to export tasks.', 'danger');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Export Error', `Failed to export tasks: ${error.message}`, 'danger');
            }
            
            closePopup('exportPopup');
        }
        
        function handleImportTasks() {
            const file = document.getElementById('importFile').files[0];
            const url = document.getElementById('importUrl').value;
            
            if (!file && !url) {
                showToast('Import Error', 'Please provide a file or URL to import from.', 'danger');
                return;
            }
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const importCount = app.importTasks(event.target.result);
                        closePopup('importPopup');
                        renderTaskList();
                        updateTaskSummary();
                        updateTaskInsights();
                        renderGraphs();
                        showToast('Import Successful', `${importCount} tasks imported successfully.`);
                    } catch (error) {
                        showToast('Import Error', `Failed to import tasks: ${error.message}`, 'danger');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Import Error', 'Failed to read file.', 'danger');
                };
                
                reader.readAsText(file);
            } else if (url) {
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .then(data => {
                        try {
                            const importCount = app.importTasks(data);
                            closePopup('importPopup');
                            renderTaskList();
                            updateTaskSummary();
                            updateTaskInsights();
                            renderGraphs();
                            showToast('Import Successful', `${importCount} tasks imported successfully.`);
                        } catch (error) {
                            showToast('Import Error', `Failed to import tasks: ${error.message}`, 'danger');
                        }
                    })
                    .catch(error => {
                        showToast('Import Error', `Failed to fetch from URL: ${error.message}`, 'danger');
                    });
            }
        }
        
        function handleAddCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            
            if (!newCategory) {
                showToast('Error', 'Please enter a category name.', 'danger');
                return;
            }
            
            if (app.categories.includes(newCategory)) {
                showToast('Error', 'This category already exists.', 'danger');
                return;
            }
            
            app.addCategory(newCategory);
            document.getElementById('newCategory').value = '';
            renderCategories();
            updateCategorySelectors();
            showToast('Category Added', `Category "${newCategory}" has been added.`);
        }
        
        function handleDeleteCategory(category) {
            if (app.categories.length <= 1) {
                showToast('Error', 'Cannot delete the last remaining category.', 'danger');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the category "${category}"? Tasks in this category will be moved to another category.`)) {
                app.deleteCategory(category);
                renderCategories();
                updateCategorySelectors();
                showToast('Category Deleted', `Category "${category}" has been deleted.`);
            }
        }
        
        function handleUndo() {
            if (app.undo()) {
                renderTaskList();
                updateTaskSummary();
                updateTaskInsights();
                renderGraphs();
                updateUndoRedoButtons();
                showToast('Action Undone', 'Your last action has been undone.');
            } else {
                showToast('Cannot Undo', 'There are no actions to undo.', 'warning');
            }
        }
        
        function handleRedo() {
            if (app.redo()) {
                renderTaskList();
                updateTaskSummary();
                updateTaskInsights();
                renderGraphs();
                updateUndoRedoButtons();
                showToast('Action Redone', 'Your last undone action has been redone.');
            } else {
                showToast('Cannot Redo', 'There are no actions to redo.', 'warning');
            }
        }
        
        function handleCompleteSelected() {
            const count = app.completeSelectedTasks();
            if (count > 0) {
                renderTaskList();
                updateTaskSummary();
                updateTaskInsights();
                renderGraphs();
                document.getElementById('multiSelectBar').style.display = 'none';
                showToast('Tasks Completed', `${count} tasks have been marked as completed.`);
            }
        }
        
        function handleDeleteSelected() {
            if (confirm('Are you sure you want to delete all selected tasks?')) {
                const count = app.deleteSelectedTasks();
                if (count > 0) {
                    renderTaskList();
                    updateTaskSummary();
                    updateTaskInsights();
                    renderGraphs();
                    document.getElementById('multiSelectBar').style.display = 'none';
                    showToast('Tasks Deleted', `${count} tasks have been deleted.`);
                }
            }
        }
        
        function handleCancelSelection() {
            app.clearTaskSelection();
            renderTaskList();
            document.getElementById('multiSelectBar').style.display = 'none';
        }
        
        function handleDueDateFilter() {
            const dueDateFilter = document.getElementById('dueDateFilter');
            
            if (dueDateFilter.value === 'custom') {
                openPopup('dateRangePopup');
            } else {
                applyFilters();
            }
        }
        
        function handleApplyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showToast('Error', 'Please select both start and end dates.', 'danger');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showToast('Error', 'Start date cannot be after end date.', 'danger');
                return;
            }
            
            // Store date range in the filter element
            document.getElementById('dueDateFilter').dataset.startDate = startDate;
            document.getElementById('dueDateFilter').dataset.endDate = endDate;
            
            closePopup('dateRangePopup');
            applyFilters();
        }
        
        // UI UPDATE FUNCTIONS
        function initializeDashboard() {
            renderTaskList();
            updateTaskSummary();
            updateTaskInsights();
            renderGraphs();
            renderCategories();
            updateUndoRedoButtons();
            updateNotificationBadge();
            showUsers();
        }
        
        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            // Get filter values
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const dueDateFilter = document.getElementById('dueDateFilter').value;
            const searchInput = document.getElementById('searchInput').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            // Get date range if custom filter is selected
            let dateRange = null;
            if (dueDateFilter === 'custom') {
                const startDate = document.getElementById('dueDateFilter').dataset.startDate;
                const endDate = document.getElementById('dueDateFilter').dataset.endDate;
                
                if (startDate && endDate) {
                    dateRange = { start: startDate, end: endDate };
                }
            }
            
            // Filter and sort tasks
            const filteredTasks = app.filterTasks({
                status: statusFilter,
                category: categoryFilter,
                priority: priorityFilter,
                dueDate: dueDateFilter,
                search: searchInput,
                sort: sortFilter,
                dateRange
            });
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 40px; background-color: var(--card-bg); border-radius: var(--radius-md); box-shadow: var(--shadow-sm);">
                        <i class="fas fa-tasks" style="font-size: 48px; color: var(--primary-color); margin-bottom: 20px;"></i>
                        <h3 style="margin-bottom: 10px; color: var(--text-color);">No tasks found</h3>
                        <p style="color: var(--gray-color);">Try changing your filters or create a new task.</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="document.getElementById('addTaskBtn').click()">
                            <i class="fas fa-plus"></i> Add New Task
                        </button>
                    </div>
                `;
                return;
            }
            
            // Create task items
            filteredTasks.forEach(task => {
                const now = new Date();
                const dueDate = new Date(task.dueDate);
                const timeDiff = dueDate - now;
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                
                let taskStatus = '';
                if (task.completed) {
                    taskStatus = 'completed';
                } else if (hoursDiff < 0) {
                    taskStatus = 'expired';
                } else if (hoursDiff <= 48) {
                    taskStatus = 'due-soon';
                }
                
                const priorityClass = task.priority === 'high' ? 'high' : 
                                  task.priority === 'medium' ? 'medium' : 'low';
                
                const isSelected = app.selectedTasks.has(task.id);
                
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${taskStatus}`;
                taskElement.dataset.taskId = task.id;
                taskElement.draggable = true;
                
                // Subtasks HTML
                let subtasksHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    subtasksHtml = `
                        <div class="task-subtasks">
                            ${task.subtasks.map(subtask => `
                                <div class="subtask-item" data-subtask-id="${subtask.id}">
                                    <div class="subtask-checkbox ${subtask.completed ? 'checked' : ''}" onclick="handleToggleSubtaskCompletion('${task.id}', '${subtask.id}')"></div>
                                    <p class="subtask-title ${subtask.completed ? 'completed' : ''}">${subtask.title}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Format time spent
                const timeSpent = task.timeSpent ? formatTime(task.timeSpent) : '00:00:00';
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-title-area">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="handleToggleTaskCompletion('${task.id}')"></div>
                            <h3 class="task-title ${task.completed ? 'completed' : ''}">${task.title}</h3>
                        </div>
                        
                        <div class="task-badges">
                            <span class="task-badge badge-due-date">Due: ${formatDate(task.dueDate)}</span>
                            <span class="task-badge badge-priority ${priorityClass}">${task.priority}</span>
                            <span class="task-badge badge-category">${task.category}</span>
                        </div>
                    </div>
                    
                    <p class="task-description">${task.description || ''}</p>
                    
                    ${subtasksHtml}
                    
                    <div class="task-footer">
                        <div class="task-timer-info">
                            <i class="fas fa-clock"></i> ${timeSpent}
                        </div>
                        
                        <div class="task-actions">
                            <button class="task-btn task-btn-play" style="${app.currentTimerTask === task.id ? 'display: none;' : ''}" onclick="handleTaskTimer('${task.id}', 'play')">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="task-btn task-btn-pause" style="${app.currentTimerTask === task.id ? '' : 'display: none;'}" onclick="handleTaskTimer('${task.id}', 'pause')">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="task-btn task-btn-view" onclick="handleViewTask('${task.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="task-btn task-btn-edit" onclick="showEditTaskPopup('${task.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="task-btn task-btn-share" onclick="showShareTaskPopup('${task.id}')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="task-btn task-btn-delete" onclick="handleDeleteTask('${task.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add drag and drop event listeners
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragover', handleDragOver);
                taskElement.addEventListener('dragenter', handleDragEnter);
                taskElement.addEventListener('dragleave', handleDragLeave);
                taskElement.addEventListener('drop', handleDrop);
                taskElement.addEventListener('dragend', handleDragEnd);
                
                // Add task selection event
                taskElement.querySelector('.task-checkbox').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const count = app.toggleTaskSelection(task.id);
                    
                    if (count > 0) {
                        document.getElementById('multiSelectBar').style.display = 'flex';
                        document.getElementById('selectedTasksCount').textContent = count;
                    } else {
                        document.getElementById('multiSelectBar').style.display = 'none';
                    }
                    
                    renderTaskList();
                });
                
                taskList.appendChild(taskElement);
            });
            
            // Update multi-select bar visibility
            if (app.selectedTasks.size > 0) {
                document.getElementById('multiSelectBar').style.display = 'flex';
                document.getElementById('selectedTasksCount').textContent = app.selectedTasks.size;
            } else {
                document.getElementById('multiSelectBar').style.display = 'none';
            }
        }
        
        // Drag and drop handlers
        let draggedElement = null;
        
        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedElement = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            this.classList.add('over');
        }
        
        function handleDragLeave(e) {
            this.classList.remove('over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                // Reorder tasks in the app state
                const taskList = document.getElementById('taskList');
                const tasks = Array.from(taskList.querySelectorAll('.task-item'));
                const fromIndex = tasks.indexOf(draggedElement);
                const toIndex = tasks.indexOf(this);
                
                app.reorderTasks(fromIndex, toIndex);
                
                // Re-render the list
                renderTaskList();
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('over', 'dragging');
            });
        }
        
        function updateTaskSummary() {
            const stats = app.getTasksStats();
            
            document.getElementById('totalTasksCount').textContent = stats.totalTasks;
            document.getElementById('completedTasksCount').textContent = stats.completedTasks;
            document.getElementById('pendingTasksCount').textContent = stats.pendingTasks;
        }
        
        function updateTaskInsights() {
            const stats = app.getTasksStats();
            
            document.getElementById('onTimeCompletionRate').textContent = `${stats.onTimeRate}%`;
            document.getElementById('tasksDueSoon').textContent = stats.dueSoon;
            document.getElementById('expiredTasks').textContent = stats.expired;
            document.getElementById('avgCompletionTime').textContent = `${stats.avgCompletionTime}h`;
        }
        
        function renderGraphs() {
            // Destroy existing charts
            if (window.tasksProgressChart) {
                window.tasksProgressChart.destroy();
            }
            
            if (window.taskDistributionChart) {
                window.taskDistributionChart.destroy();
            }
            
            // Get chart data
            const progressData = app.getTasksProgressData();
            const distributionData = app.getTaskDistributionData();
            
            // Create tasks progress chart
            const progressCtx = document.getElementById('tasksProgressChart').getContext('2d');
            window.tasksProgressChart = new Chart(progressCtx, {
                type: 'bar',
                data: progressData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color')
                            }
                        },
                        y: {
                            ticks: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.body).getPropertyValue('--border-color')
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
            
            // Create task distribution chart
            const distributionCtx = document.getElementById('taskDistributionChart').getContext('2d');
            window.taskDistributionChart = new Chart(distributionCtx, {
                type: 'pie',
                data: distributionData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.body).getPropertyValue('--text-color')
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });
        }
        
        function renderCategories() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            app.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.display = 'flex';
                categoryDiv.style.justifyContent = 'space-between';
                categoryDiv.style.alignItems = 'center';
                categoryDiv.style.padding = '10px';
                categoryDiv.style.marginBottom = '10px';
                categoryDiv.style.borderRadius = 'var(--radius-md)';
                categoryDiv.style.backgroundColor = 'var(--input-bg)';
                
                categoryDiv.innerHTML = `
                    <span>${category}</span>
                    <button class="btn-outline" style="border: none; padding: 5px; background: none; color: var(--danger-color); cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                categoryDiv.querySelector('button').addEventListener('click', () => {
                    handleDeleteCategory(category);
                });
                
                categoriesList.appendChild(categoryDiv);
            });
        }
        
        function updateCategorySelectors() {
            const taskCategorySelect = document.getElementById('taskCategory');
            const categoryFilterSelect = document.getElementById('categoryFilter');
            
            // Save current values
            const taskCategoryValue = taskCategorySelect.value;
            const categoryFilterValue = categoryFilterSelect.value;
            
            // Clear options
            taskCategorySelect.innerHTML = '';
            categoryFilterSelect.innerHTML = '<option value="all">All</option>';
            
            // Add options
            app.categories.forEach(category => {
                const taskOption = document.createElement('option');
                taskOption.value = category;
                taskOption.textContent = category;
                taskCategorySelect.appendChild(taskOption);
                
                const filterOption = document.createElement('option');
                filterOption.value = category;
                filterOption.textContent = category;
                categoryFilterSelect.appendChild(filterOption);
            });
            
            // Restore values if they still exist in options
            if (app.categories.includes(taskCategoryValue)) {
                taskCategorySelect.value = taskCategoryValue;
            }
            
            if (categoryFilterValue === 'all' || app.categories.includes(categoryFilterValue)) {
                categoryFilterSelect.value = categoryFilterValue;
            } else {
                categoryFilterSelect.value = 'all';
            }
        }
        
        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = app.taskHistory.past.length === 0;
            document.getElementById('redoBtn').disabled = app.taskHistory.future.length === 0;
        }
        
        function updateNotificationBadge() {
            const count = app.getUnreadNotificationCount();
            const badge = document.getElementById('notificationBadge');
            
            badge.textContent = count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }
        
        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '';
            
            if (app.notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--gray-color);">
                        No notifications to display.
                    </div>
                `;
                return;
            }
            
            app.notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationItem.dataset.id = notification.id;
                
                const timeAgo = getTimeAgo(new Date(notification.timestamp));
                
                notificationItem.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-content">${notification.content}</div>
                    <div class="notification-time">${timeAgo}</div>
                `;
                
                notificationItem.addEventListener('click', () => {
                    if (!notification.read) {
                        app.markNotificationAsRead(notification.id);
                        notificationItem.classList.remove('unread');
                        updateNotificationBadge();
                    }
                });
                
                notificationsList.appendChild(notificationItem);
            });
        }
        
        function markAllNotificationsAsRead() {
            app.markAllNotificationsAsRead();
            updateNotificationBadge();
            renderNotifications();
            showToast('Notifications', 'All notifications marked as read.');
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffDays > 0) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else if (diffHours > 0) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffMinutes > 0) {
                return `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
            } else {
                return 'Just now';
            }
        }
        
        function showUsers() {
            const usersGrid = document.getElementById('usersGrid');
            usersGrid.innerHTML = '';
            
            app.users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                userCard.innerHTML = `
                    <img src="${user.profileImage}" alt="${user.firstName}" class="user-avatar">
                    <h3 class="user-name">${user.firstName} ${user.lastName}</h3>
                    <p class="user-email">${user.email}</p>
                    <div class="user-role">${user.role}</div>
                `;
                
                usersGrid.appendChild(userCard);
            });
        }
        
        function applyFilters() {
            renderTaskList();
        }
        
        function switchView(viewId) {
            // Hide all views
            document.getElementById('listView').classList.remove('active');
            document.getElementById('graphView').classList.remove('active');
            
            // Remove active class from buttons
            document.getElementById('listViewBtn').classList.remove('active');
            document.getElementById('graphViewBtn').classList.remove('active');
            
            // Show selected view
            document.getElementById(viewId).classList.add('active');
            
            // Add active class to button
            document.getElementById(`${viewId}Btn`).classList.add('active');
            
            // Update charts if switching to graph view
            if (viewId === 'graphView') {
                renderGraphs();
            }
        }
    </script>
</body>
</html>
