<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif']
                    },
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#00008B',
                        success: '#28A745',
                        warning: '#FFC107',
                        danger: '#DC3545',
                        orange: '#FD7E14',
                        darkred: '#8B0000',
                        dark: '#1C2526'
                    },
                    animation: {
                        'glow': 'glow 1.5s ease-in-out infinite alternate',
                        'move-light': 'move-light 3s linear infinite',
                        'fade-in': 'fade-in 0.3s ease-in-out',
                        'fade-out': 'fade-out 0.3s ease-in-out',
                        'scale-up': 'scale-up 0.3s ease-in-out',
                        'slide-in': 'slide-in 0.3s ease-in-out',
                        'slide-out': 'slide-out 0.3s ease-in-out',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #5D5CDE, 0 0 10px #5D5CDE' },
                            '100%': { boxShadow: '0 0 10px #5D5CDE, 0 0 20px #5D5CDE' }
                        },
                        'move-light': {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' }
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        'fade-out': {
                            '0%': { opacity: '1' },
                            '100%': { opacity: '0' }
                        },
                        'scale-up': {
                            '0%': { transform: 'scale(0.95)' },
                            '100%': { transform: 'scale(1)' }
                        },
                        'slide-in': {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        'slide-out': {
                            '0%': { transform: 'translateY(0)', opacity: '1' },
                            '100%': { transform: 'translateY(20px)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary: #5D5CDE;
            --secondary: #00008B;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --orange: #FD7E14;
            --darkred: #8B0000;
            --dark: #1C2526;
        }

        html {
            scroll-behavior: smooth;
        }

        html.dark {
            color-scheme: dark;
        }

        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s ease;
        }

        .dark body {
            background: linear-gradient(to bottom, var(--darkred), #4B0000);
            color: #f3f4f6;
        }

        body:not(.dark) {
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
            color: #1a202c;
        }

        .login-bg {
            background-color: #ffffff;
        }

        .dark .login-bg {
            background-color: #1f2937;
        }

        .login-button {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .login-button:before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(90deg, #f5d020, #f53803, #ff2b92, #5D5CDE, #3eecac);
            background-size: 400% 400%;
            z-index: -1;
            border-radius: 0.5rem;
            animation: move-light 3s linear infinite;
        }

        .register-link:hover {
            text-decoration: underline;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Task cards and modals */
        .task-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .task-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .dragging {
            opacity: 0.5;
            cursor: grab;
        }

        .modal {
            animation: fade-in 0.3s ease-in-out;
        }

        .task-completed {
            opacity: 0.8;
            text-decoration: line-through;
        }

        /* Toast notifications */
        .toast {
            animation: slide-in 0.3s ease-in-out;
        }

        .toast.hiding {
            animation: slide-out 0.3s ease-in-out forwards;
        }

        /* Dashboard gradients */
        .dashboard-gradient {
            background: linear-gradient(to right, #f5f7fa, #c3cfe2);
        }

        .dark .dashboard-gradient {
            background: linear-gradient(to right, #1f2937, #111827);
        }

        /* Custom switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Insights section */
        .insights-container {
            transition: height 0.3s ease;
        }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Graph transition */
        .chart-container {
            transition: all 0.5s ease;
        }

        /* Action bar */
        .action-bar {
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .action-bar.show {
            transform: translateY(0);
        }

        /* Profile dropdown */
        .profile-dropdown {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* Make sure chart canvases have background in dark mode */
        .dark .chart-canvas {
            background: rgba(31, 41, 55, 0.8);
            border-radius: 8px;
        }

        /* Action buttons */
        .action-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .action-button:active {
            transform: translateY(1px);
        }

        /* Drag handle */
        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Tab buttons */
        .tab-button {
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background-color: var(--primary);
            color: white;
        }

        /* Focus styles for accessibility */
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Toast container */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Login Page -->
    <div id="login-page" class="flex justify-center items-center min-h-screen">
        <div class="login-bg p-8 rounded-lg shadow-lg w-full max-w-md animate-fade-in">
            <h1 class="text-3xl font-bold text-center mb-6">Task Management</h1>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" name="email" value="test@example.com" class="w-full px-4 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" name="password" value="123456" class="w-full px-4 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div class="flex justify-center">
                    <button type="submit" class="login-button bg-primary text-white w-48 py-2 rounded-md focus:outline-none transition-all">
                        <span class="relative z-10">Login</span>
                    </button>
                </div>
                <div class="text-center">
                    <p>Don't have an account? <span id="register-link" class="text-secondary register-link cursor-pointer font-medium">Register now.</span></p>
                </div>
            </form>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="register-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-8 rounded-lg shadow-lg w-full max-w-md animate-scale-up">
            <h2 class="text-2xl font-bold mb-6">Create an Account</h2>
            <form id="register-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="lastName" class="block text-sm font-medium mb-1">Last Name</label>
                        <input type="text" id="lastName" name="lastName" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                    </div>
                    <div>
                        <label for="firstName" class="block text-sm font-medium mb-1">First Name</label>
                        <input type="text" id="firstName" name="firstName" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                    </div>
                </div>
                <div>
                    <label for="registerEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="registerEmail" name="registerEmail" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="confirmEmail" class="block text-sm font-medium mb-1">Confirm Email</label>
                    <input type="email" id="confirmEmail" name="confirmEmail" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="registerPassword" name="registerPassword" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="birthdate" class="block text-sm font-medium mb-1">Birthdate</label>
                    <input type="text" id="birthdate" name="birthdate" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="nationality" class="block text-sm font-medium mb-1">Nationality</label>
                    <select id="nationality" name="nationality" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <option value="" disabled selected>Select your country</option>
                    </select>
                </div>
                <div>
                    <label for="role" class="block text-sm font-medium mb-1">Role</label>
                    <select id="role" name="role" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-between pt-4">
                    <button type="button" id="cancel-register" class="px-6 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-success text-white rounded-md transition hover:bg-green-600 action-button">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <header class="dashboard-gradient shadow-md p-4">
            <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold mb-4 sm:mb-0">To-Do App</h1>
                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-full focus:outline-none relative" aria-label="Toggle theme">
                        <i id="theme-icon" class="fas fa-sun text-xl"></i>
                    </button>

                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notification-btn" class="p-2 rounded-full focus:outline-none relative" aria-label="View notifications">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notification-count" class="notification-badge hidden">0</span>
                        </button>
                    </div>

                    <!-- Users Button -->
                    <button id="users-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-secondary transition action-button">Users</button>
                    
                    <!-- Profile -->
                    <div class="relative">
                        <button id="profile-btn" class="relative focus:outline-none" aria-label="User profile">
                            <img id="user-avatar" src="https://randomuser.me/api/portraits/men/1.jpg" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
                        </button>
                        <!-- Profile Dropdown -->
                        <div id="profile-dropdown" class="profile-dropdown absolute right-0 mt-2 w-48 py-2 bg-white dark:bg-gray-800 rounded-md shadow-xl z-20">
                            <a href="#" id="view-profile" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user mr-2"></i> View Profile
                            </a>
                            <a href="#" id="switch-mode" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-adjust mr-2"></i> Switch Mode
                            </a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer -->
            <div class="container mx-auto mt-4 p-3 border dark:border-gray-700 rounded-lg max-w-xs mx-auto flex justify-between items-center shadow-md bg-white dark:bg-gray-800">
                <div>
                    <span class="font-medium text-sm">Task Timer:</span>
                </div>
                <div class="flex items-center">
                    <span id="task-timer" class="text-xl font-mono">00:00:00</span>
                    <button id="timer-control" class="ml-3 text-primary" disabled>
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4">
            <!-- Tasks Summary -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 task-card col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4">Total Tasks: <span id="total-task-count">0</span></h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-success bg-opacity-20 dark:bg-opacity-10 p-6 rounded-lg shadow task-card">
                            <h3 class="text-lg font-semibold mb-2">Completed Tasks</h3>
                            <p class="text-4xl font-bold text-success"><span id="completed-task-count">0</span></p>
                        </div>
                        <div class="bg-warning bg-opacity-20 dark:bg-opacity-10 p-6 rounded-lg shadow task-card">
                            <h3 class="text-lg font-semibold mb-2">Pending Tasks</h3>
                            <p class="text-4xl font-bold text-warning"><span id="pending-task-count">0</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tasks Section -->
            <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <h2 class="text-2xl font-bold mb-4 sm:mb-0">Tasks</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="add-task-btn" class="px-4 py-2 bg-success text-white rounded-md hover:bg-green-600 transition action-button">
                            <i class="fas fa-plus mr-1"></i> Add Task
                        </button>
                        <button id="export-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-indigo-600 transition action-button">
                            <i class="fas fa-file-export mr-1"></i> Export
                        </button>
                        <button id="import-btn" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-blue-900 transition action-button">
                            <i class="fas fa-file-import mr-1"></i> Import
                        </button>
                        <button id="manage-categories-btn" class="px-4 py-2 bg-orange text-white rounded-md hover:bg-orange-600 transition action-button">
                            <i class="fas fa-tags mr-1"></i> Manage Categories
                        </button>
                    </div>
                </div>

                <!-- View Switcher -->
                <div class="flex mb-6 border rounded-md overflow-hidden">
                    <button id="list-view-btn" class="flex-1 p-2 tab-button active">
                        <i class="fas fa-list mr-1"></i> List View
                    </button>
                    <button id="graph-view-btn" class="flex-1 p-2 tab-button">
                        <i class="fas fa-chart-pie mr-1"></i> Graph View
                    </button>
                </div>

                <!-- Filters & Search -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search tasks..." class="w-full px-4 py-2 pr-10 border rounded-md text-base">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <select id="status-filter" class="px-4 py-2 border rounded-md text-base">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="category-filter" class="px-4 py-2 border rounded-md text-base">
                        <option value="all">All Categories</option>
                    </select>
                    <select id="priority-filter" class="px-4 py-2 border rounded-md text-base">
                        <option value="all">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="duedate-filter" class="px-4 py-2 border rounded-md text-base">
                        <option value="all">All Due Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <!-- Sort Options -->
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex items-center">
                        <label for="sort-select" class="mr-2">Sort By:</label>
                        <select id="sort-select" class="px-3 py-1 border rounded-md text-base">
                            <option value="title-asc">Title (A-Z)</option>
                            <option value="title-desc">Title (Z-A)</option>
                            <option value="date-asc">Due Date (Earliest)</option>
                            <option value="date-desc">Due Date (Latest)</option>
                            <option value="priority-high">Priority (High to Low)</option>
                            <option value="priority-low">Priority (Low to High)</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="undo-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded-md transition hover:bg-gray-400 dark:hover:bg-gray-600 action-button" disabled>
                            <i class="fas fa-undo"></i>
                        </button>
                        <button id="redo-btn" class="px-3 py-1 bg-gray-300 dark:bg-gray-700 rounded-md transition hover:bg-gray-400 dark:hover:bg-gray-600 action-button" disabled>
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>

                <!-- List View -->
                <div id="list-view" class="mb-6">
                    <div id="task-container" class="space-y-4">
                        <!-- Tasks will be added here dynamically -->
                    </div>
                    <div id="no-tasks-message" class="text-center py-12 text-gray-500 dark:text-gray-400 hidden">
                        <i class="fas fa-tasks text-5xl mb-4"></i>
                        <p class="text-lg">No tasks found. Add a task to get started!</p>
                    </div>
                </div>

                <!-- Graph View -->
                <div id="graph-view" class="mb-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow chart-container">
                            <h3 class="text-lg font-semibold mb-4">Tasks Over Time</h3>
                            <div class="chart-canvas">
                                <canvas id="tasks-chart" height="250"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow chart-container">
                            <h3 class="text-lg font-semibold mb-4">Task Status</h3>
                            <div class="chart-canvas">
                                <canvas id="status-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Bar for Multiple Selection -->
                <div id="action-bar" class="fixed bottom-0 left-0 right-0 bg-primary text-white p-4 action-bar">
                    <div class="container mx-auto flex justify-between items-center">
                        <div>
                            <span id="selected-count">0</span> tasks selected
                        </div>
                        <div class="flex gap-2">
                            <button id="batch-complete-btn" class="px-4 py-2 bg-success rounded-md transition hover:bg-green-600 action-button">
                                Mark Complete
                            </button>
                            <button id="batch-delete-btn" class="px-4 py-2 bg-danger rounded-md transition hover:bg-red-600 action-button">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Insights Section -->
            <section id="insights-section" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6">Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow task-card">
                        <h3 class="text-lg font-semibold mb-3">Task Completion Rate</h3>
                        <div class="flex items-center justify-center">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center border-4 border-primary">
                                <span id="completion-rate" class="text-2xl font-bold">0%</span>
                            </div>
                        </div>
                        <p class="text-sm text-center mt-3">of all tasks completed</p>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow task-card">
                        <h3 class="text-lg font-semibold mb-3">Due Soon</h3>
                        <div class="text-center">
                            <span id="due-soon-count" class="text-4xl font-bold text-warning">0</span>
                            <p class="text-sm mt-2">tasks due in the next 48 hours</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow task-card">
                        <h3 class="text-lg font-semibold mb-3">Most Common Category</h3>
                        <div class="text-center">
                            <span id="common-category" class="text-xl font-bold">None</span>
                            <div class="mt-2 text-sm">
                                <span id="category-count" class="font-medium">0</span> tasks
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-xl max-h-[90vh] overflow-y-auto animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Add New Task</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-task-form" class="space-y-4">
                <div>
                    <label for="task-title" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="task-title" name="task-title" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="task-description" class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="task-description" name="task-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Sub-Tasks</label>
                    <div id="subtasks-container" class="space-y-2"></div>
                    <button type="button" id="add-subtask-btn" class="mt-2 text-primary hover:text-secondary transition">
                        <i class="fas fa-plus mr-1"></i> Add Sub-task
                    </button>
                </div>
                <div>
                    <label for="task-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                    <input type="text" id="task-due-date" name="task-due-date" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="task-priority" class="block text-sm font-medium mb-1">Priority</label>
                    <select id="task-priority" name="task-priority" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label for="task-category" class="block text-sm font-medium mb-1">Category</label>
                    <select id="task-category" name="task-category" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <!-- Categories will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label for="task-notes" class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="task-notes" name="task-notes" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="cancel-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-success text-white rounded-md transition hover:bg-green-600 action-button">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Task Modal -->
    <div id="view-task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-xl max-h-[90vh] overflow-y-auto animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="view-task-title">Task Title</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Description</h3>
                    <p id="view-task-description" class="mt-1">Task description here</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Sub-Tasks</h3>
                    <ul id="view-subtasks-list" class="list-disc list-inside mt-1">
                        <!-- Subtasks will be added here -->
                    </ul>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Due Date</h3>
                        <p id="view-task-due-date" class="mt-1">Due date here</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Priority</h3>
                        <p id="view-task-priority" class="mt-1">Priority here</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Category</h3>
                        <p id="view-task-category" class="mt-1">Category here</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Status</h3>
                        <p id="view-task-status" class="mt-1">Status here</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Notes</h3>
                    <p id="view-task-notes" class="mt-1">Notes here</p>
                </div>
                <div class="pt-4 flex justify-end gap-2">
                    <button class="close-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-xl max-h-[90vh] overflow-y-auto animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Edit Task</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-task-form" class="space-y-4">
                <input type="hidden" id="edit-task-id">
                <div>
                    <label for="edit-task-title" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="edit-task-title" name="edit-task-title" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="edit-task-description" class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="edit-task-description" name="edit-task-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Sub-Tasks</label>
                    <div id="edit-subtasks-container" class="space-y-2"></div>
                    <button type="button" id="edit-add-subtask-btn" class="mt-2 text-primary hover:text-secondary transition">
                        <i class="fas fa-plus mr-1"></i> Add Sub-task
                    </button>
                </div>
                <div>
                    <label for="edit-task-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                    <input type="text" id="edit-task-due-date" name="edit-task-due-date" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                </div>
                <div>
                    <label for="edit-task-priority" class="block text-sm font-medium mb-1">Priority</label>
                    <select id="edit-task-priority" name="edit-task-priority" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label for="edit-task-category" class="block text-sm font-medium mb-1">Category</label>
                    <select id="edit-task-category" name="edit-task-category" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base" required>
                        <!-- Categories will be added dynamically -->
                    </select>
                </div>
                <div>
                    <label for="edit-task-notes" class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="edit-task-notes" name="edit-task-notes" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base"></textarea>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="cancel-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-success text-white rounded-md transition hover:bg-green-600 action-button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-md animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Export Tasks</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="mb-4">Select a format to export your tasks:</p>
            <div class="space-y-3">
                <button id="export-pdf" class="w-full px-4 py-3 bg-red-600 text-white rounded-md transition hover:bg-red-700 flex items-center justify-center action-button">
                    <i class="fas fa-file-pdf mr-2"></i> Export as PDF
                </button>
                <button id="export-excel" class="w-full px-4 py-3 bg-green-600 text-white rounded-md transition hover:bg-green-700 flex items-center justify-center action-button">
                    <i class="fas fa-file-excel mr-2"></i> Export as Excel
                </button>
                <button id="export-json" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md transition hover:bg-blue-700 flex items-center justify-center action-button">
                    <i class="fas fa-file-code mr-2"></i> Export as JSON
                </button>
            </div>
            <div class="mt-4 flex justify-end">
                <button class="cancel-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-md animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Import Tasks</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Upload JSON File</label>
                    <input type="file" id="import-file" accept=".json" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary">
                    <p class="text-xs text-gray-500 mt-1">Only JSON files are supported</p>
                </div>
                <div>
                    <label for="import-url" class="block text-sm font-medium mb-2">Import from URL</label>
                    <input type="url" id="import-url" placeholder="https://example.com/tasks.json" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                </div>
                <div class="flex justify-end gap-2">
                    <button class="cancel-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                    <button id="import-btn-confirm" class="px-4 py-2 bg-primary text-white rounded-md transition hover:bg-indigo-600 action-button">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="categories-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-md animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Manage Categories</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="new-category" placeholder="New category name" class="flex-1 px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                    <button id="add-category-btn" class="px-4 py-2 bg-success text-white rounded-md transition hover:bg-green-600 action-button">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div id="categories-list" class="max-h-60 overflow-y-auto">
                <!-- Categories will be added here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button class="close-modal px-4 py-2 bg-primary text-white rounded-md transition hover:bg-indigo-600 action-button">Done</button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-xl animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">User Profile</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-col items-center">
                    <img id="profile-image" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover mb-4">
                    <label id="change-photo-btn" class="px-3 py-1 bg-primary text-white rounded-md cursor-pointer text-sm transition hover:bg-indigo-600">
                        Change Photo
                        <input type="file" id="profile-photo-input" accept="image/*" class="hidden">
                    </label>
                </div>
                <div class="flex-1">
                    <div id="profile-view" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">First Name</h3>
                                <p id="profile-firstname" class="font-medium">John</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Last Name</h3>
                                <p id="profile-lastname" class="font-medium">Doe</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Email</h3>
                                <p id="profile-email" class="font-medium">test@example.com</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Role</h3>
                                <p id="profile-role" class="font-medium">Admin</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Country</h3>
                                <p id="profile-country" class="font-medium">United States</p>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Joined On</h3>
                                <p id="profile-joined" class="font-medium">Jan 1, 2023</p>
                            </div>
                        </div>
                        <div class="pt-4">
                            <button id="edit-profile-btn" class="px-4 py-2 bg-primary text-white rounded-md transition hover:bg-indigo-600 action-button">Edit Profile</button>
                        </div>
                    </div>
                    <div id="profile-edit" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="edit-firstname" class="block text-sm font-medium mb-1">First Name</label>
                                <input type="text" id="edit-firstname" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                            </div>
                            <div>
                                <label for="edit-lastname" class="block text-sm font-medium mb-1">Last Name</label>
                                <input type="text" id="edit-lastname" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                            </div>
                            <div>
                                <label for="edit-email" class="block text-sm font-medium mb-1">Email</label>
                                <input type="email" id="edit-email" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                            </div>
                            <div>
                                <label for="edit-role" class="block text-sm font-medium mb-1">Role</label>
                                <select id="edit-role" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                                    <option value="Manager">Manager</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Customer">Customer</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div>
                                <label for="edit-country" class="block text-sm font-medium mb-1">Country</label>
                                <select id="edit-country" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                                    <!-- Countries will be added dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 pt-4">
                            <button id="cancel-edit-profile" class="px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                            <button id="save-profile" class="px-4 py-2 bg-success text-white rounded-md transition hover:bg-green-600 action-button">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="users-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Users</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="users-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Users will be added here -->
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Notifications</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="notifications-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Notifications will be added here -->
            </div>
            <div class="mt-4 flex justify-between">
                <button id="mark-all-read" class="px-4 py-2 bg-primary text-white rounded-md transition hover:bg-indigo-600 action-button">
                    Mark All as Read
                </button>
                <button class="close-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Date Range Modal -->
    <div id="date-range-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="login-bg p-6 rounded-lg shadow-lg w-full max-w-md animate-scale-up">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Select Date Range</h2>
                <button class="close-modal text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="date-range-start" class="block text-sm font-medium mb-1">Start Date</label>
                    <input type="text" id="date-range-start" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                </div>
                <div>
                    <label for="date-range-end" class="block text-sm font-medium mb-1">End Date</label>
                    <input type="text" id="date-range-end" class="w-full px-3 py-2 border rounded-md focus:ring-primary focus:border-primary text-base">
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button class="cancel-modal px-4 py-2 bg-gray-500 text-white rounded-md transition hover:bg-gray-600 action-button">Cancel</button>
                    <button id="apply-date-range" class="px-4 py-2 bg-primary text-white rounded-md transition hover:bg-indigo-600 action-button">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateChartsForTheme();
        });

        // Initialize task and user data
        const DEFAULT_CATEGORIES = ['Work', 'Personal', 'Shopping', 'Health', 'Education'];
        let currentUser = null;
        let tasks = [];
        let users = [];
        let categories = [...DEFAULT_CATEGORIES];
        let notifications = [];
        let selectedTasks = [];
        let taskHistory = [];
        let historyPointer = -1;
        let activeTaskId = null;
        let taskTimer = {
            seconds: 0,
            interval: null,
            active: false
        };
        let tasksChart = null;
        let statusChart = null;
        let dateRangeStart = null;
        let dateRangeEnd = null;

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const registerLink = document.getElementById('register-link');
        const registerModal = document.getElementById('register-modal');
        const registerForm = document.getElementById('register-form');
        const cancelRegister = document.getElementById('cancel-register');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const viewProfileLink = document.getElementById('view-profile');
        const switchModeLink = document.getElementById('switch-mode');
        const logoutBtn = document.getElementById('logout-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const taskContainer = document.getElementById('task-container');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const addTaskBtn = document.getElementById('add-task-btn');
        const addTaskModal = document.getElementById('add-task-modal');
        const addTaskForm = document.getElementById('add-task-form');
        const exportBtn = document.getElementById('export-btn');
        const exportModal = document.getElementById('export-modal');
        const importBtn = document.getElementById('import-btn');
        const importModal = document.getElementById('import-modal');
        const manageCategBtn = document.getElementById('manage-categories-btn');
        const categoriesModal = document.getElementById('categories-modal');
        const categoryFilter = document.getElementById('category-filter');
        const statusFilter = document.getElementById('status-filter');
        const priorityFilter = document.getElementById('priority-filter');
        const dueDateFilter = document.getElementById('duedate-filter');
        const sortSelect = document.getElementById('sort-select');
        const searchInput = document.getElementById('search-input');
        const viewTaskModal = document.getElementById('view-task-modal');
        const editTaskModal = document.getElementById('edit-task-modal');
        const editTaskForm = document.getElementById('edit-task-form');
        const actionBar = document.getElementById('action-bar');
        const selectedCount = document.getElementById('selected-count');
        const batchCompleteBtn = document.getElementById('batch-complete-btn');
        const batchDeleteBtn = document.getElementById('batch-delete-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const graphViewBtn = document.getElementById('graph-view-btn');
        const listView = document.getElementById('list-view');
        const graphView = document.getElementById('graph-view');
        const profileModal = document.getElementById('profile-modal');
        const profileView = document.getElementById('profile-view');
        const profileEdit = document.getElementById('profile-edit');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const cancelEditProfile = document.getElementById('cancel-edit-profile');
        const saveProfileBtn = document.getElementById('save-profile');
        const usersBtn = document.getElementById('users-btn');
        const usersModal = document.getElementById('users-modal');
        const usersContainer = document.getElementById('users-container');
        const totalTaskCount = document.getElementById('total-task-count');
        const completedTaskCount = document.getElementById('completed-task-count');
        const pendingTaskCount = document.getElementById('pending-task-count');
        const completionRate = document.getElementById('completion-rate');
        const dueSoonCount = document.getElementById('due-soon-count');
        const commonCategory = document.getElementById('common-category');
        const categoryCount = document.getElementById('category-count');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationCount = document.getElementById('notification-count');
        const notificationModal = document.getElementById('notification-modal');
        const notificationsList = document.getElementById('notifications-list');
        const markAllReadBtn = document.getElementById('mark-all-read');
        const taskTimerDisplay = document.getElementById('task-timer');
        const timerControl = document.getElementById('timer-control');
        const dateRangeModal = document.getElementById('date-range-modal');
        
        // Initialize Flatpickr date pickers
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize birthdate picker with max date as today
            flatpickr('#birthdate', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });

            // Task due date pickers
            flatpickr('#task-due-date', {
                dateFormat: 'Y-m-d',
                minDate: 'today'
            });

            flatpickr('#edit-task-due-date', {
                dateFormat: 'Y-m-d',
                minDate: 'today'
            });

            // Date range pickers
            flatpickr('#date-range-start', {
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates) {
                    dateRangeStart = selectedDates[0];
                }
            });

            flatpickr('#date-range-end', {
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates) {
                    dateRangeEnd = selectedDates[0];
                }
            });

            // Fetch countries for the nationality dropdown
            fetchCountries();
            
            // Initialize the app
            initApp();
        });

        // Fetch countries from API
        function fetchCountries() {
            // Using a reliable source for country data
            fetch('https://restcountries.com/v3.1/all?fields=name')
                .then(response => response.json())
                .then(data => {
                    const nationalitySelect = document.getElementById('nationality');
                    const editCountrySelect = document.getElementById('edit-country');
                    
                    // Sort countries alphabetically by name
                    data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                    
                    // Add countries to dropdowns
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        nationalitySelect.appendChild(option);
                        
                        const editOption = document.createElement('option');
                        editOption.value = country.name.common;
                        editOption.textContent = country.name.common;
                        editCountrySelect.appendChild(editOption);
                    });
                })
                .catch(error => {
                    console.error('Error fetching countries:', error);
                    // Fallback for country list if API fails
                    const countries = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Japan', 'Brazil', 'India', 'China'];
                    
                    const nationalitySelect = document.getElementById('nationality');
                    const editCountrySelect = document.getElementById('edit-country');
                    
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        nationalitySelect.appendChild(option);
                        
                        const editOption = document.createElement('option');
                        editOption.value = country;
                        editOption.textContent = country;
                        editCountrySelect.appendChild(editOption);
                    });
                });
        }

        // Initialize app data, load from localStorage if available
        function initApp() {
            // Try to load data from localStorage
            loadData();
            
            // Create sample data if needed
            if (tasks.length === 0) {
                createSampleTasks();
            }
            
            if (users.length === 0) {
                createSampleUsers();
            }
            
            // Initialize categories
            populateCategoryDropdowns();
            
            // Update task views and counters
            renderTasks();
            updateTaskCounters();
            
            // Initialize charts for graph view
            initializeCharts();
            
            // Check for unread notifications
            updateNotificationBadge();
        }

        // Load data from localStorage
        function loadData() {
            try {
                const tasksData = localStorage.getItem('tasks');
                const usersData = localStorage.getItem('users');
                const categoriesData = localStorage.getItem('categories');
                const notificationsData = localStorage.getItem('notifications');
                const currentUserData = localStorage.getItem('currentUser');
                
                if (tasksData) {
                    tasks = JSON.parse(tasksData);
                }
                
                if (usersData) {
                    users = JSON.parse(usersData);
                }
                
                if (categoriesData) {
                    categories = JSON.parse(categoriesData);
                }
                
                if (notificationsData) {
                    notifications = JSON.parse(notificationsData);
                }
                
                if (currentUserData) {
                    currentUser = JSON.parse(currentUserData);
                    // Load timer data if available
                    const timerData = localStorage.getItem('taskTimer');
                    if (timerData) {
                        const savedTimer = JSON.parse(timerData);
                        taskTimer.seconds = savedTimer.seconds || 0;
                        activeTaskId = savedTimer.taskId || null;
                        updateTimerDisplay();
                    }
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                // If there's an error, we'll use the default empty arrays
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('notifications', JSON.stringify(notifications));
                if (currentUser) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                // Save timer state
                localStorage.setItem('taskTimer', JSON.stringify({
                    seconds: taskTimer.seconds,
                    taskId: activeTaskId
                }));
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
                showToast('Error saving data. Local storage might be full or unavailable.', 'error');
            }
        }

        // Create sample tasks for demonstration
        function createSampleTasks() {
            const now = new Date();
            const oneDay = 24 * 60 * 60 * 1000;
            const oneWeek = 7 * oneDay;
            
            // Sample tasks with different statuses, priorities, etc.
            tasks = [
                {
                    id: generateId(),
                    title: 'Complete project proposal',
                    description: 'Finalize the budget and timeline for the Q3 marketing campaign.',
                    dueDate: new Date(now.getTime() + oneDay).toISOString().split('T')[0],
                    priority: 'high',
                    category: 'Work',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Research competitors', completed: true },
                        { id: generateId(), title: 'Create budget spreadsheet', completed: false },
                        { id: generateId(), title: 'Set up timeline in project management tool', completed: false }
                    ],
                    notes: 'Remember to include the new branding guidelines.',
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    title: 'Schedule dentist appointment',
                    description: 'Annual checkup and cleaning',
                    dueDate: new Date(now.getTime() + 3 * oneDay).toISOString().split('T')[0],
                    priority: 'medium',
                    category: 'Health',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Call dentist office', completed: false },
                        { id: generateId(), title: 'Check insurance coverage', completed: true }
                    ],
                    notes: 'Dr. Smith at Smile Dental, phone: 555-1234',
                    createdAt: new Date(now.getTime() - 2 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Buy groceries',
                    description: 'Weekly grocery shopping',
                    dueDate: new Date(now.getTime() + 1 * oneDay).toISOString().split('T')[0],
                    priority: 'medium',
                    category: 'Shopping',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Make shopping list', completed: true },
                        { id: generateId(), title: 'Check pantry for needed items', completed: true },
                        { id: generateId(), title: 'Buy items', completed: false }
                    ],
                    notes: 'Don\'t forget to use the 10% off coupon',
                    createdAt: new Date(now.getTime() - 1 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Finish online course',
                    description: 'Complete the JavaScript Advanced Concepts course',
                    dueDate: new Date(now.getTime() + 5 * oneDay).toISOString().split('T')[0],
                    priority: 'high',
                    category: 'Education',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Complete Module 5: Promises', completed: true },
                        { id: generateId(), title: 'Complete Module 6: Async/Await', completed: false },
                        { id: generateId(), title: 'Complete Final Project', completed: false }
                    ],
                    notes: 'Course completion certificate will be issued after the final project',
                    createdAt: new Date(now.getTime() - 5 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Pay utility bills',
                    description: 'Monthly utility payments for electricity, water, and internet',
                    dueDate: new Date(now.getTime() + 2 * oneDay).toISOString().split('T')[0],
                    priority: 'high',
                    category: 'Personal',
                    completed: true,
                    subtasks: [
                        { id: generateId(), title: 'Pay electricity bill', completed: true },
                        { id: generateId(), title: 'Pay water bill', completed: true },
                        { id: generateId(), title: 'Pay internet bill', completed: true }
                    ],
                    notes: 'Set up auto-pay for next month',
                    createdAt: new Date(now.getTime() - 3 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Plan weekend trip',
                    description: 'Organize a weekend getaway to the mountains',
                    dueDate: new Date(now.getTime() + oneWeek).toISOString().split('T')[0],
                    priority: 'medium',
                    category: 'Personal',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Research accommodations', completed: true },
                        { id: generateId(), title: 'Book hotel', completed: false },
                        { id: generateId(), title: 'Plan activities', completed: false },
                        { id: generateId(), title: 'Pack bags', completed: false }
                    ],
                    notes: 'Check weather forecast before leaving',
                    createdAt: new Date(now.getTime() - 4 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Renew gym membership',
                    description: 'Annual membership renewal at Fitness Center',
                    dueDate: new Date(now.getTime() + 3 * oneDay).toISOString().split('T')[0],
                    priority: 'low',
                    category: 'Health',
                    completed: false,
                    subtasks: [],
                    notes: 'Ask about the new yoga classes',
                    createdAt: new Date(now.getTime() - 10 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Prepare presentation',
                    description: 'Create slides for the quarterly business review',
                    dueDate: new Date(now.getTime() + 4 * oneDay).toISOString().split('T')[0],
                    priority: 'high',
                    category: 'Work',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Gather Q2 metrics', completed: true },
                        { id: generateId(), title: 'Create charts and graphs', completed: false },
                        { id: generateId(), title: 'Write speaking notes', completed: false },
                        { id: generateId(), title: 'Practice presentation', completed: false }
                    ],
                    notes: 'Presentation should be 15-20 minutes long',
                    createdAt: new Date(now.getTime() - 6 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Call parents',
                    description: 'Weekly check-in call with mom and dad',
                    dueDate: new Date(now.getTime() + 2 * oneDay).toISOString().split('T')[0],
                    priority: 'medium',
                    category: 'Personal',
                    completed: false,
                    subtasks: [],
                    notes: 'Ask about their plans for the holidays',
                    createdAt: new Date(now.getTime() - 7 * oneDay).toISOString()
                },
                {
                    id: generateId(),
                    title: 'Update resume',
                    description: 'Add recent projects and skills to resume',
                    dueDate: new Date(now.getTime() + 10 * oneDay).toISOString().split('T')[0],
                    priority: 'low',
                    category: 'Personal',
                    completed: false,
                    subtasks: [
                        { id: generateId(), title: 'Add recent work experience', completed: false },
                        { id: generateId(), title: 'Update skills section', completed: true },
                        { id: generateId(), title: 'Proofread document', completed: false }
                    ],
                    notes: 'Also update LinkedIn profile with the same information',
                    createdAt: new Date(now.getTime() - 8 * oneDay).toISOString()
                }
            ];
        }

        // Create sample users for the users list
        function createSampleUsers() {
            users = [
                {
                    id: generateId(),
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'test@example.com',
                    password: '123456',
                    birthdate: '1990-01-01',
                    nationality: 'United States',
                    role: 'Admin',
                    avatar: 'https://randomuser.me/api/portraits/men/1.jpg',
                    joinedDate: new Date().toISOString()
                }
            ];
            
            // Add 9 more random users
            const roles = ['Manager', 'Staff', 'Customer'];
            const countries = ['United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Japan', 'Brazil', 'India', 'China'];
            
            for (let i = 0; i < 9; i++) {
                const gender = i % 2 === 0 ? 'men' : 'women';
                const user = {
                    id: generateId(),
                    firstName: `User${i+1}`,
                    lastName: `Sample${i+1}`,
                    email: `user${i+1}@example.com`,
                    password: 'password',
                    birthdate: `199${i}-01-01`,
                    nationality: countries[i],
                    role: roles[i % 3],
                    avatar: `https://randomuser.me/api/portraits/${gender}/${i+10}.jpg`,
                    joinedDate: new Date(Date.now() - (i * 30 * 24 * 60 * 60 * 1000)).toISOString() // Each joined 30 days apart
                };
                users.push(user);
            }
        }

        // Populate category dropdowns with available categories
        function populateCategoryDropdowns() {
            const taskCategorySelect = document.getElementById('task-category');
            const editTaskCategorySelect = document.getElementById('edit-task-category');
            const categoryFilterSelect = document.getElementById('category-filter');
            
            // Clear existing options
            taskCategorySelect.innerHTML = '';
            editTaskCategorySelect.innerHTML = '';
            categoryFilterSelect.innerHTML = '<option value="all">All Categories</option>';
            
            // Populate with categories
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                taskCategorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                editTaskCategorySelect.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = category;
                option3.textContent = category;
                categoryFilterSelect.appendChild(option3);
            });
        }

        // Generate unique ID for tasks and users
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        // Show a toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast p-4 mb-3 rounded-lg shadow-lg animate-slide-in max-w-md`;
            
            // Set background color based on type
            if (type === 'success') {
                toast.classList.add('bg-success', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                toast.classList.add('bg-warning', 'text-gray-900');
            } else {
                toast.classList.add('bg-primary', 'text-white');
            }
            
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                    <button class="text-white focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Add event listener to close button
            const closeBtn = toast.querySelector('button');
            closeBtn.addEventListener('click', () => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            });
            
            // Auto-remove toast after 5 seconds
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // Add notification
        function addNotification(title, message, type = 'info') {
            const notification = {
                id: generateId(),
                title,
                message,
                type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification); // Add to beginning of array
            
            // Cap notifications at 50 items to prevent excessive storage usage
            if (notifications.length > 50) {
                notifications.pop();
            }
            
            updateNotificationBadge();
            saveData();
            
            // Show a toast for task-related notifications
            if (type !== 'login') {
                showToast(message, type === 'warning' ? 'warning' : 'info');
            }
        }

        // Update notification badge and counter
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                notificationCount.textContent = unreadCount <= 99 ? unreadCount : '99+';
                notificationCount.classList.remove('hidden');
            } else {
                notificationCount.classList.add('hidden');
            }
        }

        // Render notifications list
        function renderNotifications() {
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<div class="text-center py-4 text-gray-500">No notifications</div>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-3 rounded ${notification.read ? 'bg-gray-100 dark:bg-gray-700' : 'bg-blue-50 dark:bg-blue-900/30 border-l-4 border-primary'}`;
                notificationItem.dataset.id = notification.id;
                
                const date = new Date(notification.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let iconClass = 'info-circle text-primary';
                if (notification.type === 'warning') {
                    iconClass = 'exclamation-triangle text-warning';
                } else if (notification.type === 'success') {
                    iconClass = 'check-circle text-success';
                } else if (notification.type === 'error') {
                    iconClass = 'exclamation-circle text-danger';
                }
                
                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-3">
                            <i class="fas fa-${iconClass} text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="text-sm font-semibold">${notification.title}</h4>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${formattedDate}</span>
                            </div>
                            <p class="text-sm">${notification.message}</p>
                        </div>
                    </div>
                `;
                
                notificationItem.addEventListener('click', () => {
                    if (!notification.read) {
                        notification.read = true;
                        notificationItem.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'border-l-4', 'border-primary');
                        notificationItem.classList.add('bg-gray-100', 'dark:bg-gray-700');
                        updateNotificationBadge();
                        saveData();
                    }
                });
                
                notificationsList.appendChild(notificationItem);
            });
        }

        // Initialize charts
        function initializeCharts() {
            // Destroy existing charts if any
            if (tasksChart) tasksChart.destroy();
            if (statusChart) statusChart.destroy();
            
            // Create tasks over time chart
            const tasksCtx = document.getElementById('tasks-chart').getContext('2d');
            
            const taskData = prepareTaskChartData();
            
            tasksChart = new Chart(tasksCtx, {
                type: 'bar',
                data: {
                    labels: taskData.labels,
                    datasets: [
                        {
                            label: 'Completed Tasks',
                            data: taskData.completedData,
                            backgroundColor: '#28A745',
                            borderColor: '#28A745',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending Tasks',
                            data: taskData.pendingData,
                            backgroundColor: '#FFC107',
                            borderColor: '#FFC107',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#1a202c'
                            }
                        }
                    }
                }
            });
            
            // Create task status pie chart
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            
            const completedCount = tasks.filter(task => task.completed).length;
            const pendingCount = tasks.length - completedCount;
            
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completedCount, pendingCount],
                        backgroundColor: ['#28A745', '#FFC107'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#1a202c'
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        // Prepare data for tasks chart
        function prepareTaskChartData() {
            // Get the last 7 days
            const dates = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date);
            }
            
            // Format dates for labels
            const labels = dates.map(date => date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            
            // Count completed and pending tasks for each date
            const completedData = [];
            const pendingData = [];
            
            dates.forEach(date => {
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                // Count tasks due on this date
                const dateStr = date.toISOString().split('T')[0];
                
                const completedCount = tasks.filter(task => 
                    task.dueDate === dateStr && task.completed
                ).length;
                
                const pendingCount = tasks.filter(task => 
                    task.dueDate === dateStr && !task.completed
                ).length;
                
                completedData.push(completedCount);
                pendingData.push(pendingCount);
            });
            
            return { labels, completedData, pendingData };
        }

        // Update charts when data changes
        function updateCharts() {
            if (!tasksChart || !statusChart) return;
            
            // Update tasks over time chart
            const taskData = prepareTaskChartData();
            
            tasksChart.data.labels = taskData.labels;
            tasksChart.data.datasets[0].data = taskData.completedData;
            tasksChart.data.datasets[1].data = taskData.pendingData;
            tasksChart.update();
            
            // Update task status pie chart
            const completedCount = tasks.filter(task => task.completed).length;
            const pendingCount = tasks.length - completedCount;
            
            statusChart.data.datasets[0].data = [completedCount, pendingCount];
            statusChart.update();
        }

        // Update charts when theme changes
        function updateChartsForTheme() {
            if (!tasksChart || !statusChart) return;
            
            const isDark = document.documentElement.classList.contains('dark');
            
            // Update tasks chart grid and text colors
            tasksChart.options.scales.x.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            tasksChart.options.scales.y.grid.color = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            tasksChart.options.plugins.legend.labels.color = isDark ? '#f3f4f6' : '#1a202c';
            
            // Update status chart colors
            statusChart.data.datasets[0].borderColor = isDark ? '#1f2937' : '#ffffff';
            statusChart.options.plugins.legend.labels.color = isDark ? '#f3f4f6' : '#1a202c';
            
            tasksChart.update();
            statusChart.update();
        }

        // Update task counters and insights
        function updateTaskCounters() {
            const total = tasks.length;
            const completed = tasks.filter(task => task.completed).length;
            const pending = total - completed;
            
            totalTaskCount.textContent = total;
            completedTaskCount.textContent = completed;
            pendingTaskCount.textContent = pending;
            
            // Update completion rate
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
            completionRate.textContent = `${rate}%`;
            
            // Count tasks due within 48 hours
            const now = new Date();
            const in48Hours = new Date(now.getTime() + 48 * 60 * 60 * 1000);
            
            const dueSoon = tasks.filter(task => {
                if (task.completed) return false;
                const dueDate = new Date(task.dueDate);
                return dueDate >= now && dueDate <= in48Hours;
            }).length;
            
            dueSoonCount.textContent = dueSoon;
            
            // Find most common category
            if (total > 0) {
                const categoryMap = {};
                
                tasks.forEach(task => {
                    if (!categoryMap[task.category]) {
                        categoryMap[task.category] = 1;
                    } else {
                        categoryMap[task.category]++;
                    }
                });
                
                let maxCount = 0;
                let maxCategory = 'None';
                
                for (const category in categoryMap) {
                    if (categoryMap[category] > maxCount) {
                        maxCount = categoryMap[category];
                        maxCategory = category;
                    }
                }
                
                commonCategory.textContent = maxCategory;
                categoryCount.textContent = maxCount;
            } else {
                commonCategory.textContent = 'None';
                categoryCount.textContent = '0';
            }
        }

        // Render all tasks according to current filters and sorting
        function renderTasks() {
            const statusFilterValue = statusFilter.value;
            const categoryFilterValue = categoryFilter.value;
            const priorityFilterValue = priorityFilter.value;
            const dueDateFilterValue = dueDateFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            const sortValue = sortSelect.value;
            
            // Apply filters
            let filteredTasks = tasks.filter(task => {
                // Status filter
                if (statusFilterValue === 'active' && task.completed) return false;
                if (statusFilterValue === 'completed' && !task.completed) return false;
                
                // Category filter
                if (categoryFilterValue !== 'all' && task.category !== categoryFilterValue) return false;
                
                // Priority filter
                if (priorityFilterValue !== 'all' && task.priority !== priorityFilterValue) return false;
                
                // Due date filter
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const dueDate = new Date(task.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                
                if (dueDateFilterValue === 'today') {
                    const today = new Date(now);
                    if (dueDate.getTime() !== today.getTime()) return false;
                } else if (dueDateFilterValue === 'week') {
                    const weekStart = new Date(now);
                    const weekEnd = new Date(now);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    
                    if (dueDate < weekStart || dueDate > weekEnd) return false;
                } else if (dueDateFilterValue === 'month') {
                    const monthStart = new Date(now);
                    const monthEnd = new Date(now);
                    monthEnd.setMonth(monthEnd.getMonth() + 1);
                    
                    if (dueDate < monthStart || dueDate > monthEnd) return false;
                } else if (dueDateFilterValue === 'custom' && dateRangeStart && dateRangeEnd) {
                    const start = new Date(dateRangeStart);
                    start.setHours(0, 0, 0, 0);
                    const end = new Date(dateRangeEnd);
                    end.setHours(23, 59, 59, 999);
                    
                    if (dueDate < start || dueDate > end) return false;
                }
                
                // Search filter
                if (searchValue) {
                    const titleMatch = task.title.toLowerCase().includes(searchValue);
                    const descMatch = task.description.toLowerCase().includes(searchValue);
                    if (!titleMatch && !descMatch) return false;
                }
                
                return true;
            });
            
            // Apply sorting
            filteredTasks.sort((a, b) => {
                if (sortValue === 'title-asc') {
                    return a.title.localeCompare(b.title);
                } else if (sortValue === 'title-desc') {
                    return b.title.localeCompare(a.title);
                } else if (sortValue === 'date-asc') {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                } else if (sortValue === 'date-desc') {
                    return new Date(b.dueDate) - new Date(a.dueDate);
                } else if (sortValue === 'priority-high') {
                    const priorityOrder = { high: 1, medium: 2, low: 3 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                } else if (sortValue === 'priority-low') {
                    const priorityOrder = { high: 1, medium: 2, low: 3 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                }
                return 0;
            });
            
            // Clear task container
            taskContainer.innerHTML = '';
            
            // Show message if no tasks
            if (filteredTasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                
                // Render each task
                filteredTasks.forEach(task => {
                    const taskElement = createTaskElement(task);
                    taskContainer.appendChild(taskElement);
                });
            }
            
            // Update charts if visible
            if (!listView.classList.contains('hidden')) {
                updateCharts();
            }
        }

        // Create HTML element for a task
        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = `task-card rounded-lg shadow-md p-4 transition-all ${task.completed ? 'bg-green-100 dark:bg-green-900/20' : 'bg-white dark:bg-gray-800'}`;
            taskElement.setAttribute('draggable', 'true');
            taskElement.dataset.id = task.id;
            
            // Determine the border color based on due date and priority
            let borderClass = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(task.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            
            if (dueDate < today && !task.completed) {
                // Expired task
                borderClass = 'border-l-4 border-danger';
            } else if (!task.completed) {
                const in48Hours = new Date(today);
                in48Hours.setHours(in48Hours.getHours() + 48);
                
                if (dueDate <= in48Hours) {
                    // Due within 48 hours
                    borderClass = 'border-l-4 border-warning';
                } else {
                    // Due later
                    borderClass = 'border-l-4 border-success';
                }
            }
            
            taskElement.classList.add(borderClass);
            
            // Priority indicator
            const priorityClass = task.priority === 'high' ? 'text-danger' : 
                                task.priority === 'medium' ? 'text-orange' : 'text-gray-500';
            
            // Create task content
            taskElement.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="mr-3">
                            <label class="switch">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} class="task-complete-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium ${task.completed ? 'task-completed' : ''}">${task.title}</h3>
                            <div class="flex items-center text-sm mt-1">
                                <span class="mr-3 ${priorityClass}">
                                    <i class="fas fa-flag mr-1"></i> ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                </span>
                                <span class="mr-3">
                                    <i class="fas fa-tag mr-1"></i> ${task.category}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" class="task-select-checkbox mr-2 w-4 h-4" aria-label="Select task">
                        <div class="drag-handle mr-2 cursor-grab text-gray-400 hidden sm:block">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                    </div>
                </div>
                <p class="text-sm mb-3 text-gray-600 dark:text-gray-300 line-clamp-2">${task.description}</p>
                <div class="flex flex-wrap justify-between items-center">
                    <div class="text-sm">
                        <i class="far fa-calendar-alt mr-1"></i> Due: ${new Date(task.dueDate).toLocaleDateString()}
                    </div>
                    <div class="flex mt-2 sm:mt-0">
                        <button class="task-play-btn text-primary p-1" title="${task.id === activeTaskId && taskTimer.active ? 'Pause Task' : 'Start Task'}" aria-label="${task.id === activeTaskId && taskTimer.active ? 'Pause Task' : 'Start Task'}">
                            <i class="fas ${task.id === activeTaskId && taskTimer.active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button class="task-view-btn text-primary p-1 ml-1" title="View Task" aria-label="View Task">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="task-edit-btn text-primary p-1 ml-1" title="Edit Task" aria-label="Edit Task">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-delete-btn text-danger p-1 ml-1" title="Delete Task" aria-label="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            const completeToggle = taskElement.querySelector('.task-complete-toggle');
            completeToggle.addEventListener('change', () => {
                toggleTaskComplete(task.id, completeToggle.checked);
            });
            
            const viewBtn = taskElement.querySelector('.task-view-btn');
            viewBtn.addEventListener('click', () => {
                viewTask(task.id);
            });
            
            const editBtn = taskElement.querySelector('.task-edit-btn');
            editBtn.addEventListener('click', () => {
                editTask(task.id);
            });
            
            const deleteBtn = taskElement.querySelector('.task-delete-btn');
            deleteBtn.addEventListener('click', () => {
                deleteTask(task.id);
            });
            
            const playBtn = taskElement.querySelector('.task-play-btn');
            playBtn.addEventListener('click', () => {
                toggleTaskTimer(task.id);
            });
            
            const selectCheckbox = taskElement.querySelector('.task-select-checkbox');
            selectCheckbox.addEventListener('change', () => {
                if (selectCheckbox.checked) {
                    selectedTasks.push(task.id);
                } else {
                    const index = selectedTasks.indexOf(task.id);
                    if (index !== -1) {
                        selectedTasks.splice(index, 1);
                    }
                }
                updateActionBar();
            });
            
            // Setup drag and drop
            taskElement.addEventListener('dragstart', handleDragStart);
            taskElement.addEventListener('dragover', handleDragOver);
            taskElement.addEventListener('dragenter', handleDragEnter);
            taskElement.addEventListener('dragleave', handleDragLeave);
            taskElement.addEventListener('drop', handleDrop);
            taskElement.addEventListener('dragend', handleDragEnd);
            
            return taskElement;
        }

        // Toggle task completion status
        function toggleTaskComplete(taskId, completed) {
            // Save current state for undo
            addToHistory();
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].completed = completed;
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Add notification
                addNotification(
                    completed ? 'Task Completed' : 'Task Reopened',
                    `Task "${tasks[taskIndex].title}" ${completed ? 'marked as complete' : 'reopened'}`,
                    completed ? 'success' : 'info'
                );
                
                // Save data
                saveData();
            }
        }

        // View task details
        function viewTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('view-task-title').textContent = task.title;
            document.getElementById('view-task-description').textContent = task.description || 'No description provided';
            document.getElementById('view-task-due-date').textContent = new Date(task.dueDate).toLocaleDateString();
            
            const priorityText = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            let priorityClass = '';
            if (task.priority === 'high') priorityClass = 'text-danger';
            else if (task.priority === 'medium') priorityClass = 'text-orange';
            else priorityClass = 'text-gray-500';
            
            document.getElementById('view-task-priority').innerHTML = `<span class="${priorityClass}">${priorityText}</span>`;
            document.getElementById('view-task-category').textContent = task.category;
            document.getElementById('view-task-status').innerHTML = task.completed ? 
                '<span class="text-success">Completed</span>' : 
                '<span class="text-warning">Pending</span>';
            document.getElementById('view-task-notes').textContent = task.notes || 'No notes provided';
            
            // Render subtasks
            const subtasksList = document.getElementById('view-subtasks-list');
            subtasksList.innerHTML = '';
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.title}</span>
                        ${subtask.completed ? ' <i class="fas fa-check text-success ml-1"></i>' : ''}
                    `;
                    subtasksList.appendChild(li);
                });
            } else {
                subtasksList.innerHTML = '<li class="text-gray-500">No subtasks</li>';
            }
            
            // Show modal
            viewTaskModal.classList.remove('hidden');
        }

        // Edit task
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('edit-task-id').value = task.id;
            document.getElementById('edit-task-title').value = task.title;
            document.getElementById('edit-task-description').value = task.description || '';
            document.getElementById('edit-task-due-date').value = task.dueDate;
            document.getElementById('edit-task-priority').value = task.priority;
            document.getElementById('edit-task-category').value = task.category;
            document.getElementById('edit-task-notes').value = task.notes || '';
            
            // Render subtasks
            const subtasksContainer = document.getElementById('edit-subtasks-container');
            subtasksContainer.innerHTML = '';
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    addSubtaskToForm(subtasksContainer, subtask.title, subtask.completed, subtask.id);
                });
            }
            
            // Show modal
            editTaskModal.classList.remove('hidden');
        }

        // Delete task
        function deleteTask(taskId) {
            // Save current state for undo
            addToHistory();
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const task = tasks[taskIndex];
                
                // Add notification
                addNotification(
                    'Task Deleted',
                    `Task "${task.title}" has been deleted`,
                    'warning'
                );
                
                // Remove task
                tasks.splice(taskIndex, 1);
                
                // If this task was being timed, stop the timer
                if (activeTaskId === taskId) {
                    stopTaskTimer();
                }
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Save data
                saveData();
            }
        }

        // Toggle task timer
        function toggleTaskTimer(taskId) {
            // If a different task is active, stop it first
            if (activeTaskId && activeTaskId !== taskId && taskTimer.active) {
                stopTaskTimer();
                showToast(`Timer stopped. Time spent: ${formatTime(taskTimer.seconds)}`, 'info');
            }
            
            // If this task is already active, toggle play/pause
            if (activeTaskId === taskId) {
                if (taskTimer.active) {
                    pauseTaskTimer();
                    showToast(`Timer paused. Time spent: ${formatTime(taskTimer.seconds)}`, 'info');
                } else {
                    startTaskTimer(taskId);
                }
            } else {
                // Start timing this task
                activeTaskId = taskId;
                startTaskTimer(taskId);
            }
            
            // Update UI to reflect changes
            renderTasks();
            saveData();
        }

        // Start task timer
        function startTaskTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            taskTimer.active = true;
            
            // Update timer control button
            timerControl.innerHTML = '<i class="fas fa-pause"></i>';
            timerControl.disabled = false;
            
            // Start interval
            if (!taskTimer.interval) {
                taskTimer.interval = setInterval(() => {
                    taskTimer.seconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        // Pause task timer
        function pauseTaskTimer() {
            taskTimer.active = false;
            
            // Update timer control button
            timerControl.innerHTML = '<i class="fas fa-play"></i>';
            
            // Clear interval
            if (taskTimer.interval) {
                clearInterval(taskTimer.interval);
                taskTimer.interval = null;
            }
        }

        // Stop task timer
        function stopTaskTimer() {
            taskTimer.active = false;
            activeTaskId = null;
            
            // Update timer control button
            timerControl.innerHTML = '<i class="fas fa-play"></i>';
            timerControl.disabled = true;
            
            // Clear interval
            if (taskTimer.interval) {
                clearInterval(taskTimer.interval);
                taskTimer.interval = null;
            }
        }

        // Format time in HH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }

        // Update timer display
        function updateTimerDisplay() {
            taskTimerDisplay.textContent = formatTime(taskTimer.seconds);
        }

        // Update action bar for batch operations
        function updateActionBar() {
            if (selectedTasks.length > 0) {
                selectedCount.textContent = selectedTasks.length;
                actionBar.classList.add('show');
            } else {
                actionBar.classList.remove('show');
            }
        }

        // Add state to history for undo/redo
        function addToHistory() {
            // If we're not at the end of the history, truncate
            if (historyPointer < taskHistory.length - 1) {
                taskHistory = taskHistory.slice(0, historyPointer + 1);
            }
            
            // Add current state to history
            taskHistory.push(JSON.stringify(tasks));
            historyPointer = taskHistory.length - 1;
            
            // Limit history size to prevent excessive memory usage
            if (taskHistory.length > 20) {
                taskHistory.shift();
                historyPointer--;
            }
            
            // Enable/disable undo/redo buttons
            updateUndoRedoButtons();
        }

        // Update undo/redo buttons state
        function updateUndoRedoButtons() {
            undoBtn.disabled = historyPointer < 0;
            redoBtn.disabled = historyPointer >= taskHistory.length - 1;
            
            undoBtn.classList.toggle('opacity-50', historyPointer < 0);
            redoBtn.classList.toggle('opacity-50', historyPointer >= taskHistory.length - 1);
        }

        // Undo last action
        function undoAction() {
            if (historyPointer >= 0) {
                historyPointer--;
                
                if (historyPointer >= 0) {
                    tasks = JSON.parse(taskHistory[historyPointer]);
                } else {
                    tasks = [];
                }
                
                renderTasks();
                updateTaskCounters();
                saveData();
                updateUndoRedoButtons();
                
                showToast('Action undone', 'info');
            }
        }

        // Redo last undone action
        function redoAction() {
            if (historyPointer < taskHistory.length - 1) {
                historyPointer++;
                tasks = JSON.parse(taskHistory[historyPointer]);
                
                renderTasks();
                updateTaskCounters();
                saveData();
                updateUndoRedoButtons();
                
                showToast('Action redone', 'info');
            }
        }

        // Drag and drop functions
        let draggedItem = null;

        function handleDragStart(e) {
            // Set data for drag operation
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            
            // Add dragging class
            setTimeout(() => {
                this.classList.add('dragging');
            }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('bg-gray-100', 'dark:bg-gray-700');
        }

        function handleDragLeave(e) {
            this.classList.remove('bg-gray-100', 'dark:bg-gray-700');
        }

        function handleDrop(e) {
            e.stopPropagation();
            
            if (draggedItem && draggedItem !== this) {
                // Save current state for undo
                addToHistory();
                
                // Get positions
                const allTasks = Array.from(taskContainer.querySelectorAll('.task-card'));
                const draggedIndex = allTasks.indexOf(draggedItem);
                const dropIndex = allTasks.indexOf(this);
                
                // Get task IDs
                const draggedTaskId = draggedItem.dataset.id;
                const dropTaskId = this.dataset.id;
                
                // Find task indexes in the tasks array
                const draggedTaskArrayIndex = tasks.findIndex(t => t.id === draggedTaskId);
                const dropTaskArrayIndex = tasks.findIndex(t => t.id === dropTaskId);
                
                if (draggedTaskArrayIndex !== -1 && dropTaskArrayIndex !== -1) {
                    // Reorder tasks array
                    const [movedTask] = tasks.splice(draggedTaskArrayIndex, 1);
                    tasks.splice(dropTaskArrayIndex, 0, movedTask);
                    
                    // Re-render tasks
                    renderTasks();
                    saveData();
                    
                    // Add notification
                    addNotification(
                        'Task Reordered',
                        `Task "${movedTask.title}" has been reordered`,
                        'info'
                    );
                }
            }
            
            this.classList.remove('bg-gray-100', 'dark:bg-gray-700');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            return false;
        }

        // Add subtask to form
        function addSubtaskToForm(container, value = '', completed = false, id = null) {
            const subtaskId = id || generateId();
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'flex items-center gap-2';
            subtaskDiv.dataset.id = subtaskId;
            
            subtaskDiv.innerHTML = `
                <input type="checkbox" ${completed ? 'checked' : ''} class="subtask-completed w-4 h-4">
                <input type="text" value="${value}" placeholder="Enter subtask" class="flex-1 px-3 py-1 border rounded-md focus:ring-primary focus:border-primary text-base">
                <button type="button" class="remove-subtask text-danger">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            const removeBtn = subtaskDiv.querySelector('.remove-subtask');
            removeBtn.addEventListener('click', () => {
                subtaskDiv.remove();
            });
            
            container.appendChild(subtaskDiv);
        }

        // Add task to the list
        function addTask(taskData) {
            // Save current state for undo
            addToHistory();
            
            // Create new task
            const newTask = {
                id: generateId(),
                ...taskData,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            
            // Update UI
            renderTasks();
            updateTaskCounters();
            
            // Add notification
            addNotification(
                'Task Added',
                `New task "${newTask.title}" has been added`,
                'success'
            );
            
            // Save data
            saveData();
        }

        // Update existing task
        function updateTask(taskId, taskData) {
            // Save current state for undo
            addToHistory();
            
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const oldTask = tasks[taskIndex];
                const updatedTask = {
                    ...oldTask,
                    ...taskData
                };
                
                tasks[taskIndex] = updatedTask;
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Add notification
                addNotification(
                    'Task Updated',
                    `Task "${updatedTask.title}" has been updated`,
                    'info'
                );
                
                // Save data
                saveData();
            }
        }

        // Batch complete selected tasks
        function batchCompleteTasks() {
            // Save current state for undo
            addToHistory();
            
            // Mark all selected tasks as complete
            let count = 0;
            selectedTasks.forEach(taskId => {
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1 && !tasks[taskIndex].completed) {
                    tasks[taskIndex].completed = true;
                    count++;
                }
            });
            
            if (count > 0) {
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Add notification
                addNotification(
                    'Tasks Completed',
                    `${count} tasks marked as complete`,
                    'success'
                );
                
                // Save data
                saveData();
            }
            
            // Clear selection
            selectedTasks = [];
            updateActionBar();
        }

        // Batch delete selected tasks
        function batchDeleteTasks() {
            // Save current state for undo
            addToHistory();
            
            // Delete all selected tasks
            const count = selectedTasks.length;
            
            if (count > 0) {
                // Remove tasks
                tasks = tasks.filter(task => !selectedTasks.includes(task.id));
                
                // Check if any selected task was being timed
                if (selectedTasks.includes(activeTaskId)) {
                    stopTaskTimer();
                }
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Add notification
                addNotification(
                    'Tasks Deleted',
                    `${count} tasks have been deleted`,
                    'warning'
                );
                
                // Save data
                saveData();
            }
            
            // Clear selection
            selectedTasks = [];
            updateActionBar();
        }

        // Export tasks to different formats
        function exportTasks(format) {
            if (tasks.length === 0) {
                showToast('No tasks to export', 'warning');
                return;
            }
            
            try {
                if (format === 'json') {
                    // Export as JSON
                    const jsonString = JSON.stringify(tasks, null, 2);
                    showToast('Tasks successfully exported to JSON in the console. Right-click -> Save As to download.', 'success');
                    console.log(jsonString);
                } else if (format === 'pdf') {
                    // Export as PDF
                    showToast('PDF export demonstrated (would download in production)', 'success');
                    alert('In a production environment, this would generate and download a PDF file of your tasks using jsPDF. For this demo, we\'re showing this alert instead.');
                } else if (format === 'excel') {
                    // Export as Excel
                    showToast('Excel export demonstrated (would download in production)', 'success');
                    alert('In a production environment, this would generate and download an Excel file of your tasks using XLSX.js. For this demo, we\'re showing this alert instead.');
                }
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting tasks', 'error');
            }
        }

        // Import tasks from JSON
        function importTasks(jsonData) {
            try {
                const importedTasks = JSON.parse(jsonData);
                
                if (Array.isArray(importedTasks)) {
                    // Save current state for undo
                    addToHistory();
                    
                    // Generate new IDs for imported tasks to avoid conflicts
                    const tasksToImport = importedTasks.map(task => ({
                        ...task,
                        id: generateId()
                    }));
                    
                    // Add imported tasks to existing tasks
                    tasks = [...tasks, ...tasksToImport];
                    
                    // Update UI
                    renderTasks();
                    updateTaskCounters();
                    
                    // Add notification
                    addNotification(
                        'Tasks Imported',
                        `${tasksToImport.length} tasks have been imported`,
                        'success'
                    );
                    
                    // Save data
                    saveData();
                    
                    return true;
                } else {
                    showToast('Invalid import data: not an array', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('Error parsing import data', 'error');
                return false;
            }
        }

        // Add category
        function addCategory(categoryName) {
            if (categoryName && !categories.includes(categoryName)) {
                categories.push(categoryName);
                saveData();
                populateCategoryDropdowns();
                return true;
            }
            return false;
        }

        // Delete category
        function deleteCategory(categoryName) {
            const index = categories.indexOf(categoryName);
            if (index !== -1) {
                categories.splice(index, 1);
                saveData();
                populateCategoryDropdowns();
                return true;
            }
            return false;
        }

        // Render categories list
        function renderCategories() {
            const categoriesList = document.getElementById('categories-list');
            categoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'flex items-center justify-between p-2 border-b';
                
                categoryItem.innerHTML = `
                    <span>${category}</span>
                    <button class="delete-category text-danger" data-category="${category}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                const deleteBtn = categoryItem.querySelector('.delete-category');
                deleteBtn.addEventListener('click', () => {
                    // Check if this category is in use
                    const inUse = tasks.some(task => task.category === category);
                    
                    if (inUse) {
                        showToast(`Cannot delete "${category}" - it's currently used by tasks`, 'warning');
                    } else {
                        if (deleteCategory(category)) {
                            categoryItem.remove();
                            showToast(`Category "${category}" deleted`, 'success');
                        }
                    }
                });
                
                categoriesList.appendChild(categoryItem);
            });
        }

        // Render users list
        function renderUsers() {
            usersContainer.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 task-card flex flex-col items-center';
                
                userCard.innerHTML = `
                    <img src="${user.avatar}" alt="${user.firstName} ${user.lastName}" class="w-20 h-20 rounded-full object-cover mb-3">
                    <h3 class="font-medium text-lg">${user.firstName} ${user.lastName}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${user.email}</p>
                    <div class="mt-2 px-3 py-1 bg-primary bg-opacity-20 text-primary rounded-full text-sm">
                        ${user.role}
                    </div>
                `;
                
                usersContainer.appendChild(userCard);
            });
        }

        // Update profile data
        function updateProfile(profileData) {
            if (!currentUser) return false;
            
            currentUser = {
                ...currentUser,
                ...profileData
            };
            
            // Update user in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
            }
            
            saveData();
            renderProfile();
            return true;
        }

        // Render profile data
        function renderProfile() {
            if (!currentUser) return;
            
            // Update avatar
            document.getElementById('user-avatar').src = currentUser.avatar;
            document.getElementById('profile-image').src = currentUser.avatar;
            
            // Update profile view
            document.getElementById('profile-firstname').textContent = currentUser.firstName;
            document.getElementById('profile-lastname').textContent = currentUser.lastName;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-role').textContent = currentUser.role;
            document.getElementById('profile-country').textContent = currentUser.nationality;
            
            const joinedDate = new Date(currentUser.joinedDate);
            document.getElementById('profile-joined').textContent = joinedDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Update profile edit form
            document.getElementById('edit-firstname').value = currentUser.firstName;
            document.getElementById('edit-lastname').value = currentUser.lastName;
            document.getElementById('edit-email').value = currentUser.email;
            document.getElementById('edit-role').value = currentUser.role;
            
            // Find and select the right country
            const countrySelect = document.getElementById('edit-country');
            for (let i = 0; i < countrySelect.options.length; i++) {
                if (countrySelect.options[i].value === currentUser.nationality) {
                    countrySelect.selectedIndex = i;
                    break;
                }
            }
        }

        // EVENT LISTENERS
        
        // Login form submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Check credentials
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                // Set current user
                currentUser = user;
                saveData();
                
                // Show dashboard
                loginPage.classList.add('hidden');
                dashboard.classList.remove('hidden');
                
                // Render profile
                renderProfile();
                
                // Add notification
                addNotification(
                    'Login Successful',
                    `Welcome back, ${user.firstName}!`,
                    'login'
                );
            } else {
                showToast('Invalid email or password', 'error');
            }
        });

        // Register link click
        registerLink.addEventListener('click', function() {
            registerModal.classList.remove('hidden');
        });

        // Cancel register button
        cancelRegister.addEventListener('click', function() {
            registerModal.classList.add('hidden');
            registerForm.reset();
        });

        // Register form submission
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const lastName = document.getElementById('lastName').value;
            const firstName = document.getElementById('firstName').value;
            const email = document.getElementById('registerEmail').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthdate = document.getElementById('birthdate').value;
            const nationality = document.getElementById('nationality').value;
            const role = document.getElementById('role').value;
            
            // Check if emails match
            if (email !== confirmEmail) {
                showToast('Emails do not match', 'error');
                return;
            }
            
            // Check if passwords match
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            // Check if email is already in use
            if (users.some(u => u.email === email)) {
                showToast('Email is already in use', 'error');
                return;
            }
            
            // Validate all fields are filled
            if (!lastName || !firstName || !email || !password || !birthdate || !nationality || !role) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                id: generateId(),
                lastName,
                firstName,
                email,
                password,
                birthdate,
                nationality,
                role,
                avatar: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 100)}.jpg`,
                joinedDate: new Date().toISOString()
            };
            
            users.push(newUser);
            saveData();
            
            // Set as current user and show dashboard
            currentUser = newUser;
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
            
            // Render profile
            renderProfile();
            
            // Hide modal and reset form
            registerModal.classList.add('hidden');
            registerForm.reset();
            
            // Add notification
            addNotification(
                'Registration Successful',
                `Welcome, ${firstName}!`,
                'success'
            );
        });

        // Profile button click
        profileBtn.addEventListener('click', function() {
            profileDropdown.classList.toggle('show');
        });

        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.remove('show');
            }
        });

        // View profile click
        viewProfileLink.addEventListener('click', function(e) {
            e.preventDefault();
            profileDropdown.classList.remove('show');
            profileModal.classList.remove('hidden');
            profileView.classList.remove('hidden');
            profileEdit.classList.add('hidden');
        });

        // Switch mode click
        switchModeLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.documentElement.classList.toggle('dark');
            profileDropdown.classList.remove('show');
            updateChartsForTheme();
        });

        // Logout button click
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Stop task timer if active
            if (taskTimer.active) {
                stopTaskTimer();
            }
            
            // Clear current user
            currentUser = null;
            saveData();
            
            // Show login page
            dashboard.classList.add('hidden');
            loginPage.classList.remove('hidden');
            
            // Hide profile dropdown
            profileDropdown.classList.remove('show');
        });

        // Theme toggle click
        themeToggle.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            
            // Update icon
            if (document.documentElement.classList.contains('dark')) {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            } else {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            
            updateChartsForTheme();
        });

        // Add task button click
        addTaskBtn.addEventListener('click', function() {
            // Clear form
            document.getElementById('add-task-form').reset();
            document.getElementById('subtasks-container').innerHTML = '';
            
            // Show modal
            addTaskModal.classList.remove('hidden');
        });

        // Add task form submission
        addTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const category = document.getElementById('task-category').value;
            const notes = document.getElementById('task-notes').value;
            
            // Get subtasks
            const subtasksContainer = document.getElementById('subtasks-container');
            const subtaskItems = subtasksContainer.querySelectorAll('div');
            const subtasks = Array.from(subtaskItems).map(item => {
                return {
                    id: item.dataset.id,
                    title: item.querySelector('input[type="text"]').value,
                    completed: item.querySelector('input[type="checkbox"]').checked
                };
            });
            
            // Add task
            addTask({
                title,
                description,
                dueDate,
                priority,
                category,
                notes,
                subtasks,
                completed: false
            });
            
            // Hide modal
            addTaskModal.classList.add('hidden');
            
            // Reset form
            addTaskForm.reset();
            subtasksContainer.innerHTML = '';
        });

        // Add subtask button click
        document.getElementById('add-subtask-btn').addEventListener('click', function() {
            const container = document.getElementById('subtasks-container');
            addSubtaskToForm(container);
        });

        // Edit add subtask button click
        document.getElementById('edit-add-subtask-btn').addEventListener('click', function() {
            const container = document.getElementById('edit-subtasks-container');
            addSubtaskToForm(container);
        });

        // Edit task form submission
        editTaskForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskId = document.getElementById('edit-task-id').value;
            const title = document.getElementById('edit-task-title').value;
            const description = document.getElementById('edit-task-description').value;
            const dueDate = document.getElementById('edit-task-due-date').value;
            const priority = document.getElementById('edit-task-priority').value;
            const category = document.getElementById('edit-task-category').value;
            const notes = document.getElementById('edit-task-notes').value;
            
            // Get subtasks
            const subtasksContainer = document.getElementById('edit-subtasks-container');
            const subtaskItems = subtasksContainer.querySelectorAll('div');
            const subtasks = Array.from(subtaskItems).map(item => {
                return {
                    id: item.dataset.id,
                    title: item.querySelector('input[type="text"]').value,
                    completed: item.querySelector('input[type="checkbox"]').checked
                };
            });
            
            // Update task
            updateTask(taskId, {
                title,
                description,
                dueDate,
                priority,
                category,
                notes,
                subtasks
            });
            
            // Hide modal
            editTaskModal.classList.add('hidden');
        });

        // Export button click
        exportBtn.addEventListener('click', function() {
            exportModal.classList.remove('hidden');
        });

        // Export format buttons
        document.getElementById('export-pdf').addEventListener('click', function() {
            exportTasks('pdf');
            exportModal.classList.add('hidden');
        });

        document.getElementById('export-excel').addEventListener('click', function() {
            exportTasks('excel');
            exportModal.classList.add('hidden');
        });

        document.getElementById('export-json').addEventListener('click', function() {
            exportTasks('json');
            exportModal.classList.add('hidden');
        });

        // Import button click
        importBtn.addEventListener('click', function() {
            importModal.classList.remove('hidden');
        });

        // Import button confirm click
        document.getElementById('import-btn-confirm').addEventListener('click', function() {
            const fileInput = document.getElementById('import-file');
            const urlInput = document.getElementById('import-url');
            
            if (fileInput.files.length > 0) {
                // Import from file
                const file = fileInput.files[0];
                
                if (file.type === 'application/json') {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const success = importTasks(e.target.result);
                        
                        if (success) {
                            importModal.classList.add('hidden');
                            fileInput.value = '';
                        }
                    };
                    
                    reader.readAsText(file);
                } else {
                    showToast('Only JSON files are supported', 'error');
                }
            } else if (urlInput.value) {
                // Import from URL (would implement fetch in production)
                showToast('URL import simulated (would fetch in production)', 'info');
                
                // Create sample JSON data for demonstration
                const sampleData = JSON.stringify([
                    {
                        title: 'Imported Task 1',
                        description: 'This is an imported task',
                        dueDate: new Date().toISOString().split('T')[0],
                        priority: 'medium',
                        category: 'Work',
                        completed: false,
                        subtasks: []
                    },
                    {
                        title: 'Imported Task 2',
                        description: 'Another imported task',
                        dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        priority: 'high',
                        category: 'Personal',
                        completed: false,
                        subtasks: []
                    }
                ]);
                
                const success = importTasks(sampleData);
                
                if (success) {
                    importModal.classList.add('hidden');
                    urlInput.value = '';
                }
            } else {
                showToast('Please select a file or enter a URL', 'warning');
            }
        });

        // Manage categories button click
        manageCategBtn.addEventListener('click', function() {
            renderCategories();
            categoriesModal.classList.remove('hidden');
        });

        // Add category button click
        document.getElementById('add-category-btn').addEventListener('click', function() {
            const categoryInput = document.getElementById('new-category');
            const categoryName = categoryInput.value.trim();
            
            if (categoryName) {
                if (categories.includes(categoryName)) {
                    showToast(`Category "${categoryName}" already exists`, 'warning');
                } else {
                    if (addCategory(categoryName)) {
                        renderCategories();
                        categoryInput.value = '';
                        showToast(`Category "${categoryName}" added`, 'success');
                    }
                }
            } else {
                showToast('Please enter a category name', 'warning');
            }
        });

        // Close modals
        const closeModalBtns = document.querySelectorAll('.close-modal, .cancel-modal');
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // Hide all modals
                document.querySelectorAll('.fixed.inset-0').forEach(modal => {
                    modal.classList.add('hidden');
                });
            });
        });

        // Filter change events
        statusFilter.addEventListener('change', renderTasks);
        categoryFilter.addEventListener('change', renderTasks);
        priorityFilter.addEventListener('change', renderTasks);
        dueDateFilter.addEventListener('change', function() {
            if (this.value === 'custom') {
                dateRangeModal.classList.remove('hidden');
            } else {
                renderTasks();
            }
        });

        // Apply date range
        document.getElementById('apply-date-range').addEventListener('click', function() {
            dateRangeModal.classList.add('hidden');
            renderTasks();
        });

        // Sort change event
        sortSelect.addEventListener('change', renderTasks);

        // Search input event
        searchInput.addEventListener('input', debounce(function() {
            renderTasks();
        }, 300));

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // Batch action buttons
        batchCompleteBtn.addEventListener('click', batchCompleteTasks);
        batchDeleteBtn.addEventListener('click', batchDeleteTasks);

        // Undo/Redo buttons
        undoBtn.addEventListener('click', undoAction);
        redoBtn.addEventListener('click', redoAction);

        // View switcher
        listViewBtn.addEventListener('click', function() {
            listViewBtn.classList.add('active');
            graphViewBtn.classList.remove('active');
            listView.classList.remove('hidden');
            graphView.classList.add('hidden');
        });

        graphViewBtn.addEventListener('click', function() {
            graphViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            graphView.classList.remove('hidden');
            listView.classList.add('hidden');
            
            // If chart not initialized or needs update
            updateCharts();
        });

        // Edit profile button
        editProfileBtn.addEventListener('click', function() {
            profileView.classList.add('hidden');
            profileEdit.classList.remove('hidden');
        });

        // Cancel edit profile
        cancelEditProfile.addEventListener('click', function() {
            profileEdit.classList.add('hidden');
            profileView.classList.remove('hidden');
        });

        // Save profile
        saveProfileBtn.addEventListener('click', function() {
            const firstName = document.getElementById('edit-firstname').value;
            const lastName = document.getElementById('edit-lastname').value;
            const email = document.getElementById('edit-email').value;
            const role = document.getElementById('edit-role').value;
            const country = document.getElementById('edit-country').value;
            
            if (firstName && lastName && email && role && country) {
                if (updateProfile({
                    firstName,
                    lastName,
                    email,
                    role,
                    nationality: country
                })) {
                    profileEdit.classList.add('hidden');
                    profileView.classList.remove('hidden');
                    showToast('Profile updated successfully', 'success');
                }
            } else {
                showToast('Please fill all required fields', 'warning');
            }
        });

        // Change profile photo
        document.getElementById('profile-photo-input').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                
                // Show image upload success (in production would handle actual upload)
                document.getElementById('profile-image').src = URL.createObjectURL(file);
                document.getElementById('user-avatar').src = URL.createObjectURL(file);
                
                // Update the profile avatar property (in production would save the actual URL)
                if (currentUser) {
                    currentUser.avatar = URL.createObjectURL(file);
                    saveData();
                }
                
                showToast('Profile photo updated', 'success');
            }
        });

        // Users button click
        usersBtn.addEventListener('click', function() {
            renderUsers();
            usersModal.classList.remove('hidden');
        });

        // Notification button click
        notificationBtn.addEventListener('click', function() {
            renderNotifications();
            notificationModal.classList.remove('hidden');
        });

        // Mark all notifications as read
        markAllReadBtn.addEventListener('click', function() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            
            updateNotificationBadge();
            renderNotifications();
            saveData();
            
            showToast('All notifications marked as read', 'success');
        });

        // Timer control button
        timerControl.addEventListener('click', function() {
            if (activeTaskId) {
                if (taskTimer.active) {
                    pauseTaskTimer();
                    showToast(`Timer paused. Time spent: ${formatTime(taskTimer.seconds)}`, 'info');
                } else {
                    startTaskTimer(activeTaskId);
                }
                
                // Update UI
                renderTasks();
                saveData();
            }
        });
    </script>
</body>
</html>
