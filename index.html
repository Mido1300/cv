<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To-Do App</title>
  
  <!-- External Libraries via CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --primary: #5D5CDE;
      --primary-light: #7776ff;
      --primary-dark: #4c4bae;
      --success: #28A745;
      --warning: #FFC107;
      --danger: #DC3545;
      --info: #17A2B8;
      --secondary: #6C757D;
      --light: #f8f9fa;
      --dark: #343a40;
      --medium: #FD7E14;
      --bg-light: #FFFFFF;
      --bg-dark: #181818;
      --text-light: #212529;
      --text-dark: #E9ECEF;
      --border-radius: 8px;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      --transition-speed: 0.3s;
      --status-online: #28A745;
      --status-break: #FFC107;
      --status-logout: #DC3545;
      --status-shadow: #6C757D;
    }
    
    .dark {
      --bg-light: #181818;
      --bg-dark: #0d0d0d;
      --text-light: #E9ECEF;
      --text-dark: #212529;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --hover-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    
    body {
      background-color: var(--bg-light);
      color: var(--text-light);
      min-height: 100vh;
    }
    
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    /* Login Page Styles */
    .login-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-light) 0%, #f0f2f5 100%);
    }
    
    .login-form {
      width: 100%;
      max-width: 400px;
      padding: 2rem;
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      animation: fadeIn 0.5s ease-in-out;
    }
    
    .login-form h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--primary);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      font-size: 16px;
      transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
      background-color: var(--bg-light);
      color: var(--text-light);
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      font-size: 16px;
      font-weight: 500;
      border-radius: var(--border-radius);
      border: none;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    
    .btn-login {
      margin: 0 auto;
      display: block;
      width: 80%;
    }
    
    .btn-login::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: skewX(-25deg);
      animation: lightEffect 3s infinite;
    }
    
    @keyframes lightEffect {
      0% {
        left: -100%;
      }
      50% {
        left: 100%;
      }
      100% {
        left: 100%;
      }
    }
    
    .btn-success {
      background-color: var(--success);
      color: white;
    }
    
    .btn-danger {
      background-color: var(--danger);
      color: white;
    }
    
    .btn-warning {
      background-color: var(--warning);
      color: white;
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: white;
    }
    
    .btn-info {
      background-color: var(--info);
      color: white;
    }
    
    .login-links {
      text-align: center;
      margin-top: 1.5rem;
    }
    
    .login-links a {
      color: #00008B;
      text-decoration: none;
      transition: color var(--transition-speed);
    }
    
    .login-links a:hover {
      text-decoration: underline;
      color: var(--primary);
    }
    
    /* Modal Styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-speed), visibility var(--transition-speed);
    }
    
    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(-20px);
      transition: transform var(--transition-speed);
    }
    
    .modal.show {
      transform: translateY(0);
    }
    
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--secondary);
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    /* Dashboard Styles */
    .dashboard {
      display: none;
    }
    
    .header {
      background-color: var(--bg-light);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }
    
    .logo i {
      margin-right: 0.5rem;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .task-timer {
      display: flex;
      align-items: center;
      background-color: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-light);
    }
    
    .task-timer span {
      margin: 0 0.25rem;
    }
    
    .timer-controls {
      display: flex;
      gap: 0.5rem;
      margin-left: 0.5rem;
    }
    
    .timer-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: var(--text-light);
      transition: color var(--transition-speed);
    }
    
    .timer-btn:hover {
      color: var(--primary);
    }
    
    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--text-light);
      transition: color var(--transition-speed);
    }
    
    .theme-toggle:hover {
      color: var(--primary);
    }
    
    .notification-btn {
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      color: var(--text-light);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background-color: var(--danger);
      color: white;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .notification-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 300px;
      max-height: 400px;
      overflow-y: auto;
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      z-index: 100;
      display: none;
    }
    
    .notification-dropdown.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .notification-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-title {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .notification-clear {
      font-size: 0.875rem;
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
    }
    
    .notification-items {
      padding: 0.5rem 0;
    }
    
    .notification-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }
    
    .notification-item:hover {
      background-color: rgba(93, 92, 222, 0.05);
    }
    
    .notification-item.unread {
      background-color: rgba(93, 92, 222, 0.1);
    }
    
    .notification-content {
      margin-bottom: 0.25rem;
    }
    
    .notification-time {
      font-size: 0.75rem;
      color: var(--secondary);
    }
    
    .notifications-empty {
      padding: 1rem;
      text-align: center;
      color: var(--secondary);
    }
    
    .profile-dropdown {
      position: relative;
    }
    
    .profile-btn {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--status-online); /* Default status */
    }
    
    .user-status {
      position: relative;
    }
    
    .status-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 150px;
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      z-index: 100;
      display: none;
    }
    
    .status-dropdown.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .status-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background-color var(--transition-speed);
      display: flex;
      align-items: center;
    }
    
    .status-item:hover {
      background-color: rgba(93, 92, 222, 0.05);
    }
    
    .status-marker {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    
    .status-online .status-marker {
      background-color: var(--status-online);
    }
    
    .status-break .status-marker {
      background-color: var(--status-break);
    }
    
    .status-logout .status-marker {
      background-color: var(--status-logout);
    }
    
    .status-shadow .status-marker {
      background-color: var(--status-shadow);
    }
    
    .profile-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      width: 200px;
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      z-index: 100;
      display: none;
    }
    
    .profile-dropdown-menu.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .profile-dropdown-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      text-decoration: none;
      cursor: pointer;
      transition: background-color var(--transition-speed);
    }
    
    .profile-dropdown-item:hover {
      background-color: rgba(93, 92, 222, 0.05);
    }
    
    .profile-dropdown-item i {
      font-size: 1rem;
      color: var(--primary);
    }
    
    /* Main Content */
    .main {
      padding: 2rem 0;
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .task-summary {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .summary-card {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    
    .summary-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .summary-card-title {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-light);
      margin-bottom: 0.5rem;
    }
    
    .summary-card-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .total-tasks {
      border: 3px solid var(--primary);
    }
    
    .completed-tasks {
      border-top: 3px solid var(--success);
    }
    
    .completed-tasks .summary-card-value {
      color: var(--success);
    }
    
    .pending-tasks {
      border-top: 3px solid var(--warning);
    }
    
    .pending-tasks .summary-card-value {
      color: var(--warning);
    }
    
    .expired-tasks {
      border-top: 3px solid var(--danger);
    }
    
    .expired-tasks .summary-card-value {
      color: var(--danger);
    }
    
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .task-filters {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .filter-select {
      padding: 0.5rem;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      background-color: var(--bg-light);
      color: var(--text-light);
      font-size: 16px;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .task-search {
      display: flex;
      align-items: center;
      background-color: var(--bg-light);
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      width: 100%;
      max-width: 300px;
    }
    
    .task-search input {
      border: none;
      background: none;
      width: 100%;
      font-size: 16px;
      color: var(--text-light);
    }
    
    .task-search input:focus {
      outline: none;
    }
    
    .task-search i {
      color: var(--secondary);
      margin-right: 0.5rem;
    }
    
    .view-switcher {
      display: flex;
      gap: 0.5rem;
    }
    
    .view-btn {
      padding: 0.5rem;
      background: none;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      cursor: pointer;
      color: var(--text-light);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    
    .view-btn.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .history-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .history-btn {
      padding: 0.5rem;
      background: none;
      border: 1px solid #ced4da;
      border-radius: var(--border-radius);
      cursor: pointer;
      color: var(--text-light);
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }
    
    .history-btn:hover {
      background-color: rgba(93, 92, 222, 0.1);
    }
    
    .history-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .task-list-container {
      margin-bottom: 2rem;
    }
    
    .task-list {
      display: grid;
      gap: 1rem;
    }
    
    .task-item {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1rem;
      cursor: grab;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
      border-left: 5px solid var(--light);
    }
    
    .task-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--hover-shadow);
    }
    
    .task-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .task-item.expired {
      border-left-color: var(--danger);
    }
    
    .task-item.due-soon {
      border-left-color: var(--warning);
    }
    
    .task-item.due-later {
      border-left-color: var(--success);
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
      color: var(--text-light);
    }
    
    .task-category {
      display: inline-block;
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 50px;
      background-color: rgba(93, 92, 222, 0.1);
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }
    
    .task-meta-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .task-meta-item i {
      color: var(--primary);
    }
    
    .task-priority {
      padding: 0.2rem 0.5rem;
      border-radius: 50px;
      font-size: 0.75rem;
    }
    
    .priority-high {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }
    
    .priority-medium {
      background-color: rgba(253, 126, 20, 0.1);
      color: var(--medium);
    }
    
    .priority-low {
      background-color: rgba(108, 117, 125, 0.1);
      color: var(--secondary);
    }
    
    .task-description {
      margin-bottom: 1rem;
      color: var(--text-light);
    }
    
    .task-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .task-btn {
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    
    .task-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .task-btn i {
      font-size: 0.9rem;
    }
    
    .task-complete-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: auto;
    }
    
    .task-complete-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .task-toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .task-toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    .task-complete-toggle input:checked + .task-toggle-slider {
      background-color: var(--success);
    }
    
    .task-complete-toggle input:checked + .task-toggle-slider:before {
      transform: translateX(26px);
    }
    
    .task-selection {
      display: flex;
      align-items: center;
      margin-right: 0.5rem;
    }
    
    .task-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .bulk-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--primary);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transform: translateY(100%);
      transition: transform var(--transition-speed);
      z-index: 90;
    }
    
    .bulk-actions.show {
      transform: translateY(0);
    }
    
    .bulk-info {
      font-weight: 500;
    }
    
    .bulk-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .subtasks {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      padding-left: 1.5rem;
    }
    
    .subtask-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.25rem;
    }
    
    .subtask-checkbox {
      margin-right: 0.5rem;
    }
    
    .subtask-label {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .subtask-label.completed {
      text-decoration: line-through;
      color: var(--secondary);
    }
    
    .task-graph-view {
      display: none;
    }
    
    .graphs-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .graph-card {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    
    .graph-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .graph-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-light);
    }
    
    .graph-container {
      position: relative;
      height: 300px;
    }
    
    .insights-container {
      margin-top: 2rem;
    }
    
    .insights-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-light);
    }
    
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .insight-card {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    
    .insight-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .insight-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-light);
    }
    
    .insight-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .insight-content {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      z-index: 1000;
    }
    
    .toast {
      background-color: var(--bg-light);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1rem;
      margin-bottom: 0.5rem;
      max-width: 300px;
      animation: toastIn 0.3s ease-in-out, toastOut 0.3s ease-in-out 4.7s;
      position: relative;
      overflow: hidden;
    }
    
    .toast-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-light);
    }
    
    .toast-message {
      font-size: 0.9rem;
      color: var(--text-light);
    }
    
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background-color: var(--primary);
      animation: toastProgress 5s linear;
    }
    
    @keyframes toastIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes toastOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }
    
    @keyframes toastProgress {
      from {
        width: 100%;
      }
      to {
        width: 0;
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes slideInUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
    
    .slide-in {
      animation: slideInUp 0.5s ease-in-out;
    }
    
    /* Responsive styles */
    @media (min-width: 576px) {
      .task-summary {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .total-tasks {
        grid-column: 1 / -1;
      }
      
      .modal {
        max-width: 500px;
      }
    }
    
    @media (min-width: 768px) {
      .task-summary {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .total-tasks {
        grid-column: 1 / -1;
      }
      
      .graphs-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .pie-chart-container {
        max-width: 80%;
        margin: 0 auto;
      }
    }
    
    @media (min-width: 992px) {
      .task-summary {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .total-tasks {
        grid-column: 1 / -1;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-container" id="loginPage">
    <div class="login-form">
      <h2>Welcome to To-Do App</h2>
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" class="form-control" value="test@example.com">
      </div>
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" class="form-control" value="123456">
      </div>
      <button type="button" id="loginBtn" class="btn btn-primary btn-login">Login</button>
      <div class="login-links">
        <p>Don't have an account? <a href="#" id="registerLink">Register now</a></p>
      </div>
    </div>
  </div>
  
  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Header -->
    <header class="header">
      <div class="container header-container">
        <a class="logo" id="logo">
          <i class="bi bi-check2-square"></i>
          <span>To-Do App</span>
        </a>
        <div class="header-actions">
          <div class="task-timer">
            <span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
            <div class="timer-controls">
              <button class="timer-btn" id="playTimer" aria-label="Start timer">
                <i class="bi bi-play-fill"></i>
              </button>
              <button class="timer-btn" id="pauseTimer" aria-label="Pause timer">
                <i class="bi bi-pause-fill"></i>
              </button>
            </div>
          </div>
          <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode">
            <i class="bi bi-sun"></i>
          </button>
          <div class="notification-btn" id="notificationBtn">
            <i class="bi bi-bell"></i>
            <span class="notification-badge" id="notificationBadge">0</span>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="notification-header">
                <span class="notification-title">Notifications</span>
                <span class="notification-clear" id="clearNotifications">Clear all</span>
              </div>
              <div class="notification-items" id="notificationItems">
                <div class="notifications-empty">No notifications yet</div>
              </div>
            </div>
          </div>
          <div class="user-status">
            <button class="profile-btn" id="statusBtn">
              <span>● Online</span>
            </button>
            <div class="status-dropdown" id="statusDropdown">
              <div class="status-item status-online" data-status="online">
                <span class="status-marker"></span>
                <span>Online</span>
              </div>
              <div class="status-item status-break" data-status="break">
                <span class="status-marker"></span>
                <span>Break</span>
              </div>
              <div class="status-item status-shadow" data-status="shadow">
                <span class="status-marker"></span>
                <span>Shadow</span>
              </div>
              <div class="status-item status-logout" data-status="logout">
                <span class="status-marker"></span>
                <span>Logout</span>
              </div>
            </div>
          </div>
          <div class="profile-dropdown">
            <button class="profile-btn" id="profileBtn">
              <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="profileImg">
            </button>
            <div class="profile-dropdown-menu" id="profileDropdown">
              <div class="profile-dropdown-item" id="viewProfileBtn">
                <i class="bi bi-person"></i>
                <span>View Profile</span>
              </div>
              <div class="profile-dropdown-item" id="logoutBtn">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Main Content -->
    <main class="main">
      <div class="container">
        <!-- Task Summary -->
        <div class="task-summary">
          <div class="summary-card total-tasks">
            <h3 class="summary-card-title">Total Tasks</h3>
            <div class="summary-card-value" id="totalTasksCount">0</div>
          </div>
          <div class="summary-card completed-tasks">
            <h3 class="summary-card-title">Completed Tasks</h3>
            <div class="summary-card-value" id="completedTasksCount">0</div>
          </div>
          <div class="summary-card pending-tasks">
            <h3 class="summary-card-title">Pending Tasks</h3>
            <div class="summary-card-value" id="pendingTasksCount">0</div>
          </div>
          <div class="summary-card expired-tasks">
            <h3 class="summary-card-title">Expired Tasks</h3>
            <div class="summary-card-value" id="expiredTasksCount">0</div>
          </div>
        </div>
        
        <!-- Tasks Section -->
        <div class="section-title">
          <h2>Tasks</h2>
          <div class="action-buttons">
            <button class="action-btn btn-primary" id="addTaskBtn">
              <i class="bi bi-plus-lg"></i>
              <span>Add Task</span>
            </button>
            <button class="action-btn btn-info" id="categoriesBtn">
              <i class="bi bi-tags"></i>
              <span>Categories</span>
            </button>
            <button class="action-btn btn-secondary" id="usersBtn">
              <i class="bi bi-people"></i>
              <span>Users</span>
            </button>
          </div>
        </div>
        
        <div class="action-bar">
          <div class="task-filters">
            <select class="filter-select" id="statusFilter">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
            </select>
            <select class="filter-select" id="categoryFilter">
              <option value="all">All Categories</option>
            </select>
            <select class="filter-select" id="priorityFilter">
              <option value="all">All Priorities</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select class="filter-select" id="dateFilter">
              <option value="all">All Dates</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="custom">Custom Range</option>
            </select>
            <select class="filter-select" id="sortFilter">
              <option value="dateAsc">Due Date (Earliest)</option>
              <option value="dateDesc">Due Date (Latest)</option>
              <option value="titleAsc">Title (A-Z)</option>
              <option value="titleDesc">Title (Z-A)</option>
              <option value="priorityDesc">Priority (High-Low)</option>
              <option value="priorityAsc">Priority (Low-High)</option>
            </select>
          </div>
          <div class="task-search">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" placeholder="Search tasks...">
          </div>
        </div>
        
        <div class="action-bar">
          <div class="history-actions">
            <button class="history-btn" id="undoBtn" title="Undo">
              <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button class="history-btn" id="redoBtn" title="Redo">
              <i class="bi bi-arrow-clockwise"></i>
            </button>
          </div>
          <div class="action-buttons">
            <button class="action-btn btn-secondary" id="exportBtn">
              <i class="bi bi-download"></i>
              <span>Export</span>
            </button>
            <button class="action-btn btn-secondary" id="importBtn">
              <i class="bi bi-upload"></i>
              <span>Import</span>
            </button>
          </div>
          <div class="view-switcher">
            <button class="view-btn active" id="listViewBtn">
              <i class="bi bi-list-ul"></i>
            </button>
            <button class="view-btn" id="graphViewBtn">
              <i class="bi bi-bar-chart"></i>
            </button>
          </div>
        </div>
        
        <!-- Task List View -->
        <div class="task-list-container" id="taskListView">
          <div class="task-list" id="taskList">
            <!-- Task items will be added here -->
          </div>
        </div>
        
        <!-- Task Graph View -->
        <div class="task-graph-view" id="taskGraphView">
          <div class="graphs-container">
            <div class="graph-card">
              <h3 class="graph-title">Task Progress Over Time</h3>
              <div class="graph-container">
                <canvas id="taskProgressChart"></canvas>
              </div>
            </div>
            <div class="graph-card">
              <h3 class="graph-title">Task Distribution</h3>
              <div class="graph-container pie-chart-container">
                <canvas id="taskDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Insights Section -->
        <div class="insights-container">
          <h2 class="insights-title">Insights</h2>
          <div class="insights-grid">
            <div class="insight-card">
              <h3 class="insight-title">Productivity Score</h3>
              <div class="insight-value" id="productivityScore">0%</div>
              <p class="insight-content">Based on task completion rates and timeliness.</p>
            </div>
            <div class="insight-card">
              <h3 class="insight-title">Most Productive Category</h3>
              <div class="insight-value" id="productiveCategory">None</div>
              <p class="insight-content">Category with highest completion rate.</p>
            </div>
            <div class="insight-card">
              <h3 class="insight-title">Average Completion Time</h3>
              <div class="insight-value" id="avgCompletionTime">0h</div>
              <p class="insight-content">Average time to complete tasks.</p>
            </div>
            <div class="insight-card">
              <h3 class="insight-title">Tasks Due Soon</h3>
              <div class="insight-value" id="tasksDueSoon">0</div>
              <p class="insight-content">Tasks due in the next 48 hours.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions">
      <div class="bulk-info">
        <span id="selectedCount">0</span> tasks selected
      </div>
      <div class="bulk-buttons">
        <button class="btn btn-success" id="bulkCompleteBtn">
          <i class="bi bi-check-lg"></i>
          <span>Mark Complete</span>
        </button>
        <button class="btn btn-danger" id="bulkDeleteBtn">
          <i class="bi bi-trash"></i>
          <span>Delete</span>
        </button>
        <button class="btn btn-secondary" id="bulkCancelBtn">
          <i class="bi bi-x-lg"></i>
          <span>Cancel</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  
  <!-- Modals -->
  
  <!-- Register Modal -->
  <div class="modal-backdrop" id="registerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Create Account</h3>
        <button class="modal-close" id="closeRegisterModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="register-last-name">Last Name</label>
          <input type="text" id="register-last-name" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-first-name">First Name</label>
          <input type="text" id="register-first-name" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-email">Email</label>
          <input type="email" id="register-email" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-confirm-email">Confirm Email</label>
          <input type="email" id="register-confirm-email" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-password">Password</label>
          <input type="password" id="register-password" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-confirm-password">Confirm Password</label>
          <input type="password" id="register-confirm-password" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-birthdate">Birthdate</label>
          <input type="text" id="register-birthdate" class="form-control">
        </div>
        <div class="form-group">
          <label for="register-nationality">Nationality</label>
          <select id="register-nationality" class="form-control">
            <option value="">Select country</option>
          </select>
        </div>
        <div class="form-group">
          <label for="register-role">Role</label>
          <select id="register-role" class="form-control">
            <option value="manager">Manager</option>
            <option value="staff">Staff</option>
            <option value="customer">Customer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRegisterBtn">Cancel</button>
        <button class="btn btn-success" id="createAccountBtn">Create</button>
      </div>
    </div>
  </div>
  
  <!-- Add Task Modal -->
  <div class="modal-backdrop" id="addTaskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Task</h3>
        <button class="modal-close" id="closeAddTaskModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="task-title">Title</label>
          <input type="text" id="task-title" class="form-control">
        </div>
        <div class="form-group">
          <label for="task-description">Description</label>
          <textarea id="task-description" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Sub-Tasks</label>
          <div id="subtasks-container"></div>
          <button type="button" id="addSubtaskBtn" class="btn btn-secondary" style="margin-top: 0.5rem;">
            <i class="bi bi-plus-lg"></i> Add Subtask
          </button>
        </div>
        <div class="form-group">
          <label for="task-due-date">Due Date</label>
          <input type="text" id="task-due-date" class="form-control">
        </div>
        <div class="form-group">
          <label for="task-priority">Priority</label>
          <select id="task-priority" class="form-control">
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label for="task-category">Category</label>
          <select id="task-category" class="form-control">
            <!-- Categories will be added dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label for="task-notes">Notes</label>
          <textarea id="task-notes" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelAddTaskBtn">Cancel</button>
        <button class="btn btn-success" id="saveTaskBtn">Create</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Task Modal -->
  <div class="modal-backdrop" id="editTaskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Task</h3>
        <button class="modal-close" id="closeEditTaskModal">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-task-id">
        <div class="form-group">
          <label for="edit-task-title">Title</label>
          <input type="text" id="edit-task-title" class="form-control">
        </div>
        <div class="form-group">
          <label for="edit-task-description">Description</label>
          <textarea id="edit-task-description" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Sub-Tasks</label>
          <div id="edit-subtasks-container"></div>
          <button type="button" id="editAddSubtaskBtn" class="btn btn-secondary" style="margin-top: 0.5rem;">
            <i class="bi bi-plus-lg"></i> Add Subtask
          </button>
        </div>
        <div class="form-group">
          <label for="edit-task-due-date">Due Date</label>
          <input type="text" id="edit-task-due-date" class="form-control">
        </div>
        <div class="form-group">
          <label for="edit-task-priority">Priority</label>
          <select id="edit-task-priority" class="form-control">
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-task-category">Category</label>
          <select id="edit-task-category" class="form-control">
            <!-- Categories will be added dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit-task-notes">Notes</label>
          <textarea id="edit-task-notes" class="form-control" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelEditTaskBtn">Cancel</button>
        <button class="btn btn-success" id="updateTaskBtn">Update</button>
      </div>
    </div>
  </div>
  
  <!-- View Task Modal -->
  <div class="modal-backdrop" id="viewTaskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="view-task-title">Task Details</h3>
        <button class="modal-close" id="closeViewTaskModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="task-view-details">
          <p><strong>Description:</strong> <span id="view-task-description"></span></p>
          <p><strong>Due Date:</strong> <span id="view-task-due-date"></span></p>
          <p><strong>Priority:</strong> <span id="view-task-priority"></span></p>
          <p><strong>Category:</strong> <span id="view-task-category"></span></p>
          <p><strong>Notes:</strong> <span id="view-task-notes"></span></p>
          <div>
            <strong>Sub-Tasks:</strong>
            <ul id="view-task-subtasks"></ul>
          </div>
          <p><strong>Created On:</strong> <span id="view-task-created"></span></p>
          <p><strong>Time Spent:</strong> <span id="view-task-time"></span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeViewTaskBtn">Close</button>
        <button class="btn btn-primary" id="editFromViewBtn">Edit</button>
        <button class="btn btn-success" id="shareTaskBtn">Share</button>
      </div>
    </div>
  </div>
  
  <!-- Share Task Modal -->
  <div class="modal-backdrop" id="shareTaskModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Share Task</h3>
        <button class="modal-close" id="closeShareTaskModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="share-task-users">Share with:</label>
          <select id="share-task-users" class="form-control" multiple>
            <!-- Users will be added dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label for="share-task-message">Message (optional):</label>
          <textarea id="share-task-message" class="form-control" rows="3" placeholder="Add a message..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelShareBtn">Cancel</button>
        <button class="btn btn-success" id="confirmShareBtn">Share</button>
      </div>
    </div>
  </div>
  
  <!-- Export Modal -->
  <div class="modal-backdrop" id="exportModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Export Tasks</h3>
        <button class="modal-close" id="closeExportModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="export-format">Select Format</label>
          <select id="export-format" class="form-control">
            <option value="pdf">PDF</option>
            <option value="excel">Excel</option>
            <option value="json">JSON</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
        <button class="btn btn-success" id="confirmExportBtn">Export</button>
      </div>
    </div>
  </div>
  
  <!-- Import Modal -->
  <div class="modal-backdrop" id="importModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Import Tasks</h3>
        <button class="modal-close" id="closeImportModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="import-file">Upload JSON File</label>
          <input type="file" id="import-file" class="form-control" accept=".json">
        </div>
        <div class="form-group">
          <label for="import-url">Or Import from URL</label>
          <input type="text" id="import-url" class="form-control" placeholder="https://example.com/tasks.json">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelImportBtn">Cancel</button>
        <button class="btn btn-success" id="confirmImportBtn">Import</button>
      </div>
    </div>
  </div>
  
  <!-- Manage Categories Modal -->
  <div class="modal-backdrop" id="categoriesModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Manage Categories</h3>
        <button class="modal-close" id="closeCategoriesModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="new-category">New Category</label>
          <div class="d-flex" style="display: flex; gap: 0.5rem;">
            <input type="text" id="new-category" class="form-control" style="flex: 1;">
            <button class="btn btn-primary" id="addCategoryBtn">Add</button>
          </div>
        </div>
        <div class="categories-list" id="categoriesList" style="margin-top: 1rem;">
          <!-- Categories will be added dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeCategoriesBtn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- View Profile Modal -->
  <div class="modal-backdrop" id="viewProfileModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">User Profile</h3>
        <button class="modal-close" id="closeViewProfileModal">&times;</button>
      </div>
      <div class="modal-body" id="profileModalContent">
        <div class="text-center" style="text-align: center; margin-bottom: 1.5rem;">
          <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="profileModalImg" style="width: 100px; height: 100px; border-width: 3px;">
        </div>
        <div class="profile-info">
          <p><strong>Name:</strong> <span id="profileName">John Doe</span></p>
          <p><strong>Email:</strong> <span id="profileEmail">test@example.com</span></p>
          <p><strong>Role:</strong> <span id="profileRole">Admin</span></p>
          <p><strong>Joined:</strong> <span id="profileJoined">January 1, 2023</span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeProfileBtn">Close</button>
        <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Profile Modal -->
  <div class="modal-backdrop" id="editProfileModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Profile</h3>
        <button class="modal-close" id="closeEditProfileModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="text-center" style="text-align: center; margin-bottom: 1.5rem;">
          <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="editProfileImg" style="width: 100px; height: 100px; border-width: 3px;">
          <div style="margin-top: 0.5rem;">
            <input type="file" id="profilePicture" accept="image/*" style="display: none;">
            <button class="btn btn-primary" id="changePictureBtn" style="font-size: 0.9rem;">Change Picture</button>
          </div>
        </div>
        <div class="form-group">
          <label for="edit-profile-first-name">First Name</label>
          <input type="text" id="edit-profile-first-name" class="form-control">
        </div>
        <div class="form-group">
          <label for="edit-profile-last-name">Last Name</label>
          <input type="text" id="edit-profile-last-name" class="form-control">
        </div>
        <div class="form-group">
          <label for="edit-profile-email">Email</label>
          <input type="email" id="edit-profile-email" class="form-control">
        </div>
        <div class="form-group">
          <label for="edit-profile-role">Role</label>
          <select id="edit-profile-role" class="form-control">
            <option value="manager">Manager</option>
            <option value="staff">Staff</option>
            <option value="customer">Customer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelEditProfileBtn">Cancel</button>
        <button class="btn btn-success" id="saveProfileBtn">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Users Modal -->
  <div class="modal-backdrop" id="usersModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Users</h3>
        <button class="modal-close" id="closeUsersModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="users-list" id="usersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
          <!-- Users will be added dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeUsersBtn">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Date Range Picker Modal -->
  <div class="modal-backdrop" id="dateRangeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Select Date Range</h3>
        <button class="modal-close" id="closeDateRangeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="start-date">Start Date</label>
          <input type="text" id="start-date" class="form-control">
        </div>
        <div class="form-group">
          <label for="end-date">End Date</label>
          <input type="text" id="end-date" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelDateRangeBtn">Cancel</button>
        <button class="btn btn-success" id="applyDateRangeBtn">Apply</button>
      </div>
    </div>
  </div>
  
  <script>
    // Check and apply dark mode
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
    
    // DOM Elements
    const loginPage = document.getElementById('loginPage');
    const dashboard = document.getElementById('dashboard');
    const registerLink = document.getElementById('registerLink');
    const registerModal = document.getElementById('registerModal');
    const closeRegisterModal = document.getElementById('closeRegisterModal');
    const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileDropdown = document.getElementById('profileDropdown');
    const viewProfileBtn = document.getElementById('viewProfileBtn');
    const viewProfileModal = document.getElementById('viewProfileModal');
    const closeViewProfileModal = document.getElementById('closeViewProfileModal');
    const closeProfileBtn = document.getElementById('closeProfileBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const editProfileModal = document.getElementById('editProfileModal');
    const closeEditProfileModal = document.getElementById('closeEditProfileModal');
    const cancelEditProfileBtn = document.getElementById('cancelEditProfileBtn');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const changePictureBtn = document.getElementById('changePictureBtn');
    const profilePicture = document.getElementById('profilePicture');
    const themeToggle = document.getElementById('themeToggle');
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationDropdown = document.getElementById('notificationDropdown');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationItems = document.getElementById('notificationItems');
    const clearNotifications = document.getElementById('clearNotifications');
    const statusBtn = document.getElementById('statusBtn');
    const statusDropdown = document.getElementById('statusDropdown');
    const profileImg = document.getElementById('profileImg');
    const logo = document.getElementById('logo');
    
    // Task Elements
    const addTaskBtn = document.getElementById('addTaskBtn');
    const addTaskModal = document.getElementById('addTaskModal');
    const closeAddTaskModal = document.getElementById('closeAddTaskModal');
    const cancelAddTaskBtn = document.getElementById('cancelAddTaskBtn');
    const saveTaskBtn = document.getElementById('saveTaskBtn');
    const taskList = document.getElementById('taskList');
    const editTaskModal = document.getElementById('editTaskModal');
    const closeEditTaskModal = document.getElementById('closeEditTaskModal');
    const cancelEditTaskBtn = document.getElementById('cancelEditTaskBtn');
    const updateTaskBtn = document.getElementById('updateTaskBtn');
    const viewTaskModal = document.getElementById('viewTaskModal');
    const closeViewTaskModal = document.getElementById('closeViewTaskModal');
    const closeViewTaskBtn = document.getElementById('closeViewTaskBtn');
    const editFromViewBtn = document.getElementById('editFromViewBtn');
    const shareTaskBtn = document.getElementById('shareTaskBtn');
    const shareTaskModal = document.getElementById('shareTaskModal');
    const closeShareTaskModal = document.getElementById('closeShareTaskModal');
    const cancelShareBtn = document.getElementById('cancelShareBtn');
    const confirmShareBtn = document.getElementById('confirmShareBtn');
    const exportBtn = document.getElementById('exportBtn');
    const exportModal = document.getElementById('exportModal');
    const closeExportModal = document.getElementById('closeExportModal');
    const cancelExportBtn = document.getElementById('cancelExportBtn');
    const confirmExportBtn = document.getElementById('confirmExportBtn');
    const importBtn = document.getElementById('importBtn');
    const importModal = document.getElementById('importModal');
    const closeImportModal = document.getElementById('closeImportModal');
    const cancelImportBtn = document.getElementById('cancelImportBtn');
    const confirmImportBtn = document.getElementById('confirmImportBtn');
    const categoriesBtn = document.getElementById('categoriesBtn');
    const categoriesModal = document.getElementById('categoriesModal');
    const closeCategoriesModal = document.getElementById('closeCategoriesModal');
    const closeCategoriesBtn = document.getElementById('closeCategoriesBtn');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoriesList = document.getElementById('categoriesList');
    const usersBtn = document.getElementById('usersBtn');
    const usersModal = document.getElementById('usersModal');
    const closeUsersModal = document.getElementById('closeUsersModal');
    const closeUsersBtn = document.getElementById('closeUsersBtn');
    const usersList = document.getElementById('usersList');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkCancelBtn = document.getElementById('bulkCancelBtn');
    const statusFilter = document.getElementById('statusFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const dateFilter = document.getElementById('dateFilter');
    const sortFilter = document.getElementById('sortFilter');
    const searchInput = document.getElementById('searchInput');
    const listViewBtn = document.getElementById('listViewBtn');
    const graphViewBtn = document.getElementById('graphViewBtn');
    const taskListView = document.getElementById('taskListView');
    const taskGraphView = document.getElementById('taskGraphView');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const dateRangeModal = document.getElementById('dateRangeModal');
    const closeDateRangeModal = document.getElementById('closeDateRangeModal');
    const cancelDateRangeBtn = document.getElementById('cancelDateRangeBtn');
    const applyDateRangeBtn = document.getElementById('applyDateRangeBtn');
    
    // Timer elements
    const hoursElement = document.getElementById('hours');
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');
    const playTimer = document.getElementById('playTimer');
    const pauseTimer = document.getElementById('pauseTimer');
    
    // Summary elements
    const totalTasksCount = document.getElementById('totalTasksCount');
    const completedTasksCount = document.getElementById('completedTasksCount');
    const pendingTasksCount = document.getElementById('pendingTasksCount');
    const expiredTasksCount = document.getElementById('expiredTasksCount');
    
    // Insights elements
    const productivityScore = document.getElementById('productivityScore');
    const productiveCategory = document.getElementById('productiveCategory');
    const avgCompletionTime = document.getElementById('avgCompletionTime');
    const tasksDueSoon = document.getElementById('tasksDueSoon');
    
    // Subtask elements
    const subtasksContainer = document.getElementById('subtasks-container');
    const addSubtaskBtn = document.getElementById('addSubtaskBtn');
    const editSubtasksContainer = document.getElementById('edit-subtasks-container');
    const editAddSubtaskBtn = document.getElementById('editAddSubtaskBtn');
    
    // State Management
    let currentUser = null;
    let tasks = [];
    let categories = ['Work', 'Personal', 'Shopping', 'Health', 'Finance', 'Education'];
    let notifications = [];
    let users = [];
    let history = {
      past: [],
      future: []
    };
    let activeTask = null;
    let timer = {
      seconds: 0,
      minutes: 0,
      hours: 0,
      intervalId: null,
      isRunning: false,
      task: null
    };
    
    // Initialize flatpickr date pickers
    function initializeDatePickers() {
      flatpickr("#register-birthdate", {
        dateFormat: "Y-m-d",
        maxDate: "today"
      });
      
      flatpickr("#task-due-date", {
        dateFormat: "Y-m-d H:i",
        enableTime: true,
        minDate: "today"
      });
      
      flatpickr("#edit-task-due-date", {
        dateFormat: "Y-m-d H:i",
        enableTime: true
      });
      
      flatpickr("#start-date", {
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr) {
          const endDatePicker = document.getElementById("end-date")._flatpickr;
          endDatePicker.set("minDate", dateStr);
        }
      });
      
      flatpickr("#end-date", {
        dateFormat: "Y-m-d"
      });
    }
    
    // Fetch countries for registration
    async function fetchCountries() {
      try {
        const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
        const countries = await response.json();
        
        const nationalitySelect = document.getElementById('register-nationality');
        countries.sort((a, b) => a.name.common.localeCompare(b.name.common)).forEach(country => {
          const option = document.createElement('option');
          option.value = country.name.common;
          option.textContent = country.name.common;
          nationalitySelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error fetching countries:', error);
        // Fallback with some common countries
        const countries = ['United States', 'Canada', 'United Kingdom', 'Australia', 'Germany', 'France', 'Japan', 'China', 'Brazil', 'India'];
        const nationalitySelect = document.getElementById('register-nationality');
        countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          nationalitySelect.appendChild(option);
        });
      }
    }
    
    // Initialize Random Users
    function initializeRandomUsers() {
      const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
      const names = [
        { first: 'John', last: 'Doe' },
        { first: 'Jane', last: 'Smith' },
        { first: 'Michael', last: 'Johnson' },
        { first: 'Emily', last: 'Williams' },
        { first: 'David', last: 'Brown' },
        { first: 'Sarah', last: 'Jones' },
        { first: 'Daniel', last: 'Garcia' },
        { first: 'Olivia', last: 'Miller' },
        { first: 'James', last: 'Davis' },
        { first: 'Sophia', last: 'Rodriguez' }
      ];
      
      for (let i = 0; i < 10; i++) {
        const gender = Math.random() > 0.5 ? 'men' : 'women';
        const user = {
          id: `user-${i + 1}`,
          firstName: names[i].first,
          lastName: names[i].last,
          email: `${names[i].first.toLowerCase()}.${names[i].last.toLowerCase()}@example.com`,
          role: roles[Math.floor(Math.random() * roles.length)],
          profilePicture: `https://randomuser.me/api/portraits/${gender}/${i + 1}.jpg`,
          joinDate: new Date(Date.now() - Math.floor(Math.random() * 90) * 24 * 60 * 60 * 1000).toISOString()
        };
        users.push(user);
      }
      
      renderUsersList();
      populateShareTaskUsers();
    }
    
    // Initialize Random Tasks
    function initializeRandomTasks() {
      const taskTitles = [
        'Complete Project Proposal',
        'Review Marketing Strategy',
        'Schedule Team Meeting',
        'Update Website Content',
        'Prepare Financial Report',
        'Research New Technologies',
        'Call Important Client',
        'Fix Bug in Application',
        'Create Social Media Campaign',
        'Order Office Supplies',
        'Arrange Transportation',
        'Design New Product Interface'
      ];
      
      const descriptions = [
        'Finalize all details and submit for approval',
        'Analyze current performance and suggest improvements',
        'Coordinate with all team members for availability',
        'Update blog posts and product descriptions',
        'Compile financial data for the quarterly report',
        'Research emerging technologies relevant to our industry',
        'Discuss upcoming project details and timeline',
        'Identify and fix the authentication issue',
        'Create content calendar for next month',
        'Restock essential office supplies',
        'Arrange transportation for upcoming conference',
        'Create wireframes and mockups for the new interface'
      ];
      
      const notes = [
        'Remember to include budget forecasts',
        'Focus on conversion rates',
        'Prepare agenda beforehand',
        'SEO optimization is crucial',
        'Include comparison with previous quarter',
        'Pay special attention to AI developments',
        'Prepare talking points',
        'Check server logs for clues',
        'Coordinate with the design team',
        'Check inventory before ordering',
        'Consider multiple options for cost comparison',
        'Get feedback from the UX team'
      ];
      
      const subtasks = [
        ['Research market trends', 'Draft outline', 'Get input from team', 'Review with manager'],
        ['Analyze social media metrics', 'Review competitor strategies', 'Draft improvement plan'],
        ['Send calendar invites', 'Prepare presentation', 'Book meeting room'],
        ['Update product descriptions', 'Optimize images', 'Update meta tags'],
        ['Collect expense reports', 'Reconcile accounts', 'Draft executive summary'],
        ['Read industry publications', 'Talk to experts', 'Summarize findings'],
        ['Prepare talking points', 'Gather project materials', 'Schedule follow-up'],
        ['Reproduce bug', 'Identify cause', 'Test fix', 'Deploy solution'],
        ['Define target audience', 'Create content calendar', 'Design graphics'],
        ['Inventory current supplies', 'Get approval for purchases', 'Place order'],
        ['Research options', 'Get quotes', 'Make reservations'],
        ['Sketch initial ideas', 'Create wireframes', 'Design high-fidelity mockups']
      ];
      
      const priorities = ['high', 'medium', 'low'];
      
      // Create 12 tasks with random properties
      for (let i = 0; i < 12; i++) {
        const createdDate = new Date();
        createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 10));
        
        const dueDate = new Date();
        // Distribute due dates: 2 expired, 3 due soon, 7 due later
        if (i < 2) {
          dueDate.setDate(dueDate.getDate() - Math.floor(Math.random() * 5 + 1)); // Expired
        } else if (i < 5) {
          dueDate.setHours(dueDate.getHours() + Math.floor(Math.random() * 47 + 1)); // Due soon (within 48 hours)
        } else {
          dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 14 + 3)); // Due later (3+ days)
        }
        
        const taskSubtasks = subtasks[i].map((subtask, idx) => ({
          id: `subtask-${i}-${idx}`,
          title: subtask,
          completed: Math.random() > 0.7
        }));
        
        const task = {
          id: `task-${i + 1}`,
          title: taskTitles[i],
          description: descriptions[i],
          dueDate: dueDate.toISOString(),
          priority: priorities[Math.floor(Math.random() * priorities.length)],
          category: categories[Math.floor(Math.random() * categories.length)],
          notes: notes[i],
          subtasks: taskSubtasks,
          completed: i < 3, // Make first 3 tasks completed
          createdDate: createdDate.toISOString(),
          timeSpent: Math.floor(Math.random() * 7200), // Random time spent in seconds (up to 2 hours)
        };
        
        tasks.push(task);
      }
      
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
    }
    
    // Render Tasks
    function renderTasks() {
      const filteredTasks = filterTasks();
      taskList.innerHTML = '';
      
      if (filteredTasks.length === 0) {
        taskList.innerHTML = '<div class="text-center" style="padding: 2rem; text-align: center; color: var(--secondary);">No tasks found</div>';
        return;
      }
      
      filteredTasks.forEach(task => {
        const now = new Date();
        const dueDate = new Date(task.dueDate);
        let statusClass = '';
        
        if (dueDate < now && !task.completed) {
          statusClass = 'expired';
        } else if (dueDate > now && dueDate - now < 48 * 60 * 60 * 1000 && !task.completed) {
          statusClass = 'due-soon';
        } else if (!task.completed) {
          statusClass = 'due-later';
        }
        
        const taskElement = document.createElement('div');
        taskElement.className = `task-item ${statusClass} ${task.completed ? 'completed' : ''}`;
        taskElement.dataset.id = task.id;
        taskElement.draggable = true;
        
        // Format time spent
        const timeSpent = formatTimeSpent(task.timeSpent);
        
        // Format due date
        const formattedDueDate = formatDate(task.dueDate);
        
        // Priority class
        const priorityClass = task.priority === 'high' ? 'priority-high' : task.priority === 'medium' ? 'priority-medium' : 'priority-low';
        
        taskElement.innerHTML = `
          <div class="task-header">
            <div class="task-selection">
              <input type="checkbox" class="task-checkbox" data-id="${task.id}" aria-label="Select task">
            </div>
            <h3 class="task-title">${task.title}</h3>
            <label class="task-complete-toggle">
              <input type="checkbox" class="complete-toggle" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
              <span class="task-toggle-slider"></span>
            </label>
          </div>
          <span class="task-category">${task.category}</span>
          <p class="task-description">${task.description}</p>
          
          ${task.subtasks && task.subtasks.length > 0 ? `
            <div class="subtasks">
              ${task.subtasks.map(subtask => `
                <div class="subtask-item">
                  <input type="checkbox" class="subtask-checkbox" data-task-id="${task.id}" data-subtask-id="${subtask.id}" ${subtask.completed ? 'checked' : ''}>
                  <span class="subtask-label ${subtask.completed ? 'completed' : ''}">${subtask.title}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <div class="task-meta">
            <span class="task-meta-item">
              <i class="bi bi-calendar"></i>
              <span>${formattedDueDate}</span>
            </span>
            <span class="task-meta-item">
              <i class="bi bi-flag"></i>
              <span class="task-priority ${priorityClass}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
            </span>
            <span class="task-meta-item">
              <i class="bi bi-clock"></i>
              <span>${timeSpent}</span>
            </span>
          </div>
          
          <div class="task-actions">
            <button class="task-btn btn-primary view-task-btn" data-id="${task.id}">
              <i class="bi bi-eye"></i>
              <span>View</span>
            </button>
            <button class="task-btn btn-info edit-task-btn" data-id="${task.id}">
              <i class="bi bi-pencil"></i>
              <span>Edit</span>
            </button>
            <button class="task-btn btn-danger delete-task-btn" data-id="${task.id}">
              <i class="bi bi-trash"></i>
              <span>Delete</span>
            </button>
            <button class="task-btn ${timer.task === task.id && timer.isRunning ? 'btn-warning' : 'btn-success'} timer-task-btn" data-id="${task.id}">
              <i class="bi ${timer.task === task.id && timer.isRunning ? 'bi-pause-fill' : 'bi-play-fill'}"></i>
              <span>${timer.task === task.id && timer.isRunning ? 'Pause' : 'Play'}</span>
            </button>
          </div>
        `;
        
        taskList.appendChild(taskElement);
        
        // Add event listeners
        const viewBtn = taskElement.querySelector('.view-task-btn');
        viewBtn.addEventListener('click', () => viewTask(task.id));
        
        const editBtn = taskElement.querySelector('.edit-task-btn');
        editBtn.addEventListener('click', () => editTask(task.id));
        
        const deleteBtn = taskElement.querySelector('.delete-task-btn');
        deleteBtn.addEventListener('click', () => deleteTask(task.id));
        
        const timerBtn = taskElement.querySelector('.timer-task-btn');
        timerBtn.addEventListener('click', () => toggleTaskTimer(task.id));
        
        const completeToggle = taskElement.querySelector('.complete-toggle');
        completeToggle.addEventListener('change', (e) => toggleTaskComplete(task.id, e.target.checked));
        
        const checkbox = taskElement.querySelector('.task-checkbox');
        checkbox.addEventListener('change', () => updateBulkActions());
        
        // Subtask checkboxes
        const subtaskCheckboxes = taskElement.querySelectorAll('.subtask-checkbox');
        subtaskCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            toggleSubtaskComplete(e.target.dataset.taskId, e.target.dataset.subtaskId, e.target.checked);
          });
        });
        
        // Drag and drop
        taskElement.addEventListener('dragstart', handleDragStart);
        taskElement.addEventListener('dragend', handleDragEnd);
        taskElement.addEventListener('dragover', handleDragOver);
        taskElement.addEventListener('dragenter', handleDragEnter);
        taskElement.addEventListener('dragleave', handleDragLeave);
        taskElement.addEventListener('drop', handleDrop);
      });
    }
    
    // Drag and Drop Handlers
    let draggedItem = null;
    
    function handleDragStart(e) {
      this.classList.add('dragging');
      draggedItem = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragEnd() {
      this.classList.remove('dragging');
      draggedItem = null;
      
      // Reset all drag effects on other items
      const items = document.querySelectorAll('.task-item');
      items.forEach(item => {
        item.classList.remove('drag-over');
      });
    }
    
    function handleDragOver(e) {
      e.preventDefault();
      return false;
    }
    
    function handleDragEnter(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    }
    
    function handleDragLeave() {
      this.classList.remove('drag-over');
    }
    
    function handleDrop(e) {
      e.stopPropagation();
      e.preventDefault();
      
      if (draggedItem !== this) {
        // Get task IDs
        const draggedTaskId = draggedItem.dataset.id;
        const targetTaskId = this.dataset.id;
        
        // Save state for undo
        saveState();
        
        // Find positions in filtered tasks array
        const filteredTasks = filterTasks();
        const draggedIndex = filteredTasks.findIndex(t => t.id === draggedTaskId);
        const targetIndex = filteredTasks.findIndex(t => t.id === targetTaskId);
        
        // Find positions in original tasks array
        const originalDraggedIndex = tasks.findIndex(t => t.id === draggedTaskId);
        const originalTargetIndex = tasks.findIndex(t => t.id === targetTaskId);
        
        // Calculate new position in original array
        const offset = originalTargetIndex - targetIndex;
        const newPosition = draggedIndex + offset;
        
        // Remove the task from its original position
        const taskToMove = tasks.splice(originalDraggedIndex, 1)[0];
        
        // Insert the task at the new position
        tasks.splice(newPosition, 0, taskToMove);
        
        // Re-render tasks
        renderTasks();
        
        // Show notification
        showToast('Task Order Updated', 'Task order has been updated successfully.');
      }
      
      this.classList.remove('drag-over');
      return false;
    }
    
    // Filter Tasks
    function filterTasks() {
      let filtered = [...tasks];
      
      // Status filter
      if (statusFilter.value !== 'all') {
        if (statusFilter.value === 'active') {
          filtered = filtered.filter(task => !task.completed);
        } else if (statusFilter.value === 'completed') {
          filtered = filtered.filter(task => task.completed);
        }
      }
      
      // Category filter
      if (categoryFilter.value !== 'all') {
        filtered = filtered.filter(task => task.category === categoryFilter.value);
      }
      
      // Priority filter
      if (priorityFilter.value !== 'all') {
        filtered = filtered.filter(task => task.priority === priorityFilter.value);
      }
      
      // Date filter
      if (dateFilter.value !== 'all') {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        if (dateFilter.value === 'today') {
          filtered = filtered.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate.getDate() === today.getDate() &&
                   taskDate.getMonth() === today.getMonth() &&
                   taskDate.getFullYear() === today.getFullYear();
          });
        } else if (dateFilter.value === 'week') {
          const weekLater = new Date(today);
          weekLater.setDate(weekLater.getDate() + 7);
          
          filtered = filtered.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate >= today && taskDate <= weekLater;
          });
        } else if (dateFilter.value === 'month') {
          const monthLater = new Date(today);
          monthLater.setMonth(monthLater.getMonth() + 1);
          
          filtered = filtered.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate >= today && taskDate <= monthLater;
          });
        } else if (dateFilter.value === 'custom' && window.customDateRange) {
          filtered = filtered.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate >= window.customDateRange.start && taskDate <= window.customDateRange.end;
          });
        }
      }
      
      // Search filter
      if (searchInput.value.trim() !== '') {
        const searchTerm = searchInput.value.trim().toLowerCase();
        filtered = filtered.filter(task => 
          task.title.toLowerCase().includes(searchTerm) || 
          task.description.toLowerCase().includes(searchTerm)
        );
      }
      
      // Sort
      filtered = sortTasks(filtered);
      
      return filtered;
    }
    
    // Sort Tasks
    function sortTasks(taskList) {
      const sort = sortFilter.value;
      const sorted = [...taskList];
      
      switch (sort) {
        case 'dateAsc':
          sorted.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
          break;
        case 'dateDesc':
          sorted.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
          break;
        case 'titleAsc':
          sorted.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'titleDesc':
          sorted.sort((a, b) => b.title.localeCompare(a.title));
          break;
        case 'priorityDesc':
          const priorityOrder = { high: 3, medium: 2, low: 1 };
          sorted.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
          break;
        case 'priorityAsc':
          const priorityOrderAsc = { high: 3, medium: 2, low: 1 };
          sorted.sort((a, b) => priorityOrderAsc[a.priority] - priorityOrderAsc[b.priority]);
          break;
        default:
          // Default sort (due date ascending)
          sorted.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      }
      
      return sorted;
    }
    
    // Update Task Counts
    function updateTaskCounts() {
      const total = tasks.length;
      const completed = tasks.filter(task => task.completed).length;
      const pending = total - completed;
      
      const now = new Date();
      const expired = tasks.filter(task => !task.completed && new Date(task.dueDate) < now).length;
      
      totalTasksCount.textContent = total;
      completedTasksCount.textContent = completed;
      pendingTasksCount.textContent = pending;
      expiredTasksCount.textContent = expired;
    }
    
    // Update Task Charts
    function updateTaskCharts() {
      // Get the canvas elements
      const progressCanvas = document.getElementById('taskProgressChart');
      const distributionCanvas = document.getElementById('taskDistributionChart');
      
      // Destroy previous charts if they exist
      if (window.progressChart) {
        window.progressChart.destroy();
      }
      if (window.distributionChart) {
        window.distributionChart.destroy();
      }
      
      // Prepare data for progress chart
      const dates = [];
      const completedCounts = [];
      const pendingCounts = [];
      
      // Get the last 7 days
      const today = new Date();
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        
        const dateString = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        dates.push(dateString);
        
        // Count completed and pending tasks for this date
        const dateStart = new Date(date);
        dateStart.setHours(0, 0, 0, 0);
        const dateEnd = new Date(date);
        dateEnd.setHours(23, 59, 59, 999);
        
        const completedOnDate = tasks.filter(task => 
          task.completed && 
          new Date(task.dueDate) >= dateStart && 
          new Date(task.dueDate) <= dateEnd
        ).length;
        
        const pendingOnDate = tasks.filter(task => 
          !task.completed && 
          new Date(task.dueDate) >= dateStart && 
          new Date(task.dueDate) <= dateEnd
        ).length;
        
        completedCounts.push(completedOnDate);
        pendingCounts.push(pendingOnDate);
      }
      
      // Create progress chart
      const isDarkMode = document.documentElement.classList.contains('dark');
      const textColor = isDarkMode ? '#E9ECEF' : '#212529';
      
      window.progressChart = new Chart(progressCanvas, {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Completed',
              data: completedCounts,
              backgroundColor: '#28A745',
              borderColor: '#28A745',
              borderWidth: 1
            },
            {
              label: 'Pending',
              data: pendingCounts,
              backgroundColor: '#FFC107',
              borderColor: '#FFC107',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                color: textColor
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: textColor
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: textColor
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            },
            animation: {
              duration: 1000
            }
          }
        }
      });
      
      // Prepare data for distribution chart
      const completed = tasks.filter(task => task.completed).length;
      const pending = tasks.filter(task => !task.completed).length;
      
      // Create distribution chart
      window.distributionChart = new Chart(distributionCanvas, {
        type: 'pie',
        data: {
          labels: ['Completed', 'Pending'],
          datasets: [{
            data: [completed, pending],
            backgroundColor: ['#28A745', '#FFC107'],
            borderColor: ['#28A745', '#FFC107'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor
              }
            },
            tooltip: {
              displayColors: false
            },
            animation: {
              animateRotate: true,
              animateScale: true
            }
          }
        }
      });
    }
    
    // Update Insights
    function updateInsights() {
      // Productivity Score
      const total = tasks.length;
      const completed = tasks.filter(task => task.completed).length;
      const score = total > 0 ? Math.round((completed / total) * 100) : 0;
      productivityScore.textContent = `${score}%`;
      
      // Most Productive Category
      const categoryCompletionRates = {};
      
      categories.forEach(category => {
        const categoryTasks = tasks.filter(task => task.category === category);
        const categoryCompleted = categoryTasks.filter(task => task.completed).length;
        
        if (categoryTasks.length > 0) {
          categoryCompletionRates[category] = categoryCompleted / categoryTasks.length;
        }
      });
      
      let mostProductiveCategory = 'None';
      let highestRate = 0;
      
      for (const category in categoryCompletionRates) {
        if (categoryCompletionRates[category] > highestRate) {
          highestRate = categoryCompletionRates[category];
          mostProductiveCategory = category;
        }
      }
      
      productiveCategory.textContent = mostProductiveCategory;
      
      // Average Completion Time
      const completedTasks = tasks.filter(task => task.completed);
      const totalTimeSpent = completedTasks.reduce((sum, task) => sum + task.timeSpent, 0);
      const avgTime = completedTasks.length > 0 ? Math.round(totalTimeSpent / completedTasks.length / 60) : 0;
      avgCompletionTime.textContent = `${avgTime}m`;
      
      // Tasks Due Soon
      const now = new Date();
      const in48Hours = new Date(now);
      in48Hours.setHours(in48Hours.getHours() + 48);
      
      const dueSoonCount = tasks.filter(task => 
        !task.completed && 
        new Date(task.dueDate) > now && 
        new Date(task.dueDate) <= in48Hours
      ).length;
      
      tasksDueSoon.textContent = dueSoonCount;
    }
    
    // Save state for undo/redo
    function saveState() {
      history.past.push(JSON.stringify(tasks));
      history.future = [];
      updateHistoryButtons();
    }
    
    // Update undo/redo button states
    function updateHistoryButtons() {
      undoBtn.classList.toggle('disabled', history.past.length === 0);
      redoBtn.classList.toggle('disabled', history.future.length === 0);
    }
    
    // Undo action
    function undo() {
      if (history.past.length === 0) return;
      
      const currentState = JSON.stringify(tasks);
      history.future.push(currentState);
      
      const previousState = history.past.pop();
      tasks = JSON.parse(previousState);
      
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      updateHistoryButtons();
      
      showToast('Undo', 'Last action undone successfully.');
    }
    
    // Redo action
    function redo() {
      if (history.future.length === 0) return;
      
      const currentState = JSON.stringify(tasks);
      history.past.push(currentState);
      
      const nextState = history.future.pop();
      tasks = JSON.parse(nextState);
      
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      updateHistoryButtons();
      
      showToast('Redo', 'Action redone successfully.');
    }
    
    // Timer Functions
    function startTimer() {
      if (timer.intervalId) return;
      
      timer.isRunning = true;
      timer.intervalId = setInterval(() => {
        timer.seconds++;
        
        if (timer.seconds >= 60) {
          timer.seconds = 0;
          timer.minutes++;
          
          if (timer.minutes >= 60) {
            timer.minutes = 0;
            timer.hours++;
          }
        }
        
        updateTimerDisplay();
        
        // Update task time if a task is active
        if (timer.task) {
          const taskIndex = tasks.findIndex(t => t.id === timer.task);
          if (taskIndex !== -1) {
            tasks[taskIndex].timeSpent++;
            
            // Update the time display in the task list
            const taskElement = document.querySelector(`.task-item[data-id="${timer.task}"]`);
            if (taskElement) {
              const timeSpentElement = taskElement.querySelector('.task-meta-item:nth-child(3) span');
              if (timeSpentElement) {
                timeSpentElement.textContent = formatTimeSpent(tasks[taskIndex].timeSpent);
              }
            }
          }
        }
      }, 1000);
    }
    
    function pauseTimer() {
      if (timer.intervalId) {
        clearInterval(timer.intervalId);
        timer.intervalId = null;
        timer.isRunning = false;
        
        // If a task is active, show time spent
        if (timer.task) {
          const taskIndex = tasks.findIndex(t => t.id === timer.task);
          if (taskIndex !== -1) {
            const timeSpent = formatTimeSpent(tasks[taskIndex].timeSpent);
            showToast('Timer Paused', `You've spent ${timeSpent} on this task.`);
            
            // Update play/pause button text
            const timerBtn = document.querySelector(`.timer-task-btn[data-id="${timer.task}"]`);
            if (timerBtn) {
              timerBtn.innerHTML = `<i class="bi bi-play-fill"></i><span>Play</span>`;
              timerBtn.classList.remove('btn-warning');
              timerBtn.classList.add('btn-success');
            }
          }
        }
        
        timer.task = null;
      }
    }
    
    function updateTimerDisplay() {
      hoursElement.textContent = String(timer.hours).padStart(2, '0');
      minutesElement.textContent = String(timer.minutes).padStart(2, '0');
      secondsElement.textContent = String(timer.seconds).padStart(2, '0');
    }
    
    // Toggle task timer
    function toggleTaskTimer(taskId) {
      // If another task is currently running, pause it first
      if (timer.isRunning && timer.task && timer.task !== taskId) {
        pauseTimer();
      }
      
      const taskIndex = tasks.findIndex(t => t.id === taskId);
      if (taskIndex === -1) return;
      
      // If this task is already running, pause it
      if (timer.isRunning && timer.task === taskId) {
        pauseTimer();
      } else {
        // Otherwise, start the timer for this task
        timer.task = taskId;
        
        // Set timer values from task time spent
        const timeSpent = tasks[taskIndex].timeSpent;
        timer.seconds = timeSpent % 60;
        timer.minutes = Math.floor(timeSpent / 60) % 60;
        timer.hours = Math.floor(timeSpent / 3600);
        
        updateTimerDisplay();
        startTimer();
        
        // Update play/pause button text
        const timerBtn = document.querySelector(`.timer-task-btn[data-id="${taskId}"]`);
        if (timerBtn) {
          timerBtn.innerHTML = `<i class="bi bi-pause-fill"></i><span>Pause</span>`;
          timerBtn.classList.remove('btn-success');
          timerBtn.classList.add('btn-warning');
        }
        
        showToast('Timer Started', `Now tracking time for: ${tasks[taskIndex].title}`);
      }
    }
    
    // Format time spent
    function formatTimeSpent(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((date - now) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return `Today, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays === 1) {
        return `Tomorrow, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays === -1) {
        return `Yesterday, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays > 1 && diffDays < 7) {
        return `${date.toLocaleDateString([], { weekday: 'long' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return `${date.toLocaleDateString([], { month: 'short', day: 'numeric' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      }
    }
    
    // Create Category
    function createCategory(categoryName) {
      if (categories.includes(categoryName)) {
        showToast('Error', 'Category already exists.');
        return;
      }
      
      categories.push(categoryName);
      localStorage.setItem('todoAppCategories', JSON.stringify(categories));
      
      renderCategories();
      updateCategoryDropdowns();
      
      showToast('Category Added', `Category "${categoryName}" has been added.`);
    }
    
    // Delete Category
    function deleteCategory(categoryName) {
      // Check if any tasks are using this category
      const tasksWithCategory = tasks.filter(task => task.category === categoryName);
      
      if (tasksWithCategory.length > 0) {
        if (!confirm(`There are ${tasksWithCategory.length} tasks using this category. Deleting it will set those tasks to "Uncategorized". Continue?`)) {
          return;
        }
        
        // Update tasks to use "Uncategorized"
        saveState();
        tasksWithCategory.forEach(task => {
          const index = tasks.findIndex(t => t.id === task.id);
          if (index !== -1) {
            tasks[index].category = 'Uncategorized';
          }
        });
        
        renderTasks();
      }
      
      // Remove category
      const index = categories.indexOf(categoryName);
      if (index !== -1) {
        categories.splice(index, 1);
        localStorage.setItem('todoAppCategories', JSON.stringify(categories));
        
        renderCategories();
        updateCategoryDropdowns();
        
        showToast('Category Deleted', `Category "${categoryName}" has been deleted.`);
      }
    }
    
    // Render Categories
    function renderCategories() {
      categoriesList.innerHTML = '';
      
      categories.forEach(category => {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';
        categoryItem.style.display = 'flex';
        categoryItem.style.justifyContent = 'space-between';
        categoryItem.style.alignItems = 'center';
        categoryItem.style.padding = '0.75rem 0';
        categoryItem.style.borderBottom = '1px solid #eee';
        
        categoryItem.innerHTML = `
          <span>${category}</span>
          <button class="btn-danger" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px;">
            <i class="bi bi-trash"></i>
          </button>
        `;
        
        const deleteBtn = categoryItem.querySelector('button');
        deleteBtn.addEventListener('click', () => deleteCategory(category));
        
        categoriesList.appendChild(categoryItem);
      });
    }
    
    // Update Category Dropdowns
    function updateCategoryDropdowns() {
      const categorySelect = document.getElementById('task-category');
      const editCategorySelect = document.getElementById('edit-task-category');
      const categoryFilterSelect = document.getElementById('categoryFilter');
      
      // Clear existing options
      categorySelect.innerHTML = '';
      editCategorySelect.innerHTML = '';
      
      // Keep only the "All Categories" option
      categoryFilterSelect.innerHTML = '<option value="all">All Categories</option>';
      
      // Add categories to dropdowns
      categories.forEach(category => {
        // Add to new task dropdown
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
        
        // Add to edit task dropdown
        const editOption = document.createElement('option');
        editOption.value = category;
        editOption.textContent = category;
        editCategorySelect.appendChild(editOption);
        
        // Add to filter dropdown
        const filterOption = document.createElement('option');
        filterOption.value = category;
        filterOption.textContent = category;
        categoryFilterSelect.appendChild(filterOption);
      });
    }
    
    // Create Task
    function createTask() {
      const title = document.getElementById('task-title').value.trim();
      const description = document.getElementById('task-description').value.trim();
      const dueDate = document.getElementById('task-due-date').value;
      const priority = document.getElementById('task-priority').value;
      const category = document.getElementById('task-category').value;
      const notes = document.getElementById('task-notes').value.trim();
      
      // Validate
      if (!title || !dueDate) {
        showToast('Error', 'Title and due date are required.');
        return;
      }
      
      // Get subtasks
      const subtasksElements = document.querySelectorAll('.subtask-input');
      const subtasks = Array.from(subtasksElements).map((input, index) => ({
        id: `subtask-${Date.now()}-${index}`,
        title: input.value.trim(),
        completed: false
      })).filter(subtask => subtask.title);
      
      // Save state for undo
      saveState();
      
      // Create task
      const task = {
        id: `task-${Date.now()}`,
        title,
        description,
        dueDate: new Date(dueDate).toISOString(),
        priority,
        category,
        notes,
        subtasks,
        completed: false,
        createdDate: new Date().toISOString(),
        timeSpent: 0
      };
      
      tasks.push(task);
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Close modal
      closeModal(addTaskModal);
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Add notification
      addNotification('New Task Created', `Task "${title}" has been created.`);
      
      // Show toast
      showToast('Task Created', `Task "${title}" has been created.`);
    }
    
    // Edit Task
    function editTask(taskId) {
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      const task = tasks[taskIndex];
      
      // Set form values
      document.getElementById('edit-task-id').value = task.id;
      document.getElementById('edit-task-title').value = task.title;
      document.getElementById('edit-task-description').value = task.description;
      document.getElementById('edit-task-due-date').value = new Date(task.dueDate).toLocaleString('sv-SE').replace(' ', 'T').slice(0, 16);
      document.getElementById('edit-task-priority').value = task.priority;
      document.getElementById('edit-task-category').value = task.category;
      document.getElementById('edit-task-notes').value = task.notes;
      
      // Set subtasks
      renderEditSubtasks(task.subtasks || []);
      
      // Show modal
      openModal(editTaskModal);
    }
    
    // Update Task
    function updateTask() {
      const taskId = document.getElementById('edit-task-id').value;
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      const title = document.getElementById('edit-task-title').value.trim();
      const description = document.getElementById('edit-task-description').value.trim();
      const dueDate = document.getElementById('edit-task-due-date').value;
      const priority = document.getElementById('edit-task-priority').value;
      const category = document.getElementById('edit-task-category').value;
      const notes = document.getElementById('edit-task-notes').value.trim();
      
      // Validate
      if (!title || !dueDate) {
        showToast('Error', 'Title and due date are required.');
        return;
      }
      
      // Get subtasks
      const subtasksElements = document.querySelectorAll('.edit-subtask-row');
      const subtasks = Array.from(subtasksElements).map(row => {
        const input = row.querySelector('.edit-subtask-input');
        const checkbox = row.querySelector('.edit-subtask-checkbox');
        const id = row.dataset.id || `subtask-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
        
        return {
          id,
          title: input.value.trim(),
          completed: checkbox.checked
        };
      }).filter(subtask => subtask.title);
      
      // Save state for undo
      saveState();
      
      // Update task
      tasks[taskIndex] = {
        ...tasks[taskIndex],
        title,
        description,
        dueDate: new Date(dueDate).toISOString(),
        priority,
        category,
        notes,
        subtasks
      };
      
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Close modal
      closeModal(editTaskModal);
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Add notification
      addNotification('Task Updated', `Task "${title}" has been updated.`);
      
      // Show toast
      showToast('Task Updated', `Task "${title}" has been updated.`);
    }
    
    // View Task
    function viewTask(taskId) {
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      const task = tasks[taskIndex];
      
      // Set modal content
      document.getElementById('view-task-title').textContent = task.title;
      document.getElementById('view-task-description').textContent = task.description || 'No description';
      document.getElementById('view-task-due-date').textContent = formatDate(task.dueDate);
      document.getElementById('view-task-priority').textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
      document.getElementById('view-task-category').textContent = task.category;
      document.getElementById('view-task-notes').textContent = task.notes || 'No notes';
      document.getElementById('view-task-created').textContent = new Date(task.createdDate).toLocaleString();
      document.getElementById('view-task-time').textContent = formatTimeSpent(task.timeSpent);
      
      // Set subtasks
      const subtasksList = document.getElementById('view-task-subtasks');
      subtasksList.innerHTML = '';
      
      if (task.subtasks && task.subtasks.length > 0) {
        task.subtasks.forEach(subtask => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span class="${subtask.completed ? 'completed' : ''}" style="${subtask.completed ? 'text-decoration: line-through; color: var(--secondary);' : ''}">${subtask.title}</span>
            ${subtask.completed ? ' (Completed)' : ''}
          `;
          subtasksList.appendChild(li);
        });
      } else {
        subtasksList.innerHTML = '<li>No subtasks</li>';
      }
      
      // Set up edit button
      editFromViewBtn.onclick = () => {
        closeModal(viewTaskModal);
        editTask(taskId);
      };
      
      // Set up share button
      shareTaskBtn.onclick = () => {
        closeModal(viewTaskModal);
        openShareTaskModal(taskId);
      };
      
      // Show modal
      openModal(viewTaskModal);
    }
    
    // Open Share Task Modal
    function openShareTaskModal(taskId) {
      activeTask = taskId;
      openModal(shareTaskModal);
    }
    
    // Share Task
    function shareTask() {
      const taskIndex = tasks.findIndex(task => task.id === activeTask);
      if (taskIndex === -1) return;
      
      const task = tasks[taskIndex];
      const selectedUsers = Array.from(document.getElementById('share-task-users').selectedOptions).map(option => option.value);
      const message = document.getElementById('share-task-message').value.trim();
      
      if (selectedUsers.length === 0) {
        showToast('Error', 'Please select at least one user to share with.');
        return;
      }
      
      // Create notifications for selected users
      selectedUsers.forEach(userId => {
        const user = users.find(u => u.id === userId);
        if (user) {
          addNotification('Task Shared', `"${task.title}" has been shared with you by ${currentUser.firstName} ${currentUser.lastName}.`, user.id);
        }
      });
      
      // Close modal
      closeModal(shareTaskModal);
      
      // Show toast
      showToast('Task Shared', `Task "${task.title}" has been shared with ${selectedUsers.length} user(s).`);
    }
    
    // Delete Task
    function deleteTask(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) {
        return;
      }
      
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      const taskTitle = tasks[taskIndex].title;
      
      // Save state for undo
      saveState();
      
      // Remove task
      tasks.splice(taskIndex, 1);
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Add notification
      addNotification('Task Deleted', `Task "${taskTitle}" has been deleted.`);
      
      // Show toast
      showToast('Task Deleted', `Task "${taskTitle}" has been deleted.`);
    }
    
    // Toggle Task Complete
    function toggleTaskComplete(taskId, completed) {
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      // Save state for undo
      saveState();
      
      // Update task
      tasks[taskIndex].completed = completed;
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Add notification
      if (completed) {
        addNotification('Task Completed', `Task "${tasks[taskIndex].title}" has been marked as completed.`);
        showToast('Task Completed', `Task "${tasks[taskIndex].title}" has been marked as completed.`);
      } else {
        addNotification('Task Reopened', `Task "${tasks[taskIndex].title}" has been marked as active.`);
        showToast('Task Reopened', `Task "${tasks[taskIndex].title}" has been marked as active.`);
      }
    }
    
    // Toggle Subtask Complete
    function toggleSubtaskComplete(taskId, subtaskId, completed) {
      const taskIndex = tasks.findIndex(task => task.id === taskId);
      if (taskIndex === -1) return;
      
      const subtaskIndex = tasks[taskIndex].subtasks.findIndex(subtask => subtask.id === subtaskId);
      if (subtaskIndex === -1) return;
      
      // Save state for undo
      saveState();
      
      // Update subtask
      tasks[taskIndex].subtasks[subtaskIndex].completed = completed;
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Update UI
      const subtaskLabel = document.querySelector(`.subtask-label[data-subtask-id="${subtaskId}"]`);
      if (subtaskLabel) {
        subtaskLabel.classList.toggle('completed', completed);
      }
      
      // No need to re-render all tasks, just toggle the class on the subtask label
      const label = document.querySelector(`.subtask-item [data-subtask-id="${subtaskId}"] + .subtask-label`);
      if (label) {
        label.classList.toggle('completed', completed);
      }
    }
    
    // Bulk Complete Tasks
    function bulkCompleteTasks() {
      const checkboxes = document.querySelectorAll('.task-checkbox:checked');
      const taskIds = Array.from(checkboxes).map(cb => cb.dataset.id);
      
      if (taskIds.length === 0) return;
      
      // Save state for undo
      saveState();
      
      // Update tasks
      taskIds.forEach(taskId => {
        const taskIndex = tasks.findIndex(task => task.id === taskId);
        if (taskIndex !== -1) {
          tasks[taskIndex].completed = true;
        }
      });
      
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Hide bulk actions
      bulkActions.classList.remove('show');
      
      // Add notification
      addNotification('Tasks Completed', `${taskIds.length} tasks have been marked as completed.`);
      
      // Show toast
      showToast('Tasks Completed', `${taskIds.length} tasks have been marked as completed.`);
    }
    
    // Bulk Delete Tasks
    function bulkDeleteTasks() {
      const checkboxes = document.querySelectorAll('.task-checkbox:checked');
      const taskIds = Array.from(checkboxes).map(cb => cb.dataset.id);
      
      if (taskIds.length === 0) return;
      
      if (!confirm(`Are you sure you want to delete ${taskIds.length} tasks?`)) {
        return;
      }
      
      // Save state for undo
      saveState();
      
      // Remove tasks
      taskIds.forEach(taskId => {
        const taskIndex = tasks.findIndex(task => task.id === taskId);
        if (taskIndex !== -1) {
          tasks.splice(taskIndex, 1);
        }
      });
      
      localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
      
      // Render tasks
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      
      // Hide bulk actions
      bulkActions.classList.remove('show');
      
      // Add notification
      addNotification('Tasks Deleted', `${taskIds.length} tasks have been deleted.`);
      
      // Show toast
      showToast('Tasks Deleted', `${taskIds.length} tasks have been deleted.`);
    }
    
    // Update Bulk Actions
    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.task-checkbox:checked');
      const count = checkboxes.length;
      
      selectedCount.textContent = count;
      
      if (count > 0) {
        bulkActions.classList.add('show');
      } else {
        bulkActions.classList.remove('show');
      }
    }
    
    // Export Tasks
    function exportTasks() {
      const format = document.getElementById('export-format').value;
      const filteredTasks = filterTasks();
      
      if (filteredTasks.length === 0) {
        showToast('Error', 'No tasks to export.');
        return;
      }
      
      if (format === 'pdf') {
        exportToPDF(filteredTasks);
      } else if (format === 'excel') {
        exportToExcel(filteredTasks);
      } else if (format === 'json') {
        exportToJSON(filteredTasks);
      }
      
      // Close modal
      closeModal(exportModal);
      
      // Show toast
      showToast('Tasks Exported', `${filteredTasks.length} tasks have been exported.`);
    }
    
    // Export to PDF
    function exportToPDF(taskList) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Title
      doc.setFontSize(18);
      doc.text('Tasks List', 14, 22);
      
      // Date
      doc.setFontSize(11);
      doc.text(`Exported on: ${new Date().toLocaleDateString()}`, 14, 30);
      
      // Tasks
      doc.setFontSize(12);
      let y = 40;
      
      taskList.forEach((task, index) => {
        // Add new page if needed
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        
        // Task title and status
        doc.setFont(undefined, 'bold');
        doc.text(`${index + 1}. ${task.title} ${task.completed ? '(Completed)' : ''}`, 14, y);
        y += 7;
        
        // Task details
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        
        doc.text(`Due: ${formatDate(task.dueDate)}`, 18, y);
        y += 5;
        
        doc.text(`Priority: ${task.priority}`, 18, y);
        y += 5;
        
        doc.text(`Category: ${task.category}`, 18, y);
        y += 5;
        
        if (task.description) {
          doc.text(`Description: ${task.description}`, 18, y);
          y += 5;
        }
        
        // Subtasks
        if (task.subtasks && task.subtasks.length > 0) {
          doc.text(`Subtasks:`, 18, y);
          y += 5;
          
          task.subtasks.forEach(subtask => {
            doc.text(`- ${subtask.title} ${subtask.completed ? '(Completed)' : ''}`, 22, y);
            y += 5;
          });
        }
        
        // Spacing between tasks
        y += 5;
      });
      
      // Save the PDF
      doc.save('tasks.pdf');
    }
    
    // Export to Excel
    function exportToExcel(taskList) {
      const data = [];
      
      // Header row
      data.push(['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Status', 'Created Date', 'Time Spent']);
      
      // Task rows
      taskList.forEach(task => {
        data.push([
          task.title,
          task.description,
          formatDate(task.dueDate),
          task.priority,
          task.category,
          task.completed ? 'Completed' : 'Active',
          new Date(task.createdDate).toLocaleDateString(),
          formatTimeSpent(task.timeSpent)
        ]);
      });
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
      
      // Save the file
      XLSX.writeFile(wb, 'tasks.xlsx');
    }
    
    // Export to JSON
    function exportToJSON(taskList) {
      const json = JSON.stringify(taskList, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tasks.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Import Tasks
    function importTasks() {
      const file = document.getElementById('import-file').files[0];
      const url = document.getElementById('import-url').value.trim();
      
      if (!file && !url) {
        showToast('Error', 'Please select a file or enter a URL.');
        return;
      }
      
      if (file) {
        importFromFile(file);
      } else if (url) {
        importFromURL(url);
      }
    }
    
    // Import from File
    function importFromFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const importedTasks = JSON.parse(e.target.result);
          
          if (!Array.isArray(importedTasks)) {
            showToast('Error', 'Invalid JSON format. Expected an array of tasks.');
            return;
          }
          
          // Save state for undo
          saveState();
          
          // Add imported tasks
          importedTasks.forEach(task => {
            // Check if task already exists
            const exists = tasks.some(t => t.id === task.id);
            if (!exists) {
              tasks.push(task);
            }
          });
          
          localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
          
          // Close modal
          closeModal(importModal);
          
          // Render tasks
          renderTasks();
          updateTaskCounts();
          updateTaskCharts();
          updateInsights();
          
          // Show toast
          showToast('Tasks Imported', `${importedTasks.length} tasks have been imported.`);
        } catch (error) {
          showToast('Error', 'Failed to parse JSON file.');
          console.error(error);
        }
      };
      
      reader.readAsText(file);
    }
    
    // Import from URL
    function importFromURL(url) {
      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(importedTasks => {
          if (!Array.isArray(importedTasks)) {
            showToast('Error', 'Invalid JSON format. Expected an array of tasks.');
            return;
          }
          
          // Save state for undo
          saveState();
          
          // Add imported tasks
          importedTasks.forEach(task => {
            // Check if task already exists
            const exists = tasks.some(t => t.id === task.id);
            if (!exists) {
              tasks.push(task);
            }
          });
          
          localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
          
          // Close modal
          closeModal(importModal);
          
          // Render tasks
          renderTasks();
          updateTaskCounts();
          updateTaskCharts();
          updateInsights();
          
          // Show toast
          showToast('Tasks Imported', `${importedTasks.length} tasks have been imported.`);
        })
        .catch(error => {
          showToast('Error', 'Failed to fetch or parse JSON from URL.');
          console.error(error);
        });
    }
    
    // Show Toast
    function showToast(title, message) {
      const toastContainer = document.getElementById('toastContainer');
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
        <div class="toast-progress"></div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Remove toast after 5 seconds
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }
    
    // Add Notification
    function addNotification(title, message, userId = null) {
      const notification = {
        id: `notification-${Date.now()}`,
        title,
        message,
        timestamp: new Date().toISOString(),
        read: false,
        userId: userId || (currentUser ? currentUser.id : null)
      };
      
      notifications.unshift(notification);
      
      // Keep max 50 notifications
      if (notifications.length > 50) {
        notifications.pop();
      }
      
      localStorage.setItem('todoAppNotifications', JSON.stringify(notifications));
      
      // Update notification badge
      updateNotificationBadge();
    }
    
    // Update Notification Badge
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(notification => !notification.read && (!notification.userId || notification.userId === currentUser.id)).length;
      
      notificationBadge.textContent = unreadCount;
      notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
    }
    
    // Render Notifications
    function renderNotifications() {
      const userNotifications = notifications.filter(notification => !notification.userId || notification.userId === currentUser.id);
      
      notificationItems.innerHTML = '';
      
      if (userNotifications.length === 0) {
        notificationItems.innerHTML = '<div class="notifications-empty">No notifications yet</div>';
        return;
      }
      
      userNotifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationElement.dataset.id = notification.id;
        
        const date = new Date(notification.timestamp);
        const formattedDate = date.toLocaleString();
        
        notificationElement.innerHTML = `
          <div class="notification-content">${notification.title}: ${notification.message}</div>
          <div class="notification-time">${formattedDate}</div>
        `;
        
        notificationElement.addEventListener('click', () => {
          markNotificationAsRead(notification.id);
          notificationElement.classList.remove('unread');
        });
        
        notificationItems.appendChild(notificationElement);
      });
    }
    
    // Mark Notification as Read
    function markNotificationAsRead(notificationId) {
      const index = notifications.findIndex(notification => notification.id === notificationId);
      if (index !== -1) {
        notifications[index].read = true;
        localStorage.setItem('todoAppNotifications', JSON.stringify(notifications));
        updateNotificationBadge();
      }
    }
    
    // Clear All Notifications
    function clearAllNotifications() {
      notifications = notifications.filter(notification => notification.userId && notification.userId !== currentUser.id);
      localStorage.setItem('todoAppNotifications', JSON.stringify(notifications));
      
      renderNotifications();
      updateNotificationBadge();
      
      showToast('Notifications Cleared', 'All notifications have been cleared.');
    }
    
    // Register User
    function registerUser() {
      const lastName = document.getElementById('register-last-name').value.trim();
      const firstName = document.getElementById('register-first-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const confirmEmail = document.getElementById('register-confirm-email').value.trim();
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-confirm-password').value;
      const birthdate = document.getElementById('register-birthdate').value;
      const nationality = document.getElementById('register-nationality').value;
      const role = document.getElementById('register-role').value;
      
      // Validate
      if (!lastName || !firstName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
        showToast('Error', 'All fields are required.');
        return;
      }
      
      if (email !== confirmEmail) {
        showToast('Error', 'Emails do not match.');
        return;
      }
      
      if (password !== confirmPassword) {
        showToast('Error', 'Passwords do not match.');
        return;
      }
      
      // Check if email already exists
      const existingUser = users.find(user => user.email.toLowerCase() === email.toLowerCase());
      if (existingUser) {
        showToast('Error', 'Email already registered.');
        return;
      }
      
      // Create user
      const user = {
        id: `user-${Date.now()}`,
        lastName,
        firstName,
        email,
        password,
        birthdate,
        nationality,
        role,
        profilePicture: 'https://randomuser.me/api/portraits/men/1.jpg',
        joinDate: new Date().toISOString()
      };
      
      users.push(user);
      localStorage.setItem('todoAppUsers', JSON.stringify(users));
      
      // Close modal
      closeModal(registerModal);
      
      // Show toast
      showToast('Account Created', 'Your account has been created successfully. You can now login.');
      
      // Reset form
      document.getElementById('register-last-name').value = '';
      document.getElementById('register-first-name').value = '';
      document.getElementById('register-email').value = '';
      document.getElementById('register-confirm-email').value = '';
      document.getElementById('register-password').value = '';
      document.getElementById('register-confirm-password').value = '';
      document.getElementById('register-birthdate').value = '';
      document.getElementById('register-nationality').value = '';
    }
    
    // Login User
    function loginUser() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      
      // Find user
      let user = users.find(user => user.email.toLowerCase() === email.toLowerCase() && user.password === password);
      
      // If not found, check if it's the default user
      if (!user && email === 'test@example.com' && password === '123456') {
        user = {
          id: 'default-user',
          lastName: 'Doe',
          firstName: 'John',
          email: 'test@example.com',
          role: 'admin',
          profilePicture: 'https://randomuser.me/api/portraits/men/1.jpg',
          joinDate: new Date().toISOString()
        };
      }
      
      if (!user) {
        showToast('Error', 'Invalid email or password.');
        return;
      }
      
      // Set current user
      currentUser = user;
      localStorage.setItem('todoAppCurrentUser', JSON.stringify(currentUser));
      
      // Update profile image
      profileImg.src = currentUser.profilePicture;
      
      // Hide login page, show dashboard
      loginPage.style.display = 'none';
      dashboard.style.display = 'block';
      
      // Add welcome notification
      addNotification('Welcome', `Welcome back, ${currentUser.firstName}!`);
      
      // Update notification badge
      updateNotificationBadge();
      
      // Show toast
      showToast('Login Successful', `Welcome back, ${currentUser.firstName}!`);
      
      // Load data
      loadData();
    }
    
    // Logout User
    function logoutUser() {
      if (!confirm('Are you sure you want to logout?')) {
        return;
      }
      
      // Clear current user
      currentUser = null;
      localStorage.removeItem('todoAppCurrentUser');
      
      // Pause timer if running
      if (timer.isRunning) {
        pauseTimer();
      }
      
      // Hide dashboard, show login page
      dashboard.style.display = 'none';
      loginPage.style.display = 'flex';
      
      // Show toast
      showToast('Logout Successful', 'You have been logged out successfully.');
    }
    
    // Save Profile
    function saveProfile() {
      const firstName = document.getElementById('edit-profile-first-name').value.trim();
      const lastName = document.getElementById('edit-profile-last-name').value.trim();
      const email = document.getElementById('edit-profile-email').value.trim();
      const role = document.getElementById('edit-profile-role').value;
      
      // Validate
      if (!firstName || !lastName || !email) {
        showToast('Error', 'First name, last name, and email are required.');
        return;
      }
      
      // Check if email already exists and it's not the current user's email
      if (email.toLowerCase() !== currentUser.email.toLowerCase()) {
        const existingUser = users.find(user => user.email.toLowerCase() === email.toLowerCase());
        if (existingUser) {
          showToast('Error', 'Email already registered.');
          return;
        }
      }
      
      // Update user
      currentUser.firstName = firstName;
      currentUser.lastName = lastName;
      currentUser.email = email;
      currentUser.role = role;
      
      // Update profile image if changed
      if (window.newProfilePicture) {
        currentUser.profilePicture = window.newProfilePicture;
        profileImg.src = window.newProfilePicture;
        window.newProfilePicture = null;
      }
      
      // Update users array
      const userIndex = users.findIndex(user => user.id === currentUser.id);
      if (userIndex !== -1) {
        users[userIndex] = currentUser;
      }
      
      localStorage.setItem('todoAppUsers', JSON.stringify(users));
      localStorage.setItem('todoAppCurrentUser', JSON.stringify(currentUser));
      
      // Close modal
      closeModal(editProfileModal);
      
      // Show toast
      showToast('Profile Updated', 'Your profile has been updated successfully.');
    }
    
    // Render Users List
    function renderUsersList() {
      usersList.innerHTML = '';
      
      users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = 'user-card';
        userElement.style.backgroundColor = 'var(--bg-light)';
        userElement.style.borderRadius = 'var(--border-radius)';
        userElement.style.boxShadow = 'var(--card-shadow)';
        userElement.style.padding = '1rem';
        userElement.style.transition = 'transform var(--transition-speed), box-shadow var(--transition-speed)';
        
        userElement.innerHTML = `
          <div style="text-align: center; margin-bottom: 1rem;">
            <img src="${user.profilePicture}" alt="${user.firstName}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
          </div>
          <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">${user.firstName} ${user.lastName}</h3>
          <p style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 0.25rem; text-align: center;">${user.email}</p>
          <p style="font-size: 0.9rem; margin-bottom: 0.25rem; text-align: center;">Role: ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
          <p style="font-size: 0.9rem; margin-bottom: 0.25rem; text-align: center;">Joined: ${new Date(user.joinDate).toLocaleDateString()}</p>
        `;
        
        userElement.addEventListener('mouseenter', () => {
          userElement.style.transform = 'translateY(-5px)';
          userElement.style.boxShadow = 'var(--hover-shadow)';
        });
        
        userElement.addEventListener('mouseleave', () => {
          userElement.style.transform = 'translateY(0)';
          userElement.style.boxShadow = 'var(--card-shadow)';
        });
        
        usersList.appendChild(userElement);
      });
    }
    
    // Populate Share Task Users
    function populateShareTaskUsers() {
      const shareTaskUsers = document.getElementById('share-task-users');
      shareTaskUsers.innerHTML = '';
      
      users.forEach(user => {
        if (user.id !== currentUser?.id) {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
          shareTaskUsers.appendChild(option);
        }
      });
    }
    
    // Add Subtask Input
    function addSubtaskInput() {
      const subtaskRow = document.createElement('div');
      subtaskRow.className = 'subtask-row';
      subtaskRow.style.display = 'flex';
      subtaskRow.style.gap = '0.5rem';
      subtaskRow.style.marginBottom = '0.5rem';
      
      subtaskRow.innerHTML = `
        <input type="text" class="form-control subtask-input" placeholder="Subtask">
        <button type="button" class="btn btn-danger remove-subtask-btn" style="padding: 0.5rem; line-height: 1;">
          <i class="bi bi-trash"></i>
        </button>
      `;
      
      const removeBtn = subtaskRow.querySelector('.remove-subtask-btn');
      removeBtn.addEventListener('click', () => {
        subtaskRow.remove();
      });
      
      subtasksContainer.appendChild(subtaskRow);
    }
    
    // Render Edit Subtasks
    function renderEditSubtasks(subtasks) {
      editSubtasksContainer.innerHTML = '';
      
      subtasks.forEach(subtask => {
        const subtaskRow = document.createElement('div');
        subtaskRow.className = 'edit-subtask-row';
        subtaskRow.dataset.id = subtask.id;
        subtaskRow.style.display = 'flex';
        subtaskRow.style.gap = '0.5rem';
        subtaskRow.style.marginBottom = '0.5rem';
        
        subtaskRow.innerHTML = `
          <input type="checkbox" class="edit-subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
          <input type="text" class="form-control edit-subtask-input" placeholder="Subtask" value="${subtask.title}">
          <button type="button" class="btn btn-danger remove-edit-subtask-btn" style="padding: 0.5rem; line-height: 1;">
            <i class="bi bi-trash"></i>
          </button>
        `;
        
        const removeBtn = subtaskRow.querySelector('.remove-edit-subtask-btn');
        removeBtn.addEventListener('click', () => {
          subtaskRow.remove();
        });
        
        editSubtasksContainer.appendChild(subtaskRow);
      });
    }
    
    // Add Edit Subtask Input
    function addEditSubtaskInput() {
      const subtaskRow = document.createElement('div');
      subtaskRow.className = 'edit-subtask-row';
      subtaskRow.style.display = 'flex';
      subtaskRow.style.gap = '0.5rem';
      subtaskRow.style.marginBottom = '0.5rem';
      
      subtaskRow.innerHTML = `
        <input type="checkbox" class="edit-subtask-checkbox">
        <input type="text" class="form-control edit-subtask-input" placeholder="Subtask">
        <button type="button" class="btn btn-danger remove-edit-subtask-btn" style="padding: 0.5rem; line-height: 1;">
          <i class="bi bi-trash"></i>
        </button>
      `;
      
      const removeBtn = subtaskRow.querySelector('.remove-edit-subtask-btn');
      removeBtn.addEventListener('click', () => {
        subtaskRow.remove();
      });
      
      editSubtasksContainer.appendChild(subtaskRow);
    }
    
    // Open Modal
    function openModal(modal) {
      modal.classList.add('show');
      modal.querySelector('.modal').classList.add('show');
    }
    
    // Close Modal
    function closeModal(modal) {
      modal.classList.remove('show');
      modal.querySelector('.modal').classList.remove('show');
    }
    
    // Update User Status
    function updateUserStatus(status) {
      const statuses = {
        online: {
          text: '● Online',
          color: 'var(--status-online)'
        },
        break: {
          text: '● Break',
          color: 'var(--status-break)'
        },
        shadow: {
          text: '● Shadow',
          color: 'var(--status-shadow)'
        },
        logout: {
          text: '● Offline',
          color: 'var(--status-logout)'
        }
      };
      
      statusBtn.innerHTML = `<span>${statuses[status].text}</span>`;
      profileImg.style.borderColor = statuses[status].color;
      
      if (status === 'logout') {
        logoutUser();
      }
    }
    
    // Load Data from localStorage
    function loadData() {
      // Load categories
      const savedCategories = localStorage.getItem('todoAppCategories');
      if (savedCategories) {
        categories = JSON.parse(savedCategories);
      }
      
      // Load tasks
      const savedTasks = localStorage.getItem('todoAppTasks');
      if (savedTasks) {
        tasks = JSON.parse(savedTasks);
      } else {
        // Initialize with random tasks if none exist
        initializeRandomTasks();
      }
      
      // Load users
      const savedUsers = localStorage.getItem('todoAppUsers');
      if (savedUsers) {
        users = JSON.parse(savedUsers);
      } else {
        // Initialize with random users if none exist
        initializeRandomUsers();
      }
      
      // Load notifications
      const savedNotifications = localStorage.getItem('todoAppNotifications');
      if (savedNotifications) {
        notifications = JSON.parse(savedNotifications);
      }
      
      // Render data
      renderCategories();
      updateCategoryDropdowns();
      renderTasks();
      updateTaskCounts();
      updateTaskCharts();
      updateInsights();
      renderNotifications();
      updateNotificationBadge();
      populateShareTaskUsers();
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      initializeDatePickers();
      fetchCountries();
      
      // Register modal
      registerLink.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(registerModal);
      });
      
      closeRegisterModal.addEventListener('click', () => {
        closeModal(registerModal);
      });
      
      cancelRegisterBtn.addEventListener('click', () => {
        closeModal(registerModal);
      });
      
      createAccountBtn.addEventListener('click', registerUser);
      
      // Login
      loginBtn.addEventListener('click', loginUser);
      
      // Logout
      logoutBtn.addEventListener('click', logoutUser);
      
      // Profile
      profileBtn.addEventListener('click', () => {
        profileDropdown.classList.toggle('show');
      });
      
      viewProfileBtn.addEventListener('click', () => {
        profileDropdown.classList.remove('show');
        
        // Set profile info
        document.getElementById('profileName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('profileEmail').textContent = currentUser.email;
        document.getElementById('profileRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
        document.getElementById('profileJoined').textContent = new Date(currentUser.joinDate).toLocaleDateString();
        document.getElementById('profileModalImg').src = currentUser.profilePicture;
        
        openModal(viewProfileModal);
      });
      
      closeViewProfileModal.addEventListener('click', () => {
        closeModal(viewProfileModal);
      });
      
      closeProfileBtn.addEventListener('click', () => {
        closeModal(viewProfileModal);
      });
      
      editProfileBtn.addEventListener('click', () => {
        closeModal(viewProfileModal);
        
        // Set form values
        document.getElementById('edit-profile-first-name').value = currentUser.firstName;
        document.getElementById('edit-profile-last-name').value = currentUser.lastName;
        document.getElementById('edit-profile-email').value = currentUser.email;
        document.getElementById('edit-profile-role').value = currentUser.role;
        document.getElementById('editProfileImg').src = currentUser.profilePicture;
        
        openModal(editProfileModal);
      });
      
      closeEditProfileModal.addEventListener('click', () => {
        closeModal(editProfileModal);
      });
      
      cancelEditProfileBtn.addEventListener('click', () => {
        closeModal(editProfileModal);
      });
      
      saveProfileBtn.addEventListener('click', saveProfile);
      
      changePictureBtn.addEventListener('click', () => {
        profilePicture.click();
      });
      
      profilePicture.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('editProfileImg').src = e.target.result;
            window.newProfilePicture = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Theme toggle
      themeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        
        const isDark = document.documentElement.classList.contains('dark');
        themeToggle.innerHTML = isDark ? '<i class="bi bi-moon"></i>' : '<i class="bi bi-sun"></i>';
        
        // Update charts for new theme
        updateTaskCharts();
      });
      
      // Notification dropdown
      notificationBtn.addEventListener('click', () => {
        notificationDropdown.classList.toggle('show');
        renderNotifications();
      });
      
      clearNotifications.addEventListener('click', clearAllNotifications);
      
      // User status
      statusBtn.addEventListener('click', () => {
        statusDropdown.classList.toggle('show');
      });
      
      document.querySelectorAll('.status-item').forEach(item => {
        item.addEventListener('click', () => {
          const status = item.dataset.status;
          updateUserStatus(status);
          statusDropdown.classList.remove('show');
        });
      });
      
      // Add task
      addTaskBtn.addEventListener('click', () => {
        // Reset form
        document.getElementById('task-title').value = '';
        document.getElementById('task-description').value = '';
        document.getElementById('task-due-date').value = '';
        document.getElementById('task-priority').value = 'medium';
        document.getElementById('task-category').value = categories[0];
        document.getElementById('task-notes').value = '';
        subtasksContainer.innerHTML = '';
        
        openModal(addTaskModal);
      });
      
      closeAddTaskModal.addEventListener('click', () => {
        closeModal(addTaskModal);
      });
      
      cancelAddTaskBtn.addEventListener('click', () => {
        closeModal(addTaskModal);
      });
      
      saveTaskBtn.addEventListener('click', createTask);
      
      // Edit task
      closeEditTaskModal.addEventListener('click', () => {
        closeModal(editTaskModal);
      });
      
      cancelEditTaskBtn.addEventListener('click', () => {
        closeModal(editTaskModal);
      });
      
      updateTaskBtn.addEventListener('click', updateTask);
      
      // View task
      closeViewTaskModal.addEventListener('click', () => {
        closeModal(viewTaskModal);
      });
      
      closeViewTaskBtn.addEventListener('click', () => {
        closeModal(viewTaskModal);
      });
      
      // Share task
      closeShareTaskModal.addEventListener('click', () => {
        closeModal(shareTaskModal);
      });
      
      cancelShareBtn.addEventListener('click', () => {
        closeModal(shareTaskModal);
      });
      
      confirmShareBtn.addEventListener('click', shareTask);
      
      // Export
      exportBtn.addEventListener('click', () => {
        openModal(exportModal);
      });
      
      closeExportModal.addEventListener('click', () => {
        closeModal(exportModal);
      });
      
      cancelExportBtn.addEventListener('click', () => {
        closeModal(exportModal);
      });
      
      confirmExportBtn.addEventListener('click', exportTasks);
      
      // Import
      importBtn.addEventListener('click', () => {
        openModal(importModal);
      });
      
      closeImportModal.addEventListener('click', () => {
        closeModal(importModal);
      });
      
      cancelImportBtn.addEventListener('click', () => {
        closeModal(importModal);
      });
      
      confirmImportBtn.addEventListener('click', importTasks);
      
      // Categories
      categoriesBtn.addEventListener('click', () => {
        renderCategories();
        openModal(categoriesModal);
      });
      
      closeCategoriesModal.addEventListener('click', () => {
        closeModal(categoriesModal);
      });
      
      closeCategoriesBtn.addEventListener('click', () => {
        closeModal(categoriesModal);
      });
      
      addCategoryBtn.addEventListener('click', () => {
        const newCategory = document.getElementById('new-category').value.trim();
        if (newCategory) {
          createCategory(newCategory);
          document.getElementById('new-category').value = '';
        }
      });
      
      // Users
      usersBtn.addEventListener('click', () => {
        renderUsersList();
        openModal(usersModal);
      });
      
      closeUsersModal.addEventListener('click', () => {
        closeModal(usersModal);
      });
      
      closeUsersBtn.addEventListener('click', () => {
        closeModal(usersModal);
      });
      
      // Bulk actions
      bulkCompleteBtn.addEventListener('click', bulkCompleteTasks);
      bulkDeleteBtn.addEventListener('click', bulkDeleteTasks);
      bulkCancelBtn.addEventListener('click', () => {
        document.querySelectorAll('.task-checkbox').forEach(cb => {
          cb.checked = false;
        });
        bulkActions.classList.remove('show');
      });
      
      // View switcher
      listViewBtn.addEventListener('click', () => {
        listViewBtn.classList.add('active');
        graphViewBtn.classList.remove('active');
        taskListView.style.display = 'block';
        taskGraphView.style.display = 'none';
      });
      
      graphViewBtn.addEventListener('click', () => {
        graphViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        taskListView.style.display = 'none';
        taskGraphView.style.display = 'block';
        
        // Update charts in case data changed
        updateTaskCharts();
      });
      
      // History actions
      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);
      
      // Date filter
      dateFilter.addEventListener('change', () => {
        if (dateFilter.value === 'custom') {
          openModal(dateRangeModal);
        } else {
          renderTasks();
        }
      });
      
      closeDateRangeModal.addEventListener('click', () => {
        closeModal(dateRangeModal);
        dateFilter.value = 'all';
        renderTasks();
      });
      
      cancelDateRangeBtn.addEventListener('click', () => {
        closeModal(dateRangeModal);
        dateFilter.value = 'all';
        renderTasks();
      });
      
      applyDateRangeBtn.addEventListener('click', () => {
        const startDate = new Date(document.getElementById('start-date').value);
        const endDate = new Date(document.getElementById('end-date').value);
        
        if (!startDate || !endDate) {
          showToast('Error', 'Please select both start and end dates.');
          return;
        }
        
        // Set end date to end of day
        endDate.setHours(23, 59, 59, 999);
        
        window.customDateRange = {
          start: startDate,
          end: endDate
        };
        
        closeModal(dateRangeModal);
        renderTasks();
      });
      
      // Timer controls
      playTimer.addEventListener('click', startTimer);
      pauseTimer.addEventListener('click', pauseTimer);
      
      // Subtasks
      addSubtaskBtn.addEventListener('click', addSubtaskInput);
      editAddSubtaskBtn.addEventListener('click', addEditSubtaskInput);
      
      // Filters and search
      statusFilter.addEventListener('change', renderTasks);
      categoryFilter.addEventListener('change', renderTasks);
      priorityFilter.addEventListener('change', renderTasks);
      sortFilter.addEventListener('change', renderTasks);
      
      // Debounce search
      let searchTimeout = null;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(renderTasks, 300);
      });
      
      // Logo click
      logo.addEventListener('click', () => {
        listViewBtn.click();
        statusFilter.value = 'all';
        categoryFilter.value = 'all';
        priorityFilter.value = 'all';
        dateFilter.value = 'all';
        searchInput.value = '';
        renderTasks();
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
          notificationDropdown.classList.remove('show');
        }
        
        if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
          profileDropdown.classList.remove('show');
        }
        
        if (!statusBtn.contains(e.target) && !statusDropdown.contains(e.target)) {
          statusDropdown.classList.remove('show');
        }
      });
      
      // Check for current user
      const savedUser = localStorage.getItem('todoAppCurrentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        profileImg.src = currentUser.profilePicture;
        
        // Hide login page, show dashboard
        loginPage.style.display = 'none';
        dashboard.style.display = 'block';
        
        // Load data
        loadData();
      }
      
      // Initialize history buttons
      updateHistoryButtons();
    });
  </script>
</body>
</html>
