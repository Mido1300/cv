<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do APP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #000;
            --task-bg: #f0f0f0;
            --border-radius: 5px;
        }
        .dark-mode {
            --bg-color: #333;
            --text-color: #fff;
            --task-bg: #444;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: all 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        #auth, #app {
            display: none;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
            margin: 20px auto;
        }
        input, select, textarea, button {
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
        }
        button {
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #0056b3;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--task-bg);
            border-radius: var(--border-radius);
        }
        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .profile {
            position: relative;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        .status-frame {
            position: absolute;
            top: -2px;
            left: -2px;
            width: 44px;
            height: 44px;
            border: 2px solid green;
            border-radius: 50%;
            pointer-events: none;
        }
        .dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--task-bg);
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
        }
        .profile:hover .dropdown {
            display diedaisplay: block;
        }
        .dropdown ul {
            list-style: none;
            padding: 10px;
            margin: 0;
        }
        .dropdown li {
            padding: 5px;
            cursor: pointer;
        }
        .dropdown li:hover {
            background-color: #ddd;
        }
        .notifications {
            position: relative;
            cursor: pointer;
        }
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 12px;
        }
        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--task-bg);
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 300px;
        }
        .task-counts {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .task-counts div {
            flex: 1;
            padding: 10px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        .total-tasks { background-color: #cce5ff; }
        .completed-tasks { background-color: #d4edda; }
        .pending-tasks { background-color: #fff3cd; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tasks-section {
            background-color: var(--task-bg);
            padding: 20px;
            border-radius: var(--border-radius);
        }
        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .view-switcher button.active {
            background-color: #007bff;
            color: white;
        }
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .task-item {
            background-color: var(--bg-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .task-item.completed {
            background-color: #d4edda;
        }
        .priority.high { color: red; }
        .priority.medium { color: yellow; }
        .priority.low { color: grey; }
        .due-expired { border-left: 5px solid red; }
        .due-soon { border-left: 5px solid yellow; }
        .due-far { border-left: 5px solid green; }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color);
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
        }
        @media (max-width: 768px) {
            .task-counts, .controls, .filters {
                flex-direction: column;
            }
            .user-section {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth">
            <div id="login-form">
                <h2>Login</h2>
                <form id="login">
                    <input type="email" placeholder="Email" required>
                    <input type="password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <p>Don't have an account? <a href="#" id="show-register">Register</a></p>
            </div>
            <div id="register-form" style="display: none;">
                <h2>Register</h2>
                <form id="register">
                    <input type="text" placeholder="Name" required>
                    <input type="email" placeholder="Email" required>
                    <input type="email" placeholder="Confirm Email" required>
                    <input type="password" placeholder="Password" required>
                    <input type="password" placeholder="Confirm Password" required>
                    <input type="tel" placeholder="Phone Number" required>
                    <select id="country" required>
                        <option value="">Select Country</option>
                        <option value="US">United States</option>
                        <option value="UK">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <!-- Add more countries as needed -->
                    </select>
                    <select required>
                        <option value="">Select Role</option>
                        <option value="Manager">Manager</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                    </select>
                    <button type="submit">Register</button>
                </form>
                <p>Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </div>
        <div id="app">
            <header>
                <div class="logo">To-Do APP</div>
                <div class="user-section">
                    <div class="time-counter">0h 0m 0s</div>
                    <div class="mode-switcher">
                        <label>
                            <input type="checkbox" id="dark-mode-toggle"> Dark Mode
                        </label>
                    </div>
                    <div class="notifications">
                        <span class="notification-icon">ðŸ””</span>
                        <span class="notification-count">0</span>
                        <div class="notification-dropdown">
                            <ul></ul>
                        </div>
                    </div>
                    <div class="profile">
                        <img src="https://via.placeholder.com/50" alt="Profile" class="profile-pic">
                        <div class="status-frame"></div>
                        <div class="dropdown">
                            <ul>
                                <li>Status
                                    <ul>
                                        <li data-status="login">Login</li>
                                        <li data-status="shadow">Shadow</li>
                                        <li data-status="break">Break</li>
                                        <li data-status="logout">Logout</li>
                                    </ul>
                                </li>
                                <li id="view-profile">View Profile</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>
            <div class="task-counts">
                <div class="total-tasks">Total Tasks: <span>0</span></div>
                <div class="completed-tasks">Completed: <span>0</span></div>
                <div class="pending-tasks">Pending: <span>0</span></div>
            </div>
            <div class="controls">
                <button class="import">Import</button>
                <button class="export">Export</button>
                <button class="users">Users</button>
                <button class="add-task">+ Add Task</button>
            </div>
            <div class="tasks-section">
                <h2>Tasks</h2>
                <div class="view-switcher">
                    <button class="list-view active">List View</button>
                    <button class="graph-view">Graph View</button>
                </div>
                <div class="filters">
                    <input type="text" placeholder="Search" id="search-input">
                    <select id="priority-filter">
                        <option value="">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="status-filter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="due-date-filter">
                        <option value="">All Due Dates</option>
                        <option value="today">Today</option>
                        <option value="week">In a week</option>
                        <option value="month">In a month</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="custom-date-range" style="display: none;">
                        <input type="date" id="start-date">
                        <input type="date" id="end-date">
                    </div>
                </div>
                <div class="bulk-actions">
                    <button id="delete-selected">Delete Selected</button>
                    <button id="complete-selected">Mark as Completed</button>
                </div>
                <div class="task-list"></div>
                <div class="graph-view" style="display: none;">
                    <canvas id="task-chart"></canvas>
                </div>
            </div>
            <div class="insights">
                <h2>Insights</h2>
                <p>Average completion time: <span id="avg-time">N/A</span></p>
            </div>
        </div>
        <div id="profile-popup" class="popup">
            <h2>Profile</h2>
            <img src="" alt="Profile" class="popup-profile-pic" style="width: 100px; height: 100px; border-radius: 50%;">
            <input type="file" accept="image/*">
            <p>Name: <span id="profile-name"></span></p>
            <p>Email: <span id="profile-email"></span></p>
            <p>Phone: <span id="profile-phone"></span></p>
            <p>Password: <span id="profile-password"></span></p>
            <p>Role: <span id="profile-role"></span></p>
            <button id="edit-profile">Edit</button>
            <button id="save-profile" style="display: none;">Save</button>
            <button id="cancel-profile">Cancel</button>
        </div>
        <div id="add-task-popup" class="popup">
            <h2>Add Task</h2>
            <form id="add-task-form">
                <input type="text" placeholder="Title" required>
                <textarea placeholder="Description" required></textarea>
                <select id="task-priority" required>
                    <option value="">Select Priority</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <input type="date" required>
                <select id="assign-to">
                    <option value="">Assign To</option>
                </select>
                <textarea placeholder="Notes"></textarea>
                <button type="submit">Save</button>
                <button type="button" id="cancel-add-task">Cancel</button>
            </form>
        </div>
        <div id="users-popup" class="popup">
            <h2>Users</h2>
            <ul></ul>
            <button id="close-users">Close</button>
        </div>
    </div>
    <script>
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let currentStatus = localStorage.getItem('currentStatus') || 'login';
        let statusStartTime = parseInt(localStorage.getItem('statusStartTime')) || Date.now();
        let statusPeriods = JSON.parse(localStorage.getItem('statusPeriods')) || [];
        let lastStatusDate = localStorage.getItem('lastStatusDate') || new Date().toUTCString().slice(0, 16);

        // Authentication
        document.getElementById('login').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target[0].value;
            const password = e.target[1].value;
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                showApp();
            } else {
                alert('Invalid credentials');
            }
        });

        document.getElementById('register').addEventListener('submit', (e) => {
            e.preventDefault();
            const [name, email, confirmEmail, password, confirmPassword, phone, country, role] = e.target;
            if (email.value !== confirmEmail.value || password.value !== confirmPassword.value) {
                alert('Email or password do not match');
                return;
            }
            if (users.some(u => u.email === email.value)) {
                alert('Email already exists');
                return;
            }
            const user = { name: name.value, email: email.value, password: password.value, phone: phone.value, country: country.value, role: role.value, profilePic: 'https://via.placeholder.com/50' };
            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            showLogin();
        });

        document.getElementById('show-register').addEventListener('click', () => {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        });

        document.getElementById('show-login').addEventListener('click', () => {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        });

        function showApp() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadApp();
        }

        function showLogin() {
            document.getElementById('auth').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }

        if (localStorage.getItem('currentUser')) showApp(); else showLogin();

        // App Initialization
        function loadApp() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.querySelector('.profile-pic').src = user.profilePic;
            checkAndResetStatusPeriods();
            updateFrameColor();
            updateTimeCounter();
            updateNotificationCount();
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').checked = true;
            }
            renderTasks();
            updateTaskCounts();
            populateAssignTo();
            if (!notifications.length) {
                notifications = [
                    { message: 'Welcome to To-Do APP!', read: false },
                    { message: 'New task assigned!', read: false }
                ];
                localStorage.setItem('notifications', JSON.stringify(notifications));
            }
            if (!tasks.length) {
                tasks = Array.from({ length: 10 }, (_, i) => ({
                    id: Date.now() + i,
                    title: `Task ${i + 1}`,
                    description: `Description for task ${i + 1}`,
                    priority: ['High', 'Medium', 'Low'][Math.floor(Math.random() * 3)],
                    dueDate: new Date(Date.now() + Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: Math.random() > 0.5 ? 'completed' : 'pending',
                    timeSpent: 0
                }));
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }
        }

        // Status and Timer
        function checkAndResetStatusPeriods() {
            const today = new Date().toUTCString().slice(0, 16);
            if (today !== lastStatusDate) {
                statusPeriods = [];
                localStorage.setItem('statusPeriods', JSON.stringify(statusPeriods));
                localStorage.setItem('lastStatusDate', today);
                statusStartTime = Date.now();
                localStorage.setItem('statusStartTime', statusStartTime);
            }
        }

        function changeStatus(newStatus) {
            const now = Date.now();
            if (currentStatus) {
                statusPeriods.push({ status: currentStatus, startTime: statusStartTime, endTime: now });
            }
            currentStatus = newStatus;
            statusStartTime = now;
            localStorage.setItem('currentStatus', currentStatus);
            localStorage.setItem('statusStartTime', statusStartTime);
            localStorage.setItem('statusPeriods', JSON.stringify(statusPeriods));
            updateFrameColor();
            updateTimeCounter();
        }

        function getCumulativeTime(status) {
            const now = Date.now();
            let total = 0;
            statusPeriods.forEach(period => {
                if (period.status === status) total += period.endTime - period.startTime;
            });
            if (currentStatus === status) total += now - statusStartTime;
            return total;
        }

        function updateTimeCounter() {
            const time = getCumulativeTime(currentStatus);
            const seconds = Math.floor((time / 1000) % 60);
            const minutes = Math.floor((time / (1000 * 60)) % 60);
            const hours = Math.floor((time / (1000 * 60 * 60)) % 24);
            document.querySelector('.time-counter').textContent = `${hours}h ${minutes}m ${seconds}s`;
        }

        function updateFrameColor() {
            const frame = document.querySelector('.status-frame');
            frame.style.borderColor = { login: 'green', shadow: 'grey', break: 'yellow', logout: 'red' }[currentStatus];
        }

        document.querySelectorAll('.dropdown ul ul li').forEach(li => {
            li.addEventListener('click', () => {
                const newStatus = li.getAttribute('data-status');
                if (newStatus === 'logout') {
                    localStorage.removeItem('currentUser');
                    showLogin();
                } else {
                    changeStatus(newStatus);
                }
            });
        });

        setInterval(updateTimeCounter, 1000);

        // Profile
        document.getElementById('view-profile').addEventListener('click', () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.querySelector('.popup-profile-pic').src = user.profilePic;
            document.getElementById('profile-name').textContent = user.name;
            document.getElementById('profile-email').textContent = user.email;
            document.getElementById('profile-phone').textContent = user.phone;
            document.getElementById('profile-password').textContent = '********';
            document.getElementById('profile-role').textContent = user.role;
            document.getElementById('profile-popup').style.display = 'block';
            document.getElementById('save-profile').style.display = 'none';
        });

        document.querySelector('#profile-popup input[type="file"]').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.querySelector('.popup-profile-pic').src = event.target.result;
                    document.querySelector('.profile-pic').src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('edit-profile').addEventListener('click', () => {
            const fields = ['name', 'email', 'phone', 'password', 'role'];
            fields.forEach(field => {
                const span = document.getElementById(`profile-${field}`);
                const value = field === 'password' ? '' : span.textContent.replace('********', '');
                span.innerHTML = field === 'password' ? `<input type="password" placeholder="New Password">` : `<input type="text" value="${value}">`;
            });
            document.getElementById('edit-profile').style.display = 'none';
            document.getElementById('save-profile').style.display = 'inline';
        });

        document.getElementById('save-profile').addEventListener('click', () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            user.name = document.querySelector('#profile-name input').value;
            user.email = document.querySelector('#profile-email input').value;
            user.phone = document.querySelector('#profile-phone input').value;
            const newPassword = document.querySelector('#profile-password input').value;
            if (newPassword) user.password = newPassword;
            user.role = document.querySelector('#profile-role input').value;
            user.profilePic = document.querySelector('.popup-profile-pic').src;
            localStorage.setItem('currentUser', JSON.stringify(user));
            const userIndex = users.findIndex(u => u.email === user.email);
            if (userIndex !== -1) users[userIndex] = user;
            localStorage.setItem('users', JSON.stringify(users));
            document.getElementById('profile-popup').style.display = 'none';
        });

        document.getElementById('cancel-profile').addEventListener('click', () => {
            document.getElementById('profile-popup').style.display = 'none';
        });

        // Notifications
        function updateNotificationCount() {
            const unread = notifications.filter(n => !n.read).length;
            document.querySelector('.notification-count').textContent = unread;
        }

        document.querySelector('.notification-icon').addEventListener('click', () => {
            const dropdown = document.querySelector('.notification-dropdown ul');
            dropdown.innerHTML = '';
            notifications.forEach((notif, index) => {
                const li = document.createElement('li');
                li.textContent = notif.message;
                if (!notif.read) {
                    li.style.fontWeight = 'bold';
                    li.addEventListener('click', () => {
                        notifications[index].read = true;
                        localStorage.setItem('notifications', JSON.stringify(notifications));
                        updateNotificationCount();
                        li.style.fontWeight = 'normal';
                    });
                }
                dropdown.appendChild(li);
            });
            document.querySelector('.notification-dropdown').style.display = 'block';
        });

        // Dark Mode
        document.getElementById('dark-mode-toggle').addEventListener('change', function() {
            localStorage.setItem('darkMode', this.checked);
            document.body.classList.toggle('dark-mode', this.checked);
        });

        // Tasks
        function filterTasks() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const priority = document.getElementById('priority-filter').value;
            const status = document.getElementById('status-filter').value;
            const dueDateFilter = document.getElementById('due-date-filter').value;
            let startDate = document.getElementById('start-date').value;
            let endDate = document.getElementById('end-date').value;

            return tasks.filter(task => {
                if (search && !task.title.toLowerCase().includes(search)) return false;
                if (priority && task.priority !== priority) return false;
                if (status && task.status !== status) return false;
                if (dueDateFilter) {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    if (dueDateFilter === 'today' && dueDate.toDateString() !== today.toDateString()) return false;
                    if (dueDateFilter === 'week') {
                        const weekLater = new Date(today);
                        weekLater.setDate(weekLater.getDate() + 7);
                        if (dueDate < today || dueDate > weekLater) return false;
                    }
                    if (dueDateFilter === 'month') {
                        const monthLater = new Date(today);
                        monthLater.setMonth(monthLater.getMonth() + 1);
                        if (dueDate < today || dueDate > monthLater) return false;
                    }
                    if (dueDateFilter === 'custom' && startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        if (dueDate < start || dueDate > end) return false;
                    }
                }
                return true;
            });
        }

        function renderTasks() {
            const filteredTasks = filterTasks();
            const taskList = document.querySelector('.task-list');
            taskList.innerHTML = '';
            filteredTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.status === 'completed' ? 'completed' : ''}`;
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                if (dueDate < now) taskItem.classList.add('due-expired');
                else if (dueDate - now < 48 * 3600 * 1000) taskItem.classList.add('due-soon');
                else taskItem.classList.add('due-far');
                taskItem.innerHTML = `
                    <input type="checkbox" class="select-task" data-id="${task.id}">
                    <h3>${task.title}</h3>
                    <p>${task.description}</p>
                    <span class="priority ${task.priority.toLowerCase()}">${task.priority}</span>
                    <span class="due-date">${task.dueDate}</span>
                    <span class="time-spent">${formatTime(task.timeSpent || 0)}</span>
                    <button class="timer-btn" data-id="${task.id}">${task.timerActive ? 'Stop' : 'Start'} Timer</button>
                    <button class="share-btn" data-id="${task.id}">Share</button>
                    <label><input type="checkbox" class="complete-task" data-id="${task.id}" ${task.status === 'completed' ? 'checked' : ''}> Completed</label>
                `;
                taskList.appendChild(taskItem);
            });
            document.querySelectorAll('.timer-btn').forEach(btn => btn.addEventListener('click', handleTimer));
            document.querySelectorAll('.complete-task').forEach(cb => cb.addEventListener('change', handleComplete));
            document.querySelectorAll('.share-btn').forEach(btn => btn.addEventListener('click', () => alert('Share functionality not implemented')));
            new Sortable(taskList, {
                animation: 150,
                onEnd: (evt) => {
                    const movedTask = filteredTasks.splice(evt.oldIndex, 1)[0];
                    filteredTasks.splice(evt.newIndex, 0, movedTask);
                    tasks = [...tasks.filter(t => !filteredTasks.some(ft => ft.id === t.id)), ...filteredTasks];
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                }
            });
        }

        function formatTime(ms) {
            const seconds = Math.floor((ms / 1000) % 60);
            const minutes = Math.floor((ms / (1000 * 60)) % 60);
            const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function handleTimer(e) {
            const id = e.target.dataset.id;
            const task = tasks.find(t => t.id == id);
            if (task.timerActive) {
                const elapsed = Date.now() - task.timerStartTime;
                task.timeSpent = (task.timeSpent || 0) + elapsed;
                task.timerActive = false;
                delete task.timerStartTime;
            } else {
                tasks.forEach(t => {
                    if (t.timerActive) {
                        const elapsed = Date.now() - t.timerStartTime;
                        t.timeSpent = (t.timeSpent || 0) + elapsed;
                        t.timerActive = false;
                        delete t.timerStartTime;
                    }
                });
                task.timerActive = true;
                task.timerStartTime = Date.now();
            }
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
        }

        function handleComplete(e) {
            const id = e.target.dataset.id;
            const task = tasks.find(t => t.id == id);
            task.status = e.target.checked ? 'completed' : 'pending';
            task.completedAt = e.target.checked ? Date.now() : null;
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
            updateTaskCounts();
        }

        setInterval(() => {
            if (tasks.some(t => t.timerActive)) renderTasks();
        }, 1000);

        function updateTaskCounts() {
            document.querySelector('.total-tasks span').textContent = tasks.length;
            document.querySelector('.completed-tasks span').textContent = tasks.filter(t => t.status === 'completed').length;
            document.querySelector('.pending-tasks span').textContent = tasks.filter(t => t.status === 'pending').length;
        }

        // View Switcher
        let chart;
        document.querySelector('.list-view').addEventListener('click', () => {
            document.querySelector('.task-list').style.display = 'block';
            document.querySelector('.graph-view').style.display = 'none';
            document.querySelector('.list-view').classList.add('active');
            document.querySelector('.graph-view').classList.remove('active');
            if (chart) chart.destroy();
        });

        document.querySelector('.graph-view').addEventListener('click', () => {
            document.querySelector('.task-list').style.display = 'none';
            document.querySelector('.graph-view').style.display = 'block';
            document.querySelector('.graph-view').classList.add('active');
            document.querySelector('.list-view').classList.remove('active');
            renderGraph();
        });

        function renderGraph() {
            const ctx = document.getElementById('task-chart').getContext('2d');
            const completed = tasks.filter(t => t.status === 'completed').length;
            const pending = tasks.length - completed;
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        label: 'Tasks',
                        data: [completed, pending],
                        backgroundColor: ['green', 'yellow']
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // Filters
        document.querySelectorAll('.filters input, .filters select').forEach(el => {
            el.addEventListener('change', renderTasks);
        });

        document.getElementById('due-date-filter').addEventListener('change', (e) => {
            document.getElementById('custom-date-range').style.display = e.target.value === 'custom' ? 'block' : 'none';
            renderTasks();
        });

        // Controls
        document.querySelector('.add-task').addEventListener('click', () => {
            document.getElementById('add-task-popup').style.display = 'block';
        });

        document.getElementById('add-task-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const [title, description, priority, dueDate,, notes] = e.target;
            const assignedTo = document.getElementById('assign-to').value;
            const task = {
                id: Date.now(),
                title: title.value,
                description: description.value,
                priority: priority.value,
                dueDate: dueDate.value,
                assignedTo: assignedTo || null,
                notes: notes.value,
                status: 'pending',
                timeSpent: 0
            };
            tasks.push(task);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
            updateTaskCounts();
            document.getElementById('add-task-popup').style.display = 'none';
        });

        document.getElementById('cancel-add-task').addEventListener('click', () => {
            document.getElementById('add-task-popup').style.display = 'none';
        });

        function populateAssignTo() {
            const select = document.getElementById('assign-to');
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = `${user.name} (${user.role})`;
                select.appendChild(option);
            });
        }

        document.querySelector('.users').addEventListener('click', () => {
            const ul = document.querySelector('#users-popup ul');
            ul.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `<img src="${user.profilePic}" alt="${user.name}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;"> ${user.name} (${user.role}) - ${user.email}`;
                ul.appendChild(li);
            });
            document.getElementById('users-popup').style.display = 'block';
        });

        document.getElementById('close-users').addEventListener('click', () => {
            document.getElementById('users-popup').style.display = 'none';
        });

        document.querySelector('.import').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedTasks = JSON.parse(event.target.result);
                            tasks.push(...importedTasks);
                            localStorage.setItem('tasks', JSON.stringify(tasks));
                            renderTasks();
                            updateTaskCounts();
                        } catch (err) {
                            alert('Invalid JSON file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        document.querySelector('.export').addEventListener('click', () => {
            const data = JSON.stringify(tasks);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tasks.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('delete-selected').addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.select-task:checked')).map(cb => cb.dataset.id);
            tasks = tasks.filter(t => !selectedIds.includes(String(t.id)));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
            updateTaskCounts();
        });

        document.getElementById('complete-selected').addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.select-task:checked')).map(cb => cb.dataset.id);
            tasks.forEach(t => {
                if (selectedIds.includes(String(t.id))) {
                    t.status = 'completed';
                    t.completedAt = Date.now();
                }
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));
            renderTasks();
            updateTaskCounts();
        });

        // Insights
        function updateInsights() {
            const completedTasks = tasks.filter(t => t.status === 'completed' && t.completedAt);
            if (completedTasks.length) {
                const avgTime = completedTasks.reduce((sum, t) => sum + (t.completedAt - t.createdAt), 0) / completedTasks.length;
                document.getElementById('avg-time').textContent = formatTime(avgTime);
            }
        }
    </script>
</body>
</html>
