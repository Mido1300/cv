<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional To-Do App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- XLSX for Excel/CSV export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Custom Gradient Backgrounds */
        .light-mode-gradient {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        }

        .dark-mode-gradient {
            background: linear-gradient(135deg, #1f2937, #111827);
        }

        /* Priority Colors */
        .priority-high {
            border-left: 4px solid #ef4444;
        }

        .priority-medium {
            border-left: 4px solid #f59e0b;
        }

        .priority-low {
            border-left: 4px solid #10b981;
        }

        /* Status Colors */
        .status-ok {
            border-color: #10b981;
        }

        .status-warning {
            border-color: #f59e0b;
        }

        .status-expired {
            border-color: #ef4444;
        }

        /* Dark Mode Styles */
        .dark .bg-white {
            background-color: #2d3748;
        }

        .dark .text-gray-800 {
            color: #e5e7eb;
        }

        /* Card Hover Effect */
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Task Item Styling */
        .task-item {
            background: #fff;
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .dark .task-item {
            background: #2d3748;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        /* SortableJS Styles */
        .sortable-ghost {
            opacity: 0.4;
            background: #c8e6c9;
        }

        .sortable-drag {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Animation */
        .modal {
            animation: scale 0.3s ease;
        }

        @keyframes scale {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Slide-in Animation */
        .animate-slide-in {
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Dark Mode Switch */
        .dark-mode-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 9999px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .dark .dark-mode-switch {
            background: #4b5563;
        }

        .switch-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #f59e0b;
        }

        .dark .switch-handle {
            transform: translateX(24px);
            color: #60a5fa;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #9ca3af;
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .task-item .flex-grow {
                width: 100%;
            }

            .task-item .flex.items-center.space-x-3 {
                flex-wrap: wrap;
                justify-content: flex-start;
                margin-top: 1rem;
            }

            .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: 1fr;
            }

            .grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .action-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .action-bar .flex.space-x-3 {
                flex-direction: column;
                width: 100%;
            }

            .action-bar .flex.space-x-3 button {
                width: 100%;
            }

            .modal {
                width: 90%;
                margin: 0 auto;
            }

            .dropdown-menu {
                width: 100%;
                right: 0;
            }

            .task-timer {
                font-size: 0.875rem;
            }

            .header .flex-wrap {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header .flex.items-center.space-x-4 {
                flex-wrap: wrap;
                width: 100%;
                justify-content: space-between;
            }

            .text-3xl {
                font-size: 1.5rem;
            }

            .text-2xl {
                font-size: 1.25rem;
            }

            .text-xl {
                font-size: 1rem;
            }

            .text-lg {
                font-size: 0.875rem;
            }
        }

        /* Touch-Friendly Buttons */
        button, .btn {
            touch-action: manipulation;
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>
<body class="min-h-screen light-mode-gradient transition-all duration-300">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Login Page -->
        <div id="login-page" class="flex items-center justify-center min-h-screen">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md animate-scale">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">
                    <i class="fas fa-sign-in-alt mr-2 text-primary"></i> Login
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                        <input id="login-username" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter username">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input id="login-password" type="password" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter password">
                    </div>
                    <button id="login-btn" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                        Login
                    </button>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400">
                        Don't have an account? <a href="#" id="show-signup-btn" class="text-primary hover:underline">Sign Up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signup-page" class="hidden flex items-center justify-center min-h-screen">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md animate-scale">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">
                    <i class="fas fa-user-plus mr-2 text-primary"></i> Sign Up
                </h2>
                <div class="space-y-4">
                    <div>
                        <label for="signup-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                        <input id="signup-username" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter username">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                        <input id="signup-password" type="password" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter password">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input id="signup-email" type="email" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter email">
                    </div>
                    <button id="signup-btn" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                        Sign Up
                    </button>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400">
                        Already have an account? <a href="#" id="show-login-btn" class="text-primary hover:underline">Login</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="hidden">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white">
                    <i class="fas fa-tasks mr-2 text-primary"></i> To-Do App
                </h1>
                <div class="flex flex-wrap items-center gap-4 w-full sm:w-auto">
                    <!-- Task Timer -->
                    <div class="task-timer bg-gray-100 dark:bg-gray-700 rounded-lg shadow px-3 py-2 flex items-center">
                        <i class="fas fa-clock text-primary mr-2"></i>
                        <span id="task-timer-display" class="text-base sm:text-lg font-mono text-gray-800 dark:text-white">00:00:00</span>
                    </div>
                    <!-- Dark Mode Switch -->
                    <div class="dark-mode-switch" id="dark-mode-toggle" aria-label="Toggle dark mode">
                        <div class="switch-handle">
                            <i class="fas fa-sun"></i>
                        </div>
                    </div>
                    <!-- User Status Dropdown -->
                    <div class="relative flex-grow sm:flex-grow-0">
                        <select id="user-status" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 appearance-none cursor-pointer w-full sm:w-auto">
                            <option value="online" selected>Online</option>
                            <option value="break">Break</option>
                            <option value="busy">Busy</option>
                            <option value="away">Away</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <!-- Notification Button -->
                    <div class="relative">
                        <button id="notification-btn" class="relative p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                            <i class="fas fa-bell text-gray-600 dark:text-gray-300"></i>
                            <span id="notification-badge" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10 py-2 dropdown-menu">
                            <div class="px-4 py-2 border-b border-gray-200 dark:bg-gray-700">
                                <h3 class="font-semibold text-gray-800 dark:text-white">Notifications</h3>
                            </div>
                            <div id="notification-list" class="max-h-64 overflow-y-auto">
                                <div class="px-4 py-3 text-gray-500 dark:text-gray-400 text-center">
                                    No notifications yet
                                </div>
                            </div>
                            <div class="px-4 py-2 border-t border-gray-200 dark:border-gray-700 text-center">
                                <button id="mark-all-read" class="text-sm text-primary hover:text-primary-600 dark:hover:text-primary-400">
                                    Mark all as read
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- User Profile -->
                    <div class="relative">
                        <button id="profile-btn" class="relative rounded-full w-10 h-10 overflow-hidden border-2 border-green-500" aria-label="User profile">
                            <img id="user-avatar" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User profile" class="w-full h-full object-cover">
                        </button>
                        <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-10 dropdown-menu">
                            <div class="py-1">
                                <button id="view-profile-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-user mr-2"></i> View Profile
                                </button>
                                <button id="edit-profile-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-edit mr-2"></i> Edit Profile
                                </button>
                                <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <div class="grid grid-cols-1 gap-6">
                <!-- Quick Stats -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-in">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-chart-bar mr-2 text-primary"></i> Quick Stats
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Total Tasks</h3>
                            <p id="total-tasks" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Completed</h3>
                            <p id="completed-tasks" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Pending</h3>
                            <p id="pending-tasks" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Expired</h3>
                            <p id="expired-tasks" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-in">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-chart-line mr-2 text-primary"></i> Analytics
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Task Completion Trend</h3>
                            <div class="h-64">
                                <canvas id="line-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Task Status</h3>
                            <div class="h-64">
                                <canvas id="pie-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Priority Distribution</h3>
                            <div class="h-64">
                                <canvas id="priority-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Category Distribution</h3>
                            <div class="h-64">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 animate-slide-in">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-tasks mr-2 text-primary"></i> Tasks
                        </h2>
                        <div class="flex flex-wrap items-center gap-4">
                            <button id="add-task-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                                <i class="fas fa-plus mr-2"></i> Add Task
                            </button>
                            <button id="export-tasks-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors duration-200">
                                <i class="fas fa-file-export mr-2"></i> Export
                            </button>
                            <button id="undo-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50" disabled>
                                <i class="fas fa-undo mr-2"></i> Undo
                            </button>
                            <button id="redo-btn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50" disabled>
                                <i class="fas fa-redo mr-2"></i> Redo
                            </button>
                        </div>
                    </div>
                    <!-- Filters -->
                    <div class="flex flex-wrap gap-4 mb-6">
                        <div class="flex-1 min-w-[150px]">
                            <label for="filter-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                            <select id="filter-status" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                                <option value="all">All</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                            <select id="filter-category" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="filter-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                            <select id="filter-priority" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[150px]">
                            <label for="filter-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</label>
                            <select id="filter-due-date" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label for="search-tasks" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Search</label>
                            <input id="search-tasks" type="text" placeholder="Search tasks..." class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    <!-- Custom Date Range -->
                    <div id="custom-date-range" class="hidden mb-6">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label for="date-range-start" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Start Date</label>
                                <input id="date-range-start" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white flatpickr" placeholder="Select start date">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label for="date-range-end" class="block text-sm font-medium text-gray-700 dark:text-gray-300">End Date</label>
                                <input id="date-range-end" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white flatpickr" placeholder="Select end date">
                            </div>
                        </div>
                    </div>
                    <!-- Sort -->
                    <div class="flex justify-end mb-4">
                        <div class="w-full sm:w-48">
                            <label for="sort-by" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sort By</label>
                            <select id="sort-by" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                                <option value="dueDate-asc">Due Date (Asc)</option>
                                <option value="dueDate-desc">Due Date (Desc)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="priority-asc">Priority (Low to High)</option>
                                <option value="priority-desc" selected>Priority (High to Low)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Multi-Action Bar -->
                    <div id="multi-action-bar" class="hidden bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="select-all-tasks" class="h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                                <label for="select-all-tasks" class="text-sm text-gray-700 dark:text-gray-300">Select All</label>
                                <span id="selected-count" class="text-sm text-gray-500 dark:text-gray-400">(0 selected)</span>
                            </div>
                            <div class="flex space-x-3">
                                <button id="multi-complete-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors duration-200 disabled:opacity-50" disabled>
                                    <i class="fas fa-check mr-2"></i> Mark as Complete
                                </button>
                                <button id="multi-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 disabled:opacity-50" disabled>
                                    <i class="fas fa-trash mr-2"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tasks Container -->
                    <div id="tasks-container" class="space-y-4"></div>
                </div>

                <!-- Insights Section -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mt-6 animate-slide-in">
                    <div class="flex flex-wrap justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-chart-line mr-2 text-primary"></i> Insights
                        </h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Productivity Score -->
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Productivity Score</h3>
                            <p id="productivity-score" class="text-3xl font-bold">0%</p>
                            <p class="text-sm mt-2">Based on completed tasks this week</p>
                        </div>
                        <!-- Tasks Completed This Week -->
                        <div class="bg-gradient-to-r from-teal-500 to-teal-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Tasks Completed (Week)</h3>
                            <p id="weekly-completed" class="text-3xl font-bold">0</p>
                            <p class="text-sm mt-2">Tasks finished in the last 7 days</p>
                        </div>
                        <!-- Average Completion Time -->
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-md p-4 text-white card-hover">
                            <h3 class="text-lg font-semibold">Avg. Completion Time</h3>
                            <p id="avg-completion-time" class="text-3xl font-bold">0h 0m</p>
                            <p class="text-sm mt-2">Average time to complete tasks</p>
                        </div>
                    </div>
                    <!-- Insights Chart -->
                    <div class="mt-6 bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Weekly Task Completion Trend</h3>
                        <div class="h-64">
                            <canvas id="insights-trend-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Add/Edit Task Modal -->
        <div id="task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 modal">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="task-modal-title" class="text-xl font-semibold text-gray-800 dark:text-white">Add Task</h3>
                    <button id="task-modal-close" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                        <input id="task-title" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter task title">
                    </div>
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                        <textarea id="task-description" rows="4" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter task description"></textarea>
                    </div>
                    <div>
                        <label for="task-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</label>
                        <input id="task-due-date" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white flatpickr" placeholder="Select due date">
                    </div>
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                        <select id="task-priority" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="task-category" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes</label>
                        <textarea id="task-notes" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Additional notes"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="task-modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-200">
                            Cancel
                        </button>
                        <button id="task-modal-save" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Task Modal -->
        <div id="view-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 modal">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Task Details</h3>
                    <button id="view-task-modal-close" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Title</h4>
                        <p id="view-task-title" class="text-lg text-gray-800 dark:text-white"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Description</h4>
                        <p id="view-task-description" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</h4>
                        <p id="view-task-due-date" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Priority</h4>
                        <p id="view-task-priority" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Category</h4>
                        <p id="view-task-category" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</h4>
                        <p id="view-task-status" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Notes</h4>
                        <p id="view-task-notes" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Time Spent</h4>
                        <p id="view-task-time" class="text-gray-600 dark:text-gray-400"></p>
                    </div>
                    <div class="flex justify-end">
                        <button id="view-task-modal-edit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                            Edit Task
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 modal">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Export Tasks</h3>
                    <button id="export-modal-close" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="export-format" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Format</label>
                        <select id="export-format" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white">
                            <option value="json">JSON</option>
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="export-modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-200">
                            Cancel
                        </button>
                        <button id="export-modal-confirm" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                            Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 modal">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="profile-modal-title" class="text-xl font-semibold text-gray-800 dark:text-white">User Profile</h3>
                    <button id="profile-modal-close" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-center">
                        <img id="profile-avatar-preview" src="https://randomuser.me/api/portraits/men/32.jpg" alt="User avatar" class="w-24 h-24 rounded-full border-2 border-primary">
                    </div>
                    <div>
                        <label for="profile-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                        <input id="profile-username" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter username">
                    </div>
                    <div>
                        <label for="profile-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input id="profile-email" type="email" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter email">
                    </div>
                    <div>
                        <label for="profile-avatar" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Avatar URL</label>
                        <input id="profile-avatar" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter avatar URL">
                    </div>
                    <div id="profile-password-section" class="space-y-4">
                        <div>
                            <label for="profile-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Password</label>
                            <input id="profile-password" type="password" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Enter new password">
                        </div>
                        <div>
                            <label for="profile-confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirm Password</label>
                            <input id="profile-confirm-password" type="password" class="mt-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white" placeholder="Confirm new password">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="profile-modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-white rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors duration-200">
                            Cancel
                        </button>
                        <button id="profile-modal-save" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors duration-200">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg hidden flex items-center space-x-2">
            <i id="toast-icon" class="fas"></i>
            <span id="toast-message"></span>
        </div>
    </div>

    <script>
        // Tailwind Config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-600': '#4B4ABF'
                    }
                }
            }
        };

        // Initialize Variables
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let taskTimes = JSON.parse(localStorage.getItem('taskTimes')) || {};
        let activeTaskId = null;
        let activeTimer = null;
        let categories = JSON.parse(localStorage.getItem('categories')) || ['Work', 'Personal', 'Urgent'];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let history = [];
        let historyIndex = -1;
        const selectedTasks = new Set();
        let dateRangeStart = null;
        let dateRangeEnd = null;
        const charts = {};

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const signupPage = document.getElementById('signup-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const taskModal = document.getElementById('task-modal');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskModalClose = document.getElementById('task-modal-close');
        const taskModalCancel = document.getElementById('task-modal-cancel');
        const taskModalSave = document.getElementById('task-modal-save');
        const viewTaskModal = document.getElementById('view-task-modal');
        const viewTaskModalClose = document.getElementById('view-task-modal-close');
        const viewTaskModalEdit = document.getElementById('view-task-modal-edit');
        const exportModal = document.getElementById('export-modal');
        const exportModalClose = document.getElementById('export-modal-close');
        const exportModalCancel = document.getElementById('export-modal-cancel');
        const exportModalConfirm = document.getElementById('export-modal-confirm');
        const profileModal = document.getElementById('profile-modal');
        const profileModalClose = document.getElementById('profile-modal-close');
        const profileModalCancel = document.getElementById('profile-modal-cancel');
        const profileModalSave = document.getElementById('profile-modal-save');
        const addTaskBtn = document.getElementById('add-task-btn');
        const exportTasksBtn = document.getElementById('export-tasks-btn');
        const tasksContainer = document.getElementById('tasks-container');
        const filterStatus = document.getElementById('filter-status');
        const filterCategory = document.getElementById('filter-category');
        const filterPriority = document.getElementById('filter-priority');
        const filterDueDate = document.getElementById('filter-due-date');
        const customDateRange = document.getElementById('custom-date-range');
        const searchTasks = document.getElementById('search-tasks');
        const sortBy = document.getElementById('sort-by');
        const multiActionBar = document.getElementById('multi-action-bar');
        const selectAllTasks = document.getElementById('select-all-tasks');
        const multiCompleteBtn = document.getElementById('multi-complete-btn');
        const multiDeleteBtn = document.getElementById('multi-delete-btn');
        const selectedCount = document.getElementById('selected-count');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationList = document.getElementById('notification-list');
        const notificationBadge = document.getElementById('notification-badge');
        const markAllRead = document.getElementById('mark-all-read');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const taskTimerDisplay = document.getElementById('task-timer-display');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');

        // Initialize Flatpickr
        flatpickr('.flatpickr', {
            dateFormat: 'Y-m-d',
            enableTime: false
        });

        // Utility Functions
        const generateId = () => {
            return Math.random().toString(36).substr(2, 9);
        };

        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        };

        const showToast = (message, type) => {
            toastMessage.textContent = message;
            toastIcon.className = 'fas';
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg flex items-center space-x-2';
                toastIcon.classList.add('fa-check-circle');
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-md shadow-lg flex items-center space-x-2';
                toastIcon.classList.add('fa-exclamation-circle');
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg flex items-center space-x-2';
                toastIcon.classList.add('fa-info-circle');
            }
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        };

        const saveTasks = () => {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        };

        const saveTaskTimes = () => {
            localStorage.setItem('taskTimes', JSON.stringify(taskTimes));
        };

        const saveCategories = () => {
            localStorage.setItem('categories', JSON.stringify(categories));
        };

        const saveUsers = () => {
            localStorage.setItem('users', JSON.stringify(users));
        };

        const saveCurrentUser = () => {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        };

        const saveNotifications = () => {
            localStorage.setItem('notifications', JSON.stringify(notifications));
        };

        const addToHistory = (type, data) => {
            history = history.slice(0, historyIndex + 1);
            history.push({ type, data });
            historyIndex++;
            updateHistoryButtons();
        };

        const updateHistoryButtons = () => {
            undoBtn.disabled = historyIndex < 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        };

        // Authentication
        const login = () => {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (users[username] && users[username].password === password) {
                currentUser = {
                    username,
                    email: users[username].email,
                    avatar: users[username].avatar || 'https://randomuser.me/api/portraits/men/32.jpg'
                };
                saveCurrentUser();
                showDashboard();
                showToast(`Welcome back, ${username}!`, 'success');
            } else {
                showToast('Invalid username or password', 'error');
            }
        };

        const signup = () => {
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const email = document.getElementById('signup-email').value.trim();

            if (!username || !password || !email) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (users[username]) {
                showToast('Username already exists', 'error');
                return;
            }

            users[username] = {
                password,
                email,
                avatar: 'https://randomuser.me/api/portraits/men/32.jpg'
            };
            saveUsers();
            currentUser = { username, email, avatar: users[username].avatar };
            saveCurrentUser();
            showDashboard();
            showToast(`Account created for ${username}`, 'success');
        };

        const logout = () => {
            if (activeTimer) {
                clearInterval(activeTimer);
                activeTimer = null;
                activeTaskId = null;
                taskTimerDisplay.textContent = '00:00:00';
            }
            currentUser = null;
            saveCurrentUser();
            loginPage.classList.remove('hidden');
            dashboardPage.classList.add('hidden');
            showToast('Logged out successfully', 'success');
        };

        // Profile Management
        const updateProfileInfo = () => {
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-avatar').value = currentUser.avatar;
            document.getElementById('profile-avatar-preview').src = currentUser.avatar;
        };

        const showProfile = (edit = false) => {
            profileModal.classList.remove('hidden');
            document.getElementById('profile-modal-title').textContent = edit ? 'Edit Profile' : 'User Profile';
            document.getElementById('profile-password-section').style.display = edit ? 'block' : 'none';
            document.getElementById('profile-username').disabled = !edit;
            document.getElementById('profile-email').disabled = !edit;
            document.getElementById('profile-avatar').disabled = !edit;
            document.getElementById('profile-password').disabled = !edit;
            document.getElementById('profile-confirm-password').disabled = !edit;
            document.getElementById('profile-modal-save').style.display = edit ? 'inline-block' : 'none';
            document.getElementById('profile-modal-cancel').textContent = edit ? 'Cancel' : 'Close';
            updateProfileInfo();
        };

        const saveProfile = () => {
            const username = document.getElementById('profile-username').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const avatar = document.getElementById('profile-avatar').value.trim();
            const password = document.getElementById('profile-password').value;
            const confirmPassword = document.getElementById('profile-confirm-password').value;

            if (!username || !email) {
                showToast('Username and email are required', 'error');
                return;
            }

            if (password && password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (username !== currentUser.username && users[username]) {
                showToast('Username already exists', 'error');
                return;
            }

            if (password) {
                users[currentUser.username].password = password;
            }

            if (username !== currentUser.username) {
                users[username] = users[currentUser.username];
                delete users[currentUser.username];
            }

            users[username].email = email;
            users[username].avatar = avatar || 'https://randomuser.me/api/portraits/men/32.jpg';
            currentUser = { username, email, avatar: users[username].avatar };
            saveUsers();
            saveCurrentUser();
            document.getElementById('user-avatar').src = currentUser.avatar;
            profileModal.classList.add('hidden');
            showToast('Profile updated successfully', 'success');
        };

        // Notifications
        const addNotification = (message) => {
            const id = generateId();
            notifications.push({ id, message, read: false, createdAt: new Date().toISOString() });
            saveNotifications();
            updateNotifications();
        };

        const updateNotifications = () => {
            notificationList.innerHTML = '';
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'block' : 'none';

            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="px-4 py-3 text-gray-500 dark:text-gray-400 text-center">
                        No notifications yet
                    </div>
                `;
                return;
            }

            notifications.slice().reverse().forEach(notification => {
                const notificationEl = document.createElement('div');
                notificationEl.className = `px-4 py-3 flex items-center space-x-3 ${notification.read ? 'opacity-50' : 'bg-gray-50 dark:bg-gray-700'}`;
                notificationEl.innerHTML = `
                    <i class="fas fa-bell text-primary"></i>
                    <div class="flex-1">
                        <p class="text-sm text-gray-800 dark:text-gray-200">${notification.message}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(notification.createdAt)}</p>
                    </div>
                    <button class="mark-read-btn text-gray-600 dark:text-gray-400 hover:text-primary" data-id="${notification.id}">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="delete-notification-btn text-gray-600 dark:text-gray-400 hover:text-red-500" data-id="${notification.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                notificationList.appendChild(notificationEl);

                notificationEl.querySelector('.mark-read-btn').addEventListener('click', () => {
                    notifications = notifications.map(n =>
                        n.id === notification.id ? { ...n, read: true } : n
                    );
                    saveNotifications();
                    updateNotifications();
                });

                notificationEl.querySelector('.delete-notification-btn').addEventListener('click', () => {
                    notifications = notifications.filter(n => n.id !== notification.id);
                    saveNotifications();
                    updateNotifications();
                });
            });
        };

        // Task Management
        const addTask = () => {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const category = document.getElementById('task-category').value;
            const notes = document.getElementById('task-notes').value.trim();

            if (!title) {
                showToast('Task title is required', 'error');
                return;
            }

            const task = {
                id: generateId(),
                title,
                description,
                dueDate,
                priority,
                category,
                notes,
                completed: false,
                createdAt: new Date().toISOString(),
                completedAt: null
            };

            tasks.push(task);
            if (!categories.includes(category) && category) {
                categories.push(category);
                saveCategories();
                updateCategoryFilter();
            }

            addToHistory('add', { task });
            saveTasks();
            taskModal.classList.add('hidden');
            renderTasks();
            showToast('Task added successfully', 'success');
            addNotification(`New task added: ${title}`);
        };

        const editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            taskModalTitle.textContent = 'Edit Task';
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-due-date').value = task.dueDate || '';
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-category').value = task.category || '';
            document.getElementById('task-notes').value = task.notes || '';

            taskModalSave.onclick = () => {
                const title = document.getElementById('task-title').value.trim();
                const description = document.getElementById('task-description').value.trim();
                const dueDate = document.getElementById('task-due-date').value;
                const priority = document.getElementById('task-priority').value;
                const category = document.getElementById('task-category').value;
                const notes = document.getElementById('task-notes').value.trim();

                if (!title) {
                    showToast('Task title is required', 'error');
                    return;
                }

                const oldTask = { ...task };
                task.title = title;
                task.description = description;
                task.dueDate = dueDate;
                task.priority = priority;
                task.category = category;
                task.notes = notes;

                if (!categories.includes(category) && category) {
                    categories.push(category);
                    saveCategories();
                    updateCategoryFilter();
                }

                addToHistory('edit', { id, oldTask, newTask: { ...task } });
                saveTasks();
                taskModal.classList.add('hidden');
                renderTasks();
                showToast('Task updated successfully', 'success');
                addNotification(`Task updated: ${title}`);
            };

            taskModal.classList.remove('hidden');
        };

        const deleteTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            tasks = tasks.filter(t => t.id !== id);
            if (taskTimes[id]) {
                delete taskTimes[id];
                saveTaskTimes();
            }
            if (activeTaskId === id) {
                clearInterval(activeTimer);
                activeTimer = null;
                activeTaskId = null;
                taskTimerDisplay.textContent = '00:00:00';
            }

            addToHistory('delete', { task });
            saveTasks();
            renderTasks();
            showToast('Task deleted successfully', 'success');
            addNotification(`Task deleted: ${task.title}`);
        };

        const toggleTaskCompletion = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            const oldTask = { ...task };
            task.completed = !task.completed;
            task.completedAt = task.completed ? new Date().toISOString() : null;

            addToHistory('edit', { id, oldTask, newTask: { ...task } });
            saveTasks();
            renderTasks();
            showToast(`Task marked as ${task.completed ? 'completed' : 'incomplete'}`, 'success');
            addNotification(`Task ${task.completed ? 'completed' : 'marked incomplete'}: ${task.title}`);
        };

        const toggleTaskTimer = (taskId) => {
            if (activeTaskId === taskId) {
                // Pause timer
                clearInterval(activeTimer);
                activeTimer = null;
                activeTaskId = null;
                taskTimerDisplay.textContent = '00:00:00';
                showToast('Timer paused', 'info');
            } else {
                // Start timer
                if (activeTimer) {
                    clearInterval(activeTimer);
                }
                activeTaskId = taskId;
                activeTimer = setInterval(() => {
                    taskTimes[taskId] = (taskTimes[taskId] || 0) + 1;
                    saveTaskTimes();
                    renderTasks();
                    const timeSeconds = taskTimes[taskId];
                    const hours = Math.floor(timeSeconds / 3600);
                    const minutes = Math.floor((timeSeconds % 3600) / 60);
                    const seconds = timeSeconds % 60;
                    taskTimerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
                showToast('Timer started', 'success');
            }
            renderTasks();
        };

        const shareTask = (task) => {
            const shareData = {
                title: task.title,
                text: `Task: ${task.title}\nDescription: ${task.description || 'No description'}\nDue: ${task.dueDate ? formatDate(task.dueDate) : 'No due date'}\nPriority: ${task.priority}`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => showToast('Task shared successfully', 'success'))
                    .catch(err => {
                        console.error('Share error:', err);
                        fallbackShare(task);
                    });
            } else {
                fallbackShare(task);
            }
        };

        const fallbackShare = (task) => {
            const shareModal = document.createElement('div');
            shareModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            shareModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 animate-scale">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 dark:text-white">Share Task: ${task.title}</h3>
                        <button class="share-modal-close text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <button id="share-email" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all flex items-center justify-center">
                            <i class="fas fa-envelope mr-2"></i> Share via Email
                        </button>
                        <button id="share-copy" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-all flex items-center justify-center">
                            <i class="fas fa-copy mr-2"></i> Copy Link
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(shareModal);

            shareModal.querySelector('.share-modal-close').addEventListener('click', () => {
                shareModal.remove();
            });

            shareModal.querySelector('#share-email').addEventListener('click', () => {
                const subject = encodeURIComponent(`Shared Task: ${task.title}`);
                const body = encodeURIComponent(`Task: ${task.title}\nDescription: ${task.description || 'No description'}\nDue: ${task.dueDate ? formatDate(task.dueDate) : 'No due date'}\nPriority: ${task.priority}`);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
                shareModal.remove();
                showToast('Opened email client for sharing', 'success');
            });

            shareModal.querySelector('#share-copy').addEventListener('click', () => {
                const text = `Task: ${task.title}\nDescription: ${task.description || 'No description'}\nDue: ${task.dueDate ? formatDate(task.dueDate) : 'No due date'}\nPriority: ${task.priority}`;
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast('Task details copied to clipboard', 'success');
                        shareModal.remove();
                    })
                    .catch(err => {
                        console.error('Copy error:', err);
                        showToast('Failed to copy task details', 'error');
                    });
            });
        };

        const viewTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            document.getElementById('view-task-title').textContent = task.title;
            document.getElementById('view-task-description').textContent = task.description || 'No description';
            document.getElementById('view-task-due-date').textContent = task.dueDate ? formatDate(task.dueDate) : 'No due date';
            document.getElementById('view-task-priority').textContent = task.priority;
            document.getElementById('view-task-category').textContent = task.category || 'Uncategorized';
            document.getElementById('view-task-status').textContent = task.completed ? 'Completed' : 'Pending';
            document.getElementById('view-task-notes').textContent = task.notes || 'No notes';
            const timeSeconds = taskTimes[task.id] || 0;
            const hours = Math.floor(timeSeconds / 3600);
            const minutes = Math.floor((timeSeconds % 3600) / 60);
            document.getElementById('view-task-time').textContent = `${hours}h ${minutes}m`;

            viewTaskModalEdit.onclick = () => {
                viewTaskModal.classList.add('hidden');
                editTask(id);
            };

            viewTaskModal.classList.remove('hidden');
        };

        const checkExpiredTasks = () => {
            const now = new Date();
            tasks.forEach(task => {
                if (!task.completed && task.dueDate && new Date(task.dueDate) < now) {
                    const exists = notifications.some(n => n.message.includes(`Task expired: ${task.title}`));
                    if (!exists) {
                        addNotification(`Task expired: ${task.title}`);
                    }
                }
            });
        };

        const updateCategoryFilter = () => {
            filterCategory.innerHTML = '<option value="all">All</option>';
            document.getElementById('task-category').innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category;
                option1.textContent = category;
                filterCategory.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = category;
                option2.textContent = category;
                document.getElementById('task-category').appendChild(option2);
            });
        };

        const updateTaskCounts = () => {
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const pending = total - completed;
            const expired = tasks.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < new Date()).length;

            document.getElementById('total-tasks').textContent = total;
            document.getElementById('completed-tasks').textContent = completed;
            document.getElementById('pending-tasks').textContent = pending;
            document.getElementById('expired-tasks').textContent = expired;
        };

        const updateMultiActionBar = () => {
            multiActionBar.classList.toggle('hidden', selectedTasks.size === 0);
            selectedCount.textContent = `(${selectedTasks.size} selected)`;
            selectAllTasks.checked = selectedTasks.size === tasks.length && tasks.length > 0;
                        multiCompleteBtn.disabled = selectedTasks.size === 0;
            multiDeleteBtn.disabled = selectedTasks.size === 0;
        };

        // Chart Initialization
        const initLineChart = () => {
            const ctx = document.getElementById('line-chart').getContext('2d');
            charts.lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tasks Completed',
                        data: [],
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        };

        const initPieChart = () => {
            const ctx = document.getElementById('pie-chart').getContext('2d');
            charts.pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending', 'Expired'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            }
                        }
                    }
                }
            });
        };

        const initPriorityChart = () => {
            const ctx = document.getElementById('priority-chart').getContext('2d');
            charts.priorityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        label: 'Tasks by Priority',
                        data: [0, 0, 0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        };

        const initCategoryChart = () => {
            const ctx = document.getElementById('category-chart').getContext('2d');
            charts.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#5D5CDE', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                        borderColor: ['#fff', '#fff', '#fff', '#fff', '#fff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            }
                        }
                    }
                }
            });
        };

        const initInsightsChart = () => {
            const ctx = document.getElementById('insights-trend-chart').getContext('2d');
            charts.insightsTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tasks Completed',
                        data: [],
                        borderColor: '#5D5CDE',
                        backgroundColor: 'rgba(93, 92, 222, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: document.documentElement.classList.contains('dark') ? '#fff' : '#333'
                            },
                            grid: {
                                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        };

        const initCharts = () => {
            initLineChart();
            initPieChart();
            initPriorityChart();
            initCategoryChart();
            initInsightsChart();
        };

        const updateLineChart = () => {
            const now = new Date();
            const labels = [];
            const data = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                const count = tasks.filter(t => {
                    if (!t.completed) return false;
                    const completedDate = new Date(t.completedAt || t.createdAt);
                    return completedDate.toDateString() === date.toDateString();
                }).length;
                data.push(count);
            }

            charts.lineChart.data.labels = labels;
            charts.lineChart.data.datasets[0].data = data;
            charts.lineChart.update();
        };

        const updatePieChart = () => {
            const completed = tasks.filter(t => t.completed).length;
            const pending = tasks.filter(t => !t.completed && (!t.dueDate || new Date(t.dueDate) >= new Date())).length;
            const expired = tasks.filter(t => !t.completed && t.dueDate && new Date(t.dueDate) < new Date()).length;

            charts.pieChart.data.datasets[0].data = [completed, pending, expired];
            charts.pieChart.update();
        };

        const updatePriorityChart = () => {
            const high = tasks.filter(t => t.priority === 'high').length;
            const medium = tasks.filter(t => t.priority === 'medium').length;
            const low = tasks.filter(t => t.priority === 'low').length;

            charts.priorityChart.data.datasets[0].data = [high, medium, low];
            charts.priorityChart.update();
        };

        const updateCategoryChart = () => {
            const categoryCounts = categories.map(category =>
                tasks.filter(t => t.category === category).length
            );
            charts.categoryChart.data.labels = categories;
            charts.categoryChart.data.datasets[0].data = categoryCounts;
            charts.categoryChart.update();
        };

        const updateInsights = () => {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            // Productivity Score
            const totalTasksWeek = tasks.filter(t => new Date(t.createdAt) >= oneWeekAgo).length;
            const completedTasksWeek = tasks.filter(t => t.completed && new Date(t.createdAt) >= oneWeekAgo).length;
            const productivityScore = totalTasksWeek > 0 ? Math.round((completedTasksWeek / totalTasksWeek) * 100) : 0;
            document.getElementById('productivity-score').textContent = `${productivityScore}%`;

            // Weekly Completed
            document.getElementById('weekly-completed').textContent = completedTasksWeek;

            // Average Completion Time
            const completedTasks = tasks.filter(t => t.completed && taskTimes[t.id]);
            const avgTime = completedTasks.length > 0
                ? completedTasks.reduce((sum, task) => sum + (taskTimes[task.id] || 0), 0) / completedTasks.length
                : 0;
            const hours = Math.floor(avgTime / 3600);
            const minutes = Math.floor((avgTime % 3600) / 60);
            document.getElementById('avg-completion-time').textContent = `${hours}h ${minutes}m`;

            // Update Insights Chart
            const labels = [];
            const data = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                const count = tasks.filter(t => {
                    if (!t.completed) return false;
                    const completedDate = new Date(t.completedAt || t.createdAt);
                    return completedDate.toDateString() === date.toDateString();
                }).length;
                data.push(count);
            }

            if (charts.insightsTrendChart) {
                charts.insightsTrendChart.data.labels = labels;
                charts.insightsTrendChart.data.datasets[0].data = data;
                charts.insightsTrendChart.update();
            }
        };

        const updateCharts = () => {
            updateLineChart();
            updatePieChart();
            updatePriorityChart();
            updateCategoryChart();
            updateInsights();
        };

        const updateChartsTheme = () => {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#fff' : '#333';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            Object.values(charts).forEach(chart => {
                chart.options.plugins.legend.labels.color = textColor;
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.x.grid.color = gridColor;
                chart.options.scales.y.grid.color = gridColor;
                chart.update();
            });
        };

        // Export Tasks
        const exportTasks = () => {
            const format = document.getElementById('export-format').value;

            const fileName = `tasks_export_${new Date().toISOString().split('T')[0]}.${format}`;
            let blob, mimeType;

            if (format === 'json') {
                const jsonContent = JSON.stringify(tasks, null, 2);
                blob = new Blob([jsonContent], { type: 'application/json' });
                mimeType = 'application/json';
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(16);
                doc.text('Tasks Report', 20, 20);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
                doc.text(`Total Tasks: ${tasks.length}`, 20, 35);
                doc.text(`Completed: ${tasks.filter(t => t.completed).length}`, 20, 40);
                doc.text(`Pending: ${tasks.filter(t => !t.completed).length}`, 20, 45);

                const tableRows = tasks.map(task => [
                    task.title,
                    task.category || '-',
                    task.priority,
                    task.dueDate ? formatDate(task.dueDate) : '-',
                    task.completed ? 'Completed' : 'Pending'
                ]);

                doc.autoTable({
                    startY: 55,
                    head: [['Title', 'Category', 'Priority', 'Due Date', 'Status']],
                    body: tableRows,
                    theme: 'striped',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [93, 92, 222] }
                });

                blob = doc.output('blob');
                mimeType = 'application/pdf';
            } else if (format === 'excel' || format === 'csv') {
                const worksheet = XLSX.utils.json_to_sheet(tasks.map(task => ({
                    Title: task.title,
                    Description: task.description,
                    'Due Date': task.dueDate ? formatDate(task.dueDate) : '',
                    Priority: task.priority,
                    Category: task.category || '',
                    Status: task.completed ? 'Completed' : 'Pending',
                    Notes: task.notes || ''
                })));

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');

                if (format === 'excel') {
                    blob = new Blob([XLSX.write(workbook, { bookType: 'xlsx', type: 'array' })], {
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    });
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                } else {
                    const csvContent = XLSX.utils.sheet_to_csv(worksheet);
                    blob = new Blob([csvContent], { type: 'text/csv' });
                    mimeType = 'text/csv';
                }
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`${format.toUpperCase()} file downloaded successfully`, 'success');
            exportModal.classList.add('hidden');
        };

        // Undo/Redo
        const undo = () => {
            if (historyIndex < 0) return;

            const action = history[historyIndex];
            historyIndex--;
            updateHistoryButtons();

            if (action.type === 'add') {
                tasks = tasks.filter(t => t.id !== action.data.task.id);
                if (taskTimes[action.data.task.id]) {
                    delete taskTimes[action.data.task.id];
                    saveTaskTimes();
                }
            } else if (action.type === 'edit') {
                const task = tasks.find(t => t.id === action.data.id);
                if (task) {
                    Object.assign(task, action.data.oldTask);
                }
            } else if (action.type === 'delete') {
                tasks.push(action.data.task);
            } else if (action.type === 'move') {
                const { taskId, fromIndex, toIndex } = action.data;
                const task = tasks[toIndex];
                tasks.splice(toIndex, 1);
                tasks.splice(fromIndex, 0, task);
            } else if (action.type === 'multi-complete') {
                action.data.taskIds.forEach(id => {
                    const task = tasks.find(t => t.id === id);
                    if (task) {
                        task.completed = false;
                        task.completedAt = null;
                    }
                });
            } else if (action.type === 'multi-delete') {
                tasks.push(...action.data.tasks);
            }

            saveTasks();
            renderTasks();
            showToast('Action undone', 'success');
        };

        const redo = () => {
            if (historyIndex >= history.length - 1) return;

            historyIndex++;
            const action = history[historyIndex];
            updateHistoryButtons();

            if (action.type === 'add') {
                tasks.push(action.data.task);
            } else if (action.type === 'edit') {
                const task = tasks.find(t => t.id === action.data.id);
                if (task) {
                    Object.assign(task, action.data.newTask);
                }
            } else if (action.type === 'delete') {
                tasks = tasks.filter(t => t.id !== action.data.task.id);
                if (taskTimes[action.data.task.id]) {
                    delete taskTimes[action.data.task.id];
                    saveTaskTimes();
                }
            } else if (action.type === 'move') {
                const { taskId, fromIndex, toIndex } = action.data;
                const task = tasks[fromIndex];
                tasks.splice(fromIndex, 1);
                tasks.splice(toIndex, 0, task);
            } else if (action.type === 'multi-complete') {
                action.data.taskIds.forEach(id => {
                    const task = tasks.find(t => t.id === id);
                    if (task) {
                        task.completed = true;
                        task.completedAt = new Date().toISOString();
                    }
                });
            } else if (action.type === 'multi-delete') {
                tasks = tasks.filter(t => !action.data.tasks.some(dt => dt.id === t.id));
                action.data.tasks.forEach(t => {
                    if (taskTimes[t.id]) {
                        delete taskTimes[t.id];
                    }
                });
                saveTaskTimes();
            }

            saveTasks();
            renderTasks();
            showToast('Action redone', 'success');
        };

        // Multi-Action Handlers
        const markSelectedComplete = () => {
            const taskIds = Array.from(selectedTasks);
            taskIds.forEach(id => {
                const task = tasks.find(t => t.id === id);
                if (task && !task.completed) {
                    task.completed = true;
                    task.completedAt = new Date().toISOString();
                }
            });

            addToHistory('multi-complete', { taskIds });
            saveTasks();
            selectedTasks.clear();
            renderTasks();
            showToast('Selected tasks marked as complete', 'success');
            addNotification('Multiple tasks marked as complete');
        };

        const deleteSelected = () => {
            const deletedTasks = [];
            const taskIds = Array.from(selectedTasks);
            taskIds.forEach(id => {
                const task = tasks.find(t => t.id === id);
                if (task) {
                    deletedTasks.push({ ...task });
                }
            });

            tasks = tasks.filter(t => !selectedTasks.has(t.id));
            taskIds.forEach(id => {
                if (taskTimes[id]) {
                    delete taskTimes[id];
                }
                if (activeTaskId === id) {
                    clearInterval(activeTimer);
                    activeTimer = null;
                    activeTaskId = null;
                    taskTimerDisplay.textContent = '00:00:00';
                }
            });
            saveTaskTimes();

            addToHistory('multi-delete', { tasks: deletedTasks });
            saveTasks();
            selectedTasks.clear();
            renderTasks();
            showToast('Selected tasks deleted', 'success');
            addNotification('Multiple tasks deleted');
        };

        // Render Tasks
        const renderTasks = () => {
            tasksContainer.innerHTML = '';
            selectedTasks.clear();
            updateMultiActionBar();

            let filteredTasks = [...tasks];

            // Apply filters
            const statusFilter = document.getElementById('filter-status').value;
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task =>
                    statusFilter === 'completed' ? task.completed : !task.completed
                );
            }

            const categoryFilter = document.getElementById('filter-category').value;
            if (categoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilter);
            }

            const priorityFilter = document.getElementById('filter-priority').value;
            if (priorityFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.priority === priorityFilter);
            }

            const dueDateFilter = document.getElementById('filter-due-date').value;
            if (dueDateFilter !== 'all') {
                const now = new Date();
                now.setHours(0, 0, 0, 0);

                if (dueDateFilter === 'today') {
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate);
                        dueDate.setHours(0, 0, 0, 0);
                        return dueDate.getTime() === now.getTime();
                    });
                } else if (dueDateFilter === 'week') {
                    const oneWeekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= now && dueDate <= oneWeekFromNow;
                    });
                } else if (dueDateFilter === 'month') {
                    const oneMonthFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= now && dueDate <= oneMonthFromNow;
                    });
                } else if (dueDateFilter === 'custom' && dateRangeStart && dateRangeEnd) {
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= dateRangeStart && dueDate <= dateRangeEnd;
                    });
                }
            }

            const searchQuery = document.getElementById('search-tasks').value.toLowerCase();
            if (searchQuery) {
                filteredTasks = filteredTasks.filter(task =>
                    task.title.toLowerCase().includes(searchQuery) ||
                    task.description.toLowerCase().includes(searchQuery)
                );
            }

            // Apply sorting
            const sortBy = document.getElementById('sort-by').value;
            filteredTasks.sort((a, b) => {
                if (sortBy === 'dueDate-asc') {
                    return (a.dueDate || '9999-12-31') < (b.dueDate || '9999-12-31') ? -1 : 1;
                } else if (sortBy === 'dueDate-desc') {
                    return (a.dueDate || '9999-12-31') > (b.dueDate || '9999-12-31') ? -1 : 1;
                } else if (sortBy === 'title-asc') {
                    return a.title.localeCompare(b.title);
                } else if (sortBy === 'title-desc') {
                    return b.title.localeCompare(b.title);
                } else if (sortBy === 'priority-desc') {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                } else if (sortBy === 'priority-asc') {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return 0;
            });

            if (filteredTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-tasks text-5xl mb-4 opacity-30"></i>
                        <p class="text-lg">No tasks found</p>
                    </div>
                `;
                updateTaskCounts();
                updateCharts();
                return;
            }

            filteredTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `task-item p-4 rounded-lg shadow-md card-hover priority-${task.priority} ${task.completed ? 'opacity-60' : ''}`;
                taskEl.setAttribute('data-task-id', task.id);

                // Calculate status based on due date
                let statusClass = 'status-ok';
                let statusIcon = 'fa-circle-check';
                if (!task.completed && task.dueDate) {
                    const now = new Date();
                    const dueDate = new Date(task.dueDate);
                    const diffTime = dueDate - now;
                    if (diffTime < 0) {
                        statusClass = 'status-expired';
                        statusIcon = 'fa-circle-exclamation';
                    } else if (diffTime < 24 * 60 * 60 * 1000) {
                        statusClass = 'status-warning';
                        statusIcon = 'fa-circle-exclamation';
                    }
                }

                // Format timer
                const timeSeconds = taskTimes[task.id] || 0;
                const hours = Math.floor(timeSeconds / 3600);
                const minutes = Math.floor((timeSeconds % 3600) / 60);
                const seconds = timeSeconds % 60;
                const timerDisplay = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                taskEl.innerHTML = `
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center space-x-4 flex-grow">
                            <input type="checkbox" class="task-select h-5 w-5 rounded border-gray-300 text-primary focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                            <div class="flex-grow">
                                <div class="flex items-center space-x-2">
                                    <h3 class="text-lg font-medium text-gray-800 dark:text-white ${task.completed ? 'line-through' : ''}">
                                        ${task.title}
                                    </h3>
                                    <span class="task-timer text-sm text-gray-500 dark:text-gray-400 font-mono">${timerDisplay}</span>
                                    ${activeTaskId === task.id ? '<i class="fas fa-play text-green-500"></i>' : ''}
                                </div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${task.description || 'No description'}</p>
                                <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                                        <i class="fas fa-folder mr-1 text-primary"></i>
                                        ${task.category || 'Uncategorized'}
                                    </span>
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                                        <i class="fas fa-exclamation-circle mr-1"></i>
                                        ${task.priority}
                                    </span>
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-md">
                                        <i class="fas fa-calendar-alt mr-1"></i>
                                        ${task.dueDate ? formatDate(task.dueDate) : 'No due date'}
                                    </span>
                                    <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-md border-2 ${statusClass}">
                                        <i class="fas ${statusIcon} mr-1"></i>
                                        ${task.completed ? 'Completed' : (statusClass === 'status-expired' ? 'Expired' : (statusClass === 'status-warning' ? 'Due Soon' : 'Active'))}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="toggle-timer-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary" title="${activeTaskId === task.id ? 'Pause Timer' : 'Start Timer'}">
                                <i class="fas ${activeTaskId === task.id ? 'fa-pause' : 'fa-play'}"></i>
                            </button>
                            <button class="share-task-btn p-2 text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400" title="Share Task">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="view-task-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary" title="View Task">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="edit-task-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-task-btn p-2 text-gray-600 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-500" title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="toggle-complete-btn p-2 text-gray-600 dark:text-gray-400 hover:text-green-500 dark:hover:text-green-500" title="${task.completed ? 'Mark as Incomplete' : 'Mark as Complete'}">
                                <i class="fas ${task.completed ? 'fa-undo' : 'fa-check'}"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Event Listeners
                const selectCheckbox = taskEl.querySelector('.task-select');
                selectCheckbox.addEventListener('change', () => {
                    if (selectCheckbox.checked) {
                        selectedTasks.add(task.id);
                    } else {
                        selectedTasks.delete(task.id);
                    }
                    updateMultiActionBar();
                });

                taskEl.querySelector('.toggle-complete-btn').addEventListener('click', () => {
                    toggleTaskCompletion(task.id);
                });

                taskEl.querySelector('.delete-task-btn').addEventListener('click', () => {
                    deleteTask(task.id);
                });

                taskEl.querySelector('.edit-task-btn').addEventListener('click', () => {
                    editTask(task.id);
                });

                taskEl.querySelector('.view-task-btn').addEventListener('click', () => {
                    viewTask(task.id);
                });

                taskEl.querySelector('.toggle-timer-btn').addEventListener('click', () => {
                    toggleTaskTimer(task.id);
                });

                taskEl.querySelector('.share-task-btn').addEventListener('click', () => {
                    shareTask(task);
                });

                tasksContainer.appendChild(taskEl);
            });

            // Initialize drag and drop
            new Sortable(tasksContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.task-item',
                onEnd: (evt) => {
                    const taskId = evt.item.getAttribute('data-task-id');
                    const fromIndex = evt.oldIndex;
                    const toIndex = evt.newIndex;

                    if (fromIndex !== toIndex) {
                        const [task] = tasks.splice(fromIndex, 1);
                        tasks.splice(toIndex, 0, task);

                        addToHistory('move', {
                            taskId,
                            fromIndex,
                            toIndex
                        });

                        saveTasks();
                        renderTasks();
                    }
                }
            });

            updateTaskCounts();
            updateCharts();
        };

        // Show Dashboard
        const showDashboard = () => {
            loginPage.classList.add('hidden');
            signupPage.classList.add('hidden');
            dashboardPage.classList.remove('hidden');

            if (currentUser) {
                document.getElementById('user-avatar').src = currentUser.avatar || 'https://randomuser.me/api/portraits/men/32.jpg';
                updateProfileInfo();
            }

            checkExpiredTasks();
            updateCategoryFilter();
            renderTasks();
            updateNotifications();
            updateInsights();
        };

        // Event Listeners
        loginBtn.addEventListener('click', login);
        signupBtn.addEventListener('click', signup);
        showSignupBtn.addEventListener('click', () => {
            loginPage.classList.add('hidden');
            signupPage.classList.remove('hidden');
        });
        showLoginBtn.addEventListener('click', () => {
            signupPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
        });

        addTaskBtn.addEventListener('click', () => {
            taskModalTitle.textContent = 'Add Task';
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-due-date').value = '';
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-category').value = '';
            document.getElementById('task-notes').value = '';
            taskModalSave.onclick = addTask;
            taskModal.classList.remove('hidden');
        });

        taskModalClose.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });

        taskModalCancel.addEventListener('click', () => {
            taskModal.classList.add('hidden');
        });

        viewTaskModalClose.addEventListener('click', () => {
            viewTaskModal.classList.add('hidden');
        });

        exportTasksBtn.addEventListener('click', () => {
            exportModal.classList.remove('hidden');
        });

        exportModalClose.addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });

        exportModalCancel.addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });

        exportModalConfirm.addEventListener('click', exportTasks);

        profileModalClose.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        profileModalCancel.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        profileModalSave.addEventListener('click', saveProfile);

        filterStatus.addEventListener('change', renderTasks);
        filterCategory.addEventListener('change', renderTasks);
        filterPriority.addEventListener('change', renderTasks);
        filterDueDate.addEventListener('change', () => {
            customDateRange.classList.toggle('hidden', filterDueDate.value !== 'custom');
            renderTasks();
        });

        document.getElementById('date-range-start').addEventListener('change', (e) => {
            dateRangeStart = new Date(e.target.value);
            renderTasks();
        });

        document.getElementById('date-range-end').addEventListener('change', (e) => {
            dateRangeEnd = new Date(e.target.value);
            renderTasks();
        });

        searchTasks.addEventListener('input', renderTasks);
        sortBy.addEventListener('change', renderTasks);

        selectAllTasks.addEventListener('change', () => {
            const checkboxes = tasksContainer.querySelectorAll('.task-select');
            if (selectAllTasks.checked) {
                tasks.forEach(task => selectedTasks.add(task.id));
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                selectedTasks.clear();
                checkboxes.forEach(cb => cb.checked = false);
            }
            updateMultiActionBar();
        });

        multiCompleteBtn.addEventListener('click', markSelectedComplete);
        multiDeleteBtn.addEventListener('click', deleteSelected);

        notificationBtn.addEventListener('click', () => {
            notificationDropdown.classList.toggle('hidden');
        });

        markAllRead.addEventListener('click', () => {
            notifications = notifications.map(n => ({ ...n, read: true }));
            saveNotifications();
            updateNotifications();
        });

        profileBtn.addEventListener('click', () => {
            profileDropdown.classList.toggle('hidden');
        });

        viewProfileBtn.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            showProfile(false);
        });

        editProfileBtn.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            showProfile(true);
        });

        logoutBtn.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            logout();
        });

        darkModeToggle.addEventListener('click', toggleDarkMode);

        // Fixed Login Function
        const login = () => {
            const usernameInput = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const username = usernameInput.toLowerCase(); // Normalize to lowercase

            if (!username || !password) {
                showToast('Please enter both username and password', 'error');
                return;
            }

            try {
                if (users[username] && users[username].password === password) {
                    currentUser = {
                        username,
                        email: users[username].email,
                        avatar: users[username].avatar || 'https://randomuser.me/api/portraits/men/32.jpg'
                    };
                    saveCurrentUser();
                    // Clear input fields
                    document.getElementById('login-username').value = '';
                    document.getElementById('login-password').value = '';
                    showDashboard();
                    showToast(`Welcome back, ${usernameInput}!`, 'success');
                } else {
                    showToast('Invalid username or password', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('An error occurred during login', 'error');
            }
        };

        // Fixed Signup Function
        const signup = () => {
            const usernameInput = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value;
            const email = document.getElementById('signup-email').value.trim();
            const username = usernameInput.toLowerCase(); // Normalize to lowercase

            // Validate inputs
            if (!username || !password || !email) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            try {
                if (users[username]) {
                    showToast('Username already exists', 'error');
                    return;
                }

                users[username] = {
                    password,
                    email,
                    avatar: 'https://randomuser.me/api/portraits/men/32.jpg'
                };
                saveUsers();
                currentUser = { username, email, avatar: users[username].avatar };
                saveCurrentUser();
                // Clear input fields
                document.getElementById('signup-username').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-email').value = '';
                showDashboard();
                showToast(`Account created for ${usernameInput}`, 'success');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('An error occurred during signup', 'error');
            }
        };

        // Toggle Dark Mode
        const toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                document.body.classList.remove('light-mode-gradient');
                document.body.classList.add('dark-mode-gradient');
                localStorage.setItem('theme', 'dark');
                darkModeToggle.querySelector('.switch-handle i').className = 'fas fa-moon';
            } else {
                document.body.classList.add('light-mode-gradient');
                document.body.classList.remove('dark-mode-gradient');
                localStorage.setItem('theme', 'light');
                darkModeToggle.querySelector('.switch-handle i').className = 'fas fa-sun';
            }
            updateChartsTheme();
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.body.classList.remove('light-mode-gradient');
                document.body.classList.add('dark-mode-gradient');
                darkModeToggle.querySelector('.switch-handle i').className = 'fas fa-moon';
            } else {
                document.documentElement.classList.remove('dark');
                document.body.classList.add('light-mode-gradient');
                document.body.classList.remove('dark-mode-gradient');
                darkModeToggle.querySelector('.switch-handle i').className = 'fas fa-sun';
            }

            initCharts();
            updateCategoryFilter();

            if (currentUser) {
                showDashboard();
            } else {
                loginPage.classList.remove('hidden');
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                }
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
