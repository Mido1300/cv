<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Custom styles */
        :root {
            --primary-color: #5D5CDE;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --shadow-color: #9CA3AF;
            --background-light: #FFFFFF;
            --text-light: #1F2937;
            --background-dark: #181818;
            --text-dark: #F3F4F6;
        }

        .light-mode {
            --background: var(--background-light);
            --text: var(--text-light);
            --card-bg: #F9FAFB;
            --border: #E5E7EB;
        }

        .dark-mode {
            --background: var(--background-dark);
            --text: var(--text-dark);
            --card-bg: #262626;
            --border: #404040;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
        }

        .popup-content {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            margin: 2rem auto;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
        }

        .dropdown-content a {
            color: var(--text);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .show {
            display: block;
        }

        .nested-dropdown {
            position: relative;
        }

        .nested-dropdown-content {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            background-color: var(--card-bg);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-radius: 0.375rem;
            border: 1px solid var(--border);
        }

        .profile-status-green {
            border: 3px solid var(--success-color);
        }

        .profile-status-red {
            border: 3px solid var(--danger-color);
        }

        .profile-status-yellow {
            border: 3px solid var(--warning-color);
        }

        .profile-status-grey {
            border: 3px solid var(--shadow-color);
        }

        .task-item {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .task-priority-high {
            border-left: 4px solid var(--danger-color);
        }

        .task-priority-medium {
            border-left: 4px solid var(--warning-color);
        }

        .task-priority-low {
            border-left: 4px solid var(--shadow-color);
        }

        .task-completed {
            border-left: 4px solid var(--success-color) !important;
            opacity: 0.8;
        }

        .notification-popup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            background-color: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            max-width: 350px;
        }

        .notification-popup.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-popup.success {
            border-left: 4px solid var(--success-color);
        }

        .notification-popup.warning {
            border-left: 4px solid var(--warning-color);
        }

        .notification-popup.danger {
            border-left: 4px solid var(--danger-color);
        }

        .notification-popup.info {
            border-left: 4px solid var(--primary-color);
        }

        /* Drag and drop */
        .task-item.dragging {
            opacity: 0.4;
        }

        /* Additional animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .responsive-grid {
                grid-template-columns: 1fr;
            }
            
            .title-bar-content {
                flex-direction: column;
            }
            
            .task-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .task-controls button {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="light-mode min-h-screen">
    <!-- Login/Register Page -->
    <div id="auth-container" class="w-full min-h-screen p-4 flex items-center justify-center">
        <div class="card p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-primary-600">
                    <i class="fas fa-tasks mr-2 text-purple-600"></i>
                    To-Do App
                </h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Manage your tasks efficiently</p>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-2xl font-semibold mb-4">Login</h2>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded transition duration-300">Login</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Don't have an account? 
                    <a href="#" id="showRegister" class="text-purple-600 hover:underline">Register now</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <h2 class="text-2xl font-semibold mb-4">Create an Account</h2>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerName" class="block text-sm font-medium mb-1">Full Name</label>
                        <input type="text" id="registerName" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="John Doe" required>
                    </div>
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="registerEmail" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="confirmEmail" class="block text-sm font-medium mb-1">Confirm Email</label>
                        <input type="email" id="confirmEmail" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="registerPassword" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="••••••••" required>
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium mb-1">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="••••••••" required>
                    </div>
                    <div>
                        <label for="registerPhone" class="block text-sm font-medium mb-1">Phone Number</label>
                        <input type="tel" id="registerPhone" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="+1 234 567 8900" required>
                    </div>
                    <div>
                        <label for="registerCountry" class="block text-sm font-medium mb-1">Country</label>
                        <select id="registerCountry" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                            <option value="" disabled selected>Select your country</option>
                            <option value="USA">United States</option>
                            <option value="CAN">Canada</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AUS">Australia</option>
                            <option value="DEU">Germany</option>
                            <option value="FRA">France</option>
                            <option value="JPN">Japan</option>
                            <option value="CHN">China</option>
                            <option value="IND">India</option>
                            <option value="BRA">Brazil</option>
                        </select>
                    </div>
                    <div>
                        <label for="registerRole" class="block text-sm font-medium mb-1">Role</label>
                        <select id="registerRole" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                            <option value="" disabled selected>Select your role</option>
                            <option value="Manager">Manager</option>
                            <option value="Admin">Admin</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded transition duration-300">Register</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Already have an account? 
                    <a href="#" id="showLogin" class="text-purple-600 hover:underline">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-container" class="hidden w-full min-h-screen">
        <!-- Title Bar -->
        <div class="sticky top-0 z-50 bg-white dark:bg-gray-900 shadow-md">
            <div class="container mx-auto p-4">
                <div class="flex justify-between items-center title-bar-content">
                    <!-- Logo and App Name -->
                    <div class="flex items-center">
                        <i class="fas fa-tasks text-2xl text-purple-600 mr-2"></i>
                        <h1 class="text-2xl font-bold">To-Do App</h1>
                    </div>

                    <!-- Right Side Items -->
                    <div class="flex items-center space-x-4">
                        <!-- Timer -->
                        <div class="hidden md:flex items-center bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg">
                            <i class="far fa-clock mr-2 text-purple-600"></i>
                            <span id="work-timer" class="font-mono">00:00:00</span>
                        </div>

                        <!-- Theme Toggle -->
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i class="fas fa-moon text-gray-600 dark:text-gray-300 dark:hidden"></i>
                            <i class="fas fa-sun text-yellow-400 hidden dark:block"></i>
                        </button>

                        <!-- Notifications -->
                        <div class="dropdown">
                            <button id="notification-button" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 relative">
                                <i class="fas fa-bell text-gray-600 dark:text-gray-300"></i>
                                <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                            </button>
                            <div id="notification-dropdown" class="dropdown-content">
                                <div class="p-2 text-center" id="empty-notifications">
                                    No notifications
                                </div>
                                <div id="notification-list" class="max-h-80 overflow-y-auto"></div>
                            </div>
                        </div>

                        <!-- Profile -->
                        <div class="dropdown">
                            <button id="profile-button" class="relative focus:outline-none">
                                <img id="profile-image" src="" alt="Profile" class="w-10 h-10 rounded-full profile-status-red object-cover">
                            </button>
                            <div id="profile-dropdown" class="dropdown-content">
                                <a href="#" id="view-profile">View Profile</a>
                                <div class="nested-dropdown">
                                    <a href="#" id="status-option">
                                        Status <i class="fas fa-caret-right float-right mt-1"></i>
                                    </a>
                                    <div id="status-dropdown" class="nested-dropdown-content">
                                        <a href="#" data-status="login" class="status-item">
                                            <i class="fas fa-circle text-green-500 mr-2"></i> Login
                                        </a>
                                        <a href="#" data-status="shadow" class="status-item">
                                            <i class="fas fa-circle text-gray-500 mr-2"></i> Shadow
                                        </a>
                                        <a href="#" data-status="break" class="status-item">
                                            <i class="fas fa-circle text-yellow-500 mr-2"></i> Break
                                        </a>
                                        <a href="#" data-status="logout" class="status-item">
                                            <i class="fas fa-circle text-red-500 mr-2"></i> Logout
                                        </a>
                                    </div>
                                </div>
                                <a href="#" id="logout-button">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Timer (visible only on small screens) -->
        <div class="md:hidden container mx-auto p-4">
            <div class="flex items-center bg-gray-100 dark:bg-gray-800 px-4 py-2 rounded-lg">
                <i class="far fa-clock mr-2 text-purple-600"></i>
                <span id="mobile-work-timer" class="font-mono">00:00:00</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container mx-auto p-4">
            <!-- Task Status Summary -->
            <div class="mb-6">
                <div class="grid grid-cols-1 gap-4 mb-4">
                    <div class="card p-4 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full mr-4">
                                <i class="fas fa-tasks text-blue-500 dark:text-blue-300 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Total Tasks</h3>
                                <p id="total-tasks-count" class="text-3xl font-bold text-blue-500">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-4 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full mr-4">
                                <i class="fas fa-check text-green-500 dark:text-green-300 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Completed Tasks</h3>
                                <p id="completed-tasks-count" class="text-3xl font-bold text-green-500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 dark:bg-yellow-900 p-3 rounded-full mr-4">
                                <i class="fas fa-clock text-yellow-500 dark:text-yellow-300 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Pending Tasks</h3>
                                <p id="pending-tasks-count" class="text-3xl font-bold text-yellow-500">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Controls -->
            <div class="mb-6 flex items-center justify-between flex-wrap task-controls">
                <div class="flex items-center mb-4 md:mb-0">
                    <h2 class="text-2xl font-bold mr-4">Tasks</h2>
                    <div class="flex items-center bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                        <button id="list-view-btn" class="px-3 py-1 rounded-lg bg-white dark:bg-gray-700 shadow-sm">
                            <i class="fas fa-list mr-1"></i> List
                        </button>
                        <button id="graph-view-btn" class="px-3 py-1 rounded-lg">
                            <i class="fas fa-chart-pie mr-1"></i> Graph
                        </button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="import-btn" class="flex items-center px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition duration-200">
                        <i class="fas fa-file-import mr-2"></i> Import
                    </button>
                    <button id="export-btn" class="flex items-center px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition duration-200">
                        <i class="fas fa-file-export mr-2"></i> Export
                    </button>
                    <button id="users-btn" class="flex items-center px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition duration-200">
                        <i class="fas fa-users mr-2"></i> Users
                    </button>
                    <button id="add-task-btn" class="flex items-center px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition duration-200">
                        <i class="fas fa-plus mr-2"></i> Add Task
                    </button>
                </div>
            </div>

            <!-- Filters and Sorting -->
            <div class="card p-4 rounded-lg shadow mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Search</label>
                        <div class="relative">
                            <input type="text" id="search-tasks" class="w-full px-4 py-2 pl-10 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Search tasks...">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[180px]">
                            <label for="filter-category" class="block text-sm font-medium mb-1">Category</label>
                            <select id="filter-category" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                                <option value="all">All Categories</option>
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="health">Health</option>
                                <option value="education">Education</option>
                                <option value="finance">Finance</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[180px]">
                            <label for="filter-priority" class="block text-sm font-medium mb-1">Priority</label>
                            <select id="filter-priority" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[180px]">
                            <label for="filter-status" class="block text-sm font-medium mb-1">Status</label>
                            <select id="filter-status" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[180px]">
                            <label for="filter-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                            <select id="filter-due-date" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">In a Week</option>
                                <option value="month">In a Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex items-end gap-4">
                        <div id="custom-date-range" class="hidden flex-1 gap-2">
                            <div class="flex-1">
                                <label for="date-from" class="block text-sm font-medium mb-1">From</label>
                                <input type="date" id="date-from" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                            </div>
                            <div class="flex-1">
                                <label for="date-to" class="block text-sm font-medium mb-1">To</label>
                                <input type="date" id="date-to" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                            </div>
                        </div>
                        <div class="flex-1 min-w-[180px]" id="sort-container">
                            <label for="sort-tasks" class="block text-sm font-medium mb-1">Sort By</label>
                            <select id="sort-tasks" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                                <option value="dueDate-asc">Due Date (Earliest)</option>
                                <option value="dueDate-desc">Due Date (Latest)</option>
                                <option value="priority-desc">Priority (High → Low)</option>
                                <option value="priority-asc">Priority (Low → High)</option>
                                <option value="title-asc">Title (A → Z)</option>
                                <option value="title-desc">Title (Z → A)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-4">
                    <div class="flex gap-2">
                        <button id="undo-btn" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-undo"></i>
                        </button>
                        <button id="redo-btn" class="px-2 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div>
                        <button id="clear-filters-btn" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded transition duration-200">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tasks List View -->
            <div id="list-view" class="mb-6">
                <div id="tasks-container" class="space-y-4">
                    <!-- Task items will be generated here -->
                    <div class="text-center p-8 text-gray-500">
                        No tasks found. Click "+ Add Task" to create your first task.
                    </div>
                </div>
            </div>

            <!-- Tasks Graph View -->
            <div id="graph-view" class="mb-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Task Status Distribution</h3>
                        <div class="h-64">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div class="card p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Task Priority Distribution</h3>
                        <div class="h-64">
                            <canvas id="priority-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <div class="card p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Tasks Due Date Timeline</h3>
                        <div class="h-64">
                            <canvas id="timeline-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights View -->
            <div class="mb-6">
                <div class="card p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4">Insights</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                            <h3 class="font-semibold mb-2">Productivity Score</h3>
                            <div class="flex items-end">
                                <span id="productivity-score" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0%</span>
                                <span id="productivity-trend" class="ml-2 text-sm text-green-500">
                                    <i class="fas fa-arrow-up"></i> +0%
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Based on completed vs. total tasks</p>
                        </div>
                        <div class="p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                            <h3 class="font-semibold mb-2">Task Completion Time</h3>
                            <div class="flex items-end">
                                <span id="avg-completion-time" class="text-3xl font-bold text-purple-600 dark:text-purple-400">0h</span>
                                <span id="completion-trend" class="ml-2 text-sm text-green-500">
                                    <i class="fas fa-arrow-down"></i> -0%
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Average time to complete tasks</p>
                        </div>
                        <div class="p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                            <h3 class="font-semibold mb-2">Upcoming Deadlines</h3>
                            <div class="flex items-end">
                                <span id="upcoming-deadlines" class="text-3xl font-bold text-orange-600 dark:text-orange-400">0</span>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Tasks due in the next 48 hours</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <h3 class="font-semibold mb-3">Productivity Insights</h3>
                        <ul id="productivity-insights" class="space-y-2 text-sm">
                            <li><i class="fas fa-info-circle text-blue-500 mr-2"></i> Complete your profile to get personalized insights.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <!-- Add Task Popup -->
    <div id="add-task-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add New Task</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-task-form" class="space-y-4">
                <div>
                    <label for="task-title" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="task-title" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Task title" required>
                </div>
                <div>
                    <label for="task-description" class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="task-description" rows="3" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Task description"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-priority" class="block text-sm font-medium mb-1">Priority</label>
                        <select id="task-priority" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                            <option value="" disabled selected>Select priority</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-category" class="block text-sm font-medium mb-1">Category</label>
                        <select id="task-category" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                            <option value="" disabled selected>Select category</option>
                            <option value="work">Work</option>
                            <option value="personal">Personal</option>
                            <option value="health">Health</option>
                            <option value="education">Education</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                        <input type="datetime-local" id="task-due-date" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                    </div>
                    <div>
                        <label for="task-assign-to" class="block text-sm font-medium mb-1">Assign To</label>
                        <select id="task-assign-to" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base">
                            <option value="" selected>Select user (optional)</option>
                            <!-- User options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Subtasks</label>
                    <div id="subtasks-container" class="space-y-2"></div>
                    <button type="button" id="add-subtask" class="mt-2 text-sm text-purple-600 hover:text-purple-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i> Add Subtask
                    </button>
                </div>
                <div>
                    <label for="task-notes" class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="task-notes" rows="2" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Additional notes"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                        Save Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Users Popup -->
    <div id="users-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Users</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="search-users" class="w-full px-4 py-2 pl-10 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Search users...">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>
            <div id="users-container" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Users will be populated here -->
            </div>
        </div>
    </div>

    <!-- Profile Popup -->
    <div id="profile-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Your Profile</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <img id="profile-picture" src="" alt="Profile" class="w-32 h-32 rounded-full object-cover mb-2">
                        <button id="change-profile-pic" class="absolute bottom-0 right-0 bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-full shadow-lg transition duration-200">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <h3 id="profile-name" class="text-lg font-semibold mt-2"></h3>
                    <p id="profile-role" class="text-sm text-gray-500 dark:text-gray-400"></p>
                </div>
                <div class="flex-1">
                    <form id="edit-profile-form" class="space-y-4">
                        <div>
                            <label for="edit-name" class="block text-sm font-medium mb-1">Name</label>
                            <input type="text" id="edit-name" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                        </div>
                        <div>
                            <label for="edit-email" class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="edit-email" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                        </div>
                        <div>
                            <label for="edit-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                            <input type="tel" id="edit-phone" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                        </div>
                        <div>
                            <label for="edit-country" class="block text-sm font-medium mb-1">Country</label>
                            <select id="edit-country" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                                <option value="USA">United States</option>
                                <option value="CAN">Canada</option>
                                <option value="UK">United Kingdom</option>
                                <option value="AUS">Australia</option>
                                <option value="DEU">Germany</option>
                                <option value="FRA">France</option>
                                <option value="JPN">Japan</option>
                                <option value="CHN">China</option>
                                <option value="IND">India</option>
                                <option value="BRA">Brazil</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-role" class="block text-sm font-medium mb-1">Role</label>
                            <select id="edit-role" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" required>
                                <option value="Manager">Manager</option>
                                <option value="Admin">Admin</option>
                                <option value="Staff">Staff</option>
                                <option value="Customer">Customer</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-password" class="block text-sm font-medium mb-1">Password</label>
                            <input type="password" id="edit-password" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Leave blank to keep current password">
                        </div>
                        <div>
                            <label for="confirm-edit-password" class="block text-sm font-medium mb-1">Confirm Password</label>
                            <input type="password" id="confirm-edit-password" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Leave blank to keep current password">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Popup -->
    <div id="import-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Import Tasks</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Import your tasks from a JSON file. The file should contain an array of task objects.
                </p>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-6 text-center">
                    <i class="fas fa-file-upload text-gray-400 text-3xl mb-2"></i>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Drag and drop your JSON file here or</p>
                    <label class="cursor-pointer">
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <span class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200 inline-block">
                            Browse Files
                        </span>
                    </label>
                </div>
                <div id="import-preview" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Preview:</h3>
                    <div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg max-h-40 overflow-y-auto">
                        <pre id="import-preview-content" class="text-xs whitespace-pre-wrap"></pre>
                    </div>
                    <p id="import-count" class="text-sm text-gray-600 dark:text-gray-400 mt-2"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                    Cancel
                </button>
                <button id="do-import" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200" disabled>
                    Import Tasks
                </button>
            </div>
        </div>
    </div>

    <!-- Export Popup -->
    <div id="export-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Export Tasks</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Export your tasks for backup or sharing purposes. Choose the format below.
                </p>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition duration-200">
                        <input type="radio" name="export-format" value="json" class="mr-3" checked>
                        <div>
                            <span class="font-medium">JSON Format</span>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Best for data backup or importing into another app.</p>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition duration-200">
                        <input type="radio" name="export-format" value="csv" class="mr-3">
                        <div>
                            <span class="font-medium">CSV Format</span>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Good for opening in spreadsheet applications.</p>
                        </div>
                    </label>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-1">Export Options</label>
                    <div class="space-y-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="export-completed" class="mr-2" checked>
                            Include completed tasks
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="export-current-filter" class="mr-2">
                            Apply current filters
                        </label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                    Cancel
                </button>
                <button id="do-export" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Share Task Popup -->
    <div id="share-task-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Share Task</h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <div id="share-task-details" class="mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h3 id="share-task-title" class="font-semibold"></h3>
                    <p id="share-task-description" class="text-sm text-gray-600 dark:text-gray-400 mt-1"></p>
                </div>
                <div>
                    <label for="share-task-to" class="block text-sm font-medium mb-1">Share with</label>
                    <select id="share-task-to" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" multiple>
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="mt-4">
                    <label for="share-task-message" class="block text-sm font-medium mb-1">Message (optional)</label>
                    <textarea id="share-task-message" rows="2" class="w-full px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Add a message..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                    Cancel
                </button>
                <button id="do-share-task" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                    Share
                </button>
            </div>
        </div>
    </div>

    <!-- View Task Popup -->
    <div id="view-task-popup" class="popup">
        <div class="popup-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" id="view-task-title"></h2>
                <button class="close-popup text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Description</h3>
                    <p id="view-task-description" class="mt-1"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Priority</h3>
                        <p id="view-task-priority" class="mt-1"></p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Category</h3>
                        <p id="view-task-category" class="mt-1"></p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Assigned To</h3>
                        <p id="view-task-assigned" class="mt-1"></p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Due Date</h3>
                        <p id="view-task-due-date" class="mt-1"></p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Status</h3>
                        <p id="view-task-status" class="mt-1"></p>
                    </div>
                </div>
                <div id="view-task-subtasks-section">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Subtasks</h3>
                    <ul id="view-task-subtasks" class="space-y-2"></ul>
                </div>
                <div id="view-task-notes-section">
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Notes</h3>
                    <p id="view-task-notes" class="mt-1"></p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Time Tracked</h3>
                    <p id="view-task-time-tracked" class="mt-1"></p>
                </div>
            </div>
            <div class="flex justify-between mt-6">
                <div>
                    <button id="delete-task-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200">
                        Delete
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button class="close-popup px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition duration-200">
                        Close
                    </button>
                    <button id="edit-task-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                        Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Popup -->
    <div id="notification-popup" class="notification-popup">
        <div class="flex items-start">
            <i id="notification-icon" class="fas fa-info-circle mr-3 mt-1"></i>
            <div class="flex-1">
                <h4 id="notification-title" class="font-semibold"></h4>
                <p id="notification-message" class="text-sm text-gray-600 dark:text-gray-400"></p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let tasks = [];
        let users = [];
        let notifications = [];
        let currentStatus = 'logout';
        let workTimer = { start: null, elapsed: 0, interval: null };
        let taskTimers = {};
        let undoStack = [];
        let redoStack = [];
        let currentTaskId = null;
        const profileImages = [
            'https://i.imgur.com/8Km9tLL.jpg',
            'https://i.imgur.com/ZTkt4I5.jpg',
            'https://i.imgur.com/0Gkhl1j.jpg',
            'https://i.imgur.com/MoKwSLm.jpg',
            'https://i.imgur.com/TUhCrsY.jpg',
            'https://i.imgur.com/FHLSiSq.jpg'
        ];

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function formatDate(date) {
            return new Date(date).toLocaleString();
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function getRandomDate(start, end) {
            return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
        }

        function getPriorityClass(priority) {
            return {
                'high': 'task-priority-high',
                'medium': 'task-priority-medium',
                'low': 'task-priority-low'
            }[priority.toLowerCase()] || 'task-priority-low';
        }

        function getDueDateAlert(dueDate) {
            const now = new Date();
            const due = new Date(dueDate);
            const diffHours = (due - now) / (1000 * 60 * 60);
            
            if (diffHours < 0) return 'text-red-500';
            if (diffHours < 48) return 'text-yellow-500';
            return 'text-green-500';
        }

        function saveToLocalStorage() {
            localStorage.setItem('todo_app_users', JSON.stringify(users));
            localStorage.setItem('todo_app_tasks', JSON.stringify(tasks));
            localStorage.setItem('todo_app_notifications', JSON.stringify(notifications));
            if (currentUser) {
                localStorage.setItem('todo_app_current_user', JSON.stringify(currentUser));
                localStorage.setItem('todo_app_status', currentStatus);
                localStorage.setItem('todo_app_work_timer', JSON.stringify({
                    elapsed: workTimer.elapsed + (workTimer.start ? (Date.now() - workTimer.start) / 1000 : 0),
                    start: workTimer.start ? Date.now() : null
                }));
            }
        }

        function loadFromLocalStorage() {
            const storedUsers = localStorage.getItem('todo_app_users');
            const storedTasks = localStorage.getItem('todo_app_tasks');
            const storedNotifications = localStorage.getItem('todo_app_notifications');
            const storedCurrentUser = localStorage.getItem('todo_app_current_user');
            const storedStatus = localStorage.getItem('todo_app_status');
            const storedWorkTimer = localStorage.getItem('todo_app_work_timer');
            
            if (storedUsers) users = JSON.parse(storedUsers);
            if (storedTasks) tasks = JSON.parse(storedTasks);
            if (storedNotifications) notifications = JSON.parse(storedNotifications);
            if (storedCurrentUser) {
                currentUser = JSON.parse(storedCurrentUser);
                if (storedStatus) currentStatus = storedStatus;
                if (storedWorkTimer) {
                    const parsed = JSON.parse(storedWorkTimer);
                    workTimer.elapsed = parsed.elapsed;
                    workTimer.start = parsed.start;
                }
                
                // If the page is loaded and the user is still logged in, show the app
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // Update UI based on loaded data
                updateProfileUI();
                updateTasksUI();
                updateNotifications();
                
                // Start the work timer if the status is 'login'
                if (currentStatus === 'login' && workTimer.start) {
                    startWorkTimer();
                }
            }
            
            // Generate random data if none exists
            if (users.length === 0) {
                generateRandomUsers();
            }
            if (tasks.length === 0) {
                generateRandomTasks();
            }
        }

        // Authentication functions
        function registerUser(userData) {
            const existingUser = users.find(u => u.email === userData.email);
            if (existingUser) {
                return { success: false, message: 'Email already exists' };
            }
            
            const newUser = {
                id: generateId(),
                name: userData.name,
                email: userData.email,
                password: userData.password,
                phone: userData.phone,
                country: userData.country,
                role: userData.role,
                profileImage: getRandomItem(profileImages),
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            saveToLocalStorage();
            return { success: true, user: newUser };
        }

        function loginUser(email, password) {
            const user = users.find(u => u.email === email && u.password === password);
            if (!user) {
                return { success: false, message: 'Invalid credentials' };
            }
            
            currentUser = user;
            changeStatus('login');
            saveToLocalStorage();
            return { success: true, user };
        }

        function logoutUser() {
            changeStatus('logout');
            stopWorkTimer();
            currentUser = null;
            localStorage.removeItem('todo_app_current_user');
            localStorage.removeItem('todo_app_status');
            localStorage.removeItem('todo_app_work_timer');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');
        }

        // Status functions
        function changeStatus(status) {
            // Stop current timer
            stopWorkTimer();
            
            // Change status
            currentStatus = status;
            
            // Update UI
            updateProfileStatus();
            
            // Start timer if login
            if (status === 'login') {
                startWorkTimer();
            }
            
            saveToLocalStorage();
            
            // Add notification
            addNotification({
                title: 'Status Changed',
                message: `Your status is now: ${status}`,
                type: 'info',
                time: new Date().toISOString()
            });
        }

        function updateProfileStatus() {
            const profileImage = document.getElementById('profile-image');
            profileImage.classList.remove('profile-status-green', 'profile-status-red', 'profile-status-yellow', 'profile-status-grey');
            
            switch (currentStatus) {
                case 'login':
                    profileImage.classList.add('profile-status-green');
                    break;
                case 'logout':
                    profileImage.classList.add('profile-status-red');
                    break;
                case 'break':
                    profileImage.classList.add('profile-status-yellow');
                    break;
                case 'shadow':
                    profileImage.classList.add('profile-status-grey');
                    break;
            }
        }

        // Timer functions
        function startWorkTimer() {
            stopWorkTimer();
            
            workTimer.start = Date.now();
            workTimer.interval = setInterval(() => {
                updateTimerDisplay();
            }, 1000);
        }

        function stopWorkTimer() {
            if (workTimer.interval) {
                clearInterval(workTimer.interval);
                
                if (workTimer.start) {
                    workTimer.elapsed += (Date.now() - workTimer.start) / 1000;
                    workTimer.start = null;
                }
            }
        }

        function updateTimerDisplay() {
            const elapsed = workTimer.elapsed + (workTimer.start ? (Date.now() - workTimer.start) / 1000 : 0);
            const formattedTime = formatDuration(elapsed);
            document.getElementById('work-timer').textContent = formattedTime;
            document.getElementById('mobile-work-timer').textContent = formattedTime;
        }

        function resetDailyTimer() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setUTCHours(24, 0, 0, 0);
            const timeUntilMidnight = midnight - now;
            
            setTimeout(() => {
                workTimer.elapsed = 0;
                if (workTimer.start) {
                    workTimer.start = Date.now();
                }
                updateTimerDisplay();
                resetDailyTimer(); // Set the next day's reset
                saveToLocalStorage();
            }, timeUntilMidnight);
        }

        // Task functions
        function addTask(taskData) {
            const newTask = {
                id: generateId(),
                title: taskData.title,
                description: taskData.description || '',
                priority: taskData.priority,
                category: taskData.category,
                dueDate: taskData.dueDate,
                assignedTo: taskData.assignedTo || null,
                subtasks: taskData.subtasks || [],
                notes: taskData.notes || '',
                completed: false,
                timeTracked: 0,
                timerRunning: false,
                timerStart: null,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.id
            };
            
            addToUndoStack('add', null, newTask);
            tasks.push(newTask);
            
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
            
            addNotification({
                title: 'Task Added',
                message: `New task "${taskData.title}" created`,
                type: 'success',
                time: new Date().toISOString()
            });
            
            // Check due date and add notification if it's soon
            const dueDate = new Date(taskData.dueDate);
            const now = new Date();
            const diffHours = (dueDate - now) / (1000 * 60 * 60);
            
            if (diffHours > 0 && diffHours <= 48) {
                addNotification({
                    title: 'Upcoming Deadline',
                    message: `Task "${taskData.title}" is due in less than 48 hours`,
                    type: 'warning',
                    time: new Date().toISOString()
                });
            }
            
            return newTask;
        }

        function updateTask(taskId, taskData) {
            const index = tasks.findIndex(t => t.id === taskId);
            if (index === -1) return null;
            
            const oldTask = {...tasks[index]};
            
            // Update task
            tasks[index] = {
                ...tasks[index],
                ...taskData,
                updatedAt: new Date().toISOString()
            };
            
            addToUndoStack('update', oldTask, tasks[index]);
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
            
            return tasks[index];
        }

        function deleteTask(taskId) {
            const index = tasks.findIndex(t => t.id === taskId);
            if (index === -1) return false;
            
            const deletedTask = tasks[index];
            addToUndoStack('delete', deletedTask, null);
            
            // Stop timer if running
            if (deletedTask.timerRunning) {
                stopTaskTimer(taskId);
            }
            
            tasks.splice(index, 1);
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
            
            addNotification({
                title: 'Task Deleted',
                message: `Task "${deletedTask.title}" was deleted`,
                type: 'info',
                time: new Date().toISOString()
            });
            
            return true;
        }

        function toggleTaskCompletion(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const oldTask = {...task};
            task.completed = !task.completed;
            task.updatedAt = new Date().toISOString();
            
            if (task.completed) {
                // Stop timer if running
                if (task.timerRunning) {
                    stopTaskTimer(taskId);
                }
                
                addNotification({
                    title: 'Task Completed',
                    message: `Task "${task.title}" marked as complete`,
                    type: 'success',
                    time: new Date().toISOString()
                });
            } else {
                addNotification({
                    title: 'Task Reopened',
                    message: `Task "${task.title}" marked as incomplete`,
                    type: 'info',
                    time: new Date().toISOString()
                });
            }
            
            addToUndoStack('update', oldTask, task);
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
        }

        function toggleSubtaskCompletion(taskId, subtaskIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.subtasks[subtaskIndex]) return;
            
            const oldTask = {...task, subtasks: [...task.subtasks]};
            task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
            task.updatedAt = new Date().toISOString();
            
            addToUndoStack('update', oldTask, task);
            saveToLocalStorage();
            updateTasksUI();
        }

        function startTaskTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Stop any running timers
            tasks.forEach(t => {
                if (t.timerRunning && t.id !== taskId) {
                    stopTaskTimer(t.id);
                }
            });
            
            const oldTask = {...task};
            task.timerRunning = true;
            task.timerStart = Date.now();
            
            addToUndoStack('update', oldTask, task);
            saveToLocalStorage();
            
            // Start timer interval
            if (taskTimers[taskId]) {
                clearInterval(taskTimers[taskId]);
            }
            
            taskTimers[taskId] = setInterval(() => {
                updateTaskTimerDisplay(taskId);
            }, 1000);
            
            updateTaskTimerDisplay(taskId);
        }

        function stopTaskTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || !task.timerRunning) return;
            
            const oldTask = {...task};
            
            if (task.timerStart) {
                task.timeTracked += (Date.now() - task.timerStart) / 1000;
                task.timerStart = null;
            }
            
            task.timerRunning = false;
            
            addToUndoStack('update', oldTask, task);
            saveToLocalStorage();
            
            // Clear interval
            if (taskTimers[taskId]) {
                clearInterval(taskTimers[taskId]);
                delete taskTimers[taskId];
            }
            
            updateTaskTimerDisplay(taskId);
        }

        function updateTaskTimerDisplay(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const timerElement = document.querySelector(`#task-${taskId} .task-timer`);
            if (!timerElement) return;
            
            let elapsed = task.timeTracked;
            if (task.timerRunning && task.timerStart) {
                elapsed += (Date.now() - task.timerStart) / 1000;
            }
            
            timerElement.textContent = formatDuration(elapsed);
        }

        // Undo/Redo functions
        function addToUndoStack(action, oldData, newData) {
            undoStack.push({ action, oldData, newData });
            
            // Limit stack size
            if (undoStack.length > 20) {
                undoStack.shift();
            }
            
            // Clear redo stack when a new action is performed
            redoStack = [];
            
            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length === 0) return;
            
            const action = undoStack.pop();
            redoStack.push(action);
            
            switch (action.action) {
                case 'add':
                    // Remove added task
                    const addIndex = tasks.findIndex(t => t.id === action.newData.id);
                    if (addIndex !== -1) tasks.splice(addIndex, 1);
                    break;
                    
                case 'update':
                    // Restore previous state
                    const updateIndex = tasks.findIndex(t => t.id === action.oldData.id);
                    if (updateIndex !== -1) tasks[updateIndex] = action.oldData;
                    break;
                    
                case 'delete':
                    // Restore deleted task
                    tasks.push(action.oldData);
                    break;
            }
            
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
            updateUndoRedoButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            
            const action = redoStack.pop();
            undoStack.push(action);
            
            switch (action.action) {
                case 'add':
                    // Add the task again
                    tasks.push(action.newData);
                    break;
                    
                case 'update':
                    // Apply the update again
                    const updateIndex = tasks.findIndex(t => t.id === action.newData.id);
                    if (updateIndex !== -1) tasks[updateIndex] = action.newData;
                    break;
                    
                case 'delete':
                    // Delete the task again
                    const deleteIndex = tasks.findIndex(t => t.id === action.oldData.id);
                    if (deleteIndex !== -1) tasks.splice(deleteIndex, 1);
                    break;
            }
            
            saveToLocalStorage();
            updateTasksUI();
            updateTaskStats();
            updateInsightsView();
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            document.getElementById('undo-btn').disabled = undoStack.length === 0;
            document.getElementById('redo-btn').disabled = redoStack.length === 0;
        }

        // Notification functions
        function addNotification(notification) {
            const newNotification = {
                id: generateId(),
                title: notification.title,
                message: notification.message,
                type: notification.type || 'info',
                read: false,
                time: notification.time || new Date().toISOString()
            };
            
            notifications.unshift(newNotification);
            
            // Limit to 50 notifications
            if (notifications.length > 50) {
                notifications.pop();
            }
            
            saveToLocalStorage();
            updateNotifications();
            
            // Show toast notification
            showToastNotification(newNotification);
        }

        function markNotificationAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                saveToLocalStorage();
                updateNotifications();
            }
        }

        function updateNotifications() {
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('notification-count').textContent = unreadCount;
            document.getElementById('notification-count').style.display = unreadCount > 0 ? 'flex' : 'none';
            
            const notificationList = document.getElementById('notification-list');
            const emptyNotifications = document.getElementById('empty-notifications');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '';
                emptyNotifications.style.display = 'block';
                return;
            }
            
            emptyNotifications.style.display = 'none';
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="p-3 border-b last:border-b-0 ${notification.read ? 'opacity-60' : ''}" data-id="${notification.id}">
                    <div class="flex items-start">
                        <i class="fas fa-${
                            notification.type === 'success' ? 'check-circle text-green-500' :
                            notification.type === 'warning' ? 'exclamation-triangle text-yellow-500' :
                            notification.type === 'danger' ? 'exclamation-circle text-red-500' :
                            'info-circle text-blue-500'
                        } mt-1 mr-2"></i>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold text-sm">${notification.title}</h4>
                                <span class="text-xs text-gray-500">${formatDate(notification.time)}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${notification.message}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click event to mark notifications as read
            notificationList.querySelectorAll('[data-id]').forEach(el => {
                el.addEventListener('click', () => {
                    markNotificationAsRead(el.dataset.id);
                });
            });
        }

        function showToastNotification(notification) {
            const popup = document.getElementById('notification-popup');
            const title = document.getElementById('notification-title');
            const message = document.getElementById('notification-message');
            const icon = document.getElementById('notification-icon');
            
            title.textContent = notification.title;
            message.textContent = notification.message;
            
            // Set icon
            icon.className = 'fas mr-3 mt-1 ';
            
            popup.className = 'notification-popup';
            
            switch(notification.type) {
                case 'success':
                    icon.className += 'fa-check-circle text-green-500';
                    popup.classList.add('success');
                    break;
                case 'warning':
                    icon.className += 'fa-exclamation-triangle text-yellow-500';
                    popup.classList.add('warning');
                    break;
                case 'danger':
                    icon.className += 'fa-exclamation-circle text-red-500';
                    popup.classList.add('danger');
                    break;
                default:
                    icon.className += 'fa-info-circle text-blue-500';
                    popup.classList.add('info');
            }
            
            // Show notification
            popup.classList.add('show');
            
            // Hide after 5 seconds
            setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        // UI update functions
        function updateProfileUI() {
            if (!currentUser) return;
            
            // Update profile image
            const profileImage = document.getElementById('profile-image');
            profileImage.src = currentUser.profileImage;
            
            // Update profile status
            updateProfileStatus();
            
            // Update timer display
            updateTimerDisplay();
            
            // Populate user fields in add task form
            const taskAssignSelect = document.getElementById('task-assign-to');
            taskAssignSelect.innerHTML = `<option value="" selected>Select user (optional)</option>`;
            users.forEach(user => {
                taskAssignSelect.innerHTML += `<option value="${user.id}">${user.name}</option>`;
            });
        }

        function updateTasksUI() {
            const tasksContainer = document.getElementById('tasks-container');
            const filteredTasks = filterTasks();
            
            if (filteredTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div class="text-center p-8 text-gray-500">
                        No tasks found. Click "+ Add Task" to create your first task.
                    </div>
                `;
                return;
            }
            
            tasksContainer.innerHTML = filteredTasks.map(task => {
                // Determine if there are upcoming deadlines
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const diffHours = (dueDate - now) / (1000 * 60 * 60);
                
                const dueDateClass = diffHours < 0 ? 'text-red-500' :
                                     diffHours < 48 ? 'text-yellow-500' :
                                     'text-green-500';
                                     
                // Calculate completion percentage for subtasks
                const completedSubtasks = task.subtasks ? task.subtasks.filter(s => s.completed).length : 0;
                const totalSubtasks = task.subtasks ? task.subtasks.length : 0;
                const subtaskPercentage = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
                
                // Get assigned user
                const assignedUser = task.assignedTo ? users.find(u => u.id === task.assignedTo) : null;
                
                return `
                    <div id="task-${task.id}" class="task-item card p-4 rounded-lg shadow ${getPriorityClass(task.priority)} ${task.completed ? 'task-completed' : ''}" draggable="true" data-id="${task.id}">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="flex-1">
                                <div class="flex items-start mb-2">
                                    <div class="flex-shrink-0 mt-1">
                                        <input type="checkbox" class="task-checkbox w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" ${task.completed ? 'checked' : ''}>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-lg font-semibold ${task.completed ? 'line-through opacity-70' : ''}">${task.title}</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${task.description}</p>
                                        <div class="flex flex-wrap gap-2 text-xs mb-2">
                                            <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 rounded">${task.category}</span>
                                            <span class="px-2 py-1 rounded ${
                                                task.priority === 'high' ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200' :
                                                task.priority === 'medium' ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200' :
                                                'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                                            }">${task.priority}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${task.subtasks && task.subtasks.length > 0 ? `
                                    <div class="ml-8 mb-3">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs text-gray-500">Subtasks (${completedSubtasks}/${totalSubtasks})</span>
                                            <span class="text-xs text-gray-500">${subtaskPercentage}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                                            <div class="bg-purple-600 h-1.5 rounded-full" style="width: ${subtaskPercentage}%"></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex items-center space-x-1 md:space-x-2">
                                <button class="task-timer-toggle p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 ${task.timerRunning ? 'text-red-500' : 'text-gray-500'}">
                                    <i class="fas ${task.timerRunning ? 'fa-pause' : 'fa-play'}"></i>
                                </button>
                                <span class="task-timer font-mono text-sm px-2">${formatDuration(task.timeTracked)}</span>
                                <button class="task-share-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="task-options-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap justify-between mt-2 pt-2 border-t border-gray-200 dark:border-gray-700 text-sm">
                            <div class="flex items-center">
                                <i class="far fa-calendar mr-1 ${dueDateClass}"></i>
                                <span class="${dueDateClass}">${formatDate(task.dueDate)}</span>
                            </div>
                            ${assignedUser ? `
                                <div class="flex items-center">
                                    <img src="${assignedUser.profileImage}" alt="${assignedUser.name}" class="w-5 h-5 rounded-full mr-1">
                                    <span>${assignedUser.name}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners to tasks
            filteredTasks.forEach(task => {
                const taskElement = document.getElementById(`task-${task.id}`);
                if (!taskElement) return;
                
                // Checkbox for completing tasks
                const checkbox = taskElement.querySelector('.task-checkbox');
                checkbox.addEventListener('change', () => {
                    toggleTaskCompletion(task.id);
                });
                
                // Timer toggle
                const timerToggle = taskElement.querySelector('.task-timer-toggle');
                timerToggle.addEventListener('click', () => {
                    if (task.timerRunning) {
                        stopTaskTimer(task.id);
                    } else {
                        startTaskTimer(task.id);
                    }
                });
                
                // Share button
                const shareBtn = taskElement.querySelector('.task-share-btn');
                shareBtn.addEventListener('click', () => {
                    openShareTaskPopup(task.id);
                });
                
                // Options button (view/edit/delete)
                const optionsBtn = taskElement.querySelector('.task-options-btn');
                optionsBtn.addEventListener('click', () => {
                    openViewTaskPopup(task.id);
                });
                
                // Make task draggable
                taskElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', task.id);
                    taskElement.classList.add('dragging');
                });
                
                taskElement.addEventListener('dragend', () => {
                    taskElement.classList.remove('dragging');
                });
                
                // Click to view task
                taskElement.addEventListener('click', (e) => {
                    // Only open view if the click wasn't on a button or checkbox
                    if (!e.target.closest('button') && !e.target.closest('input[type="checkbox"]')) {
                        openViewTaskPopup(task.id);
                    }
                });
            });
            
            // Add drop zone for drag-and-drop reordering
            tasksContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggable = document.querySelector('.dragging');
                if (!draggable) return;
                
                const afterElement = getDragAfterElement(tasksContainer, e.clientY);
                if (afterElement) {
                    tasksContainer.insertBefore(draggable, afterElement);
                } else {
                    tasksContainer.appendChild(draggable);
                }
            });
            
            tasksContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const taskId = e.dataTransfer.getData('text/plain');
                const draggable = document.getElementById(`task-${taskId}`);
                if (!draggable) return;
                
                // Update task order in the array
                const newTasks = Array.from(tasksContainer.querySelectorAll('.task-item'))
                    .map(elem => tasks.find(t => t.id === elem.dataset.id))
                    .filter(t => t !== undefined);
                
                // Combine with tasks not in the current view
                const tasksNotInView = tasks.filter(t => !newTasks.some(nt => nt.id === t.id));
                tasks = [...newTasks, ...tasksNotInView];
                
                saveToLocalStorage();
            });
            
            // Update task timers for visible tasks
            filteredTasks.forEach(task => {
                if (task.timerRunning) {
                    updateTaskTimerDisplay(task.id);
                    
                    // Make sure timer is running
                    if (!taskTimers[task.id]) {
                        taskTimers[task.id] = setInterval(() => {
                            updateTaskTimerDisplay(task.id);
                        }, 1000);
                    }
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateTaskStats() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            const pendingTasks = totalTasks - completedTasks;
            
            document.getElementById('total-tasks-count').textContent = totalTasks;
            document.getElementById('completed-tasks-count').textContent = completedTasks;
            document.getElementById('pending-tasks-count').textContent = pendingTasks;
            
            // Update charts if graph view is active
            if (!document.getElementById('graph-view').classList.contains('hidden')) {
                updateCharts();
            }
        }

        function updateCharts() {
            // Status Chart
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            const completedTasks = tasks.filter(t => t.completed).length;
            const pendingTasks = tasks.length - completedTasks;
            
            if (window.statusChart) {
                window.statusChart.data.datasets[0].data = [completedTasks, pendingTasks];
                window.statusChart.update();
            } else {
                window.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completedTasks, pendingTasks],
                            backgroundColor: ['#10B981', '#F59E0B'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    color: document.documentElement.classList.contains('dark-mode') ? '#F3F4F6' : '#1F2937'
                                }
                            }
                        }
                    }
                });
            }
            
            // Priority Chart
            const priorityCtx = document.getElementById('priority-chart').getContext('2d');
            const highTasks = tasks.filter(t => t.priority === 'high').length;
            const mediumTasks = tasks.filter(t => t.priority === 'medium').length;
            const lowTasks = tasks.filter(t => t.priority === 'low').length;
            
            if (window.priorityChart) {
                window.priorityChart.data.datasets[0].data = [highTasks, mediumTasks, lowTasks];
                window.priorityChart.update();
            } else {
                window.priorityChart = new Chart(priorityCtx, {
                    type: 'pie',
                    data: {
                        labels: ['High', 'Medium', 'Low'],
                        datasets: [{
                            data: [highTasks, mediumTasks, lowTasks],
                            backgroundColor: ['#EF4444', '#F59E0B', '#9CA3AF'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    color: document.documentElement.classList.contains('dark-mode') ? '#F3F4F6' : '#1F2937'
                                }
                            }
                        }
                    }
                });
            }
            
            // Timeline Chart
            const timelineCtx = document.getElementById('timeline-chart').getContext('2d');
            
            // Group tasks by due date (month)
            const now = new Date();
            const monthsData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Initialize with the next 6 months
            for (let i = 0; i < 6; i++) {
                const month = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthKey = `${month.getFullYear()}-${month.getMonth()}`;
                monthsData[monthKey] = { 
                    label: `${monthNames[month.getMonth()]} ${month.getFullYear()}`,
                    pending: 0, 
                    completed: 0 
                };
            }
            
            // Count tasks by month
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const monthKey = `${dueDate.getFullYear()}-${dueDate.getMonth()}`;
                
                if (monthsData[monthKey]) {
                    if (task.completed) {
                        monthsData[monthKey].completed++;
                    } else {
                        monthsData[monthKey].pending++;
                    }
                }
            });
            
            const timelineLabels = Object.values(monthsData).map(m => m.label);
            const pendingData = Object.values(monthsData).map(m => m.pending);
            const completedData = Object.values(monthsData).map(m => m.completed);
            
            if (window.timelineChart) {
                window.timelineChart.data.labels = timelineLabels;
                window.timelineChart.data.datasets[0].data = completedData;
                window.timelineChart.data.datasets[1].data = pendingData;
                window.timelineChart.update();
            } else {
                window.timelineChart = new Chart(timelineCtx, {
                    type: 'bar',
                    data: {
                        labels: timelineLabels,
                        datasets: [{
                            label: 'Completed',
                            data: completedData,
                            backgroundColor: '#10B981',
                            borderWidth: 0
                        }, {
                            label: 'Pending',
                            data: pendingData,
                            backgroundColor: '#F59E0B',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark-mode') ? '#F3F4F6' : '#1F2937'
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                grid: {
                                    color: document.documentElement.classList.contains('dark-mode') ? 'rgba(243, 244, 246, 0.1)' : 'rgba(31, 41, 55, 0.1)'
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark-mode') ? '#F3F4F6' : '#1F2937'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20,
                                    color: document.documentElement.classList.contains('dark-mode') ? '#F3F4F6' : '#1F2937'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateInsightsView() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.completed).length;
            
            // Productivity score
            const productivityScore = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('productivity-score').textContent = `${productivityScore}%`;
            
            // Random trend for demo
            const trend = Math.floor(Math.random() * 10) + 1;
            document.getElementById('productivity-trend').innerHTML = `
                <i class="fas fa-arrow-${Math.random() > 0.5 ? 'up' : 'down'}"></i> ${Math.random() > 0.5 ? '+' : '-'}${trend}%
            `;
            
            // Average completion time
            const completedTasksWithTime = tasks.filter(t => t.completed && t.timeTracked > 0);
            let avgTime = 0;
            
            if (completedTasksWithTime.length > 0) {
                avgTime = completedTasksWithTime.reduce((sum, task) => sum + task.timeTracked, 0) / completedTasksWithTime.length;
            }
            
            const hours = Math.floor(avgTime / 3600);
            document.getElementById('avg-completion-time').textContent = `${hours}h`;
            
            // Completion trend
            document.getElementById('completion-trend').innerHTML = `
                <i class="fas fa-arrow-${Math.random() > 0.5 ? 'up' : 'down'}"></i> ${Math.random() > 0.5 ? '+' : '-'}${Math.floor(Math.random() * 20) + 5}%
            `;
            
            // Upcoming deadlines
            const now = new Date();
            const upcoming = tasks.filter(task => {
                if (task.completed) return false;
                
                const dueDate = new Date(task.dueDate);
                const diffHours = (dueDate - now) / (1000 * 60 * 60);
                return diffHours > 0 && diffHours <= 48;
            }).length;
            
            document.getElementById('upcoming-deadlines').textContent = upcoming;
            
            // Productivity insights
            let insights = [];
            
            if (totalTasks === 0) {
                insights.push('Add your first task to get started with productivity tracking.');
            } else {
                if (productivityScore < 30) {
                    insights.push('Your task completion rate is low. Try breaking down large tasks into smaller, more manageable subtasks.');
                } else if (productivityScore > 70) {
                    insights.push('Great job maintaining a high completion rate!');
                }
                
                if (upcoming > 0) {
                    insights.push(`You have ${upcoming} task${upcoming === 1 ? '' : 's'} due within the next 48 hours.`);
                }
                
                if (completedTasksWithTime.length > 0) {
                    insights.push(`You spend an average of ${hours} hours on each completed task.`);
                }
                
                const highPriorityTasks = tasks.filter(t => !t.completed && t.priority === 'high').length;
                if (highPriorityTasks > 0) {
                    insights.push(`You have ${highPriorityTasks} high-priority tasks that need attention.`);
                }
            }
            
            // Add a random tip
            const tips = [
                'Focus on one task at a time for better productivity.',
                'Take short breaks between tasks to maintain focus.',
                'Consider using the Pomodoro Technique: 25 minutes of work followed by a 5-minute break.',
                'Prioritize tasks using the Eisenhower Matrix (Urgent/Important).',
                'Review your completed tasks to celebrate your progress.'
            ];
            
            insights.push(`<i class="fas fa-lightbulb text-yellow-500 mr-2"></i> ${getRandomItem(tips)}`);
            
            document.getElementById('productivity-insights').innerHTML = insights.map(insight => 
                `<li><i class="fas fa-info-circle text-blue-500 mr-2"></i> ${insight}</li>`
            ).join('');
        }

        function filterTasks() {
            const searchTerm = document.getElementById('search-tasks').value.toLowerCase();
            const category = document.getElementById('filter-category').value;
            const priority = document.getElementById('filter-priority').value;
            const status = document.getElementById('filter-status').value;
            const dueDate = document.getElementById('filter-due-date').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const sortBy = document.getElementById('sort-tasks').value;
            
            let filtered = [...tasks];
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(task => {
                    return task.title.toLowerCase().includes(searchTerm) || 
                           task.description.toLowerCase().includes(searchTerm);
                });
            }
            
            // Filter by category
            if (category !== 'all') {
                filtered = filtered.filter(task => task.category === category);
            }
            
            // Filter by priority
            if (priority !== 'all') {
                filtered = filtered.filter(task => task.priority === priority);
            }
            
            // Filter by status
            if (status !== 'all') {
                filtered = filtered.filter(task => {
                    if (status === 'active') return !task.completed;
                    if (status === 'completed') return task.completed;
                    return true;
                });
            }
            
            // Filter by due date
            if (dueDate !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                const nextMonth = new Date(today);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                
                filtered = filtered.filter(task => {
                    const taskDueDate = new Date(task.dueDate);
                    
                    switch (dueDate) {
                        case 'today':
                            return taskDueDate >= today && taskDueDate < tomorrow;
                        case 'week':
                            return taskDueDate >= today && taskDueDate < nextWeek;
                        case 'month':
                            return taskDueDate >= today && taskDueDate < nextMonth;
                        case 'custom':
                            if (dateFrom && dateTo) {
                                const from = new Date(dateFrom);
                                const to = new Date(dateTo);
                                to.setDate(to.getDate() + 1); // Include the end date
                                return taskDueDate >= from && taskDueDate < to;
                            }
                            return true;
                        default:
                            return true;
                    }
                });
            }
            
            // Sort tasks
            const [sortKey, sortDirection] = sortBy.split('-');
            
            filtered.sort((a, b) => {
                let comparison = 0;
                
                switch (sortKey) {
                    case 'dueDate':
                        comparison = new Date(a.dueDate) - new Date(b.dueDate);
                        break;
                    case 'priority':
                        const priorityValues = { 'high': 3, 'medium': 2, 'low': 1 };
                        comparison = priorityValues[a.priority] - priorityValues[b.priority];
                        break;
                    case 'title':
                        comparison = a.title.localeCompare(b.title);
                        break;
                }
                
                return sortDirection === 'asc' ? comparison : -comparison;
            });
            
            return filtered;
        }

        // Popup Functions
        function openPopup(popupId) {
            document.getElementById(popupId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeAllPopups() {
            document.querySelectorAll('.popup').forEach(popup => {
                popup.style.display = 'none';
            });
            document.body.style.overflow = 'auto';
        }

        function openAddTaskPopup() {
            // Reset form
            document.getElementById('add-task-form').reset();
            document.getElementById('subtasks-container').innerHTML = '';
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(12, 0, 0, 0);
            document.getElementById('task-due-date').value = tomorrow.toISOString().slice(0, 16);
            
            openPopup('add-task-popup');
        }

        function openViewTaskPopup(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentTaskId = taskId;
            
            // Populate task details
            document.getElementById('view-task-title').textContent = task.title;
            document.getElementById('view-task-description').textContent = task.description || 'No description provided';
            document.getElementById('view-task-priority').innerHTML = `
                <span class="px-2 py-1 rounded inline-block ${
                    task.priority === 'high' ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200' :
                    task.priority === 'medium' ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200' :
                    'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
                }">${task.priority}</span>
            `;
            document.getElementById('view-task-category').textContent = task.category;
            
            const assignedUser = task.assignedTo ? users.find(u => u.id === task.assignedTo) : null;
            document.getElementById('view-task-assigned').textContent = assignedUser ? assignedUser.name : 'Unassigned';
            
            document.getElementById('view-task-due-date').innerHTML = `
                <span class="${getDueDateAlert(task.dueDate)}">${formatDate(task.dueDate)}</span>
            `;
            
            document.getElementById('view-task-status').innerHTML = `
                <span class="px-2 py-1 rounded inline-block ${
                    task.completed ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' : 
                    'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200'
                }">${task.completed ? 'Completed' : 'Active'}</span>
            `;
            
            // Subtasks
            const subtasksSection = document.getElementById('view-task-subtasks-section');
            const subtasksList = document.getElementById('view-task-subtasks');
            
            if (task.subtasks && task.subtasks.length > 0) {
                subtasksSection.style.display = 'block';
                subtasksList.innerHTML = task.subtasks.map(subtask => `
                    <li class="flex items-center">
                        <i class="fas ${subtask.completed ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-400'} mr-2"></i>
                        <span class="${subtask.completed ? 'line-through opacity-70' : ''}">${subtask.title}</span>
                    </li>
                `).join('');
            } else {
                subtasksSection.style.display = 'none';
            }
            
            // Notes
            const notesSection = document.getElementById('view-task-notes-section');
            const notesContent = document.getElementById('view-task-notes');
            
            if (task.notes) {
                notesSection.style.display = 'block';
                notesContent.textContent = task.notes;
            } else {
                notesSection.style.display = 'none';
            }
            
            // Time tracked
            let timeTracked = task.timeTracked;
            if (task.timerRunning && task.timerStart) {
                timeTracked += (Date.now() - task.timerStart) / 1000;
            }
            
            document.getElementById('view-task-time-tracked').textContent = formatDuration(timeTracked);
            
            openPopup('view-task-popup');
        }

        function openShareTaskPopup(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentTaskId = taskId;
            
            // Populate task details
            document.getElementById('share-task-title').textContent = task.title;
            document.getElementById('share-task-description').textContent = task.description || 'No description';
            
            // Populate user list
            const selectElement = document.getElementById('share-task-to');
            selectElement.innerHTML = '';
            
            users.forEach(user => {
                if (user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    selectElement.appendChild(option);
                }
            });
            
            openPopup('share-task-popup');
        }

        function openUsersPopup() {
            const usersContainer = document.getElementById('users-container');
            usersContainer.innerHTML = '';
            
            users.forEach(user => {
                usersContainer.innerHTML += `
                    <div class="flex items-center p-3 border-b last:border-b-0">
                        <img src="${user.profileImage}" alt="${user.name}" class="w-10 h-10 rounded-full mr-3">
                        <div class="flex-1">
                            <h4 class="font-semibold">${user.name}</h4>
                            <div class="flex flex-wrap text-sm text-gray-500 dark:text-gray-400">
                                <span class="mr-3">${user.email}</span>
                                <span class="mr-3">Role: ${user.role}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            openPopup('users-popup');
        }

        // Data generation functions
        function generateRandomUsers() {
            const names = [
                'John Smith', 'Emily Johnson', 'Michael Williams', 'Sarah Brown', 'David Jones',
                'Lisa Davis', 'Robert Miller', 'Jennifer Wilson', 'James Taylor', 'Jessica Martinez'
            ];
            
            const roles = ['Manager', 'Admin', 'Staff', 'Customer'];
            const countries = ['USA', 'CAN', 'UK', 'AUS', 'DEU', 'FRA', 'JPN', 'CHN', 'IND', 'BRA'];
            
            for (let i = 0; i < 10; i++) {
                const name = names[i];
                const email = name.toLowerCase().replace(' ', '.') + '@example.com';
                
                users.push({
                    id: generateId(),
                    name,
                    email,
                    password: 'password123', // For demo purposes
                    phone: `+1 ${Math.floor(100 + Math.random() * 900)}-${Math.floor(100 + Math.random() * 900)}-${Math.floor(1000 + Math.random() * 9000)}`,
                    country: getRandomItem(countries),
                    role: getRandomItem(roles),
                    profileImage: getRandomItem(profileImages),
                    createdAt: new Date().toISOString()
                });
            }
            
            saveToLocalStorage();
        }

        function generateRandomTasks() {
            const titles = [
                'Complete project proposal', 'Review marketing materials', 'Update website content',
                'Prepare quarterly report', 'Schedule team meeting', 'Client call follow-up',
                'Finish UI design', 'Research competitors', 'Update documentation', 'Fix bugs in application',
                'Create social media posts', 'Plan product launch'
            ];
            
            const descriptions = [
                'Finalize all details before the deadline',
                'Make sure everything is up to date and accurate',
                'Include all relevant information and details',
                'Coordinate with the team for best results',
                'Ensure all requirements are met',
                'Follow up with stakeholders for feedback'
            ];
            
            const categories = ['work', 'personal', 'health', 'education', 'finance'];
            const priorities = ['high', 'medium', 'low'];
            
            const now = new Date();
            const oneMonthLater = new Date(now);
            oneMonthLater.setMonth(now.getMonth() + 1);
            
            // Generate 10 random tasks
            for (let i = 0; i < 10; i++) {
                const dueDate = getRandomDate(now, oneMonthLater);
                const isCompleted = Math.random() > 0.7; // 30% chance to be completed
                
                const subtasks = [];
                const subtaskCount = Math.floor(Math.random() * 4); // 0-3 subtasks
                
                for (let j = 0; j < subtaskCount; j++) {
                    subtasks.push({
                        id: generateId(),
                        title: `Subtask ${j + 1}`,
                        completed: Math.random() > 0.5 // 50% chance to be completed
                    });
                }
                
                tasks.push({
                    id: generateId(),
                    title: getRandomItem(titles),
                    description: getRandomItem(descriptions),
                    priority: getRandomItem(priorities),
                    category: getRandomItem(categories),
                    dueDate: dueDate.toISOString(),
                    assignedTo: Math.random() > 0.3 ? getRandomItem(users).id : null, // 70% chance to be assigned
                    subtasks,
                    notes: Math.random() > 0.5 ? 'Some notes for this task.' : '', // 50% chance to have notes
                    completed: isCompleted,
                    timeTracked: Math.floor(Math.random() * 7200), // Random time up to 2 hours
                    timerRunning: false,
                    timerStart: null,
                    createdAt: new Date(now.getTime() - Math.random() * 604800000).toISOString(), // Within the last week
                    createdBy: getRandomItem(users).id
                });
            }
            
            saveToLocalStorage();
        }

        // Event Listeners
        function setupEventListeners() {
            // Authentication
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            });
            
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            });
            
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const result = loginUser(email, password);
                
                if (result.success) {
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    updateProfileUI();
                    updateTasksUI();
                    updateTaskStats();
                    updateInsightsView();
                    addNotification({
                        title: 'Welcome Back',
                        message: `You are now logged in as ${result.user.name}`,
                        type: 'success',
                        time: new Date().toISOString()
                    });
                } else {
                    showToastNotification({
                        title: 'Login Failed',
                        message: result.message,
                        type: 'danger'
                    });
                }
            });
            
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const confirmEmail = document.getElementById('confirmEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const phone = document.getElementById('registerPhone').value;
                const country = document.getElementById('registerCountry').value;
                const role = document.getElementById('registerRole').value;
                
                // Validation
                if (email !== confirmEmail) {
                    showToastNotification({
                        title: 'Registration Error',
                        message: 'Emails do not match',
                        type: 'danger'
                    });
                    return;
                }
                
                if (password !== confirmPassword) {
                    showToastNotification({
                        title: 'Registration Error',
                        message: 'Passwords do not match',
                        type: 'danger'
                    });
                    return;
                }
                
                const result = registerUser({
                    name, email, password, phone, country, role
                });
                
                if (result.success) {
                    // Auto login
                    loginUser(email, password);
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    updateProfileUI();
                    showToastNotification({
                        title: 'Registration Successful',
                        message: 'Your account has been created and you are now logged in',
                        type: 'success'
                    });
                } else {
                    showToastNotification({
                        title: 'Registration Error',
                        message: result.message,
                        type: 'danger'
                    });
                }
            });
            
            // Theme Toggle
            document.getElementById('theme-toggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark-mode');
                if (document.documentElement.classList.contains('dark-mode')) {
                    document.body.classList.add('dark-mode');
                    document.body.classList.remove('light-mode');
                } else {
                    document.body.classList.add('light-mode');
                    document.body.classList.remove('dark-mode');
                }
                
                // Update charts if visible
                if (!document.getElementById('graph-view').classList.contains('hidden')) {
                    updateCharts();
                }
            });
            
            // Profile Dropdown
            document.getElementById('profile-button').addEventListener('click', () => {
                document.getElementById('profile-dropdown').classList.toggle('show');
            });
            
            // Status Dropdown
            document.getElementById('status-option').addEventListener('mouseenter', () => {
                document.getElementById('status-dropdown').classList.add('show');
            });
            
            document.getElementById('status-option').addEventListener('mouseleave', (e) => {
                // Only hide if not moving to the status dropdown
                if (!e.relatedTarget || !e.relatedTarget.closest('#status-dropdown')) {
                    document.getElementById('status-dropdown').classList.remove('show');
                }
            });
            
            document.getElementById('status-dropdown').addEventListener('mouseleave', () => {
                document.getElementById('status-dropdown').classList.remove('show');
            });
            
            // Status Change
            document.querySelectorAll('.status-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const status = e.currentTarget.dataset.status;
                    changeStatus(status);
                    document.getElementById('profile-dropdown').classList.remove('show');
                    document.getElementById('status-dropdown').classList.remove('show');
                });
            });
            
            // View Profile
            document.getElementById('view-profile').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('profile-dropdown').classList.remove('show');
                
                // Populate profile data
                document.getElementById('profile-picture').src = currentUser.profileImage;
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-role').textContent = currentUser.role;
                
                document.getElementById('edit-name').value = currentUser.name;
                document.getElementById('edit-email').value = currentUser.email;
                document.getElementById('edit-phone').value = currentUser.phone;
                document.getElementById('edit-country').value = currentUser.country;
                document.getElementById('edit-role').value = currentUser.role;
                
                openPopup('profile-popup');
            });
            
            // Logout
            document.getElementById('logout-button').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('profile-dropdown').classList.remove('show');
                logoutUser();
            });
            
            // Notification Dropdown
            document.getElementById('notification-button').addEventListener('click', () => {
                document.getElementById('notification-dropdown').classList.toggle('show');
            });
            
            // Close dropdowns when clicking outside
            window.addEventListener('click', (e) => {
                if (!e.target.matches('#profile-button') && !e.target.closest('#profile-dropdown')) {
                    document.getElementById('profile-dropdown').classList.remove('show');
                    document.getElementById('status-dropdown').classList.remove('show');
                }
                
                if (!e.target.matches('#notification-button') && !e.target.closest('#notification-dropdown')) {
                    document.getElementById('notification-dropdown').classList.remove('show');
                }
            });
            
            // Task Controls
            document.getElementById('add-task-btn').addEventListener('click', openAddTaskPopup);
            document.getElementById('users-btn').addEventListener('click', openUsersPopup);
            
            // View Switcher
            document.getElementById('list-view-btn').addEventListener('click', () => {
                document.getElementById('list-view-btn').classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm');
                document.getElementById('graph-view-btn').classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm');
                
                document.getElementById('list-view').classList.remove('hidden');
                document.getElementById('graph-view').classList.add('hidden');
            });
            
            document.getElementById('graph-view-btn').addEventListener('click', () => {
                document.getElementById('graph-view-btn').classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm');
                document.getElementById('list-view-btn').classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm');
                
                document.getElementById('graph-view').classList.remove('hidden');
                document.getElementById('list-view').classList.add('hidden');
                
                // Update charts
                updateCharts();
            });
            
            // Filter and Sort
            document.getElementById('filter-due-date').addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    document.getElementById('custom-date-range').classList.remove('hidden');
                    document.getElementById('sort-container').classList.add('hidden');
                } else {
                    document.getElementById('custom-date-range').classList.add('hidden');
                    document.getElementById('sort-container').classList.remove('hidden');
                }
                updateTasksUI();
            });
            
            document.getElementById('search-tasks').addEventListener('input', updateTasksUI);
            document.getElementById('filter-category').addEventListener('change', updateTasksUI);
            document.getElementById('filter-priority').addEventListener('change', updateTasksUI);
            document.getElementById('filter-status').addEventListener('change', updateTasksUI);
            document.getElementById('date-from').addEventListener('change', updateTasksUI);
            document.getElementById('date-to').addEventListener('change', updateTasksUI);
            document.getElementById('sort-tasks').addEventListener('change', updateTasksUI);
            
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('search-tasks').value = '';
                document.getElementById('filter-category').value = 'all';
                document.getElementById('filter-priority').value = 'all';
                document.getElementById('filter-status').value = 'all';
                document.getElementById('filter-due-date').value = 'all';
                document.getElementById('date-from').value = '';
                document.getElementById('date-to').value = '';
                document.getElementById('sort-tasks').value = 'dueDate-asc';
                document.getElementById('custom-date-range').classList.add('hidden');
                document.getElementById('sort-container').classList.remove('hidden');
                updateTasksUI();
            });
            
            // Undo/Redo
            document.getElementById('undo-btn').addEventListener('click', undo);
            document.getElementById('redo-btn').addEventListener('click', redo);
            
            // Add Task Form
            document.getElementById('add-task-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const title = document.getElementById('task-title').value;
                const description = document.getElementById('task-description').value;
                const priority = document.getElementById('task-priority').value;
                const category = document.getElementById('task-category').value;
                const dueDate = document.getElementById('task-due-date').value;
                const assignedTo = document.getElementById('task-assign-to').value;
                const notes = document.getElementById('task-notes').value;
                
                // Get subtasks
                const subtasks = [];
                document.querySelectorAll('.subtask-input').forEach(input => {
                    if (input.value.trim()) {
                        subtasks.push({
                            id: generateId(),
                            title: input.value.trim(),
                            completed: false
                        });
                    }
                });
                
                addTask({
                    title,
                    description,
                    priority,
                    category,
                    dueDate,
                    assignedTo: assignedTo || null,
                    subtasks,
                    notes
                });
                
                closePopup('add-task-popup');
            });
            
            // Add Subtask
            document.getElementById('add-subtask').addEventListener('click', () => {
                const subtasksContainer = document.getElementById('subtasks-container');
                const index = subtasksContainer.querySelectorAll('.subtask-item').length;
                
                const subtaskItem = document.createElement('div');
                subtaskItem.className = 'subtask-item flex items-center mt-2';
                subtaskItem.innerHTML = `
                    <input type="text" class="subtask-input flex-1 px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Subtask ${index + 1}">
                    <button type="button" class="remove-subtask ml-2 text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                subtasksContainer.appendChild(subtaskItem);
                
                // Add event listener to remove button
                subtaskItem.querySelector('.remove-subtask').addEventListener('click', () => {
                    subtaskItem.remove();
                });
                
                // Focus the new input
                subtaskItem.querySelector('input').focus();
            });
            
            // Edit Profile
            document.getElementById('edit-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const name = document.getElementById('edit-name').value;
                const email = document.getElementById('edit-email').value;
                const phone = document.getElementById('edit-phone').value;
                const country = document.getElementById('edit-country').value;
                const role = document.getElementById('edit-role').value;
                const password = document.getElementById('edit-password').value;
                const confirmPassword = document.getElementById('confirm-edit-password').value;
                
                // Validation
                if (password && password !== confirmPassword) {
                    showToastNotification({
                        title: 'Error',
                        message: 'Passwords do not match',
                        type: 'danger'
                    });
                    return;
                }
                
                // Update user
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        name,
                        email,
                        phone,
                        country,
                        role
                    };
                    
                    if (password) {
                        users[userIndex].password = password;
                    }
                    
                    currentUser = users[userIndex];
                    saveToLocalStorage();
                    updateProfileUI();
                    
                    showToastNotification({
                        title: 'Profile Updated',
                        message: 'Your profile has been updated successfully',
                        type: 'success'
                    });
                    
                    closePopup('profile-popup');
                }
            });
            
            // Change Profile Picture
            document.getElementById('change-profile-pic').addEventListener('click', () => {
                // For demo purposes, just assign a random image
                const newImage = getRandomItem(profileImages);
                document.getElementById('profile-picture').src = newImage;
                
                // Update user
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].profileImage = newImage;
                    currentUser = users[userIndex];
                    document.getElementById('profile-image').src = newImage;
                    saveToLocalStorage();
                    
                    showToastNotification({
                        title: 'Profile Picture Updated',
                        message: 'Your profile picture has been updated',
                        type: 'success'
                    });
                }
            });
            
            // View Task Actions
            document.getElementById('edit-task-btn').addEventListener('click', () => {
                closePopup('view-task-popup');
                
                // Populate edit form
                const task = tasks.find(t => t.id === currentTaskId);
                if (!task) return;
                
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-priority').value = task.priority;
                document.getElementById('task-category').value = task.category;
                document.getElementById('task-due-date').value = new Date(task.dueDate).toISOString().slice(0, 16);
                document.getElementById('task-assign-to').value = task.assignedTo || '';
                document.getElementById('task-notes').value = task.notes || '';
                
                // Add subtasks
                const subtasksContainer = document.getElementById('subtasks-container');
                subtasksContainer.innerHTML = '';
                
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach((subtask, index) => {
                        const subtaskItem = document.createElement('div');
                        subtaskItem.className = 'subtask-item flex items-center mt-2';
                        subtaskItem.innerHTML = `
                            <input type="text" class="subtask-input flex-1 px-4 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-primary-500 text-base" placeholder="Subtask ${index + 1}" value="${subtask.title}">
                            <button type="button" class="remove-subtask ml-2 text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        subtasksContainer.appendChild(subtaskItem);
                        
                        // Add event listener to remove button
                        subtaskItem.querySelector('.remove-subtask').addEventListener('click', () => {
                            subtaskItem.remove();
                        });
                    });
                }
                
                // Update form submit handler
                const form = document.getElementById('add-task-form');
                const originalSubmitHandler = form.onsubmit;
                
                form.onsubmit = (e) => {
                    e.preventDefault();
                    
                    const title = document.getElementById('task-title').value;
                    const description = document.getElementById('task-description').value;
                    const priority = document.getElementById('task-priority').value;
                    const category = document.getElementById('task-category').value;
                    const dueDate = document.getElementById('task-due-date').value;
                    const assignedTo = document.getElementById('task-assign-to').value;
                    const notes = document.getElementById('task-notes').value;
                    
                    // Get subtasks
                    const subtasks = [];
                    document.querySelectorAll('.subtask-input').forEach(input => {
                        if (input.value.trim()) {
                            subtasks.push({
                                id: generateId(),
                                title: input.value.trim(),
                                completed: false
                            });
                        }
                    });
                    
                    updateTask(currentTaskId, {
                        title,
                        description,
                        priority,
                        category,
                        dueDate,
                        assignedTo: assignedTo || null,
                        subtasks,
                        notes
                    });
                    
                    // Reset form handler
                    form.onsubmit = originalSubmitHandler;
                    
                    closePopup('add-task-popup');
                    
                    showToastNotification({
                        title: 'Task Updated',
                        message: 'Task has been updated successfully',
                        type: 'success'
                    });
                };
                
                openPopup('add-task-popup');
                document.querySelector('#add-task-popup h2').textContent = 'Edit Task';
            });
            
            document.getElementById('delete-task-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this task?')) {
                    deleteTask(currentTaskId);
                    closePopup('view-task-popup');
                }
            });
            
            // Share Task
            document.getElementById('do-share-task').addEventListener('click', () => {
                const task = tasks.find(t => t.id === currentTaskId);
                if (!task) return;
                
                const selectedUsers = Array.from(document.getElementById('share-task-to').selectedOptions)
                    .map(option => option.value);
                
                const message = document.getElementById('share-task-message').value;
                
                if (selectedUsers.length === 0) {
                    showToastNotification({
                        title: 'Share Error',
                        message: 'Please select at least one user to share with',
                        type: 'warning'
                    });
                    return;
                }
                
                // For demo purposes, just show a notification
                showToastNotification({
                    title: 'Task Shared',
                    message: `Task "${task.title}" shared with ${selectedUsers.length} user(s)`,
                    type: 'success'
                });
                
                closePopup('share-task-popup');
            });
            
            // Import/Export
            document.getElementById('import-btn').addEventListener('click', () => {
                openPopup('import-popup');
            });
            
            document.getElementById('export-btn').addEventListener('click', () => {
                openPopup('export-popup');
            });
            
            document.getElementById('import-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Check if it's an array
                        if (!Array.isArray(data)) {
                            throw new Error('Invalid format: Expected an array of tasks');
                        }
                        
                        // Preview
                        document.getElementById('import-preview').classList.remove('hidden');
                        document.getElementById('import-preview-content').textContent = JSON.stringify(data, null, 2).substring(0, 500) + (data.length > 500 ? '...' : '');
                        document.getElementById('import-count').textContent = `Found ${data.length} task(s)`;
                        
                        // Enable import button
                        document.getElementById('do-import').disabled = false;
                        
                        // Store the data for import
                        document.getElementById('do-import').dataset.tasks = JSON.stringify(data);
                    } catch (error) {
                        showToastNotification({
                            title: 'Import Error',
                            message: `Failed to parse JSON: ${error.message}`,
                            type: 'danger'
                        });
                        
                        document.getElementById('import-preview').classList.add('hidden');
                        document.getElementById('do-import').disabled = true;
                    }
                };
                
                reader.readAsText(file);
            });
            
            document.getElementById('do-import').addEventListener('click', () => {
                const tasksData = document.getElementById('do-import').dataset.tasks;
                if (!tasksData) return;
                
                try {
                    const importedTasks = JSON.parse(tasksData);
                    
                    // Add tasks
                    let addedCount = 0;
                    importedTasks.forEach(taskData => {
                        // Generate new ID and dates
                        const newTask = {
                            ...taskData,
                            id: generateId(),
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser.id
                        };
                        
                        tasks.push(newTask);
                        addedCount++;
                    });
                    
                    saveToLocalStorage();
                    updateTasksUI();
                    updateTaskStats();
                    updateInsightsView();
                    
                    showToastNotification({
                        title: 'Import Successful',
                        message: `Imported ${addedCount} task(s)`,
                        type: 'success'
                    });
                    
                    closePopup('import-popup');
                } catch (error) {
                    showToastNotification({
                        title: 'Import Error',
                        message: `Failed to import tasks: ${error.message}`,
                        type: 'danger'
                    });
                }
            });
            
            document.getElementById('do-export').addEventListener('click', () => {
                // Get export options
                const format = document.querySelector('input[name="export-format"]:checked').value;
                const includeCompleted = document.getElementById('export-completed').checked;
                const applyFilters = document.getElementById('export-current-filter').checked;
                
                // Get tasks to export
                let tasksToExport = applyFilters ? filterTasks() : [...tasks];
                
                // Filter completed tasks if needed
                if (!includeCompleted) {
                    tasksToExport = tasksToExport.filter(t => !t.completed);
                }
                
                // For demo purposes, show the export in a notification
                showToastNotification({
                    title: 'Export Ready',
                    message: `${tasksToExport.length} tasks exported in ${format.toUpperCase()} format`,
                    type: 'success'
                });
                
                // In a real app, we would create a download here
                closePopup('export-popup');
            });
            
            // Close popups
            document.querySelectorAll('.close-popup').forEach(button => {
                button.addEventListener('click', () => {
                    closeAllPopups();
                });
            });
            
            // Cancel form buttons
            document.querySelectorAll('.popup form').forEach(form => {
                form.addEventListener('reset', () => {
                    closeAllPopups();
                });
            });
            
            // Close popup when clicking outside
            document.querySelectorAll('.popup').forEach(popup => {
                popup.addEventListener('click', (e) => {
                    if (e.target === popup) {
                        closeAllPopups();
                    }
                });
            });
            
            // Escape key to close popups
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllPopups();
                }
            });
        }

        // Init function
        function init() {
            // Setup dark mode detection
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark-mode');
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark-mode');
                    document.body.classList.add('dark-mode');
                    document.body.classList.remove('light-mode');
                } else {
                    document.documentElement.classList.remove('dark-mode');
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
                
                // Update charts if visible
                if (!document.getElementById('graph-view').classList.contains('hidden')) {
                    updateCharts();
                }
            });
            
            loadFromLocalStorage();
            setupEventListeners();
            updateUndoRedoButtons();
            resetDailyTimer();
        }

        // Initialize the app
        init();

    </script>
</body>
</html>
