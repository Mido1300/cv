<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Todo App</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr for date picking -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- XLSX for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --success-color: #28A745;
            --danger-color: #DC3545;
            --warning-color: #FFC107;
            --secondary-color: #6C757D;
            --light-color: #F8F9FA;
            --dark-color: #181818;
            --body-bg-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --body-bg-dark: linear-gradient(135deg, #2a0808 0%, #4a1414 100%);
            --card-bg-light: #FFFFFF;
            --card-bg-dark: #2A2A2A;
            --text-color-light: #333333;
            --text-color-dark: #FFFFFF;
            --shadow-light: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-dark: 0 4px 12px rgba(0,0,0,0.3);
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --success-gradient: linear-gradient(135deg, #28A745 0%, #34CE57 100%);
            --danger-gradient: linear-gradient(135deg, #DC3545 0%, #E35D6A 100%);
            --secondary-gradient: linear-gradient(135deg, #6C757D 0%, #858D95 100%);
            --primary-gradient: linear-gradient(135deg, #5D5CDE 0%, #7D7CF2 100%);
            
            /* Default to light mode */
            --body-bg: var(--body-bg-light);
            --card-bg: var(--card-bg-light);
            --text-color: var(--text-color-light);
            --shadow: var(--shadow-light);
        }

        .dark {
            --body-bg: var(--body-bg-dark);
            --card-bg: var(--card-bg-dark);
            --text-color: var(--text-color-dark);
            --shadow: var(--shadow-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--body-bg);
            color: var(--text-color);
            transition: background var(--transition-speed), color var(--transition-speed);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Login/Register Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            transition: all var(--transition-speed);
        }

        .auth-card h2 {
            margin-bottom: 24px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .auth-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .auth-form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.2s;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .auth-form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }

        .error-text {
            font-size: 14px;
            color: var(--danger-color);
            margin-top: 5px;
            display: none;
        }

        .auth-btn {
            display: inline-block;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 24px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(93, 92, 222, 0.3);
        }

        .auth-toggle {
            margin-top: 24px;
            font-size: 14px;
        }

        .auth-toggle a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            padding: 20px 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .dark .header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 8px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .theme-toggle, .notification-bell, .user-profile {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            position: relative;
            transition: all 0.2s;
        }

        .theme-toggle:hover, .notification-bell:hover, .user-profile:hover {
            color: var(--primary-color);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger-color);
            color: white;
            font-size: 10px;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(25%, -25%);
        }

        .nav-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 12px;
        }

        .dark .nav-tabs {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(93, 92, 222, 0.1);
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: all var(--transition-speed);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* Task Styles */
        .task-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
            color: white;
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-primary {
            background: var(--primary-gradient);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .task-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(0,0,0,0.1);
            font-size: 14px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .dark .filter-select, .dark .filter-input {
            border: 1px solid rgba(255,255,255,0.1);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .task-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.2s;
            border-left: 4px solid var(--primary-color);
        }

        .task-item.high-priority {
            border-left-color: var(--danger-color);
        }

        .task-item.medium-priority {
            border-left-color: var(--warning-color);
        }

        .task-item.low-priority {
            border-left-color: var(--success-color);
        }

        .task-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .task-checkbox {
            margin-right: 16px;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .task-details {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--secondary-color);
        }

        .task-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-actions-right {
            display: flex;
            gap: 8px;
        }

        .task-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .task-btn:hover {
            color: var(--primary-color);
        }

        .task-btn.edit:hover {
            color: var(--warning-color);
        }

        .task-btn.delete:hover {
            color: var(--danger-color);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .modal-backdrop.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .dark .modal-footer {
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .dark .form-control {
            border: 1px solid rgba(255,255,255,0.1);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Users and Categories Styles */
        .users-grid, .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .user-card, .category-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .user-card:hover, .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .user-avatar-lg {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 12px;
            object-fit: cover;
        }

        .user-name, .category-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .user-email, .category-count {
            font-size: 14px;
            color: var(--secondary-color);
        }

        /* Insights Styles */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: all 0.2s;
        }

        .insight-value {
            font-size: 32px;
            font-weight: 700;
            margin: 16px 0;
            color: var(--primary-color);
        }

        .insight-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
        }

        /* Notification Styles */
        .notification-popup {
            position: absolute;
            top: 56px;
            right: 0;
            width: 300px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .notification-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-weight: 600;
        }

        .dark .notification-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .notification-list {
            padding: 0;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .dark .notification-item {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .notification-item:hover {
            background: rgba(0,0,0,0.02);
        }

        .dark .notification-item:hover {
            background: rgba(255,255,255,0.02);
        }

        .notification-item.unread {
            border-left: 3px solid var(--primary-color);
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--secondary-color);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s forwards;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-success .toast-icon {
            color: var(--success-color);
        }

        .toast-error .toast-icon {
            color: var(--danger-color);
        }

        .toast-info .toast-icon {
            color: var(--primary-color);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all 0.2s;
        }

        .toast-close:hover {
            color: var(--danger-color);
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .task-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .task-filters {
                flex-direction: column;
            }
            
            .task-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .task-actions-right {
                width: 100%;
                justify-content: flex-end;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessible focus styles */
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Drag and drop styles */
        .task-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(93, 92, 222, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            margin: 0 auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom checkbox styles */
        .custom-checkbox {
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 35px;
            cursor: pointer;
            font-size: 16px;
            user-select: none;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 24px;
            width: 24px;
            background-color: transparent;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            transition: all 0.2s;
        }

        .custom-checkbox:hover input ~ .checkmark {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .custom-checkbox input:checked ~ .checkmark {
            background-color: var(--primary-color);
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .custom-checkbox input:checked ~ .checkmark:after {
            display: block;
        }

        .custom-checkbox .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Task view toggle */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .view-toggle button {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: var(--primary-color);
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: rgba(93, 92, 222, 0.1);
        }

        /* Task progress bar */
        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            margin-top: 8px;
        }

        .dark .progress-container {
            background: rgba(255,255,255,0.1);
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Subtasks */
        .subtasks {
            margin-top: 12px;
            margin-left: 28px;
            border-left: 1px dashed rgba(0,0,0,0.2);
            padding-left: 16px;
        }

        .dark .subtasks {
            border-left: 1px dashed rgba(255,255,255,0.2);
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        /* User profile dropdown */
        .profile-dropdown {
            position: absolute;
            top: 56px;
            right: 0;
            width: 240px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            display: none;
        }

        .profile-info {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .dark .profile-info {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-name {
            font-weight: 600;
            margin-top: 8px;
        }

        .profile-email {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .profile-menu {
            padding: 8px 0;
        }

        .profile-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .profile-menu-item:hover {
            background: rgba(0,0,0,0.02);
        }

        .dark .profile-menu-item:hover {
            background: rgba(255,255,255,0.02);
        }

        .profile-menu-item i {
            color: var(--primary-color);
        }

        /* Timer */
        .timer-display {
            font-size: 14px;
            background: rgba(93, 92, 222, 0.1);
            padding: 4px 12px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .timer-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .timer-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timer-btn:hover {
            transform: scale(1.1);
        }

        .timer-btn.pause {
            background: var(--warning-color);
        }

        .timer-btn.stop {
            background: var(--danger-color);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state i {
            font-size: 48px;
            color: var(--secondary-color);
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 18px;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        /* Focus mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--body-bg);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .focus-mode.active {
            opacity: 1;
            visibility: visible;
        }

        .focus-task {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }

        .focus-timer {
            font-size: 64px;
            font-weight: 700;
            margin-bottom: 32px;
        }

        .focus-actions {
            display: flex;
            gap: 16px;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        [role="tooltip"] {
            position: absolute;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: var(--shadow);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Custom select styles */
        .select-wrapper {
            position: relative;
        }

        .select-wrapper::after {
            content: "\f0d7";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* Hide scrollbar for cleaner look but maintain functionality */
        .task-list::-webkit-scrollbar {
            width: 8px;
        }

        .task-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .task-list::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 20px;
        }

        .dark .task-list::-webkit-scrollbar-thumb {
            background-color: rgba(255,255,255,0.2);
        }

        /* Animation for card appearance */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task-item, .insight-card, .user-card, .category-card {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Animation delay for staggered appearance */
        .task-item:nth-child(1), .insight-card:nth-child(1), .user-card:nth-child(1), .category-card:nth-child(1) {
            animation-delay: 0.05s;
        }
        .task-item:nth-child(2), .insight-card:nth-child(2), .user-card:nth-child(2), .category-card:nth-child(2) {
            animation-delay: 0.1s;
        }
        .task-item:nth-child(3), .insight-card:nth-child(3), .user-card:nth-child(3), .category-card:nth-child(3) {
            animation-delay: 0.15s;
        }
        .task-item:nth-child(4), .insight-card:nth-child(4), .user-card:nth-child(4), .category-card:nth-child(4) {
            animation-delay: 0.2s;
        }
        .task-item:nth-child(5), .insight-card:nth-child(5), .user-card:nth-child(5), .category-card:nth-child(5) {
            animation-delay: 0.25s;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Section -->
        <div class="auth-container" id="authContainer">
            <div class="auth-card">
                <h2 id="authTitle">Login to Todo App</h2>
                <form id="authForm">
                    <!-- Login Form Fields -->
                    <div class="auth-form-group" id="emailGroup">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" required>
                        <div class="error-text" id="emailError">Please enter a valid email address</div>
                    </div>
                    <div class="auth-form-group" id="passwordGroup">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required>
                        <div class="error-text" id="passwordError">Password must be at least 6 characters</div>
                    </div>
                    <!-- Additional Register Fields (hidden by default) -->
                    <div class="auth-form-group" id="nameGroup" style="display: none;">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" name="name" placeholder="Enter your full name">
                        <div class="error-text" id="nameError">Please enter your name</div>
                    </div>
                    <div class="auth-form-group" id="confirmPasswordGroup" style="display: none;">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password">
                        <div class="error-text" id="confirmPasswordError">Passwords don't match</div>
                    </div>
                    <button type="submit" class="auth-btn" id="authSubmitBtn">Login</button>
                </form>
                <div class="auth-toggle">
                    <span id="toggleText">Don't have an account?</span>
                    <a id="toggleAuth">Register</a>
                </div>
            </div>
        </div>

        <!-- Dashboard Section (hidden by default) -->
        <div class="dashboard" id="dashboardContainer">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <i class="fas fa-check-circle"></i> Advanced Todo
                </div>
                <div class="header-actions">
                    <div class="timer-display" id="timerDisplay">
                        <i class="fas fa-clock"></i>
                        <span id="timerValue">00:00:00</span>
                    </div>
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div style="position: relative;">
                        <button class="notification-bell" id="notificationBtn" aria-label="View notifications">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge">3</span>
                        </button>
                        <!-- Notification Popup -->
                        <div class="notification-popup" id="notificationPopup">
                            <div class="notification-header">Notifications</div>
                            <div class="notification-list" id="notificationList">
                                <!-- Notification items will be inserted here -->
                            </div>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <button class="user-profile" id="userProfileBtn">
                            <img src="" alt="User Avatar" class="user-avatar" id="userAvatar">
                            <span id="userNameDisplay">User Name</span>
                        </button>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-info">
                                <img src="" alt="User Avatar" class="user-avatar" id="profileAvatar" style="width: 60px; height: 60px;">
                                <div class="profile-name" id="profileName">User Name</div>
                                <div class="profile-email" id="profileEmail">user@example.com</div>
                            </div>
                            <div class="profile-menu">
                                <div class="profile-menu-item">
                                    <i class="fas fa-user-cog"></i>
                                    <span>Settings</span>
                                </div>
                                <div class="profile-menu-item" id="logoutBtn">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="tasks">Tasks</div>
                <div class="nav-tab" data-tab="users">Users</div>
                <div class="nav-tab" data-tab="categories">Categories</div>
                <div class="nav-tab" data-tab="insights">Insights</div>
            </div>

            <!-- Tasks Tab Content -->
            <div class="tab-content active" id="tasksTab">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Tasks</h3>
                        <div class="view-toggle">
                            <button class="list-view active" aria-label="List view">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="graph-view" aria-label="Graph view">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="task-actions">
                        <button class="btn btn-success" id="addTaskBtn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                        <button class="btn btn-secondary" id="exportBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                        <button class="btn btn-secondary" id="importBtn">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                        <button class="btn btn-danger" id="clearCompletedBtn">
                            <i class="fas fa-trash"></i> Clear Completed
                        </button>
                    </div>
                    
                    <div class="task-filters">
                        <div class="filter-group">
                            <label for="statusFilter">Status</label>
                            <select id="statusFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="categoryFilter">Category</label>
                            <select id="categoryFilter" class="filter-select">
                                <option value="all">All Categories</option>
                                <!-- Categories will be populated here -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="priorityFilter">Priority</label>
                            <select id="priorityFilter" class="filter-select">
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="dueDateFilter">Due Date</label>
                            <input type="text" id="dueDateFilter" class="filter-input" placeholder="Select date">
                        </div>
                        
                        <div class="filter-group">
                            <label for="searchTask">Search</label>
                            <input type="text" id="searchTask" class="filter-input" placeholder="Search tasks...">
                        </div>
                    </div>
                    
                    <!-- List View -->
                    <div id="listView">
                        <div class="task-list" id="taskList">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Graph View (hidden by default) -->
                    <div id="graphView" style="display: none;">
                        <div class="chart-container">
                            <canvas id="taskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab Content -->
            <div class="tab-content" id="usersTab">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Team Members</h3>
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                    
                    <div class="users-grid" id="usersGrid">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Categories Tab Content -->
            <div class="tab-content" id="categoriesTab">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Task Categories</h3>
                        <button class="btn btn-primary" id="addCategoryBtn">
                            <i class="fas fa-folder-plus"></i> Add Category
                        </button>
                    </div>
                    
                    <div class="categories-grid" id="categoriesGrid">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Insights Tab Content -->
            <div class="tab-content" id="insightsTab">
                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="card-title">Total Tasks</div>
                        <div class="insight-value" id="totalTasksValue">0</div>
                        <div class="insight-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span id="tasksTrend">5% from last week</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="card-title">Completed Tasks</div>
                        <div class="insight-value" id="completedTasksValue">0</div>
                        <div class="insight-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span id="completedTrend">12% from last week</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="card-title">Overdue Tasks</div>
                        <div class="insight-value" id="overdueTasksValue">0</div>
                        <div class="insight-trend trend-down">
                            <i class="fas fa-arrow-down"></i>
                            <span id="overdueTrend">3% from last week</span>
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <div class="card-title">Active Users</div>
                        <div class="insight-value" id="activeUsersValue">0</div>
                        <div class="insight-trend trend-up">
                            <i class="fas fa-arrow-up"></i>
                            <span id="usersTrend">2% from last week</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Task Distribution</h3>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tasks Completion Trend</h3>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Components -->
    <div class="modal-backdrop" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="taskModalTitle">Add New Task</h3>
                <button class="modal-close" id="closeTaskModal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Task Title</label>
                        <input type="text" id="taskTitle" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" class="form-control"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" class="form-control">
                            <!-- Categories will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="form-control">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="taskAssignee">Assign To</label>
                        <select id="taskAssignee" class="form-control">
                            <!-- Users will be populated here -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Subtasks</label>
                        <div id="subtasksList">
                            <!-- Subtasks will be added here -->
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <input type="text" id="newSubtask" class="form-control" placeholder="Add a subtask">
                            <button type="button" class="btn btn-secondary" id="addSubtaskBtn" style="flex-shrink: 0;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelTaskBtn">Cancel</button>
                <button class="btn btn-success" id="saveTaskBtn">Save Task</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="categoryModalTitle">Add New Category</h3>
                <button class="modal-close" id="closeCategoryModal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <div class="form-group">
                        <label for="categoryName">Category Name</label>
                        <input type="text" id="categoryName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryColor">Color</label>
                        <input type="color" id="categoryColor" class="form-control" value="#5D5CDE">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea id="categoryDescription" class="form-control"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelCategoryBtn">Cancel</button>
                <button class="btn btn-success" id="saveCategoryBtn">Save Category</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add New User</h3>
                <button class="modal-close" id="closeUserModal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="userName">Full Name</label>
                        <input type="text" id="userName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="userRole">Role</label>
                        <select id="userRole" class="form-control">
                            <option value="admin">Admin</option>
                            <option value="member">Team Member</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelUserBtn">Cancel</button>
                <button class="btn btn-success" id="saveUserBtn">Save User</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Tasks</h3>
                <button class="modal-close" id="closeExportModal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportFormat">Export Format</label>
                    <select id="exportFormat" class="form-control">
                        <option value="json">JSON</option>
                        <option value="xlsx">Excel (XLSX)</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Export Options</label>
                    <div>
                        <label class="custom-checkbox">
                            Include completed tasks
                            <input type="checkbox" id="includeCompleted" checked>
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <div>
                        <label class="custom-checkbox">
                            Include subtasks
                            <input type="checkbox" id="includeSubtasks" checked>
                            <span class="checkmark"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Tasks</h3>
                <button class="modal-close" id="closeImportModal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importData">Paste JSON Data</label>
                    <textarea id="importData" class="form-control" rows="8" placeholder="Paste your JSON task data here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Import Options</label>
                    <div>
                        <label class="custom-checkbox">
                            Replace existing tasks
                            <input type="checkbox" id="replaceExisting">
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <div>
                        <label class="custom-checkbox">
                            Import categories
                            <input type="checkbox" id="importCategories" checked>
                            <span class="checkmark"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toasts will be added here dynamically -->
    </div>

    <!-- Focus Mode -->
    <div class="focus-mode" id="focusMode">
        <div class="focus-task" id="focusTaskTitle">Working on: Important Task</div>
        <div class="focus-timer" id="focusTimer">25:00</div>
        <div class="focus-actions">
            <button class="btn btn-danger" id="exitFocusBtn">Exit Focus Mode</button>
        </div>
    </div>

    <script>
        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // App state and variables
            const APP_STATE = {
                currentUser: null,
                tasks: [],
                categories: [],
                users: [],
                notifications: [],
                editingTaskId: null,
                editingCategoryId: null,
                editingUserId: null,
                timer: {
                    active: false,
                    startTime: null,
                    elapsed: 0,
                    interval: null,
                    currentTaskId: null
                },
                focusMode: {
                    active: false,
                    taskId: null,
                    timeRemaining: 25 * 60, // 25 minutes in seconds
                    interval: null
                },
                lastActionTimestamp: Date.now(),
                filters: {
                    status: 'all',
                    category: 'all',
                    priority: 'all',
                    dueDate: null,
                    search: ''
                }
            };

            // Initialize DOM elements
            const DOM = {
                // Auth elements
                authContainer: document.getElementById('authContainer'),
                authTitle: document.getElementById('authTitle'),
                authForm: document.getElementById('authForm'),
                authSubmitBtn: document.getElementById('authSubmitBtn'),
                toggleAuth: document.getElementById('toggleAuth'),
                toggleText: document.getElementById('toggleText'),
                nameGroup: document.getElementById('nameGroup'),
                confirmPasswordGroup: document.getElementById('confirmPasswordGroup'),
                
                // Dashboard elements
                dashboardContainer: document.getElementById('dashboardContainer'),
                navTabs: document.querySelectorAll('.nav-tab'),
                tabContents: document.querySelectorAll('.tab-content'),
                
                // User profile
                userAvatar: document.getElementById('userAvatar'),
                userNameDisplay: document.getElementById('userNameDisplay'),
                profileDropdown: document.getElementById('profileDropdown'),
                profileAvatar: document.getElementById('profileAvatar'),
                profileName: document.getElementById('profileName'),
                profileEmail: document.getElementById('profileEmail'),
                
                // Task elements
                taskList: document.getElementById('taskList'),
                taskModal: document.getElementById('taskModal'),
                taskForm: document.getElementById('taskForm'),
                taskModalTitle: document.getElementById('taskModalTitle'),
                
                // Category elements
                categoriesGrid: document.getElementById('categoriesGrid'),
                categoryModal: document.getElementById('categoryModal'),
                
                // User elements
                usersGrid: document.getElementById('usersGrid'),
                userModal: document.getElementById('userModal'),
                
                // Insights elements
                totalTasksValue: document.getElementById('totalTasksValue'),
                completedTasksValue: document.getElementById('completedTasksValue'),
                overdueTasksValue: document.getElementById('overdueTasksValue'),
                activeUsersValue: document.getElementById('activeUsersValue'),
                
                // Notification elements
                notificationBadge: document.getElementById('notificationBadge'),
                notificationPopup: document.getElementById('notificationPopup'),
                notificationList: document.getElementById('notificationList'),
                
                // Views
                listView: document.getElementById('listView'),
                graphView: document.getElementById('graphView'),
                
                // Filter elements
                statusFilter: document.getElementById('statusFilter'),
                categoryFilter: document.getElementById('categoryFilter'),
                priorityFilter: document.getElementById('priorityFilter'),
                dueDateFilter: document.getElementById('dueDateFilter'),
                searchTask: document.getElementById('searchTask'),
                
                // Charts
                taskChart: document.getElementById('taskChart'),
                distributionChart: document.getElementById('distributionChart'),
                trendChart: document.getElementById('trendChart'),
                
                // Timer elements
                timerDisplay: document.getElementById('timerDisplay'),
                timerValue: document.getElementById('timerValue'),
                
                // Focus mode elements
                focusMode: document.getElementById('focusMode'),
                focusTaskTitle: document.getElementById('focusTaskTitle'),
                focusTimer: document.getElementById('focusTimer'),
                
                // Export/Import
                exportModal: document.getElementById('exportModal'),
                importModal: document.getElementById('importModal'),
                
                // Toast container
                toastContainer: document.getElementById('toastContainer')
            };
            
            // Initialize theme mode based on user preference
            function initTheme() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                    }
                });
            }
            
            // Utility functions for generating IDs, formatting dates, etc.
            const Utils = {
                generateId: () => {
                    return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                },
                
                formatDate: (date) => {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                },
                
                formatTime: (seconds) => {
                    const hrs = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                },
                
                debounce: (func, delay) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                },
                
                isOverdue: (dueDate) => {
                    if (!dueDate) return false;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const due = new Date(dueDate);
                    return due < today;
                },
                
                getInitials: (name) => {
                    return name.split(' ')
                        .map(word => word.charAt(0))
                        .join('')
                        .toUpperCase();
                },
                
                getRandomColor: () => {
                    const letters = '0123456789ABCDEF';
                    let color = '#';
                    for (let i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                },
                
                createInitialsAvatar: (name, color) => {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 200;
                    
                    // Draw background
                    context.fillStyle = color || Utils.getRandomColor();
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw text
                    context.font = 'bold 80px Poppins, sans-serif';
                    context.fillStyle = '#FFFFFF';
                    context.textAlign = 'center';
                    context.textBaseline = 'middle';
                    context.fillText(Utils.getInitials(name), canvas.width / 2, canvas.height / 2);
                    
                    return canvas.toDataURL('image/png');
                }
            };
            
            // Storage functions for local storage persistence
            const Storage = {
                saveUser: (user) => {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                },
                
                getUser: () => {
                    const user = localStorage.getItem('currentUser');
                    return user ? JSON.parse(user) : null;
                },
                
                saveTasks: (tasks) => {
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                },
                
                getTasks: () => {
                    const tasks = localStorage.getItem('tasks');
                    return tasks ? JSON.parse(tasks) : [];
                },
                
                saveCategories: (categories) => {
                    localStorage.setItem('categories', JSON.stringify(categories));
                },
                
                getCategories: () => {
                    const categories = localStorage.getItem('categories');
                    return categories ? JSON.parse(categories) : [];
                },
                
                saveUsers: (users) => {
                    localStorage.setItem('users', JSON.stringify(users));
                },
                
                getUsers: () => {
                    const users = localStorage.getItem('users');
                    return users ? JSON.parse(users) : [];
                },
                
                saveNotifications: (notifications) => {
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                },
                
                getNotifications: () => {
                    const notifications = localStorage.getItem('notifications');
                    return notifications ? JSON.parse(notifications) : [];
                },
                
                clearAll: () => {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('tasks');
                    localStorage.removeItem('categories');
                    localStorage.removeItem('users');
                    localStorage.removeItem('notifications');
                }
            };
            
            // Data operations
            const DataService = {
                // Task operations
                createTask: (task) => {
                    const newTask = {
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        completed: false,
                        subtasks: [],
                        timeSpent: 0,
                        ...task
                    };
                    
                    APP_STATE.tasks.push(newTask);
                    Storage.saveTasks(APP_STATE.tasks);
                    return newTask;
                },
                
                updateTask: (id, updates) => {
                    const index = APP_STATE.tasks.findIndex(task => task.id === id);
                    if (index !== -1) {
                        APP_STATE.tasks[index] = {
                            ...APP_STATE.tasks[index],
                            ...updates,
                            updatedAt: new Date().toISOString()
                        };
                        Storage.saveTasks(APP_STATE.tasks);
                        return APP_STATE.tasks[index];
                    }
                    return null;
                },
                
                deleteTask: (id) => {
                    APP_STATE.tasks = APP_STATE.tasks.filter(task => task.id !== id);
                    Storage.saveTasks(APP_STATE.tasks);
                },
                
                toggleTaskCompletion: (id) => {
                    const task = APP_STATE.tasks.find(task => task.id === id);
                    if (task) {
                        task.completed = !task.completed;
                        task.updatedAt = new Date().toISOString();
                        if (task.completed) {
                            task.completedAt = new Date().toISOString();
                            // Create notification
                            DataService.createNotification({
                                title: 'Task Completed',
                                message: `"${task.title}" has been marked as complete`,
                                type: 'success',
                                read: false
                            });
                        } else {
                            task.completedAt = null;
                        }
                        Storage.saveTasks(APP_STATE.tasks);
                        return task;
                    }
                    return null;
                },
                
                // Category operations
                createCategory: (category) => {
                    const newCategory = {
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString(),
                        ...category
                    };
                    
                    APP_STATE.categories.push(newCategory);
                    Storage.saveCategories(APP_STATE.categories);
                    return newCategory;
                },
                
                updateCategory: (id, updates) => {
                    const index = APP_STATE.categories.findIndex(category => category.id === id);
                    if (index !== -1) {
                        APP_STATE.categories[index] = {
                            ...APP_STATE.categories[index],
                            ...updates
                        };
                        Storage.saveCategories(APP_STATE.categories);
                        return APP_STATE.categories[index];
                    }
                    return null;
                },
                
                deleteCategory: (id) => {
                    // Update tasks that use this category
                    APP_STATE.tasks.forEach(task => {
                        if (task.categoryId === id) {
                            task.categoryId = null;
                        }
                    });
                    Storage.saveTasks(APP_STATE.tasks);
                    
                    APP_STATE.categories = APP_STATE.categories.filter(category => category.id !== id);
                    Storage.saveCategories(APP_STATE.categories);
                },
                
                // User operations
                createUser: (user) => {
                    const newUser = {
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString(),
                        avatar: Utils.createInitialsAvatar(user.name),
                        ...user
                    };
                    
                    APP_STATE.users.push(newUser);
                    Storage.saveUsers(APP_STATE.users);
                    return newUser;
                },
                
                updateUser: (id, updates) => {
                    const index = APP_STATE.users.findIndex(user => user.id === id);
                    if (index !== -1) {
                        if (updates.name && !updates.avatar) {
                            updates.avatar = Utils.createInitialsAvatar(updates.name);
                        }
                        
                        APP_STATE.users[index] = {
                            ...APP_STATE.users[index],
                            ...updates
                        };
                        Storage.saveUsers(APP_STATE.users);
                        
                        // Update current user if it's the same id
                        if (APP_STATE.currentUser && APP_STATE.currentUser.id === id) {
                            APP_STATE.currentUser = APP_STATE.users[index];
                            Storage.saveUser(APP_STATE.currentUser);
                        }
                        
                        return APP_STATE.users[index];
                    }
                    return null;
                },
                
                deleteUser: (id) => {
                    // Update tasks assigned to this user
                    APP_STATE.tasks.forEach(task => {
                        if (task.assigneeId === id) {
                            task.assigneeId = null;
                        }
                    });
                    Storage.saveTasks(APP_STATE.tasks);
                    
                    APP_STATE.users = APP_STATE.users.filter(user => user.id !== id);
                    Storage.saveUsers(APP_STATE.users);
                },
                
                // Notification operations
                createNotification: (notification) => {
                    const newNotification = {
                        id: Utils.generateId(),
                        createdAt: new Date().toISOString(),
                        read: false,
                        ...notification
                    };
                    
                    APP_STATE.notifications.unshift(newNotification);
                    // Keep only the most recent 20 notifications
                    if (APP_STATE.notifications.length > 20) {
                        APP_STATE.notifications = APP_STATE.notifications.slice(0, 20);
                    }
                    Storage.saveNotifications(APP_STATE.notifications);
                    
                    // Update UI badge
                    UI.updateNotificationBadge();
                    
                    // Show toast for new notification
                    UI.showToast(notification.title, notification.message, notification.type);
                    
                    return newNotification;
                },
                
                markNotificationAsRead: (id) => {
                    const notification = APP_STATE.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.read = true;
                        Storage.saveNotifications(APP_STATE.notifications);
                        UI.updateNotificationBadge();
                    }
                },
                
                markAllNotificationsAsRead: () => {
                    APP_STATE.notifications.forEach(n => {
                        n.read = true;
                    });
                    Storage.saveNotifications(APP_STATE.notifications);
                    UI.updateNotificationBadge();
                },
                
                getFilteredTasks: () => {
                    return APP_STATE.tasks.filter(task => {
                        // Status filter
                        if (APP_STATE.filters.status === 'active' && task.completed) return false;
                        if (APP_STATE.filters.status === 'completed' && !task.completed) return false;
                        
                        // Category filter
                        if (APP_STATE.filters.category !== 'all' && task.categoryId !== APP_STATE.filters.category) return false;
                        
                        // Priority filter
                        if (APP_STATE.filters.priority !== 'all' && task.priority !== APP_STATE.filters.priority) return false;
                        
                        // Due date filter
                        if (APP_STATE.filters.dueDate) {
                            const filterDate = new Date(APP_STATE.filters.dueDate);
                            filterDate.setHours(0, 0, 0, 0);
                            
                            if (!task.dueDate) return false;
                            
                            const taskDueDate = new Date(task.dueDate);
                            taskDueDate.setHours(0, 0, 0, 0);
                            
                            if (taskDueDate.getTime() !== filterDate.getTime()) return false;
                        }
                        
                        // Search filter
                        if (APP_STATE.filters.search) {
                            const search = APP_STATE.filters.search.toLowerCase();
                            const titleMatch = task.title.toLowerCase().includes(search);
                            const descMatch = task.description && task.description.toLowerCase().includes(search);
                            if (!titleMatch && !descMatch) return false;
                        }
                        
                        return true;
                    });
                },
                
                getTaskCountsByCategory: () => {
                    const counts = {};
                    APP_STATE.categories.forEach(category => {
                        counts[category.id] = 0;
                    });
                    
                    // Also count tasks with no category
                    counts['none'] = 0;
                    
                    APP_STATE.tasks.forEach(task => {
                        if (task.categoryId && counts[task.categoryId] !== undefined) {
                            counts[task.categoryId]++;
                        } else {
                            counts['none']++;
                        }
                    });
                    
                    return counts;
                },
                
                getTaskCountsByPriority: () => {
                    return {
                        high: APP_STATE.tasks.filter(task => task.priority === 'high').length,
                        medium: APP_STATE.tasks.filter(task => task.priority === 'medium').length,
                        low: APP_STATE.tasks.filter(task => task.priority === 'low').length
                    };
                },
                
                getTaskCountsByStatus: () => {
                    return {
                        completed: APP_STATE.tasks.filter(task => task.completed).length,
                        active: APP_STATE.tasks.filter(task => !task.completed).length
                    };
                },
                
                getOverdueTasks: () => {
                    return APP_STATE.tasks.filter(task => 
                        !task.completed && 
                        task.dueDate && 
                        Utils.isOverdue(task.dueDate)
                    );
                },
                
                exportTasks: (format, options) => {
                    // Filtering tasks based on options
                    let tasksToExport = [...APP_STATE.tasks];
                    
                    if (!options.includeCompleted) {
                        tasksToExport = tasksToExport.filter(task => !task.completed);
                    }
                    
                    // If not including subtasks, remove them
                    if (!options.includeSubtasks) {
                        tasksToExport = tasksToExport.map(task => {
                            const { subtasks, ...taskWithoutSubtasks } = task;
                            return taskWithoutSubtasks;
                        });
                    }
                    
                    // Export based on format
                    if (format === 'json') {
                        // Create a Blob with the JSON data
                        const jsonData = JSON.stringify(tasksToExport, null, 2);
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        return blob;
                    } else if (format === 'xlsx') {
                        // Prepare data for Excel format
                        const worksheet = XLSX.utils.json_to_sheet(tasksToExport.map(task => {
                            // Simplify the task object for Excel
                            return {
                                Title: task.title,
                                Description: task.description,
                                Status: task.completed ? 'Completed' : 'Active',
                                Priority: task.priority,
                                Category: APP_STATE.categories.find(c => c.id === task.categoryId)?.name || 'None',
                                'Due Date': task.dueDate ? Utils.formatDate(task.dueDate) : '',
                                'Time Spent': Utils.formatTime(task.timeSpent),
                                'Created At': Utils.formatDate(task.createdAt)
                            };
                        }));
                        
                        const workbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
                        
                        // Generate XLSX file
                        const excelData = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                        const blob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                        return blob;
                    } else if (format === 'pdf') {
                        // Create PDF using jsPDF
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Add title
                        doc.setFontSize(18);
                        doc.text('Task Export', 14, 22);
                        
                        // Add date
                        doc.setFontSize(12);
                        doc.text(`Export Date: ${Utils.formatDate(new Date())}`, 14, 32);
                        
                        // Add task table
                        const taskTableData = tasksToExport.map(task => [
                            task.title,
                            task.completed ? 'Completed' : 'Active',
                            task.priority,
                            APP_STATE.categories.find(c => c.id === task.categoryId)?.name || 'None',
                            task.dueDate ? Utils.formatDate(task.dueDate) : 'No due date'
                        ]);
                        
                        // Add header row
                        taskTableData.unshift(['Title', 'Status', 'Priority', 'Category', 'Due Date']);
                        
                        // Create the table
                        doc.autoTable({
                            head: [taskTableData[0]],
                            body: taskTableData.slice(1),
                            startY: 40,
                            theme: 'grid',
                            styles: {
                                fontSize: 10
                            },
                            headStyles: {
                                fillColor: [93, 92, 222],
                                textColor: [255, 255, 255]
                            }
                        });
                        
                        // Return the PDF as a blob
                        const pdfData = doc.output('arraybuffer');
                        const blob = new Blob([pdfData], { type: 'application/pdf' });
                        return blob;
                    }
                    
                    return null;
                },
                
                importTasks: (data, options) => {
                    try {
                        const importedData = JSON.parse(data);
                        
                        if (!Array.isArray(importedData)) {
                            throw new Error('Imported data should be an array of tasks');
                        }
                        
                        // Import categories if option is enabled and categories are present
                        if (options.importCategories && importedData.length > 0 && importedData[0].category) {
                            const newCategories = importedData
                                .filter(task => task.category)
                                .map(task => task.category)
                                .filter((category, index, self) => 
                                    index === self.findIndex(c => c.id === category.id)
                                );
                            
                            // Add new categories
                            newCategories.forEach(category => {
                                if (!APP_STATE.categories.some(c => c.id === category.id)) {
                                    APP_STATE.categories.push(category);
                                }
                            });
                            
                            Storage.saveCategories(APP_STATE.categories);
                        }
                        
                        // Update or add tasks
                        if (options.replaceExisting) {
                            APP_STATE.tasks = importedData;
                        } else {
                            // Merge by adding new tasks and updating existing ones
                            importedData.forEach(importedTask => {
                                const existingIndex = APP_STATE.tasks.findIndex(t => t.id === importedTask.id);
                                if (existingIndex !== -1) {
                                    APP_STATE.tasks[existingIndex] = {
                                        ...APP_STATE.tasks[existingIndex],
                                        ...importedTask,
                                        updatedAt: new Date().toISOString()
                                    };
                                } else {
                                    APP_STATE.tasks.push(importedTask);
                                }
                            });
                        }
                        
                        Storage.saveTasks(APP_STATE.tasks);
                        return true;
                    } catch (error) {
                        console.error('Import error:', error);
                        return false;
                    }
                }
            };
            
            // UI operations
            const UI = {
                // Initialize the UI
                init: () => {
                    // Check if user is logged in
                    const currentUser = Storage.getUser();
                    if (currentUser) {
                        APP_STATE.currentUser = currentUser;
                        UI.showDashboard();
                    } else {
                        UI.showLogin();
                    }
                    
                    // Initialize theme
                    initTheme();
                    
                    // Initialize datepikcers
                    flatpickr("#taskDueDate", {
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "F j, Y",
                        minDate: "today"
                    });
                    
                    flatpickr("#dueDateFilter", {
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "F j, Y",
                        onChange: (selectedDates) => {
                            if (selectedDates.length > 0) {
                                APP_STATE.filters.dueDate = selectedDates[0].toISOString();
                            } else {
                                APP_STATE.filters.dueDate = null;
                            }
                            UI.renderTasks();
                        }
                    });
                    
                    // Set up event listeners
                    UI.setupEventListeners();
                },
                
                // Show login/register form
                showLogin: () => {
                    DOM.authContainer.style.display = 'flex';
                    DOM.dashboardContainer.style.display = 'none';
                    
                    // Reset form
                    DOM.authForm.reset();
                    document.getElementById('emailError').style.display = 'none';
                    document.getElementById('passwordError').style.display = 'none';
                    document.getElementById('nameError').style.display = 'none';
                    document.getElementById('confirmPasswordError').style.display = 'none';
                },
                
                // Show dashboard
                showDashboard: () => {
                    DOM.authContainer.style.display = 'none';
                    DOM.dashboardContainer.style.display = 'block';
                    
                    // Update UI with user info
                    DOM.userNameDisplay.textContent = APP_STATE.currentUser.name;
                    DOM.userAvatar.src = APP_STATE.currentUser.avatar;
                    DOM.profileName.textContent = APP_STATE.currentUser.name;
                    DOM.profileEmail.textContent = APP_STATE.currentUser.email;
                    DOM.profileAvatar.src = APP_STATE.currentUser.avatar;
                    
                    // Load data from localStorage
                    APP_STATE.tasks = Storage.getTasks();
                    APP_STATE.categories = Storage.getCategories();
                    APP_STATE.users = Storage.getUsers();
                    APP_STATE.notifications = Storage.getNotifications();
                    
                    // Initialize default categories and users if none exist
                    if (APP_STATE.categories.length === 0) {
                        UI.initializeDefaultCategories();
                    }
                    
                    if (APP_STATE.users.length === 0) {
                        UI.initializeDefaultUsers();
                    }
                    
                    if (APP_STATE.tasks.length === 0) {
                        UI.initializeDefaultTasks();
                    }
                    
                    // Render UI components
                    UI.renderTasks();
                    UI.renderCategories();
                    UI.renderUsers();
                    UI.renderInsights();
                    UI.updateNotificationBadge();
                    UI.renderNotifications();
                },
                
                // Initialize default categories
                initializeDefaultCategories: () => {
                    const defaultCategories = [
                        { name: 'Work', color: '#5D5CDE', description: 'Work-related tasks' },
                        { name: 'Personal', color: '#28A745', description: 'Personal tasks' },
                        { name: 'Urgent', color: '#DC3545', description: 'Urgent tasks' },
                        { name: 'Learning', color: '#FFC107', description: 'Learning and education tasks' }
                    ];
                    
                    defaultCategories.forEach(category => {
                        DataService.createCategory(category);
                    });
                },
                
                // Initialize default users
                initializeDefaultUsers: () => {
                    // Get random users from API
                    fetch('https://randomuser.me/api/?results=5')
                        .then(response => response.json())
                        .then(data => {
                            const randomUsers = data.results.map(user => {
                                return {
                                    name: `${user.name.first} ${user.name.last}`,
                                    email: user.email,
                                    role: 'member',
                                    avatar: user.picture.large
                                };
                            });
                            
                            // Add the current user as admin
                            randomUsers.unshift({
                                name: APP_STATE.currentUser.name,
                                email: APP_STATE.currentUser.email,
                                role: 'admin',
                                avatar: APP_STATE.currentUser.avatar,
                                id: APP_STATE.currentUser.id
                            });
                            
                            randomUsers.forEach(user => {
                                if (user.id !== APP_STATE.currentUser.id) {
                                    DataService.createUser(user);
                                }
                            });
                            
                            UI.renderUsers();
                        })
                        .catch(error => {
                            console.error('Error fetching random users:', error);
                            
                            // Fallback: Add some static dummy users
                            const dummyUsers = [
                                { name: 'John Doe', email: 'john@example.com', role: 'member' },
                                { name: 'Jane Smith', email: 'jane@example.com', role: 'member' },
                                { name: 'Bob Johnson', email: 'bob@example.com', role: 'viewer' }
                            ];
                            
                            dummyUsers.forEach(user => {
                                DataService.createUser(user);
                            });
                            
                            UI.renderUsers();
                        });
                },
                
                // Initialize default tasks
                initializeDefaultTasks: () => {
                    const defaultTasks = [
                        {
                            title: 'Complete project proposal',
                            description: 'Finish drafting the project proposal for the client meeting',
                            priority: 'high',
                            dueDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[0]?.id,
                            assigneeId: APP_STATE.currentUser.id,
                            subtasks: [
                                { id: Utils.generateId(), title: 'Research market trends', completed: true },
                                { id: Utils.generateId(), title: 'Create budget estimation', completed: false },
                                { id: Utils.generateId(), title: 'Write executive summary', completed: false }
                            ]
                        },
                        {
                            title: 'Weekly team meeting',
                            description: 'Discuss project progress and upcoming deadlines',
                            priority: 'medium',
                            dueDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[0]?.id,
                            assigneeId: APP_STATE.users[1]?.id
                        },
                        {
                            title: 'Grocery shopping',
                            description: 'Buy groceries for the week',
                            priority: 'low',
                            dueDate: new Date().toISOString(),
                            categoryId: APP_STATE.categories[1]?.id,
                            assigneeId: APP_STATE.currentUser.id,
                            completed: false
                        },
                        {
                            title: 'Pay utility bills',
                            description: 'Pay electricity and water bills',
                            priority: 'high',
                            dueDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[2]?.id,
                            assigneeId: APP_STATE.currentUser.id,
                            completed: true,
                            completedAt: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString()
                        },
                        {
                            title: 'Complete JavaScript course',
                            description: 'Finish the advanced JavaScript course on Udemy',
                            priority: 'medium',
                            dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[3]?.id,
                            assigneeId: APP_STATE.users[2]?.id,
                            subtasks: [
                                { id: Utils.generateId(), title: 'Async/Await module', completed: true },
                                { id: Utils.generateId(), title: 'ES6+ features', completed: true },
                                { id: Utils.generateId(), title: 'Final project', completed: false }
                            ]
                        },
                        {
                            title: 'Gym workout',
                            description: 'Complete 1-hour workout at the gym',
                            priority: 'low',
                            dueDate: new Date().toISOString(),
                            categoryId: APP_STATE.categories[1]?.id,
                            assigneeId: APP_STATE.currentUser.id
                        },
                        {
                            title: 'Dentist appointment',
                            description: 'Regular checkup at Dr. Smith',
                            priority: 'medium',
                            dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[1]?.id,
                            assigneeId: APP_STATE.currentUser.id
                        },
                        {
                            title: 'Review client feedback',
                            description: 'Go through client feedback on the latest project',
                            priority: 'high',
                            dueDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[0]?.id,
                            assigneeId: APP_STATE.users[1]?.id
                        },
                        {
                            title: 'Update portfolio website',
                            description: 'Add recent projects to portfolio',
                            priority: 'medium',
                            dueDate: new Date(Date.now() + 4 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[0]?.id,
                            assigneeId: APP_STATE.currentUser.id
                        },
                        {
                            title: 'Read new programming book',
                            description: 'Read at least 3 chapters of the new programming book',
                            priority: 'low',
                            dueDate: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(),
                            categoryId: APP_STATE.categories[3]?.id,
                            assigneeId: APP_STATE.currentUser.id
                        }
                    ];
                    
                    defaultTasks.forEach(task => {
                        DataService.createTask(task);
                    });
                    
                    // Create some default notifications
                    DataService.createNotification({
                        title: 'Welcome to Todo App',
                        message: 'We\'re glad you\'re here! Let\'s get started managing your tasks.',
                        type: 'info',
                        read: false
                    });
                    
                    DataService.createNotification({
                        title: 'Task Reminder',
                        message: 'You have 2 tasks due today.',
                        type: 'warning',
                        read: false
                    });
                },
                
                // Render tasks in the task list
                renderTasks: () => {
                    const filteredTasks = DataService.getFilteredTasks();
                    
                    // Sort tasks: priority (high to low), then due date (early to late), then title
                    filteredTasks.sort((a, b) => {
                        // Put completed tasks at the bottom
                        if (a.completed !== b.completed) {
                            return a.completed ? 1 : -1;
                        }
                        
                        // Priority sorting (high, medium, low)
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                            return priorityOrder[b.priority] - priorityOrder[a.priority];
                        }
                        
                        // Due date sorting
                        if (a.dueDate && b.dueDate) {
                            return new Date(a.dueDate) - new Date(b.dueDate);
                        } else if (a.dueDate) {
                            return -1;
                        } else if (b.dueDate) {
                            return 1;
                        }
                        
                        // Title sorting
                        return a.title.localeCompare(b.title);
                    });
                    
                    const taskList = DOM.taskList;
                    taskList.innerHTML = '';
                    
                    if (filteredTasks.length === 0) {
                        taskList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-tasks"></i>
                                <div class="empty-state-text">No tasks found</div>
                                <button class="btn btn-primary" id="emptyStateAddTaskBtn">
                                    <i class="fas fa-plus"></i> Add Your First Task
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('emptyStateAddTaskBtn').addEventListener('click', () => {
                            UI.openTaskModal();
                        });
                        return;
                    }
                    
                    filteredTasks.forEach(task => {
                        const category = APP_STATE.categories.find(c => c.id === task.categoryId);
                        const assignee = APP_STATE.users.find(u => u.id === task.assigneeId);
                        
                        const taskElement = document.createElement('div');
                        taskElement.classList.add('task-item');
                        taskElement.classList.add(`${task.priority}-priority`);
                        taskElement.setAttribute('data-task-id', task.id);
                        if (task.completed) taskElement.classList.add('completed');
                        
                        // Calculate subtask progress
                        let subtaskProgress = 0;
                        if (task.subtasks && task.subtasks.length > 0) {
                            const completedSubtasks = task.subtasks.filter(subtask => subtask.completed).length;
                            subtaskProgress = Math.round((completedSubtasks / task.subtasks.length) * 100);
                        }
                        
                        // Check if task is overdue
                        const isOverdue = !task.completed && Utils.isOverdue(task.dueDate);
                        
                        taskElement.innerHTML = `
                            <div class="task-checkbox">
                                <label class="custom-checkbox">
                                    <input type="checkbox" class="task-complete-checkbox" data-task-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                                <div class="task-details">
                                    ${category ? 
                                        `<div class="task-detail">
                                            <i class="fas fa-tag" style="color: ${category.color}"></i>
                                            <span>${category.name}</span>
                                        </div>` : ''
                                    }
                                    ${task.dueDate ? 
                                        `<div class="task-detail ${isOverdue ? 'text-danger' : ''}">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>${Utils.formatDate(task.dueDate)}</span>
                                            ${isOverdue ? ' (Overdue)' : ''}
                                        </div>` : ''
                                    }
                                    ${assignee ? 
                                        `<div class="task-detail">
                                            <i class="fas fa-user"></i>
                                            <span>${assignee.name}</span>
                                        </div>` : ''
                                    }
                                    ${task.timeSpent > 0 ? 
                                        `<div class="task-detail">
                                            <i class="fas fa-clock"></i>
                                            <span>${Utils.formatTime(task.timeSpent)}</span>
                                        </div>` : ''
                                    }
                                </div>
                                
                                ${task.subtasks && task.subtasks.length > 0 ? 
                                    `<div class="progress-container">
                                        <div class="progress-bar" style="width: ${subtaskProgress}%"></div>
                                    </div>
                                    <div class="subtasks">
                                        ${task.subtasks.map(subtask => `
                                            <div class="subtask-item">
                                                <label class="custom-checkbox">
                                                    <input type="checkbox" class="subtask-checkbox" 
                                                        data-task-id="${task.id}" 
                                                        data-subtask-id="${subtask.id}" 
                                                        ${subtask.completed ? 'checked' : ''}>
                                                    <span class="checkmark"></span>
                                                </label>
                                                <span class="${subtask.completed ? 'completed' : ''}">${subtask.title}</span>
                                            </div>
                                        `).join('')}
                                    </div>` : ''
                                }
                            </div>
                            <div class="task-actions-right">
                                <button class="task-btn play" data-task-id="${task.id}" aria-label="Start timer">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="task-btn edit" data-task-id="${task.id}" aria-label="Edit task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="task-btn delete" data-task-id="${task.id}" aria-label="Delete task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        taskList.appendChild(taskElement);
                    });
                    
                    // Set up event listeners for task actions
                    document.querySelectorAll('.task-complete-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const taskId = this.getAttribute('data-task-id');
                            DataService.toggleTaskCompletion(taskId);
                            UI.renderTasks();
                            UI.renderInsights();
                        });
                    });
                    
                    document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const taskId = this.getAttribute('data-task-id');
                            const subtaskId = this.getAttribute('data-subtask-id');
                            const task = APP_STATE.tasks.find(t => t.id === taskId);
                            
                            if (task && task.subtasks) {
                                const subtask = task.subtasks.find(s => s.id === subtaskId);
                                if (subtask) {
                                    subtask.completed = this.checked;
                                    Storage.saveTasks(APP_STATE.tasks);
                                    
                                    // Update the UI without full re-render
                                    const subtaskElement = this.closest('.subtask-item').querySelector('span');
                                    if (subtask.completed) {
                                        subtaskElement.classList.add('completed');
                                    } else {
                                        subtaskElement.classList.remove('completed');
                                    }
                                    
                                    // Update progress bar
                                    const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                                    const progress = Math.round((completedSubtasks / task.subtasks.length) * 100);
                                    const progressBar = this.closest('.task-item').querySelector('.progress-bar');
                                    if (progressBar) {
                                        progressBar.style.width = `${progress}%`;
                                    }
                                    
                                    // Check if all subtasks completed, prompt to complete task
                                    if (completedSubtasks === task.subtasks.length && !task.completed) {
                                        UI.showToast('All subtasks completed', 'Would you like to mark the main task as completed?', 'info');
                                    }
                                }
                            }
                        });
                    });
                    
                    document.querySelectorAll('.task-btn.edit').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            UI.openTaskModal(taskId);
                        });
                    });
                    
                    document.querySelectorAll('.task-btn.delete').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            const task = APP_STATE.tasks.find(t => t.id === taskId);
                            
                            if (confirm(`Are you sure you want to delete "${task.title}"?`)) {
                                DataService.deleteTask(taskId);
                                UI.renderTasks();
                                UI.renderInsights();
                                UI.showToast('Task Deleted', 'The task has been deleted successfully', 'warning');
                            }
                        });
                    });
                    
                    document.querySelectorAll('.task-btn.play').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            const task = APP_STATE.tasks.find(t => t.id === taskId);
                            
                            if (task) {
                                UI.startTaskTimer(taskId);
                            }
                        });
                    });
                    
                    // Set up drag and drop
                    document.querySelectorAll('.task-item').forEach(item => {
                        item.setAttribute('draggable', true);
                        
                        item.addEventListener('dragstart', function(e) {
                            e.dataTransfer.setData('text/plain', this.getAttribute('data-task-id'));
                            this.classList.add('dragging');
                        });
                        
                        item.addEventListener('dragend', function() {
                            this.classList.remove('dragging');
                        });
                        
                        item.addEventListener('dragover', function(e) {
                            e.preventDefault();
                            this.classList.add('drag-over');
                        });
                        
                        item.addEventListener('dragleave', function() {
                            this.classList.remove('drag-over');
                        });
                        
                        item.addEventListener('drop', function(e) {
                            e.preventDefault();
                            this.classList.remove('drag-over');
                            
                            const draggedTaskId = e.dataTransfer.getData('text/plain');
                            const targetTaskId = this.getAttribute('data-task-id');
                            
                            if (draggedTaskId !== targetTaskId) {
                                // Reorder the tasks
                                const draggedTask = APP_STATE.tasks.find(t => t.id === draggedTaskId);
                                const targetTask = APP_STATE.tasks.find(t => t.id === targetTaskId);
                                
                                if (draggedTask && targetTask) {
                                    // Swap priorities or categories or assignees
                                    const draggedPriority = draggedTask.priority;
                                    draggedTask.priority = targetTask.priority;
                                    targetTask.priority = draggedPriority;
                                    
                                    Storage.saveTasks(APP_STATE.tasks);
                                    UI.renderTasks();
                                    UI.showToast('Tasks Updated', 'Tasks have been reordered', 'success');
                                }
                            }
                        });
                    });
                    
                    // Update task chart
                    UI.updateTaskChart();
                },
                
                // Render categories in the categories grid
                renderCategories: () => {
                    const categoriesGrid = DOM.categoriesGrid;
                    categoriesGrid.innerHTML = '';
                    
                    const taskCounts = DataService.getTaskCountsByCategory();
                    
                    if (APP_STATE.categories.length === 0) {
                        categoriesGrid.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <div class="empty-state-text">No categories found</div>
                                <button class="btn btn-primary" id="emptyStateAddCategoryBtn">
                                    <i class="fas fa-folder-plus"></i> Add Your First Category
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('emptyStateAddCategoryBtn').addEventListener('click', () => {
                            UI.openCategoryModal();
                        });
                        return;
                    }
                    
                    // Add categories to the category filter dropdown
                    const categoryFilter = document.getElementById('categoryFilter');
                    categoryFilter.innerHTML = '<option value="all">All Categories</option>';
                    
                    // Add categories to the task category dropdown
                    const taskCategory = document.getElementById('taskCategory');
                    taskCategory.innerHTML = '<option value="">No Category</option>';
                    
                    APP_STATE.categories.forEach(category => {
                        // Add to category grid
                        const categoryElement = document.createElement('div');
                        categoryElement.classList.add('category-card');
                        
                        categoryElement.innerHTML = `
                            <div class="category-color" style="width: 24px; height: 24px; border-radius: 50%; background-color: ${category.color}; margin: 0 auto 12px;"></div>
                            <div class="category-name">${category.name}</div>
                            <div class="category-count">${taskCounts[category.id] || 0} tasks</div>
                            <div class="category-actions" style="margin-top: 12px;">
                                <button class="btn btn-secondary edit-category" data-category-id="${category.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger delete-category" data-category-id="${category.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        categoriesGrid.appendChild(categoryElement);
                        
                        // Add to category filter dropdown
                        const categoryOption = document.createElement('option');
                        categoryOption.value = category.id;
                        categoryOption.textContent = category.name;
                        categoryFilter.appendChild(categoryOption);
                        
                        // Add to task category dropdown
                        const taskCategoryOption = document.createElement('option');
                        taskCategoryOption.value = category.id;
                        taskCategoryOption.textContent = category.name;
                        taskCategory.appendChild(taskCategoryOption);
                    });
                    
                    // Set up event listeners for category actions
                    document.querySelectorAll('.edit-category').forEach(button => {
                        button.addEventListener('click', function() {
                            const categoryId = this.getAttribute('data-category-id');
                            UI.openCategoryModal(categoryId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-category').forEach(button => {
                        button.addEventListener('click', function() {
                            const categoryId = this.getAttribute('data-category-id');
                            const category = APP_STATE.categories.find(c => c.id === categoryId);
                            
                            if (confirm(`Are you sure you want to delete the "${category.name}" category? Tasks in this category will be moved to "No Category".`)) {
                                DataService.deleteCategory(categoryId);
                                UI.renderCategories();
                                UI.renderTasks();
                                UI.renderInsights();
                                UI.showToast('Category Deleted', 'The category has been deleted successfully', 'warning');
                            }
                        });
                    });
                },
                
                // Render users in the users grid
                renderUsers: () => {
                    const usersGrid = DOM.usersGrid;
                    usersGrid.innerHTML = '';
                    
                    if (APP_STATE.users.length === 0) {
                        usersGrid.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <div class="empty-state-text">No users found</div>
                                <button class="btn btn-primary" id="emptyStateAddUserBtn">
                                    <i class="fas fa-user-plus"></i> Add Your First User
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('emptyStateAddUserBtn').addEventListener('click', () => {
                            UI.openUserModal();
                        });
                        return;
                    }
                    
                    // Add users to the task assignee dropdown
                    const taskAssignee = document.getElementById('taskAssignee');
                    taskAssignee.innerHTML = '<option value="">Unassigned</option>';
                    
                    APP_STATE.users.forEach(user => {
                        // Add to users grid
                        const userElement = document.createElement('div');
                        userElement.classList.add('user-card');
                        
                        userElement.innerHTML = `
                            <img src="${user.avatar}" alt="${user.name}" class="user-avatar-lg">
                            <div class="user-name">${user.name}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-role" style="font-size: 12px; color: var(--primary-color); margin-top: 4px;">${user.role}</div>
                            <div class="user-actions" style="margin-top: 12px;">
                                <button class="btn btn-secondary edit-user" data-user-id="${user.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                ${user.id !== APP_STATE.currentUser.id ? 
                                    `<button class="btn btn-danger delete-user" data-user-id="${user.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''
                                }
                            </div>
                        `;
                        
                        usersGrid.appendChild(userElement);
                        
                        // Add to task assignee dropdown
                        const assigneeOption = document.createElement('option');
                        assigneeOption.value = user.id;
                        assigneeOption.textContent = user.name;
                        taskAssignee.appendChild(assigneeOption);
                    });
                    
                    // Set up event listeners for user actions
                    document.querySelectorAll('.edit-user').forEach(button => {
                        button.addEventListener('click', function() {
                            const userId = this.getAttribute('data-user-id');
                            UI.openUserModal(userId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-user').forEach(button => {
                        button.addEventListener('click', function() {
                            const userId = this.getAttribute('data-user-id');
                            const user = APP_STATE.users.find(u => u.id === userId);
                            
                            if (confirm(`Are you sure you want to delete "${user.name}"? Tasks assigned to this user will be unassigned.`)) {
                                DataService.deleteUser(userId);
                                UI.renderUsers();
                                UI.renderTasks();
                                UI.renderInsights();
                                UI.showToast('User Deleted', 'The user has been deleted successfully', 'warning');
                            }
                        });
                    });
                },
                
                // Render insights and charts
                renderInsights: () => {
                    // Update insight cards
                    DOM.totalTasksValue.textContent = APP_STATE.tasks.length;
                    DOM.completedTasksValue.textContent = APP_STATE.tasks.filter(task => task.completed).length;
                    DOM.overdueTasksValue.textContent = DataService.getOverdueTasks().length;
                    DOM.activeUsersValue.textContent = APP_STATE.users.length;
                    
                    // Update distribution chart
                    UI.updateDistributionChart();
                    
                    // Update trend chart
                    UI.updateTrendChart();
                },
                
                // Update notification badge
                updateNotificationBadge: () => {
                    const unreadCount = APP_STATE.notifications.filter(n => !n.read).length;
                    DOM.notificationBadge.textContent = unreadCount;
                    
                    if (unreadCount > 0) {
                        DOM.notificationBadge.style.display = 'flex';
                    } else {
                        DOM.notificationBadge.style.display = 'none';
                    }
                },
                
                // Render notifications in the notification popup
                renderNotifications: () => {
                    const notificationList = DOM.notificationList;
                    notificationList.innerHTML = '';
                    
                    if (APP_STATE.notifications.length === 0) {
                        notificationList.innerHTML = `
                            <div style="padding: 16px; text-align: center;">
                                <i class="fas fa-bell-slash" style="font-size: 24px; color: var(--secondary-color); margin-bottom: 8px;"></i>
                                <div>No notifications</div>
                            </div>
                        `;
                        return;
                    }
                    
                    APP_STATE.notifications.forEach(notification => {
                        const notificationElement = document.createElement('div');
                        notificationElement.classList.add('notification-item');
                        if (!notification.read) {
                            notificationElement.classList.add('unread');
                        }
                        notificationElement.setAttribute('data-notification-id', notification.id);
                        
                        let iconClass = 'fas fa-info-circle';
                        if (notification.type === 'success') {
                            iconClass = 'fas fa-check-circle';
                        } else if (notification.type === 'warning') {
                            iconClass = 'fas fa-exclamation-triangle';
                        } else if (notification.type === 'error') {
                            iconClass = 'fas fa-times-circle';
                        }
                        
                        notificationElement.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="${iconClass}" style="font-size: 16px; ${notification.type === 'success' ? 'color: var(--success-color);' : notification.type === 'warning' ? 'color: var(--warning-color);' : notification.type === 'error' ? 'color: var(--danger-color);' : 'color: var(--primary-color);'}"></i>
                                <div>
                                    <div class="notification-title">${notification.title}</div>
                                    <div class="notification-message">${notification.message}</div>
                                    <div class="notification-time">${Utils.formatDate(notification.createdAt)}</div>
                                </div>
                            </div>
                        `;
                        
                        notificationList.appendChild(notificationElement);
                    });
                    
                    // Add "Mark all as read" button
                    const markAllBtn = document.createElement('div');
                    markAllBtn.classList.add('notification-item');
                    markAllBtn.style.textAlign = 'center';
                    markAllBtn.style.fontWeight = '500';
                    markAllBtn.innerHTML = 'Mark all as read';
                    markAllBtn.style.color = 'var(--primary-color)';
                    markAllBtn.style.cursor = 'pointer';
                    
                    markAllBtn.addEventListener('click', () => {
                        DataService.markAllNotificationsAsRead();
                        UI.renderNotifications();
                    });
                    
                    notificationList.appendChild(markAllBtn);
                    
                    // Add event listeners to notification items
                    document.querySelectorAll('.notification-item[data-notification-id]').forEach(item => {
                        item.addEventListener('click', function() {
                            const notificationId = this.getAttribute('data-notification-id');
                            DataService.markNotificationAsRead(notificationId);
                            
                            if (this.classList.contains('unread')) {
                                this.classList.remove('unread');
                            }
                        });
                    });
                },
                
                // Update task chart
                updateTaskChart: () => {
                    const ctx = DOM.taskChart.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.taskChart) {
                        window.taskChart.destroy();
                    }
                    
                    const tasksByStatus = DataService.getTaskCountsByStatus();
                    const tasksByPriority = DataService.getTaskCountsByPriority();
                    
                    window.taskChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['By Status', 'By Priority'],
                            datasets: [
                                {
                                    label: 'Completed',
                                    data: [tasksByStatus.completed, 0],
                                    backgroundColor: '#28A745'
                                },
                                {
                                    label: 'Active',
                                    data: [tasksByStatus.active, 0],
                                    backgroundColor: '#5D5CDE'
                                },
                                {
                                    label: 'High',
                                    data: [0, tasksByPriority.high],
                                    backgroundColor: '#DC3545'
                                },
                                {
                                    label: 'Medium',
                                    data: [0, tasksByPriority.medium],
                                    backgroundColor: '#FFC107'
                                },
                                {
                                    label: 'Low',
                                    data: [0, tasksByPriority.low],
                                    backgroundColor: '#6C757D'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                title: {
                                    display: true,
                                    text: 'Task Distribution'
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true
                                },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                },
                
                // Update distribution chart
                updateDistributionChart: () => {
                    const ctx = DOM.distributionChart.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.distributionChart) {
                        window.distributionChart.destroy();
                    }
                    
                    const taskCounts = DataService.getTaskCountsByCategory();
                    const categoryNames = APP_STATE.categories.map(category => category.name);
                    categoryNames.push('Uncategorized');
                    
                    const categoryColors = APP_STATE.categories.map(category => category.color);
                    categoryColors.push('#6C757D');
                    
                    const categoryData = APP_STATE.categories.map(category => taskCounts[category.id] || 0);
                    categoryData.push(taskCounts['none'] || 0);
                    
                    window.distributionChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: categoryNames,
                            datasets: [{
                                data: categoryData,
                                backgroundColor: categoryColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                },
                
                // Update trend chart
                updateTrendChart: () => {
                    const ctx = DOM.trendChart.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.trendChart) {
                        window.trendChart.destroy();
                    }
                    
                    // Generate date labels for the last 7 days
                    const dateLabels = [];
                    const completedData = [];
                    const activeData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        date.setHours(0, 0, 0, 0);
                        
                        dateLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        
                        // Count tasks completed on this date
                        const completedOnDate = APP_STATE.tasks.filter(task => 
                            task.completed && 
                            task.completedAt && 
                            new Date(task.completedAt).toDateString() === date.toDateString()
                        ).length;
                        
                        // Count active tasks due on this date
                        const activeOnDate = APP_STATE.tasks.filter(task => 
                            !task.completed && 
                            task.dueDate && 
                            new Date(task.dueDate).toDateString() === date.toDateString()
                        ).length;
                        
                        completedData.push(completedOnDate);
                        activeData.push(activeOnDate);
                    }
                    
                    window.trendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dateLabels,
                            datasets: [
                                {
                                    label: 'Completed Tasks',
                                    data: completedData,
                                    borderColor: '#28A745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'Active Tasks',
                                    data: activeData,
                                    borderColor: '#5D5CDE',
                                    backgroundColor: 'rgba(93, 92, 222, 0.2)',
                                    fill: true,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            }
                        }
                    });
                },
                
                // Open task modal for adding or editing a task
                openTaskModal: (taskId = null) => {
                    const taskModal = DOM.taskModal;
                    const taskForm = DOM.taskForm;
                    const taskModalTitle = DOM.taskModalTitle;
                    
                    // Reset form
                    taskForm.reset();
                    document.getElementById('subtasksList').innerHTML = '';
                    
                    if (taskId) {
                        // Editing existing task
                        const task = APP_STATE.tasks.find(t => t.id === taskId);
                        if (!task) return;
                        
                        APP_STATE.editingTaskId = taskId;
                        taskModalTitle.textContent = 'Edit Task';
                        
                        // Fill form with task data
                        document.getElementById('taskTitle').value = task.title;
                        document.getElementById('taskDescription').value = task.description || '';
                        document.getElementById('taskCategory').value = task.categoryId || '';
                        document.getElementById('taskPriority').value = task.priority;
                        document.getElementById('taskAssignee').value = task.assigneeId || '';
                        
                        if (task.dueDate) {
                            document.getElementById('taskDueDate')._flatpickr.setDate(task.dueDate);
                        }
                        
                        // Add subtasks
                        if (task.subtasks && task.subtasks.length > 0) {
                            const subtasksList = document.getElementById('subtasksList');
                            subtasksList.innerHTML = '';
                            
                            task.subtasks.forEach(subtask => {
                                const subtaskItem = document.createElement('div');
                                subtaskItem.classList.add('subtask-item');
                                subtaskItem.innerHTML = `
                                    <span class="subtask-title">${subtask.title}</span>
                                    <div class="subtask-actions">
                                        <button type="button" class="task-btn delete-subtask" data-subtask-id="${subtask.id}">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `;
                                subtasksList.appendChild(subtaskItem);
                            });
                            
                            // Add event listeners to delete subtask buttons
                            document.querySelectorAll('.delete-subtask').forEach(button => {
                                button.addEventListener('click', function() {
                                    const subtaskId = this.getAttribute('data-subtask-id');
                                    const task = APP_STATE.tasks.find(t => t.id === APP_STATE.editingTaskId);
                                    
                                    if (task) {
                                        task.subtasks = task.subtasks.filter(s => s.id !== subtaskId);
                                        this.closest('.subtask-item').remove();
                                    }
                                });
                            });
                        }
                    } else {
                        // Adding new task
                        APP_STATE.editingTaskId = null;
                        taskModalTitle.textContent = 'Add New Task';
                        
                        // Set default values
                        document.getElementById('taskPriority').value = 'medium';
                        document.getElementById('taskAssignee').value = APP_STATE.currentUser.id;
                    }
                    
                    // Show modal
                    taskModal.classList.add('active');
                },
                
                // Open category modal for adding or editing a category
                openCategoryModal: (categoryId = null) => {
                    const categoryModal = DOM.categoryModal;
                    const categoryForm = document.getElementById('categoryForm');
                    const categoryModalTitle = document.getElementById('categoryModalTitle');
                    
                    // Reset form
                    categoryForm.reset();
                    
                    if (categoryId) {
                        // Editing existing category
                        const category = APP_STATE.categories.find(c => c.id === categoryId);
                        if (!category) return;
                        
                        APP_STATE.editingCategoryId = categoryId;
                        categoryModalTitle.textContent = 'Edit Category';
                        
                        // Fill form with category data
                        document.getElementById('categoryName').value = category.name;
                        document.getElementById('categoryColor').value = category.color;
                        document.getElementById('categoryDescription').value = category.description || '';
                    } else {
                        // Adding new category
                        APP_STATE.editingCategoryId = null;
                        categoryModalTitle.textContent = 'Add New Category';
                        
                        // Set default values
                        document.getElementById('categoryColor').value = '#5D5CDE';
                    }
                    
                    // Show modal
                    categoryModal.classList.add('active');
                },
                
                // Open user modal for adding or editing a user
                openUserModal: (userId = null) => {
                    const userModal = DOM.userModal;
                    const userForm = document.getElementById('userForm');
                    const userModalTitle = document.getElementById('userModalTitle');
                    
                    // Reset form
                    userForm.reset();
                    
                    if (userId) {
                        // Editing existing user
                        const user = APP_STATE.users.find(u => u.id === userId);
                        if (!user) return;
                        
                        APP_STATE.editingUserId = userId;
                        userModalTitle.textContent = 'Edit User';
                        
                        // Fill form with user data
                        document.getElementById('userName').value = user.name;
                        document.getElementById('userEmail').value = user.email;
                        document.getElementById('userRole').value = user.role;
                        
                        // Disable email field for current user
                        const emailField = document.getElementById('userEmail');
                        if (userId === APP_STATE.currentUser.id) {
                            emailField.setAttribute('disabled', 'disabled');
                        } else {
                            emailField.removeAttribute('disabled');
                        }
                    } else {
                        // Adding new user
                        APP_STATE.editingUserId = null;
                        userModalTitle.textContent = 'Add New User';
                        
                        // Set default values
                        document.getElementById('userRole').value = 'member';
                        document.getElementById('userEmail').removeAttribute('disabled');
                    }
                    
                    // Show modal
                    userModal.classList.add('active');
                },
                
                // Open export modal
                openExportModal: () => {
                    document.getElementById('exportModal').classList.add('active');
                },
                
                // Open import modal
                openImportModal: () => {
                    document.getElementById('importModal').classList.add('active');
                    document.getElementById('importData').value = '';
                },
                
                // Start timer for a task
                startTaskTimer: (taskId) => {
                    const task = APP_STATE.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    
                    // Stop any existing timer
                    if (APP_STATE.timer.active) {
                        UI.stopTaskTimer();
                    }
                    
                    // Start new timer
                    APP_STATE.timer.active = true;
                    APP_STATE.timer.startTime = Date.now();
                    APP_STATE.timer.currentTaskId = taskId;
                    
                    // Update task button
                    const taskPlayBtn = document.querySelector(`.task-btn.play[data-task-id="${taskId}"]`);
                    if (taskPlayBtn) {
                        taskPlayBtn.innerHTML = '<i class="fas fa-stop"></i>';
                        taskPlayBtn.classList.remove('play');
                        taskPlayBtn.classList.add('stop');
                    }
                    
                    // Update timer display
                    const timerDisplay = document.getElementById('timerDisplay');
                    timerDisplay.innerHTML = `
                        <i class="fas fa-clock"></i>
                        <span id="timerValue">00:00:00</span>
                        <span class="ml-2">${task.title}</span>
                    `;
                    
                    // Set up interval to update timer
                    APP_STATE.timer.interval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - APP_STATE.timer.startTime) / 1000) + task.timeSpent;
                        document.getElementById('timerValue').textContent = Utils.formatTime(elapsed);
                    }, 1000);
                    
                    UI.showToast('Timer Started', `Tracking time for "${task.title}"`, 'info');
                },
                
                // Stop the active task timer
                stopTaskTimer: () => {
                    if (!APP_STATE.timer.active) return;
                    
                    clearInterval(APP_STATE.timer.interval);
                    
                    const taskId = APP_STATE.timer.currentTaskId;
                    const task = APP_STATE.tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        const elapsedSeconds = Math.floor((Date.now() - APP_STATE.timer.startTime) / 1000);
                        task.timeSpent = (task.timeSpent || 0) + elapsedSeconds;
                        Storage.saveTasks(APP_STATE.tasks);
                        
                        // Update task button
                        const taskStopBtn = document.querySelector(`.task-btn.stop[data-task-id="${taskId}"]`);
                        if (taskStopBtn) {
                            taskStopBtn.innerHTML = '<i class="fas fa-play"></i>';
                            taskStopBtn.classList.remove('stop');
                            taskStopBtn.classList.add('play');
                        }
                        
                        // Reset timer display
                        document.getElementById('timerDisplay').innerHTML = `
                            <i class="fas fa-clock"></i>
                            <span id="timerValue">00:00:00</span>
                        `;
                        
                        UI.showToast('Timer Stopped', `Time tracked for "${task.title}": ${Utils.formatTime(elapsedSeconds)}`, 'success');
                    }
                    
                    // Reset timer state
                    APP_STATE.timer.active = false;
                    APP_STATE.timer.startTime = null;
                    APP_STATE.timer.elapsed = 0;
                    APP_STATE.timer.currentTaskId = null;
                },
                
                // Start focus mode for a task
                startFocusMode: (taskId) => {
                    const task = APP_STATE.tasks.find(t => t.id === taskId);
                    if (!task) return;
                    
                    APP_STATE.focusMode.active = true;
                    APP_STATE.focusMode.taskId = taskId;
                    APP_STATE.focusMode.timeRemaining = 25 * 60; // 25 minutes in seconds
                    
                    document.getElementById('focusTaskTitle').textContent = `Working on: ${task.title}`;
                    document.getElementById('focusTimer').textContent = '25:00';
                    
                    DOM.focusMode.classList.add('active');
                    
                    // Start countdown
                    APP_STATE.focusMode.interval = setInterval(() => {
                        APP_STATE.focusMode.timeRemaining--;
                        
                        const minutes = Math.floor(APP_STATE.focusMode.timeRemaining / 60);
                        const seconds = APP_STATE.focusMode.timeRemaining % 60;
                        
                        document.getElementById('focusTimer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        if (APP_STATE.focusMode.timeRemaining <= 0) {
                            UI.endFocusMode();
                            UI.showToast('Focus Session Complete', 'Take a short break before starting another session', 'success');
                            
                            // Play notification sound
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8OC5dCMGJnnI8ea9djAAAyWk7vftwH8vBwIVi+P2/tGGLCQUBmTa9v7ninQzEwMwk+f//9OOUEMbByU31vz84rCJVDAFDDbI/P/fh1tUGAARid7//8lYT0UZADqp7///oEY/GwAknPL//35ALwgzsu///1csEwBbyv///zYOAILd////EQA9x/7//wwA4+3///8GAGPF//+7keP/qjBV0///iSH7/28Xs///Wg///+rs///9VwP//1EA///HAP//4wD//ygB//+CAf//pgL//4YF//+jCP//pw3//3ES//9nF///Vh3//2oj//+fKP//jS3//1ky//89N///Xzz//9JB//+3Rf//1kj//yJL//+YTP//9E3///dO///fT///4FD//xZS//+wU///b1b//2ZZ//8zXP//SGD//9pk//+Naf//9W7//6J0//8Je///jYP//7SJ//9wkP/6Y5f/5GSf/85lpv+5ea7/nZK2/4entP9in7L/fJyy/1qUrl9Gn61WRayuSjGzr28kuLOOHbm1vB5RmY8FQZWHDl6jmQxMlXwJOYdfA0PHXQdPuWwOLaE5CxeECgQndiYGEWkYBwpfEAIBXBUBDVQZAQhMEgIHQQsDAzoIBAI1BQUCLwQMAiYDFwIcAiQCFQFFAg4BZAILAY4CBACiAgMArAICAK0CAQCXAQGUEAEFIQMBBG0VPAJFHyADAAAFBwAA';
                            audio.play().catch(e => console.log('Audio play error:', e));
                        }
                    }, 1000);
                },
                
                // End focus mode
                endFocusMode: () => {
                    clearInterval(APP_STATE.focusMode.interval);
                    
                    APP_STATE.focusMode.active = false;
                    DOM.focusMode.classList.remove('active');
                    
                    // Track time for the task
                    if (APP_STATE.focusMode.taskId) {
                        const task = APP_STATE.tasks.find(t => t.id === APP_STATE.focusMode.taskId);
                        if (task) {
                            const timeSpent = 25 * 60 - APP_STATE.focusMode.timeRemaining;
                            task.timeSpent = (task.timeSpent || 0) + timeSpent;
                            Storage.saveTasks(APP_STATE.tasks);
                            
                            // Update task list if visible
                            UI.renderTasks();
                        }
                    }
                    
                    // Reset focus mode state
                    APP_STATE.focusMode.taskId = null;
                    APP_STATE.focusMode.timeRemaining = 0;
                },
                
                // Show toast notification
                showToast: (title, message, type = 'info') => {
                    const toastContainer = DOM.toastContainer;
                    
                    const toast = document.createElement('div');
                    toast.classList.add('toast', `toast-${type}`);
                    
                    let iconClass = 'fas fa-info-circle';
                    if (type === 'success') {
                        iconClass = 'fas fa-check-circle';
                    } else if (type === 'warning') {
                        iconClass = 'fas fa-exclamation-triangle';
                    } else if (type === 'error') {
                        iconClass = 'fas fa-times-circle';
                    }
                    
                    toast.innerHTML = `
                        <div class="toast-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="toast-content">
                            <div class="toast-title">${title}</div>
                            <div class="toast-message">${message}</div>
                        </div>
                        <button class="toast-close" aria-label="Close toast">&times;</button>
                    `;
                    
                    toastContainer.appendChild(toast);
                    
                    // Auto-remove toast after 5 seconds
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            toastContainer.removeChild(toast);
                        }, 300);
                    }, 5000);
                    
                    // Add close button functionality
                    toast.querySelector('.toast-close').addEventListener('click', () => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            toastContainer.removeChild(toast);
                        }, 300);
                    });
                },
                
                // Set up all event listeners
                setupEventListeners: () => {
                    // Auth events
                    DOM.toggleAuth.addEventListener('click', () => {
                        const isLogin = DOM.authTitle.textContent.includes('Login');
                        
                        if (isLogin) {
                            // Switch to register
                            DOM.authTitle.textContent = 'Register for Todo App';
                            DOM.authSubmitBtn.textContent = 'Register';
                            DOM.toggleText.textContent = 'Already have an account?';
                            DOM.toggleAuth.textContent = 'Login';
                            DOM.nameGroup.style.display = 'block';
                            DOM.confirmPasswordGroup.style.display = 'block';
                        } else {
                            // Switch to login
                            DOM.authTitle.textContent = 'Login to Todo App';
                            DOM.authSubmitBtn.textContent = 'Login';
                            DOM.toggleText.textContent = 'Don\'t have an account?';
                            DOM.toggleAuth.textContent = 'Register';
                            DOM.nameGroup.style.display = 'none';
                            DOM.confirmPasswordGroup.style.display = 'none';
                        }
                    });
                    
                    DOM.authForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        const isLogin = DOM.authTitle.textContent.includes('Login');
                        const email = document.getElementById('email').value.trim();
                        const password = document.getElementById('password').value;
                        
                        // Reset error messages
                        document.getElementById('emailError').style.display = 'none';
                        document.getElementById('passwordError').style.display = 'none';
                        
                        if (isLogin) {
                            // Login logic
                            // In a real app, this would make an API call to verify credentials
                            // For this demo, we'll check if the user exists in localStorage
                            
                            // Get all users
                            const users = Storage.getUsers();
                            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
                            
                            if (!user) {
                                document.getElementById('emailError').textContent = 'User not found';
                                document.getElementById('emailError').style.display = 'block';
                                return;
                            }
                            
                            // In a real app, we would verify the password hash here
                            // For this demo, we'll just check if it matches (insecure, just for demonstration)
                            if (password !== 'password') { // Fixed password for demo
                                document.getElementById('passwordError').textContent = 'Incorrect password';
                                document.getElementById('passwordError').style.display = 'block';
                                return;
                            }
                            
                            // Set current user
                            APP_STATE.currentUser = user;
                            Storage.saveUser(user);
                            
                            // Show dashboard
                            UI.showDashboard();
                            
                            // Create welcome notification
                            DataService.createNotification({
                                title: 'Welcome Back!',
                                message: `Good to see you, ${user.name}! You have ${DataService.getTaskCountsByStatus().active} active tasks.`,
                                type: 'info',
                                read: false
                            });
                        } else {
                            // Register logic
                            const name = document.getElementById('name').value.trim();
                            const confirmPassword = document.getElementById('confirmPassword').value;
                            
                            // Validate form
                            let hasError = false;
                            
                            if (!name) {
                                document.getElementById('nameError').style.display = 'block';
                                hasError = true;
                            }
                            
                            if (!email || !/\S+@\S+\.\S+/.test(email)) {
                                document.getElementById('emailError').style.display = 'block';
                                hasError = true;
                            }
                            
                            if (password.length < 6) {
                                document.getElementById('passwordError').style.display = 'block';
                                hasError = true;
                            }
                            
                            if (password !== confirmPassword) {
                                document.getElementById('confirmPasswordError').style.display = 'block';
                                hasError = true;
                            }
                            
                            if (hasError) return;
                            
                            // Check if email is already registered
                            const users = Storage.getUsers();
                            if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                                document.getElementById('emailError').textContent = 'Email already registered';
                                document.getElementById('emailError').style.display = 'block';
                                return;
                            }
                            
                            // Create user
                            const newUser = {
                                name,
                                email,
                                role: 'admin', // First user is admin
                                avatar: Utils.createInitialsAvatar(name),
                                // In a real app, we would hash the password
                                // For this demo, we'll store the password directly (insecure, just for demonstration)
                                password: 'password' // Fixed password for demo
                            };
                            
                            const createdUser = DataService.createUser(newUser);
                            
                            // Set as current user
                            APP_STATE.currentUser = createdUser;
                            Storage.saveUser(createdUser);
                            
                            // Show dashboard
                            UI.showDashboard();
                            
                            // Create welcome notification
                            DataService.createNotification({
                                title: 'Welcome to Todo App!',
                                message: 'Your account has been created successfully. Get started by adding your first task.',
                                type: 'success',
                                read: false
                            });
                        }
                    });
                    
                    // Theme toggle
                    document.getElementById('themeToggle').addEventListener('click', () => {
                        document.documentElement.classList.toggle('dark');
                        
                        const isDark = document.documentElement.classList.contains('dark');
                        document.getElementById('themeToggle').innerHTML = isDark ? 
                            '<i class="fas fa-sun"></i>' : 
                            '<i class="fas fa-moon"></i>';
                    });
                    
                    // Navigation tabs
                    DOM.navTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            const tabName = tab.getAttribute('data-tab');
                            
                            // Update active tab
                            DOM.navTabs.forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            
                            // Update active content
                            DOM.tabContents.forEach(content => {
                                content.classList.remove('active');
                            });
                            
                            document.getElementById(`${tabName}Tab`).classList.add('active');
                        });
                    });
                    
                    // View toggle
                    document.querySelector('.list-view').addEventListener('click', function() {
                        this.classList.add('active');
                        document.querySelector('.graph-view').classList.remove('active');
                        document.getElementById('listView').style.display = 'block';
                        document.getElementById('graphView').style.display = 'none';
                    });
                    
                    document.querySelector('.graph-view').addEventListener('click', function() {
                        this.classList.add('active');
                        document.querySelector('.list-view').classList.remove('active');
                        document.getElementById('listView').style.display = 'none';
                        document.getElementById('graphView').style.display = 'block';
                        UI.updateTaskChart();
                    });
                    
                    // Task actions
                    document.getElementById('addTaskBtn').addEventListener('click', () => {
                        UI.openTaskModal();
                    });
                    
                    document.getElementById('clearCompletedBtn').addEventListener('click', () => {
                        const completedTasks = APP_STATE.tasks.filter(task => task.completed);
                        
                        if (completedTasks.length === 0) {
                            UI.showToast('No Completed Tasks', 'There are no completed tasks to clear', 'info');
                            return;
                        }
                        
                        if (confirm(`Are you sure you want to delete ${completedTasks.length} completed tasks?`)) {
                            APP_STATE.tasks = APP_STATE.tasks.filter(task => !task.completed);
                            Storage.saveTasks(APP_STATE.tasks);
                            UI.renderTasks();
                            UI.renderInsights();
                            UI.showToast('Tasks Cleared', `${completedTasks.length} completed tasks have been removed`, 'success');
                        }
                    });
                    
                    // Category actions
                    document.getElementById('addCategoryBtn').addEventListener('click', () => {
                        UI.openCategoryModal();
                    });
                    
                    // User actions
                    document.getElementById('addUserBtn').addEventListener('click', () => {
                        UI.openUserModal();
                    });
                    
                    // Task form
                    document.getElementById('closeTaskModal').addEventListener('click', () => {
                        document.getElementById('taskModal').classList.remove('active');
                    });
                    
                    document.getElementById('cancelTaskBtn').addEventListener('click', () => {
                        document.getElementById('taskModal').classList.remove('active');
                    });
                    
                    document.getElementById('saveTaskBtn').addEventListener('click', () => {
                        const title = document.getElementById('taskTitle').value.trim();
                        if (!title) {
                            alert('Task title is required');
                            return;
                        }
                        
                        const taskData = {
                            title,
                            description: document.getElementById('taskDescription').value.trim(),
                            categoryId: document.getElementById('taskCategory').value || null,
                            priority: document.getElementById('taskPriority').value,
                            assigneeId: document.getElementById('taskAssignee').value || null,
                            dueDate: document.getElementById('taskDueDate')._flatpickr.selectedDates[0]?.toISOString() || null
                        };
                        
                        // Get subtasks
                        const subtasksElements = document.querySelectorAll('.subtask-item');
                        const subtasks = [];
                        
                        if (subtasksElements.length > 0) {
                            subtasksElements.forEach(element => {
                                const title = element.querySelector('.subtask-title').textContent;
                                const subtaskId = element.querySelector('.delete-subtask')?.getAttribute('data-subtask-id') || Utils.generateId();
                                
                                subtasks.push({
                                    id: subtaskId,
                                    title,
                                    completed: false
                                });
                            });
                            
                            taskData.subtasks = subtasks;
                        }
                        
                        if (APP_STATE.editingTaskId) {
                            // Update existing task
                            const task = APP_STATE.tasks.find(t => t.id === APP_STATE.editingTaskId);
                            
                            // Preserve completion status and timeSpent
                            taskData.completed = task.completed;
                            taskData.completedAt = task.completedAt;
                            taskData.timeSpent = task.timeSpent;
                            
                            // Preserve existing subtasks completion status
                            if (task.subtasks && taskData.subtasks) {
                                taskData.subtasks.forEach(subtask => {
                                    const existingSubtask = task.subtasks.find(s => s.id === subtask.id);
                                    if (existingSubtask) {
                                        subtask.completed = existingSubtask.completed;
                                    }
                                });
                            }
                            
                            DataService.updateTask(APP_STATE.editingTaskId, taskData);
                            UI.showToast('Task Updated', 'Task has been updated successfully', 'success');
                        } else {
                            // Create new task
                            DataService.createTask(taskData);
                            UI.showToast('Task Created', 'New task has been added successfully', 'success');
                        }
                        
                        document.getElementById('taskModal').classList.remove('active');
                        UI.renderTasks();
                        UI.renderInsights();
                    });
                    
                    // Add subtask
                    document.getElementById('addSubtaskBtn').addEventListener('click', () => {
                        const subtaskTitle = document.getElementById('newSubtask').value.trim();
                        if (!subtaskTitle) return;
                        
                        const subtasksList = document.getElementById('subtasksList');
                        const subtaskItem = document.createElement('div');
                        subtaskItem.classList.add('subtask-item');
                        
                        const subtaskId = Utils.generateId();
                        
                        subtaskItem.innerHTML = `
                            <span class="subtask-title">${subtaskTitle}</span>
                            <div class="subtask-actions">
                                <button type="button" class="task-btn delete-subtask" data-subtask-id="${subtaskId}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        
                        subtasksList.appendChild(subtaskItem);
                        document.getElementById('newSubtask').value = '';
                        
                        // Add event listener to delete button
                        subtaskItem.querySelector('.delete-subtask').addEventListener('click', function() {
                            subtaskItem.remove();
                        });
                    });
                    
                    // Add 'Enter' key support for adding subtasks
                    document.getElementById('newSubtask').addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            document.getElementById('addSubtaskBtn').click();
                        }
                    });
                    
                    // Category form
                    document.getElementById('closeCategoryModal').addEventListener('click', () => {
                        document.getElementById('categoryModal').classList.remove('active');
                    });
                    
                    document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
                        document.getElementById('categoryModal').classList.remove('active');
                    });
                    
                    document.getElementById('saveCategoryBtn').addEventListener('click', () => {
                        const name = document.getElementById('categoryName').value.trim();
                        if (!name) {
                            alert('Category name is required');
                            return;
                        }
                        
                        const categoryData = {
                            name,
                            color: document.getElementById('categoryColor').value,
                            description: document.getElementById('categoryDescription').value.trim()
                        };
                        
                        if (APP_STATE.editingCategoryId) {
                            // Update existing category
                            DataService.updateCategory(APP_STATE.editingCategoryId, categoryData);
                            UI.showToast('Category Updated', 'Category has been updated successfully', 'success');
                        } else {
                            // Create new category
                            DataService.createCategory(categoryData);
                            UI.showToast('Category Created', 'New category has been added successfully', 'success');
                        }
                        
                        document.getElementById('categoryModal').classList.remove('active');
                        UI.renderCategories();
                        UI.renderTasks();
                    });
                    
                    // User form
                    document.getElementById('closeUserModal').addEventListener('click', () => {
                        document.getElementById('userModal').classList.remove('active');
                    });
                    
                    document.getElementById('cancelUserBtn').addEventListener('click', () => {
                        document.getElementById('userModal').classList.remove('active');
                    });
                    
                    document.getElementById('saveUserBtn').addEventListener('click', () => {
                        const name = document.getElementById('userName').value.trim();
                        const email = document.getElementById('userEmail').value.trim();
                        
                        if (!name) {
                            alert('User name is required');
                            return;
                        }
                        
                        if (!email || !/\S+@\S+\.\S+/.test(email)) {
                            alert('Valid email is required');
                            return;
                        }
                        
                        const userData = {
                            name,
                            email,
                            role: document.getElementById('userRole').value
                        };
                        
                        if (APP_STATE.editingUserId) {
                            // Update existing user
                            DataService.updateUser(APP_STATE.editingUserId, userData);
                            UI.showToast('User Updated', 'User has been updated successfully', 'success');
                        } else {
                            // Check if email is already used
                            if (APP_STATE.users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                                alert('Email already in use');
                                return;
                            }
                            
                            // Create new user
                            DataService.createUser(userData);
                            UI.showToast('User Created', 'New user has been added successfully', 'success');
                        }
                        
                        document.getElementById('userModal').classList.remove('active');
                        UI.renderUsers();
                    });
                    
                    // Notification popup
                    document.getElementById('notificationBtn').addEventListener('click', () => {
                        const popup = document.getElementById('notificationPopup');
                        popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
                        
                        // Render notifications when opening
                        if (popup.style.display === 'block') {
                            UI.renderNotifications();
                        }
                    });
                    
                    // Click outside to close notification popup
                    document.addEventListener('click', (e) => {
                        const notificationBtn = document.getElementById('notificationBtn');
                        const popup = document.getElementById('notificationPopup');
                        
                        if (popup.style.display === 'block' && 
                            !popup.contains(e.target) && 
                            !notificationBtn.contains(e.target)) {
                            popup.style.display = 'none';
                        }
                    });
                    
                    // Profile dropdown
                    document.getElementById('userProfileBtn').addEventListener('click', () => {
                        const dropdown = document.getElementById('profileDropdown');
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    });
                    
                    // Click outside to close profile dropdown
                    document.addEventListener('click', (e) => {
                        const profileBtn = document.getElementById('userProfileBtn');
                        const dropdown = document.getElementById('profileDropdown');
                        
                        if (dropdown.style.display === 'block' && 
                            !dropdown.contains(e.target) && 
                            !profileBtn.contains(e.target)) {
                            dropdown.style.display = 'none';
                        }
                    });
                    
                    // Logout button
                    document.getElementById('logoutBtn').addEventListener('click', () => {
                        APP_STATE.currentUser = null;
                        Storage.saveUser(null);
                        UI.showLogin();
                    });
                    
                    // Filter events
                    document.getElementById('statusFilter').addEventListener('change', function() {
                        APP_STATE.filters.status = this.value;
                        UI.renderTasks();
                    });
                    
                    document.getElementById('categoryFilter').addEventListener('change', function() {
                        APP_STATE.filters.category = this.value;
                        UI.renderTasks();
                    });
                    
                    document.getElementById('priorityFilter').addEventListener('change', function() {
                        APP_STATE.filters.priority = this.value;
                        UI.renderTasks();
                    });
                    
                    // Search with debouncing
                    document.getElementById('searchTask').addEventListener('input', Utils.debounce(function() {
                        APP_STATE.filters.search = this.value.trim();
                        UI.renderTasks();
                    }, 300));
                    
                    // Export button
                    document.getElementById('exportBtn').addEventListener('click', () => {
                        UI.openExportModal();
                    });
                    
                    // Import button
                    document.getElementById('importBtn').addEventListener('click', () => {
                        UI.openImportModal();
                    });
                    
                    // Export modal
                    document.getElementById('closeExportModal').addEventListener('click', () => {
                        document.getElementById('exportModal').classList.remove('active');
                    });
                    
                    document.getElementById('cancelExportBtn').addEventListener('click', () => {
                        document.getElementById('exportModal').classList.remove('active');
                    });
                    
                    document.getElementById('confirmExportBtn').addEventListener('click', () => {
                        const format = document.getElementById('exportFormat').value;
                        const options = {
                            includeCompleted: document.getElementById('includeCompleted').checked,
                            includeSubtasks: document.getElementById('includeSubtasks').checked
                        };
                        
                        const blob = DataService.exportTasks(format, options);
                        
                        if (blob) {
                            // Since direct file downloads don't work in the iframe due to sandbox restrictions
                            // use a Data URL to display the content where possible or provide instructions
                            if (format === 'json') {
                                const jsonText = JSON.stringify(
                                    JSON.parse(new TextDecoder().decode(new Uint8Array(await blob.arrayBuffer()))), 
                                    null, 2
                                );
                                
                                // Show export data in a modal
                                alert("Right-click in the text area and select 'Save as...' to download the JSON data");
                                
                                // Create a modal to show the JSON
                                const modalBackdrop = document.createElement('div');
                                modalBackdrop.classList.add('modal-backdrop');
                                modalBackdrop.classList.add('active');
                                
                                modalBackdrop.innerHTML = `
                                    <div class="modal">
                                        <div class="modal-header">
                                            <h3 class="modal-title">Export Data (JSON)</h3>
                                            <button class="modal-close" id="closeJsonModal">&times;</button>
                                        </div>
                                        <div class="modal-body">
                                            <textarea id="jsonExportData" style="width: 100%; min-height: 300px; font-family: monospace; white-space: pre; font-size: 12px;">${jsonText}</textarea>
                                        </div>
                                        <div class="modal-footer">
                                            <button class="btn btn-primary" id="closeJsonModalBtn">Close</button>
                                        </div>
                                    </div>
                                `;
                                
                                document.body.appendChild(modalBackdrop);
                                
                                document.getElementById('closeJsonModal').addEventListener('click', () => {
                                    document.body.removeChild(modalBackdrop);
                                });
                                
                                document.getElementById('closeJsonModalBtn').addEventListener('click', () => {
                                    document.body.removeChild(modalBackdrop);
                                });
                                
                                // Select all text in the textarea
                                const textarea = document.getElementById('jsonExportData');
                                textarea.select();
                            } else {
                                // For other formats, we can't easily display them in the browser
                                UI.showToast('Export Not Supported', 'Due to sandbox restrictions, we can\'t download files directly. Use the JSON export option.', 'warning');
                            }
                        } else {
                            UI.showToast('Export Failed', 'Failed to generate export data', 'error');
                        }
                        
                        document.getElementById('exportModal').classList.remove('active');
                    });
                    
                    // Import modal
                    document.getElementById('closeImportModal').addEventListener('click', () => {
                        document.getElementById('importModal').classList.remove('active');
                    });
                    
                    document.getElementById('cancelImportBtn').addEventListener('click', () => {
                        document.getElementById('importModal').classList.remove('active');
                    });
                    
                    document.getElementById('confirmImportBtn').addEventListener('click', () => {
                        const importData = document.getElementById('importData').value.trim();
                        if (!importData) {
                            UI.showToast('Import Failed', 'No data to import', 'error');
                            return;
                        }
                        
                        const options = {
                            replaceExisting: document.getElementById('replaceExisting').checked,
                            importCategories: document.getElementById('importCategories').checked
                        };
                        
                        const success = DataService.importTasks(importData, options);
                        
                        if (success) {
                            UI.showToast('Import Successful', 'Tasks have been imported successfully', 'success');
                            UI.renderTasks();
                            UI.renderCategories();
                            UI.renderInsights();
                        } else {
                            UI.showToast('Import Failed', 'Invalid data format. Please check your JSON and try again', 'error');
                        }
                        
                        document.getElementById('importModal').classList.remove('active');
                    });
                    
                    // Focus mode
                    document.getElementById('exitFocusBtn').addEventListener('click', () => {
                        UI.endFocusMode();
                    });
                }
            };
            
            // Initialize the app
            UI.init();
        });
    </script>
</body>
</html>
