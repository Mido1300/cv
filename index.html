<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>To-Do App</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/8832/8832119.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    :root {
      --primary: #246bfd;
      --primary-light: #e6f0ff;
      --success: #34c759;
      --warning: #ffc600;
      --danger: #ff3b30;
      --grey: #adb5bd;
      --dark-bg: #242526;
      --light-bg: #ffffff;
      --dark-text: #ececec;
      --light-text: #242526;
      --transition: 0.2s all;
      --shadow: 0 2px 16px 0 rgba(52, 106, 253, 0.07);
      --header-height: 64px;
    }
    [data-theme="dark"] {
      --bg: var(--dark-bg);
      --text: var(--dark-text);
    }
    [data-theme="light"] {
      --bg: var(--light-bg);
      --text: var(--light-text);
    }
    html, body { height: 100%; margin: 0; }
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      transition: var(--transition);
    }
    a { color: var(--primary); text-decoration: none }
    a:hover { text-decoration: underline }
    /* === Auth (Login/Register) === */
    .auth-container {
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, var(--primary-light), var(--bg) 60%);
      transition: var(--transition);
    }
    .auth-card {
      background: var(--bg);
      color: var(--text);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 2rem 2.2rem 1.7rem 2.2rem;
      min-width: 330px;
      width: 100%; max-width: 400px;
      display: flex; flex-direction: column;
      gap: 1.1rem;
      transition: var(--transition);
    }
    .auth-card h2 {margin-bottom: .8rem;}
    .form-group {display: flex; flex-direction: column; gap: 0.2rem;}
    .form-group label {font-size: .97rem;font-weight: 500;}
    .form-group input, .form-group select {
      background: var(--light-bg);
      color: var(--text);
      padding: 0.62rem;
      border: 1px solid var(--grey);
      border-radius: 7px;
      font-size: 1rem;
      transition: var(--transition);
    }
    .form-group input:focus, .form-group select:focus {outline: 2px solid var(--primary);}
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-right: 0.4rem;
    }
    .btn:hover {background: #1749b3;}
    .auth-links {display: flex; gap: 1rem; font-size: 0.94rem;}
    .auth-links a {color: var(--primary);}
    .error-msg {color: var(--danger);margin-bottom: 0.7rem;}
    /* === Header === */
    .header {
      height: var(--header-height);
      background: var(--primary);
      color: #fff;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 1.5rem 0 1rem;
      box-shadow: var(--shadow);
      position: sticky; top:0; z-index: 9;
    }
    .logo-bar {display: flex; align-items: center; gap: 1rem;}
    .logo-bar img {
      width: 38px; height: 38px; border-radius: 50%; background: #fff;
      object-fit: cover; object-position: center;
    }
    .logo-bar h1 {font-size: 1.5rem; font-weight: 700;}
    .header-actions {
      display: flex; align-items: center; gap: 1.2rem;
    }
    /* === Profile === */
    .profile-status {
      width: 44px; height: 44px; border-radius: 50%; overflow: hidden;
      border: 3px solid var(--success); background: #fff; cursor: pointer;
      transition: var(--transition);
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .profile-status[data-status="online"] {border-color: var(--success);}
    .profile-status[data-status="offline"] {border-color: var(--danger);}
    .profile-status[data-status="break"] {border-color: var(--warning);}
    .profile-status[data-status="shadow"] {border-color: var(--grey);}
    .profile-status img {width: 100%; height: 100%; object-fit: cover;}
    .profile-dropdown {
      position: absolute; top: 54px; right: 0;
      background: var(--bg); color: var(--text);
      min-width: 210px; border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 0.7rem 0; z-index: 6;
      display: none; flex-direction: column;
      gap: 2px;
      font-size: 1rem;
      transition: var(--transition);
    }
    .profile-dropdown.open {display: flex;}
    .profile-dropdown .dropdown-item {
      cursor: pointer; padding: 0.6rem 1.2rem;
      transition: background .13s;
      display: flex; align-items: center;gap:0.7rem;
    }
    .profile-dropdown .dropdown-item:hover {background: var(--primary-light);}
    .profile-dropdown .dropdown-item .fa-angle-right {margin-left:auto;}
    .profile-dropdown .dropdown-item.submenu {position: relative;}
    .profile-dropdown .status-menu {
      position: absolute; left: 190px; top: 0;
      background: var(--bg); border-radius: 10px;
      box-shadow: var(--shadow);
      min-width: 120px; display: none; flex-direction: column;
      z-index: 7;
    }
    .profile-dropdown .dropdown-item.submenu:hover .status-menu {display: flex;}
    /* === Notification === */
    .notif-icon {
      position: relative; cursor: pointer; font-size: 1.5rem;
      display: flex; align-items: center;
    }
    .notif-count {
      position: absolute; top: -5px; right: -7px;
      background: var(--danger); color: #fff;
      font-size: .8rem; font-weight: bold;
      border-radius: 50%; padding: 2px 7px;
      pointer-events: none;
    }
    /* === Theme Toggle === */
    .theme-toggle {
      font-size: 1.5rem; cursor: pointer; color: #fff;
      transition: var(--transition);
    }
    .theme-toggle[data-theme="dark"] {color: var(--warning);}
    .theme-toggle[data-theme="light"] {color: #fff;}
    /* === Work Timer === */
    .header-timer {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 1.1rem; padding: 0 0.5rem;
      font-weight: 500;
    }
    .timer-dot {
      width: 12px; height: 12px; border-radius: 50%;
      background: var(--success); display: inline-block;
    }
    .timer-dot[data-status="online"] {background: var(--success);}
    .timer-dot[data-status="offline"] {background: var(--danger);}
    .timer-dot[data-status="break"] {background: var(--warning);}
    .timer-dot[data-status="shadow"] {background: var(--grey);}
    /* === Main (Dashboard) === */
    .main {
      max-width: 1300px;
      margin: 1.8rem auto 1.2rem auto;
      padding: 0 1.3rem;
    }
    .dashboard-alerts {
      display: flex;flex-direction: column;gap:1rem;
      margin-bottom: 1.5rem;
    }
    .alert-card {
      border-radius: 9px;
      padding: 1.1rem 1.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      display: flex; align-items: center; gap: 0.9rem;
      box-shadow: var(--shadow);
      background: var(--primary-light);
      color: var(--primary);
    }
    .alert-card.completed {
      background: #e8ffe7; color: var(--success);
    }
    .alert-card.pending {
      background: #fffbe7; color: var(--warning);
    }
    .alert-card .fa {font-size: 1.4rem;}
    .dashboard-row {
      display: flex; gap: 1.2rem; flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    /* === Task Controls === */
    .task-controls {
      display: flex; align-items: center; gap: 0.7rem;
      flex-wrap: wrap;
      margin-bottom: 1.2rem;
    }
    .view-switcher {
      margin-right: 1.1rem;
      display: flex; gap: .5rem;
    }
    .view-btn {
      background: var(--primary-light);
      color: var(--primary); border: none;
      border-radius: 6px; padding: .55rem .75rem;
      font-size: 1.06rem; font-weight: 600;
      cursor: pointer; transition: var(--transition);
    }
    .view-btn.active {background: var(--primary);color: #fff;}
    .task-btns {
      display: flex; gap: .6rem;
    }
    /* === Task Section === */
    .tasks-section {
      background: var(--bg);
      border-radius: 13px;
      box-shadow: var(--shadow);
      padding: 1.1rem 1.3rem 1.5rem 1.3rem;
      margin-bottom: 2.3rem;
      transition: var(--transition);
    }
    .tasks-header {
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
      margin-bottom: 1.1rem;
    }
    .tasks-title {font-size: 1.4rem; font-weight: 700;}
    .tasks-header .filters {
      display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap;
    }
    .tasks-header input[type="search"], .tasks-header select {
      padding: 0.45rem 0.9rem; border-radius: 7px; border: 1px solid var(--grey);
      font-size: 1rem; background: var(--light-bg); color: var(--text);
      transition: var(--transition);
    }
    .tasks-header .sort-select {width: 130px;}
    .undo-redo-btns {display: flex; gap: 0.3rem;}
    .undo-redo-btns .btn {padding: 0.5rem 0.7rem;font-size:.9rem;}
    /* TASKS LIST/GRID */
    .task-list {display: flex; flex-direction: column; gap:1.1rem;}
    .task-card {
      background: var(--light-bg);
      color: var(--text);
      box-shadow: var(--shadow);
      border-radius: 9px;
      padding: 1.1rem 1rem 1.1rem 1.15rem;
      display: flex; gap: 1.1rem;
      align-items: flex-start;
      position: relative;
      transition: var(--transition);
      border-left: 7px solid var(--primary);
    }
    .task-card.high {border-left-color: var(--danger);}
    .task-card.medium {border-left-color: var(--warning);}
    .task-card.low {border-left-color: var(--grey);}
    .task-card.completed {background: #e8ffe7; border-left-color: var(--success);}
    .task-select {
      margin-top: 5px;
      width: 22px; height: 22px; cursor: pointer;
      accent-color: var(--primary);
    }
    .task-content {
      flex: 1; display: flex; flex-direction: column; gap: 0.5rem;
    }
    .task-title-row {
      display: flex; align-items: center; gap: 0.7rem;
      margin-bottom: 0.3rem;
    }
    .task-title {
      font-size: 1.15rem; font-weight: 600; word-break: break-word;
    }
    .task-priority.high {color: var(--danger);}
    .task-priority.medium {color: var(--warning);}
    .task-priority.low {color: var(--grey);}
    .task-meta {font-size: .94rem; color: var(--grey);}
    .task-subtasks {margin-top: 0.4rem; font-size: 0.99rem;}
    .task-notes {font-size: 0.97rem; color: #666;}
    .task-actions {
      display: flex; flex-direction: column; gap: 0.7rem; align-items: flex-end;
    }
    .task-action-btn {
      background: none; border: none; color: var(--primary); cursor: pointer;
      font-size: 1.3rem; padding: 0.2rem;
      transition: color 0.14s;
    }
    .task-action-btn:hover {color: var(--danger);}
    .task-timer {
      font-size: .98rem; color: var(--primary); margin-bottom: 0.2rem;
      display: flex; align-items: center; gap: .2rem;
    }
    .task-alert {
      font-size: 0.97rem; font-weight: 600;
      margin-top: 0.3rem;
      display: flex; align-items: center; gap: 0.3rem;
    }
    .task-alert.danger {color: var(--danger);}
    .task-alert.warning {color: var(--warning);}
    .task-alert.success {color: var(--success);}
    .task-alert .fa {margin-right: 3px;}
    .drag-handle {
      cursor: grab; color: var(--primary); font-size: 1.1rem; margin-top: 2px;
      opacity:.6;transition:opacity .1s;
    }
    .drag-handle:active {opacity:1;}
    /* === Bulk Actions === */
    .bulk-actions-bar {
      position: sticky; bottom: 2.2rem; left: 0; right: 0; margin:0 auto;
      max-width: 700px;
      background: var(--primary); color: #fff;
      border-radius: 10px; box-shadow: var(--shadow);
      padding: .75rem 1.2rem;
      display: flex; align-items: center; gap: 1.3rem;
      z-index: 2; margin-top: 1.2rem;
      animation: fadeIn 0.17s;
    }
    /* === Modal/Popup === */
    .modal-mask {
      position: fixed; top:0; left:0; width:100vw; height:100vh;
      background: rgba(30,30,30,0.19); z-index: 100;
      display: flex; align-items: center; justify-content: center;
      animation: fadeIn .20s;
    }
    @keyframes fadeIn {from{opacity:0} to{opacity:1}}
    .modal {
      background: var(--bg); color: var(--text);
      border-radius: 13px; box-shadow: var(--shadow);
      min-width: 320px;
      width: 96vw; max-width: 420px;
      padding: 1.7rem 2.2rem 1.5rem 2.2rem;
      position: relative;
      animation: fadeIn .17s;
      z-index: 110;
    }
    .modal h2 {font-size: 1.22rem; font-weight: 600; margin-bottom:0.7rem;}
    .modal-close {
      position: absolute; top: 11px; right: 13px;
      background: none; color: var(--grey);
      border: none; font-size: 1.45rem; cursor: pointer;
      padding: 1px 8px;
    }
    /* === Toast Notification === */
    .toast-container {
      position: fixed; left: 20px; bottom: 24px; z-index: 120;
      display: flex; flex-direction: column; gap: 0.7rem;
      min-width: 220px; max-width: 340px;
      pointer-events: none;
    }
    .toast {
      background: var(--primary);
      color: #fff;
      border-radius: 7px;
      padding: 0.95rem 1.35rem;
      font-size: 1.05rem; font-weight: 500;
      box-shadow: var(--shadow);
      opacity: 0.97;
      pointer-events: auto;
      animation: toastIn 0.22s;
    }
    @keyframes toastIn {from{transform:translateY(32px);opacity:0}to{transform:translateY(0);opacity:1}}
    /* === Users Modal === */
    .users-list {display: flex; flex-direction: column; gap: 1.1rem;}
    .user-row {
      display: flex;align-items: center; gap: 1.1rem;
      background: var(--primary-light); color: var(--primary);
      border-radius: 7px; padding: 0.7rem 1rem;
      box-shadow: var(--shadow);
    }
    .user-row img {width: 36px; height: 36px; border-radius: 50%; object-fit: cover;}
    .user-info {flex: 1; display: flex; flex-direction: column;}
    .user-role {font-size: 0.92rem; color: var(--grey);}
    /* === Graphs & Insights === */
    .graphs-section {
      background: var(--light-bg); color: var(--text);
      border-radius: 13px; box-shadow: var(--shadow);
      padding: 1.2rem 1.1rem 1.5rem 1.1rem;
      margin-bottom: 2.2rem;
      transition: var(--transition);
    }
    .charts-row {
      display: flex; gap: 1.7rem; flex-wrap: wrap;
      justify-content: space-between;
    }
    .chart-box {
      background: var(--primary-light);
      border-radius: 8px; box-shadow: var(--shadow);
      padding: 0.9rem 1.1rem;
      min-width: 220px;flex: 1;
      margin-bottom: 0.9rem;
    }
    .chart-title {font-size: 1.05rem;font-weight:600;margin-bottom:7px;}
    /* === Insights === */
    .insights-section {
      background: var(--light-bg); color: var(--text);
      border-radius: 13px; box-shadow: var(--shadow);
      padding: 1.2rem 1.1rem 1.5rem 1.1rem;
      margin-bottom: 2.2rem;
      transition: var(--transition);
    }
    .insight-row {margin-bottom: 0.7rem;}
    .insight-label {font-weight: 600;}
    /* === Responsive === */
    @media (max-width: 960px) {
      .main {padding:0 0.4rem;}
      .dashboard-row {flex-direction: column;}
      .tasks-section, .graphs-section, .insights-section {padding:0.8rem 0.4rem;}
    }
    @media (max-width: 600px) {
      .header {flex-direction: column; height: auto; padding: 1rem 0.4rem;}
      .logo-bar h1 {font-size:1.1rem;}
      .header-actions {gap:0.6rem;}
      .dashboard-alerts {gap:0.7rem;}
      .task-list {gap:0.7rem;}
      .bulk-actions-bar {padding: .5rem 0.5rem;}
    }
  </style>
</head>
<body>
  <!-- LOGIN/REGISTER PAGE -->
  <div id="authPage" class="auth-container" style="display:flex;">
    <div class="auth-card" id="loginCard">
      <h2><img src="https://cdn-icons-png.flaticon.com/512/8832/8832119.png" style="width:32px;vertical-align:middle;"> To-Do App Login</h2>
      <div id="loginErr" class="error-msg" style="display:none"></div>
      <form id="loginForm" autocomplete="on">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn">Login</button>
      </form>
      <div class="auth-links">
        <a href="#" id="gotoRegister">Create new account</a>
      </div>
    </div>
    <div class="auth-card" id="registerCard" style="display:none;">
      <h2><img src="https://cdn-icons-png.flaticon.com/512/8832/8832119.png" style="width:32px;vertical-align:middle;"> Register</h2>
      <div id="registerErr" class="error-msg" style="display:none"></div>
      <form id="registerForm" autocomplete="on">
        <div class="form-group">
          <label for="regName">Name</label>
          <input type="text" id="regName" required autocomplete="name">
        </div>
        <div class="form-group">
          <label for="regEmail">Email</label>
          <input type="email" id="regEmail" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="regEmail2">Confirm Email</label>
          <input type="email" id="regEmail2" required>
        </div>
        <div class="form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" required autocomplete="new-password">
        </div>
        <div class="form-group">
          <label for="regPassword2">Confirm Password</label>
          <input type="password" id="regPassword2" required>
        </div>
        <div class="form-group">
          <label for="regPhone">Phone Number</label>
          <input type="tel" id="regPhone" required autocomplete="tel">
        </div>
        <div class="form-group">
          <label for="regCountry">Country</label>
          <select id="regCountry" required>
            <option value="">Select Country</option>
          </select>
        </div>
        <div class="form-group">
          <label for="regRole">Role</label>
          <select id="regRole" required>
            <option value="Manager">Manager</option>
            <option value="Admin">Admin</option>
            <option value="Staff">Staff</option>
            <option value="Customer">Customer</option>
          </select>
        </div>
        <button type="submit" class="btn">Register</button>
        <button type="button" class="btn" id="gotoLogin2" style="background:#bbb;color:#222;margin-left:7px;">Back</button>
      </form>
    </div>
  </div>
  <!-- MAIN APP -->
  <div id="mainApp" style="display:none;">
    <!-- HEADER -->
    <div class="header">
      <div class="logo-bar">
        <img src="https://cdn-icons-png.flaticon.com/512/8832/8832119.png" alt="Logo">
        <h1>To-Do App</h1>
      </div>
      <div class="header-actions">
        <div class="header-timer" id="headerTimer">
          <span class="timer-dot" id="timerDot" data-status="online"></span>
          <span id="timerLabel">00:00:00</span>
        </div>
        <div class="notif-icon" id="notifIcon">
          <i class="fa-solid fa-bell"></i>
          <span class="notif-count" id="notifCount">0</span>
        </div>
        <div class="theme-toggle" id="themeToggle" data-theme="light" title="Toggle theme">
          <i class="fa-solid fa-sun"></i>
        </div>
        <div class="profile-status" id="profileStatus" data-status="online">
          <img src="" alt="Profile" id="profilePic">
          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-item submenu">
              <span><i class="fa-solid fa-circle-dot"></i> Status</span>
              <i class="fa fa-angle-right"></i>
              <div class="status-menu">
                <div class="dropdown-item" data-status="online"><span style="color:var(--success);"><i class="fa fa-play"></i></span> Login</div>
                <div class="dropdown-item" data-status="shadow"><span style="color:var(--grey);"><i class="fa fa-user-secret"></i></span> Shadow</div>
                <div class="dropdown-item" data-status="break"><span style="color:var(--warning);"><i class="fa fa-coffee"></i></span> Break</div>
                <div class="dropdown-item" data-status="offline"><span style="color:var(--danger);"><i class="fa fa-sign-out"></i></span> Logout</div>
              </div>
            </div>
            <div class="dropdown-item" id="viewProfileBtn"><i class="fa fa-user"></i> View Profile</div>
            <div class="dropdown-item" id="logoutBtn"><i class="fa fa-sign-out"></i> Logout</div>
          </div>
        </div>
      </div>
    </div>
    <!-- DASHBOARD ALERTS -->
    <div class="main">
      <div class="dashboard-alerts">
        <div class="alert-card" id="totalTasksAlert"><i class="fa fa-tasks"></i> Total Tasks: <span id="totalTasksNum">0</span></div>
        <div class="dashboard-row">
          <div class="alert-card completed" id="completedTasksAlert"><i class="fa fa-check-circle"></i> Completed: <span id="completedTasksNum">0</span></div>
          <div class="alert-card pending" id="pendingTasksAlert"><i class="fa fa-hourglass-half"></i> Pending: <span id="pendingTasksNum">0</span></div>
        </div>
      </div>
      <!-- TASK CONTROLS -->
      <div class="task-controls">
        <div class="view-switcher">
          <button class="view-btn active" id="listViewBtn"><i class="fa fa-list"></i> List</button>
          <button class="view-btn" id="graphViewBtn"><i class="fa fa-chart-pie"></i> Graph</button>
        </div>
        <div class="task-btns">
          <button class="btn" id="importBtn"><i class="fa fa-file-import"></i> Import</button>
          <button class="btn" id="exportBtn"><i class="fa fa-file-export"></i> Export</button>
          <button class="btn" id="usersBtn"><i class="fa fa-users"></i> Users</button>
          <button class="btn" id="addTaskBtn"><i class="fa fa-plus"></i> Add Task</button>
        </div>
      </div>
      <!-- TASKS SECTION -->
      <div class="tasks-section" id="tasksSection">
        <div class="tasks-header">
          <div class="tasks-title">Tasks</div>
          <div class="filters">
            <input type="search" id="searchBox" placeholder="Search...">
            <select id="categoryFilter"><option value="">Category</option></select>
            <select id="priorityFilter">
              <option value="">Priority</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select id="statusFilter">
              <option value="">Status</option>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
            </select>
            <select id="dueFilter">
              <option value="">Due</option>
              <option value="today">Today</option>
              <option value="inweek">In a Week</option>
              <option value="inmonth">In a Month</option>
              <option value="custom">Custom</option>
            </select>
            <input type="date" id="dueStart" style="display:none;width:120px;">
            <input type="date" id="dueEnd" style="display:none;width:120px;">
            <select class="sort-select" id="sortSelect">
              <option value="">Sort by...</option>
              <option value="priority">Priority</option>
              <option value="dueDate">Due Date</option>
              <option value="createdAt">Created</option>
              <option value="title">Title</option>
            </select>
            <div class="undo-redo-btns">
              <button class="btn" id="undoBtn" title="Undo"><i class="fa fa-undo"></i></button>
              <button class="btn" id="redoBtn" title="Redo"><i class="fa fa-redo"></i></button>
            </div>
          </div>
        </div>
        <div id="taskList" class="task-list"></div>
        <div id="bulkActionsBar" class="bulk-actions-bar" style="display:none;">
          <span>Selected: <span id="bulkCount">0</span></span>
          <button class="btn" id="bulkCompleteBtn"><i class="fa fa-check"></i> Mark Complete</button>
          <button class="btn" id="bulkDeleteBtn"><i class="fa fa-trash"></i> Delete</button>
          <button class="btn" id="bulkDeselectBtn"><i class="fa fa-times"></i> Deselect</button>
        </div>
      </div>
      <!-- GRAPHS SECTION -->
      <div class="graphs-section" id="graphsSection" style="display:none;">
        <div class="charts-row" id="chartsRow"></div>
      </div>
      <!-- INSIGHTS -->
      <div class="insights-section" id="insightsSection">
        <h2>Insights View</h2>
        <div id="insightsRows"></div>
      </div>
    </div>
  </div>
  <!-- NOTIFICATION TOASTS -->
  <div class="toast-container" id="toastContainer"></div>
  <!-- MODAL DYNAMIC ROOT -->
  <div id="modalRoot"></div>
  <script>
    // --- Utility Functions ---
    function $(id) { return document.getElementById(id);}
    function randAvatar(name) {
      return `https://api.dicebear.com/6.x/initials/svg?seed=${encodeURIComponent(name)}&backgroundColor=lightblue,lightgreen,lightyellow,white&radius=50`;
    }
    function formatTime(ms) {
      let sec = Math.floor(ms/1000);
      let h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
      return `${h.toString().padStart(2,0)}:${m.toString().padStart(2,0)}:${s.toString().padStart(2,0)}`;
    }
    function uuid() {return Date.now().toString(36)+Math.random().toString(36).slice(2);}
    function deepClone(obj) {return JSON.parse(JSON.stringify(obj));}
    function randomElement(arr) {return arr[Math.floor(Math.random()*arr.length)];}
    function todayDateStr() {return new Date().toISOString().split('T')[0];}

    // --- Countries ---
    const countryList = ["Egypt","Saudi Arabia","UAE","USA","UK","France","Germany","Brazil","Canada","India","Italy","Turkey","Japan","Russia","Spain","Argentina","Netherlands","Morocco","China","Mexico","Pakistan"];
    function populateCountries() {
      const sel = $("regCountry");
      for(const c of countryList) {
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      }
    }
    populateCountries();

    // --- User/Session State ---
    let users = JSON.parse(localStorage.getItem("users")||"[]");
    let session = JSON.parse(localStorage.getItem("session")||"null");
    let tasks = JSON.parse(localStorage.getItem("tasks")||"[]");
    let undoStack = JSON.parse(localStorage.getItem("undoStack")||"[]");
    let redoStack = JSON.parse(localStorage.getItem("redoStack")||"[]");
    let notifications = JSON.parse(localStorage.getItem("notifications")||"[]");
    let statusHistory = JSON.parse(localStorage.getItem("statusHistory")||"[]");
    let workTimer = JSON.parse(localStorage.getItem("workTimer")||"null");
    let theme = localStorage.getItem("theme") || "light";
    let filterCategory = "", filterPriority = "", filterStatus = "", filterDue = "", searchQuery = "";
    let filterDueStart="", filterDueEnd="";
    let sortBy = "";
    let listView = true;

    // --- Startup: Session Restore ---
    function saveAll() {
      localStorage.setItem("users",JSON.stringify(users));
      localStorage.setItem("session",JSON.stringify(session));
      localStorage.setItem("tasks",JSON.stringify(tasks));
      localStorage.setItem("undoStack",JSON.stringify(undoStack));
      localStorage.setItem("redoStack",JSON.stringify(redoStack));
      localStorage.setItem("notifications",JSON.stringify(notifications));
      localStorage.setItem("statusHistory",JSON.stringify(statusHistory));
      localStorage.setItem("workTimer",JSON.stringify(workTimer));
      localStorage.setItem("theme",theme);
    }
    function isLoggedIn() {return !!session;}
    function requireLogin() {
      if (session) {
        $("authPage").style.display="none";
        $("mainApp").style.display="block";
        document.body.setAttribute("data-theme",theme);
        initUserUI();
        renderAll();
      } else {
        $("authPage").style.display="flex";
        $("mainApp").style.display="none";
      }
    }
    // --- Auth Logic ---
    function showLogin() {
      $("loginCard").style.display = "block";
      $("registerCard").style.display = "none";
      $("loginErr").style.display = "none";
    }
    function showRegister() {
      $("registerCard").style.display = "block";
      $("loginCard").style.display = "none";
      $("registerErr").style.display = "none";
    }
    $("gotoRegister").onclick = e=>{e.preventDefault(); showRegister();}
    $("gotoLogin2").onclick = e=>{e.preventDefault(); showLogin();}
    $("loginForm").onsubmit = function(e) {
      e.preventDefault();
      const email = $("loginEmail").value.trim().toLowerCase();
      const password = $("loginPassword").value;
      let user = users.find(u=>u.email===email && u.password===password);
      if (!user) {
        $("loginErr").textContent = "Incorrect email or password.";
        $("loginErr").style.display = "block";
      } else {
        session = {id:user.id, loginTime: Date.now()};
        localStorage.setItem("session",JSON.stringify(session));
        setStatus("online");
        showNotification("Welcome, "+user.name,"success");
        requireLogin();
      }
    }
    $("registerForm").onsubmit = function(e) {
      e.preventDefault();
      let name = $("regName").value.trim();
      let email = $("regEmail").value.trim().toLowerCase();
      let email2 = $("regEmail2").value.trim().toLowerCase();
      let pass = $("regPassword").value;
      let pass2 = $("regPassword2").value;
      let phone = $("regPhone").value.trim();
      let country = $("regCountry").value;
      let role = $("regRole").value;
      if (!name||!email||!email2||!pass||!pass2||!phone||!country||!role) return;
      if (users.find(u=>u.email===email)) {
        $("registerErr").textContent = "Email already exists.";
        $("registerErr").style.display = "block"; return;
      }
      if (email!==email2) {
        $("registerErr").textContent = "Emails do not match.";
        $("registerErr").style.display = "block"; return;
      }
      if (pass!==pass2) {
        $("registerErr").textContent = "Passwords do not match.";
        $("registerErr").style.display = "block"; return;
      }
      let user = {id:uuid(), name, email, password:pass, phone, country, role, pic:randAvatar(name)};
      users.push(user); saveAll();
      $("registerErr").style.display = "none";
      showLogin();
      showNotification("Registration successful! You can login now.","success");
    }
    // --- Logout ---
    function logout() {
      setStatus("offline");
      setTimeout(()=>{
        session = null; saveAll();
        requireLogin();
      },350);
    }
    // --- Profile/Status UI ---
    function initUserUI() {
      let user = users.find(u=>u.id===session.id);
      $("profilePic").src = user.pic;
      $("profileStatus").setAttribute("data-status", getStatus());
    }
    $("profileStatus").onclick = function(e) {
      $("profileDropdown").classList.toggle("open");
      e.stopPropagation();
    }
    document.body.onclick = function(e) {
      $("profileDropdown").classList.remove("open");
    }
    $("logoutBtn").onclick = function() {logout();}
    $("viewProfileBtn").onclick = function() {
      showProfileModal();
      $("profileDropdown").classList.remove("open");
    }
    // --- Status Change ---
    function getStatus() {
      let st = (workTimer||{}).status||"online";
      return st;
    }
    function setStatus(st) {
      workTimer = workTimer||{};
      let old = workTimer.status||"offline";
      workTimer.status = st;
      workTimer.lastChange = Date.now();
      if (st==="online") {
        if (!workTimer.loginStart) workTimer.loginStart = Date.now();
        workTimer.pausedDuration = (workTimer.pausedDuration||0);
      }
      if (st==="break" || st==="shadow") {
        workTimer.pauseStart = Date.now();
      }
      saveAll();
      $("profileStatus").setAttribute("data-status",st);
      $("timerDot").setAttribute("data-status",st);
      showNotification("Status: "+st[0].toUpperCase()+st.slice(1),"info");
      statusHistory.push({ts: Date.now(), status: st});
      saveAll();
    }
    // Profile dropdown status menu
    Array.from(document.querySelectorAll(".status-menu .dropdown-item")).forEach(btn=>{
      btn.onclick = function(e) {
        let st = btn.getAttribute("data-status");
        setStatus(st);
        $("profileDropdown").classList.remove("open");
        if (st==="offline") logout();
      }
    });
    // --- Theme Toggle ---
    $("themeToggle").onclick = function() {
      theme = theme==="dark"?"light":"dark";
      document.body.setAttribute("data-theme",theme);
      $("themeToggle").setAttribute("data-theme",theme);
      $("themeToggle").innerHTML = theme==="dark"?'<i class="fa-solid fa-moon"></i>':'<i class="fa-solid fa-sun"></i>';
      saveAll();
    }
    document.body.setAttribute("data-theme",theme);
    $("themeToggle").setAttribute("data-theme",theme);
    $("themeToggle").innerHTML = theme==="dark"?'<i class="fa-solid fa-moon"></i>':'<i class="fa-solid fa-sun"></i>';

    // --- Work Timer ---
    let timerInterval = null;
    function updateHeaderTimer() {
      if (!workTimer) return;
      let st = workTimer.status||"offline";
      let label = "";
      let elapsed = 0;
      let now = Date.now();

      // Timer logic: pause time for break/shadow, resume for online, reset at UTC midnight
      let today = new Date(), gmt = new Date(Date.now()-today.getTimezoneOffset()*60000);
      let dayStart = Date.UTC(gmt.getUTCFullYear(), gmt.getUTCMonth(), gmt.getUTCDate());
      let reset = false;
      if (workTimer.lastResetDay!==dayStart) {
        workTimer.loginStart = now;
        workTimer.pausedDuration = 0;
        workTimer.pauseStart = null;
        workTimer.lastResetDay = dayStart;
        reset = true;
      }
      if (st==="online") {
        if (workTimer.pauseStart) {
          workTimer.pausedDuration += now-workTimer.pauseStart;
          workTimer.pauseStart = null;
        }
        elapsed = (now - (workTimer.loginStart||now)) - (workTimer.pausedDuration||0);
      } else if (workTimer.pauseStart) {
        elapsed = (workTimer.pauseStart - (workTimer.loginStart||now)) - (workTimer.pausedDuration||0);
      } else {
        elapsed = (now - (workTimer.loginStart||now)) - (workTimer.pausedDuration||0);
      }
      $("timerLabel").textContent = formatTime(elapsed);
      $("timerDot").setAttribute("data-status",st);
      $("profileStatus").setAttribute("data-status",st);

      // Save timer every 15s
      if (now%15000<1000) saveAll();
    }
    function startTimerLoop() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateHeaderTimer,900);
    }
    startTimerLoop();

    // --- Notification System ---
    function showNotification(msg,type="info") {
      let color = type==="danger"?"#ff3b30":type==="success"?"#34c759":type==="warning"?"#ffc600":"#246bfd";
      let toast = document.createElement("div");
      toast.className = "toast";
      toast.style.background = color;
      toast.textContent = msg;
      $("toastContainer").appendChild(toast);
      setTimeout(()=>toast.remove(),5000);
      notifications.push({id:uuid(),msg,type,ts:Date.now(),read:false});
      updateNotifIcon();
      saveAll();
    }
    function updateNotifIcon() {
      let unread = notifications.filter(n=>!n.read).length;
      $("notifCount").textContent = unread;
      $("notifCount").style.display = unread?"inline-block":"none";
    }
    $("notifIcon").onclick = function() {
      // Show list of notifications in a modal
      showModal("Notifications",
        `<div style='max-height:330px;overflow:auto;'>
          ${notifications.length?notifications.map(n=>
            `<div style='background:${n.read?"#f2f2f2":"#e7f0ff"};color:${n.type=="danger"?"#ff3b30":n.type=="success"?"#34c759":n.type=="warning"?"#ffc600":"#246bfd"};padding:0.7rem 0.8rem;border-radius:8px;margin-bottom:7px;'>
              <span>${n.msg}</span>
              <span style='float:right;font-size:0.9em;'>${new Date(n.ts).toLocaleString()}</span>
            </div>`
          ).join(""):"<div style='text-align:center;color:#888;'>No notifications</div>"}
        </div>`,
        [
          {label:"Mark all read",cb:()=>{notifications.forEach(n=>n.read=true);updateNotifIcon();saveAll();closeModal()}}
        ]
      );
      // Mark all as read after open
      notifications.forEach(n=>n.read=true); updateNotifIcon(); saveAll();
    }
    // --- Modal System ---
    function showModal(title, html, actions=[], onclose) {
      let mask = document.createElement("div");
      mask.className = "modal-mask";
      let modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `<button class='modal-close'><i class="fa fa-times"></i></button><h2>${title}</h2>${html}<div id="modalActions"></div>`;
      mask.appendChild(modal);
      document.body.appendChild(mask);
      if (actions.length) {
        let actdiv = modal.querySelector("#modalActions");
        actions.forEach((a,i)=>{
          let btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = a.label;
          btn.onclick = function(e){e.preventDefault();a.cb();};
          actdiv.appendChild(btn);
        });
      }
      modal.querySelector(".modal-close").onclick = ()=>{mask.remove();if(onclose)onclose()};
      mask.onclick = function(e){if(e.target===mask){mask.remove();if(onclose)onclose()}};
    }
    function closeModal() {
      let mask = document.querySelector(".modal-mask");
      if(mask)mask.remove();
    }

    // --- Profile Modal ---
    function showProfileModal() {
      let user = users.find(u=>u.id===session.id);
      let html = `
      <form id='profileForm'>
        <div style='text-align:center;'>
          <img src='${user.pic}' alt='pic' style='width:62px;height:62px;border-radius:50%;margin-bottom:0.7rem;'>
          <div><input type='file' id='profilePicInput' accept='image/*' style='display:none;'><button type='button' class='btn' id='editPicBtn' style='margin:0.5rem 0;'>Change Picture</button></div>
        </div>
        <div class='form-group'><label>Name</label><input id='profName' value='${user.name}' required></div>
        <div class='form-group'><label>Email</label><input id='profEmail' value='${user.email}' required></div>
        <div class='form-group'><label>Phone</label><input id='profPhone' value='${user.phone}' required></div>
        <div class='form-group'><label>Password</label><input id='profPass' value='${user.password}' required></div>
        <div class='form-group'><label>Country</label>
          <select id='profCountry' required>${countryList.map(c=>`<option value="${c}"${user.country===c?" selected":""}>${c}</option>`).join("")}</select>
        </div>
        <div class='form-group'><label>Role</label>
          <select id='profRole'>${["Manager","Admin","Staff","Customer"].map(r=>`<option${user.role==r?" selected":""}>${r}</option>`)}</select>
        </div>
        <div style='text-align:right;margin-top:1.1rem;'>
          <button class='btn' type='submit'>Save</button>
          <button class='btn' type='button' id='profCancelBtn' style='background:#bbb;color:#222;'>Cancel</button>
        </div>
      </form>
      `;
      showModal("Profile",html,[],null);
      $("profCancelBtn").onclick = closeModal;
      $("profileForm").onsubmit = function(e){
        e.preventDefault();
        user.name = $("profName").value.trim();
        user.email = $("profEmail").value.trim().toLowerCase();
        user.phone = $("profPhone").value.trim();
        user.password = $("profPass").value;
        user.country = $("profCountry").value;
        user.role = $("profRole").value;
        saveAll();
        $("profilePic").src = user.pic;
        showNotification("Profile updated!","success");
        closeModal();
      }
      document.getElementById("editPicBtn").onclick = function(){
        $("profilePicInput").click();
      }
      $("profilePicInput").onchange = function(e){
        let file = e.target.files[0];
        if(!file)return;
        let reader = new FileReader();
        reader.onload = function(ev){
          user.pic = ev.target.result;
          $("profileForm").querySelector("img").src = user.pic;
          saveAll();
        }
        reader.readAsDataURL(file);
      }
    }

    // --- Users Modal ---
    $("usersBtn").onclick = function(){
      let html = `<div class='users-list'>`+users.map(u=>`
        <div class='user-row'>
          <img src='${u.pic}' alt='pic'>
          <div class='user-info'><div>${u.name}</div><div class='user-role'>${u.role}</div></div>
          <div style='font-size:.92em;'>${u.email}<br><span style='color:#888'>${u.country}</span></div>
        </div>
      `).join("")+`</div>`;
      showModal("Users",html,[]);
    };

    // --- Task Data Model ---
    function sampleTasks() {
      if (tasks.length) return;
      let cats = ["Work","Personal","Shopping","Learning","Family","Errands","Fitness"];
      let pri = ["high","medium","low"];
      let user = session ? session.id : users[0]?.id;
      for(let i=0;i<11;i++) {
        tasks.push({
          id:uuid(),
          title:randomElement(["Finish report","Grocery shopping","Call client","Read a book","Workout","Pay bills","Buy gift","Team meeting","Doctor appointment","Project review","Clean house"]),
          description:"This is a sample task "+(i+1),
          priority:randomElement(pri),
          status:randomElement(["active","completed"]),
          dueDate:new Date(Date.now()+randomElement([2,4,7,11,-1,-3,0])*24*3600*1000).toISOString().split("T")[0],
          createdAt:new Date(Date.now()-randomElement([1,2,3,7,0])*24*3600*1000).toISOString(),
          category:randomElement(cats),
          subtasks:[{title:"Subtask 1",done:false},{title:"Subtask 2",done:true}],
          notes:"Some notes "+i,
          assignedTo:user,
          timer:0
        });
      }
      saveAll();
    }
    // --- Task CRUD ---
    function renderAll() {
      sampleTasks();
      updateHeaderTimer();
      updateNotifIcon();
      renderTasks();
      renderDashboard();
      renderFilters();
      renderGraphs();
      renderInsights();
    }
    // --- Dashboard Alerts ---
    function renderDashboard() {
      let t = tasks.filter(t=>t.assignedTo===session.id);
      let total = t.length, completed = t.filter(x=>x.status==="completed").length, pending = t.filter(x=>x.status==="active").length;
      $("totalTasksNum").textContent = total;
      $("completedTasksNum").textContent = completed;
      $("pendingTasksNum").textContent = pending;
    }
    // --- Filters/Sorting Search ---
    function renderFilters() {
      let cats = Array.from(new Set(tasks.map(t=>t.category))).filter(Boolean);
      $("categoryFilter").innerHTML = `<option value=''>Category</option>`+cats.map(c=>`<option>${c}</option>`).join("");
    }
    $("categoryFilter").onchange = function() {filterCategory=this.value;renderTasks();}
    $("priorityFilter").onchange = function() {filterPriority=this.value;renderTasks();}
    $("statusFilter").onchange = function() {filterStatus=this.value;renderTasks();}
    $("dueFilter").onchange = function() {
      filterDue = this.value;
      $("dueStart").style.display = filterDue=="custom"?"inline-block":"none";
      $("dueEnd").style.display = filterDue=="custom"?"inline-block":"none";
      renderTasks();
    }
    $("dueStart").onchange = function() {filterDueStart = this.value; renderTasks();}
    $("dueEnd").onchange = function() {filterDueEnd = this.value; renderTasks();}
    $("searchBox").oninput = function() {searchQuery=this.value.trim().toLowerCase();renderTasks();}
    $("sortSelect").onchange = function() {sortBy=this.value;renderTasks();}
    // --- Undo/Redo ---
    $("undoBtn").onclick = function() {if(undoStack.length){redoStack.push(deepClone(tasks));tasks = undoStack.pop();saveAll();renderAll();}};
    $("redoBtn").onclick = function() {if(redoStack.length){undoStack.push(deepClone(tasks));tasks = redoStack.pop();saveAll();renderAll();}};
    // --- View Switcher ---
    $("listViewBtn").onclick = function(){listView=true;renderTasks();this.classList.add("active");$("graphViewBtn").classList.remove("active");$("graphsSection").style.display="none";$("tasksSection").style.display="block";}
    $("graphViewBtn").onclick = function(){listView=false;renderTasks();this.classList.add("active");$("listViewBtn").classList.remove("active");$("graphsSection").style.display="block";$("tasksSection").style.display="none";renderGraphs();}
    // --- Task List Render ---
    let dragSrcIndex = null;
    let selectedTasks = new Set();
    function renderTasks() {
      if (!listView) { $("tasksSection").style.display="none"; return; }
      $("tasksSection").style.display="block";
      let list = $("taskList");
      let arr = tasks.filter(t=>t.assignedTo===session.id);
      if (searchQuery) arr = arr.filter(t=>(t.title+t.description+t.notes).toLowerCase().includes(searchQuery));
      if (filterCategory) arr = arr.filter(t=>t.category===filterCategory);
      if (filterPriority) arr = arr.filter(t=>t.priority===filterPriority);
      if (filterStatus) arr = arr.filter(t=>t.status===filterStatus);
      let today = todayDateStr();
      if (filterDue=="today") arr = arr.filter(t=>t.dueDate===today);
      else if (filterDue=="inweek") {
        let dt = new Date();
        let week = new Date(dt.setDate(dt.getDate()+7)).toISOString().split("T")[0];
        arr = arr.filter(t=>t.dueDate>=today && t.dueDate<=week);
      } else if (filterDue=="inmonth") {
        let dt = new Date();
        let month = new Date(dt.setDate(dt.getDate()+30)).toISOString().split("T")[0];
        arr = arr.filter(t=>t.dueDate>=today && t.dueDate<=month);
      } else if (filterDue=="custom" && filterDueStart && filterDueEnd) {
        arr = arr.filter(t=>t.dueDate>=filterDueStart && t.dueDate<=filterDueEnd);
      }
      if (sortBy) {
        arr.sort((a,b)=>{
          if (sortBy=="priority") return ["high","medium","low"].indexOf(a.priority)-["high","medium","low"].indexOf(b.priority);
          if (sortBy=="dueDate") return (a.dueDate||"").localeCompare(b.dueDate||"");
          if (sortBy=="createdAt") return (a.createdAt||"").localeCompare(b.createdAt||"");
          if (sortBy=="title") return (a.title||"").localeCompare(b.title||"");
        });
      }
      list.innerHTML = "";
      for (let i=0; i<arr.length; ++i) {
        let t = arr[i];
        let card = document.createElement("div");
        card.className = "task-card "+t.priority+(t.status=="completed"?" completed":"");
        card.setAttribute("draggable","true");
        card.setAttribute("data-index",i);
        card.innerHTML = `
          <input type="checkbox" class="task-select" ${selectedTasks.has(t.id)?"checked":""} data-id="${t.id}">
          <div class="task-content">
            <div class="task-title-row">
              <span class="task-title">${t.title}</span>
              <span class="task-priority ${t.priority}"><i class="fa fa-flag"></i> ${t.priority}</span>
              <span class="drag-handle" title="Drag to reorder"><i class="fa fa-bars"></i></span>
            </div>
            <div class="task-meta">
              <span><i class="fa fa-calendar"></i> Due: ${t.dueDate||"--"}</span>
              <span style='margin-left:10px;'><i class='fa fa-tag'></i> ${t.category||"General"}</span>
              <span style='margin-left:10px;'><i class='fa fa-user'></i> ${users.find(u=>u.id==t.assignedTo)?.name||"--"}</span>
            </div>
            <div class="task-notes">${t.notes||""}</div>
            <div class="task-subtasks">${(t.subtasks||[]).length?("<b>Subtasks:</b> "+t.subtasks.map((s,i)=>`<input type='checkbox' ${s.done?"checked":""} data-task='${t.id}' data-sub='${i}' class='subtask-cb'> ${s.title}`).join(", ")):""}</div>
            <div class="task-timer"><i class="fa fa-stopwatch"></i> ${formatTime(t.timer||0)}</div>
            <div class="task-alert ${getTaskAlertClass(t)}">${getTaskAlertText(t)}</div>
          </div>
          <div class="task-actions">
            <button class="task-action-btn" title="Share"><i class="fa fa-share"></i></button>
            <button class="task-action-btn" title="Edit"><i class="fa fa-edit"></i></button>
            <button class="task-action-btn" title="${t.status=="completed"?"Mark Incomplete":"Mark Complete"}"><i class="fa fa-check"></i></button>
            <button class="task-action-btn" title="Delete"><i class="fa fa-trash"></i></button>
          </div>
        `;
        // --- Checkbox for Multi-select ---
        card.querySelector(".task-select").onclick = function(e){
          if (this.checked) selectedTasks.add(t.id); else selectedTasks.delete(t.id);
          updateBulkBar();
        }
        // --- Drag & Drop ---
        card.querySelector(".drag-handle").onmousedown = e=>{dragSrcIndex=i};
        card.ondragstart = e=>{dragSrcIndex=i};
        card.ondragover = e=>e.preventDefault();
        card.ondrop = e=>{
          let tgt = Number(card.getAttribute("data-index"));
          if (dragSrcIndex!==null && dragSrcIndex!==tgt) {
            let arr2 = arr.slice();
            let moved = arr2.splice(dragSrcIndex,1)[0];
            arr2.splice(tgt,0,moved);
            // update tasks order
            let indices = arr2.map(a=>a.id);
            tasks = tasks.filter(t=>t.assignedTo!==session.id).concat(arr2);
            undoStack.push(deepClone(tasks)); saveAll(); renderTasks();
          }
          dragSrcIndex=null;
        }
        // --- Subtask toggle ---
        card.querySelectorAll(".subtask-cb").forEach(cb=>{
          cb.onchange = function(){
            let sub = t.subtasks[Number(cb.getAttribute("data-sub"))];
            sub.done = cb.checked;
            undoStack.push(deepClone(tasks)); saveAll(); renderTasks();
          }
        });
        // --- Task Actions ---
        let btns = card.querySelectorAll(".task-action-btn");
        // Share
        btns[0].onclick = function() {
          let txt = `Task: ${t.title}\n${t.description}\nDue: ${t.dueDate}\nNotes: ${t.notes}`;
          navigator.clipboard.writeText(txt);
          showNotification("Task copied to clipboard!","success");
        }
        // Edit
        btns[1].onclick = function() {
          showTaskModal("Edit Task",t,task=>{
            Object.assign(t,task);
            undoStack.push(deepClone(tasks)); saveAll(); renderAll();
          });
        }
        // Complete/Incomplete
        btns[2].onclick = function() {
          t.status = t.status=="completed"?"active":"completed";
          undoStack.push(deepClone(tasks)); saveAll(); renderAll();
        }
        // Delete
        btns[3].onclick = function() {
          if (confirm("Delete this task?")) {
            tasks = tasks.filter(x=>x.id!==t.id);
            undoStack.push(deepClone(tasks)); saveAll(); renderAll();
          }
        }
        // --- Per-task Timer, Alert for expire/48h ---
        let due = new Date(t.dueDate), now = new Date();
        if (t.status=="active" && (due-now)<48*3600*1000 && (due-now)>0) {
          showNotification("Task '"+t.title+"' expiring in <48h!","warning");
        }
        if (t.status=="active" && (due-now)<0) {
          showNotification("Task '"+t.title+"' EXPIRED!","danger");
        }
        // --- Timer tick ---
        let timerBox = card.querySelector(".task-timer");
        timerBox.onclick = function(){
          t.timer = (t.timer||0) + 60000;
          saveAll(); renderTasks();
        }
        list.appendChild(card);
      }
      updateBulkBar();
    }
    function getTaskAlertClass(t) {
      let due = new Date(t.dueDate), now = new Date();
      if (t.status=="completed") return "success";
      if ((due-now)<0) return "danger";
      if ((due-now)<48*3600*1000) return "warning";
      return "";
    }
    function getTaskAlertText(t) {
      let due = new Date(t.dueDate), now = new Date();
      if (t.status=="completed") return "<i class='fa fa-check'></i> Completed";
      if ((due-now)<0) return "<i class='fa fa-exclamation-circle'></i> Expired";
      if ((due-now)<48*3600*1000) return "<i class='fa fa-clock'></i> Less than 48h left";
      return "<i class='fa fa-check-circle'></i> On time";
    }
    // --- Bulk Actions ---
    function updateBulkBar() {
      let n = selectedTasks.size;
      $("bulkActionsBar").style.display = n?"flex":"none";
      $("bulkCount").textContent = n;
    }
    $("bulkCompleteBtn").onclick = function(){
      tasks.forEach(t=>{if(selectedTasks.has(t.id))t.status="completed";});
      undoStack.push(deepClone(tasks)); selectedTasks.clear(); saveAll(); renderAll();
    };
    $("bulkDeleteBtn").onclick = function(){
      if (!selectedTasks.size) return;
      if (confirm("Delete selected tasks?")) {
        tasks = tasks.filter(t=>!selectedTasks.has(t.id));
        undoStack.push(deepClone(tasks)); selectedTasks.clear(); saveAll(); renderAll();
      }
    };
    $("bulkDeselectBtn").onclick = function(){selectedTasks.clear();renderTasks();}
    // --- Add Task Modal ---
    $("addTaskBtn").onclick = function() {
      showTaskModal("Add Task",null,task=>{
        task.id = uuid();
        task.assignedTo = session.id;
        task.status = "active";
        task.createdAt = new Date().toISOString();
        tasks.push(task);
        undoStack.push(deepClone(tasks)); saveAll(); renderAll();
      });
    };
    function showTaskModal(title, task, onSave) {
      let usersOpt = users.map(u=>`<option value="${u.id}">${u.name}</option>`).join("");
      let cats = Array.from(new Set(tasks.map(t=>t.category))).filter(Boolean);
      let html = `
      <form id='taskForm'>
        <div class='form-group'><label>Title</label><input id='taskTitle' value="${task?task.title:""}" required></div>
        <div class='form-group'><label>Description</label><textarea id='taskDesc' required>${task?task.description:""}</textarea></div>
        <div class='form-group'><label>Priority</label>
          <select id='taskPriority' required>
            <option value="high" ${task&&task.priority=="high"?"selected":""}>High</option>
            <option value="medium" ${task&&task.priority=="medium"?"selected":""}>Medium</option>
            <option value="low" ${task&&task.priority=="low"?"selected":""}>Low</option>
          </select>
        </div>
        <div class='form-group'><label>Due Date</label><input type='date' id='taskDue' value="${task?task.dueDate:todayDateStr()}" required></div>
        <div class='form-group'><label>Category</label>
          <input id='taskCat' value="${task?task.category:(cats[0]||'General')}">
        </div>
        <div class='form-group'><label>Assign To</label>
          <select id='taskUser'>${usersOpt}</select>
        </div>
        <div class='form-group'><label>Notes</label>
          <textarea id='taskNotes'>${task?task.notes:""}</textarea>
        </div>
        <div class='form-group'><label>Subtasks</label>
          <div id='subtasksBox'>${task?(task.subtasks||[]).map((s,i)=>`<input value="${s.title}" ${s.done?"checked":""} type="checkbox" class="subtask-input" data-index="${i}">`).join(""):""}</div>
          <button type='button' class='btn' id='addSubBtn'>Add Subtask</button>
        </div>
        <div style='text-align:right;margin-top:1.2rem;'>
          <button class='btn' type='submit'>Save</button>
          <button class='btn' type='button' id='taskCancelBtn' style='background:#bbb;color:#222;'>Cancel</button>
        </div>
      </form>
      `;
      showModal(title,html,[],null);
      $("taskCancelBtn").onclick = closeModal;
      $("addSubBtn").onclick = function(){
        let box = $("subtasksBox");
        let idx = box.children.length;
        let inp = document.createElement("input");
        inp.type="checkbox";
        inp.className="subtask-input";
        inp.setAttribute("data-index",idx);
        inp.value = "";
        box.appendChild(inp);
      }
      $("taskForm").onsubmit = function(e){
        e.preventDefault();
        let subtasks=[];
        Array.from(document.querySelectorAll(".subtask-input")).forEach(inp=>{
          subtasks.push({title:inp.value,done:inp.checked});
        });
        let obj = {
          title:$("taskTitle").value,
          description:$("taskDesc").value,
          priority:$("taskPriority").value,
          dueDate:$("taskDue").value,
          category:$("taskCat").value,
          assignedTo:$("taskUser").value,
          notes:$("taskNotes").value,
          subtasks,
          timer:task?task.timer:0
        };
        onSave(obj);
        closeModal();
      }
    }
    // --- Import/Export ---
    $("importBtn").onclick = function(){
      let inp=document.createElement("input");inp.type="file";
      inp.accept=".json,application/json";
      inp.onchange = function(e) {
        let file = e.target.files[0];
        if (!file) return;
        let reader=new FileReader();
        reader.onload=function(ev){
          try {
            let arr=JSON.parse(ev.target.result);
            if (!Array.isArray(arr)) throw "Invalid format";
            tasks=tasks.concat(arr);
            undoStack.push(deepClone(tasks)); saveAll(); renderAll();
            showNotification("Import successful!","success");
          } catch(err) {showNotification("Import failed!","danger");}
        }
        reader.readAsText(file);
      }
      inp.click();
    }
    $("exportBtn").onclick = function(){
      let data = JSON.stringify(tasks,null,2);
      let blob = new Blob([data],{type:"application/json"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "tasks.json";
      a.click();
      showNotification("Exported as JSON!","success");
    }
    // --- Graphs/Charts ---
    function renderGraphs() {
      let t = tasks.filter(t=>t.assignedTo===session.id);
      let completed = t.filter(x=>x.status==="completed").length;
      let pending = t.filter(x=>x.status==="active").length;
      let high = t.filter(x=>x.priority=="high").length;
      let med = t.filter(x=>x.priority=="medium").length;
      let low = t.filter(x=>x.priority=="low").length;
      $("chartsRow").innerHTML = `
        <div class='chart-box'><div class='chart-title'>Task Completion</div>
          <div style='height:90px;display:flex;align-items:end'>
            <div style='width:70px;height:${completed*15}px;background:var(--success);margin-right:10px;border-radius:6px;'></div>
            <div style='width:70px;height:${pending*15}px;background:var(--warning);border-radius:6px;'></div>
          </div>
          <div style='font-size:.97em;margin-top:7px;'>Completed: ${completed} <span style='color:var(--success);font-weight:700'>|</span> Pending: ${pending}</div>
        </div>
        <div class='chart-box'><div class='chart-title'>Priority Distribution</div>
          <div style='height:90px;display:flex;align-items:end'>
            <div style='width:38px;height:${high*13}px;background:var(--danger);margin-right:6px;border-radius:6px;'></div>
            <div style='width:38px;height:${med*13}px;background:var(--warning);margin-right:6px;border-radius:6px;'></div>
            <div style='width:38px;height:${low*13}px;background:var(--grey);border-radius:6px;'></div>
          </div>
          <div style='font-size:.97em;margin-top:7px;'>High: ${high} | Med: ${med} | Low: ${low}</div>
        </div>
      `;
    }
    // --- Insights Section ---
    function renderInsights() {
      let t = tasks.filter(t=>t.assignedTo===session.id);
      let overdue = t.filter(x=>x.status=="active" && new Date(x.dueDate)<new Date()).length;
      let avgTimer = Math.round(t.reduce((a,b)=>a+(b.timer||0),0)/(t.length||1)/60000);
      let maxTask = t.sort((a,b)=>(b.timer||0)-(a.timer||0))[0];
      $("insightsRows").innerHTML = `
        <div class='insight-row'><span class='insight-label'>Total Tasks:</span> ${t.length}</div>
        <div class='insight-row'><span class='insight-label'>Overdue Tasks:</span> ${overdue}</div>
        <div class='insight-row'><span class='insight-label'>Average Time/Task:</span> ${avgTimer} min</div>
        <div class='insight-row'><span class='insight-label'>Longest Task:</span> ${maxTask?maxTask.title:"--"}</div>
      `;
    }
    // --- State Persistence on Refresh ---
    window.onbeforeunload = function(){saveAll();}
    // --- INIT ---
    requireLogin();
  </script>
</body>
</html>
