<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern To-Do App</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #5D5CDE;
            --primary-light: #8584e6;
            --primary-dark: #4241ac;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --info-color: #17A2B8;
            --dark-blue: #00008B;
            --orange-color: #FD7E14;
            --gray-color: #6C757D;
            --light-gray: #e9ecef;
            --dark-gray: #343a40;
            --background-color: #FFFFFF;
            --text-color: #212529;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
            --header-height: 70px;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .dark {
            --primary-color: #7776f0;
            --primary-light: #a5a4ff;
            --primary-dark: #5453cc;
            --background-color: #181818;
            --text-color: #ffffff;
            --card-bg: #252525;
            --border-color: #3a3a3a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --light-gray: #3a3a3a;
            --dark-gray: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        /* Login/Register Page Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-dark) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(rgba(255, 255, 255, 0.1) 8%, transparent 8%);
            background-position: 0 0;
            background-size: 50px 50px;
            opacity: 0.2;
            animation: moveBackground 20s linear infinite;
        }
        
        @keyframes moveBackground {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .auth-form {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 450px;
            box-shadow: var(--box-shadow);
            position: relative;
            z-index: 1;
            animation: fadeIn 0.8s ease;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 32px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(93, 92, 222, 0.4);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--gray-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .auth-links {
            text-align: center;
            margin-top: 30px;
        }
        
        .auth-links a {
            color: var(--dark-blue);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .auth-links a:hover {
            text-decoration: underline;
        }
        
        .login-button {
            position: relative;
            width: 100%;
            overflow: hidden;
            background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .login-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.5) 0%, transparent 60%);
            animation: rotateLight 4s linear infinite;
            pointer-events: none;
        }
        
        @keyframes rotateLight {
            0% { transform: translate(-100%, -100%) rotate(0deg); }
            100% { transform: translate(-100%, -100%) rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-50px);
            transition: all 0.3s;
            padding: 30px;
            position: relative;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-color);
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background-color: var(--card-bg);
            height: var(--header-height);
            box-shadow: 0 2px 5px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin-left: 10px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            background-color: var(--success-color);
            color: white;
        }
        
        .timer-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            background-color: var(--card-bg);
            box-shadow: var(--box-shadow);
            margin-right: 15px;
        }
        
        .timer-display {
            font-family: 'Poppins', monospace;
            font-size: 18px;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .timer-controls {
            display: flex;
            gap: 5px;
        }
        
        .timer-btn {
            background: none;
            border: none;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--primary-color);
            transition: all 0.2s;
        }
        
        .timer-btn:hover {
            color: var(--primary-dark);
            transform: scale(1.2);
        }
        
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .theme-toggle i {
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            transition: all 0.3s;
        }
        
        .profile-img:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(93, 92, 222, 0.5);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .profile-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            width: 250px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px 0;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .profile-dropdown.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .profile-dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .profile-dropdown-item:hover {
            background-color: var(--light-gray);
        }
        
        .profile-dropdown-item i {
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .notification-dropdown {
            position: absolute;
            top: 55px;
            right: 0;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .notification-dropdown.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .notification-item {
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: var(--light-gray);
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .notification-item.read {
            opacity: 0.6;
        }
        
        .notification-item:hover {
            background-color: var(--primary-light);
            color: white;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* Main Content Styles */
        main {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .section {
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-weight: 700;
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .section-controls {
            display: flex;
            gap: 10px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all 0.3s;
            height: 100%;
        }
        
        .card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }

        .card-black-border {
            border: 2px solid var(--dark-gray);
        }
        
        .summary-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .summary-card {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: all 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .summary-card.total {
            background: linear-gradient(45deg, var(--primary-dark), var(--primary-color));
            color: white;
        }
        
        .summary-card.completed {
            background: linear-gradient(45deg, #218838, var(--success-color));
            color: white;
        }
        
        .summary-card.pending {
            background: linear-gradient(45deg, #e0a800, var(--warning-color));
            color: #212529;
        }
        
        .summary-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .summary-label {
            font-size: 18px;
            font-weight: 500;
        }
        
        /* Tasks List Styles */
        .tasks-container {
            margin-top: 30px;
        }
        
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: var(--light-gray);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .view-btn:hover:not(.active) {
            background-color: var(--border-color);
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filter-select, .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .search-input {
            padding-left: 35px;
        }
        
        .sort-container {
            flex: 1;
            min-width: 200px;
        }
        
        .tasks-view {
            margin-top: 20px;
        }
        
        .list-view, .graph-view {
            display: none;
        }
        
        .list-view.active, .graph-view.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .task-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
            cursor: grab;
            border-left: 4px solid transparent;
        }
        
        .task-item:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }
        
        .task-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .task-item.expired {
            border-left-color: var(--danger-color);
        }
        
        .task-item.due-soon {
            border-left-color: var(--warning-color);
        }
        
        .task-item.due-later {
            border-left-color: var(--success-color);
        }
        
        .task-item.completed {
            background-color: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success-color);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .task-selection {
            margin-right: 15px;
            transform: scale(1.3);
            cursor: pointer;
        }
        
        .task-title-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 18px;
            margin-right: 10px;
            transition: all 0.3s;
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .task-priority {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-high {
            background-color: var(--danger-color);
            color: white;
        }
        
        .priority-medium {
            background-color: var(--orange-color);
            color: white;
        }
        
        .priority-low {
            background-color: var(--gray-color);
            color: white;
        }
        
        .task-category {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
        }
        
        .task-body {
            margin-bottom: 15px;
        }
        
        .task-description {
            margin-bottom: 10px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .task-dates {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--gray-color);
            margin-bottom: 10px;
        }
        
        .subtasks-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 5px;
            background-color: var(--light-gray);
            transition: all 0.3s;
        }
        
        .subtask-item.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .subtask-checkbox {
            cursor: pointer;
            transform: scale(1.2);
        }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .task-controls {
            display: flex;
            gap: 10px;
        }
        
        .task-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background-color: var(--light-gray);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .task-btn:hover {
            transform: translateY(-2px);
        }
        
        .task-btn i {
            font-size: 16px;
        }
        
        .task-btn.view-btn {
            background-color: var(--primary-light);
            color: white;
        }
        
        .task-btn.edit-btn {
            background-color: var(--info-color);
            color: white;
        }
        
        .task-btn.delete-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .task-btn.complete-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .task-btn.share-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .task-btn.play-btn {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .task-btn.play-btn.active {
            background-color: var(--danger-color);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .timer-info {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .task-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .task-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .task-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-color);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Batch action bar */
        .batch-actions {
            position: fixed;
            bottom: -80px;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 90;
        }
        
        .batch-actions.active {
            bottom: 0;
            animation: slideUp 0.3s forwards;
        }
        
        @keyframes slideUp {
            from { bottom: -80px; }
            to { bottom: 0; }
        }
        
        .batch-info {
            font-weight: 500;
        }
        
        .batch-controls {
            display: flex;
            gap: 10px;
        }
        
        .batch-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .batch-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .batch-btn.delete {
            background-color: var(--danger-color);
            color: white;
        }
        
        .batch-btn.complete {
            background-color: var(--success-color);
            color: white;
        }
        
        .batch-btn.cancel {
            background-color: var(--gray-color);
            color: white;
        }
        
        /* Graph View Styles */
        .graph-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .graph-card {
            flex: 1;
            min-width: 300px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all 0.3s;
            height: 100%;
        }
        
        .graph-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }
        
        .graph-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        
        .pieChart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            height: 300px;
            margin: 0 auto;
        }
        
        /* Insights Section */
        .insights-section {
            margin-top: 40px;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .insight-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all 0.3s;
        }
        
        .insight-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }
        
        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .insight-title {
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-title i {
            font-size: 20px;
        }
        
        .insight-value {
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: var(--primary-color);
        }
        
        .insight-footer {
            font-size: 14px;
            color: var(--gray-color);
            text-align: center;
        }
        
        /* Users View */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .user-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .user-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px) scale(1.02);
        }
        
        .user-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 3px solid var(--primary-color);
        }
        
        .user-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        
        .user-email {
            font-size: 14px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .user-role {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: var(--primary-light);
            color: white;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s forwards, fadeOut 0.3s 4.7s forwards;
            transition: all 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
        
        .toast.info {
            border-left: 4px solid var(--info-color);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-icon.success {
            color: var(--success-color);
        }
        
        .toast-icon.warning {
            color: var(--warning-color);
        }
        
        .toast-icon.error {
            color: var(--danger-color);
        }
        
        .toast-icon.info {
            color: var(--info-color);
        }
        
        .toast-text {
            font-weight: 500;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--gray-color);
            transition: all 0.2s;
        }
        
        .toast-close:hover {
            color: var(--danger-color);
            transform: scale(1.2);
        }
        
        /* Undo/Redo Controls */
        .history-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 99;
        }
        
        .history-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--box-shadow);
        }
        
        .history-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(93, 92, 222, 0.4);
        }
        
        .history-btn:disabled {
            background-color: var(--gray-color);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }
        
        .history-btn i {
            font-size: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .summary-container {
                flex-direction: column;
            }
            
            .task-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-title-container {
                margin-bottom: 10px;
            }
            
            .task-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            
            .graph-container {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .header-controls {
                gap: 10px;
            }
            
            .logo h1 {
                display: none;
            }
            
            .timer-container {
                margin-right: 5px;
            }
            
            .task-btn {
                padding: 6px;
            }
            
            .task-btn i {
                font-size: 14px;
            }
            
            .batch-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .batch-info {
                text-align: center;
            }
        }
        
        @media (max-width: 576px) {
            .filters-container {
                flex-direction: column;
            }
            
            .search-container, .filter-group, .sort-container {
                width: 100%;
            }
            
            .history-controls {
                bottom: 80px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* Utility Classes */
        .text-danger { color: var(--danger-color); }
        .text-success { color: var(--success-color); }
        .text-warning { color: var(--warning-color); }
        .text-primary { color: var(--primary-color); }
        
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mt-4 { margin-top: 20px; }
        
        .hidden { display: none; }
        
        .btn-icon {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .opacity-50 { opacity: 0.5; }
    </style>
</head>
<body>
    <!-- Login/Register Page -->
    <div class="auth-container" id="authContainer">
        <div class="auth-form" id="loginForm">
            <h2>Welcome Back!</h2>
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" class="form-control" value="test@example.com" aria-label="Email">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-control" value="123456" aria-label="Password">
            </div>
            <div class="login-button">
                <button type="button" id="loginBtn" class="btn btn-primary btn-block">Login</button>
            </div>
            <div class="auth-links">
                <p>Don't have an account? <a href="#" id="showRegisterBtn">Register now</a></p>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create an Account</h3>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" class="form-control" required aria-label="Last Name">
                    </div>
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" class="form-control" required aria-label="First Name">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" required aria-label="Email">
                    </div>
                    <div class="form-group">
                        <label for="confirmEmail">Confirm Email</label>
                        <input type="email" id="confirmEmail" class="form-control" required aria-label="Confirm Email">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" required aria-label="Password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-control" required aria-label="Confirm Password">
                    </div>
                    <div class="form-group">
                        <label for="birthdate">Birthdate</label>
                        <input type="text" id="birthdate" class="form-control" required aria-label="Birthdate">
                    </div>
                    <div class="form-group">
                        <label for="nationality">Nationality</label>
                        <select id="nationality" class="form-control" required aria-label="Nationality">
                            <option value="">Select a country</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" class="form-control" required aria-label="Role">
                            <option value="">Select a role</option>
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="createAccountBtn" class="btn btn-success">Create</button>
                <button type="button" id="cancelRegisterBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Page -->
    <div class="dashboard" id="dashboard">
        <header>
            <div class="logo" id="logoHome">
                <i class="fas fa-tasks fa-lg" style="color: var(--primary-color);"></i>
                <h1>To-Do App</h1>
            </div>
            <div class="header-controls">
                <div class="status-indicator" id="statusIndicator">
                    <i class="fas fa-circle" style="font-size: 10px; margin-right: 5px;"></i>
                    <span>Online</span>
                </div>
                <div class="timer-container">
                    <div class="timer-display" id="globalTimer">00:00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" id="playPauseTimerBtn" aria-label="Play/Pause Timer">
                            <i class="fas fa-play" id="playPauseIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="theme-toggle" id="themeToggle" aria-label="Toggle Light/Dark Mode">
                    <i class="fas fa-sun" id="themeIcon"></i>
                </div>
                <div class="user-profile">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User Profile" class="profile-img" id="profileImg">
                    <div class="notification-badge" id="notificationBadge">0</div>
                    
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-dropdown-item" id="viewProfileBtn">
                            <i class="fas fa-user"></i>
                            <span>View Profile</span>
                        </div>
                        <div class="profile-dropdown-item" id="switchModeBtn">
                            <i class="fas fa-moon"></i>
                            <span>Switch Mode</span>
                        </div>
                        <div class="profile-dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                    
                    <!-- Notifications Dropdown -->
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Notifications</h4>
                            <button id="markAllReadBtn" class="btn-primary btn" style="padding: 5px 10px; font-size: 12px;">Mark All Read</button>
                        </div>
                        <div id="notificationsList">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <main>
            <!-- Tasks Summary Section -->
            <section class="section">
                <div class="summary-container">
                    <div class="summary-card total card-black-border">
                        <div class="summary-value" id="totalTasksCount">0</div>
                        <div class="summary-label">Total Tasks</div>
                    </div>
                    <div class="summary-card completed">
                        <div class="summary-value" id="completedTasksCount">0</div>
                        <div class="summary-label">Completed Tasks</div>
                    </div>
                    <div class="summary-card pending">
                        <div class="summary-value" id="pendingTasksCount">0</div>
                        <div class="summary-label">Pending Tasks</div>
                    </div>
                </div>
            </section>
            
            <!-- Tasks List Section -->
            <section class="section">
                <div class="section-header">
                    <h2 class="section-title">Tasks</h2>
                    <div class="section-controls">
                        <button class="btn btn-success btn-icon" id="addTaskBtn">
                            <i class="fas fa-plus"></i>
                            <span>Add Task</span>
                        </button>
                        <button class="btn btn-primary btn-icon" id="exportBtn">
                            <i class="fas fa-file-export"></i>
                            <span>Export</span>
                        </button>
                        <button class="btn btn-info btn-icon" id="importBtn">
                            <i class="fas fa-file-import"></i>
                            <span>Import</span>
                        </button>
                        <button class="btn btn-primary btn-icon" id="manageCategories">
                            <i class="fas fa-tags"></i>
                            <span>Categories</span>
                        </button>
                        <button class="btn btn-secondary btn-icon" id="usersBtn">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                        </button>
                    </div>
                </div>
                
                <div class="tasks-container">
                    <div class="filters-container">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input" placeholder="Search tasks..." aria-label="Search tasks">
                        </div>
                        <div class="filter-group">
                            <label for="statusFilter">Status</label>
                            <select id="statusFilter" class="filter-select" aria-label="Filter by status">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="categoryFilter">Category</label>
                            <select id="categoryFilter" class="filter-select" aria-label="Filter by category">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priorityFilter">Priority</label>
                            <select id="priorityFilter" class="filter-select" aria-label="Filter by priority">
                                <option value="all">All Priorities</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="dueDateFilter">Due Date</label>
                            <select id="dueDateFilter" class="filter-select" aria-label="Filter by due date">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="sort-container">
                            <label for="sortSelect">Sort By</label>
                            <select id="sortSelect" class="filter-select" aria-label="Sort tasks">
                                <option value="dueDate-asc">Due Date (Earliest)</option>
                                <option value="dueDate-desc">Due Date (Latest)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="priority-desc">Priority (High-Low)</option>
                                <option value="priority-asc">Priority (Low-High)</option>
                                <option value="created-desc">Date Created (Newest)</option>
                                <option value="created-asc">Date Created (Oldest)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tasks-header">
                        <h3>Task List</h3>
                        <div class="view-controls">
                            <button class="view-btn active" id="listViewBtn" aria-label="List View">
                                <i class="fas fa-list"></i>
                                <span>List</span>
                            </button>
                            <button class="view-btn" id="graphViewBtn" aria-label="Graph View">
                                <i class="fas fa-chart-bar"></i>
                                <span>Graph</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="tasks-view">
                        <div class="list-view active" id="listView">
                            <!-- Tasks list will be populated here -->
                            <div id="tasksContainer"></div>
                        </div>
                        <div class="graph-view" id="graphView">
                            <div class="graph-container">
                                <div class="graph-card">
                                    <h3 class="graph-title">Tasks Completion Over Time</h3>
                                    <div class="chart-container">
                                        <canvas id="tasksChart"></canvas>
                                    </div>
                                </div>
                                <div class="graph-card">
                                    <h3 class="graph-title">Task Distribution</h3>
                                    <div class="pieChart-container">
                                        <canvas id="taskDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Insights Section -->
            <section class="section insights-section">
                <div class="section-header">
                    <h2 class="section-title">Insights</h2>
                </div>
                <div class="insights-grid">
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-title">
                                <i class="fas fa-fire"></i>
                                <span>Productivity Score</span>
                            </div>
                        </div>
                        <div class="insight-value" id="productivityScore">0%</div>
                        <div class="insight-footer">
                            Based on task completion rate
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-title">
                                <i class="fas fa-hourglass-half"></i>
                                <span>Expired Tasks</span>
                            </div>
                        </div>
                        <div class="insight-value" id="expiredTasksCount">0</div>
                        <div class="insight-footer">
                            Tasks past their due date
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-title">
                                <i class="fas fa-clock"></i>
                                <span>Due Soon</span>
                            </div>
                        </div>
                        <div class="insight-value" id="dueSoonTasksCount">0</div>
                        <div class="insight-footer">
                            Tasks due within 48 hours
                        </div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-title">
                                <i class="fas fa-stopwatch"></i>
                                <span>Total Time Tracked</span>
                            </div>
                        </div>
                        <div class="insight-value" id="totalTimeTracked">00:00:00</div>
                        <div class="insight-footer">
                            Across all tasks
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Batch Action Bar -->
        <div class="batch-actions" id="batchActions">
            <div class="batch-info" id="selectedItemsCount">0 tasks selected</div>
            <div class="batch-controls">
                <button class="batch-btn complete" id="batchCompleteBtn">
                    <i class="fas fa-check"></i> Mark as Completed
                </button>
                <button class="batch-btn delete" id="batchDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="batch-btn cancel" id="batchCancelBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
        
        <!-- Undo/Redo Controls -->
        <div class="history-controls">
            <button class="history-btn" id="undoBtn" aria-label="Undo" disabled>
                <i class="fas fa-undo"></i>
            </button>
            <button class="history-btn" id="redoBtn" aria-label="Redo" disabled>
                <i class="fas fa-redo"></i>
            </button>
        </div>
        
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer">
            <!-- Toasts will be populated here -->
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Task</h3>
                <button class="modal-close" id="closeAddTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" class="form-control" required aria-label="Task Title">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3" aria-label="Task Description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sub-Tasks</label>
                        <div id="subTasksContainer">
                            <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="form-control subtask-input" placeholder="Enter sub-task" aria-label="Sub-task">
                                <button type="button" class="btn btn-danger remove-subtask" style="padding: 5px 10px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="addSubTaskBtn" class="btn btn-primary" style="padding: 5px 10px; margin-top: 10px;">
                            <i class="fas fa-plus"></i> Add Sub-Task
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" class="form-control" required aria-label="Due Date">
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="form-control" required aria-label="Priority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" class="form-control" required aria-label="Category">
                            <!-- Categories will be populated here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskNotes">Notes (Optional)</label>
                        <textarea id="taskNotes" class="form-control" rows="2" aria-label="Notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="createTaskBtn" class="btn btn-success">Create</button>
                <button type="button" id="cancelAddTaskBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- View Task Modal -->
    <div class="modal-overlay" id="viewTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="viewTaskTitle">Task Title</h3>
                <button class="modal-close" id="closeViewTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="viewTaskDescription" class="mt-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Due Date:</strong>
                    <p id="viewTaskDueDate" class="mt-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Priority:</strong>
                    <span id="viewTaskPriority" class="mt-2 task-priority"></span>
                </div>
                <div class="mb-3">
                    <strong>Category:</strong>
                    <span id="viewTaskCategory" class="mt-2 task-category"></span>
                </div>
                <div class="mb-3">
                    <strong>Time Spent:</strong>
                    <p id="viewTaskTimeSpent" class="mt-2"></p>
                </div>
                <div class="mb-3">
                    <strong>Notes:</strong>
                    <p id="viewTaskNotes" class="mt-2"></p>
                </div>
                <div class="mb-3" id="viewTaskSubtasksContainer">
                    <strong>Sub-Tasks:</strong>
                    <div id="viewTaskSubtasks" class="mt-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closeViewTaskBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="editTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Task</h3>
                <button class="modal-close" id="closeEditTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="form-group">
                        <label for="editTaskTitle">Title</label>
                        <input type="text" id="editTaskTitle" class="form-control" required aria-label="Task Title">
                    </div>
                    <div class="form-group">
                        <label for="editTaskDescription">Description</label>
                        <textarea id="editTaskDescription" class="form-control" rows="3" aria-label="Task Description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sub-Tasks</label>
                        <div id="editSubTasksContainer">
                            <!-- Sub-tasks will be populated here -->
                        </div>
                        <button type="button" id="editAddSubTaskBtn" class="btn btn-primary" style="padding: 5px 10px; margin-top: 10px;">
                            <i class="fas fa-plus"></i> Add Sub-Task
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="editTaskDueDate">Due Date</label>
                        <input type="text" id="editTaskDueDate" class="form-control" required aria-label="Due Date">
                    </div>
                    <div class="form-group">
                        <label for="editTaskPriority">Priority</label>
                        <select id="editTaskPriority" class="form-control" required aria-label="Priority">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskCategory">Category</label>
                        <select id="editTaskCategory" class="form-control" required aria-label="Category">
                            <!-- Categories will be populated here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskNotes">Notes (Optional)</label>
                        <textarea id="editTaskNotes" class="form-control" rows="2" aria-label="Notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="updateTaskBtn" class="btn btn-success">Update</button>
                <button type="button" id="cancelEditTaskBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div class="modal-overlay" id="categoriesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Categories</h3>
                <button class="modal-close" id="closeCategoriesModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName">New Category</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategoryName" class="form-control" placeholder="Enter category name" aria-label="New Category Name">
                        <button type="button" id="addCategoryBtn" class="btn btn-success" style="padding: 8px 15px;">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                <div class="mt-4">
                    <h4>Current Categories</h4>
                    <div id="categoriesList" class="mt-2" style="max-height: 300px; overflow-y: auto;">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="saveCategoriesBtn" class="btn btn-primary">Save</button>
                <button type="button" id="cancelCategoriesBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export Tasks</h3>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportFormat">Select Format</label>
                    <select id="exportFormat" class="form-control" aria-label="Export Format">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmExportBtn" class="btn btn-primary">Export</button>
                <button type="button" id="cancelExportBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Tasks</h3>
                <button class="modal-close" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importFile">Upload JSON File</label>
                    <input type="file" id="importFile" class="form-control" accept=".json" aria-label="Import File">
                </div>
                <div class="form-group">
                    <label for="importUrl">Or Import from URL</label>
                    <input type="url" id="importUrl" class="form-control" placeholder="https://example.com/tasks.json" aria-label="Import URL">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmImportBtn" class="btn btn-primary">Import</button>
                <button type="button" id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>User Profile</h3>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" id="profileModalImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--primary-color);">
                    <label for="profilePictureUpload" class="btn btn-primary" style="padding: 5px 10px; cursor: pointer;">
                        <i class="fas fa-camera"></i> Change Picture
                    </label>
                    <input type="file" id="profilePictureUpload" accept="image/*" style="display: none;">
                </div>
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileName">Full Name</label>
                        <input type="text" id="profileName" class="form-control" readonly aria-label="Full Name">
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail" class="form-control" readonly aria-label="Email">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Phone</label>
                        <input type="tel" id="profilePhone" class="form-control" readonly aria-label="Phone">
                    </div>
                    <div class="form-group">
                        <label for="profileCountry">Country</label>
                        <input type="text" id="profileCountry" class="form-control" readonly aria-label="Country">
                    </div>
                    <div class="form-group">
                        <label for="profileRole">Role</label>
                        <input type="text" id="profileRole" class="form-control" readonly aria-label="Role">
                    </div>
                    <div class="form-group">
                        <label for="profileJoinDate">Joining Date</label>
                        <input type="text" id="profileJoinDate" class="form-control" readonly aria-label="Joining Date">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="editProfileBtn" class="btn btn-primary">Edit Profile</button>
                <button type="button" id="saveProfileBtn" class="btn btn-success" style="display: none;">Save Profile</button>
                <button type="button" id="cancelProfileBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div class="modal-overlay" id="usersModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Team Members</h3>
                <button class="modal-close" id="closeUsersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="users-grid" id="usersGrid">
                    <!-- Users will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closeUsersBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Share Task Modal -->
    <div class="modal-overlay" id="shareTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Task</h3>
                <button class="modal-close" id="closeShareTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Task</label>
                    <p id="shareTaskName" style="font-weight: 600; margin-bottom: 15px;"></p>
                </div>
                <div class="form-group">
                    <label for="shareWithUser">Share with</label>
                    <select id="shareWithUser" class="form-control" multiple size="4" aria-label="Share with users">
                        <!-- Users will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="shareMessage">Message (Optional)</label>
                    <textarea id="shareMessage" class="form-control" rows="3" placeholder="Add a note..." aria-label="Share message"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirmShareBtn" class="btn btn-primary">Share</button>
                <button type="button" id="cancelShareBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Date Range Modal -->
    <div class="modal-overlay" id="dateRangeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Date Range</h3>
                <button class="modal-close" id="closeDateRangeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dateRangeStart">Start Date</label>
                    <input type="text" id="dateRangeStart" class="form-control" required aria-label="Start Date">
                </div>
                <div class="form-group">
                    <label for="dateRangeEnd">End Date</label>
                    <input type="text" id="dateRangeEnd" class="form-control" required aria-label="End Date">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="applyDateRangeBtn" class="btn btn-primary">Apply</button>
                <button type="button" id="cancelDateRangeBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // DOM Loaded Event
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initApp();
        });
        
        // Application State
        const appState = {
            currentUser: null,
            tasks: [],
            categories: [
                { id: 1, name: 'Work' },
                { id: 2, name: 'Personal' },
                { id: 3, name: 'Shopping' },
                { id: 4, name: 'Health' },
                { id: 5, name: 'Finance' }
            ],
            users: [],
            notifications: [],
            selectedTasks: [],
            activeTaskTimer: null,
            globalTimerActive: false,
            globalTimerSeconds: 0,
            taskTimers: {},
            darkMode: false,
            history: {
                past: [],
                future: []
            },
            userStatus: 'Online'
        };
        
        // Random Tasks Generator
        function generateRandomTasks() {
            const titles = [
                'Complete project presentation',
                'Schedule team meeting',
                'Review quarterly report',
                'Pay phone bill',
                'Prepare for client meeting',
                'Update website content',
                'Buy groceries',
                'Research new product features',
                'Send follow-up emails',
                'Finish tax preparation',
                'Book flight tickets',
                'Prepare monthly budget'
            ];
            
            const descriptions = [
                'Need to finalize all slides and rehearse presentation',
                'Coordinate with all team members for availability',
                'Analyze data and prepare summary for management',
                'Monthly bill due on the 15th',
                'Prepare agenda and supporting documents',
                'Update blog posts and product descriptions',
                'Get items for the week: fruits, vegetables, etc.',
                'Look into competitors and market trends',
                'Send thank you emails to clients from last meeting',
                'Gather all documents and submit before deadline',
                'Check prices and book for upcoming conference',
                'Review expenses and plan for next month'
            ];
            
            const subTasks = [
                ['Research topic', 'Create outline', 'Design slides', 'Practice delivery'],
                ['Send calendar invites', 'Prepare agenda', 'Book conference room'],
                ['Collect data', 'Create charts', 'Write executive summary'],
                ['Check account balance', 'Transfer funds if needed'],
                ['Review client history', 'Prepare documents', 'Create presentation'],
                ['Update product images', 'Fix broken links', 'Add new testimonials'],
                ['Make shopping list', 'Check for coupons', 'Plan meals for the week'],
                ['Analyze competitor features', 'Survey customer needs', 'Document findings'],
                ['Draft templates', 'Personalize messages', 'Schedule sends'],
                ['Organize receipts', 'Calculate deductions', 'Fill out forms'],
                ['Compare prices', 'Check for loyalty points', 'Consider upgrade options'],
                ['Review last month\'s spending', 'Set budget categories', 'Identify savings opportunities']
            ];
            
            const categories = appState.categories.map(cat => cat.name);
            const priorities = ['high', 'medium', 'low'];
            const tasks = [];
            
            // Get current date for reference
            const now = new Date();
            
            for (let i = 0; i < titles.length; i++) {
                // Generate random due date - between 5 days ago and 10 days in future
                const daysOffset = Math.floor(Math.random() * 15) - 5;
                const dueDate = new Date(now);
                dueDate.setDate(dueDate.getDate() + daysOffset);
                
                // Random created date - between 30 days ago and today
                const createdDaysAgo = Math.floor(Math.random() * 30);
                const createdDate = new Date(now);
                createdDate.setDate(createdDate.getDate() - createdDaysAgo);
                
                // Determine if task has subtasks (60% chance)
                const hasSubtasks = Math.random() < 0.6;
                
                // Generate random subtasks if applicable
                const taskSubtasks = hasSubtasks ? subTasks[i].map((title, index) => {
                    return {
                        id: `subtask-${i}-${index}`,
                        title,
                        completed: Math.random() < 0.3
                    };
                }) : [];
                
                // Create the task
                const task = {
                    id: `task-${i + 1}`,
                    title: titles[i],
                    description: descriptions[i],
                    dueDate: dueDate.toISOString(),
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    category: categories[Math.floor(Math.random() * categories.length)],
                    completed: Math.random() < 0.3,
                    createdAt: createdDate.toISOString(),
                    timeSpent: Math.floor(Math.random() * 7200), // Random time spent in seconds (up to 2 hours)
                    subtasks: taskSubtasks,
                    notes: hasSubtasks ? 'This task includes multiple steps to complete.' : ''
                };
                
                tasks.push(task);
            }
            
            return tasks;
        }
        
        // Generate Random Users
        function generateRandomUsers() {
            const firstNames = ['John', 'Sarah', 'Michael', 'Emma', 'David', 'Olivia', 'James', 'Sophia'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis'];
            const domains = ['gmail.com', 'outlook.com', 'company.com', 'mail.com'];
            const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
            
            const users = [];
            
            for (let i = 0; i < 8; i++) {
                const firstName = firstNames[i];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@${domains[Math.floor(Math.random() * domains.length)]}`;
                const role = roles[Math.floor(Math.random() * roles.length)];
                
                // Random join date between 1-365 days ago
                const daysAgo = Math.floor(Math.random() * 365) + 1;
                const joinDate = new Date();
                joinDate.setDate(joinDate.getDate() - daysAgo);
                
                const user = {
                    id: `user-${i + 1}`,
                    firstName,
                    lastName,
                    fullName: `${firstName} ${lastName}`,
                    email,
                    phone: `+1 ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                    country: 'United States',
                    role,
                    joinDate: joinDate.toISOString(),
                    profilePicture: `https://randomuser.me/api/portraits/${i % 2 === 0 ? 'men' : 'women'}/${i + 1}.jpg`
                };
                
                users.push(user);
            }
            
            return users;
        }
        
        // Initialize App
        function initApp() {
            // Setup local storage check
            const hasStorage = checkLocalStorage();
            
            // Initialize flatpickr date pickers
            initDatePickers();
            
            // Add event listeners
            setupEventListeners();
            
            // Setup dark mode detection
            setupDarkMode();
            
            // Load countries for registration
            loadCountries();
            
            // Initialize random data if not exist in storage
            if (hasStorage) {
                loadStateFromStorage();
            } else {
                initializeDefaultData();
            }
            
            // Update UI based on state
            updateUI();
        }
        
        // Check if localStorage is available
        function checkLocalStorage() {
            try {
                const testKey = '__test_key__';
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                console.log('localStorage is not available:', e);
                return false;
            }
        }
        
        // Initialize default data
        function initializeDefaultData() {
            // Generate random tasks and users
            appState.tasks = generateRandomTasks();
            appState.users = generateRandomUsers();
            
            // Generate some random notifications
            generateInitialNotifications();
            
            // Save to localStorage
            saveStateToStorage();
        }
        
        // Generate initial notifications
        function generateInitialNotifications() {
            const notificationMessages = [
                'New task "Website Redesign" assigned to you',
                'Task "Submit Quarterly Report" is due tomorrow',
                'John shared a task with you: "Client Presentation"',
                'Your task "Update Product Documentation" is now completed',
                'Meeting reminder: Team sync at 3:00 PM'
            ];
            
            const notifications = [];
            
            for (let i = 0; i < notificationMessages.length; i++) {
                // Random time within last 24 hours
                const hoursAgo = Math.floor(Math.random() * 24);
                const time = new Date();
                time.setHours(time.getHours() - hoursAgo);
                
                notifications.push({
                    id: `notification-${i + 1}`,
                    title: notificationMessages[i],
                    time: time.toISOString(),
                    read: Math.random() < 0.3
                });
            }
            
            appState.notifications = notifications;
        }
        
        // Load state from storage
        function loadStateFromStorage() {
            try {
                const storedTasks = localStorage.getItem('tasks');
                const storedCategories = localStorage.getItem('categories');
                const storedUsers = localStorage.getItem('users');
                const storedNotifications = localStorage.getItem('notifications');
                const storedCurrentUser = localStorage.getItem('currentUser');
                
                if (storedTasks) {
                    appState.tasks = JSON.parse(storedTasks);
                } else {
                    appState.tasks = generateRandomTasks();
                }
                
                if (storedCategories) {
                    appState.categories = JSON.parse(storedCategories);
                }
                
                if (storedUsers) {
                    appState.users = JSON.parse(storedUsers);
                } else {
                    appState.users = generateRandomUsers();
                }
                
                if (storedNotifications) {
                    appState.notifications = JSON.parse(storedNotifications);
                } else {
                    generateInitialNotifications();
                }
                
                if (storedCurrentUser) {
                    appState.currentUser = JSON.parse(storedCurrentUser);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                // Fallback to default data if there's an error
                initializeDefaultData();
            }
        }
        
        // Save state to storage
        function saveStateToStorage() {
            try {
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                localStorage.setItem('categories', JSON.stringify(appState.categories));
                localStorage.setItem('users', JSON.stringify(appState.users));
                localStorage.setItem('notifications', JSON.stringify(appState.notifications));
                
                if (appState.currentUser) {
                    localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                }
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showToast('Error saving data', 'error');
            }
        }
        
        // Setup Dark Mode
        function setupDarkMode() {
            // Check for user preference in localStorage
            const savedMode = localStorage.getItem('darkMode');
            
            if (savedMode === 'true') {
                document.documentElement.classList.add('dark');
                appState.darkMode = true;
                updateThemeUI();
            } else if (savedMode === 'false') {
                document.documentElement.classList.remove('dark');
                appState.darkMode = false;
                updateThemeUI();
            } else {
                // Use system preference if no saved preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                    appState.darkMode = true;
                    updateThemeUI();
                }
                
                // Listen for system preference changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                        appState.darkMode = true;
                    } else {
                        document.documentElement.classList.remove('dark');
                        appState.darkMode = false;
                    }
                    updateThemeUI();
                });
            }
        }
        
        // Update Theme UI Elements
        function updateThemeUI() {
            const themeIcon = document.getElementById('themeIcon');
            const switchModeText = document.querySelector('#switchModeBtn span');
            
            if (appState.darkMode) {
                themeIcon.className = 'fas fa-moon';
                if (switchModeText) switchModeText.textContent = 'Switch to Light Mode';
            } else {
                themeIcon.className = 'fas fa-sun';
                if (switchModeText) switchModeText.textContent = 'Switch to Dark Mode';
            }
        }
        
        // Toggle Dark Mode
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                appState.darkMode = false;
            } else {
                document.documentElement.classList.add('dark');
                appState.darkMode = true;
            }
            
            // Save preference to localStorage
            localStorage.setItem('darkMode', appState.darkMode);
            
            // Update UI
            updateThemeUI();
        }
        
        // Initialize Date Pickers
        function initDatePickers() {
            // Options for task due date
            const dueDateOptions = {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "F j, Y at h:i K",
                minDate: "today",
            };
            
            // Options for birthdate (no time, past dates allowed)
            const birthDateOptions = {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "F j, Y",
                maxDate: "today",
                yearRange: [1920, new Date().getFullYear()]
            };
            
            // Options for date range
            const dateRangeOptions = {
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "F j, Y"
            };
            
            // Initialize flatpickr instances when needed
            document.getElementById('birthdate') && flatpickr("#birthdate", birthDateOptions);
            document.getElementById('taskDueDate') && flatpickr("#taskDueDate", dueDateOptions);
            document.getElementById('dateRangeStart') && flatpickr("#dateRangeStart", dateRangeOptions);
            document.getElementById('dateRangeEnd') && flatpickr("#dateRangeEnd", dateRangeOptions);
        }
        
        // Load Countries for Registration
        function loadCountries() {
            const nationalitySelect = document.getElementById('nationality');
            if (!nationalitySelect) return;
            
            // Common countries
            const commonCountries = [
                { name: 'United States', code: 'US' },
                { name: 'United Kingdom', code: 'GB' },
                { name: 'Canada', code: 'CA' },
                { name: 'Australia', code: 'AU' },
                { name: 'Germany', code: 'DE' },
                { name: 'France', code: 'FR' },
                { name: 'Japan', code: 'JP' },
                { name: 'China', code: 'CN' },
                { name: 'India', code: 'IN' },
                { name: 'Brazil', code: 'BR' },
                { name: 'Mexico', code: 'MX' },
                { name: 'Italy', code: 'IT' },
                { name: 'Spain', code: 'ES' },
                { name: 'Russia', code: 'RU' },
                { name: 'South Korea', code: 'KR' },
                { name: 'Netherlands', code: 'NL' },
                { name: 'Switzerland', code: 'CH' },
                { name: 'Sweden', code: 'SE' },
                { name: 'Norway', code: 'NO' },
                { name: 'Denmark', code: 'DK' }
            ];
            
            // Clear any existing options except the placeholder
            while (nationalitySelect.options.length > 1) {
                nationalitySelect.remove(1);
            }
            
            // Add country options
            commonCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                nationalitySelect.appendChild(option);
            });
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Auth related events
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('showRegisterBtn').addEventListener('click', () => toggleModal('registerModal', true));
            document.getElementById('closeRegisterModal').addEventListener('click', () => toggleModal('registerModal', false));
            document.getElementById('cancelRegisterBtn').addEventListener('click', () => toggleModal('registerModal', false));
            document.getElementById('createAccountBtn').addEventListener('click', handleRegistration);
            
            // Dashboard header controls
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
            document.getElementById('profileImg').addEventListener('click', toggleProfileDropdown);
            document.getElementById('notificationBadge').addEventListener('click', toggleNotificationDropdown);
            document.getElementById('viewProfileBtn').addEventListener('click', showProfileModal);
            document.getElementById('switchModeBtn').addEventListener('click', toggleDarkMode);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsRead);
            document.getElementById('logoHome').addEventListener('click', () => {
                // Show dashboard main view
                document.querySelectorAll('.section').forEach(section => {
                    section.style.display = 'block';
                });
            });
            
            // Timer controls
            document.getElementById('playPauseTimerBtn').addEventListener('click', toggleGlobalTimer);
            
            // Task management
            document.getElementById('addTaskBtn').addEventListener('click', () => toggleModal('addTaskModal', true));
            document.getElementById('closeAddTaskModal').addEventListener('click', () => toggleModal('addTaskModal', false));
            document.getElementById('cancelAddTaskBtn').addEventListener('click', () => toggleModal('addTaskModal', false));
            document.getElementById('createTaskBtn').addEventListener('click', handleAddTask);
            document.getElementById('addSubTaskBtn').addEventListener('click', addSubTaskField);
            
            // View switching
            document.getElementById('listViewBtn').addEventListener('click', () => switchTaskView('list'));
            document.getElementById('graphViewBtn').addEventListener('click', () => switchTaskView('graph'));
            
            // Task filtering and sorting
            document.getElementById('searchInput').addEventListener('input', filterTasks);
            document.getElementById('statusFilter').addEventListener('change', filterTasks);
            document.getElementById('categoryFilter').addEventListener('change', filterTasks);
            document.getElementById('priorityFilter').addEventListener('change', filterTasks);
            document.getElementById('dueDateFilter').addEventListener('change', handleDueDateFilter);
            document.getElementById('sortSelect').addEventListener('change', sortTasks);
            
            // Batch actions
            document.getElementById('batchCompleteBtn').addEventListener('click', completeBatchTasks);
            document.getElementById('batchDeleteBtn').addEventListener('click', deleteBatchTasks);
            document.getElementById('batchCancelBtn').addEventListener('click', cancelBatchSelection);
            
            // View task modal
            document.getElementById('closeViewTaskModal').addEventListener('click', () => toggleModal('viewTaskModal', false));
            document.getElementById('closeViewTaskBtn').addEventListener('click', () => toggleModal('viewTaskModal', false));
            
            // Edit task modal
            document.getElementById('closeEditTaskModal').addEventListener('click', () => toggleModal('editTaskModal', false));
            document.getElementById('cancelEditTaskBtn').addEventListener('click', () => toggleModal('editTaskModal', false));
            document.getElementById('updateTaskBtn').addEventListener('click', handleUpdateTask);
            document.getElementById('editAddSubTaskBtn').addEventListener('click', addEditSubTaskField);
            
            // Categories management
            document.getElementById('manageCategories').addEventListener('click', () => toggleModal('categoriesModal', true));
            document.getElementById('closeCategoriesModal').addEventListener('click', () => toggleModal('categoriesModal', false));
            document.getElementById('cancelCategoriesBtn').addEventListener('click', () => toggleModal('categoriesModal', false));
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            document.getElementById('saveCategoriesBtn').addEventListener('click', saveCategories);
            
            // Export/Import
            document.getElementById('exportBtn').addEventListener('click', () => toggleModal('exportModal', true));
            document.getElementById('closeExportModal').addEventListener('click', () => toggleModal('exportModal', false));
            document.getElementById('cancelExportBtn').addEventListener('click', () => toggleModal('exportModal', false));
            document.getElementById('confirmExportBtn').addEventListener('click', handleExport);
            
            document.getElementById('importBtn').addEventListener('click', () => toggleModal('importModal', true));
            document.getElementById('closeImportModal').addEventListener('click', () => toggleModal('importModal', false));
            document.getElementById('cancelImportBtn').addEventListener('click', () => toggleModal('importModal', false));
            document.getElementById('confirmImportBtn').addEventListener('click', handleImport);
            
            // Profile management
            document.getElementById('closeProfileModal').addEventListener('click', () => toggleModal('profileModal', false));
            document.getElementById('cancelProfileBtn').addEventListener('click', () => toggleModal('profileModal', false));
            document.getElementById('editProfileBtn').addEventListener('click', toggleProfileEdit);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
            document.getElementById('profilePictureUpload').addEventListener('change', handleProfileImageChange);
            
            // Users view
            document.getElementById('usersBtn').addEventListener('click', () => {
                populateUsersGrid();
                toggleModal('usersModal', true);
            });
            document.getElementById('closeUsersModal').addEventListener('click', () => toggleModal('usersModal', false));
            document.getElementById('closeUsersBtn').addEventListener('click', () => toggleModal('usersModal', false));
            
            // Date range modal
            document.getElementById('closeDateRangeModal').addEventListener('click', () => toggleModal('dateRangeModal', false));
            document.getElementById('cancelDateRangeBtn').addEventListener('click', () => toggleModal('dateRangeModal', false));
            document.getElementById('applyDateRangeBtn').addEventListener('click', applyDateRange);
            
            // Share task modal
            document.getElementById('closeShareTaskModal').addEventListener('click', () => toggleModal('shareTaskModal', false));
            document.getElementById('cancelShareBtn').addEventListener('click', () => toggleModal('shareTaskModal', false));
            document.getElementById('confirmShareBtn').addEventListener('click', handleShareTask);
            
            // Undo/Redo
            document.getElementById('undoBtn').addEventListener('click', undoAction);
            document.getElementById('redoBtn').addEventListener('click', redoAction);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+Z for Undo
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undoAction();
                }
                // Ctrl+Y for Redo
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    redoAction();
                }
            });
        }
        
        // Handle Due Date Filter Change
        function handleDueDateFilter() {
            const dueDateFilter = document.getElementById('dueDateFilter');
            
            if (dueDateFilter.value === 'custom') {
                // Initialize date pickers if they don't exist
                if (!document.getElementById('dateRangeStart')._flatpickr) {
                    flatpickr("#dateRangeStart", {
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "F j, Y"
                    });
                }
                
                if (!document.getElementById('dateRangeEnd')._flatpickr) {
                    flatpickr("#dateRangeEnd", {
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "F j, Y"
                    });
                }
                
                // Show date range modal
                toggleModal('dateRangeModal', true);
            } else {
                // Apply non-custom filter directly
                filterTasks();
            }
        }
        
        // Apply Date Range Filter
        function applyDateRange() {
            const startDate = document.getElementById('dateRangeStart').value;
            const endDate = document.getElementById('dateRangeEnd').value;
            
            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'error');
                return;
            }
            
            // Store the date range in data attributes
            const dueDateFilter = document.getElementById('dueDateFilter');
            dueDateFilter.dataset.startDate = startDate;
            dueDateFilter.dataset.endDate = endDate;
            
            // Close the modal and apply filters
            toggleModal('dateRangeModal', false);
            filterTasks();
        }
        
        // Handle Login
        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter both email and password', 'error');
                return;
            }
            
            // Check if user exists in pre-loaded users, default users, or we just let login succeed with any credentials
            const user = appState.users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            if (user) {
                // In a real app, we would verify the password here
                appState.currentUser = user;
            } else {
                // Create a new user for demo purposes
                const newUser = {
                    id: `user-${appState.users.length + 1}`,
                    firstName: 'Demo',
                    lastName: 'User',
                    fullName: 'Demo User',
                    email: email,
                    phone: '+1 555-555-5555',
                    country: 'United States',
                    role: 'Admin',
                    joinDate: new Date().toISOString(),
                    profilePicture: `https://randomuser.me/api/portraits/men/1.jpg`
                };
                
                appState.users.push(newUser);
                appState.currentUser = newUser;
            }
            
            // Save current user to localStorage
            saveStateToStorage();
            
            // Show success message and switch to dashboard
            showToast('Login successful!', 'success');
            
            // Add animation to transition
            document.getElementById('authContainer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('dashboard').style.opacity = '1';
                }, 50);
            }, 500);
            
            // Update UI with current user data
            updateUIAfterLogin();
        }
        
        // Handle Registration
        function handleRegistration() {
            const form = document.getElementById('registerForm');
            const lastName = document.getElementById('lastName').value;
            const firstName = document.getElementById('firstName').value;
            const email = document.getElementById('email').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthdate = document.getElementById('birthdate').value;
            const nationality = document.getElementById('nationality').value;
            const role = document.getElementById('role').value;
            
            // Validate all fields are filled
            if (!lastName || !firstName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Validate emails match
            if (email !== confirmEmail) {
                showToast('Emails do not match', 'error');
                return;
            }
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            // Check if email already exists
            if (appState.users.some(user => user.email.toLowerCase() === email.toLowerCase())) {
                showToast('Email already in use', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                id: `user-${appState.users.length + 1}`,
                firstName,
                lastName,
                fullName: `${firstName} ${lastName}`,
                email,
                password, // In a real app, this would be hashed
                birthdate,
                country: nationality,
                role,
                joinDate: new Date().toISOString(),
                profilePicture: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 10) + 1}.jpg`
            };
            
            // Add user to state
            appState.users.push(newUser);
            appState.currentUser = newUser;
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show success message
            showToast('Account created successfully!', 'success');
            
            // Close registration modal
            toggleModal('registerModal', false);
            
            // Switch to dashboard
            document.getElementById('authContainer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('dashboard').style.opacity = '1';
                }, 50);
            }, 500);
            
            // Update UI with current user data
            updateUIAfterLogin();
        }
        
        // Update UI after login
        function updateUIAfterLogin() {
            // Update user profile image
            document.getElementById('profileImg').src = appState.currentUser.profilePicture;
            
            // Update profile modal data
            document.getElementById('profileModalImg').src = appState.currentUser.profilePicture;
            document.getElementById('profileName').value = appState.currentUser.fullName;
            document.getElementById('profileEmail').value = appState.currentUser.email;
            document.getElementById('profilePhone').value = appState.currentUser.phone || '';
            document.getElementById('profileCountry').value = appState.currentUser.country || '';
            document.getElementById('profileRole').value = appState.currentUser.role;
            document.getElementById('profileJoinDate').value = formatDate(new Date(appState.currentUser.joinDate));
            
            // Generate welcome notification
            addNotification(`Welcome back, ${appState.currentUser.firstName}!`);
            
            // Refresh all app data
            updateUI();
            
            // Start global timer
            startGlobalTimer();
        }
        
        // Handle Logout
        function handleLogout() {
            // Stop timers
            stopGlobalTimer();
            stopAllTaskTimers();
            
            // Clear current user
            appState.currentUser = null;
            
            // Reset task selection
            appState.selectedTasks = [];
            
            // Hide profile dropdown
            toggleProfileDropdown(false);
            
            // Switch back to login page
            document.getElementById('dashboard').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('authContainer').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('authContainer').style.opacity = '1';
                }, 50);
            }, 500);
            
            // Reset login form
            document.getElementById('loginEmail').value = 'test@example.com';
            document.getElementById('loginPassword').value = '123456';
            
            // Show toast
            showToast('Logged out successfully', 'info');
        }
        
        // Handle Add Task
        function handleAddTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate')._flatpickr.selectedDates[0]?.toISOString();
            const priority = document.getElementById('taskPriority').value;
            const category = document.getElementById('taskCategory').value;
            const notes = document.getElementById('taskNotes').value;
            
            // Get subtasks
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            const subtasks = [];
            
            subtaskInputs.forEach((input, index) => {
                if (input.value.trim()) {
                    subtasks.push({
                        id: `subtask-${Date.now()}-${index}`,
                        title: input.value.trim(),
                        completed: false
                    });
                }
            });
            
            // Validate required fields
            if (!title || !dueDate || !priority || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Create new task
            const newTask = {
                id: `task-${Date.now()}`,
                title,
                description,
                dueDate,
                priority,
                category,
                completed: false,
                createdAt: new Date().toISOString(),
                timeSpent: 0,
                subtasks,
                notes
            };
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Add task to state
            appState.tasks.push(newTask);
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show success message
            showToast('Task added successfully!', 'success');
            
            // Add notification
            addNotification(`New task created: "${title}"`);
            
            // Close modal and reset form
            toggleModal('addTaskModal', false);
            document.getElementById('addTaskForm').reset();
            document.getElementById('subTasksContainer').innerHTML = `
                <div class="form-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" class="form-control subtask-input" placeholder="Enter sub-task" aria-label="Sub-task">
                    <button type="button" class="btn btn-danger remove-subtask" style="padding: 5px 10px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Add Subtask Field for New Task
        function addSubTaskField() {
            const container = document.getElementById('subTasksContainer');
            const newSubtaskDiv = document.createElement('div');
            newSubtaskDiv.className = 'form-group';
            newSubtaskDiv.style.display = 'flex';
            newSubtaskDiv.style.gap = '10px';
            newSubtaskDiv.style.marginBottom = '10px';
            
            newSubtaskDiv.innerHTML = `
                <input type="text" class="form-control subtask-input" placeholder="Enter sub-task" aria-label="Sub-task">
                <button type="button" class="btn btn-danger remove-subtask" style="padding: 5px 10px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(newSubtaskDiv);
            
            // Add event listener to remove button
            newSubtaskDiv.querySelector('.remove-subtask').addEventListener('click', function() {
                container.removeChild(newSubtaskDiv);
            });
            
            // Add event listener to each existing remove button if not already added
            document.querySelectorAll('.remove-subtask').forEach(button => {
                if (!button.hasEventListener) {
                    button.addEventListener('click', function() {
                        const parentDiv = this.parentElement;
                        container.removeChild(parentDiv);
                    });
                    button.hasEventListener = true;
                }
            });
        }
        
        // Add Subtask Field for Edit Task
        function addEditSubTaskField() {
            const container = document.getElementById('editSubTasksContainer');
            const newSubtaskDiv = document.createElement('div');
            newSubtaskDiv.className = 'form-group';
            newSubtaskDiv.style.display = 'flex';
            newSubtaskDiv.style.gap = '10px';
            newSubtaskDiv.style.marginBottom = '10px';
            
            newSubtaskDiv.innerHTML = `
                <input type="text" class="form-control edit-subtask-input" placeholder="Enter sub-task" aria-label="Sub-task">
                <button type="button" class="btn btn-danger remove-edit-subtask" style="padding: 5px 10px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(newSubtaskDiv);
            
            // Add event listener to remove button
            newSubtaskDiv.querySelector('.remove-edit-subtask').addEventListener('click', function() {
                container.removeChild(newSubtaskDiv);
            });
            
            // Add event listener to each existing remove button if not already added
            document.querySelectorAll('.remove-edit-subtask').forEach(button => {
                if (!button.hasEventListener) {
                    button.addEventListener('click', function() {
                        const parentDiv = this.parentElement;
                        container.removeChild(parentDiv);
                    });
                    button.hasEventListener = true;
                }
            });
        }
        
        // Handle Update Task
        function handleUpdateTask() {
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value;
            const description = document.getElementById('editTaskDescription').value;
            const dueDate = document.getElementById('editTaskDueDate')._flatpickr.selectedDates[0]?.toISOString();
            const priority = document.getElementById('editTaskPriority').value;
            const category = document.getElementById('editTaskCategory').value;
            const notes = document.getElementById('editTaskNotes').value;
            
            // Get subtasks
            const subtaskInputs = document.querySelectorAll('.edit-subtask-input');
            const subtasks = [];
            
            subtaskInputs.forEach((input, index) => {
                const subtaskId = input.dataset.id || `subtask-${Date.now()}-${index}`;
                const completed = input.dataset.completed === 'true';
                
                if (input.value.trim()) {
                    subtasks.push({
                        id: subtaskId,
                        title: input.value.trim(),
                        completed
                    });
                }
            });
            
            // Validate required fields
            if (!title || !dueDate || !priority || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Find the task
            const taskIndex = appState.tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex === -1) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Get the current task for comparison
            const currentTask = appState.tasks[taskIndex];
            
            // Update task
            appState.tasks[taskIndex] = {
                ...currentTask,
                title,
                description,
                dueDate,
                priority,
                category,
                subtasks,
                notes,
                updatedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show success message
            showToast('Task updated successfully!', 'success');
            
            // Add notification if something important changed
            if (currentTask.title !== title || currentTask.dueDate !== dueDate || currentTask.priority !== priority) {
                addNotification(`Task "${title}" has been updated`);
            }
            
            // Close modal
            toggleModal('editTaskModal', false);
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Add Category
        function addCategory() {
            const newCategoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!newCategoryName) {
                showToast('Please enter a category name', 'error');
                return;
            }
            
            // Check if category already exists
            if (appState.categories.some(cat => cat.name.toLowerCase() === newCategoryName.toLowerCase())) {
                showToast('Category already exists', 'warning');
                return;
            }
            
            // Add new category
            const newCategory = {
                id: Date.now(),
                name: newCategoryName
            };
            
            appState.categories.push(newCategory);
            
            // Reset input
            document.getElementById('newCategoryName').value = '';
            
            // Update categories list
            renderCategories();
            
            // Show success message
            showToast('Category added', 'success');
        }
        
        // Save Categories Changes
        function saveCategories() {
            // Save state for undo/redo
            saveHistoryState();
            
            // Save to localStorage
            saveStateToStorage();
            
            // Close modal
            toggleModal('categoriesModal', false);
            
            // Update category dropdowns
            populateCategoryDropdowns();
            
            // Show success message
            showToast('Categories saved successfully', 'success');
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Handle Delete Category
        function handleDeleteCategory(categoryId) {
            const categoryName = appState.categories.find(cat => cat.id === categoryId)?.name;
            
            // Check if category is in use
            const categoryInUse = appState.tasks.some(task => task.category === categoryName);
            
            if (categoryInUse) {
                showToast(`Cannot delete category "${categoryName}" because it's in use`, 'error');
                return;
            }
            
            // Remove category
            appState.categories = appState.categories.filter(cat => cat.id !== categoryId);
            
            // Update categories list
            renderCategories();
            
            // Show success message
            showToast('Category deleted', 'success');
        }
        
        // Render Categories List
        function renderCategories() {
            const categoriesList = document.getElementById('categoriesList');
            
            if (!categoriesList) return;
            
            categoriesList.innerHTML = '';
            
            appState.categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.style.display = 'flex';
                categoryItem.style.justifyContent = 'space-between';
                categoryItem.style.alignItems = 'center';
                categoryItem.style.padding = '10px';
                categoryItem.style.borderBottom = '1px solid var(--border-color)';
                
                categoryItem.innerHTML = `
                    <span>${category.name}</span>
                    <button class="btn btn-danger delete-category-btn" data-id="${category.id}" style="padding: 5px 10px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                categoriesList.appendChild(categoryItem);
                
                // Add event listener
                categoryItem.querySelector('.delete-category-btn').addEventListener('click', function() {
                    const categoryId = parseInt(this.dataset.id);
                    handleDeleteCategory(categoryId);
                });
            });
        }
        
        // Handle Export
        function handleExport() {
            const format = document.getElementById('exportFormat').value;
            
            // Get tasks to export (apply current filters)
            const tasksToExport = getCurrentFilteredTasks();
            
            if (tasksToExport.length === 0) {
                showToast('No tasks to export', 'warning');
                return;
            }
            
            try {
                if (format === 'json') {
                    // Export as JSON
                    const jsonData = JSON.stringify(tasksToExport, null, 2);
                    downloadData(jsonData, 'tasks.json', 'application/json');
                } else if (format === 'pdf') {
                    // Export as PDF
                    generatePDF(tasksToExport);
                } else if (format === 'excel') {
                    // Export as Excel
                    generateExcel(tasksToExport);
                }
                
                // Close modal
                toggleModal('exportModal', false);
                
                // Show success message
                showToast(`Tasks exported as ${format.toUpperCase()}`, 'success');
            } catch (error) {
                console.error('Error exporting tasks:', error);
                showToast('Error exporting tasks', 'error');
            }
        }
        
        // Download Data Helper
        function downloadData(data, filename, type) {
            const blob = new Blob([data], { type: type });
            const url = URL.createObjectURL(blob);
            
            // Create a link and trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
        
        // Generate PDF
        function generatePDF(tasks) {
            // Create new PDF document
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Task List', 14, 20);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            let y = 40;
            const pageHeight = doc.internal.pageSize.height;
            
            // Add tasks
            doc.setFontSize(12);
            
            tasks.forEach((task, index) => {
                if (y > pageHeight - 40) {
                    doc.addPage();
                    y = 20;
                }
                
                // Task number and title
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${task.title}`, 14, y);
                y += 8;
                
                // Task details
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                // Format and limit description length
                const description = task.description ? `Description: ${task.description.substring(0, 70)}${task.description.length > 70 ? '...' : ''}` : '';
                description && (doc.text(description, 18, y), y += 6);
                
                doc.text(`Due Date: ${formatDate(new Date(task.dueDate))}`, 18, y);
                y += 6;
                
                doc.text(`Priority: ${task.priority}`, 18, y);
                y += 6;
                
                doc.text(`Category: ${task.category}`, 18, y);
                y += 6;
                
                doc.text(`Status: ${task.completed ? 'Completed' : 'Pending'}`, 18, y);
                y += 10;
                
                // Reset font size for next task
                doc.setFontSize(12);
            });
            
            // Save the PDF
            doc.save('tasks.pdf');
        }
        
        // Generate Excel
        function generateExcel(tasks) {
            // Prepare data for Excel
            const excelData = [];
            
            // Add header row
            excelData.push(['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Status']);
            
            // Add task rows
            tasks.forEach(task => {
                excelData.push([
                    task.title,
                    task.description,
                    formatDate(new Date(task.dueDate)),
                    task.priority,
                    task.category,
                    task.completed ? 'Completed' : 'Pending'
                ]);
            });
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
            
            // Generate Excel file
            XLSX.writeFile(wb, 'tasks.xlsx');
        }
        
        // Handle Import
        function handleImport() {
            const importFile = document.getElementById('importFile').files[0];
            const importUrl = document.getElementById('importUrl').value;
            
            if (!importFile && !importUrl) {
                showToast('Please select a file or enter a URL', 'error');
                return;
            }
            
            if (importFile) {
                // Import from file
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedTasks = JSON.parse(e.target.result);
                        processImportedTasks(importedTasks);
                    } catch (error) {
                        console.error('Error parsing imported file:', error);
                        showToast('Invalid JSON format', 'error');
                    }
                };
                
                reader.readAsText(importFile);
            } else if (importUrl) {
                // Import from URL
                fetch(importUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(importedTasks => {
                        processImportedTasks(importedTasks);
                    })
                    .catch(error => {
                        console.error('Error fetching data from URL:', error);
                        showToast('Error importing from URL', 'error');
                    });
            }
        }
        
        // Process Imported Tasks
        function processImportedTasks(importedTasks) {
            // Validate imported data
            if (!Array.isArray(importedTasks)) {
                showToast('Invalid import format. Expected array of tasks.', 'error');
                return;
            }
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Process each task
            let importedCount = 0;
            let invalidCount = 0;
            
            importedTasks.forEach(task => {
                // Validate required fields
                if (task.title && task.dueDate) {
                    // Generate new ID to avoid conflicts
                    task.id = `task-import-${Date.now()}-${importedCount}`;
                    
                    // Set default values for missing fields
                    task.createdAt = task.createdAt || new Date().toISOString();
                    task.priority = task.priority || 'medium';
                    task.category = task.category || 'Other';
                    task.completed = task.completed || false;
                    task.timeSpent = task.timeSpent || 0;
                    task.subtasks = task.subtasks || [];
                    
                    // Add task to state
                    appState.tasks.push(task);
                    importedCount++;
                    
                    // Check if we need to add the category
                    if (!appState.categories.some(cat => cat.name === task.category)) {
                        appState.categories.push({
                            id: Date.now() + importedCount,
                            name: task.category
                        });
                    }
                } else {
                    invalidCount++;
                }
            });
            
            // Save to localStorage
            saveStateToStorage();
            
            // Close modal and reset form
            toggleModal('importModal', false);
            document.getElementById('importFile').value = '';
            document.getElementById('importUrl').value = '';
            
            // Update category dropdowns
            populateCategoryDropdowns();
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Show result message
            if (importedCount > 0) {
                showToast(`Imported ${importedCount} tasks successfully!`, 'success');
                addNotification(`Imported ${importedCount} tasks`);
            }
            
            if (invalidCount > 0) {
                showToast(`${invalidCount} tasks were invalid and skipped`, 'warning');
            }
            
            if (importedCount === 0) {
                showToast('No valid tasks found to import', 'error');
            }
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Toggle Profile Edit
        function toggleProfileEdit() {
            const profileForm = document.getElementById('profileForm');
            const inputs = profileForm.querySelectorAll('input');
            const editBtn = document.getElementById('editProfileBtn');
            const saveBtn = document.getElementById('saveProfileBtn');
            
            // Toggle readonly attribute
            inputs.forEach(input => {
                input.readOnly = !input.readOnly;
                if (!input.readOnly) {
                    input.classList.add('form-control-active');
                } else {
                    input.classList.remove('form-control-active');
                }
            });
            
            // Toggle buttons visibility
            editBtn.style.display = editBtn.style.display === 'none' ? 'block' : 'none';
            saveBtn.style.display = saveBtn.style.display === 'none' ? 'block' : 'none';
        }
        
        // Save Profile Changes
        function saveProfileChanges() {
            const name = document.getElementById('profileName').value;
            const email = document.getElementById('profileEmail').value;
            const phone = document.getElementById('profilePhone').value;
            const country = document.getElementById('profileCountry').value;
            const role = document.getElementById('profileRole').value;
            
            // Validate required fields
            if (!name || !email) {
                showToast('Name and email are required', 'error');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Update user data
            const nameParts = name.split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
            
            // Save previous user data for undo/redo
            saveHistoryState();
            
            // Update user data
            appState.currentUser.firstName = firstName;
            appState.currentUser.lastName = lastName;
            appState.currentUser.fullName = name;
            appState.currentUser.email = email;
            appState.currentUser.phone = phone;
            appState.currentUser.country = country;
            appState.currentUser.role = role;
            
            // Update in users array
            const userIndex = appState.users.findIndex(user => user.id === appState.currentUser.id);
            if (userIndex !== -1) {
                appState.users[userIndex] = { ...appState.currentUser };
            } else {
                // If not found (new user), add to users array
                appState.users.push(appState.currentUser);
            }
            
            // Save to localStorage
            saveStateToStorage();
            
            // Toggle edit mode off
            toggleProfileEdit();
            
            // Show success message
            showToast('Profile updated successfully', 'success');
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Handle Profile Image Change
        function handleProfileImageChange(e) {
            const file = e.target.files[0];
            
            if (!file) return;
            
            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            // Create a FileReader to read the image
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const imageUrl = event.target.result;
                
                // Save previous image URL for undo/redo
                saveHistoryState();
                
                // Update profile image in UI
                document.getElementById('profileModalImg').src = imageUrl;
                document.getElementById('profileImg').src = imageUrl;
                
                // Update user data
                appState.currentUser.profilePicture = imageUrl;
                
                // Update in users array
                const userIndex = appState.users.findIndex(user => user.id === appState.currentUser.id);
                if (userIndex !== -1) {
                    appState.users[userIndex].profilePicture = imageUrl;
                }
                
                // Save to localStorage
                saveStateToStorage();
                
                // Show success message
                showToast('Profile picture updated', 'success');
                
                // Update undo/redo buttons
                updateHistoryButtons();
            };
            
            reader.readAsDataURL(file);
        }
        
        // Share Task
        function handleShareTask() {
            const taskId = document.getElementById('shareTaskName').dataset.taskId;
            const selectedUsers = Array.from(document.getElementById('shareWithUser').selectedOptions).map(option => option.value);
            const message = document.getElementById('shareMessage').value;
            
            if (selectedUsers.length === 0) {
                showToast('Please select at least one user to share with', 'error');
                return;
            }
            
            // Get task details
            const task = appState.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Get user names
            const userNames = selectedUsers.map(userId => {
                const user = appState.users.find(u => u.id === userId);
                return user ? user.firstName : 'User';
            });
            
            // Add notification
            addNotification(`You shared task "${task.title}" with ${userNames.join(', ')}`);
            
            // Close modal
            toggleModal('shareTaskModal', false);
            
            // Reset form
            document.getElementById('shareMessage').value = '';
            
            // Show success message
            showToast(`Task shared with ${selectedUsers.length} user${selectedUsers.length !== 1 ? 's' : ''}`, 'success');
        }
        
        // Populate Share With Users
        function populateShareWithUsers(currentTaskId) {
            const shareWithSelect = document.getElementById('shareWithUser');
            
            // Clear existing options
            shareWithSelect.innerHTML = '';
            
            // Skip current user
            const usersToShow = appState.users.filter(user => user.id !== appState.currentUser.id);
            
            // Add options for each user
            usersToShow.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.fullName;
                shareWithSelect.appendChild(option);
            });
            
            // Set task name
            const task = appState.tasks.find(t => t.id === currentTaskId);
            const shareTaskName = document.getElementById('shareTaskName');
            
            if (task) {
                shareTaskName.textContent = task.title;
                shareTaskName.dataset.taskId = task.id;
            }
        }
        
        // Populate Users Grid
        function populateUsersGrid() {
            const usersGrid = document.getElementById('usersGrid');
            
            // Clear existing content
            usersGrid.innerHTML = '';
            
            // Add current user first
            if (appState.currentUser) {
                const currentUserCard = createUserCard(appState.currentUser, true);
                usersGrid.appendChild(currentUserCard);
            }
            
            // Add other users
            appState.users.forEach(user => {
                if (user.id !== appState.currentUser?.id) {
                    const userCard = createUserCard(user);
                    usersGrid.appendChild(userCard);
                }
            });
        }
        
        // Create User Card
        function createUserCard(user, isCurrentUser = false) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            // Add highlight for current user
            if (isCurrentUser) {
                card.style.borderLeft = '4px solid var(--primary-color)';
            }
            
            card.innerHTML = `
                <img src="${user.profilePicture}" alt="${user.fullName}" class="user-img">
                <div class="user-name">${user.fullName}</div>
                <div class="user-email">${user.email}</div>
                <div class="user-role">${user.role}</div>
            `;
            
            return card;
        }
        
        // Update User Status
        function updateUserStatus(status) {
            appState.userStatus = status;
            
            const statusIndicator = document.getElementById('statusIndicator');
            
            // Update text
            statusIndicator.querySelector('span').textContent = status;
            
            // Update colors based on status
            switch (status) {
                case 'Online':
                    statusIndicator.style.backgroundColor = 'var(--success-color)';
                    break;
                case 'Away':
                    statusIndicator.style.backgroundColor = 'var(--warning-color)';
                    break;
                case 'Busy':
                    statusIndicator.style.backgroundColor = 'var(--danger-color)';
                    break;
                case 'Offline':
                    statusIndicator.style.backgroundColor = 'var(--gray-color)';
                    break;
                default:
                    statusIndicator.style.backgroundColor = 'var(--success-color)';
            }
            
            // Add click handler if not already added
            if (!statusIndicator.hasClickHandler) {
                statusIndicator.addEventListener('click', toggleStatusOptions);
                statusIndicator.hasClickHandler = true;
            }
        }
        
        // Toggle Status Options
        function toggleStatusOptions() {
            // Check if status options exist
            let statusOptions = document.getElementById('statusOptions');
            
            if (statusOptions) {
                // If options are already open, remove them
                statusOptions.remove();
                return;
            }
            
            // Create status options dropdown
            statusOptions = document.createElement('div');
            statusOptions.id = 'statusOptions';
            statusOptions.style.position = 'absolute';
            statusOptions.style.top = '40px';
            statusOptions.style.left = '0';
            statusOptions.style.backgroundColor = 'var(--card-bg)';
            statusOptions.style.borderRadius = 'var(--border-radius)';
            statusOptions.style.boxShadow = 'var(--box-shadow)';
            statusOptions.style.zIndex = '50';
            statusOptions.style.overflow = 'hidden';
            
            // Add status options
            const statuses = ['Online', 'Away', 'Busy', 'Offline'];
            
            statuses.forEach(status => {
                const option = document.createElement('div');
                option.style.padding = '10px 20px';
                option.style.cursor = 'pointer';
                option.style.transition = 'all 0.2s';
                
                // Highlight current status
                if (status === appState.userStatus) {
                    option.style.backgroundColor = 'var(--primary-light)';
                    option.style.color = 'white';
                }
                
                option.innerHTML = `
                    <i class="fas fa-circle" style="font-size: 10px; margin-right: 5px; color: ${getStatusColor(status)}"></i>
                    <span>${status}</span>
                `;
                
                option.addEventListener('mouseenter', function() {
                    if (status !== appState.userStatus) {
                        this.style.backgroundColor = 'var(--light-gray)';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (status !== appState.userStatus) {
                        this.style.backgroundColor = 'transparent';
                    }
                });
                
                option.addEventListener('click', function() {
                    updateUserStatus(status);
                    statusOptions.remove();
                    
                    // Notify about status change
                    if (status !== appState.userStatus) {
                        showToast(`Status updated to ${status}`, 'info');
                    }
                });
                
                statusOptions.appendChild(option);
            });
            
            // Add to DOM
            document.getElementById('statusIndicator').appendChild(statusOptions);
            
            // Close when clicking outside
            document.addEventListener('click', function closeStatusOptions(e) {
                if (!statusOptions.contains(e.target) && e.target !== document.getElementById('statusIndicator')) {
                    if (document.getElementById('statusOptions')) {
                        statusOptions.remove();
                    }
                    document.removeEventListener('click', closeStatusOptions);
                }
            });
        }
        
        // Get Status Color
        function getStatusColor(status) {
            switch (status) {
                case 'Online': return 'var(--success-color)';
                case 'Away': return 'var(--warning-color)';
                case 'Busy': return 'var(--danger-color)';
                case 'Offline': return 'var(--gray-color)';
                default: return 'var(--success-color)';
            }
        }
        
        // Toggle Profile Dropdown
        function toggleProfileDropdown(forceState) {
            const dropdown = document.getElementById('profileDropdown');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (typeof forceState === 'boolean') {
                dropdown.classList.toggle('active', forceState);
            } else {
                dropdown.classList.toggle('active');
                
                // Close notification dropdown if open
                notificationDropdown.classList.remove('active');
            }
        }
        
        // Toggle Notification Dropdown
        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notificationDropdown');
            const profileDropdown = document.getElementById('profileDropdown');
            
            dropdown.classList.toggle('active');
            
            // Close profile dropdown if open
            profileDropdown.classList.remove('active');
            
            // Load notifications
            if (dropdown.classList.contains('active')) {
                renderNotifications();
            }
        }
        
        // Show Profile Modal
        function showProfileModal() {
            // Close profile dropdown
            toggleProfileDropdown(false);
            
            // Show modal
            toggleModal('profileModal', true);
        }
        
        // Toggle Modal
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            
            if (show) {
                modal.classList.add('active');
                
                // Initialize flatpickr for date fields if needed
                if (modalId === 'addTaskModal' || modalId === 'editTaskModal') {
                    initModalDatePickers(modalId);
                }
                
                // Handle specific modal initialization
                if (modalId === 'addTaskModal') {
                    populateCategoryDropdowns();
                } else if (modalId === 'editTaskModal') {
                    populateCategoryDropdowns();
                } else if (modalId === 'categoriesModal') {
                    renderCategories();
                }
            } else {
                modal.classList.remove('active');
            }
        }
        
        // Initialize Modal Date Pickers
        function initModalDatePickers(modalId) {
            if (modalId === 'addTaskModal') {
                if (document.getElementById('taskDueDate') && !document.getElementById('taskDueDate')._flatpickr) {
                    flatpickr("#taskDueDate", {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        altInput: true,
                        altFormat: "F j, Y at h:i K",
                        minDate: "today",
                    });
                }
            } else if (modalId === 'editTaskModal') {
                if (document.getElementById('editTaskDueDate') && !document.getElementById('editTaskDueDate')._flatpickr) {
                    flatpickr("#editTaskDueDate", {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        altInput: true,
                        altFormat: "F j, Y at h:i K",
                        minDate: "today",
                    });
                }
            }
        }
        
        // Populate Category Dropdowns
        function populateCategoryDropdowns() {
            const taskCategorySelect = document.getElementById('taskCategory');
            const editTaskCategorySelect = document.getElementById('editTaskCategory');
            const categoryFilterSelect = document.getElementById('categoryFilter');
            
            // Clear existing options except the first one for filter
            if (categoryFilterSelect) {
                while (categoryFilterSelect.options.length > 1) {
                    categoryFilterSelect.remove(1);
                }
            }
            
            // Clear all options for task selects
            if (taskCategorySelect) taskCategorySelect.innerHTML = '';
            if (editTaskCategorySelect) editTaskCategorySelect.innerHTML = '';
            
            // Add options for each category
            appState.categories.forEach(category => {
                if (taskCategorySelect) {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    taskCategorySelect.appendChild(option);
                }
                
                if (editTaskCategorySelect) {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    editTaskCategorySelect.appendChild(option);
                }
                
                if (categoryFilterSelect) {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categoryFilterSelect.appendChild(option);
                }
            });
        }
        
        // Switch Task View (List/Graph)
        function switchTaskView(view) {
            const listView = document.getElementById('listView');
            const graphView = document.getElementById('graphView');
            const listViewBtn = document.getElementById('listViewBtn');
            const graphViewBtn = document.getElementById('graphViewBtn');
            
            if (view === 'list') {
                listView.classList.add('active');
                graphView.classList.remove('active');
                listViewBtn.classList.add('active');
                graphViewBtn.classList.remove('active');
            } else if (view === 'graph') {
                graphView.classList.add('active');
                listView.classList.remove('active');
                graphViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                
                // Initialize charts when switching to graph view
                updateGraphs();
            }
        }
        
        // Start Global Timer
        function startGlobalTimer() {
            // Reset timer if it's not already running
            if (!appState.globalTimerActive) {
                appState.globalTimerActive = true;
                
                // Update UI
                const playPauseIcon = document.getElementById('playPauseIcon');
                playPauseIcon.className = 'fas fa-pause';
                
                // Start the timer interval
                appState.globalTimerInterval = setInterval(updateGlobalTimer, 1000);
            }
        }
        
        // Stop Global Timer
        function stopGlobalTimer() {
            if (appState.globalTimerActive) {
                appState.globalTimerActive = false;
                
                // Update UI
                const playPauseIcon = document.getElementById('playPauseIcon');
                playPauseIcon.className = 'fas fa-play';
                
                // Stop the timer interval
                clearInterval(appState.globalTimerInterval);
            }
        }
        
        // Toggle Global Timer
        function toggleGlobalTimer() {
            if (appState.globalTimerActive) {
                stopGlobalTimer();
            } else {
                startGlobalTimer();
            }
        }
        
        // Update Global Timer
        function updateGlobalTimer() {
            if (appState.globalTimerActive) {
                appState.globalTimerSeconds++;
                
                // Update timer display
                const globalTimer = document.getElementById('globalTimer');
                globalTimer.textContent = formatTime(appState.globalTimerSeconds);
                
                // Also update active task timer if any
                if (appState.activeTaskTimer) {
                    updateTaskTimer(appState.activeTaskTimer);
                }
            }
        }
        
        // Toggle Task Timer
        function toggleTaskTimer(taskId) {
            // Stop all other timers first
            stopAllTaskTimers();
            
            // Find the task
            const task = appState.tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Check if this task's timer is active
            if (appState.activeTaskTimer === taskId) {
                // Stop this timer
                appState.activeTaskTimer = null;
                
                // Update button
                const playButton = document.querySelector(`.task-btn.play-btn[data-id="${taskId}"]`);
                if (playButton) {
                    playButton.innerHTML = '<i class="fas fa-play"></i>';
                    playButton.classList.remove('active');
                    playButton.title = 'Start Timer';
                }
                
                // Save the time spent
                saveStateToStorage();
                
                // Show time spent toast
                const timeSpent = formatTime(task.timeSpent);
                showToast(`Timer stopped. Total time spent on "${task.title}": ${timeSpent}`, 'info');
            } else {
                // Start this timer
                appState.activeTaskTimer = taskId;
                
                // Ensure global timer is running
                if (!appState.globalTimerActive) {
                    startGlobalTimer();
                }
                
                // Update button
                const playButton = document.querySelector(`.task-btn.play-btn[data-id="${taskId}"]`);
                if (playButton) {
                    playButton.innerHTML = '<i class="fas fa-pause"></i>';
                    playButton.classList.add('active');
                    playButton.title = 'Pause Timer';
                }
                
                // Show start timer notification
                showToast(`Timer started for task "${task.title}"`, 'info');
                addNotification(`You started working on "${task.title}"`);
            }
        }
        
        // Update Task Timer
        function updateTaskTimer(taskId) {
            // Find the task
            const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) return;
            
            // Increment time spent
            appState.tasks[taskIndex].timeSpent++;
            
            // Update timer display if present
            const timerInfo = document.querySelector(`.timer-info[data-id="${taskId}"]`);
            if (timerInfo) {
                timerInfo.textContent = formatTime(appState.tasks[taskIndex].timeSpent);
            }
        }
        
        // Stop All Task Timers
        function stopAllTaskTimers() {
            if (appState.activeTaskTimer) {
                const oldTaskId = appState.activeTaskTimer;
                appState.activeTaskTimer = null;
                
                // Update button
                const playButton = document.querySelector(`.task-btn.play-btn[data-id="${oldTaskId}"]`);
                if (playButton) {
                    playButton.innerHTML = '<i class="fas fa-play"></i>';
                    playButton.classList.remove('active');
                }
            }
        }
        
        // Format Time (seconds to HH:MM:SS)
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // Format Date
        function formatDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        // Format Date Time
        function formatDateTime(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString(undefined, options);
        }
        
        // Format Relative Time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffSec < 60) {
                return 'just now';
            } else if (diffMin < 60) {
                return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            } else if (diffHour < 24) {
                return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
            } else if (diffDay < 30) {
                return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
            } else {
                return formatDate(date);
            }
        }
        
        // Show Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Set toast icon based on type
            let icon;
            switch (type) {
                case 'success':
                    icon = 'check-circle';
                    break;
                case 'error':
                    icon = 'times-circle';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    break;
                default:
                    icon = 'info-circle';
            }
            
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${icon} toast-icon ${type}"></i>
                    <span class="toast-text">${message}</span>
                </div>
                <button class="toast-close">&times;</button>
            `;
            
            // Add to container
            container.appendChild(toast);
            
            // Add event listener to close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                container.removeChild(toast);
            });
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 5000);
        }
        
        // Add Notification
        function addNotification(title) {
            const notification = {
                id: `notification-${Date.now()}`,
                title,
                time: new Date().toISOString(),
                read: false
            };
            
            appState.notifications.unshift(notification);
            
            // Keep max 20 notifications
            if (appState.notifications.length > 20) {
                appState.notifications = appState.notifications.slice(0, 20);
            }
            
            // Update notification badge
            updateNotificationBadge();
            
            // Save to localStorage
            saveStateToStorage();
        }
        
        // Mark Notification as Read
        function markNotificationAsRead(notificationId) {
            const index = appState.notifications.findIndex(n => n.id === notificationId);
            
            if (index !== -1) {
                appState.notifications[index].read = true;
                
                // Update notification badge
                updateNotificationBadge();
                
                // Update UI
                const notificationItem = document.getElementById(notificationId);
                if (notificationItem) {
                    notificationItem.classList.add('read');
                }
                
                // Save to localStorage
                saveStateToStorage();
            }
        }
        
        // Mark All Notifications as Read
        function markAllNotificationsRead() {
            appState.notifications.forEach(notification => {
                notification.read = true;
            });
            
            // Update notification badge
            updateNotificationBadge();
            
            // Update UI
            renderNotifications();
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show toast
            showToast('All notifications marked as read', 'success');
        }
        
        // Update Notification Badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = appState.notifications.filter(n => !n.read).length;
            
            badge.textContent = unreadCount;
            
            // Show/hide badge based on count
            if (unreadCount > 0) {
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Render Notifications
        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            
            // Clear existing notifications
            notificationsList.innerHTML = '';
            
            if (appState.notifications.length === 0) {
                notificationsList.innerHTML = '<div class="empty-state">No notifications</div>';
                return;
            }
            
            // Add notifications
            appState.notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item${notification.read ? ' read' : ''}`;
                notificationItem.id = notification.id;
                
                notificationItem.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-time">${formatRelativeTime(notification.time)}</div>
                `;
                
                // Add click event
                notificationItem.addEventListener('click', function() {
                    if (!notification.read) {
                        markNotificationAsRead(notification.id);
                    }
                });
                
                notificationsList.appendChild(notificationItem);
            });
        }
        
        // Update Task Counts
        function updateTaskCounts() {
            const totalCount = appState.tasks.length;
            const completedCount = appState.tasks.filter(task => task.completed).length;
            const pendingCount = totalCount - completedCount;
            
            document.getElementById('totalTasksCount').textContent = totalCount;
            document.getElementById('completedTasksCount').textContent = completedCount;
            document.getElementById('pendingTasksCount').textContent = pendingCount;
            
            // Calculate productivity score
            const productivityScore = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            document.getElementById('productivityScore').textContent = `${productivityScore}%`;
            
            // Calculate expired tasks
            const now = new Date();
            const expiredTasks = appState.tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate < now && !task.completed;
            }).length;
            
            document.getElementById('expiredTasksCount').textContent = expiredTasks;
            
            // Calculate due soon tasks
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setHours(twoDaysFromNow.getHours() + 48);
            
            const dueSoonTasks = appState.tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate > now && dueDate <= twoDaysFromNow && !task.completed;
            }).length;
            
            document.getElementById('dueSoonTasksCount').textContent = dueSoonTasks;
            
            // Update total time tracked
            const totalSeconds = appState.tasks.reduce((total, task) => total + task.timeSpent, 0);
            document.getElementById('totalTimeTracked').textContent = formatTime(totalSeconds);
        }
        
        // Update Graphs
        function updateGraphs() {
            // Only update graphs if on graph view or first load
            const graphView = document.getElementById('graphView');
            if (!graphView || !graphView.classList.contains('active')) return;
            
            // Get task data for charts
            const completedTasks = appState.tasks.filter(task => task.completed).length;
            const pendingTasks = appState.tasks.filter(task => !task.completed).length;
            
            // Group tasks by due date (week)
            const tasksByWeek = {};
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30); // Past 30 days
            
            for (let i = 0; i < 5; i++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(weekStart.getDate() + (i * 7));
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const weekKey = `Week ${i + 1}`;
                
                tasksByWeek[weekKey] = {
                    label: weekKey,
                    completed: 0,
                    pending: 0,
                    total: 0
                };
                
                // Count tasks in this week
                appState.tasks.forEach(task => {
                    const taskDate = new Date(task.createdAt);
                    if (taskDate >= weekStart && taskDate <= weekEnd) {
                        tasksByWeek[weekKey].total++;
                        if (task.completed) {
                            tasksByWeek[weekKey].completed++;
                        } else {
                            tasksByWeek[weekKey].pending++;
                        }
                    }
                });
            }
            
            // Line chart for task completion over time
            const taskChart = document.getElementById('tasksChart');
            
            if (taskChart) {
                // Destroy previous chart if it exists
                if (taskChart.chart) {
                    taskChart.chart.destroy();
                }
                
                const ctx = taskChart.getContext('2d');
                
                const weeks = Object.keys(tasksByWeek);
                const completedData = weeks.map(week => tasksByWeek[week].completed);
                const pendingData = weeks.map(week => tasksByWeek[week].pending);
                
                taskChart.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeks,
                        datasets: [
                            {
                                label: 'Completed Tasks',
                                data: completedData,
                                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Pending Tasks',
                                data: pendingData,
                                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.1)'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(200, 200, 200, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 10
                                }
                            }
                        }
                    }
                });
            }
            
            // Pie chart for task distribution
            const pieChart = document.getElementById('taskDistributionChart');
            
            if (pieChart) {
                // Destroy previous chart if it exists
                if (pieChart.chart) {
                    pieChart.chart.destroy();
                }
                
                const ctx = pieChart.getContext('2d');
                
                pieChart.chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Completed Tasks', 'Pending Tasks'],
                        datasets: [{
                            data: [completedTasks, pendingTasks],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(255, 193, 7, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1000,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    boxWidth: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = completedTasks + pendingTasks;
                                        const value = context.raw;
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Update Insights
        function updateInsights() {
            const now = new Date();
            
            // Get expired tasks
            const expiredTasks = appState.tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate < now && !task.completed;
            });
            
            document.getElementById('expiredTasksCount').textContent = expiredTasks.length;
            
            // Get due soon tasks
            const twoDaysFromNow = new Date();
            twoDaysFromNow.setHours(twoDaysFromNow.getHours() + 48);
            
            const dueSoonTasks = appState.tasks.filter(task => {
                const dueDate = new Date(task.dueDate);
                return dueDate > now && dueDate <= twoDaysFromNow && !task.completed;
            });
            
            document.getElementById('dueSoonTasksCount').textContent = dueSoonTasks.length;
            
            // Calculate productivity score
            const totalTasks = appState.tasks.length;
            const completedTasks = appState.tasks.filter(task => task.completed).length;
            const productivityScore = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('productivityScore').textContent = `${productivityScore}%`;
            
            // Update total time tracked
            const totalSeconds = appState.tasks.reduce((total, task) => total + task.timeSpent, 0);
            document.getElementById('totalTimeTracked').textContent = formatTime(totalSeconds);
        }
        
        // Filter Tasks
        function filterTasks() {
            renderTasks();
        }
        
        // Get Current Filtered Tasks
        function getCurrentFilteredTasks() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const dueDateFilter = document.getElementById('dueDateFilter').value;
            
            // Get custom date range if selected
            let startDate = null;
            let endDate = null;
            
            if (dueDateFilter === 'custom') {
                const dueDateFilterElem = document.getElementById('dueDateFilter');
                if (dueDateFilterElem.dataset.startDate && dueDateFilterElem.dataset.endDate) {
                    startDate = new Date(dueDateFilterElem.dataset.startDate);
                    endDate = new Date(dueDateFilterElem.dataset.endDate);
                    endDate.setHours(23, 59, 59, 999); // End of the day
                }
            }
            
            // Apply filters
            return appState.tasks.filter(task => {
                // Search filter
                const matchesSearch = 
                    searchQuery === '' || 
                    task.title.toLowerCase().includes(searchQuery) || 
                    task.description.toLowerCase().includes(searchQuery);
                
                // Status filter
                const matchesStatus = 
                    statusFilter === 'all' || 
                    (statusFilter === 'completed' && task.completed) || 
                    (statusFilter === 'active' && !task.completed);
                
                // Category filter
                const matchesCategory = 
                    categoryFilter === 'all' || 
                    task.category === categoryFilter;
                
                // Priority filter
                const matchesPriority = 
                    priorityFilter === 'all' || 
                    task.priority === priorityFilter;
                
                // Due date filter
                let matchesDueDate = true;
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                
                if (dueDateFilter === 'today') {
                    matchesDueDate = 
                        dueDate.getDate() === today.getDate() && 
                        dueDate.getMonth() === today.getMonth() && 
                        dueDate.getFullYear() === today.getFullYear();
                } else if (dueDateFilter === 'week') {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay()); // Sunday
                    
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6); // Saturday
                    weekEnd.setHours(23, 59, 59, 999);
                    
                    matchesDueDate = dueDate >= weekStart && dueDate <= weekEnd;
                } else if (dueDateFilter === 'month') {
                    matchesDueDate = 
                        dueDate.getMonth() === today.getMonth() && 
                        dueDate.getFullYear() === today.getFullYear();
                } else if (dueDateFilter === 'custom' && startDate && endDate) {
                    matchesDueDate = dueDate >= startDate && dueDate <= endDate;
                }
                
                return matchesSearch && matchesStatus && matchesCategory && matchesPriority && matchesDueDate;
            });
        }
        
        // Sort Tasks
        function sortTasks() {
            renderTasks();
        }
        
        // Complete Batch Tasks
        function completeBatchTasks() {
            if (appState.selectedTasks.length === 0) {
                showToast('No tasks selected', 'error');
                return;
            }
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Update tasks
            appState.selectedTasks.forEach(taskId => {
                const taskIndex = appState.tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    appState.tasks[taskIndex].completed = true;
                }
            });
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show toast
            showToast(`${appState.selectedTasks.length} tasks marked as completed`, 'success');
            
            // Add notification
            addNotification(`You completed ${appState.selectedTasks.length} tasks`);
            
            // Clear selection
            cancelBatchSelection();
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Delete Batch Tasks
        function deleteBatchTasks() {
            if (appState.selectedTasks.length === 0) {
                showToast('No tasks selected', 'error');
                return;
            }
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Get task names for notification
            const taskNames = appState.selectedTasks.map(taskId => {
                const task = appState.tasks.find(t => t.id === taskId);
                return task ? task.title : '';
            }).filter(Boolean);
            
            // Delete tasks
            appState.tasks = appState.tasks.filter(task => !appState.selectedTasks.includes(task.id));
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show toast
            showToast(`${appState.selectedTasks.length} tasks deleted`, 'success');
            
            // Add notification
            if (taskNames.length > 2) {
                addNotification(`You deleted ${taskNames.length} tasks including "${taskNames[0]}" and "${taskNames[1]}"`);
            } else if (taskNames.length === 2) {
                addNotification(`You deleted "${taskNames[0]}" and "${taskNames[1]}"`);
            } else if (taskNames.length === 1) {
                addNotification(`You deleted "${taskNames[0]}"`);
            }
            
            // Clear selection
            cancelBatchSelection();
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Cancel Batch Selection
        function cancelBatchSelection() {
            appState.selectedTasks = [];
            
            // Hide batch actions bar
            document.getElementById('batchActions').classList.remove('active');
            
            // Uncheck all checkboxes
            document.querySelectorAll('.task-selection').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Update Batch Selection
        function updateBatchSelection() {
            const batchActions = document.getElementById('batchActions');
            const selectedItemsCount = document.getElementById('selectedItemsCount');
            
            if (appState.selectedTasks.length > 0) {
                batchActions.classList.add('active');
                selectedItemsCount.textContent = `${appState.selectedTasks.length} task${appState.selectedTasks.length !== 1 ? 's' : ''} selected`;
            } else {
                batchActions.classList.remove('active');
            }
        }
        
        // Toggle Task Selection
        function toggleTaskSelection(taskId, checked) {
            if (checked) {
                if (!appState.selectedTasks.includes(taskId)) {
                    appState.selectedTasks.push(taskId);
                }
            } else {
                appState.selectedTasks = appState.selectedTasks.filter(id => id !== taskId);
            }
            
            updateBatchSelection();
        }
        
        // View Task
        function viewTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Set modal data
            document.getElementById('viewTaskTitle').textContent = task.title;
            document.getElementById('viewTaskDescription').textContent = task.description || 'No description';
            document.getElementById('viewTaskDueDate').textContent = formatDateTime(new Date(task.dueDate));
            
            const viewTaskPriority = document.getElementById('viewTaskPriority');
            viewTaskPriority.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            viewTaskPriority.className = `task-priority priority-${task.priority}`;
            
            document.getElementById('viewTaskCategory').textContent = task.category;
            document.getElementById('viewTaskTimeSpent').textContent = formatTime(task.timeSpent);
            document.getElementById('viewTaskNotes').textContent = task.notes || 'No notes';
            
            // Check if task has subtasks
            const subtasksContainer = document.getElementById('viewTaskSubtasksContainer');
            const subtasksList = document.getElementById('viewTaskSubtasks');
            
            if (task.subtasks && task.subtasks.length > 0) {
                subtasksContainer.style.display = 'block';
                subtasksList.innerHTML = '';
                
                task.subtasks.forEach(subtask => {
                    const subtaskItem = document.createElement('div');
                    subtaskItem.className = `subtask-item${subtask.completed ? ' completed' : ''}`;
                    
                    subtaskItem.innerHTML = `
                        <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''} disabled>
                        <span>${subtask.title}</span>
                    `;
                    
                    subtasksList.appendChild(subtaskItem);
                });
            } else {
                subtasksContainer.style.display = 'none';
            }
            
            // Show modal
            toggleModal('viewTaskModal', true);
        }
        
        // Edit Task
        function editTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Set modal data
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description || '';
            
            // Initialize date picker
            if (!document.getElementById('editTaskDueDate')._flatpickr) {
                flatpickr("#editTaskDueDate", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    altInput: true,
                    altFormat: "F j, Y at h:i K",
                    minDate: "today",
                });
            }
            
            // Set due date
            document.getElementById('editTaskDueDate')._flatpickr.setDate(task.dueDate);
            
            // Set priority and category
            document.getElementById('editTaskPriority').value = task.priority;
            populateCategoryDropdowns(); // Make sure categories are loaded
            document.getElementById('editTaskCategory').value = task.category;
            document.getElementById('editTaskNotes').value = task.notes || '';
            
            // Set subtasks
            const subtasksContainer = document.getElementById('editSubTasksContainer');
            subtasksContainer.innerHTML = '';
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const subtaskDiv = document.createElement('div');
                    subtaskDiv.className = 'form-group';
                    subtaskDiv.style.display = 'flex';
                    subtaskDiv.style.gap = '10px';
                    subtaskDiv.style.marginBottom = '10px';
                    
                    subtaskDiv.innerHTML = `
                        <div style="display: flex; align-items: center; margin-right: 10px;">
                            <input type="checkbox" ${subtask.completed ? 'checked' : ''} class="subtask-status" style="transform: scale(1.2);">
                        </div>
                        <input type="text" class="form-control edit-subtask-input" value="${subtask.title}" data-id="${subtask.id}" data-completed="${subtask.completed}" placeholder="Enter sub-task" aria-label="Sub-task">
                        <button type="button" class="btn btn-danger remove-edit-subtask" style="padding: 5px 10px;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    subtasksContainer.appendChild(subtaskDiv);
                    
                    // Add event listener to remove button
                    subtaskDiv.querySelector('.remove-edit-subtask').addEventListener('click', function() {
                        subtasksContainer.removeChild(subtaskDiv);
                    });
                    
                    // Add event listener to checkbox
                    subtaskDiv.querySelector('.subtask-status').addEventListener('change', function() {
                        const input = subtaskDiv.querySelector('.edit-subtask-input');
                        input.dataset.completed = this.checked;
                    });
                });
            } else {
                // Add an empty subtask field
                const subtaskDiv = document.createElement('div');
                subtaskDiv.className = 'form-group';
                subtaskDiv.style.display = 'flex';
                subtaskDiv.style.gap = '10px';
                subtaskDiv.style.marginBottom = '10px';
                
                subtaskDiv.innerHTML = `
                    <input type="text" class="form-control edit-subtask-input" placeholder="Enter sub-task" aria-label="Sub-task">
                    <button type="button" class="btn btn-danger remove-edit-subtask" style="padding: 5px 10px;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                subtasksContainer.appendChild(subtaskDiv);
                
                // Add event listener to remove button
                subtaskDiv.querySelector('.remove-edit-subtask').addEventListener('click', function() {
                    subtasksContainer.removeChild(subtaskDiv);
                });
            }
            
            // Show modal
            toggleModal('editTaskModal', true);
        }
        
        // Delete Task
        function deleteTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Confirm deletion
            if (confirm(`Are you sure you want to delete task "${task.title}"?`)) {
                // Save state for undo/redo
                saveHistoryState();
                
                // Remove task
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                
                // Save to localStorage
                saveStateToStorage();
                
                // Show toast
                showToast(`Task "${task.title}" deleted`, 'success');
                
                // Add notification
                addNotification(`You deleted task "${task.title}"`);
                
                // Update UI
                renderTasks();
                updateTaskCounts();
                updateGraphs();
                updateInsights();
                
                // Update undo/redo buttons
                updateHistoryButtons();
            }
        }
        
        // Toggle Task Completion
        function toggleTaskCompletion(taskId) {
            const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) {
                showToast('Task not found', 'error');
                return;
            }
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Toggle completion
            appState.tasks[taskIndex].completed = !appState.tasks[taskIndex].completed;
            
            // If task is now completed, stop its timer if active
            if (appState.tasks[taskIndex].completed && appState.activeTaskTimer === taskId) {
                toggleTaskTimer(taskId);
            }
            
            // Save to localStorage
            saveStateToStorage();
            
            // Show toast
            const task = appState.tasks[taskIndex];
            if (task.completed) {
                showToast(`Task "${task.title}" marked as completed`, 'success');
                addNotification(`You completed task "${task.title}"`);
            } else {
                showToast(`Task "${task.title}" marked as incomplete`, 'info');
            }
            
            // Update UI
            renderTasks();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Share Task
        function shareTask(taskId) {
            // Populate share with users
            populateShareWithUsers(taskId);
            
            // Show modal
            toggleModal('shareTaskModal', true);
        }
        
        // Render Tasks
        function renderTasks() {
            const tasksContainer = document.getElementById('tasksContainer');
            
            if (!tasksContainer) return;
            
            // Get filtered tasks
            let filteredTasks = getCurrentFilteredTasks();
            
            // Sort tasks
            const sortSelect = document.getElementById('sortSelect');
            const sortValue = sortSelect ? sortSelect.value : 'dueDate-asc';
            const [sortField, sortDirection] = sortValue.split('-');
            
            filteredTasks.sort((a, b) => {
                let valueA, valueB;
                
                // Get values based on sort field
                switch (sortField) {
                    case 'title':
                        valueA = a.title.toLowerCase();
                        valueB = b.title.toLowerCase();
                        break;
                    case 'dueDate':
                        valueA = new Date(a.dueDate);
                        valueB = new Date(b.dueDate);
                        break;
                    case 'priority':
                        const priorityValues = { high: 3, medium: 2, low: 1 };
                        valueA = priorityValues[a.priority] || 0;
                        valueB = priorityValues[b.priority] || 0;
                        break;
                    case 'created':
                        valueA = new Date(a.createdAt);
                        valueB = new Date(b.createdAt);
                        break;
                    default:
                        valueA = a[sortField];
                        valueB = b[sortField];
                }
                
                // Compare values based on direction
                if (sortDirection === 'asc') {
                    return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                } else {
                    return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                }
            });
            
            // Clear existing tasks
            tasksContainer.innerHTML = '';
            
            // Show message if no tasks
            if (filteredTasks.length === 0) {
                tasksContainer.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 60px; color: var(--gray-color); margin-bottom: 20px;">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3>No tasks found</h3>
                        <p>Try adjusting your filters or add a new task</p>
                    </div>
                `;
                return;
            }
            
            // Render tasks
            filteredTasks.forEach(task => {
                // Determine task due date status
                const now = new Date();
                const dueDate = new Date(task.dueDate);
                const twoDaysFromNow = new Date();
                twoDaysFromNow.setHours(twoDaysFromNow.getHours() + 48);
                
                let dueDateClass = '';
                if (dueDate < now && !task.completed) {
                    dueDateClass = 'expired';
                } else if (dueDate <= twoDaysFromNow && !task.completed) {
                    dueDateClass = 'due-soon';
                } else if (!task.completed) {
                    dueDateClass = 'due-later';
                }
                
                // Create task element
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${dueDateClass}${task.completed ? ' completed' : ''}`;
                taskElement.setAttribute('data-id', task.id);
                taskElement.draggable = true;
                
                // Task content
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-title-container">
                            <input type="checkbox" class="task-selection" aria-label="Select task" ${appState.selectedTasks.includes(task.id) ? 'checked' : ''}>
                            <div>
                                <h3 class="task-title">${task.title}</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                                    <span class="task-priority priority-${task.priority}">${task.priority}</span>
                                    <span class="task-category">${task.category}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="task-body">
                        <p class="task-description">${task.description || 'No description'}</p>
                        
                        <div class="task-dates">
                            <div>
                                <i class="far fa-calendar-alt"></i> Due: ${formatDateTime(new Date(task.dueDate))}
                                ${dueDateClass === 'expired' ? '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Expired</span>' : ''}
                                ${dueDateClass === 'due-soon' ? '<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Due soon</span>' : ''}
                            </div>
                            <div>
                                <i class="far fa-clock"></i> Created: ${formatDate(new Date(task.createdAt))}
                            </div>
                        </div>
                        
                        ${task.subtasks && task.subtasks.length > 0 ? `
                            <div class="subtasks-container">
                                <h4 style="margin-bottom: 10px;">Sub-tasks (${task.subtasks.filter(s => s.completed).length}/${task.subtasks.length})</h4>
                                ${task.subtasks.map(subtask => `
                                    <div class="subtask-item${subtask.completed ? ' completed' : ''}">
                                        <input type="checkbox" class="subtask-checkbox" data-task-id="${task.id}" data-subtask-id="${subtask.id}" ${subtask.completed ? 'checked' : ''}>
                                        <span>${subtask.title}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="task-footer">
                        <div class="timer-info" data-id="${task.id}">${formatTime(task.timeSpent)}</div>
                        
                        <div class="task-controls">
                            <button class="task-btn view-btn" data-id="${task.id}" aria-label="View task">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="task-btn edit-btn" data-id="${task.id}" aria-label="Edit task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="task-btn share-btn" data-id="${task.id}" aria-label="Share task">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="task-btn delete-btn" data-id="${task.id}" aria-label="Delete task">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="task-btn play-btn${appState.activeTaskTimer === task.id ? ' active' : ''}" data-id="${task.id}" aria-label="${appState.activeTaskTimer === task.id ? 'Pause timer' : 'Start timer'}">
                                <i class="fas fa-${appState.activeTaskTimer === task.id ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                        
                        <div class="task-toggle-container">
                            <span>Mark as completed</span>
                            <label class="task-toggle">
                                <input type="checkbox" class="task-complete-toggle" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                `;
                
                tasksContainer.appendChild(taskElement);
                
                // Add event listeners to buttons
                taskElement.querySelector('.task-selection').addEventListener('change', function() {
                    toggleTaskSelection(task.id, this.checked);
                });
                
                taskElement.querySelector('.task-btn.view-btn').addEventListener('click', function() {
                    viewTask(task.id);
                });
                
                taskElement.querySelector('.task-btn.edit-btn').addEventListener('click', function() {
                    editTask(task.id);
                });
                
                taskElement.querySelector('.task-btn.delete-btn').addEventListener('click', function() {
                    deleteTask(task.id);
                });
                
                taskElement.querySelector('.task-btn.share-btn').addEventListener('click', function() {
                    shareTask(task.id);
                });
                
                taskElement.querySelector('.task-btn.play-btn').addEventListener('click', function() {
                    toggleTaskTimer(task.id);
                });
                
                taskElement.querySelector('.task-complete-toggle').addEventListener('change', function() {
                    toggleTaskCompletion(task.id);
                });
                
                // Add event listeners to subtasks
                taskElement.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const taskId = this.dataset.taskId;
                        const subtaskId = this.dataset.subtaskId;
                        toggleSubtaskCompletion(taskId, subtaskId, this.checked);
                    });
                });
                
                // Add drag and drop event listeners
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragover', handleDragOver);
                taskElement.addEventListener('dragenter', handleDragEnter);
                taskElement.addEventListener('dragleave', handleDragLeave);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('drop', handleDrop);
            });
        }
        
        // Toggle Subtask Completion
        function toggleSubtaskCompletion(taskId, subtaskId, completed) {
            const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
            
            if (taskIndex === -1) return;
            
            const subtaskIndex = appState.tasks[taskIndex].subtasks.findIndex(s => s.id === subtaskId);
            
            if (subtaskIndex === -1) return;
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Update subtask
            appState.tasks[taskIndex].subtasks[subtaskIndex].completed = completed;
            
            // Check if all subtasks are completed
            const allSubtasksCompleted = appState.tasks[taskIndex].subtasks.every(s => s.completed);
            
            // Save to localStorage
            saveStateToStorage();
            
            // Update UI
            renderTasks();
            
            // Show toast if all subtasks completed
            if (allSubtasksCompleted && appState.tasks[taskIndex].subtasks.length > 0) {
                showToast('All subtasks completed!', 'success');
            }
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Drag and Drop Handlers
        let draggedItem = null;
        
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }
        
        function handleDragLeave() {
            this.classList.remove('drag-over');
        }
        
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = this.getAttribute('data-id');
            
            if (draggedId === targetId) return;
            
            // Find indices
            const draggedIndex = appState.tasks.findIndex(t => t.id === draggedId);
            const targetIndex = appState.tasks.findIndex(t => t.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Save state for undo/redo
            saveHistoryState();
            
            // Reorder tasks
            const taskToMove = appState.tasks[draggedIndex];
            appState.tasks.splice(draggedIndex, 1);
            appState.tasks.splice(targetIndex, 0, taskToMove);
            
            // Save to localStorage
            saveStateToStorage();
            
            // Update UI
            renderTasks();
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Save History State
        function saveHistoryState() {
            // Save current state to history
            appState.history.past.push(JSON.stringify({
                tasks: appState.tasks,
                categories: appState.categories,
                currentUser: appState.currentUser
            }));
            
            // Clear future states when a new action is performed
            appState.history.future = [];
            
            // Limit history size
            if (appState.history.past.length > 20) {
                appState.history.past.shift();
            }
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
        
        // Update History Buttons
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            undoBtn.disabled = appState.history.past.length === 0;
            redoBtn.disabled = appState.history.future.length === 0;
        }
        
        // Undo Action
        function undoAction() {
            if (appState.history.past.length === 0) return;
            
            // Get last state
            const lastState = JSON.parse(appState.history.past.pop());
            
            // Save current state to future
            appState.history.future.push(JSON.stringify({
                tasks: appState.tasks,
                categories: appState.categories,
                currentUser: appState.currentUser
            }));
            
            // Restore state
            appState.tasks = lastState.tasks;
            appState.categories = lastState.categories;
            
            if (lastState.currentUser) {
                appState.currentUser = lastState.currentUser;
                document.getElementById('profileImg').src = appState.currentUser.profilePicture;
                document.getElementById('profileModalImg').src = appState.currentUser.profilePicture;
            }
            
            // Save to localStorage
            saveStateToStorage();
            
            // Update UI
            renderTasks();
            populateCategoryDropdowns();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
            
            // Show toast
            showToast('Action undone', 'info');
        }
        
        // Redo Action
        function redoAction() {
            if (appState.history.future.length === 0) return;
            
            // Get next state
            const nextState = JSON.parse(appState.history.future.pop());
            
            // Save current state to past
            appState.history.past.push(JSON.stringify({
                tasks: appState.tasks,
                categories: appState.categories,
                currentUser: appState.currentUser
            }));
            
            // Restore state
            appState.tasks = nextState.tasks;
            appState.categories = nextState.categories;
            
            if (nextState.currentUser) {
                appState.currentUser = nextState.currentUser;
                document.getElementById('profileImg').src = appState.currentUser.profilePicture;
                document.getElementById('profileModalImg').src = appState.currentUser.profilePicture;
            }
            
            // Save to localStorage
            saveStateToStorage();
            
            // Update UI
            renderTasks();
            populateCategoryDropdowns();
            updateTaskCounts();
            updateGraphs();
            updateInsights();
            
            // Update undo/redo buttons
            updateHistoryButtons();
            
            // Show toast
            showToast('Action redone', 'info');
        }
        
        // Update UI
        function updateUI() {
            // Update task counts
            updateTaskCounts();
            
            // Render tasks
            renderTasks();
            
            // Update notification badge
            updateNotificationBadge();
            
            // Populate category dropdowns
            populateCategoryDropdowns();
            
            // Update graphs
            updateGraphs();
            
            // Update insights
            updateInsights();
            
            // Update user status
            updateUserStatus('Online');
            
            // Update undo/redo buttons
            updateHistoryButtons();
        }
    </script>
</body>
</html>
