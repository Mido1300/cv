<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional To-Do App</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Flatpickr Calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- XLSX for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* Color Variables */
            --primary-color: #5D5CDE;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --orange-color: #FD7E14;
            --gray-color: #6C757D;
            --dark-blue: #00008B;
            
            /* Light Mode Colors */
            --bg-color: #FFFFFF;
            --card-bg: #f8f9fa;
            --text-color: #333333;
            --border-color: #dee2e6;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Transition Speed */
            --transition-speed: 0.3s;
        }
        
        /* Dark Mode Colors */
        .dark {
            --bg-color: #181818;
            --card-bg: #282828;
            --text-color: #FFFFFF;
            --border-color: #444444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-md);
        }
        
        .login-form {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: var(--spacing-xl);
            width: 100%;
            max-width: 400px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .login-form:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
            outline: none;
        }
        
        .login-btn {
            display: block;
            width: 80%;
            margin: var(--spacing-lg) auto;
            padding: var(--spacing-sm);
            background: linear-gradient(to right, var(--primary-color), #7776e7);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 1s;
        }
        
        .login-btn:hover::before {
            left: 100%;
        }
        
        .login-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.5);
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .register-link {
            text-align: center;
            margin-top: var(--spacing-md);
        }
        
        .register-link a {
            color: var(--dark-blue);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--card-bg);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .task-timer {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            border-radius: 5px;
            padding: var(--spacing-xs) var(--spacing-sm);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .timer-display {
            font-size: 18px;
            font-weight: 600;
            margin: 0 var(--spacing-sm);
        }
        
        .timer-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .timer-btn:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .mode-switch {
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s, transform 0.5s;
        }
        
        .mode-switch:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .profile {
            position: relative;
            cursor: pointer;
        }
        
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--success-color);
            transition: transform 0.3s;
        }
        
        .profile-img:hover {
            transform: scale(1.05);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            overflow: hidden;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .profile-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .dropdown-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .main-container {
            flex: 1;
            padding: var(--spacing-lg);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Header Buttons */
        .header-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        
        .header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(93, 92, 222, 0.3);
        }
        
        /* Task Summary Section */
        .summary-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .total-tasks-card {
            grid-column: 1 / -1;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: var(--spacing-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .total-tasks-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .summary-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: var(--spacing-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .completed-card {
            border-left: 5px solid var(--success-color);
        }
        
        .pending-card {
            border-left: 5px solid var(--warning-color);
        }
        
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .card-count {
            font-size: 24px;
            font-weight: 700;
        }
        
        /* Insights Section */
        .insights-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .insight-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: var(--spacing-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .insight-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        /* Tasks Section */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .tasks-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .tasks-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-gray {
            background-color: var(--gray-color);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        /* Task Filters */
        .filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--card-bg);
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .filter-label {
            font-weight: 500;
            white-space: nowrap;
        }
        
        .filter-select {
            padding: var(--spacing-xs);
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .search-container {
            position: relative;
            flex-grow: 1;
        }
        
        .search-input {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-sm) var(--spacing-xs) var(--spacing-lg);
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        
        .search-icon {
            position: absolute;
            left: var(--spacing-xs);
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* View Switcher */
        .view-switch {
            display: flex;
            margin-bottom: var(--spacing-md);
        }
        
        .view-btn {
            padding: var(--spacing-xs) var(--spacing-md);
            background-color: var(--card-bg);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .view-btn:first-child {
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }
        
        .view-btn:last-child {
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Task List */
        .tasks-list {
            margin-bottom: var(--spacing-lg);
        }
        
        .task-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--gray-color);
            display: flex;
            align-items: flex-start;
        }
        
        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .task-item.expired {
            border-left-color: var(--danger-color);
        }
        
        .task-item.due-soon {
            border-left-color: var(--warning-color);
        }
        
        .task-item.completed {
            border-left-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .task-checkbox {
            margin-right: var(--spacing-sm);
            transform: scale(1.2);
        }
        
        .task-content {
            flex-grow: 1;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }
        
        .task-title {
            font-weight: 600;
            font-size: 18px;
            margin-right: var(--spacing-sm);
        }
        
        .priority-badge {
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .priority-high {
            background-color: var(--danger-color);
            color: white;
        }
        
        .priority-medium {
            background-color: var(--orange-color);
            color: white;
        }
        
        .priority-low {
            background-color: var(--gray-color);
            color: white;
        }
        
        .task-details {
            margin-bottom: var(--spacing-xs);
        }
        
        .task-description {
            margin-bottom: var(--spacing-xs);
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            font-size: 14px;
            margin-bottom: var(--spacing-xs);
        }
        
        .task-due, .task-category {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        .btn-view {
            color: var(--primary-color);
        }
        
        .btn-edit {
            color: var(--warning-color);
        }
        
        .btn-delete {
            color: var(--danger-color);
        }
        
        .btn-play {
            color: var(--success-color);
        }
        
        .btn-share {
            color: var(--primary-color);
        }
        
        .task-timer-display {
            font-size: 14px;
            font-weight: 500;
            margin-left: var(--spacing-xs);
        }
        
        /* Graph View */
        .graph-view {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
        }
        
        .graph-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: var(--spacing-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        /* Multi-Select Action Bar */
        .multi-select-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, var(--primary-color), #7776e7);
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 100;
        }
        
        .multi-select-bar.show {
            transform: translateY(0);
        }
        
        .multi-select-count {
            color: white;
            font-weight: 600;
        }
        
        .multi-select-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .modal {
            background-color: var(--bg-color);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
            opacity: 1;
        }
        
        .modal-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--gray-color);
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: var(--spacing-md);
        }
        
        .modal-footer {
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }
        
        /* Form Styles */
        .form-row {
            margin-bottom: var(--spacing-md);
        }
        
        .subtasks-container {
            margin-top: var(--spacing-xs);
        }
        
        .subtask-item {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
            align-items: center;
        }
        
        .subtask-input {
            flex-grow: 1;
            padding: var(--spacing-xs);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .add-subtask-btn, .remove-subtask-btn {
            min-width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .add-subtask-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .remove-subtask-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .add-subtask-btn:hover, .remove-subtask-btn:hover {
            transform: scale(1.1);
        }
        
        /* Custom Toggle Switch */
        .toggle-container {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-color);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .toggle-input:checked + .toggle-slider {
            background-color: var(--success-color);
        }
        
        .toggle-input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .toast {
            background-color: var(--card-bg);
            border-radius: 5px;
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeInUp 0.3s, fadeOut 0.3s 4.7s;
            width: 300px;
            max-width: 100%;
        }
        
        .toast-content {
            margin-right: var(--spacing-sm);
        }
        
        .toast-message {
            margin-right: var(--spacing-sm);
        }
        
        .toast-action {
            color: var(--primary-color);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* Notification Popup */
        .notification-popup {
            position: absolute;
            top: 50px;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .notification-popup.show {
            display: block;
        }
        
        .notification-header {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .notification-list {
            padding: var(--spacing-xs);
        }
        
        .notification-item {
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .notification-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-message {
            margin-bottom: var(--spacing-xs);
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--gray-color);
        }
        
        /* User Cards */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
        }
        
        .user-card {
            background-color: var(--bg-color);
            border-radius: 10px;
            padding: var(--spacing-md);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .user-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: var(--spacing-sm);
            border: 3px solid var(--primary-color);
        }
        
        .user-name {
            font-weight: 600;
            text-align: center;
            margin-bottom: var(--spacing-xs);
        }
        
        .user-email, .user-role {
            font-size: 14px;
            text-align: center;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        /* Animation Keyframes */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .insights-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .graph-view {
                grid-template-columns: 1fr;
            }
            
            .users-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                margin-bottom: var(--spacing-xs);
            }
        }
        
        @media (max-width: 576px) {
            .summary-section {
                grid-template-columns: 1fr;
            }
            
            .insights-section {
                grid-template-columns: 1fr;
            }
            
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .task-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }
            
            .tasks-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .task-meta {
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            
            .header {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: flex-start;
            }
            
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2 class="form-title">Welcome to the To-Do App</h2>
            <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" class="form-input" value="test@example.com" required>
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" value="123456" required>
            </div>
            <button id="loginButton" class="login-btn">Login</button>
            <div class="register-link">
                Don't have an account? <a href="#" id="registerLink">Register now</a>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Container -->
    <div class="dashboard" id="dashboardContainer">
        <header class="header">
            <div class="app-title">To-Do App</div>
            <div class="header-actions">
                <button class="header-btn" id="usersButton">Users</button>
                <button class="header-btn" id="categoriesButton">Manage Categories</button>
            </div>
            <div class="header-right">
                <div class="task-timer">
                    <button class="timer-btn" id="timerPlayPause" aria-label="Play/Pause Timer">
                        <i class="fas fa-play"></i>
                    </button>
                    <span class="timer-display" id="timerDisplay">00:00:00</span>
                </div>
                <div class="mode-switch" id="modeSwitch" aria-label="Switch between light and dark mode">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="profile" id="profileContainer">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="profileImg">
                    <span class="notification-badge" id="notificationBadge">3</span>
                    
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-item" id="viewProfileBtn">
                            <i class="fas fa-user"></i>
                            <span>View Profile</span>
                        </div>
                        <div class="dropdown-item" id="switchModeBtn">
                            <i class="fas fa-moon"></i>
                            <span>Switch to Dark Mode</span>
                        </div>
                        <div class="dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                    
                    <!-- Notification Popup -->
                    <div class="notification-popup" id="notificationPopup">
                        <div class="notification-header">
                            Notifications
                        </div>
                        <div class="notification-list" id="notificationList">
                            <!-- Notifications will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="main-container">
            <!-- Task Summary Section -->
            <section class="summary-section">
                <div class="total-tasks-card">
                    <h3 class="card-title">Total Tasks</h3>
                    <p class="card-count" id="totalTasksCount">10</p>
                </div>
                <div class="summary-card completed-card">
                    <h3 class="card-title">Completed Tasks</h3>
                    <p class="card-count" id="completedTasksCount">3</p>
                </div>
                <div class="summary-card pending-card">
                    <h3 class="card-title">Pending Tasks</h3>
                    <p class="card-count" id="pendingTasksCount">7</p>
                </div>
            </section>
            
            <!-- Insights Section -->
            <section class="insights-section">
                <div class="insight-card">
                    <h3 class="card-title">Tasks by Category</h3>
                    <div id="categoryInsight">
                        Work: 5, Personal: 3, Other: 2
                    </div>
                </div>
                <div class="insight-card">
                    <h3 class="card-title">Tasks by Priority</h3>
                    <div id="priorityInsight">
                        High: 2, Medium: 4, Low: 4
                    </div>
                </div>
                <div class="insight-card">
                    <h3 class="card-title">Average Completion Time</h3>
                    <div id="timeInsight">
                        2h 35m
                    </div>
                </div>
            </section>
            
            <!-- Tasks Section -->
            <section class="tasks-section">
                <div class="tasks-header">
                    <h2 class="tasks-title">Tasks</h2>
                    <div class="tasks-actions">
                        <button class="btn btn-success" id="addTaskBtn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                        <button class="btn btn-primary" id="exportBtn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                        <button class="btn btn-primary" id="importBtn">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                    </div>
                </div>
                
                <!-- Task Filters -->
                <div class="filters-container">
                    <div class="filter-group">
                        <span class="filter-label">Status:</span>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Category:</span>
                        <select class="filter-select" id="categoryFilter">
                            <option value="all">All</option>
                            <!-- Categories will be populated here -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Priority:</span>
                        <select class="filter-select" id="priorityFilter">
                            <option value="all">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Due Date:</span>
                        <select class="filter-select" id="dueDateFilter">
                            <option value="all">All</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Sort By:</span>
                        <select class="filter-select" id="sortFilter">
                            <option value="dueDate-asc">Due Date (Earliest)</option>
                            <option value="dueDate-desc">Due Date (Latest)</option>
                            <option value="title-asc">Title (A-Z)</option>
                            <option value="title-desc">Title (Z-A)</option>
                            <option value="priority-asc">Priority (Low to High)</option>
                            <option value="priority-desc">Priority (High to Low)</option>
                        </select>
                    </div>
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search tasks...">
                    </div>
                </div>
                
                <!-- View Switcher -->
                <div class="view-switch">
                    <button class="view-btn active" data-view="list" id="listViewBtn">List View</button>
                    <button class="view-btn" data-view="graph" id="graphViewBtn">Graph View</button>
                </div>
                
                <!-- Task List View -->
                <div class="tasks-list" id="tasksListView">
                    <!-- Tasks will be populated here -->
                </div>
                
                <!-- Graph View -->
                <div class="graph-view" id="tasksGraphView">
                    <div class="graph-card">
                        <h3 class="card-title">Tasks Over Time</h3>
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                    <div class="graph-card">
                        <h3 class="card-title">Tasks Distribution</h3>
                        <div class="chart-container">
                            <canvas id="tasksPieChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Multi-Select Action Bar -->
                <div class="multi-select-bar" id="multiSelectBar">
                    <div class="multi-select-count">
                        <span id="selectedCount">0</span> tasks selected
                    </div>
                    <div class="multi-select-actions">
                        <button class="btn btn-success" id="markCompleteBtn">
                            <i class="fas fa-check"></i> Mark Complete
                        </button>
                        <button class="btn btn-danger" id="deleteSelectedBtn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn btn-gray" id="cancelSelectionBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Toast Notification Container -->
        <div class="toast-container" id="toastContainer">
            <!-- Toast notifications will be added here -->
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create Account</h3>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="regFirstName" class="form-label">First Name</label>
                    <input type="text" id="regFirstName" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regLastName" class="form-label">Last Name</label>
                    <input type="text" id="regLastName" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regEmail" class="form-label">Email</label>
                    <input type="email" id="regEmail" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regConfirmEmail" class="form-label">Confirm Email</label>
                    <input type="email" id="regConfirmEmail" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regPassword" class="form-label">Password</label>
                    <input type="password" id="regPassword" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regConfirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" id="regConfirmPassword" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regBirthdate" class="form-label">Birthdate</label>
                    <input type="text" id="regBirthdate" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="regNationality" class="form-label">Nationality</label>
                    <select id="regNationality" class="form-input" required>
                        <option value="">Select country</option>
                        <!-- Countries will be populated here -->
                    </select>
                </div>
                <div class="form-row">
                    <label for="regRole" class="form-label">Role</label>
                    <select id="regRole" class="form-input" required>
                        <option value="">Select role</option>
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="cancelRegisterBtn">Cancel</button>
                <button class="btn btn-success" id="createAccountBtn">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="taskModalTitle">Add New Task</h3>
                <button class="modal-close" id="closeTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="taskId">
                <div class="form-row">
                    <label for="taskTitle" class="form-label">Title</label>
                    <input type="text" id="taskTitle" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="taskDescription" class="form-label">Description</label>
                    <textarea id="taskDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <label class="form-label">Sub-Tasks</label>
                    <div class="subtasks-container" id="subtasksContainer">
                        <div class="subtask-item">
                            <input type="text" class="subtask-input" placeholder="Enter sub-task...">
                            <button class="remove-subtask-btn" aria-label="Remove sub-task">-</button>
                        </div>
                    </div>
                    <button class="add-subtask-btn" id="addSubtaskBtn" aria-label="Add sub-task">+</button>
                </div>
                <div class="form-row">
                    <label for="taskDueDate" class="form-label">Due Date</label>
                    <input type="text" id="taskDueDate" class="form-input" required>
                </div>
                <div class="form-row">
                    <label for="taskPriority" class="form-label">Priority</label>
                    <select id="taskPriority" class="form-input" required>
                        <option value="">Select priority</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="taskCategory" class="form-label">Category</label>
                    <select id="taskCategory" class="form-input" required>
                        <option value="">Select category</option>
                        <!-- Categories will be populated here -->
                    </select>
                </div>
                <div class="form-row">
                    <label for="taskNotes" class="form-label">Notes</label>
                    <textarea id="taskNotes" class="form-input" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="cancelTaskBtn">Cancel</button>
                <button class="btn btn-success" id="saveTaskBtn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- View Task Modal -->
    <div class="modal-overlay" id="viewTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="viewTaskTitle">Task Details</h3>
                <button class="modal-close" id="closeViewTaskModal">&times;</button>
            </div>
            <div class="modal-body" id="viewTaskContent">
                <!-- Task details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="editTaskFromViewBtn">Edit</button>
                <button class="btn btn-gray" id="closeViewTaskBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Tasks</h3>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="exportFormat" class="form-label">Select Format</label>
                    <select id="exportFormat" class="form-input">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="json">JSON</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Tasks</h3>
                <button class="modal-close" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="importFile" class="form-label">Upload JSON File</label>
                    <input type="file" id="importFile" class="form-input" accept=".json">
                </div>
                <div class="form-row">
                    <label for="importUrl" class="form-label">Or Import from URL</label>
                    <input type="url" id="importUrl" class="form-input" placeholder="https://example.com/tasks.json">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div class="modal-overlay" id="usersModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Users</h3>
                <button class="modal-close" id="closeUsersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="users-grid" id="usersGrid">
                    <!-- User cards will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="closeUsersBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Categories Modal -->
    <div class="modal-overlay" id="categoriesModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Manage Categories</h3>
                <button class="modal-close" id="closeCategoriesModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="newCategory" class="form-label">Add New Category</label>
                    <div class="subtask-item">
                        <input type="text" id="newCategory" class="subtask-input" placeholder="Enter category name...">
                        <button class="add-subtask-btn" id="addCategoryBtn" aria-label="Add category">+</button>
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label">Existing Categories</label>
                    <div id="categoriesList">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="closeCategoriesBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="profileModalTitle">User Profile</h3>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div style="text-align: center; margin-bottom: var(--spacing-md);">
                        <img id="profileImage" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" 
                             style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color);">
                        <div id="profileImageUpload" style="display: none; margin-top: var(--spacing-sm);">
                            <label for="profileImageInput" class="btn btn-primary" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Upload Photo
                            </label>
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>
                <div id="profileInfo">
                    <!-- Profile info will be populated here -->
                </div>
                <div id="profileForm" style="display: none;">
                    <div class="form-row">
                        <label for="profileFirstName" class="form-label">First Name</label>
                        <input type="text" id="profileFirstName" class="form-input">
                    </div>
                    <div class="form-row">
                        <label for="profileLastName" class="form-label">Last Name</label>
                        <input type="text" id="profileLastName" class="form-input">
                    </div>
                    <div class="form-row">
                        <label for="profileEmail" class="form-label">Email</label>
                        <input type="email" id="profileEmail" class="form-input">
                    </div>
                    <div class="form-row">
                        <label for="profilePhone" class="form-label">Phone</label>
                        <input type="tel" id="profilePhone" class="form-input">
                    </div>
                    <div class="form-row">
                        <label for="profileCountry" class="form-label">Country</label>
                        <select id="profileCountry" class="form-input">
                            <!-- Countries will be populated here -->
                        </select>
                    </div>
                    <div class="form-row">
                        <label for="profileRole" class="form-label">Role</label>
                        <select id="profileRole" class="form-input">
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="profileViewFooter">
                <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                <button class="btn btn-gray" id="closeProfileBtn">Close</button>
            </div>
            <div class="modal-footer" id="profileEditFooter" style="display: none;">
                <button class="btn btn-gray" id="cancelProfileBtn">Cancel</button>
                <button class="btn btn-success" id="saveProfileBtn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Share Task Modal -->
    <div class="modal-overlay" id="shareTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Task</h3>
                <button class="modal-close" id="closeShareModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label class="form-label">Share Link</label>
                    <input type="text" id="shareLink" class="form-input" readonly>
                </div>
                <div class="form-row" style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                    <button class="btn btn-primary" id="copyLinkBtn">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                    <button class="btn btn-primary" id="emailLinkBtn">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="closeShareBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Date Range Modal -->
    <div class="modal-overlay" id="dateRangeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Date Range</h3>
                <button class="modal-close" id="closeDateRangeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="text" id="startDate" class="form-input">
                </div>
                <div class="form-row">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="text" id="endDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-gray" id="cancelDateRangeBtn">Cancel</button>
                <button class="btn btn-primary" id="applyDateRangeBtn">Apply</button>
            </div>
        </div>
    </div>
    
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // Listen for changes in color scheme preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Utility Functions
        const $ = selector => document.querySelector(selector);
        const $$ = selector => document.querySelectorAll(selector);
        
        // Format time (for task timer)
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        // Format date
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        // Generate random ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Show toast notification
        function showToast(message, action = null, actionText = null) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let content = `<div class="toast-message">${message}</div>`;
            if (action && actionText) {
                content += `<button class="toast-action">${actionText}</button>`;
            }
            
            toast.innerHTML = content;
            $('#toastContainer').appendChild(toast);
            
            if (action && actionText) {
                toast.querySelector('.toast-action').addEventListener('click', action);
            }
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }
        
        // Show modal
        function showModal(modalId) {
            const modal = $(modalId);
            modal.classList.add('show');
        }
        
        // Hide modal
        function hideModal(modalId) {
            const modal = $(modalId);
            modal.classList.remove('show');
        }
        
        // Initialize Flatpickr date pickers
        function initDatePickers() {
            flatpickr("#regBirthdate", {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
            
            flatpickr("#taskDueDate", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            flatpickr("#startDate", {
                dateFormat: "Y-m-d"
            });
            
            flatpickr("#endDate", {
                dateFormat: "Y-m-d"
            });
        }
        
        // Initialize Data
        let categories = localStorage.getItem('categories') ? 
            JSON.parse(localStorage.getItem('categories')) : 
            ['Work', 'Personal', 'Shopping', 'Health', 'Finance'];
        
        let tasks = localStorage.getItem('tasks') ? 
            JSON.parse(localStorage.getItem('tasks')) : 
            generateInitialTasks();
        
        let users = localStorage.getItem('users') ? 
            JSON.parse(localStorage.getItem('users')) : 
            [];
        
        let notifications = localStorage.getItem('notifications') ? 
            JSON.parse(localStorage.getItem('notifications')) : 
            generateInitialNotifications();
        
        let currentUser = localStorage.getItem('currentUser') ? 
            JSON.parse(localStorage.getItem('currentUser')) : 
            null;
        
        // Timer variables
        let activeTaskId = null;
        let timerInterval = null;
        let timerRunning = false;
        let timerSeconds = 0;
        
        // Generate random initial tasks
        function generateInitialTasks() {
            const priorities = ['high', 'medium', 'low'];
            const categories = ['Work', 'Personal', 'Shopping', 'Health', 'Finance'];
            const titles = [
                'Complete project proposal', 
                'Schedule doctor appointment', 
                'Buy groceries', 
                'Review quarterly budget', 
                'Plan team meeting',
                'Submit expense report',
                'Prepare presentation slides',
                'Call client for feedback',
                'Update website content',
                'Organize files and documents'
            ];
            const descriptions = [
                'Need to finalize all requirements',
                'Annual checkup due',
                'Need milk, eggs, bread and vegetables',
                'Analyze Q3 expenses and forecast Q4',
                'Prepare agenda for Monday',
                'Include all receipts from business trip',
                'Create 10 slides with key metrics',
                'Follow up on project implementation',
                'Add new product pages and update blog',
                'Clean up digital and physical files'
            ];
            
            let initialTasks = [];
            
            for (let i = 0; i < 10; i++) {
                const task = {
                    id: generateId(),
                    title: titles[i],
                    description: descriptions[i],
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    category: categories[Math.floor(Math.random() * categories.length)],
                    dueDate: new Date(Date.now() + Math.floor(Math.random() * 15) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    completed: Math.random() > 0.7,
                    timeSpent: Math.floor(Math.random() * 7200),
                    subtasks: [],
                    notes: 'Additional notes here',
                    createdAt: new Date().toISOString(),
                    isActive: false,
                    order: i
                };
                
                // Add subtasks to some tasks
                if (i < 3) {
                    const numSubtasks = Math.floor(Math.random() * 2) + 2; // 2-3 subtasks
                    for (let j = 0; j < numSubtasks; j++) {
                        task.subtasks.push({
                            id: generateId(),
                            title: `Subtask ${j+1} for ${task.title}`,
                            completed: Math.random() > 0.5
                        });
                    }
                }
                
                initialTasks.push(task);
            }
            
            return initialTasks;
        }
        
        // Generate initial notifications
        function generateInitialNotifications() {
            return [
                {
                    id: generateId(),
                    message: 'Task "Review quarterly budget" is due today!',
                    timestamp: new Date().toISOString(),
                    read: false
                },
                {
                    id: generateId(),
                    message: 'Task "Complete project proposal" was completed',
                    timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                    read: false
                },
                {
                    id: generateId(),
                    message: 'New task "Buy groceries" was created',
                    timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    read: false
                }
            ];
        }
        
        // Generate or load random users
        async function loadRandomUsers() {
            if (users.length === 0) {
                try {
                    const response = await fetch('https://randomuser.me/api/?results=10');
                    const data = await response.json();
                    
                    users = data.results.map(user => {
                        return {
                            id: generateId(),
                            firstName: user.name.first,
                            lastName: user.name.last,
                            email: user.email,
                            picture: user.picture.large,
                            role: ['Manager', 'Staff', 'Customer', 'Admin'][Math.floor(Math.random() * 4)],
                            country: user.location.country,
                            phone: user.phone,
                            joinDate: new Date(Date.now() - Math.floor(Math.random() * 365) * 24 * 60 * 60 * 1000).toISOString()
                        };
                    });
                    
                    // Add default test user
                    users.push({
                        id: generateId(),
                        firstName: 'Test',
                        lastName: 'User',
                        email: 'test@example.com',
                        password: '123456',
                        picture: 'https://randomuser.me/api/portraits/men/1.jpg',
                        role: 'Admin',
                        country: 'United States',
                        phone: '555-123-4567',
                        joinDate: new Date().toISOString()
                    });
                    
                    localStorage.setItem('users', JSON.stringify(users));
                } catch (error) {
                    console.error('Error fetching random users:', error);
                    // Fallback to basic user data if API fails
                    users = generateFallbackUsers();
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }
            
            renderUsersGrid();
        }
        
        // Fallback user generation if API fails
        function generateFallbackUsers() {
            const fallbackUsers = [
                {
                    id: generateId(),
                    firstName: 'Test',
                    lastName: 'User',
                    email: 'test@example.com',
                    password: '123456',
                    picture: 'https://randomuser.me/api/portraits/men/1.jpg',
                    role: 'Admin',
                    country: 'United States',
                    phone: '555-123-4567',
                    joinDate: new Date().toISOString()
                }
            ];
            
            // Generate 9 more random users
            for (let i = 0; i < 9; i++) {
                const gender = Math.random() > 0.5 ? 'men' : 'women';
                const id = Math.floor(Math.random() * 100);
                
                fallbackUsers.push({
                    id: generateId(),
                    firstName: `User`,
                    lastName: `${i+1}`,
                    email: `user${i+1}@example.com`,
                    picture: `https://randomuser.me/api/portraits/${gender}/${id}.jpg`,
                    role: ['Manager', 'Staff', 'Customer', 'Admin'][Math.floor(Math.random() * 4)],
                    country: 'United States',
                    phone: `555-${100+i}-${1000+i}`,
                    joinDate: new Date(Date.now() - Math.floor(Math.random() * 365) * 24 * 60 * 60 * 1000).toISOString()
                });
            }
            
            return fallbackUsers;
        }
        
        // Load countries for dropdowns
        async function loadCountries() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name');
                const countries = await response.json();
                
                // Sort countries by name
                countries.sort((a, b) => {
                    return a.name.common.localeCompare(b.name.common);
                });
                
                // Populate nationality dropdown in registration form
                const nationalitySelect = $('#regNationality');
                nationalitySelect.innerHTML = '<option value="">Select country</option>';
                
                // Populate country dropdown in profile edit form
                const profileCountrySelect = $('#profileCountry');
                profileCountrySelect.innerHTML = '<option value="">Select country</option>';
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.name.common;
                    option.textContent = country.name.common;
                    
                    const optionClone = option.cloneNode(true);
                    
                    nationalitySelect.appendChild(option);
                    profileCountrySelect.appendChild(optionClone);
                });
            } catch (error) {
                console.error('Error loading countries:', error);
                // Fallback to a smaller list if API fails
                const fallbackCountries = [
                    'United States', 'Canada', 'United Kingdom', 'Australia', 
                    'Germany', 'France', 'Japan', 'Brazil', 'India', 'China'
                ];
                
                const nationalitySelect = $('#regNationality');
                nationalitySelect.innerHTML = '<option value="">Select country</option>';
                
                const profileCountrySelect = $('#profileCountry');
                profileCountrySelect.innerHTML = '<option value="">Select country</option>';
                
                fallbackCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    
                    const optionClone = option.cloneNode(true);
                    
                    nationalitySelect.appendChild(option);
                    profileCountrySelect.appendChild(optionClone);
                });
            }
        }
        
        // Render Categories
        function renderCategories() {
            // Populate category filter
            const categoryFilter = $('#categoryFilter');
            categoryFilter.innerHTML = '<option value="all">All</option>';
            
            // Populate task category dropdown
            const taskCategory = $('#taskCategory');
            taskCategory.innerHTML = '<option value="">Select category</option>';
            
            categories.forEach(category => {
                const filterOption = document.createElement('option');
                filterOption.value = category.toLowerCase();
                filterOption.textContent = category;
                categoryFilter.appendChild(filterOption);
                
                const taskOption = document.createElement('option');
                taskOption.value = category;
                taskOption.textContent = category;
                taskCategory.appendChild(taskOption);
            });
            
            // Render categories list in categories modal
            const categoriesList = $('#categoriesList');
            categoriesList.innerHTML = '';
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'subtask-item';
                categoryItem.innerHTML = `
                    <input type="text" class="subtask-input" value="${category}" data-original="${category}">
                    <button class="btn-edit category-edit" data-category="${category}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-delete category-delete" data-category="${category}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                categoriesList.appendChild(categoryItem);
            });
            
            // Add event listeners to category edit and delete buttons
            $$('.category-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const categoryItem = this.parentElement;
                    const input = categoryItem.querySelector('input');
                    const originalValue = input.dataset.original;
                    const newValue = input.value.trim();
                    
                    if (!newValue) {
                        showToast('Category name cannot be empty');
                        input.value = originalValue;
                        return;
                    }
                    
                    if (newValue !== originalValue) {
                        if (categories.includes(newValue)) {
                            showToast('Category already exists');
                            input.value = originalValue;
                            return;
                        }
                        
                        // Update category in array
                        const index = categories.indexOf(originalValue);
                        categories[index] = newValue;
                        
                        // Update category in tasks
                        tasks.forEach(task => {
                            if (task.category === originalValue) {
                                task.category = newValue;
                            }
                        });
                        
                        // Save updated categories and tasks
                        localStorage.setItem('categories', JSON.stringify(categories));
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        
                        // Update UI
                        renderCategories();
                        renderTasks();
                        updateInsights();
                        
                        showToast(`Category "${originalValue}" renamed to "${newValue}"`);
                    }
                });
            });
            
            $$('.category-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // Check if category is used in tasks
                    const tasksWithCategory = tasks.filter(task => task.category === category);
                    
                    if (tasksWithCategory.length > 0) {
                        showToast(`Cannot delete category "${category}" as it is used in ${tasksWithCategory.length} task(s)`);
                        return;
                    }
                    
                    // Remove category from array
                    categories = categories.filter(c => c !== category);
                    
                    // Save updated categories
                    localStorage.setItem('categories', JSON.stringify(categories));
                    
                    // Update UI
                    renderCategories();
                    updateInsights();
                    
                    showToast(`Category "${category}" deleted`);
                });
            });
        }
        
        // Add new category
        function addCategory(categoryName) {
            categoryName = categoryName.trim();
            
            if (!categoryName) {
                showToast('Category name cannot be empty');
                return false;
            }
            
            if (categories.includes(categoryName)) {
                showToast('Category already exists');
                return false;
            }
            
            categories.push(categoryName);
            localStorage.setItem('categories', JSON.stringify(categories));
            
            renderCategories();
            showToast(`Category "${categoryName}" added`);
            return true;
        }
        
        // Render Tasks
        function renderTasks() {
            // Get filter values
            const statusFilter = $('#statusFilter').value;
            const categoryFilter = $('#categoryFilter').value;
            const priorityFilter = $('#priorityFilter').value;
            const dueDateFilter = $('#dueDateFilter').value;
            const searchInput = $('#searchInput').value.toLowerCase();
            const sortOption = $('#sortFilter').value;
            
            // Filter tasks
            let filteredTasks = [...tasks];
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    return statusFilter === 'completed' ? task.completed : !task.completed;
                });
            }
            
            // Apply category filter
            if (categoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    return task.category.toLowerCase() === categoryFilter;
                });
            }
            
            // Apply priority filter
            if (priorityFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    return task.priority === priorityFilter;
                });
            }
            
            // Apply due date filter
            if (dueDateFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayStr = today.toISOString().split('T')[0];
                
                if (dueDateFilter === 'today') {
                    filteredTasks = filteredTasks.filter(task => task.dueDate === todayStr);
                } else if (dueDateFilter === 'week') {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(today.getDate() + 7);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= today && dueDate <= weekEnd;
                    });
                } else if (dueDateFilter === 'month') {
                    const monthEnd = new Date(today);
                    monthEnd.setMonth(today.getMonth() + 1);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= today && dueDate <= monthEnd;
                    });
                } else if (dueDateFilter === 'custom' && customDateRange) {
                    const startDate = new Date(customDateRange.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    
                    const endDate = new Date(customDateRange.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= startDate && dueDate <= endDate;
                    });
                }
            }
            
            // Apply search filter
            if (searchInput) {
                filteredTasks = filteredTasks.filter(task => {
                    return (
                        task.title.toLowerCase().includes(searchInput) ||
                        task.description.toLowerCase().includes(searchInput) ||
                        task.category.toLowerCase().includes(searchInput)
                    );
                });
            }
            
            // Sort tasks
            const [sortField, sortDirection] = sortOption.split('-');
            
            filteredTasks.sort((a, b) => {
                if (sortField === 'dueDate') {
                    const dateA = new Date(a.dueDate);
                    const dateB = new Date(b.dueDate);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                } else if (sortField === 'title') {
                    return sortDirection === 'asc' 
                        ? a.title.localeCompare(b.title) 
                        : b.title.localeCompare(a.title);
                } else if (sortField === 'priority') {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    const priorityA = priorityOrder[a.priority] || 0;
                    const priorityB = priorityOrder[b.priority] || 0;
                    return sortDirection === 'asc' 
                        ? priorityA - priorityB 
                        : priorityB - priorityA;
                }
                
                // Default sort by order property (for drag and drop)
                return a.order - b.order;
            });
            
            // Render tasks
            const tasksListView = $('#tasksListView');
            tasksListView.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                tasksListView.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl);">
                        <i class="fas fa-tasks" style="font-size: 48px; color: var(--gray-color); margin-bottom: var(--spacing-md);"></i>
                        <p>No tasks found. Try changing your filters or add a new task.</p>
                    </div>
                `;
                return;
            }
            
            filteredTasks.forEach(task => {
                const now = new Date();
                const dueDate = new Date(task.dueDate);
                const hoursRemaining = Math.floor((dueDate - now) / (1000 * 60 * 60));
                
                let statusClass = '';
                if (task.completed) {
                    statusClass = 'completed';
                } else if (hoursRemaining < 0) {
                    statusClass = 'expired';
                } else if (hoursRemaining < 48) {
                    statusClass = 'due-soon';
                }
                
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${statusClass}`;
                taskElement.draggable = true;
                taskElement.dataset.id = task.id;
                
                taskElement.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} aria-label="Mark task as complete">
                    <div class="task-content">
                        <div class="task-header">
                            <h3 class="task-title">${task.title}</h3>
                            <span class="priority-badge priority-${task.priority}">
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </span>
                        </div>
                        <div class="task-details">
                            <p class="task-description">${task.description}</p>
                            <div class="task-meta">
                                <div class="task-due">
                                    <i class="far fa-calendar-alt"></i>
                                    <span>${formatDate(task.dueDate)}</span>
                                    ${hoursRemaining < 0 ? '<span style="color: var(--danger-color);"> (Expired)</span>' : 
                                     hoursRemaining < 48 ? '<span style="color: var(--warning-color);"> (Due soon)</span>' : ''}
                                </div>
                                <div class="task-category">
                                    <i class="fas fa-tag"></i>
                                    <span>${task.category}</span>
                                </div>
                                <div class="task-timer-display">
                                    <i class="far fa-clock"></i>
                                    <span>${formatTime(task.timeSpent)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="action-btn btn-view" data-id="${task.id}" aria-label="View task details">
                                <i class="far fa-eye"></i>
                            </button>
                            <button class="action-btn btn-edit" data-id="${task.id}" aria-label="Edit task">
                                <i class="far fa-edit"></i>
                            </button>
                            <button class="action-btn btn-delete" data-id="${task.id}" aria-label="Delete task">
                                <i class="far fa-trash-alt"></i>
                            </button>
                            <button class="action-btn ${task.isActive ? 'btn-pause' : 'btn-play'}" data-id="${task.id}" aria-label="${task.isActive ? 'Pause timer' : 'Start timer'}">
                                <i class="fas ${task.isActive ? 'fa-pause' : 'fa-play'}"></i>
                            </button>
                            <button class="action-btn btn-share" data-id="${task.id}" aria-label="Share task">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                tasksListView.appendChild(taskElement);
            });
            
            // Add event listeners to task items
            addTaskEventListeners();
            
            // Update summary counts
            updateSummary();
        }
        
        // Add event listeners to task items
        function addTaskEventListeners() {
            // Task checkboxes
            $$('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const taskItem = this.closest('.task-item');
                    const taskId = taskItem.dataset.id;
                    const task = tasks.find(t => t.id === taskId);
                    
                    task.completed = this.checked;
                    
                    if (this.checked) {
                        taskItem.classList.add('completed');
                        taskItem.classList.remove('expired', 'due-soon');
                        
                        // Add notification for task completion
                        addNotification(`Task "${task.title}" completed`);
                    } else {
                        taskItem.classList.remove('completed');
                        
                        // Check if task is expired or due soon
                        const now = new Date();
                        const dueDate = new Date(task.dueDate);
                        const hoursRemaining = Math.floor((dueDate - now) / (1000 * 60 * 60));
                        
                        if (hoursRemaining < 0) {
                            taskItem.classList.add('expired');
                        } else if (hoursRemaining < 48) {
                            taskItem.classList.add('due-soon');
                        }
                    }
                    
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    updateSummary();
                    updateInsights();
                    renderGraphs();
                });
            });
            
            // View task button
            $$('.btn-view').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.id;
                    viewTask(taskId);
                });
            });
            
            // Edit task button
            $$('.btn-edit').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.id;
                    editTask(taskId);
                });
            });
            
            // Delete task button
            $$('.btn-delete').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.id;
                    deleteTask(taskId);
                });
            });
            
            // Play/Pause task button
            $$('.btn-play, .btn-pause').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.id;
                    toggleTaskTimer(taskId);
                });
            });
            
            // Share task button
            $$('.btn-share').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.dataset.id;
                    shareTask(taskId);
                });
            });
            
            // Drag and drop functionality
            $$('.task-item').forEach(item => {
                // Drag start
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                    item.classList.add('dragging');
                });
                
                // Drag end
                item.addEventListener('dragend', function() {
                    item.classList.remove('dragging');
                });
                
                // Drag over
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const draggingElement = document.querySelector('.dragging');
                    
                    if (draggingElement !== this) {
                        const rect = item.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        
                        if (y < rect.height / 2) {
                            // Insert before
                            item.classList.add('drag-above');
                            item.classList.remove('drag-below');
                        } else {
                            // Insert after
                            item.classList.add('drag-below');
                            item.classList.remove('drag-above');
                        }
                    }
                });
                
                // Drag leave
                item.addEventListener('dragleave', function() {
                    item.classList.remove('drag-above', 'drag-below');
                });
                
                // Drop
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    const draggingId = e.dataTransfer.getData('text/plain');
                    const targetId = item.dataset.id;
                    
                    if (draggingId === targetId) {
                        return;
                    }
                    
                    const draggedTask = tasks.find(t => t.id === draggingId);
                    const targetTask = tasks.find(t => t.id === targetId);
                    
                    // Get all task elements to determine new order
                    const taskElements = Array.from($$('.task-item'));
                    const draggedIndex = taskElements.findIndex(el => el.dataset.id === draggingId);
                    const targetIndex = taskElements.findIndex(el => el.dataset.id === targetId);
                    
                    // Remove dragged task from array
                    tasks = tasks.filter(t => t.id !== draggingId);
                    
                    // Determine insert position based on drag position
                    let insertIndex = tasks.findIndex(t => t.id === targetId);
                    if (item.classList.contains('drag-below')) {
                        insertIndex++;
                    }
                    
                    // Insert task at new position
                    tasks.splice(insertIndex, 0, draggedTask);
                    
                    // Update order property for all tasks
                    tasks.forEach((task, index) => {
                        task.order = index;
                    });
                    
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    renderTasks();
                    
                    item.classList.remove('drag-above', 'drag-below');
                });
            });
        }
        
        // View task details
        function viewTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Set task title
            $('#viewTaskTitle').textContent = task.title;
            
            // Populate task content
            const viewTaskContent = $('#viewTaskContent');
            
            let subtasksHtml = '';
            if (task.subtasks && task.subtasks.length > 0) {
                subtasksHtml = `
                    <div class="form-row">
                        <label class="form-label">Sub-Tasks</label>
                        <ul style="margin-left: var(--spacing-md);">
                            ${task.subtasks.map(subtask => `
                                <li>
                                    <span style="${subtask.completed ? 'text-decoration: line-through;' : ''}">
                                        ${subtask.title}
                                    </span>
                                    ${subtask.completed ? ' ' : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            viewTaskContent.innerHTML = `
                <div class="form-row">
                    <label class="form-label">Description</label>
                    <p>${task.description || 'No description provided'}</p>
                </div>
                ${subtasksHtml}
                <div class="form-row">
                    <label class="form-label">Due Date</label>
                    <p>${formatDate(task.dueDate)}</p>
                </div>
                <div class="form-row">
                    <label class="form-label">Priority</label>
                    <p>
                        <span class="priority-badge priority-${task.priority}">
                            ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                        </span>
                    </p>
                </div>
                <div class="form-row">
                    <label class="form-label">Category</label>
                    <p>${task.category}</p>
                </div>
                <div class="form-row">
                    <label class="form-label">Status</label>
                    <p>${task.completed ? 'Completed' : 'Pending'}</p>
                </div>
                <div class="form-row">
                    <label class="form-label">Time Spent</label>
                    <p>${formatTime(task.timeSpent)}</p>
                </div>
                ${task.notes ? `
                    <div class="form-row">
                        <label class="form-label">Notes</label>
                        <p>${task.notes}</p>
                    </div>
                ` : ''}
                <div class="form-row">
                    <label class="form-label">Created At</label>
                    <p>${formatDate(task.createdAt)}</p>
                </div>
            `;
            
            // Add event listener to edit button
            $('#editTaskFromViewBtn').onclick = () => {
                hideModal('#viewTaskModal');
                editTask(taskId);
            };
            
            // Show modal
            showModal('#viewTaskModal');
        }
        
        // Edit task
        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Set modal title and task ID
            $('#taskModalTitle').textContent = 'Edit Task';
            $('#taskId').value = taskId;
            
            // Populate form fields
            $('#taskTitle').value = task.title;
            $('#taskDescription').value = task.description || '';
            $('#taskDueDate').value = task.dueDate;
            $('#taskPriority').value = task.priority;
            $('#taskCategory').value = task.category;
            $('#taskNotes').value = task.notes || '';
            
            // Populate subtasks
            const subtasksContainer = $('#subtasksContainer');
            subtasksContainer.innerHTML = '';
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const subtaskItem = document.createElement('div');
                    subtaskItem.className = 'subtask-item';
                    subtaskItem.innerHTML = `
                        <input type="text" class="subtask-input" value="${subtask.title}" 
                               data-id="${subtask.id}" data-completed="${subtask.completed}">
                        <button class="remove-subtask-btn" aria-label="Remove sub-task">-</button>
                    `;
                    subtasksContainer.appendChild(subtaskItem);
                });
            } else {
                // Add one empty subtask field
                const subtaskItem = document.createElement('div');
                subtaskItem.className = 'subtask-item';
                subtaskItem.innerHTML = `
                    <input type="text" class="subtask-input" placeholder="Enter sub-task...">
                    <button class="remove-subtask-btn" aria-label="Remove sub-task">-</button>
                `;
                subtasksContainer.appendChild(subtaskItem);
            }
            
            // Add event listeners to remove subtask buttons
            $$('.remove-subtask-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (subtasksContainer.children.length > 1) {
                        this.parentElement.remove();
                    } else {
                        this.previousElementSibling.value = '';
                    }
                });
            });
            
            // Show modal
            showModal('#taskModal');
        }
        
        // Add new task
        function addNewTask() {
            // Clear form fields
            $('#taskModalTitle').textContent = 'Add New Task';
            $('#taskId').value = '';
            $('#taskTitle').value = '';
            $('#taskDescription').value = '';
            $('#taskDueDate').value = '';
            $('#taskPriority').value = '';
            $('#taskCategory').value = '';
            $('#taskNotes').value = '';
            
            // Reset subtasks
            const subtasksContainer = $('#subtasksContainer');
            subtasksContainer.innerHTML = `
                <div class="subtask-item">
                    <input type="text" class="subtask-input" placeholder="Enter sub-task...">
                    <button class="remove-subtask-btn" aria-label="Remove sub-task">-</button>
                </div>
            `;
            
            // Add event listener to remove subtask button
            $('.remove-subtask-btn').addEventListener('click', function() {
                this.previousElementSibling.value = '';
            });
            
            // Show modal
            showModal('#taskModal');
        }
        
        // Save task (add or update)
        function saveTask() {
            const taskId = $('#taskId').value;
            const title = $('#taskTitle').value.trim();
            const description = $('#taskDescription').value.trim();
            const dueDate = $('#taskDueDate').value;
            const priority = $('#taskPriority').value;
            const category = $('#taskCategory').value;
            const notes = $('#taskNotes').value.trim();
            
            // Validate required fields
            if (!title || !dueDate || !priority || !category) {
                showToast('Please fill in all required fields');
                return;
            }
            
            // Get subtasks
            const subtaskInputs = $$('#subtasksContainer .subtask-input');
            let subtasks = [];
            
            subtaskInputs.forEach(input => {
                const subtaskTitle = input.value.trim();
                
                if (subtaskTitle) {
                    const subtask = {
                        id: input.dataset.id || generateId(),
                        title: subtaskTitle,
                        completed: input.dataset.completed === 'true'
                    };
                    
                    subtasks.push(subtask);
                }
            });
            
            if (taskId) {
                // Update existing task
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    task.title = title;
                    task.description = description;
                    task.dueDate = dueDate;
                    task.priority = priority;
                    task.category = category;
                    task.notes = notes;
                    task.subtasks = subtasks;
                    
                    // Add notification for task update
                    addNotification(`Task "${title}" updated`);
                }
            } else {
                // Add new task
                const newTask = {
                    id: generateId(),
                    title,
                    description,
                    dueDate,
                    priority,
                    category,
                    notes,
                    subtasks,
                    completed: false,
                    timeSpent: 0,
                    createdAt: new Date().toISOString(),
                    isActive: false,
                    order: tasks.length
                };
                
                tasks.push(newTask);
                
                // Add notification for new task
                addNotification(`New task "${title}" created`);
            }
            
            // Save tasks to localStorage
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // Update UI
            renderTasks();
            updateInsights();
            renderGraphs();
            
            // Hide modal
            hideModal('#taskModal');
        }
        
        // Delete task
        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Store task details for undo functionality
            const deletedTask = { ...task };
            
            // Remove task from tasks array
            tasks = tasks.filter(t => t.id !== taskId);
            
            // Update localStorage
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            // Update UI
            renderTasks();
            updateInsights();
            renderGraphs();
            
            // Show toast with undo option
            showToast(`Task "${deletedTask.title}" deleted`, () => {
                // Restore task
                tasks.push(deletedTask);
                
                // Update localStorage
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                // Update UI
                renderTasks();
                updateInsights();
                renderGraphs();
                
                // Show confirmation
                showToast(`Task "${deletedTask.title}" restored`);
            }, 'Undo');
            
            // Add notification for task deletion
            addNotification(`Task "${deletedTask.title}" deleted`);
        }
        
        // Toggle task timer
        function toggleTaskTimer(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // If another task is active, pause it first
            if (activeTaskId && activeTaskId !== taskId) {
                const activeTask = tasks.find(t => t.id === activeTaskId);
                
                if (activeTask) {
                    activeTask.isActive = false;
                    
                    // Show toast for paused task
                    showToast(`Task "${activeTask.title}" paused after ${formatTime(activeTask.timeSpent)}`);
                }
                
                clearInterval(timerInterval);
                timerInterval = null;
                timerRunning = false;
            }
            
            // Toggle timer for current task
            task.isActive = !task.isActive;
            
            if (task.isActive) {
                // Start timer
                activeTaskId = taskId;
                timerRunning = true;
                
                // Update UI button
                const button = $(`.task-item[data-id="${taskId}"] .btn-play`);
                button.classList.remove('btn-play');
                button.classList.add('btn-pause');
                button.querySelector('i').classList.remove('fa-play');
                button.querySelector('i').classList.add('fa-pause');
                button.setAttribute('aria-label', 'Pause timer');
                
                // Start interval to update time spent
                timerInterval = setInterval(() => {
                    task.timeSpent++;
                    timerSeconds++;
                    
                    // Update timer display
                    $('#timerDisplay').textContent = formatTime(timerSeconds);
                    
                    // Update task timer display
                    const timerDisplay = $(`.task-item[data-id="${taskId}"] .task-timer-display span`);
                    if (timerDisplay) {
                        timerDisplay.textContent = formatTime(task.timeSpent);
                    }
                    
                    // Save tasks to localStorage
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    
                    // Every minute, update insights
                    if (task.timeSpent % 60 === 0) {
                        updateInsights();
                    }
                }, 1000);
                
                // Update play/pause button in header
                $('#timerPlayPause i').classList.remove('fa-play');
                $('#timerPlayPause i').classList.add('fa-pause');
                
                // Show toast for started task
                showToast(`Timer started for "${task.title}"`);
            } else {
                // Pause timer
                activeTaskId = null;
                timerRunning = false;
                
                // Update UI button
                const button = $(`.task-item[data-id="${taskId}"] .btn-pause`);
                button.classList.remove('btn-pause');
                button.classList.add('btn-play');
                button.querySelector('i').classList.remove('fa-pause');
                button.querySelector('i').classList.add('fa-play');
                button.setAttribute('aria-label', 'Start timer');
                
                // Clear interval
                clearInterval(timerInterval);
                timerInterval = null;
                
                // Update play/pause button in header
                $('#timerPlayPause i').classList.remove('fa-pause');
                $('#timerPlayPause i').classList.add('fa-play');
                
                // Show toast for paused task
                showToast(`Task "${task.title}" paused after ${formatTime(task.timeSpent)}`);
            }
            
            // Save tasks to localStorage
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        // Share task
        function shareTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Generate share link (just a placeholder in this demo)
            const shareLink = `https://todo.app/share/${taskId}`;
            
            // Set share link input value
            $('#shareLink').value = shareLink;
            
            // Show share modal
            showModal('#shareTaskModal');
        }
        
        // Update summary counts
        function updateSummary() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            const pendingTasks = totalTasks - completedTasks;
            
            $('#totalTasksCount').textContent = totalTasks;
            $('#completedTasksCount').textContent = completedTasks;
            $('#pendingTasksCount').textContent = pendingTasks;
        }
        
        // Update insights
        function updateInsights() {
            // Tasks by category
            const tasksByCategory = {};
            categories.forEach(category => {
                tasksByCategory[category] = 0;
            });
            
            tasks.forEach(task => {
                if (tasksByCategory[task.category] !== undefined) {
                    tasksByCategory[task.category]++;
                }
            });
            
            let categoryInsightText = Object.entries(tasksByCategory)
                .filter(([category, count]) => count > 0)
                .map(([category, count]) => `${category}: ${count}`)
                .join(', ');
            
            if (!categoryInsightText) {
                categoryInsightText = 'No tasks yet';
            }
            
            $('#categoryInsight').textContent = categoryInsightText;
            
            // Tasks by priority
            const tasksByPriority = {
                high: 0,
                medium: 0,
                low: 0
            };
            
            tasks.forEach(task => {
                tasksByPriority[task.priority]++;
            });
            
            let priorityInsightText = Object.entries(tasksByPriority)
                .filter(([priority, count]) => count > 0)
                .map(([priority, count]) => `${priority.charAt(0).toUpperCase() + priority.slice(1)}: ${count}`)
                .join(', ');
            
            if (!priorityInsightText) {
                priorityInsightText = 'No tasks yet';
            }
            
            $('#priorityInsight').textContent = priorityInsightText;
            
            // Average completion time
            const completedTasks = tasks.filter(task => task.completed);
            
            if (completedTasks.length > 0) {
                const totalTime = completedTasks.reduce((sum, task) => sum + task.timeSpent, 0);
                const averageTime = Math.floor(totalTime / completedTasks.length);
                
                $('#timeInsight').textContent = formatTime(averageTime);
            } else {
                $('#timeInsight').textContent = 'No completed tasks yet';
            }
        }
        
        // Render Graph View
        function renderGraphs() {
            // Destroy existing charts if they exist
            if (window.tasksChart) {
                window.tasksChart.destroy();
            }
            
            if (window.tasksPieChart) {
                window.tasksPieChart.destroy();
            }
            
            // Create line chart for tasks over time
            const tasksCtx = $('#tasksChart').getContext('2d');
            
            // Get dates for last 7 days
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            
            // Count completed and pending tasks by date
            const completedByDate = {};
            const pendingByDate = {};
            
            dates.forEach(date => {
                completedByDate[date] = 0;
                pendingByDate[date] = 0;
            });
            
            tasks.forEach(task => {
                // Use created date for this demo
                const taskDate = new Date(task.createdAt).toISOString().split('T')[0];
                
                if (dates.includes(taskDate)) {
                    if (task.completed) {
                        completedByDate[taskDate]++;
                    } else {
                        pendingByDate[taskDate]++;
                    }
                }
            });
            
            // Format dates for display
            const formattedDates = dates.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            
            // Create line chart
            window.tasksChart = new Chart(tasksCtx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: [
                        {
                            label: 'Completed',
                            data: dates.map(date => completedByDate[date]),
                            borderColor: '#28A745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Pending',
                            data: dates.map(date => pendingByDate[date]),
                            borderColor: '#FFC107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Create pie chart for task distribution
            const pieCtx = $('#tasksPieChart').getContext('2d');
            
            const completedTasks = tasks.filter(t => t.completed).length;
            const pendingTasks = tasks.length - completedTasks;
            
            window.tasksPieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completedTasks, pendingTasks],
                        backgroundColor: ['#28A745', '#FFC107'],
                        borderColor: ['#28A745', '#FFC107'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
        
        // Render User Cards in Users Modal
        function renderUsersGrid() {
            const usersGrid = $('#usersGrid');
            usersGrid.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <img src="${user.picture}" alt="${user.firstName} ${user.lastName}" class="user-avatar">
                    <div class="user-name">${user.firstName} ${user.lastName}</div>
                    <div class="user-email">${user.email}</div>
                    <div class="user-role">${user.role}</div>
                `;
                usersGrid.appendChild(userCard);
            });
        }
        
        // Add notification
        function addNotification(message) {
            const notification = {
                id: generateId(),
                message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            
            // Limit to 20 notifications
            if (notifications.length > 20) {
                notifications.pop();
            }
            
            // Update localStorage
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update notification badge
            updateNotificationBadge();
            
            // Render notifications if popup is open
            if ($('#notificationPopup').classList.contains('show')) {
                renderNotifications();
            }
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            
            const badge = $('#notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Render notifications in popup
        function renderNotifications() {
            const notificationList = $('#notificationList');
            notificationList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-md);">
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }
            
            notifications.forEach(notification => {
                const notificationTime = new Date(notification.timestamp);
                const timeAgo = getTimeAgo(notificationTime);
                
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationItem.dataset.id = notification.id;
                
                notificationItem.innerHTML = `
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${timeAgo}</div>
                `;
                
                notificationList.appendChild(notificationItem);
            });
            
            // Add event listeners to notification items
            $$('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const notificationId = this.dataset.id;
                    const notification = notifications.find(n => n.id === notificationId);
                    
                    if (notification && !notification.read) {
                        notification.read = true;
                        
                        // Update localStorage
                        localStorage.setItem('notifications', JSON.stringify(notifications));
                        
                        // Update UI
                        this.classList.remove('unread');
                        updateNotificationBadge();
                    }
                });
            });
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return '1 day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return '1 minute ago';
            
            return 'just now';
        }
        
        // Export tasks
        function exportTasks(format) {
            if (format === 'pdf') {
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text('Tasks List', 14, 22);
                
                doc.setFontSize(11);
                doc.setTextColor(100);
                
                let y = 30;
                tasks.forEach((task, index) => {
                    // Check if new page needed
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${task.title} ${task.completed ? '(Completed)' : ''}`, 14, y);
                    y += 7;
                    
                    doc.setFont(undefined, 'normal');
                    
                    if (task.description) {
                        doc.text(`Description: ${task.description}`, 18, y);
                        y += 7;
                    }
                    
                    doc.text(`Due: ${formatDate(task.dueDate)} | Priority: ${task.priority} | Category: ${task.category}`, 18, y);
                    y += 7;
                    
                    if (task.subtasks && task.subtasks.length > 0) {
                        doc.text('Subtasks:', 18, y);
                        y += 7;
                        
                        task.subtasks.forEach(subtask => {
                            doc.text(`- ${subtask.title} ${subtask.completed ? '(Completed)' : ''}`, 22, y);
                            y += 7;
                        });
                    }
                    
                    // Add some space between tasks
                    y += 5;
                });
                
                // Display the PDF in a new tab - in a real app, this would trigger a download
                // doc.save('tasks.pdf');
                // For this demo, we'll open the PDF in a new tab
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                window.open(pdfUrl, '_blank');
                
                showToast('PDF generated! Your browser should show a preview (right-click to save)');
            } else if (format === 'excel') {
                // Generate Excel using XLSX
                const worksheet = XLSX.utils.json_to_sheet(tasks.map(task => {
                    return {
                        Title: task.title,
                        Description: task.description,
                        'Due Date': formatDate(task.dueDate),
                        Priority: task.priority,
                        Category: task.category,
                        Status: task.completed ? 'Completed' : 'Pending',
                        'Time Spent': formatTime(task.timeSpent),
                        'Created At': formatDate(task.createdAt)
                    };
                }));
                
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
                
                // Generate Excel file and open in new tab
                const excelData = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const excelBlob = new Blob([excelData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const excelUrl = URL.createObjectURL(excelBlob);
                window.open(excelUrl, '_blank');
                
                showToast('Excel file generated! Your browser should show a preview (right-click to save)');
            } else if (format === 'json') {
                // Generate JSON string
                const jsonData = JSON.stringify(tasks, null, 2);
                
                // Create blob and download
                const jsonBlob = new Blob([jsonData], { type: 'application/json' });
                const jsonUrl = URL.createObjectURL(jsonBlob);
                window.open(jsonUrl, '_blank');
                
                showToast('JSON file generated! Your browser should show a preview (right-click to save)');
            }
        }
        
        // Import tasks from JSON
        function importTasks(jsonData) {
            try {
                const importedTasks = JSON.parse(jsonData);
                
                if (!Array.isArray(importedTasks)) {
                    showToast('Invalid JSON format. Expected an array of tasks.');
                    return;
                }
                
                // Validate tasks structure
                const validTasks = importedTasks.filter(task => {
                    return (
                        task && 
                        typeof task === 'object' &&
                        task.title && 
                        task.dueDate && 
                        task.priority && 
                        task.category
                    );
                });
                
                if (validTasks.length === 0) {
                    showToast('No valid tasks found in the imported data.');
                    return;
                }
                
                if (validTasks.length < importedTasks.length) {
                    showToast(`Imported ${validTasks.length} out of ${importedTasks.length} tasks. Some tasks were invalid.`);
                }
                
                // Generate new IDs for imported tasks to avoid conflicts
                const newTasks = validTasks.map(task => {
                    return {
                        ...task,
                        id: generateId(),
                        order: tasks.length + validTasks.indexOf(task)
                    };
                });
                
                // Add new tasks to existing tasks
                tasks = [...tasks, ...newTasks];
                
                // Save to localStorage
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                // Update UI
                renderTasks();
                updateSummary();
                updateInsights();
                renderGraphs();
                
                showToast(`Successfully imported ${newTasks.length} tasks`);
                
                // Add notification
                addNotification(`Imported ${newTasks.length} tasks`);
            } catch (error) {
                console.error('Error importing tasks:', error);
                showToast('Error importing tasks. Invalid JSON format.');
            }
        }
        
        // Initialize the app
        function init() {
            // Initialize date pickers
            initDatePickers();
            
            // Load countries for select dropdowns
            loadCountries();
            
            // Load random users
            loadRandomUsers();
            
            // Render categories
            renderCategories();
            
            // Render tasks
            renderTasks();
            
            // Update insights
            updateSummary();
            updateInsights();
            
            // Update notification badge
            updateNotificationBadge();
            
            // Restore timer state if there's an active task
            const activeTask = tasks.find(task => task.isActive);
            
            if (activeTask) {
                activeTaskId = activeTask.id;
                timerSeconds = activeTask.timeSpent;
                $('#timerDisplay').textContent = formatTime(timerSeconds);
                
                // Start timer
                timerRunning = true;
                
                timerInterval = setInterval(() => {
                    activeTask.timeSpent++;
                    timerSeconds++;
                    
                    // Update timer display
                    $('#timerDisplay').textContent = formatTime(timerSeconds);
                    
                    // Update task timer display
                    const timerDisplay = $(`.task-item[data-id="${activeTaskId}"] .task-timer-display span`);
                    if (timerDisplay) {
                        timerDisplay.textContent = formatTime(activeTask.timeSpent);
                    }
                    
                    // Save tasks to localStorage
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                    
                    // Every minute, update insights
                    if (activeTask.timeSpent % 60 === 0) {
                        updateInsights();
                    }
                }, 1000);
                
                // Update play/pause button in header
                $('#timerPlayPause i').classList.remove('fa-play');
                $('#timerPlayPause i').classList.add('fa-pause');
            } else {
                $('#timerDisplay').textContent = '00:00:00';
            }
            
            // Initialize chart when switching to graph view
            $('#graphViewBtn').addEventListener('click', function() {
                setTimeout(() => {
                    renderGraphs();
                }, 100);
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login Button
            $('#loginButton').addEventListener('click', function() {
                const email = $('#email').value.trim();
                const password = $('#password').value;
                
                // For demo purposes, accept any input or check specific credentials
                if (email === 'test@example.com' && password === '123456') {
                    // Find or create user
                    let user = users.find(u => u.email === email);
                    
                    if (!user) {
                        user = {
                            id: generateId(),
                            firstName: 'Test',
                            lastName: 'User',
                            email: email,
                            picture: 'https://randomuser.me/api/portraits/men/1.jpg',
                            role: 'Admin',
                            country: 'United States',
                            phone: '555-123-4567',
                            joinDate: new Date().toISOString()
                        };
                        users.push(user);
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    
                    // Set current user
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update profile picture
                    $('#profileImg').src = currentUser.picture;
                    
                    // Hide login container, show dashboard
                    $('#loginContainer').style.display = 'none';
                    $('#dashboardContainer').style.display = 'flex';
                    
                    // Initialize app
                    init();
                    
                    // Add notification
                    addNotification('Welcome back! You have successfully logged in.');
                } else {
                    showToast('Invalid credentials. Try using test@example.com/123456');
                }
            });
            
            // Register Link
            $('#registerLink').addEventListener('click', function(e) {
                e.preventDefault();
                showModal('#registerModal');
            });
            
            // Close Register Modal
            $('#closeRegisterModal, #cancelRegisterBtn').addEventListener('click', function() {
                hideModal('#registerModal');
            });
            
            // Create Account Button
            $('#createAccountBtn').addEventListener('click', function() {
                const firstName = $('#regFirstName').value.trim();
                const lastName = $('#regLastName').value.trim();
                const email = $('#regEmail').value.trim();
                const confirmEmail = $('#regConfirmEmail').value.trim();
                const password = $('#regPassword').value;
                const confirmPassword = $('#regConfirmPassword').value;
                const birthdate = $('#regBirthdate').value;
                const nationality = $('#regNationality').value;
                const role = $('#regRole').value;
                
                // Validate required fields
                if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                    showToast('Please fill in all required fields');
                    return;
                }
                
                // Validate email match
                if (email !== confirmEmail) {
                    showToast('Emails do not match');
                    return;
                }
                
                // Validate password match
                if (password !== confirmPassword) {
                    showToast('Passwords do not match');
                    return;
                }
                
                // Check if email already exists
                if (users.some(user => user.email === email)) {
                    showToast('Email already exists');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: generateId(),
                    firstName,
                    lastName,
                    email,
                    password, // In a real app, this should be hashed
                    picture: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 100)}.jpg`,
                    role,
                    country: nationality,
                    birthdate,
                    phone: '',
                    joinDate: new Date().toISOString()
                };
                
                // Add user to users array
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                
                // Set current user
                currentUser = newUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Update profile picture
                $('#profileImg').src = currentUser.picture;
                
                // Hide register modal and login container, show dashboard
                hideModal('#registerModal');
                $('#loginContainer').style.display = 'none';
                $('#dashboardContainer').style.display = 'flex';
                
                // Initialize app
                init();
                
                // Add notification
                addNotification('Welcome! Your account has been created successfully.');
                
                // Update users grid
                renderUsersGrid();
            });
            
            // Mode Switch
            $('#modeSwitch, #switchModeBtn').addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                
                const isDarkMode = document.documentElement.classList.contains('dark');
                
                // Update mode switch icon
                const modeIcon = $('#modeSwitch i');
                if (isDarkMode) {
                    modeIcon.classList.remove('fa-sun');
                    modeIcon.classList.add('fa-moon');
                    $('#switchModeBtn i').className = 'fas fa-sun';
                    $('#switchModeBtn span').textContent = 'Switch to Light Mode';
                } else {
                    modeIcon.classList.remove('fa-moon');
                    modeIcon.classList.add('fa-sun');
                    $('#switchModeBtn i').className = 'fas fa-moon';
                    $('#switchModeBtn span').textContent = 'Switch to Dark Mode';
                }
                
                // Save preference to localStorage
                localStorage.setItem('darkMode', isDarkMode);
                
                // Re-render charts if they exist
                if ($('#tasksGraphView').style.display === 'grid') {
                    renderGraphs();
                }
            });
            
            // Profile Click
            $('#profileContainer').addEventListener('click', function(e) {
                if (e.target.closest('#profileImg')) {
                    // Toggle profile dropdown
                    const dropdown = $('#profileDropdown');
                    dropdown.classList.toggle('show');
                    
                    // Hide notification popup if open
                    $('#notificationPopup').classList.remove('show');
                } else if (e.target.closest('#notificationBadge')) {
                    // Toggle notification popup
                    const popup = $('#notificationPopup');
                    popup.classList.toggle('show');
                    
                    // Hide profile dropdown if open
                    $('#profileDropdown').classList.remove('show');
                    
                    // Render notifications
                    renderNotifications();
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#profileContainer')) {
                    $('#profileDropdown').classList.remove('show');
                    $('#notificationPopup').classList.remove('show');
                }
            });
            
            // Logout Button
            $('#logoutBtn').addEventListener('click', function() {
                // Clear current user
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Hide dashboard, show login container
                $('#dashboardContainer').style.display = 'none';
                $('#loginContainer').style.display = 'flex';
                
                // Stop timer if running
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            });
            
            // View Profile Button
            $('#viewProfileBtn').addEventListener('click', function() {
                // Hide profile dropdown
                $('#profileDropdown').classList.remove('show');
                
                // Set profile image
                $('#profileImage').src = currentUser.picture;
                
                // Set profile info
                $('#profileInfo').innerHTML = `
                    <div class="form-row">
                        <label class="form-label">Name</label>
                        <p>${currentUser.firstName} ${currentUser.lastName}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Email</label>
                        <p>${currentUser.email}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Phone</label>
                        <p>${currentUser.phone || 'Not provided'}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Country</label>
                        <p>${currentUser.country}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Role</label>
                        <p>${currentUser.role}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Joined</label>
                        <p>${formatDate(currentUser.joinDate)}</p>
                    </div>
                `;
                
                // Show view section, hide edit section
                $('#profileInfo').style.display = 'block';
                $('#profileForm').style.display = 'none';
                $('#profileViewFooter').style.display = 'flex';
                $('#profileEditFooter').style.display = 'none';
                $('#profileImageUpload').style.display = 'none';
                
                // Show profile modal
                showModal('#profileModal');
            });
            
            // Edit Profile Button
            $('#editProfileBtn').addEventListener('click', function() {
                // Fill form fields with current user data
                $('#profileFirstName').value = currentUser.firstName;
                $('#profileLastName').value = currentUser.lastName;
                $('#profileEmail').value = currentUser.email;
                $('#profilePhone').value = currentUser.phone || '';
                $('#profileCountry').value = currentUser.country;
                $('#profileRole').value = currentUser.role;
                
                // Show edit section, hide view section
                $('#profileInfo').style.display = 'none';
                $('#profileForm').style.display = 'block';
                $('#profileViewFooter').style.display = 'none';
                $('#profileEditFooter').style.display = 'flex';
                $('#profileImageUpload').style.display = 'block';
            });
            
            // Close Profile Modal
            $('#closeProfileModal, #closeProfileBtn').addEventListener('click', function() {
                hideModal('#profileModal');
            });
            
            // Cancel Profile Edit
            $('#cancelProfileBtn').addEventListener('click', function() {
                // Show view section, hide edit section
                $('#profileInfo').style.display = 'block';
                $('#profileForm').style.display = 'none';
                $('#profileViewFooter').style.display = 'flex';
                $('#profileEditFooter').style.display = 'none';
                $('#profileImageUpload').style.display = 'none';
            });
            
            // Save Profile Changes
            $('#saveProfileBtn').addEventListener('click', function() {
                const firstName = $('#profileFirstName').value.trim();
                const lastName = $('#profileLastName').value.trim();
                const email = $('#profileEmail').value.trim();
                const phone = $('#profilePhone').value.trim();
                const country = $('#profileCountry').value;
                const role = $('#profileRole').value;
                
                // Validate required fields
                if (!firstName || !lastName || !email || !country || !role) {
                    showToast('Please fill in all required fields');
                    return;
                }
                
                // Update current user data
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                currentUser.email = email;
                currentUser.phone = phone;
                currentUser.country = country;
                currentUser.role = role;
                
                // Update user in users array
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = { ...currentUser };
                }
                
                // Save to localStorage
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('users', JSON.stringify(users));
                
                // Update profile info display
                $('#profileInfo').innerHTML = `
                    <div class="form-row">
                        <label class="form-label">Name</label>
                        <p>${currentUser.firstName} ${currentUser.lastName}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Email</label>
                        <p>${currentUser.email}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Phone</label>
                        <p>${currentUser.phone || 'Not provided'}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Country</label>
                        <p>${currentUser.country}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Role</label>
                        <p>${currentUser.role}</p>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Joined</label>
                        <p>${formatDate(currentUser.joinDate)}</p>
                    </div>
                `;
                
                // Show view section, hide edit section
                $('#profileInfo').style.display = 'block';
                $('#profileForm').style.display = 'none';
                $('#profileViewFooter').style.display = 'flex';
                $('#profileEditFooter').style.display = 'none';
                $('#profileImageUpload').style.display = 'none';
                
                // Update users grid
                renderUsersGrid();
                
                // Show success message
                showToast('Profile updated successfully');
            });
            
            // Profile Image Upload
            $('#profileImageInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const imageUrl = event.target.result;
                        
                        // Update profile image
                        $('#profileImage').src = imageUrl;
                        
                        // Update current user data
                        currentUser.picture = imageUrl;
                        
                        // Update user in users array
                        const userIndex = users.findIndex(u => u.id === currentUser.id);
                        if (userIndex !== -1) {
                            users[userIndex].picture = imageUrl;
                        }
                        
                        // Save to localStorage
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        localStorage.setItem('users', JSON.stringify(users));
                        
                        // Update profile picture in header
                        $('#profileImg').src = imageUrl;
                        
                        // Update users grid
                        renderUsersGrid();
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Header Timer Play/Pause Button
            $('#timerPlayPause').addEventListener('click', function() {
                if (activeTaskId) {
                    // If there's an active task, toggle its timer
                    toggleTaskTimer(activeTaskId);
                } else if (tasks.length > 0) {
                    // If no active task but tasks exist, start timer for first pending task
                    const pendingTask = tasks.find(task => !task.completed);
                    
                    if (pendingTask) {
                        toggleTaskTimer(pendingTask.id);
                    } else {
                        showToast('No pending tasks to start timer for');
                    }
                } else {
                    showToast('No tasks available to start timer');
                }
            });
            
            // Users Button
            $('#usersButton').addEventListener('click', function() {
                showModal('#usersModal');
            });
            
            // Close Users Modal
            $('#closeUsersModal, #closeUsersBtn').addEventListener('click', function() {
                hideModal('#usersModal');
            });
            
            // Categories Button
            $('#categoriesButton').addEventListener('click', function() {
                showModal('#categoriesModal');
            });
            
            // Close Categories Modal
            $('#closeCategoriesModal, #closeCategoriesBtn').addEventListener('click', function() {
                hideModal('#categoriesModal');
            });
            
            // Add Category Button
            $('#addCategoryBtn').addEventListener('click', function() {
                const categoryName = $('#newCategory').value.trim();
                
                if (addCategory(categoryName)) {
                    $('#newCategory').value = '';
                }
            });
            
            // Add Task Button
            $('#addTaskBtn').addEventListener('click', function() {
                addNewTask();
            });
            
            // Close Task Modal
            $('#closeTaskModal, #cancelTaskBtn').addEventListener('click', function() {
                hideModal('#taskModal');
            });
            
            // Save Task Button
            $('#saveTaskBtn').addEventListener('click', function() {
                saveTask();
            });
            
            // Add Subtask Button
            $('#addSubtaskBtn').addEventListener('click', function() {
                const subtasksContainer = $('#subtasksContainer');
                
                const subtaskItem = document.createElement('div');
                subtaskItem.className = 'subtask-item';
                subtaskItem.innerHTML = `
                    <input type="text" class="subtask-input" placeholder="Enter sub-task...">
                    <button class="remove-subtask-btn" aria-label="Remove sub-task">-</button>
                `;
                
                subtasksContainer.appendChild(subtaskItem);
                
                // Add event listener to remove button
                subtaskItem.querySelector('.remove-subtask-btn').addEventListener('click', function() {
                    subtaskItem.remove();
                });
            });
            
            // Close View Task Modal
            $('#closeViewTaskModal, #closeViewTaskBtn').addEventListener('click', function() {
                hideModal('#viewTaskModal');
            });
            
            // Export Button
            $('#exportBtn').addEventListener('click', function() {
                showModal('#exportModal');
            });
            
            // Close Export Modal
            $('#closeExportModal, #cancelExportBtn').addEventListener('click', function() {
                hideModal('#exportModal');
            });
            
            // Confirm Export Button
            $('#confirmExportBtn').addEventListener('click', function() {
                const format = $('#exportFormat').value;
                exportTasks(format);
                hideModal('#exportModal');
            });
            
            // Import Button
            $('#importBtn').addEventListener('click', function() {
                showModal('#importModal');
            });
            
            // Close Import Modal
            $('#closeImportModal, #cancelImportBtn').addEventListener('click', function() {
                hideModal('#importModal');
            });
            
            // Confirm Import Button
            $('#confirmImportBtn').addEventListener('click', function() {
                const file = $('#importFile').files[0];
                const url = $('#importUrl').value.trim();
                
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        importTasks(e.target.result);
                    };
                    
                    reader.readAsText(file);
                    hideModal('#importModal');
                } else if (url) {
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            importTasks(JSON.stringify(data));
                            hideModal('#importModal');
                        })
                        .catch(error => {
                            console.error('Error fetching JSON from URL:', error);
                            showToast('Error fetching JSON from URL');
                        });
                } else {
                    showToast('Please select a file or enter a URL');
                }
            });
            
            // View Switch Buttons
            $$('.view-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    $$('.view-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Get view type
                    const viewType = this.dataset.view;
                    
                    // Hide all views
                    $('#tasksListView').style.display = 'none';
                    $('#tasksGraphView').style.display = 'none';
                    
                    // Show selected view
                    if (viewType === 'list') {
                        $('#tasksListView').style.display = 'block';
                    } else if (viewType === 'graph') {
                        $('#tasksGraphView').style.display = 'grid';
                        renderGraphs();
                    }
                });
            });
            
            // Filter change events
            $('#statusFilter, #categoryFilter, #priorityFilter, #sortFilter').forEach(element => {
                element.addEventListener('change', function() {
                    renderTasks();
                });
            });
            
            // Due date filter change
            $('#dueDateFilter').addEventListener('change', function() {
                if (this.value === 'custom') {
                    showModal('#dateRangeModal');
                } else {
                    renderTasks();
                }
            });
            
            // Search input
            $('#searchInput').addEventListener('input', debounce(function() {
                renderTasks();
            }, 300));
            
            // Close Date Range Modal
            $('#closeDateRangeModal, #cancelDateRangeBtn').addEventListener('click', function() {
                hideModal('#dateRangeModal');
                $('#dueDateFilter').value = 'all';
            });
            
            // Apply Date Range Button
            $('#applyDateRangeBtn').addEventListener('click', function() {
                const startDate = $('#startDate').value;
                const endDate = $('#endDate').value;
                
                if (!startDate || !endDate) {
                    showToast('Please select both start and end dates');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    showToast('Start date cannot be after end date');
                    return;
                }
                
                customDateRange = { startDate, endDate };
                hideModal('#dateRangeModal');
                renderTasks();
            });
            
            // Close Share Modal
            $('#closeShareModal, #closeShareBtn').addEventListener('click', function() {
                hideModal('#shareTaskModal');
            });
            
            // Copy Share Link Button
            $('#copyLinkBtn').addEventListener('click', function() {
                const shareLink = $('#shareLink');
                shareLink.select();
                document.execCommand('copy');
                
                showToast('Link copied to clipboard');
            });
            
            // Email Share Link Button
            $('#emailLinkBtn').addEventListener('click', function() {
                const shareLink = $('#shareLink').value;
                const subject = 'Task Shared from To-Do App';
                const body = `Check out this task: ${shareLink}`;
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                window.open(mailtoLink, '_blank');
            });
            
            // Check if user is already logged in
            if (currentUser) {
                // Update profile picture
                $('#profileImg').src = currentUser.picture;
                
                // Hide login container, show dashboard
                $('#loginContainer').style.display = 'none';
                $('#dashboardContainer').style.display = 'flex';
                
                // Initialize app
                init();
            }
        });
        
        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Variables
        let customDateRange = null;
    </script>
</body>
</html>
