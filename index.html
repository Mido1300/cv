<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskMaster Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f0ff',
              100: '#e0e0ff',
              200: '#c2c1ff',
              300: '#a3a2ff',
              400: '#8584fe',
              500: '#6665fe',
              600: '#5D5CDE',
              700: '#4947c9',
              800: '#3b39a3',
              900: '#2e2c7e',
            },
            dark: {
              100: '#d5d5d5',
              200: '#aaaaaa',
              300: '#808080',
              400: '#555555',
              500: '#2b2b2b',
              600: '#222222',
              700: '#1e1e1e',
              800: '#181818',
              900: '#101010',
            },
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
          },
          spacing: {
            '18': '4.5rem',
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'slide-down': 'slideDown 0.3s ease-out',
            'spin-slow': 'spin 3s linear infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            slideDown: {
              '0%': { transform: 'translateY(-10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
          },
          boxShadow: {
            'soft': '0 2px 10px rgba(0, 0, 0, 0.05)',
            'hover': '0 4px 20px rgba(0, 0, 0, 0.1)',
            'dark-soft': '0 2px 10px rgba(0, 0, 0, 0.2)',
            'dark-hover': '0 4px 20px rgba(0, 0, 0, 0.3)',
          },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom CSS */
    .task-enter {
      opacity: 0;
      transform: translateY(10px);
    }
    .task-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 300ms, transform 300ms;
    }
    .task-exit {
      opacity: 1;
    }
    .task-exit-active {
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 300ms, transform 300ms;
    }
    .task-item {
      transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
    }
    .task-item:hover {
      transform: translateY(-2px);
    }
    .checkbox-container {
      transition: background-color 0.2s;
    }
    .priority-high {
      background-color: rgba(255, 86, 86, 0.15);
      border-left: 3px solid rgb(255, 86, 86);
    }
    .priority-medium {
      background-color: rgba(255, 171, 64, 0.15);
      border-left: 3px solid rgb(255, 171, 64);
    }
    .priority-low {
      background-color: rgba(77, 171, 247, 0.15);
      border-left: 3px solid rgb(77, 171, 247);
    }
    .dark .priority-high {
      background-color: rgba(255, 86, 86, 0.2);
    }
    .dark .priority-medium {
      background-color: rgba(255, 171, 64, 0.2);
    }
    .dark .priority-low {
      background-color: rgba(77, 171, 247, 0.2);
    }
    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    /* Custom animations */
    @keyframes checkmark {
      0% { stroke-dashoffset: 24; }
      100% { stroke-dashoffset: 0; }
    }
    .checkmark {
      stroke-dasharray: 24;
      stroke-dashoffset: 24;
      animation: checkmark 0.3s ease-in-out forwards;
    }
    .toast {
      animation: slideInRight 0.3s, fadeOut 0.3s 2.7s forwards;
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    /* Shimmer loading effect */
    .shimmer {
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    .dark .shimmer {
      background: linear-gradient(90deg, 
        rgba(30, 30, 30, 0) 0%, 
        rgba(60, 60, 60, 0.2) 50%, 
        rgba(30, 30, 30, 0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="antialiased min-h-screen bg-gray-50 dark:bg-dark-800 text-gray-800 dark:text-gray-200 transition-colors duration-200">
  <div id="app" class="flex flex-col min-h-screen">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-80 dark:bg-dark-800 dark:bg-opacity-80 z-50 transition-opacity duration-300 opacity-100">
      <div class="flex flex-col items-center">
        <div class="w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-primary-600 font-medium">Loading TaskMaster Pro...</p>
      </div>
    </div>

    <!-- Toast notification container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Modal container -->
    <div id="modal-container" class="fixed inset-0 flex items-center justify-center z-40 hidden">
      <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-40 dark:bg-opacity-60"></div>
      <div id="modal-content" class="bg-white dark:bg-dark-700 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden z-50 transform transition-all duration-300 scale-95 opacity-0">
        <!-- Modal content will be dynamically inserted here -->
      </div>
    </div>

    <!-- Header/Navbar -->
    <header class="bg-white dark:bg-dark-700 shadow-sm sticky top-0 z-30 transition-colors duration-200">
      <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            <h1 class="text-lg font-bold ml-2">TaskMaster Pro</h1>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <!-- Theme toggle -->
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
            <!-- Sun icon (for dark mode) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <!-- Moon icon (for light mode) -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          </button>
          
          <!-- User account dropdown -->
          <div class="relative" id="user-menu">
            <button id="user-menu-button" class="flex items-center gap-2 py-1 px-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
              <div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-900 flex items-center justify-center text-primary-700 dark:text-primary-300 font-medium user-avatar">
                <!-- User initials will be inserted here -->
              </div>
              <span class="text-sm user-display-name hidden sm:inline">
                <!-- Username will be inserted here -->
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden sm:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div id="user-dropdown" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-dark-700 ring-1 ring-black ring-opacity-5 transition-all duration-200 transform opacity-0 scale-95 pointer-events-none z-50">
              <div class="py-1">
                <a href="#" id="user-profile" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">Profile</a>
                <a href="#" id="user-settings" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">Settings</a>
                <hr class="my-1 border-gray-200 dark:border-dark-600">
                <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-dark-600">Sign out</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar -->
      <aside id="sidebar" class="bg-white dark:bg-dark-700 w-64 flex-shrink-0 border-r border-gray-200 dark:border-dark-600 transition-all duration-200 transform -translate-x-full lg:translate-x-0 fixed lg:relative h-[calc(100vh-3.5rem)] lg:h-auto z-20 overflow-y-auto">
        <div class="p-4">
          <!-- Add new task button -->
          <button id="add-task-button" class="w-full flex items-center justify-center px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-sm transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            New Task
          </button>
          
          <!-- Task filters -->
          <div class="mt-6">
            <h3 class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400 tracking-wider mb-3">Filters</h3>
            <ul class="space-y-1">
              <li>
                <button data-filter="all" class="filter-button w-full flex items-center px-3 py-2 rounded-md bg-primary-50 dark:bg-primary-900/40 text-primary-800 dark:text-primary-200 font-medium">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                  All Tasks
                  <span class="ml-auto bg-primary-100 dark:bg-primary-800 text-primary-800 dark:text-primary-200 px-2 py-0.5 rounded-full text-xs font-medium" id="all-tasks-count">0</span>
                </button>
              </li>
              <li>
                <button data-filter="today" class="filter-button w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Today
                  <span class="ml-auto bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs font-medium" id="today-tasks-count">0</span>
                </button>
              </li>
              <li>
                <button data-filter="upcoming" class="filter-button w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Upcoming
                  <span class="ml-auto bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs font-medium" id="upcoming-tasks-count">0</span>
                </button>
              </li>
              <li>
                <button data-filter="important" class="filter-button w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                  </svg>
                  Important
                  <span class="ml-auto bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs font-medium" id="important-tasks-count">0</span>
                </button>
              </li>
              <li>
                <button data-filter="completed" class="filter-button w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Completed
                  <span class="ml-auto bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded-full text-xs font-medium" id="completed-tasks-count">0</span>
                </button>
              </li>
            </ul>
          </div>
          
          <!-- Categories section -->
          <div class="mt-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400 tracking-wider">Categories</h3>
              <button id="add-category-button" class="text-xs text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 transition-colors">
                + Add
              </button>
            </div>
            <ul id="category-list" class="space-y-1">
              <!-- Categories will be dynamically populated here -->
              <!-- Loading placeholder -->
              <li class="animate-pulse">
                <div class="h-9 bg-gray-200 dark:bg-dark-600 rounded-md"></div>
              </li>
              <li class="animate-pulse">
                <div class="h-9 bg-gray-200 dark:bg-dark-600 rounded-md"></div>
              </li>
              <li class="animate-pulse">
                <div class="h-9 bg-gray-200 dark:bg-dark-600 rounded-md"></div>
              </li>
            </ul>
          </div>
          
          <!-- Export/Import section -->
          <div class="mt-6">
            <h3 class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400 tracking-wider mb-3">Data Management</h3>
            <div class="space-y-2">
              <button id="export-button" class="w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Export Tasks
              </button>
              <button id="import-button" class="w-full flex items-center px-3 py-2 rounded-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Import Tasks
              </button>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main content area -->
      <main class="flex-1 overflow-y-auto bg-gray-50 dark:bg-dark-800">
        <div class="container mx-auto p-4">
          <!-- Search and actions header -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
            <div class="relative flex-1">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <input type="text" id="search-input" placeholder="Search tasks..." class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 dark:border-dark-600 rounded-lg bg-white dark:bg-dark-700 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:focus:ring-primary-600 focus:border-transparent text-base">
            </div>
            <div class="flex items-center gap-3">
              <div class="relative">
                <button id="sort-button" class="flex items-center px-4 py-2 bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                  </svg>
                  <span>Sort</span>
                </button>
                <div id="sort-dropdown" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-dark-700 ring-1 ring-black ring-opacity-5 transition-all duration-200 transform opacity-0 scale-95 pointer-events-none z-10">
                  <div class="py-1">
                    <button data-sort="dateCreated" data-order="desc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Newest first
                    </button>
                    <button data-sort="dateCreated" data-order="asc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Oldest first
                    </button>
                    <button data-sort="dueDate" data-order="asc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Due date (earliest)
                    </button>
                    <button data-sort="priority" data-order="desc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Priority (highest)
                    </button>
                    <button data-sort="priority" data-order="asc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Priority (lowest)
                    </button>
                    <button data-sort="alphabetical" data-order="asc" class="sort-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Alphabetically (A-Z)
                    </button>
                  </div>
                </div>
              </div>
              <div class="relative">
                <button id="view-button" class="flex items-center px-4 py-2 bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                  </svg>
                  <span>View</span>
                </button>
                <div id="view-dropdown" class="absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-dark-700 ring-1 ring-black ring-opacity-5 transition-all duration-200 transform opacity-0 scale-95 pointer-events-none z-10">
                  <div class="py-1">
                    <button data-view="list" class="view-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      List view
                    </button>
                    <button data-view="compact" class="view-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Compact view
                    </button>
                    <button data-view="board" class="view-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600">
                      Board view
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Current view title -->
          <div class="mb-6">
            <h2 id="current-view-title" class="text-2xl font-bold">All Tasks</h2>
            <p id="tasks-info" class="text-gray-500 dark:text-gray-400 mt-1">Showing <span id="displayed-tasks-count">0</span> of <span id="total-tasks-count">0</span> tasks</p>
          </div>

          <!-- Tasks list container - when view is 'list' or 'compact' -->
          <div id="tasks-container" class="space-y-3 animate-fade-in">
            <!-- Tasks will be dynamically inserted here -->
            <!-- Loading placeholders -->
            <div class="task-item-skeleton animate-pulse bg-white dark:bg-dark-700 rounded-lg shadow-sm p-4">
              <div class="flex items-center">
                <div class="h-5 w-5 rounded-full bg-gray-200 dark:bg-dark-600"></div>
                <div class="ml-3 flex-1">
                  <div class="h-4 bg-gray-200 dark:bg-dark-600 rounded w-3/4"></div>
                  <div class="mt-2 h-3 bg-gray-200 dark:bg-dark-600 rounded w-1/2"></div>
                </div>
              </div>
            </div>
            <div class="task-item-skeleton animate-pulse bg-white dark:bg-dark-700 rounded-lg shadow-sm p-4">
              <div class="flex items-center">
                <div class="h-5 w-5 rounded-full bg-gray-200 dark:bg-dark-600"></div>
                <div class="ml-3 flex-1">
                  <div class="h-4 bg-gray-200 dark:bg-dark-600 rounded w-2/3"></div>
                  <div class="mt-2 h-3 bg-gray-200 dark:bg-dark-600 rounded w-1/4"></div>
                </div>
              </div>
            </div>
            <div class="task-item-skeleton animate-pulse bg-white dark:bg-dark-700 rounded-lg shadow-sm p-4">
              <div class="flex items-center">
                <div class="h-5 w-5 rounded-full bg-gray-200 dark:bg-dark-600"></div>
                <div class="ml-3 flex-1">
                  <div class="h-4 bg-gray-200 dark:bg-dark-600 rounded w-4/5"></div>
                  <div class="mt-2 h-3 bg-gray-200 dark:bg-dark-600 rounded w-2/5"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tasks board container - when view is 'board' -->
          <div id="board-container" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 animate-fade-in">
            <!-- To Do column -->
            <div class="board-column bg-gray-100 dark:bg-dark-700/50 rounded-lg p-3">
              <h3 class="text-lg font-semibold mb-3 px-2">To Do</h3>
              <div id="todo-tasks" class="space-y-2 min-h-[100px]">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>
            
            <!-- In Progress column -->
            <div class="board-column bg-gray-100 dark:bg-dark-700/50 rounded-lg p-3">
              <h3 class="text-lg font-semibold mb-3 px-2">In Progress</h3>
              <div id="progress-tasks" class="space-y-2 min-h-[100px]">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>
            
            <!-- Completed column -->
            <div class="board-column bg-gray-100 dark:bg-dark-700/50 rounded-lg p-3">
              <h3 class="text-lg font-semibold mb-3 px-2">Completed</h3>
              <div id="completed-tasks" class="space-y-2 min-h-[100px]">
                <!-- Tasks will be dynamically inserted here -->
              </div>
            </div>
          </div>
          
          <!-- Empty state -->
          <div id="empty-state" class="hidden text-center py-10">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <h3 class="mt-4 text-lg font-medium">No tasks found</h3>
            <p class="mt-1 text-gray-500 dark:text-gray-400">Get started by creating your first task</p>
            <button id="empty-add-task-button" class="mt-4 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg shadow-sm transition-colors">
              Create a task
            </button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Script imports -->
  <script>
    // Enable dark mode based on user preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // App module pattern
    const TodoApp = (function() {
      // Local storage keys
      const STORAGE_KEYS = {
        TASKS: 'taskmaster-tasks',
        CATEGORIES: 'taskmaster-categories',
        USERS: 'taskmaster-users',
        CURRENT_USER: 'taskmaster-current-user',
        SETTINGS: 'taskmaster-settings',
      };

      // Task priority levels
      const PRIORITY_LEVELS = {
        LOW: 'low',
        MEDIUM: 'medium',
        HIGH: 'high',
      };

      // Task status types for board view
      const TASK_STATUS = {
        TODO: 'todo',
        PROGRESS: 'progress',
        COMPLETED: 'completed',
      };

      // View types
      const VIEW_TYPES = {
        LIST: 'list',
        COMPACT: 'compact',
        BOARD: 'board',
      };

      // Filter types
      const FILTER_TYPES = {
        ALL: 'all',
        TODAY: 'today',
        UPCOMING: 'upcoming',
        IMPORTANT: 'important',
        COMPLETED: 'completed',
        CATEGORY: 'category',
      };

      // Sort options
      const SORT_OPTIONS = {
        DATE_CREATED_ASC: { field: 'dateCreated', order: 'asc' },
        DATE_CREATED_DESC: { field: 'dateCreated', order: 'desc' },
        DUE_DATE_ASC: { field: 'dueDate', order: 'asc' },
        PRIORITY_ASC: { field: 'priority', order: 'asc' },
        PRIORITY_DESC: { field: 'priority', order: 'desc' },
        ALPHABETICAL_ASC: { field: 'alphabetical', order: 'asc' },
      };

      // Default category colors
      const CATEGORY_COLORS = [
        '#5D5CDE', // Primary blue
        '#10B981', // Green
        '#F59E0B', // Amber
        '#EC4899', // Pink
        '#8B5CF6', // Purple
        '#EF4444', // Red
        '#3B82F6', // Blue
        '#06B6D4', // Cyan
      ];

      // App state
      let state = {
        tasks: [],
        categories: [],
        users: [],
        currentUser: null,
        settings: {
          theme: 'system',
          view: VIEW_TYPES.LIST,
          currentFilter: FILTER_TYPES.ALL,
          currentCategoryFilter: null,
          sortOption: SORT_OPTIONS.DATE_CREATED_DESC,
          searchQuery: '',
        },
        ui: {
          isLoading: true,
          activeSidebar: false,
          activeUserDropdown: false,
          activeSortDropdown: false,
          activeViewDropdown: false,
        }
      };

      // DOM elements (populated in init() function)
      let elements = {};

      // Helper functions
      const helpers = {
        generateId: () => '_' + Math.random().toString(36).substring(2, 11),
        formatDate: (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return new Intl.DateTimeFormat('en-US', { 
            month: 'short', 
            day: 'numeric',
            year: 'numeric'
          }).format(date);
        },
        formatDateRelative: (dateString) => {
          if (!dateString) return '';
          
          const date = new Date(dateString);
          const now = new Date();
          const diffTime = date - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays === 0) {
            return 'Today';
          } else if (diffDays === 1) {
            return 'Tomorrow';
          } else if (diffDays === -1) {
            return 'Yesterday';
          } else if (diffDays > 0 && diffDays < 7) {
            return `In ${diffDays} days`;
          } else if (diffDays < 0 && diffDays > -7) {
            return `${Math.abs(diffDays)} days ago`;
          } else {
            return helpers.formatDate(dateString);
          }
        },
        getPriorityLabel: (priority) => {
          const labels = {
            [PRIORITY_LEVELS.LOW]: 'Low',
            [PRIORITY_LEVELS.MEDIUM]: 'Medium',
            [PRIORITY_LEVELS.HIGH]: 'High',
          };
          return labels[priority] || 'None';
        },
        getPriorityColor: (priority) => {
          const colors = {
            [PRIORITY_LEVELS.LOW]: 'bg-blue-400 dark:bg-blue-500',
            [PRIORITY_LEVELS.MEDIUM]: 'bg-amber-400 dark:bg-amber-500',
            [PRIORITY_LEVELS.HIGH]: 'bg-red-400 dark:bg-red-500',
          };
          return colors[priority] || '';
        },
        isToday: (dateString) => {
          if (!dateString) return false;
          const date = new Date(dateString);
          const today = new Date();
          return date.getDate() === today.getDate() &&
            date.getMonth() === today.getMonth() &&
            date.getFullYear() === today.getFullYear();
        },
        isUpcoming: (dateString) => {
          if (!dateString) return false;
          const date = new Date(dateString);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return date > today;
        },
        getInitials: (name) => {
          if (!name) return '';
          return name.split(' ')
            .map(word => word.charAt(0).toUpperCase())
            .slice(0, 2)
            .join('');
        },
        isOverdue: (dateString) => {
          if (!dateString) return false;
          const date = new Date(dateString);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return date < today;
        },
        debounce: (func, wait) => {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        },
        sortTasks: (tasks, sortOption) => {
          const { field, order } = sortOption;
          const sortedTasks = [...tasks];
          
          sortedTasks.sort((a, b) => {
            if (field === 'dateCreated') {
              return order === 'asc' 
                ? new Date(a.dateCreated) - new Date(b.dateCreated)
                : new Date(b.dateCreated) - new Date(a.dateCreated);
            } else if (field === 'dueDate') {
              // Handle null or undefined due dates
              if (!a.dueDate && !b.dueDate) return 0;
              if (!a.dueDate) return order === 'asc' ? 1 : -1;
              if (!b.dueDate) return order === 'asc' ? -1 : 1;
              
              return order === 'asc'
                ? new Date(a.dueDate) - new Date(b.dueDate)
                : new Date(b.dueDate) - new Date(a.dueDate);
            } else if (field === 'priority') {
              const priorityValues = {
                [PRIORITY_LEVELS.LOW]: 1,
                [PRIORITY_LEVELS.MEDIUM]: 2,
                [PRIORITY_LEVELS.HIGH]: 3,
              };
              
              const valueA = priorityValues[a.priority] || 0;
              const valueB = priorityValues[b.priority] || 0;
              
              return order === 'asc' ? valueA - valueB : valueB - valueA;
            } else if (field === 'alphabetical') {
              return order === 'asc'
                ? a.title.localeCompare(b.title)
                : b.title.localeCompare(a.title);
            }
            
            return 0;
          });
          
          return sortedTasks;
        },
        getTaskPriorityClass: (priority) => {
          const classes = {
            [PRIORITY_LEVELS.LOW]: 'priority-low',
            [PRIORITY_LEVELS.MEDIUM]: 'priority-medium',
            [PRIORITY_LEVELS.HIGH]: 'priority-high',
          };
          return classes[priority] || '';
        },
      };

      // Storage service
      const storage = {
        getItem: (key) => {
          try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
          } catch (error) {
            console.error(`Error getting item ${key} from localStorage:`, error);
            return null;
          }
        },
        setItem: (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.error(`Error setting item ${key} in localStorage:`, error);
          }
        },
        removeItem: (key) => {
          try {
            localStorage.removeItem(key);
          } catch (error) {
            console.error(`Error removing item ${key} from localStorage:`, error);
          }
        },
      };

      // Task service
      const taskService = {
        getTasks: () => {
          return storage.getItem(STORAGE_KEYS.TASKS) || [];
        },
        saveTasks: (tasks) => {
          storage.setItem(STORAGE_KEYS.TASKS, tasks);
        },
        addTask: (task) => {
          const tasks = taskService.getTasks();
          const newTask = {
            id: helpers.generateId(),
            dateCreated: new Date().toISOString(),
            completed: false,
            status: TASK_STATUS.TODO,
            ...task,
          };
          tasks.push(newTask);
          taskService.saveTasks(tasks);
          return newTask;
        },
        updateTask: (taskId, updatedData) => {
          const tasks = taskService.getTasks();
          const index = tasks.findIndex(task => task.id === taskId);
          
          if (index !== -1) {
            tasks[index] = { ...tasks[index], ...updatedData };
            taskService.saveTasks(tasks);
            return tasks[index];
          }
          
          return null;
        },
        deleteTask: (taskId) => {
          const tasks = taskService.getTasks();
          const newTasks = tasks.filter(task => task.id !== taskId);
          taskService.saveTasks(newTasks);
          return newTasks;
        },
        toggleTaskCompleted: (taskId) => {
          const tasks = taskService.getTasks();
          const task = tasks.find(task => task.id === taskId);
          
          if (task) {
            const updatedTask = { 
              ...task, 
              completed: !task.completed,
              status: !task.completed ? TASK_STATUS.COMPLETED : TASK_STATUS.TODO
            };
            return taskService.updateTask(taskId, updatedTask);
          }
          
          return null;
        },
        deleteCompletedTasks: () => {
          const tasks = taskService.getTasks();
          const newTasks = tasks.filter(task => !task.completed);
          taskService.saveTasks(newTasks);
          return newTasks;
        },
        filterTasks: (tasks, filterType, categoryId, searchQuery) => {
          let filteredTasks = [...tasks];
          
          // First apply category filter if applicable
          if (categoryId) {
            filteredTasks = filteredTasks.filter(task => task.categoryId === categoryId);
          }
          
          // Then apply search filter if there's a query
          if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filteredTasks = filteredTasks.filter(task => 
              task.title.toLowerCase().includes(query) || 
              (task.description && task.description.toLowerCase().includes(query))
            );
          }
          
          // Finally apply specific filter type
          switch (filterType) {
            case FILTER_TYPES.TODAY:
              return filteredTasks.filter(task => helpers.isToday(task.dueDate));
            case FILTER_TYPES.UPCOMING:
              return filteredTasks.filter(task => helpers.isUpcoming(task.dueDate));
            case FILTER_TYPES.IMPORTANT:
              return filteredTasks.filter(task => task.priority === PRIORITY_LEVELS.HIGH);
            case FILTER_TYPES.COMPLETED:
              return filteredTasks.filter(task => task.completed);
            case FILTER_TYPES.ALL:
            default:
              return filteredTasks;
          }
        },
      };

      // Category service
      const categoryService = {
        getCategories: () => {
          return storage.getItem(STORAGE_KEYS.CATEGORIES) || [];
        },
        saveCategories: (categories) => {
          storage.setItem(STORAGE_KEYS.CATEGORIES, categories);
        },
        addCategory: (category) => {
          const categories = categoryService.getCategories();
          const color = category.color || CATEGORY_COLORS[categories.length % CATEGORY_COLORS.length];
          
          const newCategory = {
            id: helpers.generateId(),
            dateCreated: new Date().toISOString(),
            color,
            ...category,
          };
          
          categories.push(newCategory);
          categoryService.saveCategories(categories);
          return newCategory;
        },
        updateCategory: (categoryId, updatedData) => {
          const categories = categoryService.getCategories();
          const index = categories.findIndex(category => category.id === categoryId);
          
          if (index !== -1) {
            categories[index] = { ...categories[index], ...updatedData };
            categoryService.saveCategories(categories);
            return categories[index];
          }
          
          return null;
        },
        deleteCategory: (categoryId) => {
          const categories = categoryService.getCategories();
          const newCategories = categories.filter(category => category.id !== categoryId);
          categoryService.saveCategories(newCategories);
          
          // Also remove this category from tasks
          const tasks = taskService.getTasks();
          const updatedTasks = tasks.map(task => {
            if (task.categoryId === categoryId) {
              return { ...task, categoryId: null };
            }
            return task;
          });
          
          taskService.saveTasks(updatedTasks);
          return newCategories;
        },
      };

      // User service (mock authentication)
      const userService = {
        getUsers: () => {
          return storage.getItem(STORAGE_KEYS.USERS) || [];
        },
        saveUsers: (users) => {
          storage.setItem(STORAGE_KEYS.USERS, users);
        },
        getCurrentUser: () => {
          return storage.getItem(STORAGE_KEYS.CURRENT_USER);
        },
        setCurrentUser: (user) => {
          storage.setItem(STORAGE_KEYS.CURRENT_USER, user);
        },
        register: (userData) => {
          const users = userService.getUsers();
          
          // Check if user already exists
          if (users.some(user => user.username === userData.username)) {
            throw new Error('Username already exists');
          }
          
          const newUser = {
            id: helpers.generateId(),
            dateCreated: new Date().toISOString(),
            ...userData,
          };
          
          users.push(newUser);
          userService.saveUsers(users);
          return newUser;
        },
        login: (username, password) => {
          const users = userService.getUsers();
          const user = users.find(user => 
            user.username === username && user.password === password
          );
          
          if (user) {
            // Remove password from the stored user object
            const userWithoutPassword = { ...user };
            delete userWithoutPassword.password;
            
            userService.setCurrentUser(userWithoutPassword);
            return userWithoutPassword;
          }
          
          throw new Error('Invalid username or password');
        },
        logout: () => {
          storage.removeItem(STORAGE_KEYS.CURRENT_USER);
        },
        // Check if the user is logged in
        isAuthenticated: () => {
          return !!userService.getCurrentUser();
        },
      };

      // Settings service
      const settingsService = {
        getSettings: () => {
          return storage.getItem(STORAGE_KEYS.SETTINGS) || {
            theme: 'system',
            view: VIEW_TYPES.LIST,
            currentFilter: FILTER_TYPES.ALL,
            currentCategoryFilter: null,
            sortOption: SORT_OPTIONS.DATE_CREATED_DESC,
            searchQuery: '',
          };
        },
        saveSettings: (settings) => {
          storage.setItem(STORAGE_KEYS.SETTINGS, settings);
        },
        updateSettings: (updatedSettings) => {
          const currentSettings = settingsService.getSettings();
          const newSettings = { ...currentSettings, ...updatedSettings };
          settingsService.saveSettings(newSettings);
          return newSettings;
        },
      };

      // UI Helpers
      const ui = {
        showToast: (message, type = 'success', duration = 3000) => {
          const toastContainer = elements.toastContainer;
          
          const toast = document.createElement('div');
          toast.className = `toast max-w-xs w-full p-3 rounded-lg shadow-lg text-white items-center ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 
            type === 'warning' ? 'bg-amber-500' : 'bg-primary-600'
          }`;
          
          // Create the toast content
          toast.innerHTML = `
            <div class="flex items-center">
              ${type === 'success' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              ` : type === 'error' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              ` : type === 'warning' ? `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              ` : `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              `}
              <span>${message}</span>
            </div>
          `;
          
          toastContainer.appendChild(toast);
          
          // Automatically remove toast after duration
          setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
              toast.remove();
            }, 300);
          }, duration);
        },

        showModal: (title, content, onConfirm, confirmText = 'Confirm', cancelText = 'Cancel', type = 'default') => {
          const modalOverlay = elements.modalOverlay;
          const modalContent = elements.modalContent;
          const modalContainer = elements.modalContainer;
          
          // Set up modal content
          let headerClass = 'bg-white dark:bg-dark-700';
          let headerIcon = '';
          
          if (type === 'danger') {
            headerClass = 'bg-red-500 text-white';
            headerIcon = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            `;
          }
          
          modalContent.innerHTML = `
            <div class="flex items-center justify-between ${headerClass} px-4 py-3 rounded-t-lg">
              <h3 class="text-lg font-medium flex items-center">
                ${headerIcon}
                <span class="${headerIcon ? 'ml-2' : ''}">${title}</span>
              </h3>
              <button id="modal-close" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="p-4">
              ${content}
            </div>
            <div class="bg-gray-50 dark:bg-dark-600 px-4 py-3 flex ${onConfirm ? 'justify-end' : 'justify-center'} gap-2 rounded-b-lg">
              ${onConfirm ? `
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 dark:bg-dark-500 hover:bg-gray-300 dark:hover:bg-dark-400 rounded-md transition-colors">
                  ${cancelText}
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md transition-colors">
                  ${confirmText}
                </button>
              ` : `
                <button id="modal-close-btn" class="px-4 py-2 bg-gray-200 dark:bg-dark-500 hover:bg-gray-300 dark:hover:bg-dark-400 rounded-md transition-colors">
                  ${cancelText}
                </button>
              `}
            </div>
          `;
          
          // Show modal with animation
          modalContainer.classList.remove('hidden');
          modalContainer.classList.add('flex');
          
          // Animate in
          setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
          }, 10);
          
          // Set up event listeners
          const closeModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
              modalContainer.classList.remove('flex');
              modalContainer.classList.add('hidden');
            }, 300);
          };
          
          // Close button in header
          document.getElementById('modal-close').addEventListener('click', closeModal);
          
          // Close on overlay click
          modalOverlay.addEventListener('click', closeModal);
          
          // Cancel button
          const cancelButton = document.getElementById('modal-cancel');
          if (cancelButton) {
            cancelButton.addEventListener('click', closeModal);
          }
          
          // Simple close button (for dialogs without confirm)
          const closeButton = document.getElementById('modal-close-btn');
          if (closeButton) {
            closeButton.addEventListener('click', closeModal);
          }
          
          // Confirm button
          if (onConfirm) {
            const confirmButton = document.getElementById('modal-confirm');
            confirmButton.addEventListener('click', () => {
              onConfirm();
              closeModal();
            });
          }
          
          // Escape key to close
          const escHandler = (e) => {
            if (e.key === 'Escape') {
              closeModal();
              document.removeEventListener('keydown', escHandler);
            }
          };
          
          document.addEventListener('keydown', escHandler);
        },

        // Show task form for adding or editing a task
        showTaskForm: (task = null) => {
          const isEditing = !!task;
          const title = isEditing ? 'Edit Task' : 'Add New Task';
          
          // Get all categories for the select dropdown
          const categoryOptions = state.categories.map(category => `
            <option value="${category.id}" ${isEditing && task.categoryId === category.id ? 'selected' : ''}>
              ${category.name}
            </option>
          `).join('');
          
          // Generate the form HTML
          const formContent = `
            <form id="task-form" class="space-y-4">
              <div>
                <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Title <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="task-title" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base" 
                  placeholder="Enter task title"
                  value="${isEditing ? task.title : ''}"
                  required
                >
              </div>
              
              <div>
                <label for="task-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Description
                </label>
                <textarea 
                  id="task-description" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base" 
                  placeholder="Enter task description"
                  rows="3"
                >${isEditing && task.description ? task.description : ''}</textarea>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="task-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Due Date
                  </label>
                  <input 
                    type="date" 
                    id="task-due-date" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                    value="${isEditing && task.dueDate ? task.dueDate.split('T')[0] : ''}"
                  >
                </div>
                
                <div>
                  <label for="task-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Priority
                  </label>
                  <select 
                    id="task-priority" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                  >
                    <option value="${PRIORITY_LEVELS.LOW}" ${isEditing && task.priority === PRIORITY_LEVELS.LOW ? 'selected' : ''}>
                      Low
                    </option>
                    <option value="${PRIORITY_LEVELS.MEDIUM}" ${isEditing && task.priority === PRIORITY_LEVELS.MEDIUM ? 'selected' : ''}>
                      Medium
                    </option>
                    <option value="${PRIORITY_LEVELS.HIGH}" ${isEditing && task.priority === PRIORITY_LEVELS.HIGH ? 'selected' : ''}>
                      High
                    </option>
                  </select>
                </div>
              </div>
              
              <div>
                <label for="task-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Category
                </label>
                <select 
                  id="task-category" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                >
                  <option value="">No Category</option>
                  ${categoryOptions}
                </select>
              </div>
              
              ${isEditing ? `
                <div>
                  <label for="task-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Status
                  </label>
                  <select 
                    id="task-status" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                  >
                    <option value="${TASK_STATUS.TODO}" ${task.status === TASK_STATUS.TODO ? 'selected' : ''}>
                      To Do
                    </option>
                    <option value="${TASK_STATUS.PROGRESS}" ${task.status === TASK_STATUS.PROGRESS ? 'selected' : ''}>
                      In Progress
                    </option>
                    <option value="${TASK_STATUS.COMPLETED}" ${task.status === TASK_STATUS.COMPLETED ? 'selected' : ''}>
                      Completed
                    </option>
                  </select>
                </div>
              ` : ''}
              
              <input type="hidden" id="task-id" value="${isEditing ? task.id : ''}">
            </form>
          `;
          
          // Show the modal with the form
          ui.showModal(title, formContent, () => {
            // Get form values
            const taskTitle = document.getElementById('task-title').value.trim();
            const taskDescription = document.getElementById('task-description').value.trim();
            const taskDueDate = document.getElementById('task-due-date').value;
            const taskPriority = document.getElementById('task-priority').value;
            const taskCategory = document.getElementById('task-category').value || null;
            const taskId = document.getElementById('task-id').value;
            
            // Optional: Get status if editing
            let taskStatus = task?.status || TASK_STATUS.TODO;
            const statusElement = document.getElementById('task-status');
            if (statusElement) {
              taskStatus = statusElement.value;
            }
            
            // Check required fields
            if (!taskTitle) {
              ui.showToast('Task title is required', 'error');
              return;
            }
            
            // Convert date string to ISO format if present
            const formattedDueDate = taskDueDate ? new Date(taskDueDate).toISOString() : null;
            
            // Create task object
            const taskData = {
              title: taskTitle,
              description: taskDescription,
              dueDate: formattedDueDate,
              priority: taskPriority,
              categoryId: taskCategory,
              status: taskStatus,
              // If editing and the status is COMPLETED, maintain the completed flag
              ...(isEditing && { completed: taskStatus === TASK_STATUS.COMPLETED }),
            };
            
            // If editing, update task, otherwise add new task
            if (isEditing) {
              const updatedTask = taskService.updateTask(taskId, taskData);
              if (updatedTask) {
                // Update the state
                state.tasks = state.tasks.map(t => t.id === taskId ? updatedTask : t);
                ui.showToast('Task updated successfully');
                ui.renderTasks();
              }
            } else {
              const newTask = taskService.addTask(taskData);
              if (newTask) {
                // Update the state
                state.tasks.push(newTask);
                ui.showToast('Task added successfully');
                ui.renderTasks();
              }
            }
          }, isEditing ? 'Save Changes' : 'Add Task');
        },

        // Show category form for adding or editing
        showCategoryForm: (category = null) => {
          const isEditing = !!category;
          const title = isEditing ? 'Edit Category' : 'Add New Category';
          
          // Generate a random color if not editing
          const initialColor = isEditing 
            ? category.color 
            : CATEGORY_COLORS[Math.floor(Math.random() * CATEGORY_COLORS.length)];
          
          // Generate the form HTML
          const formContent = `
            <form id="category-form" class="space-y-4">
              <div>
                <label for="category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Name <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="category-name" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                  placeholder="Enter category name"
                  value="${isEditing ? category.name : ''}"
                  required
                >
              </div>
              
              <div>
                <label for="category-color" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Color
                </label>
                <div class="flex items-center space-x-2">
                  <input 
                    type="color" 
                    id="category-color" 
                    class="h-10 w-10 border-0 p-0 rounded-md cursor-pointer"
                    value="${initialColor}"
                  >
                  <input 
                    type="text" 
                    id="category-color-hex" 
                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base uppercase"
                    value="${initialColor}"
                    maxlength="7"
                  >
                </div>
              </div>
              
              <div class="flex flex-wrap gap-2">
                ${CATEGORY_COLORS.map(color => `
                  <button 
                    type="button" 
                    class="color-preset w-8 h-8 rounded-full border-2 ${color === initialColor ? 'border-gray-900 dark:border-white' : 'border-transparent'}" 
                    style="background-color: ${color};"
                    data-color="${color}"
                  ></button>
                `).join('')}
              </div>
              
              <input type="hidden" id="category-id" value="${isEditing ? category.id : ''}">
            </form>
          `;
          
          // Show the modal with the form
          ui.showModal(title, formContent, () => {
            // Get form values
            const categoryName = document.getElementById('category-name').value.trim();
            const categoryColor = document.getElementById('category-color').value;
            const categoryId = document.getElementById('category-id').value;
            
            // Check required fields
            if (!categoryName) {
              ui.showToast('Category name is required', 'error');
              return;
            }
            
            // Create category object
            const categoryData = {
              name: categoryName,
              color: categoryColor
            };
            
            // If editing, update category, otherwise add new category
            if (isEditing) {
              const updatedCategory = categoryService.updateCategory(categoryId, categoryData);
              if (updatedCategory) {
                // Update the state
                state.categories = state.categories.map(c => c.id === categoryId ? updatedCategory : c);
                ui.showToast('Category updated successfully');
                ui.renderCategories();
                ui.renderTasks(); // Re-render tasks to reflect category changes
              }
            } else {
              const newCategory = categoryService.addCategory(categoryData);
              if (newCategory) {
                // Update the state
                state.categories.push(newCategory);
                ui.showToast('Category added successfully');
                ui.renderCategories();
              }
            }
          }, isEditing ? 'Save Changes' : 'Add Category');
          
          // Add event listeners to connect color input and text field
          const colorInput = document.getElementById('category-color');
          const colorText = document.getElementById('category-color-hex');
          
          colorInput.addEventListener('input', () => {
            colorText.value = colorInput.value;
          });
          
          colorText.addEventListener('input', () => {
            if (/^#[0-9A-F]{6}$/i.test(colorText.value)) {
              colorInput.value = colorText.value;
            }
          });
          
          // Add event listeners to color presets
          const colorPresets = document.querySelectorAll('.color-preset');
          colorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
              const color = preset.dataset.color;
              colorInput.value = color;
              colorText.value = color;
              
              // Update the selected state
              colorPresets.forEach(p => {
                p.classList.remove('border-gray-900', 'dark:border-white');
                p.classList.add('border-transparent');
              });
              preset.classList.remove('border-transparent');
              preset.classList.add('border-gray-900', 'dark:border-white');
            });
          });
        },

        // Show authentication form (login/register)
        showAuthForm: (isLogin = true) => {
          const title = isLogin ? 'Sign In' : 'Create Account';
          
          const formContent = `
            <form id="auth-form" class="space-y-4">
              <div>
                <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Username <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="username" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                  placeholder="Enter your username"
                  required
                >
              </div>
              
              <div>
                <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Password <span class="text-red-500">*</span>
                </label>
                <input 
                  type="password" 
                  id="password" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                  placeholder="Enter your password"
                  required
                >
              </div>
              
              ${!isLogin ? `
                <div>
                  <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Confirm Password <span class="text-red-500">*</span>
                  </label>
                  <input 
                    type="password" 
                    id="confirm-password" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                    placeholder="Confirm your password"
                    required
                  >
                </div>
                
                <div>
                  <label for="display-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Display Name <span class="text-red-500">*</span>
                  </label>
                  <input 
                    type="text" 
                    id="display-name" 
                    class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 dark:bg-dark-800 dark:text-white text-base"
                    placeholder="Enter your display name"
                    required
                  >
                </div>
              ` : ''}
            </form>
            
            <div class="mt-4 text-center">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                ${isLogin ? 
                  "Don't have an account? <button id='switch-to-register' class='text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300'>Sign Up</button>" :
                  "Already have an account? <button id='switch-to-login' class='text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300'>Sign In</button>"
                }
              </p>
            </div>
          `;
          
          ui.showModal(title, formContent, () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
              ui.showToast('Username and password are required', 'error');
              return;
            }
            
            if (isLogin) {
              try {
                const user = userService.login(username, password);
                state.currentUser = user;
                ui.showToast(`Welcome back, ${user.displayName || user.username}!`);
                ui.updateUserUI();
                
                // Load user-specific data
                ui.loadUserData();
              } catch (error) {
                ui.showToast(error.message, 'error');
              }
            } else {
              // For registration
              const confirmPassword = document.getElementById('confirm-password').value;
              const displayName = document.getElementById('display-name').value.trim();
              
              if (password !== confirmPassword) {
                ui.showToast('Passwords do not match', 'error');
                return;
              }
              
              if (!displayName) {
                ui.showToast('Display name is required', 'error');
                return;
              }
              
              try {
                const newUser = userService.register({
                  username,
                  password,
                  displayName
                });
                
                // Auto login the user
                state.currentUser = { ...newUser };
                delete state.currentUser.password;
                userService.setCurrentUser(state.currentUser);
                
                ui.showToast(`Welcome, ${displayName}!`);
                ui.updateUserUI();
                
                // Initialize user data
                ui.initializeUserData();
              } catch (error) {
                ui.showToast(error.message, 'error');
              }
            }
          }, isLogin ? 'Sign In' : 'Create Account');
          
          // Add event listeners for switching between login and register
          if (isLogin) {
            document.getElementById('switch-to-register').addEventListener('click', () => {
              ui.showAuthForm(false);
            });
          } else {
            document.getElementById('switch-to-login').addEventListener('click', () => {
              ui.showAuthForm(true);
            });
          }
        },

        // Show export dialog
        showExportDialog: () => {
          const exportData = {
            tasks: state.tasks,
            categories: state.categories,
            appVersion: '1.0',
            exportDate: new Date().toISOString()
          };
          
          const jsonData = JSON.stringify(exportData, null, 2);
          
          const content = `
            <div class="space-y-4">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Copy the JSON data below. You can save this to a file and import it later.
              </p>
              
              <div class="relative">
                <textarea 
                  id="export-json" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-mono text-sm dark:bg-dark-900 dark:text-gray-300"
                  rows="10"
                  readonly
                >${jsonData}</textarea>
                
                <button 
                  id="copy-json-btn" 
                  class="absolute top-2 right-2 p-1.5 bg-gray-200 dark:bg-dark-600 rounded-md hover:bg-gray-300 dark:hover:bg-dark-500 transition-colors"
                  title="Copy to clipboard"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-12a2 2 0 00-2-2h-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                </button>
              </div>
              
              <p class="text-sm text-gray-500 dark:text-gray-400">
                To import this data later, go to "Import Tasks" in the sidebar.
              </p>
            </div>
          `;
          
          ui.showModal('Export Tasks', content, null, 'Close');
          
          // Add copy to clipboard functionality
          document.getElementById('copy-json-btn').addEventListener('click', () => {
            const exportJson = document.getElementById('export-json');
            exportJson.select();
            
            try {
              // Using the Clipboard API
              navigator.clipboard.writeText(exportJson.value)
                .then(() => {
                  ui.showToast('JSON copied to clipboard');
                })
                .catch(err => {
                  console.error('Failed to copy: ', err);
                  ui.showToast('Failed to copy to clipboard', 'error');
                });
            } catch (err) {
              console.error('Clipboard API not available: ', err);
              ui.showToast('Copy feature not available', 'error');
            }
          });
        },

        // Show import dialog
        showImportDialog: () => {
          const content = `
            <div class="space-y-4">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Paste your previously exported JSON data below to import your tasks and categories.
              </p>
              
              <div>
                <textarea 
                  id="import-json" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-dark-500 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-mono text-sm dark:bg-dark-900 dark:text-gray-300"
                  rows="10"
                  placeholder="Paste your JSON data here..."
                ></textarea>
              </div>
              
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Warning: This will overwrite your current data. Make sure to export your current data first if you want to keep it.
              </p>
            </div>
          `;
          
          ui.showModal('Import Tasks', content, () => {
            const importJsonElement = document.getElementById('import-json');
            const jsonText = importJsonElement.value.trim();
            
            if (!jsonText) {
              ui.showToast('Please paste JSON data to import', 'warning');
              return;
            }
            
            try {
              const importData = JSON.parse(jsonText);
              
              if (!importData.tasks || !importData.categories) {
                throw new Error('Invalid import data: missing tasks or categories');
              }
              
              // Import the data
              state.tasks = importData.tasks;
              state.categories = importData.categories;
              
              // Save to storage
              taskService.saveTasks(state.tasks);
              categoryService.saveCategories(state.categories);
              
              // Update UI
              ui.renderCategories();
              ui.renderTasks();
              
              ui.showToast('Data imported successfully');
            } catch (error) {
              console.error('Import error:', error);
              ui.showToast('Invalid JSON data. Please check the format and try again.', 'error');
            }
          }, 'Import');
        },

        // Confirm dialog for task deletion
        confirmDeleteTask: (taskId) => {
          const task = state.tasks.find(t => t.id === taskId);
          
          if (!task) {
            ui.showToast('Task not found', 'error');
            return;
          }
          
          const content = `
            <p>Are you sure you want to delete the task "<strong>${task.title}</strong>"?</p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
          `;
          
          ui.showModal('Delete Task', content, () => {
            // Delete the task
            const updatedTasks = taskService.deleteTask(taskId);
            state.tasks = updatedTasks;
            
            ui.showToast('Task deleted successfully');
            ui.renderTasks();
          }, 'Delete', 'Cancel', 'danger');
        },

        // Confirm dialog for category deletion
        confirmDeleteCategory: (categoryId) => {
          const category = state.categories.find(c => c.id === categoryId);
          
          if (!category) {
            ui.showToast('Category not found', 'error');
            return;
          }
          
          // Count tasks in this category
          const tasksInCategory = state.tasks.filter(t => t.categoryId === categoryId).length;
          
          const content = `
            <p>Are you sure you want to delete the category "<strong>${category.name}</strong>"?</p>
            ${tasksInCategory > 0 ? 
              `<p class="mt-2"><strong>${tasksInCategory}</strong> task${tasksInCategory !== 1 ? 's' : ''} will be moved to "No Category".</p>` : 
              ''
            }
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
          `;
          
          ui.showModal('Delete Category', content, () => {
            // Delete the category
            const updatedCategories = categoryService.deleteCategory(categoryId);
            state.categories = updatedCategories;
            
            // Update tasks that had this category
            state.tasks = taskService.getTasks();
            
            ui.showToast('Category deleted successfully');
            ui.renderCategories();
            ui.renderTasks();
          }, 'Delete', 'Cancel', 'danger');
        },

        // Render the task list
        renderTasks: () => {
          // Get the filtered and sorted tasks
          const { currentFilter, currentCategoryFilter, searchQuery, sortOption } = state.settings;
          
          // Filter tasks
          const filteredTasks = taskService.filterTasks(
            state.tasks, 
            currentFilter, 
            currentCategoryFilter,
            searchQuery
          );
          
          // Sort tasks
          const sortedTasks = helpers.sortTasks(filteredTasks, sortOption);
          
          // Select the container based on the current view
          const tasksContainer = elements.tasksContainer;
          const boardContainer = elements.boardContainer;
          const todoTasksColumn = document.getElementById('todo-tasks');
          const progressTasksColumn = document.getElementById('progress-tasks');
          const completedTasksColumn = document.getElementById('completed-tasks');
          
          // Update the empty state
          const emptyState = elements.emptyState;
          
          if (sortedTasks.length === 0) {
            tasksContainer.classList.add('hidden');
            boardContainer.classList.add('hidden');
            emptyState.classList.remove('hidden');
          } else {
            emptyState.classList.add('hidden');
            
            // Show the appropriate container based on view type
            if (state.settings.view === VIEW_TYPES.BOARD) {
              tasksContainer.classList.add('hidden');
              boardContainer.classList.remove('hidden');
              
              // Clear board columns
              todoTasksColumn.innerHTML = '';
              progressTasksColumn.innerHTML = '';
              completedTasksColumn.innerHTML = '';
              
              // Distribute tasks into columns
              sortedTasks.forEach(task => {
                let columnElement;
                
                if (task.completed) {
                  columnElement = completedTasksColumn;
                } else if (task.status === TASK_STATUS.PROGRESS) {
                  columnElement = progressTasksColumn;
                } else {
                  columnElement = todoTasksColumn;
                }
                
                columnElement.appendChild(ui.createBoardTaskItem(task));
              });
            } else {
              boardContainer.classList.add('hidden');
              tasksContainer.classList.remove('hidden');
              
              // Clear and populate the tasks container
              tasksContainer.innerHTML = '';
              
              sortedTasks.forEach(task => {
                tasksContainer.appendChild(
                  state.settings.view === VIEW_TYPES.COMPACT
                    ? ui.createCompactTaskItem(task)
                    : ui.createTaskItem(task)
                );
              });
            }
          }
          
          // Update counts
          ui.updateTaskCounts();
          
          // Update current view title
          ui.updateViewTitle();
        },

        // Create a task item for list view
        createTaskItem: (task) => {
          const taskElement = document.createElement('div');
          taskElement.className = `task-item rounded-lg bg-white dark:bg-dark-700 shadow-sm hover:shadow-md transition-all ${helpers.getTaskPriorityClass(task.priority)}`;
          taskElement.setAttribute('data-task-id', task.id);
          
          // Find the category if set
          const category = task.categoryId 
            ? state.categories.find(c => c.id === task.categoryId) 
            : null;
          
          // Format the date
          const formattedDate = task.dueDate ? helpers.formatDateRelative(task.dueDate) : '';
          const isOverdue = !task.completed && helpers.isOverdue(task.dueDate);
          
          taskElement.innerHTML = `
            <div class="p-4">
              <div class="flex items-start">
                <!-- Checkbox -->
                <div class="flex-shrink-0 pt-0.5">
                  <button class="task-checkbox w-5 h-5 rounded-full ${
                    task.completed 
                      ? 'bg-primary-600 dark:bg-primary-600 text-white' 
                      : 'border-2 border-gray-300 dark:border-gray-600'
                  } flex items-center justify-center transition-colors">
                    ${task.completed ? `
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 checkmark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                      </svg>
                    ` : ''}
                  </button>
                </div>
                
                <!-- Task content -->
                <div class="ml-3 flex-1">
                  <div class="flex flex-wrap items-center justify-between">
                    <h3 class="text-lg font-medium ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-gray-100'} transition-colors">
                      ${task.title}
                    </h3>
                    
                    <!-- Task actions -->
                    <div class="flex items-center ml-2">
                      <button class="edit-task-button p-1.5 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                      </button>
                      <button class="delete-task-button p-1.5 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  ${task.description ? `
                    <p class="mt-1 text-gray-600 dark:text-gray-400 ${task.completed ? 'line-through' : ''}">
                      ${task.description}
                    </p>
                  ` : ''}
                  
                  <div class="mt-3 flex flex-wrap items-center gap-2">
                    ${category ? `
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}20; color: ${category.color}">
                        ${category.name}
                      </span>
                    ` : ''}
                    
                    ${task.priority ? `
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${helpers.getPriorityColor(task.priority)}">
                        ${helpers.getPriorityLabel(task.priority)}
                      </span>
                    ` : ''}
                    
                    ${formattedDate ? `
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        isOverdue 
                          ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' 
                          : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                      }">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        ${formattedDate}
                      </span>
                    ` : ''}
                    
                    ${task.status === TASK_STATUS.PROGRESS ? `
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                        In Progress
                      </span>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Add event listeners
          const checkbox = taskElement.querySelector('.task-checkbox');
          checkbox.addEventListener('click', () => {
            taskService.toggleTaskCompleted(task.id);
            state.tasks = taskService.getTasks();
            ui.renderTasks();
          });
          
          const editButton = taskElement.querySelector('.edit-task-button');
          editButton.addEventListener('click', () => {
            ui.showTaskForm(task);
          });
          
          const deleteButton = taskElement.querySelector('.delete-task-button');
          deleteButton.addEventListener('click', () => {
            ui.confirmDeleteTask(task.id);
          });
          
          return taskElement;
        },

        // Create a task item for compact view
        createCompactTaskItem: (task) => {
          const taskElement = document.createElement('div');
          taskElement.className = `task-item rounded-lg bg-white dark:bg-dark-700 shadow-sm hover:shadow-md transition-all ${helpers.getTaskPriorityClass(task.priority)}`;
          taskElement.setAttribute('data-task-id', task.id);
          
          // Find the category if set
          const category = task.categoryId 
            ? state.categories.find(c => c.id === task.categoryId) 
            : null;
          
          // Format the date
          const formattedDate = task.dueDate ? helpers.formatDateRelative(task.dueDate) : '';
          const isOverdue = !task.completed && helpers.isOverdue(task.dueDate);
          
          taskElement.innerHTML = `
            <div class="p-3">
              <div class="flex items-center">
                <!-- Checkbox -->
                <button class="task-checkbox w-5 h-5 rounded-full ${
                  task.completed 
                    ? 'bg-primary-600 dark:bg-primary-600 text-white' 
                    : 'border-2 border-gray-300 dark:border-gray-600'
                } flex items-center justify-center transition-colors">
                  ${task.completed ? `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 checkmark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                  ` : ''}
                </button>
                
                <!-- Task content -->
                <div class="ml-3 flex-1 min-w-0">
                  <div class="flex items-center justify-between">
                    <h3 class="text-sm sm:text-base font-medium ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-gray-100'} transition-colors truncate">
                      ${task.title}
                    </h3>
                    
                    <!-- Task actions - only visible on hover/touch -->
                    <div class="flex items-center ml-2 opacity-0 group-hover:opacity-100 hover:opacity-100 focus-within:opacity-100 transition-opacity">
                      <button class="edit-task-button p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                      </button>
                      <button class="delete-task-button p-1 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  <div class="mt-1 flex flex-wrap items-center gap-1.5">
                    ${category ? `
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}20; color: ${category.color}">
                        ${category.name}
                      </span>
                    ` : ''}
                    
                    ${formattedDate ? `
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${
                        isOverdue 
                          ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' 
                          : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                      }">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        ${formattedDate}
                      </span>
                    ` : ''}
                    
                    ${task.status === TASK_STATUS.PROGRESS ? `
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                        In Progress
                      </span>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Add event listeners
          const checkbox = taskElement.querySelector('.task-checkbox');
          checkbox.addEventListener('click', () => {
            taskService.toggleTaskCompleted(task.id);
            state.tasks = taskService.getTasks();
            ui.renderTasks();
          });
          
          const editButton = taskElement.querySelector('.edit-task-button');
          editButton.addEventListener('click', () => {
            ui.showTaskForm(task);
          });
          
          const deleteButton = taskElement.querySelector('.delete-task-button');
          deleteButton.addEventListener('click', () => {
            ui.confirmDeleteTask(task.id);
          });
          
          return taskElement;
        },

        // Create a task item for board view
        createBoardTaskItem: (task) => {
          const taskElement = document.createElement('div');
          taskElement.className = `task-item rounded-lg bg-white dark:bg-dark-700 shadow-sm hover:shadow-md transition-all p-3`;
          taskElement.setAttribute('data-task-id', task.id);
          
          // Find the category if set
          const category = task.categoryId 
            ? state.categories.find(c => c.id === task.categoryId) 
            : null;
          
          // Format the date
          const formattedDate = task.dueDate ? helpers.formatDateRelative(task.dueDate) : '';
          const isOverdue = !task.completed && helpers.isOverdue(task.dueDate);
          
          taskElement.innerHTML = `
            <div class="flex justify-between items-start">
              <h3 class="text-sm font-medium ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-gray-100'} transition-colors">
                ${task.title}
              </h3>
              
              <div class="flex">
                <button class="edit-task-button p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>
                <button class="delete-task-button p-1 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors ml-0.5">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
            
            ${task.description ? `
              <p class="mt-1 text-xs text-gray-600 dark:text-gray-400 ${task.completed ? 'line-through' : ''}">
                ${task.description.length > 80 ? task.description.substring(0, 80) + '...' : task.description}
              </p>
            ` : ''}
            
            <div class="mt-2 flex flex-wrap items-center gap-1.5">
              <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${helpers.getPriorityColor(task.priority)}">
                ${helpers.getPriorityLabel(task.priority)}
              </span>
              
              ${category ? `
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}20; color: ${category.color}">
                  ${category.name}
                </span>
              ` : ''}
              
              ${formattedDate ? `
                <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${
                  isOverdue 
                    ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' 
                    : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                }">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  ${formattedDate}
                </span>
              ` : ''}
            </div>
          `;
          
          // Add event listeners
          const editButton = taskElement.querySelector('.edit-task-button');
          editButton.addEventListener('click', () => {
            ui.showTaskForm(task);
          });
          
          const deleteButton = taskElement.querySelector('.delete-task-button');
          deleteButton.addEventListener('click', () => {
            ui.confirmDeleteTask(task.id);
          });
          
          return taskElement;
        },

        // Render the categories list
        renderCategories: () => {
          const categoryList = elements.categoryList;
          categoryList.innerHTML = '';
          
          state.categories.forEach(category => {
            const categoryElement = document.createElement('li');
            categoryElement.setAttribute('data-category-id', category.id);
            
            // Check if this category is currently selected
            const isSelected = state.settings.currentCategoryFilter === category.id;
            
            categoryElement.innerHTML = `
              <button class="category-button w-full flex items-center px-3 py-2 rounded-md ${
                isSelected 
                  ? 'bg-primary-50 dark:bg-primary-900/40 text-primary-800 dark:text-primary-200 font-medium' 
                  : 'text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-600'
              } transition-colors group">
                <span class="w-3 h-3 rounded-full mr-3" style="background-color: ${category.color};"></span>
                <span class="flex-1 truncate">${category.name}</span>
                
                <div class="flex items-center ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button class="edit-category-button p-1 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                  </button>
                  <button class="delete-category-button p-1 text-gray-400 hover:text-red-500 dark:text-gray-500 dark:hover:text-red-400 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 transition-colors ml-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                  </button>
                </div>
                
                <span class="ml-auto ${
                  isSelected 
                    ? 'bg-primary-100 dark:bg-primary-800 text-primary-800 dark:text-primary-200' 
                    : 'bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-300'
                } px-2 py-0.5 rounded-full text-xs font-medium category-count">
                  ${state.tasks.filter(task => task.categoryId === category.id).length}
                </span>
              </button>
            `;
            
            // Add event listeners
            const categoryButton = categoryElement.querySelector('.category-button');
            categoryButton.addEventListener('click', (e) => {
              // Ignore clicks on the edit and delete buttons
              if (e.target.closest('.edit-category-button') || e.target.closest('.delete-category-button')) {
                return;
              }
              
              // Toggle category filter
              const currentFilter = state.settings.currentCategoryFilter;
              const newFilter = currentFilter === category.id ? null : category.id;
              
              state.settings.currentCategoryFilter = newFilter;
              if (newFilter) {
                // When selecting a category, always reset to "All" filter
                state.settings.currentFilter = FILTER_TYPES.ALL;
              }
              
              // Save settings
              settingsService.updateSettings(state.settings);
              
              // Update UI
              ui.updateFilterButtons();
              ui.renderCategories();
              ui.renderTasks();
            });
            
            const editCategoryButton = categoryElement.querySelector('.edit-category-button');
            editCategoryButton.addEventListener('click', () => {
              ui.showCategoryForm(category);
            });
            
            const deleteCategoryButton = categoryElement.querySelector('.delete-category-button');
            deleteCategoryButton.addEventListener('click', () => {
              ui.confirmDeleteCategory(category.id);
            });
            
            categoryList.appendChild(categoryElement);
          });
          
          // If no categories, show a message
          if (state.categories.length === 0) {
            const emptyElement = document.createElement('li');
            emptyElement.innerHTML = `
              <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-2">
                No categories yet
              </p>
            `;
            categoryList.appendChild(emptyElement);
          }
        },

        // Update task counts in the sidebar
        updateTaskCounts: () => {
          // Total count
          const totalTasks = state.tasks.length;
          document.getElementById('total-tasks-count').textContent = totalTasks;
          
          // Count by filter type
          const allTasksCount = state.tasks.length;
          const todayTasksCount = state.tasks.filter(task => helpers.isToday(task.dueDate)).length;
          const upcomingTasksCount = state.tasks.filter(task => helpers.isUpcoming(task.dueDate)).length;
          const importantTasksCount = state.tasks.filter(task => task.priority === PRIORITY_LEVELS.HIGH).length;
          const completedTasksCount = state.tasks.filter(task => task.completed).length;
          
          // Update the count elements
          document.getElementById('all-tasks-count').textContent = allTasksCount;
          document.getElementById('today-tasks-count').textContent = todayTasksCount;
          document.getElementById('upcoming-tasks-count').textContent = upcomingTasksCount;
          document.getElementById('important-tasks-count').textContent = importantTasksCount;
          document.getElementById('completed-tasks-count').textContent = completedTasksCount;
          
          // Count of displayed tasks
          const currentlyDisplayedTasks = taskService.filterTasks(
            state.tasks, 
            state.settings.currentFilter, 
            state.settings.currentCategoryFilter,
            state.settings.searchQuery
          ).length;
          
          document.getElementById('displayed-tasks-count').textContent = currentlyDisplayedTasks;
        },

        // Update the current view title
        updateViewTitle: () => {
          const titleElement = document.getElementById('current-view-title');
          
          if (state.settings.currentCategoryFilter) {
            // If filtering by category, show the category name
            const category = state.categories.find(c => c.id === state.settings.currentCategoryFilter);
            if (category) {
              titleElement.innerHTML = `
                <span class="inline-flex items-center">
                  <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color};"></span>
                  ${category.name}
                </span>
              `;
            }
          } else {
            // Otherwise show the filter name
            const filterTitles = {
              [FILTER_TYPES.ALL]: 'All Tasks',
              [FILTER_TYPES.TODAY]: 'Today',
              [FILTER_TYPES.UPCOMING]: 'Upcoming',
              [FILTER_TYPES.IMPORTANT]: 'Important',
              [FILTER_TYPES.COMPLETED]: 'Completed',
            };
            
            titleElement.textContent = filterTitles[state.settings.currentFilter] || 'Tasks';
          }
          
          // If there's a search query, indicate that
          if (state.settings.searchQuery) {
            titleElement.textContent += `  Search: "${state.settings.searchQuery}"`;
          }
        },

        // Update filter buttons in the sidebar
        updateFilterButtons: () => {
          const filterButtons = document.querySelectorAll('.filter-button');
          
          filterButtons.forEach(button => {
            const filterType = button.getAttribute('data-filter');
            const isActive = state.settings.currentFilter === filterType && !state.settings.currentCategoryFilter;
            
            // Update the active state
            if (isActive) {
              button.classList.add('bg-primary-50', 'dark:bg-primary-900/40', 'text-primary-800', 'dark:text-primary-200', 'font-medium');
              button.classList.remove('text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-100', 'dark:hover:bg-dark-600');
              
              // Also update the count badge
              const countBadge = button.querySelector('span:last-child');
              if (countBadge) {
                countBadge.classList.remove('bg-gray-100', 'dark:bg-dark-600', 'text-gray-600', 'dark:text-gray-300');
                countBadge.classList.add('bg-primary-100', 'dark:bg-primary-800', 'text-primary-800', 'dark:text-primary-200');
              }
            } else {
              button.classList.remove('bg-primary-50', 'dark:bg-primary-900/40', 'text-primary-800', 'dark:text-primary-200', 'font-medium');
              button.classList.add('text-gray-700', 'dark:text-gray-200', 'hover:bg-gray-100', 'dark:hover:bg-dark-600');
              
              // Also update the count badge
              const countBadge = button.querySelector('span:last-child');
              if (countBadge) {
                countBadge.classList.add('bg-gray-100', 'dark:bg-dark-600', 'text-gray-600', 'dark:text-gray-300');
                countBadge.classList.remove('bg-primary-100', 'dark:bg-primary-800', 'text-primary-800', 'dark:text-primary-200');
              }
            }
          });
        },

        // Update the user interface based on the current user
        updateUserUI: () => {
          const userAvatar = document.querySelector('.user-avatar');
          const userDisplayName = document.querySelector('.user-display-name');
          
          if (state.currentUser) {
            // Update avatar with initials
            userAvatar.textContent = helpers.getInitials(state.currentUser.displayName || state.currentUser.username);
            
            // Update display name
            userDisplayName.textContent = state.currentUser.displayName || state.currentUser.username;
          } else {
            // Default for not logged in
            userAvatar.textContent = '?';
            userDisplayName.textContent = 'Guest';
          }
        },

        // Load user-specific data
        loadUserData: () => {
          // Load tasks and categories from storage
          state.tasks = taskService.getTasks();
          state.categories = categoryService.getCategories();
          
          // Load settings
          state.settings = settingsService.getSettings();
          
          // Render UI
          ui.renderCategories();
          ui.renderTasks();
          ui.updateFilterButtons();
        },

        // Initialize data for a new user
        initializeUserData: () => {
          // Create default categories
          const defaultCategories = [
            { name: 'Work', color: '#5D5CDE' },
            { name: 'Personal', color: '#10B981' },
            { name: 'Shopping', color: '#F59E0B' },
            { name: 'Health', color: '#EC4899' },
          ];
          
          state.categories = [];
          defaultCategories.forEach(category => {
            const newCategory = categoryService.addCategory(category);
            state.categories.push(newCategory);
          });
          
          // Create sample tasks
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          const sampleTasks = [
            {
              title: 'Welcome to TaskMaster Pro',
              description: 'This is a sample task to help you get started. You can edit or delete it.',
              priority: PRIORITY_LEVELS.MEDIUM,
              categoryId: state.categories[1].id, // Personal
              dueDate: today.toISOString()
            },
            {
              title: 'Create your first task',
              description: 'Click the "New Task" button to create your own task.',
              priority: PRIORITY_LEVELS.HIGH,
              categoryId: state.categories[0].id, // Work
              dueDate: tomorrow.toISOString()
            },
            {
              title: 'Explore the sidebar',
              description: 'Use the sidebar to filter tasks and manage categories.',
              priority: PRIORITY_LEVELS.LOW,
              categoryId: state.categories[1].id, // Personal
            },
          ];
          
          state.tasks = [];
          sampleTasks.forEach(task => {
            const newTask = taskService.addTask(task);
            state.tasks.push(newTask);
          });
          
          // Set up default settings
          state.settings = settingsService.getSettings();
          
          // Render UI
          ui.renderCategories();
          ui.renderTasks();
          ui.updateFilterButtons();
        },

        // Initialize the app UI
        initUI: () => {
          // Set up theme based on user preference or settings
          if (state.settings.theme === 'dark') {
            document.documentElement.classList.add('dark');
          } else if (state.settings.theme === 'light') {
            document.documentElement.classList.remove('dark');
          }
          
          // Check if logged in and show appropriate UI
          if (userService.isAuthenticated()) {
            state.currentUser = userService.getCurrentUser();
            ui.updateUserUI();
            ui.loadUserData();
          } else {
            // Show login form for first-time users
            setTimeout(() => {
              ui.showAuthForm(true);
            }, 500);
          }
          
          // Setup event listeners for UI components
          ui.setupEventListeners();
          
          // Hide loading overlay
          setTimeout(() => {
            elements.loadingOverlay.classList.add('opacity-0');
            setTimeout(() => {
              elements.loadingOverlay.classList.add('hidden');
            }, 300);
          }, 800);
        },

        // Set up all event listeners
        setupEventListeners: () => {
          // Theme toggle
          elements.themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            state.settings.theme = isDarkMode ? 'dark' : 'light';
            settingsService.updateSettings(state.settings);
          });
          
          // Sidebar toggle (for mobile)
          elements.sidebarToggle.addEventListener('click', () => {
            elements.sidebar.classList.toggle('-translate-x-full');
            elements.sidebar.classList.toggle('translate-x-0');
            
            // Add backdrop for mobile
            if (elements.sidebar.classList.contains('translate-x-0')) {
              const backdrop = document.createElement('div');
              backdrop.id = 'sidebar-backdrop';
              backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-10 lg:hidden';
              document.body.appendChild(backdrop);
              
              backdrop.addEventListener('click', () => {
                elements.sidebar.classList.remove('translate-x-0');
                elements.sidebar.classList.add('-translate-x-full');
                backdrop.remove();
              });
            } else {
              const backdrop = document.getElementById('sidebar-backdrop');
              if (backdrop) backdrop.remove();
            }
          });
          
          // User menu toggle
          elements.userMenuButton.addEventListener('click', () => {
            const dropdown = elements.userDropdown;
            const isHidden = dropdown.classList.contains('opacity-0');
            
            if (isHidden) {
              dropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
              dropdown.classList.add('opacity-100', 'scale-100');
              
              // Add click outside listener
              const closeDropdown = (e) => {
                if (!elements.userMenu.contains(e.target)) {
                  dropdown.classList.remove('opacity-100', 'scale-100');
                  dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                  document.removeEventListener('click', closeDropdown);
                }
              };
              
              // Delay adding the event listener slightly to avoid immediate trigger
              setTimeout(() => {
                document.addEventListener('click', closeDropdown);
              }, 10);
            } else {
              dropdown.classList.remove('opacity-100', 'scale-100');
              dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
          });
          
          // Logout button
          elements.logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            
            userService.logout();
            state.currentUser = null;
            
            // Reset UI
            ui.updateUserUI();
            ui.showToast('Logged out successfully');
            
            // Show login form
            setTimeout(() => {
              ui.showAuthForm(true);
            }, 300);
          });
          
          // Add new task button
          elements.addTaskButton.addEventListener('click', () => {
            ui.showTaskForm();
          });
          
          // Add new task button in empty state
          elements.emptyAddTaskButton.addEventListener('click', () => {
            ui.showTaskForm();
          });
          
          // Add new category button
          elements.addCategoryButton.addEventListener('click', () => {
            ui.showCategoryForm();
          });
          
          // Export button
          elements.exportButton.addEventListener('click', () => {
            ui.showExportDialog();
          });
          
          // Import button
          elements.importButton.addEventListener('click', () => {
            ui.showImportDialog();
          });
          
          // Filter buttons
          document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', () => {
              const filterType = button.getAttribute('data-filter');
              
              state.settings.currentFilter = filterType;
              state.settings.currentCategoryFilter = null;
              
              // Save settings
              settingsService.updateSettings(state.settings);
              
              // Update UI
              ui.updateFilterButtons();
              ui.renderCategories();
              ui.renderTasks();
            });
          });
          
          // Sort button and dropdown
          elements.sortButton.addEventListener('click', () => {
            const dropdown = elements.sortDropdown;
            const isHidden = dropdown.classList.contains('opacity-0');
            
            if (isHidden) {
              dropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
              dropdown.classList.add('opacity-100', 'scale-100');
              
              // Add click outside listener
              const closeDropdown = (e) => {
                if (!elements.sortButton.contains(e.target)) {
                  dropdown.classList.remove('opacity-100', 'scale-100');
                  dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                  document.removeEventListener('click', closeDropdown);
                }
              };
              
              // Delay adding the event listener slightly to avoid immediate trigger
              setTimeout(() => {
                document.addEventListener('click', closeDropdown);
              }, 10);
            } else {
              dropdown.classList.remove('opacity-100', 'scale-100');
              dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
          });
          
          // Sort options
          document.querySelectorAll('.sort-option').forEach(option => {
            option.addEventListener('click', () => {
              const sortField = option.getAttribute('data-sort');
              const sortOrder = option.getAttribute('data-order');
              
              state.settings.sortOption = { field: sortField, order: sortOrder };
              settingsService.updateSettings(state.settings);
              
              elements.sortDropdown.classList.remove('opacity-100', 'scale-100');
              elements.sortDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
              
              ui.renderTasks();
            });
          });
          
          // View button and dropdown
          elements.viewButton.addEventListener('click', () => {
            const dropdown = elements.viewDropdown;
            const isHidden = dropdown.classList.contains('opacity-0');
            
            if (isHidden) {
              dropdown.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
              dropdown.classList.add('opacity-100', 'scale-100');
              
              // Add click outside listener
              const closeDropdown = (e) => {
                if (!elements.viewButton.contains(e.target)) {
                  dropdown.classList.remove('opacity-100', 'scale-100');
                  dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                  document.removeEventListener('click', closeDropdown);
                }
              };
              
              // Delay adding the event listener slightly to avoid immediate trigger
              setTimeout(() => {
                document.addEventListener('click', closeDropdown);
              }, 10);
            } else {
              dropdown.classList.remove('opacity-100', 'scale-100');
              dropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
          });
          
          // View options
          document.querySelectorAll('.view-option').forEach(option => {
            option.addEventListener('click', () => {
              const viewType = option.getAttribute('data-view');
              
              state.settings.view = viewType;
              settingsService.updateSettings(state.settings);
              
              elements.viewDropdown.classList.remove('opacity-100', 'scale-100');
              elements.viewDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
              
              ui.renderTasks();
            });
          });
          
          // Search input
          elements.searchInput.addEventListener('input', helpers.debounce((e) => {
            const query = e.target.value.trim();
            
            state.settings.searchQuery = query;
            settingsService.updateSettings(state.settings);
            
            ui.renderTasks();
          }, 300));
          
          // Keyboard shortcuts
          document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N for new task
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
              e.preventDefault();
              ui.showTaskForm();
            }
            
            // Escape to close modals and dropdowns
            if (e.key === 'Escape') {
              // Close dropdowns
              elements.sortDropdown.classList.remove('opacity-100', 'scale-100');
              elements.sortDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
              
              elements.viewDropdown.classList.remove('opacity-100', 'scale-100');
              elements.viewDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
              
              elements.userDropdown.classList.remove('opacity-100', 'scale-100');
              elements.userDropdown.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
              
              // Close sidebar on mobile
              if (window.innerWidth < 1024 && elements.sidebar.classList.contains('translate-x-0')) {
                elements.sidebar.classList.remove('translate-x-0');
                elements.sidebar.classList.add('-translate-x-full');
                const backdrop = document.getElementById('sidebar-backdrop');
                if (backdrop) backdrop.remove();
              }
            }
            
            // Ctrl/Cmd + / for search focus
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
              e.preventDefault();
              elements.searchInput.focus();
            }
          });
        }
      };

      // Initialize function
      function init() {
        // Store DOM elements
        elements = {
          app: document.getElementById('app'),
          loadingOverlay: document.getElementById('loading-overlay'),
          toastContainer: document.getElementById('toast-container'),
          modalContainer: document.getElementById('modal-container'),
          modalOverlay: document.getElementById('modal-overlay'),
          modalContent: document.getElementById('modal-content'),
          sidebar: document.getElementById('sidebar'),
          sidebarToggle: document.getElementById('sidebar-toggle'),
          tasksContainer: document.getElementById('tasks-container'),
          boardContainer: document.getElementById('board-container'),
          emptyState: document.getElementById('empty-state'),
          userMenu: document.getElementById('user-menu'),
          userMenuButton: document.getElementById('user-menu-button'),
          userDropdown: document.getElementById('user-dropdown'),
          logoutButton: document.getElementById('logout-button'),
          themeToggle: document.getElementById('theme-toggle'),
          addTaskButton: document.getElementById('add-task-button'),
          emptyAddTaskButton: document.getElementById('empty-add-task-button'),
          categoryList: document.getElementById('category-list'),
          addCategoryButton: document.getElementById('add-category-button'),
          exportButton: document.getElementById('export-button'),
          importButton: document.getElementById('import-button'),
          searchInput: document.getElementById('search-input'),
          sortButton: document.getElementById('sort-button'),
          sortDropdown: document.getElementById('sort-dropdown'),
          viewButton: document.getElementById('view-button'),
          viewDropdown: document.getElementById('view-dropdown'),
        };
        
        // Load user if logged in
        state.currentUser = userService.getCurrentUser();
        
        // Load settings
        state.settings = settingsService.getSettings();
        
        // Initialize UI
        ui.initUI();
      }

      // Public API
      return {
        init
      };
    })();

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      TodoApp.init();
    });
  </script>
</body>
</html>
