<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern To-Do App</title>
    
    <!-- External Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #5D5CDE;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #DC3545;
            --medium: #FD7E14;
            --gray: #6C757D;
            --dark: #212529;
            --light: #F8F9FA;
            --white: #FFFFFF;
            --black: #181818;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.35);
            --shadow-light: 0 4px 12px rgba(255, 255, 255, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
            --border: 1px solid rgba(0, 0, 0, 0.125);
            --border-dark: 1px solid rgba(255, 255, 255, 0.125);
            --font-family: 'Poppins', sans-serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        
        html, body {
            height: 100%;
            width: 100%;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark);
            transition: var(--transition);
            overflow-x: hidden;
        }
        
        body.dark {
            background-color: var(--black);
            color: var(--white);
        }
        
        /* Login Page Styles */
        .login-container {
            height: 100vh;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(145deg, #1C2526, #000000);
            transition: var(--transition);
        }
        
        body.dark .login-container {
            background: linear-gradient(145deg, #8B0000, #4B0000);
        }
        
        .login-form {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            animation: fadeIn 0.5s ease;
        }
        
        body.dark .login-form {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: var(--border);
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--white);
            color: var(--dark);
        }
        
        body.dark .form-input {
            background-color: #2a2a2a;
            border: var(--border-dark);
            color: var(--white);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, var(--primary), #7A79E0);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            font-size: 16px;
        }
        
        .login-btn:before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            z-index: -1;
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 400%;
            border-radius: 10px;
            opacity: 0;
            transition: 0.5s;
            animation: animate 8s linear infinite;
        }
        
        .login-btn:hover:before {
            opacity: 1;
            filter: blur(20px);
        }
        
        .login-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.5);
        }
        
        .login-btn:active {
            transform: scale(0.98);
        }
        
        .register-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
        }
        
        .register-link a {
            color: #00008B;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            transition: var(--transition);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        body.dark .modal {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--danger);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-gray {
            background-color: var(--gray);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        /* Dashboard Styles */
        .dashboard {
            min-height: 100vh;
            display: none;
            flex-direction: column;
            transition: var(--transition);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: relative;
            z-index: 10;
            transition: var(--transition);
        }
        
        body.dark .header {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .app-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .work-timer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 0 0 8px 8px;
            font-weight: 500;
            box-shadow: var(--shadow);
        }
        
        .task-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        .profile-container {
            position: relative;
        }
        
        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--primary);
            transition: var(--transition);
        }
        
        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success);
            border: 2px solid var(--white);
        }
        
        body.dark .status-indicator {
            border-color: var(--dark);
        }
        
        .notification-badge {
            position: relative;
            cursor: pointer;
        }
        
        .notification-icon {
            font-size: 1.25rem;
            color: var(--gray);
            transition: var(--transition);
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .theme-toggle {
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--gray);
            transition: var(--transition);
        }
        
        .theme-toggle:hover, .notification-icon:hover {
            color: var(--primary);
        }
        
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 200px;
            z-index: 100;
            overflow: hidden;
            transform-origin: top right;
            transform: scale(0);
            opacity: 0;
            transition: var(--transition);
        }
        
        body.dark .profile-dropdown {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .profile-dropdown.active {
            transform: scale(1);
            opacity: 1;
        }
        
        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        body.dark .dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .dropdown-icon {
            font-size: 1rem;
            color: var(--primary);
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            transform-origin: top right;
            transform: scale(0);
            opacity: 0;
            transition: var(--transition);
        }
        
        body.dark .notification-dropdown {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .notification-dropdown.active {
            transform: scale(1);
            opacity: 1;
        }
        
        .notification-header {
            padding: 1rem;
            border-bottom: var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark .notification-header {
            border-bottom: var(--border-dark);
        }
        
        .notification-title {
            font-weight: 600;
            margin: 0;
        }
        
        .mark-all-read {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .mark-all-read:hover {
            text-decoration: underline;
        }
        
        .notification-list {
            padding: 0.5rem 0;
        }
        
        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        body.dark .notification-item {
            border-bottom: var(--border-dark);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        body.dark .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .notification-item:hover {
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        body.dark .notification-item:hover {
            background-color: rgba(93, 92, 222, 0.15);
        }
        
        .notification-content {
            margin-bottom: 0.25rem;
        }
        
        .notification-time {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            transition: var(--transition);
        }
        
        /* Summary Section */
        .summary-section {
            margin-bottom: 2rem;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .total-tasks-card {
                grid-column: 1 / -1;
            }
        }
        
        .summary-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }
        
        body.dark .summary-card {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        body.dark .summary-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }
        
        .total-tasks-card {
            background-color: var(--primary);
            color: white;
        }
        
        .completed-tasks-card {
            border-left: 5px solid var(--success);
        }
        
        .pending-tasks-card {
            border-left: 5px solid var(--warning);
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* Insights Section */
        .insights-section {
            margin-bottom: 2rem;
        }
        
        .insights-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        body.dark .insights-card {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .insights-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        
        .insight-item {
            padding: 1rem;
            border-radius: 8px;
            background-color: rgba(93, 92, 222, 0.1);
            transition: var(--transition);
        }
        
        body.dark .insight-item {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .insight-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        body.dark .insight-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .insight-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }
        
        .insight-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        /* Tasks Section */
        .tasks-section {
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            margin: 0;
        }
        
        .section-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        /* Filters Section */
        .filters-section {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            transition: var(--transition);
        }
        
        body.dark .filters-section {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .filter-select {
            padding: 0.6rem;
            border-radius: 8px;
            border: var(--border);
            background-color: var(--white);
            font-size: 16px;
            transition: var(--transition);
        }
        
        body.dark .filter-select {
            background-color: #2a2a2a;
            border: var(--border-dark);
            color: var(--white);
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            border-radius: 8px;
            border: var(--border);
            width: 100%;
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--white);
        }
        
        body.dark .search-input {
            background-color: #2a2a2a;
            border: var(--border-dark);
            color: var(--white);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        /* View Switcher */
        .view-switcher {
            display: flex;
            align-items: center;
            background-color: var(--light);
            border-radius: 20px;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
            width: max-content;
            transition: var(--transition);
        }
        
        body.dark .view-switcher {
            background-color: #333;
        }
        
        .view-option {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .view-option.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* Tasks List */
        .tasks-container {
            display: block;
        }
        
        .tasks-list {
            display: grid;
            gap: 1rem;
        }
        
        .task-item {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: var(--transition);
            position: relative;
            animation: fadeIn 0.3s ease;
            border-left: 5px solid transparent;
        }
        
        body.dark .task-item {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .task-item.completed {
            border-left-color: var(--success);
        }
        
        .task-item.expired {
            border-left-color: var(--danger);
        }
        
        .task-item.due-soon {
            border-left-color: var(--warning);
        }
        
        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .task-checkbox.checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .task-checkbox.checked i {
            color: white;
            opacity: 1;
        }
        
        .task-checkbox i {
            opacity: 0;
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .task-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
            transition: var(--transition);
        }
        
        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--gray);
        }
        
        .task-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--gray);
        }
        
        .task-description {
            margin: 0.5rem 0;
            font-size: 0.875rem;
            color: var(--gray);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .task-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .task-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary);
            transition: var(--transition);
        }
        
        body.dark .task-tag {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        .priority-tag {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .priority-high {
            color: var(--danger);
        }
        
        .priority-medium {
            color: var(--medium);
        }
        
        .priority-low {
            color: var(--gray);
        }
        
        .task-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .task-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--light);
            color: var(--gray);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }
        
        body.dark .task-action-btn {
            background-color: #333;
            color: #eee;
        }
        
        .task-action-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .task-action-btn.play-btn {
            background-color: var(--success);
            color: white;
        }
        
        .task-action-btn.play-btn:hover {
            background-color: #249c3d;
        }
        
        .task-timer-display {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--primary);
            margin-left: 0.5rem;
        }
        
        /* Graph View */
        .graphs-container {
            display: none;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .graphs-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .graph-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        body.dark .graph-card {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .graph-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        /* Multi-select Actions */
        .multi-actions-bar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: linear-gradient(45deg, var(--primary), #7A79E0);
            border-radius: var(--border-radius);
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            box-shadow: var(--shadow);
            z-index: 100;
            transition: var(--transition);
        }
        
        .multi-actions-bar.active {
            transform: translateX(-50%) translateY(0);
        }
        
        .selected-count {
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .toast {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
            width: 300px;
            max-width: 90vw;
            transition: var(--transition);
        }
        
        body.dark .toast {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        
        .toast-success .toast-icon {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success);
        }
        
        .toast-warning .toast-icon {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }
        
        .toast-error .toast-icon {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: var(--gray);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            padding: 0.25rem;
        }
        
        .toast-close:hover {
            color: var(--danger);
        }
        
        /* Users Grid */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .user-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }
        
        body.dark .user-card {
            background-color: var(--dark);
            box-shadow: var(--shadow-dark);
        }
        
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        body.dark .user-card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }
        
        .user-info {
            text-align: center;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .user-email {
            font-size: 0.875rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }
        
        .user-role {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary);
        }
        
        body.dark .user-role {
            background-color: rgba(93, 92, 222, 0.2);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes animate {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 400% 0;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .app-title {
                font-size: 1.25rem;
            }
            
            .header-actions {
                gap: 1rem;
            }
            
            .main-content {
                padding: 1.5rem 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-item {
                grid-template-columns: 1fr;
            }
            
            .task-checkbox {
                grid-row: 1;
                grid-column: 1;
                justify-self: start;
            }
            
            .task-content {
                grid-row: 2;
                grid-column: 1;
            }
            
            .task-actions {
                grid-row: 3;
                grid-column: 1;
                justify-self: center;
                margin-top: 1rem;
            }
        }
        
        /* Loading spinner */
        .loader {
            border: 4px solid rgba(93, 92, 222, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Modal loader */
        .modal-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
        }
        
        /* Category management */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .category-card {
            background-color: var(--light);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        body.dark .category-card {
            background-color: #333;
        }
        
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        body.dark .category-card:hover {
            box-shadow: var(--shadow-dark);
        }
        
        .category-name {
            font-weight: 500;
        }
        
        .category-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .category-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }
        
        .category-btn:hover {
            color: var(--primary);
        }
        
        .category-btn.delete-btn:hover {
            color: var(--danger);
        }
        
        .add-category-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .add-category-input {
            flex: 1;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            border: var(--border);
            font-size: 16px;
            transition: var(--transition);
        }
        
        body.dark .add-category-input {
            background-color: #2a2a2a;
            border: var(--border-dark);
            color: var(--white);
        }
        
        .add-category-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Form grid for add task/edit task */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-grid .form-group:last-child {
                grid-column: 1 / -1;
            }
        }
        
        /* Sub-tasks */
        .sub-tasks-list {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .sub-task-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sub-task-input {
            flex: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: var(--border);
            font-size: 16px;
            transition: var(--transition);
        }
        
        body.dark .sub-task-input {
            background-color: #2a2a2a;
            border: var(--border-dark);
            color: var(--white);
        }
        
        .sub-task-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }
        
        .sub-task-remove {
            background-color: var(--danger);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .sub-task-remove:hover {
            background-color: #c82333;
        }
        
        .add-sub-task-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            transition: var(--transition);
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .add-sub-task-btn:hover {
            text-decoration: underline;
        }
        
        /* Profile View */
        .profile-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        
        .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .avatar-edit:hover {
            transform: scale(1.1);
        }
        
        .profile-info {
            width: 100%;
        }
        
        .profile-info-item {
            margin-bottom: 1rem;
        }
        
        .profile-info-label {
            font-weight: 500;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }
        
        .profile-info-value {
            font-weight: 600;
        }
        
        /* File Input */
        .file-input-container {
            position: relative;
            margin-top: 1rem;
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        .file-input-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            background-color: var(--primary);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            width: fit-content;
        }
        
        .file-input-label:hover {
            background-color: #4847c9;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container">
        <div class="login-form">
            <h2 class="form-title">Welcome to Task Manager</h2>
            <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input type="email" id="email" class="form-input" value="test@example.com" aria-label="Email">
            </div>
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" id="password" class="form-input" value="123456" aria-label="Password">
            </div>
            <button id="login-btn" class="login-btn" aria-label="Login">Login</button>
            <div class="register-link">
                Don't have an account? <a href="#" id="register-link">Register now</a>
            </div>
        </div>
    </div>
    
    <!-- Registration Modal -->
    <div class="modal-overlay" id="register-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create an Account</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="register-firstname" class="form-label">First Name</label>
                    <input type="text" id="register-firstname" class="form-input" aria-label="First Name">
                </div>
                <div class="form-group">
                    <label for="register-lastname" class="form-label">Last Name</label>
                    <input type="text" id="register-lastname" class="form-input" aria-label="Last Name">
                </div>
                <div class="form-group">
                    <label for="register-email" class="form-label">Email</label>
                    <input type="email" id="register-email" class="form-input" aria-label="Email">
                </div>
                <div class="form-group">
                    <label for="register-confirmemail" class="form-label">Confirm Email</label>
                    <input type="email" id="register-confirmemail" class="form-input" aria-label="Confirm Email">
                </div>
                <div class="form-group">
                    <label for="register-password" class="form-label">Password</label>
                    <input type="password" id="register-password" class="form-input" aria-label="Password">
                </div>
                <div class="form-group">
                    <label for="register-confirmpassword" class="form-label">Confirm Password</label>
                    <input type="password" id="register-confirmpassword" class="form-input" aria-label="Confirm Password">
                </div>
                <div class="form-group">
                    <label for="register-birthdate" class="form-label">Birthdate</label>
                    <input type="text" id="register-birthdate" class="form-input" aria-label="Birthdate">
                </div>
                <div class="form-group">
                    <label for="register-nationality" class="form-label">Nationality</label>
                    <select id="register-nationality" class="form-input" aria-label="Nationality">
                        <option value="">Select your country</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-role" class="form-label">Role</label>
                    <select id="register-role" class="form-input" aria-label="Role">
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="register-cancel">Cancel</button>
                <button class="btn btn-success" id="register-create">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard">
        <header class="header">
            <h1 class="app-title">To-Do App</h1>
            <div class="work-timer" id="work-timer">00:00:00</div>
            <div class="header-actions">
                <button class="btn btn-primary" id="users-btn" aria-label="View Users">
                    <i class="fas fa-users"></i> Users
                </button>
                <div class="task-timer" id="task-timer">
                    <i class="fas fa-stopwatch"></i>
                    <span id="task-timer-display">00:00:00</span>
                </div>
                <div class="notification-badge" id="notification-badge">
                    <i class="fas fa-bell notification-icon"></i>
                    <span class="notification-count">0</span>
                    
                    <!-- Notification Dropdown -->
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-header">
                            <h3 class="notification-title">Notifications</h3>
                            <button class="mark-all-read" id="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <!-- Notifications will be added here -->
                        </div>
                    </div>
                </div>
                <div class="theme-toggle" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="profile-container">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-img" id="profile-img">
                    <span class="status-indicator"></span>
                    
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="dropdown-item" id="view-profile">
                            <i class="fas fa-user dropdown-icon"></i>
                            <span>View Profile</span>
                        </div>
                        <div class="dropdown-item" id="switch-mode">
                            <i class="fas fa-moon dropdown-icon"></i>
                            <span>Switch Mode</span>
                        </div>
                        <div class="dropdown-item" id="logout">
                            <i class="fas fa-sign-out-alt dropdown-icon"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <main class="main-content">
            <!-- Summary Section -->
            <section class="summary-section">
                <div class="summary-cards">
                    <div class="summary-card total-tasks-card">
                        <div class="card-title">Total Tasks</div>
                        <div class="card-value" id="total-tasks-count">0</div>
                    </div>
                    <div class="summary-card completed-tasks-card">
                        <div class="card-title">Completed Tasks</div>
                        <div class="card-value" id="completed-tasks-count">0</div>
                    </div>
                    <div class="summary-card pending-tasks-card">
                        <div class="card-title">Pending Tasks</div>
                        <div class="card-value" id="pending-tasks-count">0</div>
                    </div>
                </div>
            </section>
            
            <!-- Insights Section -->
            <section class="insights-section">
                <div class="insights-card">
                    <h2 class="insights-title">Insights</h2>
                    <div class="insights-grid" id="insights-grid">
                        <div class="insight-item">
                            <div class="insight-label">Completed Tasks</div>
                            <div class="insight-value" id="completed-percentage">0%</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-label">Overdue Tasks</div>
                            <div class="insight-value" id="overdue-count">0</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-label">Due Today</div>
                            <div class="insight-value" id="due-today-count">0</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-label">High Priority</div>
                            <div class="insight-value" id="high-priority-count">0</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Tasks Section -->
            <section class="tasks-section">
                <div class="section-header">
                    <h2 class="section-title">Tasks</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" id="add-task-btn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                        <button class="btn btn-primary" id="export-btn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                        <button class="btn btn-primary" id="import-btn">
                            <i class="fas fa-file-import"></i> Import
                        </button>
                        <button class="btn btn-primary" id="manage-categories-btn">
                            <i class="fas fa-tags"></i> Manage Categories
                        </button>
                    </div>
                </div>
                
                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label" for="status-filter">Status</label>
                            <select class="filter-select" id="status-filter" aria-label="Filter by status">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="category-filter">Category</label>
                            <select class="filter-select" id="category-filter" aria-label="Filter by category">
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="priority-filter">Priority</label>
                            <select class="filter-select" id="priority-filter" aria-label="Filter by priority">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="date-filter">Due Date</label>
                            <select class="filter-select" id="date-filter" aria-label="Filter by due date">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="custom-date-range">Custom Range</label>
                            <input type="text" class="form-input" id="custom-date-range" placeholder="Select date range" disabled aria-label="Custom date range">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label" for="sort-by">Sort By</label>
                            <select class="filter-select" id="sort-by" aria-label="Sort tasks">
                                <option value="dueDate-asc">Due Date (Earliest)</option>
                                <option value="dueDate-desc">Due Date (Latest)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="priority-desc">Priority (High to Low)</option>
                                <option value="priority-asc">Priority (Low to High)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="search-input" placeholder="Search tasks..." aria-label="Search tasks">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- View Switcher -->
                <div class="view-switcher">
                    <div class="view-option active" data-view="list">List View</div>
                    <div class="view-option" data-view="graph">Graph View</div>
                </div>
                
                <!-- Tasks List View -->
                <div class="tasks-container" id="tasks-container">
                    <div class="tasks-list" id="tasks-list">
                        <!-- Tasks will be added here -->
                    </div>
                </div>
                
                <!-- Graph View -->
                <div class="graphs-container" id="graphs-container">
                    <div class="graph-card">
                        <h3 class="graph-title">Tasks Progress Over Time</h3>
                        <canvas id="tasks-chart"></canvas>
                    </div>
                    <div class="graph-card">
                        <h3 class="graph-title">Tasks Status</h3>
                        <canvas id="status-chart"></canvas>
                    </div>
                </div>
                
                <!-- No Tasks Message -->
                <div id="no-tasks-message" style="text-align: center; margin-top: 2rem; display: none;">
                    <i class="fas fa-tasks" style="font-size: 3rem; color: var(--gray); margin-bottom: 1rem;"></i>
                    <h3>No tasks found</h3>
                    <p>Add a new task or change your filter settings</p>
                </div>
            </section>
        </main>
        
        <!-- Multi-select Actions Bar -->
        <div class="multi-actions-bar" id="multi-actions-bar">
            <div class="selected-count">
                <i class="fas fa-check-square"></i>
                <span id="selected-count-text">0 tasks selected</span>
            </div>
            <button class="btn btn-success" id="complete-selected">
                <i class="fas fa-check"></i> Complete
            </button>
            <button class="btn btn-danger" id="delete-selected">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button class="btn btn-gray" id="cancel-selection">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts will be added here -->
    </div>
    
    <!-- Add Task Modal -->
    <div class="modal-overlay" id="add-task-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Task</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="task-title" class="form-label">Title</label>
                    <input type="text" id="task-title" class="form-input" aria-label="Task title">
                </div>
                <div class="form-group">
                    <label for="task-due-date" class="form-label">Due Date</label>
                    <input type="text" id="task-due-date" class="form-input" aria-label="Due date">
                </div>
                <div class="form-group">
                    <label for="task-priority" class="form-label">Priority</label>
                    <select id="task-priority" class="form-input" aria-label="Priority">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-category" class="form-label">Category</label>
                    <select id="task-category" class="form-input" aria-label="Category">
                        <!-- Categories will be added here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sub-Tasks</label>
                    <div class="sub-tasks-list" id="sub-tasks-list">
                        <div class="sub-task-item">
                            <input type="text" class="sub-task-input" placeholder="Sub-task" aria-label="Sub-task">
                            <button class="sub-task-remove" aria-label="Remove sub-task">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="add-sub-task-btn" id="add-sub-task-btn">
                        <i class="fas fa-plus"></i> Add Sub-Task
                    </button>
                </div>
                <div class="form-group">
                    <label for="task-description" class="form-label">Description</label>
                    <textarea id="task-description" class="form-input" rows="4" aria-label="Description"></textarea>
                </div>
                <div class="form-group">
                    <label for="task-notes" class="form-label">Notes</label>
                    <textarea id="task-notes" class="form-input" rows="3" aria-label="Notes"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-add-task">Cancel</button>
                <button class="btn btn-success" id="create-task">Create</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="edit-task-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit-task-title" class="form-label">Title</label>
                    <input type="text" id="edit-task-title" class="form-input" aria-label="Task title">
                </div>
                <div class="form-group">
                    <label for="edit-task-due-date" class="form-label">Due Date</label>
                    <input type="text" id="edit-task-due-date" class="form-input" aria-label="Due date">
                </div>
                <div class="form-group">
                    <label for="edit-task-priority" class="form-label">Priority</label>
                    <select id="edit-task-priority" class="form-input" aria-label="Priority">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-task-category" class="form-label">Category</label>
                    <select id="edit-task-category" class="form-input" aria-label="Category">
                        <!-- Categories will be added here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sub-Tasks</label>
                    <div class="sub-tasks-list" id="edit-sub-tasks-list">
                        <!-- Sub-tasks will be added here -->
                    </div>
                    <button type="button" class="add-sub-task-btn" id="edit-add-sub-task-btn">
                        <i class="fas fa-plus"></i> Add Sub-Task
                    </button>
                </div>
                <div class="form-group">
                    <label for="edit-task-description" class="form-label">Description</label>
                    <textarea id="edit-task-description" class="form-input" rows="4" aria-label="Description"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-task-notes" class="form-label">Notes</label>
                    <textarea id="edit-task-notes" class="form-input" rows="3" aria-label="Notes"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-edit-task">Cancel</button>
                <button class="btn btn-success" id="save-task">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- View Task Modal -->
    <div class="modal-overlay" id="view-task-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="view-task-title">Task Details</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div id="view-task-details">
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <p id="view-task-due-date"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <p id="view-task-status"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <p id="view-task-priority"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <p id="view-task-category"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p id="view-task-description"></p>
                </div>
                <div class="form-group" id="view-subtasks-container">
                    <label class="form-label">Sub-Tasks</label>
                    <ul id="view-task-subtasks"></ul>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <p id="view-task-notes"></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Spent</label>
                    <p id="view-task-time"></p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="close-view-task">Close</button>
                <button class="btn btn-primary" id="edit-from-view">Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Export Tasks</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-group">
                <label for="export-format" class="form-label">Select Format</label>
                <select id="export-format" class="form-input" aria-label="Export format">
                    <option value="json">JSON</option>
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-export">Cancel</button>
                <button class="btn btn-primary" id="confirm-export">Export</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Import Tasks</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Upload JSON File</label>
                <div class="file-input-container">
                    <input type="file" id="import-file" class="file-input" accept=".json" aria-label="Import file">
                    <label for="import-file" class="file-input-label">
                        <i class="fas fa-upload"></i> Choose File
                    </label>
                </div>
                <p id="file-name" style="margin-top: 0.5rem; font-size: 0.875rem;"></p>
            </div>
            <div class="form-group">
                <label for="import-url" class="form-label">Or Import from URL</label>
                <input type="text" id="import-url" class="form-input" placeholder="Enter URL to JSON file" aria-label="Import URL">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-import">Cancel</button>
                <button class="btn btn-primary" id="confirm-import">Import</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Categories Modal -->
    <div class="modal-overlay" id="categories-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Manage Categories</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="add-category-form">
                <input type="text" id="new-category" class="add-category-input" placeholder="New category name" aria-label="New category name">
                <button class="btn btn-primary" id="add-category-btn">Add</button>
            </div>
            <div class="categories-grid" id="categories-grid">
                <!-- Categories will be added here -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="close-categories">Done</button>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div class="modal-overlay" id="users-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Users</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="modal-loader" id="users-loader">
                <div class="loader"></div>
            </div>
            <div class="users-grid" id="users-grid">
                <!-- Users will be added here -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="close-users">Close</button>
            </div>
        </div>
    </div>
    
    <!-- View Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Profile</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="profile-view">
                <div class="profile-avatar-container">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="profile-avatar" id="profile-avatar">
                    <div class="avatar-edit" id="avatar-edit">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                </div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <div class="profile-info-label">Name</div>
                        <div class="profile-info-value" id="profile-name">John Doe</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Email</div>
                        <div class="profile-info-value" id="profile-email">test@example.com</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Role</div>
                        <div class="profile-info-value" id="profile-role">Manager</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Country</div>
                        <div class="profile-info-value" id="profile-country">United States</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">Joining Date</div>
                        <div class="profile-info-value" id="profile-joining-date">January 1, 2023</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="close-profile">Close</button>
                <button class="btn btn-primary" id="edit-profile">Edit Profile</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-profile-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit-profile-firstname" class="form-label">First Name</label>
                    <input type="text" id="edit-profile-firstname" class="form-input" aria-label="First Name">
                </div>
                <div class="form-group">
                    <label for="edit-profile-lastname" class="form-label">Last Name</label>
                    <input type="text" id="edit-profile-lastname" class="form-input" aria-label="Last Name">
                </div>
                <div class="form-group">
                    <label for="edit-profile-email" class="form-label">Email</label>
                    <input type="email" id="edit-profile-email" class="form-input" aria-label="Email">
                </div>
                <div class="form-group">
                    <label for="edit-profile-country" class="form-label">Country</label>
                    <select id="edit-profile-country" class="form-input" aria-label="Country">
                        <option value="">Select your country</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-profile-role" class="form-label">Role</label>
                    <select id="edit-profile-role" class="form-input" aria-label="Role">
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-edit-profile">Cancel</button>
                <button class="btn btn-success" id="save-profile">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Date Range Modal -->
    <div class="modal-overlay" id="date-range-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Select Date Range</h2>
                <button class="modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="form-group">
                <label for="date-range-picker" class="form-label">Date Range</label>
                <input type="text" id="date-range-picker" class="form-input" aria-label="Date range">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" id="cancel-date-range">Cancel</button>
                <button class="btn btn-primary" id="apply-date-range">Apply</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check for dark mode preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark');
            }
            
            // Listen for changes to color scheme preference
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.body.classList.add('dark');
                } else {
                    document.body.classList.remove('dark');
                }
            });
            
            // Global variables
            let currentUser = null;
            let tasks = [];
            let categories = [];
            let notifications = [];
            let selectedTasks = [];
            let activeTaskTimer = null;
            let taskTimers = {};
            let workTimer = null;
            let workTimerValue = 0;
            let undoStack = [];
            let redoStack = [];
            let draggedTask = null;
            let draggedIndex = null;
            let searchTimeout = null;
            let statusChart = null;
            let tasksChart = null;
            
            // Initialize data
            function initializeApp() {
                // Load data from local storage or initialize with defaults
                loadFromLocalStorage();
                
                // Initialize timers
                initializeTimers();
                
                // Initialize UI
                updateUI();
                
                // Initialize chart if visible
                if (document.getElementById('graphs-container').style.display !== 'none') {
                    initializeCharts();
                }
                
                // Check for session persistence
                checkSession();
            }
            
            // Check if user was logged in and session needs to persist
            function checkSession() {
                const persistedUser = localStorage.getItem('currentUser');
                if (persistedUser) {
                    currentUser = JSON.parse(persistedUser);
                    showDashboard();
                    updateProfileInfo();
                    showToast('success', 'Welcome back!', `Your session was restored, ${currentUser.firstName}.`);
                }
            }
            
            // Load data from local storage
            function loadFromLocalStorage() {
                const storedTasks = localStorage.getItem('tasks');
                const storedCategories = localStorage.getItem('categories');
                const storedNotifications = localStorage.getItem('notifications');
                const storedUsers = localStorage.getItem('users');
                const storedTimers = localStorage.getItem('taskTimers');
                const storedWorkTimer = localStorage.getItem('workTimer');
                
                if (storedTasks) {
                    tasks = JSON.parse(storedTasks);
                } else {
                    // Create sample tasks
                    generateSampleTasks();
                }
                
                if (storedCategories) {
                    categories = JSON.parse(storedCategories);
                } else {
                    // Create sample categories
                    categories = ['Work', 'Personal', 'Shopping', 'Health', 'Finance', 'Education'];
                    saveToLocalStorage('categories', categories);
                }
                
                if (storedNotifications) {
                    notifications = JSON.parse(storedNotifications);
                } else {
                    notifications = [];
                }
                
                if (storedTimers) {
                    taskTimers = JSON.parse(storedTimers);
                }
                
                if (storedWorkTimer) {
                    workTimerValue = parseInt(storedWorkTimer);
                }
                
                if (!storedUsers) {
                    // Create default user
                    const defaultUser = {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'test@example.com',
                        password: '123456',
                        role: 'Manager',
                        country: 'United States',
                        joiningDate: new Date().toISOString(),
                        profileImage: 'https://randomuser.me/api/portraits/men/1.jpg'
                    };
                    
                    saveToLocalStorage('users', [defaultUser]);
                }
            }
            
            // Save data to local storage
            function saveToLocalStorage(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }
            
            // Generate sample tasks
            function generateSampleTasks() {
                tasks = [];
                
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const lastWeek = new Date(today);
                lastWeek.setDate(lastWeek.getDate() - 7);
                
                tasks.push({
                    id: generateId(),
                    title: 'Complete project proposal',
                    description: 'Draft and finalize the project proposal document',
                    dueDate: tomorrow.toISOString(),
                    priority: 'high',
                    category: 'Work',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Include budget estimations and timeline',
                    subTasks: [
                        { id: generateId(), title: 'Research similar projects', completed: true },
                        { id: generateId(), title: 'Create outline', completed: false },
                        { id: generateId(), title: 'Write draft', completed: false }
                    ],
                    timeSpent: 0
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Grocery shopping',
                    description: 'Buy groceries for the week',
                    dueDate: today.toISOString(),
                    priority: 'medium',
                    category: 'Shopping',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Don\'t forget vegetables and fruits',
                    subTasks: [
                        { id: generateId(), title: 'Vegetables', completed: false },
                        { id: generateId(), title: 'Fruits', completed: true },
                        { id: generateId(), title: 'Dairy', completed: false }
                    ],
                    timeSpent: 0
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Gym workout',
                    description: 'Complete 1-hour workout session',
                    dueDate: today.toISOString(),
                    priority: 'medium',
                    category: 'Health',
                    completed: true,
                    createdAt: lastWeek.toISOString(),
                    notes: 'Focus on cardio and core exercises',
                    subTasks: [],
                    timeSpent: 3600
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Pay bills',
                    description: 'Pay utility and credit card bills',
                    dueDate: nextWeek.toISOString(),
                    priority: 'high',
                    category: 'Finance',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Electricity bill due on the 15th',
                    subTasks: [
                        { id: generateId(), title: 'Electricity bill', completed: false },
                        { id: generateId(), title: 'Water bill', completed: false },
                        { id: generateId(), title: 'Credit card', completed: false }
                    ],
                    timeSpent: 0
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Read book',
                    description: 'Finish reading the current book',
                    dueDate: nextWeek.toISOString(),
                    priority: 'low',
                    category: 'Personal',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Aim for 30 pages per day',
                    subTasks: [],
                    timeSpent: 7200
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Team meeting preparation',
                    description: 'Prepare slides and agenda for team meeting',
                    dueDate: tomorrow.toISOString(),
                    priority: 'high',
                    category: 'Work',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Include project status updates and next steps',
                    subTasks: [
                        { id: generateId(), title: 'Create slides', completed: false },
                        { id: generateId(), title: 'Prepare agenda', completed: true }
                    ],
                    timeSpent: 1800
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Schedule dentist appointment',
                    description: 'Call dentist office to schedule annual checkup',
                    dueDate: nextWeek.toISOString(),
                    priority: 'medium',
                    category: 'Health',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Remember to ask about teeth whitening options',
                    subTasks: [],
                    timeSpent: 0
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Online course assignment',
                    description: 'Complete and submit the week 3 assignment',
                    dueDate: lastWeek.toISOString(),
                    priority: 'high',
                    category: 'Education',
                    completed: false,
                    createdAt: new Date(lastWeek).setDate(lastWeek.getDate() - 3),
                    notes: 'Focus on sections 3.2 and 3.4 of the textbook',
                    subTasks: [
                        { id: generateId(), title: 'Read chapter 3', completed: true },
                        { id: generateId(), title: 'Complete exercises', completed: false },
                        { id: generateId(), title: 'Submit assignment', completed: false }
                    ],
                    timeSpent: 5400
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Clean home office',
                    description: 'Organize desk and clean office space',
                    dueDate: today.toISOString(),
                    priority: 'low',
                    category: 'Personal',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Sort through papers and organize cables',
                    subTasks: [
                        { id: generateId(), title: 'Organize desk', completed: false },
                        { id: generateId(), title: 'Clean floor', completed: false },
                        { id: generateId(), title: 'Sort papers', completed: true }
                    ],
                    timeSpent: 0
                });
                
                tasks.push({
                    id: generateId(),
                    title: 'Update resume',
                    description: 'Review and update resume with recent experience',
                    dueDate: nextWeek.toISOString(),
                    priority: 'medium',
                    category: 'Work',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes: 'Add new skills and projects completed this year',
                    subTasks: [],
                    timeSpent: 3600
                });
                
                saveToLocalStorage('tasks', tasks);
            }
            
            // Initialize timers
            function initializeTimers() {
                // Task timer - updates active task timer
                setInterval(() => {
                    if (activeTaskTimer) {
                        taskTimers[activeTaskTimer] = (taskTimers[activeTaskTimer] || 0) + 1;
                        saveToLocalStorage('taskTimers', taskTimers);
                        updateActiveTaskTimerDisplay();
                    }
                }, 1000);
                
                // Work timer - counts work time when logged in
                workTimer = setInterval(() => {
                    workTimerValue++;
                    saveToLocalStorage('workTimer', workTimerValue);
                    updateWorkTimerDisplay();
                }, 1000);
            }
            
            // Update work timer display
            function updateWorkTimerDisplay() {
                const workTimerElement = document.getElementById('work-timer');
                workTimerElement.textContent = formatTime(workTimerValue);
            }
            
            // Update active task timer display
            function updateActiveTaskTimerDisplay() {
                if (activeTaskTimer) {
                    const taskTimerDisplay = document.getElementById('task-timer-display');
                    taskTimerDisplay.textContent = formatTime(taskTimers[activeTaskTimer] || 0);
                }
            }
            
            // Format time in HH:MM:SS
            function formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            
            // Generate unique ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
            
            // Update UI
            function updateUI() {
                updateTasksList();
                updateCategoriesDropdowns();
                updateSummaryCards();
                updateInsights();
                updateNotificationBadge();
            }
            
            // Update categories in dropdowns
            function updateCategoriesDropdowns() {
                const categoryFilters = [
                    document.getElementById('category-filter'),
                    document.getElementById('task-category'),
                    document.getElementById('edit-task-category')
                ];
                
                categoryFilters.forEach(select => {
                    if (!select) return;
                    
                    // Save current selection
                    const currentValue = select.value;
                    
                    // Clear options except the first one (All) for the filter dropdown
                    if (select.id === 'category-filter') {
                        select.innerHTML = '<option value="all">All</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    
                    // Add categories
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });
                    
                    // Restore selection if it exists in the new options
                    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                        select.value = currentValue;
                    }
                });
                
                // Update categories grid in the manage categories modal
                const categoriesGrid = document.getElementById('categories-grid');
                categoriesGrid.innerHTML = '';
                
                categories.forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'category-card';
                    categoryCard.innerHTML = `
                        <div class="category-name">${category}</div>
                        <div class="category-actions">
                            <button class="category-btn edit-category" aria-label="Edit category">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="category-btn delete-category" aria-label="Delete category">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    // Add event listeners
                    categoryCard.querySelector('.edit-category').addEventListener('click', () => {
                        editCategory(category);
                    });
                    
                    categoryCard.querySelector('.delete-category').addEventListener('click', () => {
                        deleteCategory(category);
                    });
                    
                    categoriesGrid.appendChild(categoryCard);
                });
            }
            
            // Update tasks list based on filters
            function updateTasksList() {
                const tasksList = document.getElementById('tasks-list');
                const noTasksMessage = document.getElementById('no-tasks-message');
                
                // Get filter values
                const statusFilter = document.getElementById('status-filter').value;
                const categoryFilter = document.getElementById('category-filter').value;
                const priorityFilter = document.getElementById('priority-filter').value;
                const dateFilter = document.getElementById('date-filter').value;
                const searchInput = document.getElementById('search-input').value.toLowerCase();
                const sortBy = document.getElementById('sort-by').value;
                
                // Apply filters
                let filteredTasks = tasks.filter(task => {
                    // Status filter
                    if (statusFilter === 'active' && task.completed) return false;
                    if (statusFilter === 'completed' && !task.completed) return false;
                    
                    // Category filter
                    if (categoryFilter !== 'all' && task.category !== categoryFilter) return false;
                    
                    // Priority filter
                    if (priorityFilter !== 'all' && task.priority !== priorityFilter) return false;
                    
                    // Date filter
                    if (dateFilter !== 'all') {
                        const dueDate = new Date(task.dueDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 7);
                        
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        
                        if (dateFilter === 'today' && (dueDate < today || dueDate >= tomorrow)) return false;
                        if (dateFilter === 'week' && (dueDate < weekStart || dueDate >= weekEnd)) return false;
                        if (dateFilter === 'month' && (dueDate < monthStart || dueDate >= monthEnd)) return false;
                        if (dateFilter === 'custom' && window.customDateRange) {
                            const [start, end] = window.customDateRange;
                            if (dueDate < start || dueDate > end) return false;
                        }
                    }
                    
                    // Search filter
                    if (searchInput && !task.title.toLowerCase().includes(searchInput) && !task.description.toLowerCase().includes(searchInput)) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Sort tasks
                filteredTasks.sort((a, b) => {
                    const [field, direction] = sortBy.split('-');
                    
                    if (field === 'dueDate') {
                        const dateA = new Date(a.dueDate);
                        const dateB = new Date(b.dueDate);
                        return direction === 'asc' ? dateA - dateB : dateB - dateA;
                    }
                    
                    if (field === 'title') {
                        return direction === 'asc' 
                            ? a.title.localeCompare(b.title) 
                            : b.title.localeCompare(a.title);
                    }
                    
                    if (field === 'priority') {
                        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                        return direction === 'asc' 
                            ? priorityOrder[a.priority] - priorityOrder[b.priority] 
                            : priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    
                    return 0;
                });
                
                // Clear tasks list
                tasksList.innerHTML = '';
                
                // Check if there are no tasks
                if (filteredTasks.length === 0) {
                    noTasksMessage.style.display = 'block';
                } else {
                    noTasksMessage.style.display = 'none';
                    
                    // Render tasks
                    filteredTasks.forEach(task => {
                        const taskElement = createTaskElement(task);
                        tasksList.appendChild(taskElement);
                    });
                    
                    // Add drag and drop functionality
                    setupDragAndDrop();
                }
            }
            
            // Create task element
            function createTaskElement(task) {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item${task.completed ? ' completed' : ''}`;
                taskElement.setAttribute('data-id', task.id);
                taskElement.draggable = true;
                
                // Add border color based on due date
                const now = new Date();
                const dueDate = new Date(task.dueDate);
                
                if (dueDate < now && !task.completed) {
                    taskElement.classList.add('expired');
                } else if (dueDate.getTime() - now.getTime() < 48 * 60 * 60 * 1000 && !task.completed) {
                    taskElement.classList.add('due-soon');
                }
                
                const taskCheckboxChecked = task.completed ? 'checked' : '';
                const priorityClass = `priority-${task.priority}`;
                const priorityIcon = getPriorityIcon(task.priority);
                
                taskElement.innerHTML = `
                    <div class="task-checkbox ${taskCheckboxChecked}" data-id="${task.id}">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="task-content">
                        <div class="task-header">
                            <h3 class="task-title">${task.title}</h3>
                            <div class="task-date">
                                <i class="far fa-calendar-alt"></i>
                                ${formatDate(dueDate)}
                            </div>
                        </div>
                        <p class="task-description">${task.description}</p>
                        <div class="task-meta">
                            <span class="task-tag">${task.category}</span>
                            <span class="priority-tag ${priorityClass}">
                                ${priorityIcon} ${capitalizeFirstLetter(task.priority)}
                            </span>
                            ${task.subTasks.length ? `<span class="task-tag">${task.subTasks.filter(st => st.completed).length}/${task.subTasks.length} subtasks</span>` : ''}
                            ${taskTimers[task.id] ? `<span class="task-timer-display">${formatTime(taskTimers[task.id])}</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-action-btn view-btn" aria-label="View task">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="task-action-btn edit-btn" aria-label="Edit task">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="task-action-btn delete-btn" aria-label="Delete task">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="task-action-btn ${activeTaskTimer === task.id ? 'pause-btn' : 'play-btn'}" aria-label="${activeTaskTimer === task.id ? 'Pause timer' : 'Start timer'}">
                            <i class="fas ${activeTaskTimer === task.id ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <label class="toggle-switch" aria-label="Mark as ${task.completed ? 'incomplete' : 'complete'}">
                            <input type="checkbox" ${task.completed ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                
                // Add event listeners
                // Task checkbox
                taskElement.querySelector('.task-checkbox').addEventListener('click', () => {
                    toggleTaskCompletion(task.id);
                });
                
                // Toggle switch
                taskElement.querySelector('.toggle-switch input').addEventListener('change', (e) => {
                    toggleTaskCompletion(task.id);
                });
                
                // View button
                taskElement.querySelector('.view-btn').addEventListener('click', () => {
                    viewTask(task.id);
                });
                
                // Edit button
                taskElement.querySelector('.edit-btn').addEventListener('click', () => {
                    editTask(task.id);
                });
                
                // Delete button
                taskElement.querySelector('.delete-btn').addEventListener('click', () => {
                    deleteTask(task.id);
                });
                
                // Play/Pause button
                taskElement.querySelector(`.${activeTaskTimer === task.id ? 'pause-btn' : 'play-btn'}`).addEventListener('click', () => {
                    toggleTaskTimer(task.id);
                });
                
                // Add drag and drop attributes
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragend', handleDragEnd);
                taskElement.addEventListener('dragover', handleDragOver);
                taskElement.addEventListener('dragenter', handleDragEnter);
                taskElement.addEventListener('dragleave', handleDragLeave);
                taskElement.addEventListener('drop', handleDrop);
                
                return taskElement;
            }
            
            // Setup drag and drop functionality
            function setupDragAndDrop() {
                const taskItems = document.querySelectorAll('.task-item');
                taskItems.forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragend', handleDragEnd);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('dragenter', handleDragEnter);
                    item.addEventListener('dragleave', handleDragLeave);
                    item.addEventListener('drop', handleDrop);
                });
            }
            
            // Drag and drop event handlers
            function handleDragStart(e) {
                this.style.opacity = '0.4';
                draggedTask = this;
                draggedIndex = Array.from(this.parentNode.children).indexOf(this);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }
            
            function handleDragEnd(e) {
                this.style.opacity = '1';
                
                const taskItems = document.querySelectorAll('.task-item');
                taskItems.forEach(item => {
                    item.classList.remove('over');
                });
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter(e) {
                this.classList.add('over');
            }
            
            function handleDragLeave(e) {
                this.classList.remove('over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                if (draggedTask !== this) {
                    // Reorder tasks array
                    const dropIndex = Array.from(this.parentNode.children).indexOf(this);
                    const draggedId = draggedTask.getAttribute('data-id');
                    const dropId = this.getAttribute('data-id');
                    
                    const draggedTaskIndex = tasks.findIndex(t => t.id === draggedId);
                    const dropTaskIndex = tasks.findIndex(t => t.id === dropId);
                    
                    // Move task in array
                    const [removed] = tasks.splice(draggedTaskIndex, 1);
                    tasks.splice(dropTaskIndex, 0, removed);
                    
                    // Save to localStorage
                    saveToLocalStorage('tasks', tasks);
                    
                    // Update UI
                    updateTasksList();
                    
                    // Add to undo stack
                    addToUndoStack({
                        type: 'reorder',
                        draggedIndex: draggedTaskIndex,
                        dropIndex: dropTaskIndex
                    });
                    
                    // Show toast
                    showToast('success', 'Task Reordered', 'Task order has been updated.');
                }
                
                return false;
            }
            
            // Get priority icon
            function getPriorityIcon(priority) {
                switch (priority) {
                    case 'high':
                        return '<i class="fas fa-arrow-up"></i>';
                    case 'medium':
                        return '<i class="fas fa-arrow-right"></i>';
                    case 'low':
                        return '<i class="fas fa-arrow-down"></i>';
                    default:
                        return '';
                }
            }
            
            // Toggle task completion status
            function toggleTaskCompletion(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    // Save previous state for undo
                    const previousState = JSON.parse(JSON.stringify(task));
                    
                    task.completed = !task.completed;
                    
                    // Save to localStorage
                    saveToLocalStorage('tasks', tasks);
                    
                    // Update UI
                    updateUI();
                    
                    // Add notification
                    addNotification(`Task "${task.title}" marked as ${task.completed ? 'completed' : 'incomplete'}`);
                    
                    // Add to undo stack
                    addToUndoStack({
                        type: 'update',
                        taskId,
                        previousState,
                        newState: JSON.parse(JSON.stringify(task))
                    });
                    
                    // Show toast
                    showToast(
                        'success',
                        `Task ${task.completed ? 'Completed' : 'Reactivated'}`,
                        `"${task.title}" has been marked as ${task.completed ? 'completed' : 'incomplete'}.`
                    );
                }
            }
            
            // View task details
            function viewTask(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('view-task-title').textContent = task.title;
                    document.getElementById('view-task-due-date').textContent = formatDate(new Date(task.dueDate));
                    document.getElementById('view-task-status').textContent = task.completed ? 'Completed' : 'Pending';
                    document.getElementById('view-task-status').style.color = task.completed ? 'var(--success)' : 'var(--warning)';
                    document.getElementById('view-task-priority').textContent = capitalizeFirstLetter(task.priority);
                    document.getElementById('view-task-priority').style.color = `var(--${task.priority === 'high' ? 'danger' : task.priority === 'medium' ? 'medium' : 'gray'})`;
                    document.getElementById('view-task-category').textContent = task.category;
                    document.getElementById('view-task-description').textContent = task.description || 'No description';
                    document.getElementById('view-task-notes').textContent = task.notes || 'No notes';
                    document.getElementById('view-task-time').textContent = formatTime(taskTimers[task.id] || 0);
                    
                    // Update subtasks
                    const subtasksContainer = document.getElementById('view-subtasks-container');
                    const subtasksList = document.getElementById('view-task-subtasks');
                    subtasksList.innerHTML = '';
                    
                    if (task.subTasks && task.subTasks.length > 0) {
                        subtasksContainer.style.display = 'block';
                        task.subTasks.forEach(subTask => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                ${subTask.completed ? '<i class="fas fa-check-circle" style="color: var(--success); margin-right: 0.5rem;"></i>' : '<i class="far fa-circle" style="color: var(--gray); margin-right: 0.5rem;"></i>'}
                                ${subTask.title}
                            `;
                            subtasksList.appendChild(li);
                        });
                    } else {
                        subtasksContainer.style.display = 'none';
                    }
                    
                    // Show the view task modal
                    const viewTaskModal = document.getElementById('view-task-modal');
                    openModal(viewTaskModal);
                    
                    // Save the task id for edit button
                    document.getElementById('edit-from-view').setAttribute('data-id', taskId);
                }
            }
            
            // Edit task
            function editTask(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('edit-task-title').value = task.title;
                    document.getElementById('edit-task-description').value = task.description;
                    
                    // Initialize flatpickr
                    if (window.editDatePicker) {
                        window.editDatePicker.setDate(task.dueDate);
                    } else {
                        window.editDatePicker = flatpickr('#edit-task-due-date', {
                            dateFormat: 'Y-m-d',
                            defaultDate: task.dueDate
                        });
                    }
                    
                    document.getElementById('edit-task-priority').value = task.priority;
                    document.getElementById('edit-task-category').value = task.category;
                    document.getElementById('edit-task-notes').value = task.notes;
                    
                    // Update subtasks
                    const subTasksList = document.getElementById('edit-sub-tasks-list');
                    subTasksList.innerHTML = '';
                    
                    if (task.subTasks && task.subTasks.length > 0) {
                        task.subTasks.forEach(subTask => {
                            const subTaskItem = document.createElement('div');
                            subTaskItem.className = 'sub-task-item';
                            subTaskItem.setAttribute('data-id', subTask.id);
                            subTaskItem.innerHTML = `
                                <input type="text" class="sub-task-input" value="${subTask.title}" aria-label="Sub-task">
                                <button class="sub-task-remove" aria-label="Remove sub-task">
                                    <i class="fas fa-times"></i>
                                </button>
                                <div class="sub-task-checkbox" style="margin-left: 0.5rem;">
                                    <label class="toggle-switch" aria-label="Mark as ${subTask.completed ? 'incomplete' : 'complete'}">
                                        <input type="checkbox" ${subTask.completed ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            `;
                            
                            // Add event listener for remove button
                            subTaskItem.querySelector('.sub-task-remove').addEventListener('click', function() {
                                subTaskItem.remove();
                            });
                            
                            subTasksList.appendChild(subTaskItem);
                        });
                    }
                    
                    // Show the edit task modal
                    const editTaskModal = document.getElementById('edit-task-modal');
                    openModal(editTaskModal);
                    
                    // Save the task id for save button
                    document.getElementById('save-task').setAttribute('data-id', taskId);
                }
            }
            
            // Delete task
            function deleteTask(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const confirmDelete = confirm(`Are you sure you want to delete the task "${task.title}"?`);
                    if (confirmDelete) {
                        // Save task for undo
                        const taskIndex = tasks.findIndex(t => t.id === taskId);
                        const taskCopy = JSON.parse(JSON.stringify(task));
                        
                        // Remove task
                        tasks = tasks.filter(t => t.id !== taskId);
                        
                        // Save to localStorage
                        saveToLocalStorage('tasks', tasks);
                        
                        // Update UI
                        updateUI();
                        
                        // Add notification
                        addNotification(`Task "${task.title}" was deleted`);
                        
                        // Add to undo stack
                        addToUndoStack({
                            type: 'delete',
                            task: taskCopy,
                            index: taskIndex
                        });
                        
                        // Show toast
                        showToast('success', 'Task Deleted', `"${task.title}" has been deleted.`);
                    }
                }
            }
            
            // Toggle task timer
            function toggleTaskTimer(taskId) {
                // If there's already an active timer, pause it
                if (activeTaskTimer) {
                    const activeTask = tasks.find(t => t.id === activeTaskTimer);
                    if (activeTask) {
                        showToast('info', 'Timer Paused', `Paused timer for "${activeTask.title}" at ${formatTime(taskTimers[activeTaskTimer] || 0)}`);
                    }
                    
                    activeTaskTimer = null;
                    updateTasksList();
                    updateActiveTaskTimerDisplay();
                }
                
                // If the clicked task is not the one that was just paused, start its timer
                if (taskId !== activeTaskTimer) {
                    activeTaskTimer = taskId;
                    const activeTask = tasks.find(t => t.id === activeTaskTimer);
                    if (activeTask) {
                        showToast('info', 'Timer Started', `Started timer for "${activeTask.title}"`);
                    }
                    
                    // Initialize timer if it doesn't exist
                    if (!taskTimers[activeTaskTimer]) {
                        taskTimers[activeTaskTimer] = 0;
                    }
                    
                    updateTasksList();
                    updateActiveTaskTimerDisplay();
                }
            }
            
            // Create a new task
            function createTask() {
                // Get form values
                const title = document.getElementById('task-title').value.trim();
                const description = document.getElementById('task-description').value.trim();
                const dueDate = document.getElementById('task-due-date').value;
                const priority = document.getElementById('task-priority').value;
                const category = document.getElementById('task-category').value;
                const notes = document.getElementById('task-notes').value.trim();
                
                // Validate form
                if (!title) {
                    alert('Please enter a task title');
                    return;
                }
                
                if (!dueDate) {
                    alert('Please select a due date');
                    return;
                }
                
                // Get subtasks
                const subTasksElements = document.querySelectorAll('#sub-tasks-list .sub-task-item');
                const subTasks = Array.from(subTasksElements).map(item => {
                    const title = item.querySelector('.sub-task-input').value.trim();
                    return {
                        id: generateId(),
                        title,
                        completed: false
                    };
                }).filter(subTask => subTask.title);
                
                // Create task object
                const newTask = {
                    id: generateId(),
                    title,
                    description,
                    dueDate: new Date(dueDate).toISOString(),
                    priority,
                    category,
                    completed: false,
                    createdAt: new Date().toISOString(),
                    notes,
                    subTasks,
                    timeSpent: 0
                };
                
                // Add task to array
                tasks.push(newTask);
                
                // Save to localStorage
                saveToLocalStorage('tasks', tasks);
                
                // Update UI
                updateUI();
                
                // Close modal
                closeModal(document.getElementById('add-task-modal'));
                
                // Reset form
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-notes').value = '';
                document.getElementById('sub-tasks-list').innerHTML = `
                    <div class="sub-task-item">
                        <input type="text" class="sub-task-input" placeholder="Sub-task" aria-label="Sub-task">
                        <button class="sub-task-remove" aria-label="Remove sub-task">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                // Add notification
                addNotification(`New task "${title}" was created`);
                
                // Add to undo stack
                addToUndoStack({
                    type: 'create',
                    task: newTask
                });
                
                // Show toast
                showToast('success', 'Task Created', `"${title}" has been added to your tasks.`);
            }
            
            // Save edited task
            function saveEditedTask(taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    // Save previous state for undo
                    const previousState = JSON.parse(JSON.stringify(task));
                    
                    // Get form values
                    const title = document.getElementById('edit-task-title').value.trim();
                    const description = document.getElementById('edit-task-description').value.trim();
                    const dueDate = document.getElementById('edit-task-due-date').value;
                    const priority = document.getElementById('edit-task-priority').value;
                    const category = document.getElementById('edit-task-category').value;
                    const notes = document.getElementById('edit-task-notes').value.trim();
                    
                    // Validate form
                    if (!title) {
                        alert('Please enter a task title');
                        return;
                    }
                    
                    if (!dueDate) {
                        alert('Please select a due date');
                        return;
                    }
                    
                    // Get subtasks
                    const subTasksElements = document.querySelectorAll('#edit-sub-tasks-list .sub-task-item');
                    const subTasks = Array.from(subTasksElements).map(item => {
                        const title = item.querySelector('.sub-task-input').value.trim();
                        const completed = item.querySelector('input[type="checkbox"]').checked;
                        return {
                            id: item.getAttribute('data-id') || generateId(),
                            title,
                            completed
                        };
                    }).filter(subTask => subTask.title);
                    
                    // Update task
                    task.title = title;
                    task.description = description;
                    task.dueDate = new Date(dueDate).toISOString();
                    task.priority = priority;
                    task.category = category;
                    task.notes = notes;
                    task.subTasks = subTasks;
                    
                    // Save to localStorage
                    saveToLocalStorage('tasks', tasks);
                    
                    // Update UI
                    updateUI();
                    
                    // Close modal
                    closeModal(document.getElementById('edit-task-modal'));
                    
                    // Add notification
                    addNotification(`Task "${title}" was updated`);
                    
                    // Add to undo stack
                    addToUndoStack({
                        type: 'update',
                        taskId,
                        previousState,
                        newState: JSON.parse(JSON.stringify(task))
                    });
                    
                    // Show toast
                    showToast('success', 'Task Updated', `"${title}" has been updated.`);
                }
            }
            
            // Update summary cards
            function updateSummaryCards() {
                const totalTasksCount = tasks.length;
                const completedTasksCount = tasks.filter(task => task.completed).length;
                const pendingTasksCount = totalTasksCount - completedTasksCount;
                
                document.getElementById('total-tasks-count').textContent = totalTasksCount;
                document.getElementById('completed-tasks-count').textContent = completedTasksCount;
                document.getElementById('pending-tasks-count').textContent = pendingTasksCount;
            }
            
            // Update insights
            function updateInsights() {
                const totalTasksCount = tasks.length;
                const completedTasksCount = tasks.filter(task => task.completed).length;
                const completedPercentage = totalTasksCount > 0 ? Math.round((completedTasksCount / totalTasksCount) * 100) : 0;
                
                const now = new Date();
                const overdueCount = tasks.filter(task => !task.completed && new Date(task.dueDate) < now).length;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dueTodayCount = tasks.filter(task => !task.completed && new Date(task.dueDate) >= today && new Date(task.dueDate) < tomorrow).length;
                
                const highPriorityCount = tasks.filter(task => !task.completed && task.priority === 'high').length;
                
                document.getElementById('completed-percentage').textContent = `${completedPercentage}%`;
                document.getElementById('overdue-count').textContent = overdueCount;
                document.getElementById('due-today-count').textContent = dueTodayCount;
                document.getElementById('high-priority-count').textContent = highPriorityCount;
            }
            
            // Initialize charts
            function initializeCharts() {
                const statusChartCtx = document.getElementById('status-chart').getContext('2d');
                const tasksChartCtx = document.getElementById('tasks-chart').getContext('2d');
                
                // Status chart (pie chart)
                if (statusChart) {
                    statusChart.destroy();
                }
                
                const completedCount = tasks.filter(task => task.completed).length;
                const pendingCount = tasks.length - completedCount;
                
                statusChart = new Chart(statusChartCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completedCount, pendingCount],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(255, 193, 7, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        },
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Tasks chart (line chart)
                if (tasksChart) {
                    tasksChart.destroy();
                }
                
                // Group tasks by due date
                const tasksByDate = {};
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                // Go back 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    tasksByDate[dateStr] = { completed: 0, pending: 0 };
                }
                
                // Count tasks for each date
                tasks.forEach(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const dateStr = dueDate.toISOString().split('T')[0];
                    
                    if (tasksByDate[dateStr]) {
                        if (task.completed) {
                            tasksByDate[dateStr].completed++;
                        } else {
                            tasksByDate[dateStr].pending++;
                        }
                    }
                });
                
                // Prepare data for chart
                const labels = Object.keys(tasksByDate);
                const completedData = labels.map(date => tasksByDate[date].completed);
                const pendingData = labels.map(date => tasksByDate[date].pending);
                
                tasksChart = new Chart(tasksChartCtx, {
                    type: 'line',
                    data: {
                        labels: labels.map(date => {
                            const d = new Date(date);
                            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'Completed',
                                data: completedData,
                                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Pending',
                                data: pendingData,
                                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    color: document.body.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
            
            // Format date
            function formatDate(date) {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            // Capitalize first letter
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            
            // Add notification
            function addNotification(message) {
                const notification = {
                    id: generateId(),
                    message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                notifications.unshift(notification);
                
                // Limit to 50 notifications
                if (notifications.length > 50) {
                    notifications.pop();
                }
                
                saveToLocalStorage('notifications', notifications);
                updateNotificationBadge();
                updateNotificationList();
            }
            
            // Update notification badge
            function updateNotificationBadge() {
                const unreadCount = notifications.filter(n => !n.read).length;
                const badge = document.querySelector('.notification-count');
                badge.textContent = unreadCount;
                
                if (unreadCount > 0) {
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            // Update notification list
            function updateNotificationList() {
                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = '';
                
                if (notifications.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'notification-item';
                    emptyItem.innerHTML = 'No notifications';
                    notificationList.appendChild(emptyItem);
                    return;
                }
                
                notifications.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item${notification.read ? '' : ' unread'}`;
                    notificationItem.setAttribute('data-id', notification.id);
                    
                    const timestamp = new Date(notification.timestamp);
                    const timeAgo = getTimeAgo(timestamp);
                    
                    notificationItem.innerHTML = `
                        <div class="notification-content">${notification.message}</div>
                        <div class="notification-time">${timeAgo}</div>
                    `;
                    
                    notificationItem.addEventListener('click', () => {
                        markNotificationAsRead(notification.id);
                    });
                    
                    notificationList.appendChild(notificationItem);
                });
            }
            
            // Mark notification as read
            function markNotificationAsRead(notificationId) {
                const notification = notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    saveToLocalStorage('notifications', notifications);
                    updateNotificationBadge();
                    updateNotificationList();
                }
            }
            
            // Mark all notifications as read
            function markAllNotificationsAsRead() {
                notifications.forEach(notification => {
                    notification.read = true;
                });
                
                saveToLocalStorage('notifications', notifications);
                updateNotificationBadge();
                updateNotificationList();
            }
            
            // Get time ago
            function getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                let interval = Math.floor(seconds / 31536000);
                if (interval > 1) {
                    return interval + ' years ago';
                }
                if (interval === 1) {
                    return '1 year ago';
                }
                
                interval = Math.floor(seconds / 2592000);
                if (interval > 1) {
                    return interval + ' months ago';
                }
                if (interval === 1) {
                    return '1 month ago';
                }
                
                interval = Math.floor(seconds / 86400);
                if (interval > 1) {
                    return interval + ' days ago';
                }
                if (interval === 1) {
                    return '1 day ago';
                }
                
                interval = Math.floor(seconds / 3600);
                if (interval > 1) {
                    return interval + ' hours ago';
                }
                if (interval === 1) {
                    return '1 hour ago';
                }
                
                interval = Math.floor(seconds / 60);
                if (interval > 1) {
                    return interval + ' minutes ago';
                }
                if (interval === 1) {
                    return '1 minute ago';
                }
                
                return 'just now';
            }
            
            // Show toast notification
            function showToast(type, title, message) {
                const toastContainer = document.getElementById('toast-container');
                
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                let icon = '';
                switch (type) {
                    case 'success':
                        icon = 'check';
                        break;
                    case 'warning':
                        icon = 'exclamation';
                        break;
                    case 'error':
                        icon = 'times';
                        break;
                    case 'info':
                        icon = 'info';
                        break;
                    default:
                        icon = 'info';
                }
                
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
            
            // Add action to undo stack
            function addToUndoStack(action) {
                undoStack.push(action);
                // Clear redo stack when a new action is performed
                redoStack = [];
            }
            
            // Undo last action
            function undoAction() {
                if (undoStack.length === 0) return;
                
                const action = undoStack.pop();
                redoStack.push(action);
                
                switch (action.type) {
                    case 'create':
                        // Remove the created task
                        tasks = tasks.filter(t => t.id !== action.task.id);
                        break;
                    
                    case 'update':
                        // Restore previous task state
                        const taskToUpdate = tasks.find(t => t.id === action.taskId);
                        if (taskToUpdate) {
                            Object.assign(taskToUpdate, action.previousState);
                        }
                        break;
                    
                    case 'delete':
                        // Restore deleted task
                        tasks.splice(action.index, 0, action.task);
                        break;
                    
                    case 'reorder':
                        // Restore previous order
                        const [task] = tasks.splice(action.dropIndex, 1);
                        tasks.splice(action.draggedIndex, 0, task);
                        break;
                }
                
                saveToLocalStorage('tasks', tasks);
                updateUI();
                
                showToast('info', 'Undo', 'Last action has been undone.');
            }
            
            // Redo last undone action
            function redoAction() {
                if (redoStack.length === 0) return;
                
                const action = redoStack.pop();
                undoStack.push(action);
                
                switch (action.type) {
                    case 'create':
                        // Re-add the task
                        tasks.push(action.task);
                        break;
                    
                    case 'update':
                        // Apply new task state
                        const taskToUpdate = tasks.find(t => t.id === action.taskId);
                        if (taskToUpdate) {
                            Object.assign(taskToUpdate, action.newState);
                        }
                        break;
                    
                    case 'delete':
                        // Remove the task again
                        tasks = tasks.filter(t => t.id !== action.task.id);
                        break;
                    
                    case 'reorder':
                        // Apply the reorder again
                        const [task] = tasks.splice(action.draggedIndex, 1);
                        tasks.splice(action.dropIndex, 0, task);
                        break;
                }
                
                saveToLocalStorage('tasks', tasks);
                updateUI();
                
                showToast('info', 'Redo', 'Action has been redone.');
            }
            
            // Add category
            function addCategory() {
                const newCategoryInput = document.getElementById('new-category');
                const categoryName = newCategoryInput.value.trim();
                
                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }
                
                if (categories.includes(categoryName)) {
                    alert('This category already exists');
                    return;
                }
                
                categories.push(categoryName);
                saveToLocalStorage('categories', categories);
                
                newCategoryInput.value = '';
                updateCategoriesDropdowns();
                
                showToast('success', 'Category Added', `"${categoryName}" has been added to categories.`);
            }
            
            // Edit category
            function editCategory(categoryName) {
                const newName = prompt('Enter new name for category:', categoryName);
                
                if (!newName || newName.trim() === '') {
                    return;
                }
                
                if (newName === categoryName) {
                    return;
                }
                
                if (categories.includes(newName)) {
                    alert('This category already exists');
                    return;
                }
                
                // Update category name in categories array
                const index = categories.indexOf(categoryName);
                if (index !== -1) {
                    categories[index] = newName;
                }
                
                // Update category name in tasks
                tasks.forEach(task => {
                    if (task.category === categoryName) {
                        task.category = newName;
                    }
                });
                
                // Save to localStorage
                saveToLocalStorage('categories', categories);
                saveToLocalStorage('tasks', tasks);
                
                // Update UI
                updateCategoriesDropdowns();
                updateTasksList();
                
                showToast('success', 'Category Updated', `"${categoryName}" has been renamed to "${newName}".`);
            }
            
            // Delete category
            function deleteCategory(categoryName) {
                const confirmDelete = confirm(`Are you sure you want to delete the category "${categoryName}"?`);
                
                if (!confirmDelete) {
                    return;
                }
                
                // Check if category is used in tasks
                const tasksWithCategory = tasks.filter(task => task.category === categoryName);
                
                if (tasksWithCategory.length > 0) {
                    const confirmReplacement = confirm(`This category is used in ${tasksWithCategory.length} task(s). Do you want to replace it with "Uncategorized"?`);
                    
                    if (!confirmReplacement) {
                        return;
                    }
                    
                    // Replace category in tasks
                    tasks.forEach(task => {
                        if (task.category === categoryName) {
                            task.category = 'Uncategorized';
                        }
                    });
                    
                    // Add "Uncategorized" category if it doesn't exist
                    if (!categories.includes('Uncategorized')) {
                        categories.push('Uncategorized');
                    }
                }
                
                // Remove category
                categories = categories.filter(c => c !== categoryName);
                
                // Save to localStorage
                saveToLocalStorage('categories', categories);
                saveToLocalStorage('tasks', tasks);
                
                // Update UI
                updateCategoriesDropdowns();
                updateTasksList();
                
                showToast('success', 'Category Deleted', `"${categoryName}" has been deleted.`);
            }
            
            // Load users for the users modal
            function loadUsers() {
                const usersGrid = document.getElementById('users-grid');
                const usersLoader = document.getElementById('users-loader');
                
                usersGrid.innerHTML = '';
                usersLoader.style.display = 'flex';
                
                // Fetch random users from the API
                fetch('https://randomuser.me/api/?results=9')
                    .then(response => response.json())
                    .then(data => {
                        usersLoader.style.display = 'none';
                        
                        data.results.forEach(user => {
                            const userCard = document.createElement('div');
                            userCard.className = 'user-card';
                            
                            const role = ['Manager', 'Staff', 'Customer', 'Admin'][Math.floor(Math.random() * 4)];
                            
                            userCard.innerHTML = `
                                <img src="${user.picture.large}" alt="${user.name.first}" class="user-avatar" loading="lazy">
                                <div class="user-info">
                                    <div class="user-name">${user.name.first} ${user.name.last}</div>
                                    <div class="user-email">${user.email}</div>
                                    <div class="user-role">${role}</div>
                                </div>
                            `;
                            
                            usersGrid.appendChild(userCard);
                        });
                    })
                    .catch(error => {
                        usersLoader.style.display = 'none';
                        usersGrid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                                <p>Error loading users. Please try again.</p>
                                <button class="btn btn-primary" id="retry-users">Retry</button>
                            </div>
                        `;
                        
                        document.getElementById('retry-users').addEventListener('click', loadUsers);
                    });
            }
            
            // Export tasks
            function exportTasks(format) {
                switch (format) {
                    case 'json':
                        // Export as JSON
                        const jsonData = JSON.stringify(tasks, null, 2);
                        
                        // Create blob and download link
                        const blob = new Blob([jsonData], { type: 'application/json' });
                        
                        showBlobContent(blob, 'tasks.json', 'JSON');
                        break;
                    
                    case 'pdf':
                        // Export as PDF
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Add title
                        doc.setFontSize(18);
                        doc.text('Tasks List', 14, 22);
                        
                        // Add date
                        doc.setFontSize(11);
                        doc.text(`Generated on ${new Date().toLocaleDateString()}`, 14, 30);
                        
                        // Add tasks
                        doc.setFontSize(12);
                        let y = 40;
                        
                        tasks.forEach((task, index) => {
                            // Add page if needed
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.setFont(undefined, 'bold');
                            doc.text(`${index + 1}. ${task.title} (${task.completed ? 'Completed' : 'Pending'})`, 14, y);
                            y += 7;
                            
                            doc.setFont(undefined, 'normal');
                            doc.text(`Due: ${new Date(task.dueDate).toLocaleDateString()}`, 20, y);
                            y += 7;
                            
                            doc.text(`Priority: ${capitalizeFirstLetter(task.priority)}`, 20, y);
                            y += 7;
                            
                            doc.text(`Category: ${task.category}`, 20, y);
                            y += 7;
                            
                            if (task.description) {
                                const splitDesc = doc.splitTextToSize(task.description, 180);
                                doc.text(splitDesc, 20, y);
                                y += splitDesc.length * 7;
                            }
                            
                            y += 5;
                        });
                        
                        // Save PDF
                        const pdfData = doc.output('blob');
                        
                        showBlobContent(pdfData, 'tasks.pdf', 'PDF');
                        break;
                    
                    case 'excel':
                        // Export as Excel
                        const wb = XLSX.utils.book_new();
                        
                        // Format tasks for Excel
                        const excelData = tasks.map(task => ({
                            Title: task.title,
                            Description: task.description,
                            'Due Date': new Date(task.dueDate).toLocaleDateString(),
                            Priority: capitalizeFirstLetter(task.priority),
                            Category: task.category,
                            Status: task.completed ? 'Completed' : 'Pending',
                            'Time Spent': formatTime(taskTimers[task.id] || 0)
                        }));
                        
                        const ws = XLSX.utils.json_to_sheet(excelData);
                        XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
                        
                        // Generate and download Excel file
                        const excelBlob = XLSX.write(wb, { bookType: 'xlsx', type: 'blob' });
                        
                        showBlobContent(excelBlob, 'tasks.xlsx', 'Excel');
                        break;
                }
                
                // Close modal
                closeModal(document.getElementById('export-modal'));
            }
            
            // Show blob content and instructions
            function showBlobContent(blob, filename, format) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                
                const downloadUrl = URL.createObjectURL(blob);
                
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h2 class="modal-title">${format} File Generated</h2>
                            <button class="modal-close" aria-label="Close">&times;</button>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <p>Your ${format} file has been generated. Since browsers don't allow automatic downloads in iframes, please follow these steps:</p>
                            <ol style="margin-top: 1rem; margin-left: 1.5rem;">
                                <li>Click on the link below to open the file</li>
                                <li>Use your browser's "Save as" function (right-click or Ctrl+S) to save the file</li>
                            </ol>
                        </div>
                        <div style="text-align: center;">
                            <a href="${downloadUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                                <i class="fas fa-external-link-alt"></i> Open ${format} File
                            </a>
                        </div>
                        <div class="modal-buttons">
                            <button class="btn btn-gray close-blob-modal">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('.modal-close').addEventListener('click', () => {
                    modal.remove();
                    URL.revokeObjectURL(downloadUrl);
                });
                
                modal.querySelector('.close-blob-modal').addEventListener('click', () => {
                    modal.remove();
                    URL.revokeObjectURL(downloadUrl);
                });
            }
            
            // Import tasks
            function importTasks() {
                const fileInput = document.getElementById('import-file');
                const urlInput = document.getElementById('import-url');
                
                if (fileInput.files.length > 0) {
                    // Import from file
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const importedTasks = JSON.parse(e.target.result);
                            processTasks(importedTasks);
                        } catch (error) {
                            alert('Invalid JSON file');
                        }
                    };
                    
                    reader.readAsText(file);
                } else if (urlInput.value.trim()) {
                    // Import from URL
                    fetch(urlInput.value.trim())
                        .then(response => response.json())
                        .then(importedTasks => {
                            processTasks(importedTasks);
                        })
                        .catch(error => {
                            alert('Error fetching tasks from URL');
                        });
                } else {
                    alert('Please select a file or enter a URL');
                    return;
                }
                
                // Process imported tasks
                function processTasks(importedTasks) {
                    if (!Array.isArray(importedTasks)) {
                        alert('Invalid tasks format');
                        return;
                    }
                    
                    // Validate and clean imported tasks
                    const validTasks = importedTasks.filter(task => {
                        return task && task.title && task.dueDate;
                    }).map(task => {
                        // Generate new ID to avoid conflicts
                        const newTask = { ...task, id: generateId() };
                        
                        // Ensure required fields
                        if (!newTask.createdAt) {
                            newTask.createdAt = new Date().toISOString();
                        }
                        
                        if (!newTask.category) {
                            newTask.category = 'Imported';
                        }
                        
                        if (!newTask.priority) {
                            newTask.priority = 'medium';
                        }
                        
                        if (typeof newTask.completed !== 'boolean') {
                            newTask.completed = false;
                        }
                        
                        if (!Array.isArray(newTask.subTasks)) {
                            newTask.subTasks = [];
                        } else {
                            // Generate new IDs for subtasks
                            newTask.subTasks = newTask.subTasks.map(st => ({
                                ...st,
                                id: generateId()
                            }));
                        }
                        
                        return newTask;
                    });
                    
                    if (validTasks.length === 0) {
                        alert('No valid tasks found');
                        return;
                    }
                    
                    // Add new categories if they don't exist
                    const newCategories = new Set();
                    validTasks.forEach(task => {
                        if (task.category && !categories.includes(task.category)) {
                            newCategories.add(task.category);
                        }
                    });
                    
                    categories = [...categories, ...newCategories];
                    saveToLocalStorage('categories', categories);
                    
                    // Add tasks
                    tasks = [...tasks, ...validTasks];
                    saveToLocalStorage('tasks', tasks);
                    
                    // Update UI
                    updateUI();
                    
                    // Close modal
                    closeModal(document.getElementById('import-modal'));
                    
                    // Reset form
                    fileInput.value = '';
                    urlInput.value = '';
                    document.getElementById('file-name').textContent = '';
                    
                    // Add notification
                    addNotification(`${validTasks.length} tasks imported`);
                    
                    // Show toast
                    showToast('success', 'Tasks Imported', `${validTasks.length} tasks have been imported.`);
                }
            }
            
            // Toggle dark mode
            function toggleDarkMode() {
                document.body.classList.toggle('dark');
                
                // Update charts if they exist
                if (statusChart || tasksChart) {
                    initializeCharts();
                }
                
                // Show toast
                const isDark = document.body.classList.contains('dark');
                showToast('info', `${isDark ? 'Dark' : 'Light'} Mode Activated`, `Switched to ${isDark ? 'dark' : 'light'} mode.`);
                
                // Update theme toggle icon
                const themeToggle = document.getElementById('theme-toggle');
                themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                
                // Update dropdown text
                const switchModeText = document.querySelector('#switch-mode span');
                switchModeText.textContent = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
                
                // Update dropdown icon
                const switchModeIcon = document.querySelector('#switch-mode i');
                switchModeIcon.className = isDark ? 'fas fa-sun dropdown-icon' : 'fas fa-moon dropdown-icon';
            }
            
            // Login function
            function login() {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                // Get users from localStorage
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // Find user
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    currentUser = user;
                    saveToLocalStorage('currentUser', currentUser);
                    
                    // Show dashboard
                    showDashboard();
                    
                    // Update profile info
                    updateProfileInfo();
                    
                    // Add notification
                    addNotification('You have logged in');
                    
                    // Show toast
                    showToast('success', 'Login Successful', `Welcome back, ${currentUser.firstName}!`);
                } else {
                    alert('Invalid email or password');
                }
            }
            
            // Register function
            function register() {
                const firstName = document.getElementById('register-firstname').value.trim();
                const lastName = document.getElementById('register-lastname').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const confirmEmail = document.getElementById('register-confirmemail').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirmpassword').value;
                const birthdate = document.getElementById('register-birthdate').value;
                const nationality = document.getElementById('register-nationality').value;
                const role = document.getElementById('register-role').value;
                
                // Validate form
                if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                    alert('Please fill in all fields');
                    return;
                }
                
                if (email !== confirmEmail) {
                    alert('Emails do not match');
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert('Passwords do not match');
                    return;
                }
                
                // Check if email already exists
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.some(u => u.email === email)) {
                    alert('Email already registered');
                    return;
                }
                
                // Create user object
                const newUser = {
                    firstName,
                    lastName,
                    email,
                    password,
                    birthdate,
                    nationality,
                    role,
                    joiningDate: new Date().toISOString(),
                    profileImage: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 100)}.jpg`
                };
                
                // Add user to array
                users.push(newUser);
                
                // Save to localStorage
                saveToLocalStorage('users', users);
                
                // Close modal
                closeModal(document.getElementById('register-modal'));
                
                // Reset form
                document.getElementById('register-firstname').value = '';
                document.getElementById('register-lastname').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-confirmemail').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirmpassword').value = '';
                
                // Show toast
                showToast('success', 'Registration Successful', 'You can now log in with your credentials.');
            }
            
            // Show dashboard
            function showDashboard() {
                document.querySelector('.login-container').style.display = 'none';
                document.querySelector('.dashboard').style.display = 'flex';
            }
            
            // Update profile info
            function updateProfileInfo() {
                if (currentUser) {
                    // Update profile image
                    const profileImg = document.getElementById('profile-img');
                    const profileAvatar = document.getElementById('profile-avatar');
                    
                    profileImg.src = currentUser.profileImage;
                    profileAvatar.src = currentUser.profileImage;
                    
                    // Update profile info
                    document.getElementById('profile-name').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    document.getElementById('profile-email').textContent = currentUser.email;
                    document.getElementById('profile-role').textContent = currentUser.role;
                    document.getElementById('profile-country').textContent = currentUser.nationality;
                    document.getElementById('profile-joining-date').textContent = formatDate(new Date(currentUser.joiningDate));
                }
            }
            
            // Open modal
            function openModal(modal) {
                modal.classList.add('active');
            }
            
            // Close modal
            function closeModal(modal) {
                modal.classList.remove('active');
            }
            
            // Update selected tasks
            function updateSelectedTasks() {
                const selectedCount = selectedTasks.length;
                document.getElementById('selected-count-text').textContent = `${selectedCount} task${selectedCount !== 1 ? 's' : ''} selected`;
                
                if (selectedCount > 0) {
                    document.getElementById('multi-actions-bar').classList.add('active');
                } else {
                    document.getElementById('multi-actions-bar').classList.remove('active');
                }
            }
            
            // Load countries for nationality dropdown
            function loadCountries() {
                const countrySelects = [
                    document.getElementById('register-nationality'),
                    document.getElementById('edit-profile-country')
                ];
                
                fetch('https://restcountries.com/v3.1/all')
                    .then(response => response.json())
                    .then(data => {
                        // Sort countries by name
                        data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                        
                        countrySelects.forEach(select => {
                            if (!select) return;
                            
                            // Clear options except the first one
                            select.innerHTML = '<option value="">Select your country</option>';
                            
                            // Add countries
                            data.forEach(country => {
                                const option = document.createElement('option');
                                option.value = country.name.common;
                                option.textContent = country.name.common;
                                select.appendChild(option);
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error loading countries:', error);
                        
                        // Add some default countries
                        const defaultCountries = [
                            'United States',
                            'United Kingdom',
                            'Canada',
                            'Australia',
                            'Germany',
                            'France',
                            'Japan',
                            'China',
                            'India',
                            'Brazil'
                        ];
                        
                        countrySelects.forEach(select => {
                            if (!select) return;
                            
                            // Clear options except the first one
                            select.innerHTML = '<option value="">Select your country</option>';
                            
                            // Add default countries
                            defaultCountries.forEach(country => {
                                const option = document.createElement('option');
                                option.value = country;
                                option.textContent = country;
                                select.appendChild(option);
                            });
                        });
                    });
            }
            
            // Event listeners
            
            // Login form
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('email').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            // Register link
            document.getElementById('register-link').addEventListener('click', function(e) {
                e.preventDefault();
                openModal(document.getElementById('register-modal'));
            });
            
            // Register form
            document.getElementById('register-create').addEventListener('click', register);
            document.getElementById('register-cancel').addEventListener('click', function() {
                closeModal(document.getElementById('register-modal'));
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function() {
                    closeModal(this.closest('.modal-overlay'));
                });
            });
            
            // Add task form
            document.getElementById('add-task-btn').addEventListener('click', function() {
                openModal(document.getElementById('add-task-modal'));
                
                // Initialize flatpickr
                if (!window.addDatePicker) {
                    window.addDatePicker = flatpickr('#task-due-date', {
                        dateFormat: 'Y-m-d',
                        minDate: 'today'
                    });
                }
            });
            
            document.getElementById('create-task').addEventListener('click', createTask);
            document.getElementById('cancel-add-task').addEventListener('click', function() {
                closeModal(document.getElementById('add-task-modal'));
            });
            
            // Add sub-task button
            document.getElementById('add-sub-task-btn').addEventListener('click', function() {
                const subTasksList = document.getElementById('sub-tasks-list');
                const subTaskItem = document.createElement('div');
                subTaskItem.className = 'sub-task-item';
                subTaskItem.innerHTML = `
                    <input type="text" class="sub-task-input" placeholder="Sub-task" aria-label="Sub-task">
                    <button class="sub-task-remove" aria-label="Remove sub-task">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add event listener for remove button
                subTaskItem.querySelector('.sub-task-remove').addEventListener('click', function() {
                    subTaskItem.remove();
                });
                
                subTasksList.appendChild(subTaskItem);
            });
            
            // Delete sub-task buttons
            document.querySelector('#sub-tasks-list .sub-task-remove').addEventListener('click', function() {
                if (document.querySelectorAll('#sub-tasks-list .sub-task-item').length > 1) {
                    this.closest('.sub-task-item').remove();
                } else {
                    this.closest('.sub-task-item').querySelector('.sub-task-input').value = '';
                }
            });
            
            // Add sub-task button in edit form
            document.getElementById('edit-add-sub-task-btn').addEventListener('click', function() {
                const subTasksList = document.getElementById('edit-sub-tasks-list');
                const subTaskItem = document.createElement('div');
                subTaskItem.className = 'sub-task-item';
                subTaskItem.setAttribute('data-id', generateId());
                subTaskItem.innerHTML = `
                    <input type="text" class="sub-task-input" placeholder="Sub-task" aria-label="Sub-task">
                    <button class="sub-task-remove" aria-label="Remove sub-task">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="sub-task-checkbox" style="margin-left: 0.5rem;">
                        <label class="toggle-switch" aria-label="Mark as complete">
                            <input type="checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                
                // Add event listener for remove button
                subTaskItem.querySelector('.sub-task-remove').addEventListener('click', function() {
                    subTaskItem.remove();
                });
                
                subTasksList.appendChild(subTaskItem);
            });
            
            // Save edited task
            document.getElementById('save-task').addEventListener('click', function() {
                const taskId = this.getAttribute('data-id');
                saveEditedTask(taskId);
            });
            
            document.getElementById('cancel-edit-task').addEventListener('click', function() {
                closeModal(document.getElementById('edit-task-modal'));
            });
            
            // View task
            document.getElementById('close-view-task').addEventListener('click', function() {
                closeModal(document.getElementById('view-task-modal'));
            });
            
            document.getElementById('edit-from-view').addEventListener('click', function() {
                closeModal(document.getElementById('view-task-modal'));
                editTask(this.getAttribute('data-id'));
            });
            
            // Filters
            document.getElementById('status-filter').addEventListener('change', updateTasksList);
            document.getElementById('category-filter').addEventListener('change', updateTasksList);
            document.getElementById('priority-filter').addEventListener('change', updateTasksList);
            document.getElementById('date-filter').addEventListener('change', function() {
                if (this.value === 'custom') {
                    openModal(document.getElementById('date-range-modal'));
                    
                    if (!window.dateRangePicker) {
                        window.dateRangePicker = flatpickr('#date-range-picker', {
                            mode: 'range',
                            dateFormat: 'Y-m-d'
                        });
                    }
                } else {
                    // Reset custom date range
                    window.customDateRange = null;
                    document.getElementById('custom-date-range').value = '';
                    document.getElementById('custom-date-range').disabled = true;
                    
                    updateTasksList();
                }
            });
            
            document.getElementById('sort-by').addEventListener('change', updateTasksList);
            
            // Search input with debounce
            document.getElementById('search-input').addEventListener('input', function() {
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                searchTimeout = setTimeout(() => {
                    updateTasksList();
                }, 300);
            });
            
            // Custom date range
            document.getElementById('apply-date-range').addEventListener('click', function() {
                const dateRange = document.getElementById('date-range-picker').value;
                
                if (!dateRange) {
                    alert('Please select a date range');
                    return;
                }
                
                const dates = dateRange.split(' to ');
                if (dates.length !== 2) {
                    alert('Please select a valid date range');
                    return;
                }
                
                const startDate = new Date(dates[0]);
                const endDate = new Date(dates[1]);
                endDate.setHours(23, 59, 59, 999);
                
                window.customDateRange = [startDate, endDate];
                document.getElementById('custom-date-range').value = dateRange;
                document.getElementById('custom-date-range').disabled = false;
                
                closeModal(document.getElementById('date-range-modal'));
                updateTasksList();
            });
            
            document.getElementById('cancel-date-range').addEventListener('click', function() {
                closeModal(document.getElementById('date-range-modal'));
                document.getElementById('date-filter').value = 'all';
                updateTasksList();
            });
            
            // View switcher
            document.querySelectorAll('.view-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.view-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    const view = this.getAttribute('data-view');
                    
                    if (view === 'list') {
                        document.getElementById('tasks-container').style.display = 'block';
                        document.getElementById('graphs-container').style.display = 'none';
                    } else if (view === 'graph') {
                        document.getElementById('tasks-container').style.display = 'none';
                        document.getElementById('graphs-container').style.display = 'grid';
                        initializeCharts();
                    }
                });
            });
            
            // Multi-select actions
            document.getElementById('complete-selected').addEventListener('click', function() {
                if (selectedTasks.length === 0) return;
                
                // Complete all selected tasks
                selectedTasks.forEach(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (task && !task.completed) {
                        // Save previous state for undo
                        const previousState = JSON.parse(JSON.stringify(task));
                        
                        task.completed = true;
                        
                        // Add to undo stack
                        addToUndoStack({
                            type: 'update',
                            taskId,
                            previousState,
                            newState: JSON.parse(JSON.stringify(task))
                        });
                    }
                });
                
                // Save to localStorage
                saveToLocalStorage('tasks', tasks);
                
                // Clear selection
                selectedTasks = [];
                updateSelectedTasks();
                
                // Update UI
                updateUI();
                
                // Add notification
                addNotification(`${selectedTasks.length} tasks marked as completed`);
                
                // Show toast
                showToast('success', 'Tasks Completed', `${selectedTasks.length} tasks have been marked as completed.`);
            });
            
            document.getElementById('delete-selected').addEventListener('click', function() {
                if (selectedTasks.length === 0) return;
                
                const confirmDelete = confirm(`Are you sure you want to delete ${selectedTasks.length} selected tasks?`);
                if (!confirmDelete) return;
                
                // Delete all selected tasks
                const deletedTasks = [];
                
                selectedTasks.forEach(taskId => {
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        const task = tasks[taskIndex];
                        deletedTasks.push({
                            task: JSON.parse(JSON.stringify(task)),
                            index: taskIndex
                        });
                    }
                });
                
                // Remove tasks
                tasks = tasks.filter(task => !selectedTasks.includes(task.id));
                
                // Save to localStorage
                saveToLocalStorage('tasks', tasks);
                
                // Clear selection
                selectedTasks = [];
                updateSelectedTasks();
                
                // Update UI
                updateUI();
                
                // Add notification
                addNotification(`${deletedTasks.length} tasks were deleted`);
                
                // Add to undo stack
                addToUndoStack({
                    type: 'multi-delete',
                    deletedTasks
                });
                
                // Show toast
                showToast('success', 'Tasks Deleted', `${deletedTasks.length} tasks have been deleted.`);
            });
            
            document.getElementById('cancel-selection').addEventListener('click', function() {
                selectedTasks = [];
                updateSelectedTasks();
                updateTasksList();
            });
            
            // Manage categories
            document.getElementById('manage-categories-btn').addEventListener('click', function() {
                openModal(document.getElementById('categories-modal'));
            });
            
            document.getElementById('add-category-btn').addEventListener('click', addCategory);
            document.getElementById('close-categories').addEventListener('click', function() {
                closeModal(document.getElementById('categories-modal'));
            });
            
            document.getElementById('new-category').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCategory();
                }
            });
            
            // Export button
            document.getElementById('export-btn').addEventListener('click', function() {
                openModal(document.getElementById('export-modal'));
            });
            
            document.getElementById('confirm-export').addEventListener('click', function() {
                const format = document.getElementById('export-format').value;
                exportTasks(format);
            });
            
            document.getElementById('cancel-export').addEventListener('click', function() {
                closeModal(document.getElementById('export-modal'));
            });
            
            // Import button
            document.getElementById('import-btn').addEventListener('click', function() {
                openModal(document.getElementById('import-modal'));
            });
            
            document.getElementById('confirm-import').addEventListener('click', importTasks);
            document.getElementById('cancel-import').addEventListener('click', function() {
                closeModal(document.getElementById('import-modal'));
            });
            
            document.getElementById('import-file').addEventListener('change', function() {
                if (this.files.length > 0) {
                    document.getElementById('file-name').textContent = this.files[0].name;
                } else {
                    document.getElementById('file-name').textContent = '';
                }
            });
            
            // Header actions
            document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
            
            document.getElementById('profile-img').addEventListener('click', function() {
                const dropdown = document.getElementById('profile-dropdown');
                dropdown.classList.toggle('active');
            });
            
            document.getElementById('notification-badge').addEventListener('click', function() {
                const dropdown = document.getElementById('notification-dropdown');
                dropdown.classList.toggle('active');
                updateNotificationList();
            });
            
            document.getElementById('mark-all-read').addEventListener('click', markAllNotificationsAsRead);
            
            document.getElementById('switch-mode').addEventListener('click', function() {
                toggleDarkMode();
                document.getElementById('profile-dropdown').classList.remove('active');
            });
            
            document.getElementById('logout').addEventListener('click', function() {
                // Clear current user
                currentUser = null;
                localStorage.removeItem('currentUser');
                
                // Hide dashboard
                document.querySelector('.dashboard').style.display = 'none';
                document.querySelector('.login-container').style.display = 'flex';
                
                // Hide profile dropdown
                document.getElementById('profile-dropdown').classList.remove('active');
                
                // Show toast
                showToast('info', 'Logged Out', 'You have been logged out.');
            });
            
            document.getElementById('view-profile').addEventListener('click', function() {
                document.getElementById('profile-dropdown').classList.remove('active');
                openModal(document.getElementById('profile-modal'));
            });
            
            document.getElementById('edit-profile').addEventListener('click', function() {
                closeModal(document.getElementById('profile-modal'));
                
                // Fill edit profile form
                document.getElementById('edit-profile-firstname').value = currentUser.firstName;
                document.getElementById('edit-profile-lastname').value = currentUser.lastName;
                document.getElementById('edit-profile-email').value = currentUser.email;
                
                // Set country and role if available
                if (document.getElementById('edit-profile-country').querySelector(`option[value="${currentUser.nationality}"]`)) {
                    document.getElementById('edit-profile-country').value = currentUser.nationality;
                }
                
                document.getElementById('edit-profile-role').value = currentUser.role;
                
                openModal(document.getElementById('edit-profile-modal'));
            });
            
            document.getElementById('save-profile').addEventListener('click', function() {
                // Get form values
                const firstName = document.getElementById('edit-profile-firstname').value.trim();
                const lastName = document.getElementById('edit-profile-lastname').value.trim();
                const email = document.getElementById('edit-profile-email').value.trim();
                const country = document.getElementById('edit-profile-country').value;
                const role = document.getElementById('edit-profile-role').value;
                
                // Validate form
                if (!firstName || !lastName || !email || !country || !role) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Check if email already exists (if changed)
                if (email !== currentUser.email) {
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    if (users.some(u => u.email === email && u.email !== currentUser.email)) {
                        alert('Email already registered');
                        return;
                    }
                }
                
                // Update user
                currentUser.firstName = firstName;
                currentUser.lastName = lastName;
                currentUser.email = email;
                currentUser.nationality = country;
                currentUser.role = role;
                
                // Update users in localStorage
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    saveToLocalStorage('users', users);
                }
                
                // Update current user in localStorage
                saveToLocalStorage('currentUser', currentUser);
                
                // Update profile info
                updateProfileInfo();
                
                // Close modal
                closeModal(document.getElementById('edit-profile-modal'));
                
                // Show toast
                showToast('success', 'Profile Updated', 'Your profile has been updated.');
            });
            
            document.getElementById('close-profile').addEventListener('click', function() {
                closeModal(document.getElementById('profile-modal'));
            });
            
            document.getElementById('cancel-edit-profile').addEventListener('click', function() {
                closeModal(document.getElementById('edit-profile-modal'));
            });
            
            document.getElementById('avatar-edit').addEventListener('click', function() {
                document.getElementById('avatar-upload').click();
            });
            
            document.getElementById('avatar-upload').addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Update avatar
                        document.getElementById('profile-avatar').src = e.target.result;
                        document.getElementById('profile-img').src = e.target.result;
                        
                        // Update current user
                        currentUser.profileImage = e.target.result;
                        
                        // Update users in localStorage
                        const users = JSON.parse(localStorage.getItem('users') || '[]');
                        const userIndex = users.findIndex(u => u.email === currentUser.email);
                        if (userIndex !== -1) {
                            users[userIndex].profileImage = e.target.result;
                            saveToLocalStorage('users', users);
                        }
                        
                        // Update current user in localStorage
                        saveToLocalStorage('currentUser', currentUser);
                        
                        // Show toast
                        showToast('success', 'Avatar Updated', 'Your profile picture has been updated.');
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Users button
            document.getElementById('users-btn').addEventListener('click', function() {
                openModal(document.getElementById('users-modal'));
                loadUsers();
            });
            
            document.getElementById('close-users').addEventListener('click', function() {
                closeModal(document.getElementById('users-modal'));
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                const profileDropdown = document.getElementById('profile-dropdown');
                const profileImg = document.getElementById('profile-img');
                
                if (profileDropdown.classList.contains('active') && !profileDropdown.contains(e.target) && e.target !== profileImg) {
                    profileDropdown.classList.remove('active');
                }
                
                const notificationDropdown = document.getElementById('notification-dropdown');
                const notificationBadge = document.getElementById('notification-badge');
                
                if (notificationDropdown.classList.contains('active') && !notificationDropdown.contains(e.target) && !notificationBadge.contains(e.target)) {
                    notificationDropdown.classList.remove('active');
                }
            });
            
            // Key commands
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Z for Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undoAction();
                }
                
                // Ctrl/Cmd + Shift + Z or Ctrl/Cmd + Y for Redo
                if (((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) || ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                    e.preventDefault();
                    redoAction();
                }
            });
            
            // Initialize Flatpickr instances for birthdate
            flatpickr('#register-birthdate', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
            
            // Load countries
            loadCountries();
            
            // Initialize app
            initializeApp();
        });
    </script>
</body>
</html>
