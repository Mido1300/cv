<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Application</title>
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Flatpickr for date picking -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- XLSX for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Color variables */
            --primary-color: #5D5CDE;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --info-color: #17A2B8;
            --secondary-color: #6C757D;
            --dark-color: #1C2526;
            --light-color: #F8F9FA;
            --white-color: #FFFFFF;
            --black-color: #000000;
            --orange-color: #FD7E14;
            --dark-blue: #00008B;
            
            /* Light mode colors */
            --bg-color: var(--white-color);
            --text-color: var(--dark-color);
            --card-bg: var(--white-color);
            --border-color: #E9ECEF;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --header-bg: linear-gradient(135deg, #1C2526, #000000);
            --header-text: var(--white-color);
            
            /* App specific variables */
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --box-shadow: 0 4px 12px var(--shadow-color);
            --hover-shadow: 0 8px 16px var(--shadow-color);
        }

        .dark {
            /* Dark mode colors */
            --bg-color: #121212;
            --text-color: var(--white-color);
            --card-bg: #1E1E1E;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --header-bg: linear-gradient(135deg, #8B0000, #4B0000);
            --header-text: var(--white-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--header-bg);
            padding: 20px;
        }

        .login-form {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 450px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }

        .login-form-glow {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(93, 92, 222, 0.8) 0%, rgba(93, 92, 222, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.7;
            filter: blur(5px);
            z-index: 0;
            animation: moveGlow 10s infinite alternate;
        }

        @keyframes moveGlow {
            0% { top: 0; left: 0; }
            25% { top: 0; left: calc(100% - 30px); }
            50% { top: calc(100% - 30px); left: calc(100% - 30px); }
            75% { top: calc(100% - 30px); left: 0; }
            100% { top: 0; left: 0; }
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: all var(--transition-speed);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.25);
        }

        .btn {
            display: inline-block;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed);
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4949B3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(93, 92, 222, 0.3);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-login {
            width: 80%;
            display: block;
            margin: 0 auto 20px;
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .register-link a {
            color: var(--dark-blue);
            text-decoration: none;
            font-weight: 600;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        /* Modal/Popup styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            transform: translateY(20px);
            opacity: 0;
            transition: all var(--transition-speed);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: color var(--transition-speed);
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Dashboard Header Styles */
        .header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 100;
        }

        .header-logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--white-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .user-profile {
            position: relative;
            cursor: pointer;
        }

        .profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid transparent;
            transition: all var(--transition-speed);
        }

        .profile-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }

        .status-online .profile-image {
            border-color: var(--success-color);
        }

        .status-offline .profile-image {
            border-color: var(--danger-color);
        }

        .status-break .profile-image {
            border-color: var(--warning-color);
        }

        .status-away .profile-image {
            border-color: var(--secondary-color);
        }

        .theme-switcher {
            background: transparent;
            border: none;
            color: var(--white-color);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all var(--transition-speed);
        }

        .theme-switcher:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-bell {
            position: relative;
            background: transparent;
            border: none;
            color: var(--white-color);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all var(--transition-speed);
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .task-timer {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            font-size: 24px;
            font-weight: 500;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 200px;
            z-index: 100;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all var(--transition-speed);
        }

        .dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            text-decoration: none;
            transition: background-color var(--transition-speed);
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Task Summary Styles */
        .task-summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .task-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .total-tasks {
            grid-column: 1 / -1;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: all var(--transition-speed);
        }

        .total-tasks:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .tasks-count {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .tasks-label {
            font-size: 1rem;
            color: var(--secondary-color);
        }

        .completed-tasks {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border-left: 5px solid var(--success-color);
            transition: all var(--transition-speed);
        }

        .completed-tasks:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .completed-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .pending-tasks {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border-left: 5px solid var(--warning-color);
            transition: all var(--transition-speed);
        }

        .pending-tasks:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .pending-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--warning-color);
        }

        /* Tasks Section Styles */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tasks-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .tasks-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tasks-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .search-container {
            position: relative;
            flex: 2;
            min-width: 200px;
        }

        .search-icon {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        .search-input {
            padding-left: 40px;
        }

        /* Task List Styles */
        .tasks-view-switcher {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .view-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .view-btn:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .view-btn:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }

        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .task-list {
            margin-bottom: 30px;
        }

        .task-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-speed);
            border-left: 5px solid transparent;
        }

        .task-item:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .task-item.completed {
            border-left-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.05);
        }

        .task-item.expired {
            border-left-color: var(--danger-color);
        }

        .task-item.due-soon {
            border-left-color: var(--warning-color);
        }

        .task-checkbox {
            margin-right: 15px;
            position: relative;
        }

        .task-checkbox input[type="checkbox"] {
            opacity: 0;
            position: absolute;
        }

        .checkmark {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        .task-checkbox input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 9px;
            width: 5px;
            height: 10px;
            border: solid var(--primary-color);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .task-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .task-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
            color: var(--secondary-color);
        }

        .task-details {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: var(--secondary-color);
            flex-wrap: wrap;
        }

        .task-due-date, .task-category, .task-priority {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-priority-high {
            color: var(--danger-color);
            font-weight: 500;
        }

        .task-priority-medium {
            color: var(--orange-color);
            font-weight: 500;
        }

        .task-priority-low {
            color: var(--secondary-color);
            font-weight: 500;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-action-btn {
            background-color: transparent;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--secondary-color);
            transition: all var(--transition-speed);
        }

        .task-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        .task-action-btn.edit:hover {
            color: var(--info-color);
        }

        .task-action-btn.delete:hover {
            color: var(--danger-color);
        }

        .task-action-btn.play:hover, .task-action-btn.pause:hover {
            color: var(--success-color);
        }

        /* Multi-select action bar */
        .multi-select-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, var(--primary-color), #4949B3);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            transition: transform var(--transition-speed);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        .multi-select-bar.active {
            transform: translateY(0);
        }

        .selected-count {
            font-weight: 500;
        }

        .multi-select-actions {
            display: flex;
            gap: 10px;
        }

        /* Graph View Styles */
        .graph-view {
            display: none;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .graph-view {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .graph-view.active {
            display: grid;
        }

        .graph-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all var(--transition-speed);
        }

        .graph-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .graph-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Insights Layout Styles */
        .insights-section {
            margin-top: 50px;
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .insights-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .insight-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            transition: all var(--transition-speed);
        }

        .insight-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px);
        }

        .insight-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .insight-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .insight-label {
            color: var(--secondary-color);
        }

        .insight-value {
            font-weight: 500;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px 20px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s, fadeOut 0.3s 4.7s;
            width: 300px;
            pointer-events: none;
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast-info {
            border-left: 4px solid var(--info-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(93, 92, 222, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s infinite linear;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px;
        }

        .loading-text {
            color: var(--secondary-color);
            font-size: 14px;
        }

        /* Animation keyframes */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary-color);
            transition: var(--transition-speed);
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-speed);
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Users Page */
        .users-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .users-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .users-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .user-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all var(--transition-speed);
        }

        .user-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-3px) scale(1.02);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-email, .user-role {
            font-size: 14px;
            color: var(--secondary-color);
        }

        /* Subtask styles */
        .subtasks-list {
            margin-top: 10px;
            padding-left: 25px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .subtask-item.completed {
            text-decoration: line-through;
            color: var(--secondary-color);
        }

        /* Notification styles */
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color var(--transition-speed);
        }

        .notification-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .notification-item.unread {
            border-left: 3px solid var(--primary-color);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .notification-icon.success {
            background-color: var(--success-color);
        }

        .notification-icon.warning {
            background-color: var(--warning-color);
        }

        .notification-icon.danger {
            background-color: var(--danger-color);
        }

        .notification-icon.info {
            background-color: var(--info-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .notification-time {
            font-size: 12px;
            color: var(--secondary-color);
        }

        .notification-actions {
            display: flex;
            gap: 5px;
        }

        .notification-btn {
            background-color: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: var(--secondary-color);
            transition: color var(--transition-speed);
        }

        .notification-btn:hover {
            color: var(--primary-color);
        }

        /* Flatpickr customization */
        .flatpickr-calendar {
            box-shadow: var(--box-shadow) !important;
            border-radius: var(--border-radius) !important;
        }

        /* Custom scrollbar for Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Login Page -->
        <div class="login-container" id="loginPage">
            <div class="login-form">
                <div class="login-form-glow"></div>
                <h2>Login to Todo App</h2>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" value="123456">
                </div>
                <button type="button" id="loginBtn" class="btn btn-primary btn-login">Login</button>
                <div class="register-link">
                    Don't have an account? <a href="#" id="registerLink">Register now</a>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard" style="display: none;">
            <!-- Header -->
            <div class="header">
                <div class="header-logo">To-Do App</div>
                <div class="header-actions">
                    <div class="task-timer" id="taskTimer">00:00:00</div>
                    <button class="notification-bell" id="notificationBell">
                        <i class="fa">🔔</i>
                        <span class="profile-badge" id="notificationBadge">0</span>
                    </button>
                    <button class="theme-switcher" id="themeSwitcher">
                        <i class="fa" id="themeIcon">☀️</i>
                    </button>
                    <div class="user-profile status-online" id="userProfile">
                        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User" class="profile-image" id="profileImage">
                        <span class="profile-badge" id="profileBadge">0</span>
                        <div class="dropdown" id="profileDropdown">
                            <div class="dropdown-item" id="viewProfileBtn">
                                <i class="fa">👤</i> View Profile
                            </div>
                            <div class="dropdown-item" id="statusToggleBtn">
                                <i class="fa">🟢</i> Status: Online
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="switchModeBtn">
                                <i class="fa" id="switchModeIcon">☀️</i> Switch Mode
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" id="logoutBtn">
                                <i class="fa">🚪</i> Logout
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="header-nav" id="navBar">
                <button class="nav-btn active" data-view="tasks">Tasks</button>
                <button class="nav-btn" data-view="users">Users</button>
                <button class="nav-btn" data-view="categories">Manage Categories</button>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Tasks View -->
                <div class="view-content" id="tasksView">
                    <!-- Task Summary -->
                    <div class="task-summary">
                        <div class="total-tasks">
                            <div class="tasks-count" id="totalTasksCount">10</div>
                            <div class="tasks-label">Total Tasks</div>
                        </div>
                        <div class="completed-tasks">
                            <div class="completed-count" id="completedTasksCount">4</div>
                            <div class="tasks-label">Completed Tasks</div>
                        </div>
                        <div class="pending-tasks">
                            <div class="pending-count" id="pendingTasksCount">6</div>
                            <div class="tasks-label">Pending Tasks</div>
                        </div>
                    </div>

                    <!-- Tasks Header -->
                    <div class="tasks-header">
                        <h2 class="tasks-title">Tasks</h2>
                        <div class="tasks-actions">
                            <button class="btn btn-success btn-icon" id="addTaskBtn">
                                <i class="fa">➕</i> Add Task
                            </button>
                            <button class="btn btn-primary btn-icon" id="exportTasksBtn">
                                <i class="fa">📤</i> Export
                            </button>
                            <button class="btn btn-secondary btn-icon" id="importTasksBtn">
                                <i class="fa">📥</i> Import
                            </button>
                        </div>
                    </div>

                    <!-- Tasks Filters -->
                    <div class="tasks-filters">
                        <div class="filter-group">
                            <label for="statusFilter">Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="categoryFilter">Category</label>
                            <select id="categoryFilter" class="form-control">
                                <option value="all">All</option>
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="study">Study</option>
                                <option value="health">Health</option>
                                <option value="finance">Finance</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priorityFilter">Priority</label>
                            <select id="priorityFilter" class="form-control">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="dueDateFilter">Due Date</label>
                            <select id="dueDateFilter" class="form-control">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="search-container">
                            <label for="searchTasks">Search</label>
                            <div style="position: relative;">
                                <span class="search-icon">🔍</span>
                                <input type="text" id="searchTasks" class="form-control search-input" placeholder="Search tasks...">
                            </div>
                        </div>
                    </div>

                    <!-- Sort Options -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;">
                        <div class="filter-group" style="min-width: 200px;">
                            <label for="sortTasks">Sort By</label>
                            <select id="sortTasks" class="form-control">
                                <option value="dueDate-asc">Due Date (Earliest)</option>
                                <option value="dueDate-desc">Due Date (Latest)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                                <option value="priority-desc">Priority (High to Low)</option>
                                <option value="priority-asc">Priority (Low to High)</option>
                            </select>
                        </div>
                        <div class="tasks-view-switcher">
                            <button class="view-btn active" data-view="list">List</button>
                            <button class="view-btn" data-view="graph">Graph</button>
                        </div>
                    </div>

                    <!-- Undo/Redo -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-secondary btn-icon" id="undoBtn" disabled>
                            <i class="fa">↩️</i> Undo
                        </button>
                        <button class="btn btn-secondary btn-icon" id="redoBtn" disabled>
                            <i class="fa">↪️</i> Redo
                        </button>
                    </div>

                    <!-- Task List View -->
                    <div class="task-list" id="taskList">
                        <!-- Tasks will be generated by JavaScript -->
                    </div>

                    <!-- Graph View -->
                    <div class="graph-view" id="graphView">
                        <div class="graph-card">
                            <h3 class="graph-title">Tasks Over Time</h3>
                            <div class="chart-container">
                                <canvas id="tasksTimeChart"></canvas>
                            </div>
                        </div>
                        <div class="graph-card">
                            <h3 class="graph-title">Task Status</h3>
                            <div class="chart-container">
                                <canvas id="tasksPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Multi-select Action Bar -->
                    <div class="multi-select-bar" id="multiSelectBar">
                        <div class="selected-count">
                            <span id="selectedCount">0</span> tasks selected
                        </div>
                        <div class="multi-select-actions">
                            <button class="btn btn-success" id="completeSelectedBtn">
                                Mark as Complete
                            </button>
                            <button class="btn btn-danger" id="deleteSelectedBtn">
                                Delete Selected
                            </button>
                            <button class="btn btn-secondary" id="cancelSelectionBtn">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users View -->
                <div class="view-content" id="usersView" style="display: none;">
                    <h2 class="tasks-title" style="margin-bottom: 20px;">Users</h2>
                    <div class="users-grid" id="usersGrid">
                        <!-- Users will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Categories View -->
                <div class="view-content" id="categoriesView" style="display: none;">
                    <h2 class="tasks-title" style="margin-bottom: 20px;">Manage Categories</h2>
                    <div class="category-manager">
                        <div class="form-group">
                            <label for="newCategory">Add New Category</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newCategory" class="form-control" placeholder="Category name...">
                                <button class="btn btn-success" id="addCategoryBtn">Add</button>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h3 style="margin-bottom: 15px; font-size: 1.2rem;">Existing Categories</h3>
                            <div id="categoriesList" class="task-list">
                                <!-- Categories will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights Section -->
                <div class="insights-section">
                    <h2 class="insights-title">Insights</h2>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h3 class="insight-header">Task Statistics</h3>
                            <div class="insight-content">
                                <div class="insight-item">
                                    <span class="insight-label">Total Tasks</span>
                                    <span class="insight-value" id="insightTotalTasks">10</span>
                                </div>
                                <div class="insight-item">
                                    <span class="insight-label">Completed Tasks</span>
                                    <span class="insight-value" id="insightCompletedTasks">4</span>
                                </div>
                                <div class="insight-item">
                                    <span class="insight-label">Completion Rate</span>
                                    <span class="insight-value" id="insightCompletionRate">40%</span>
                                </div>
                                <div class="insight-item">
                                    <span class="insight-label">Tasks Due Today</span>
                                    <span class="insight-value" id="insightTasksDueToday">2</span>
                                </div>
                            </div>
                        </div>
                        <div class="insight-card">
                            <h3 class="insight-header">Category Breakdown</h3>
                            <div class="insight-content" id="categoriesBreakdown">
                                <!-- Category breakdown will be generated by JavaScript -->
                            </div>
                        </div>
                        <div class="insight-card">
                            <h3 class="insight-header">Priority Breakdown</h3>
                            <div class="insight-content" id="priorityBreakdown">
                                <!-- Priority breakdown will be generated by JavaScript -->
                            </div>
                        </div>
                        <div class="insight-card">
                            <h3 class="insight-header">User Statistics</h3>
                            <div class="insight-content">
                                <div class="insight-item">
                                    <span class="insight-label">Total Users</span>
                                    <span class="insight-value" id="insightTotalUsers">5</span>
                                </div>
                                <div class="insight-item">
                                    <span class="insight-label">Active Users</span>
                                    <span class="insight-value" id="insightActiveUsers">3</span>
                                </div>
                            </div>
                        </div>
                        <div class="insight-card">
                            <h3 class="insight-header">Role Distribution</h3>
                            <div class="insight-content" id="roleDistribution">
                                <!-- Role distribution will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Modals -->
        <!-- Register Modal -->
        <div class="modal-overlay" id="registerModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Register</h3>
                    <button class="modal-close" id="closeRegisterModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="regFirstName">First Name</label>
                        <input type="text" id="regFirstName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regLastName">Last Name</label>
                        <input type="text" id="regLastName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regConfirmEmail">Confirm Email</label>
                        <input type="email" id="regConfirmEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regBirthdate">Birthdate</label>
                        <input type="text" id="regBirthdate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="regNationality">Nationality</label>
                        <select id="regNationality" class="form-control" required>
                            <option value="">Select Country</option>
                            <!-- Countries will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regRole">Role</label>
                        <select id="regRole" class="form-control" required>
                            <option value="manager">Manager</option>
                            <option value="staff">Staff</option>
                            <option value="customer">Customer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelRegisterBtn">Cancel</button>
                    <button class="btn btn-success" id="createAccountBtn">Create</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Task Modal -->
        <div class="modal-overlay" id="taskModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="taskModalTitle">Add Task</h3>
                    <button class="modal-close" id="closeTaskModal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="taskId">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="taskSubtasks">Subtasks</label>
                        <div id="subtasksContainer">
                            <div class="subtask-input" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="form-control subtask-title" placeholder="Subtask title...">
                                <button type="button" class="btn btn-danger remove-subtask-btn">✕</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" id="addSubtaskBtn" style="margin-top: 10px;">
                            <i class="fa">➕</i> Add Subtask
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="form-control" required>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" class="form-control" required>
                            <option value="work">Work</option>
                            <option value="personal">Personal</option>
                            <option value="study">Study</option>
                            <option value="health">Health</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskNotes">Notes</label>
                        <textarea id="taskNotes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelTaskBtn">Cancel</button>
                    <button class="btn btn-success" id="saveTaskBtn">Save</button>
                </div>
            </div>
        </div>

        <!-- View Task Modal -->
        <div class="modal-overlay" id="viewTaskModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="viewTaskTitle">Task Details</h3>
                    <button class="modal-close" id="closeViewTaskModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="viewTaskContent"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="closeViewTaskBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Export Tasks Modal -->
        <div class="modal-overlay" id="exportModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Export Tasks</h3>
                    <button class="modal-close" id="closeExportModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="exportFormat">Select Format</label>
                        <select id="exportFormat" class="form-control">
                            <option value="pdf">PDF</option>
                            <option value="json">JSON</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelExportBtn">Cancel</button>
                    <button class="btn btn-primary" id="confirmExportBtn">Export</button>
                </div>
            </div>
        </div>

        <!-- Import Tasks Modal -->
        <div class="modal-overlay" id="importModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Import Tasks</h3>
                    <button class="modal-close" id="closeImportModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Import Method</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-primary" id="fileImportBtn">Upload JSON File</button>
                            <button class="btn btn-secondary" id="urlImportBtn">Import from URL</button>
                        </div>
                    </div>
                    <div id="fileImportSection" style="display: none;">
                        <div class="form-group">
                            <label for="importFile">Select JSON File</label>
                            <input type="file" id="importFile" class="form-control" accept=".json">
                        </div>
                    </div>
                    <div id="urlImportSection" style="display: none;">
                        <div class="form-group">
                            <label for="importUrl">Enter URL</label>
                            <input type="url" id="importUrl" class="form-control" placeholder="https://example.com/tasks.json">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelImportBtn">Cancel</button>
                    <button class="btn btn-success" id="confirmImportBtn">Import</button>
                </div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div class="modal-overlay" id="profileModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">User Profile</h3>
                    <button class="modal-close" id="closeProfileModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                        <div style="position: relative; width: 100px; height: 100px;">
                            <img id="profileModalImage" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                            <label for="profileImageUpload" style="position: absolute; bottom: 0; right: 0; background: var(--primary-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer;">
                                <i class="fa">📷</i>
                            </label>
                            <input type="file" id="profileImageUpload" style="display: none;" accept="image/*">
                        </div>
                    </div>
                    <div id="profileContent"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="closeProfileViewBtn">Close</button>
                    <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div class="modal-overlay" id="editProfileModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Profile</h3>
                    <button class="modal-close" id="closeEditProfileModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email</label>
                        <input type="email" id="editEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Phone</label>
                        <input type="tel" id="editPhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editCountry">Country</label>
                        <select id="editCountry" class="form-control">
                            <!-- Countries will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelEditProfileBtn">Cancel</button>
                    <button class="btn btn-success" id="saveProfileBtn">Save</button>
                </div>
            </div>
        </div>

        <!-- Notifications Modal -->
        <div class="modal-overlay" id="notificationsModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Notifications</h3>
                    <button class="modal-close" id="closeNotificationsModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="notification-list" id="notificationsList">
                        <!-- Notifications will be generated by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="closeNotificationsBtn">Close</button>
                    <button class="btn btn-primary" id="markAllReadBtn">Mark All as Read</button>
                </div>
            </div>
        </div>

        <!-- Status Modal -->
        <div class="modal-overlay" id="statusModal">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Change Status</h3>
                    <button class="modal-close" id="closeStatusModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Select Status</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                            <div class="status-option" data-status="online" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-speed);">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: var(--success-color);"></div>
                                <span>Online</span>
                            </div>
                            <div class="status-option" data-status="break" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-speed);">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: var(--warning-color);"></div>
                                <span>Break</span>
                            </div>
                            <div class="status-option" data-status="away" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-speed);">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: var(--secondary-color);"></div>
                                <span>Away</span>
                            </div>
                            <div class="status-option" data-status="offline" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: var(--border-radius); cursor: pointer; transition: all var(--transition-speed);">
                                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: var(--danger-color);"></div>
                                <span>Offline</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Date Range Modal -->
        <div class="modal-overlay" id="dateRangeModal">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Select Date Range</h3>
                    <button class="modal-close" id="closeDateRangeModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="text" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="text" id="endDate" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelDateRangeBtn">Cancel</button>
                    <button class="btn btn-primary" id="applyDateRangeBtn">Apply</button>
                </div>
            </div>
        </div>

        <!-- Edit Category Modal -->
        <div class="modal-overlay" id="editCategoryModal">
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Category</h3>
                    <button class="modal-close" id="closeEditCategoryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="categoryId">
                    <div class="form-group">
                        <label for="editCategoryName">Category Name</label>
                        <input type="text" id="editCategoryName" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelEditCategoryBtn">Cancel</button>
                    <button class="btn btn-success" id="saveEditCategoryBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }

        // Listen for changes to color scheme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App State Management
        const AppState = {
            user: null,
            tasks: [],
            users: [],
            categories: [],
            notifications: [],
            activeTaskTimer: null,
            taskTimerInterval: null,
            elapsedTime: 0,
            history: [], // For undo/redo
            historyIndex: -1, // Current position in history
            selectedTasks: [], // For multi-select
            filters: {
                status: 'all',
                category: 'all',
                priority: 'all',
                dueDate: 'all',
                search: '',
                dateRange: {
                    start: null,
                    end: null
                }
            },
            sort: {
                field: 'dueDate',
                direction: 'asc'
            },
            viewMode: 'list',
            init() {
                this.loadDataFromLocalStorage();
                this.generateRandomData();
            },
            // Load data from localStorage
            loadDataFromLocalStorage() {
                const user = localStorage.getItem('todoAppUser');
                if (user) {
                    this.user = JSON.parse(user);
                }

                const tasks = localStorage.getItem('todoAppTasks');
                if (tasks) {
                    this.tasks = JSON.parse(tasks);
                }

                const users = localStorage.getItem('todoAppUsers');
                if (users) {
                    this.users = JSON.parse(users);
                }

                const categories = localStorage.getItem('todoAppCategories');
                if (categories) {
                    this.categories = JSON.parse(categories);
                } else {
                    // Default categories
                    this.categories = [
                        { id: 'work', name: 'Work' },
                        { id: 'personal', name: 'Personal' },
                        { id: 'study', name: 'Study' },
                        { id: 'health', name: 'Health' },
                        { id: 'finance', name: 'Finance' }
                    ];
                }

                const notifications = localStorage.getItem('todoAppNotifications');
                if (notifications) {
                    this.notifications = JSON.parse(notifications);
                }
            },
            // Save data to localStorage
            saveDataToLocalStorage() {
                localStorage.setItem('todoAppUser', JSON.stringify(this.user));
                localStorage.setItem('todoAppTasks', JSON.stringify(this.tasks));
                localStorage.setItem('todoAppUsers', JSON.stringify(this.users));
                localStorage.setItem('todoAppCategories', JSON.stringify(this.categories));
                localStorage.setItem('todoAppNotifications', JSON.stringify(this.notifications));
            },
            // Generate random data for demo
            generateRandomData() {
                // Generate default categories if none
                if (this.categories.length === 0) {
                    this.categories = [
                        { id: 'work', name: 'Work' },
                        { id: 'personal', name: 'Personal' },
                        { id: 'study', name: 'Study' },
                        { id: 'health', name: 'Health' },
                        { id: 'finance', name: 'Finance' }
                    ];
                }

                // Generate random tasks if none
                if (this.tasks.length === 0) {
                    const taskTitles = [
                        'Complete project proposal',
                        'Schedule team meeting',
                        'Prepare presentation',
                        'Review design mockups',
                        'Update documentation',
                        'Fix reported bugs',
                        'Research new technologies',
                        'Set up development environment',
                        'Write unit tests',
                        'Deploy to production'
                    ];

                    const taskDescriptions = [
                        'Finish the detailed proposal document with budget and timeline',
                        'Coordinate with team members for the weekly status meeting',
                        'Create slides and prepare talking points for client presentation',
                        'Review and provide feedback on the new design mockups',
                        'Update the technical documentation with recent changes',
                        'Address the bugs reported in the issue tracker',
                        'Research and evaluate new technologies for future projects',
                        'Set up local development environment with latest dependencies',
                        'Write comprehensive unit tests for the new features',
                        'Deploy the latest version to the production environment'
                    ];

                    const subtaskExamples = [
                        ['Research competitors', 'Draft executive summary', 'Prepare budget estimates'],
                        ['Book conference room', 'Prepare agenda', 'Send invitations'],
                        ['Gather data', 'Create graphs', 'Practice delivery'],
                        ['Check mobile responsiveness', 'Verify accessibility', 'Test different browsers'],
                        ['Update API documentation', 'Add code examples', 'Review formatting'],
                        ['Reproduce issues', 'Debug and fix', 'Test solutions'],
                        ['Read blog posts', 'Watch tutorial videos', 'Create proof of concept'],
                        ['Install dependencies', 'Configure environment variables', 'Run test suite'],
                        ['Write test cases', 'Set up test fixtures', 'Run tests and fix issues'],
                        ['Run final tests', 'Create backup', 'Execute deployment script']
                    ];

                    const categories = ['work', 'personal', 'study', 'health', 'finance'];
                    const priorities = ['high', 'medium', 'low'];
                    const today = new Date();

                    this.tasks = [];
                    for (let i = 0; i < 10; i++) {
                        const dueDate = new Date(today);
                        dueDate.setDate(today.getDate() + Math.floor(Math.random() * 14) - 5); // Random date from 5 days ago to 9 days in future

                        const completed = Math.random() > 0.6; // 40% chance of being completed
                        
                        // Create subtasks with different completed states
                        const subtasks = [];
                        const thisTaskSubtasks = subtaskExamples[i];
                        if (thisTaskSubtasks) {
                            for (let j = 0; j < thisTaskSubtasks.length; j++) {
                                subtasks.push({
                                    id: `subtask-${i}-${j}`,
                                    title: thisTaskSubtasks[j],
                                    completed: completed || Math.random() > 0.5 // More likely to be completed if parent is completed
                                });
                            }
                        }

                        const task = {
                            id: `task-${i}`,
                            title: taskTitles[i],
                            description: taskDescriptions[i],
                            completed: completed,
                            dueDate: dueDate.toISOString(),
                            timeSpent: Math.floor(Math.random() * 36000), // Random time spent in seconds (up to 10 hours)
                            category: categories[Math.floor(Math.random() * categories.length)],
                            priority: priorities[Math.floor(Math.random() * priorities.length)],
                            notes: 'Additional notes for this task.',
                            subtasks: subtasks,
                            createdAt: new Date(today.getTime() - Math.floor(Math.random() * 10 * 24 * 60 * 60 * 1000)).toISOString() // Random creation date up to 10 days ago
                        };

                        this.tasks.push(task);
                    }
                }

                // Generate random users if none
                if (this.users.length === 0) {
                    const roles = ['manager', 'staff', 'customer', 'admin'];
                    
                    this.users = [
                        {
                            id: 'user-1',
                            firstName: 'John',
                            lastName: 'Doe',
                            email: 'test@example.com',
                            password: '123456', // In a real app, passwords should be hashed!
                            birthdate: '1990-01-01',
                            nationality: 'United States',
                            role: 'admin',
                            avatar: 'https://randomuser.me/api/portraits/men/1.jpg',
                            status: 'online',
                            joiningDate: new Date().toISOString()
                        }
                    ];

                    // Add 4 additional random users
                    for (let i = 2; i <= 5; i++) {
                        const gender = Math.random() > 0.5 ? 'men' : 'women';
                        const randomNum = Math.floor(Math.random() * 50) + 1;
                        
                        this.users.push({
                            id: `user-${i}`,
                            firstName: `User${i}`,
                            lastName: `Test${i}`,
                            email: `user${i}@example.com`,
                            password: '123456', // In a real app, passwords should be hashed!
                            birthdate: `199${i}-01-01`,
                            nationality: 'United Kingdom',
                            role: roles[Math.floor(Math.random() * roles.length)],
                            avatar: `https://randomuser.me/api/portraits/${gender}/${randomNum}.jpg`,
                            status: Math.random() > 0.5 ? 'online' : 'offline',
                            joiningDate: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString() // Random date within last 90 days
                        });
                    }
                }

                // Generate random notifications if none
                if (this.notifications.length === 0) {
                    this.notifications = [
                        {
                            id: 'notif-1',
                            title: 'Task due soon',
                            message: `"${this.tasks[0]?.title}" is due in 2 days.`,
                            type: 'warning',
                            read: false,
                            createdAt: new Date().toISOString(),
                            relatedId: this.tasks[0]?.id
                        },
                        {
                            id: 'notif-2',
                            title: 'Task completed',
                            message: `"${this.tasks[1]?.title}" was marked as completed.`,
                            type: 'success',
                            read: true,
                            createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            relatedId: this.tasks[1]?.id
                        },
                        {
                            id: 'notif-3',
                            title: 'New task created',
                            message: `New task "${this.tasks[2]?.title}" was created.`,
                            type: 'info',
                            read: false,
                            createdAt: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                            relatedId: this.tasks[2]?.id
                        }
                    ];
                }

                this.saveDataToLocalStorage();
            },
            // Add task
            addTask(task) {
                // Save current state for undo/redo
                this.saveHistoryState();
                
                this.tasks.push(task);
                this.saveDataToLocalStorage();
                
                // Add notification
                this.addNotification({
                    title: 'Task created',
                    message: `New task "${task.title}" was created.`,
                    type: 'info',
                    relatedId: task.id
                });
                
                return task;
            },
            // Update task
            updateTask(taskId, updatedTask) {
                // Save current state for undo/redo
                this.saveHistoryState();
                
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    this.tasks[index] = { ...this.tasks[index], ...updatedTask };
                    this.saveDataToLocalStorage();
                    
                    // Add notification
                    this.addNotification({
                        title: 'Task updated',
                        message: `Task "${this.tasks[index].title}" was updated.`,
                        type: 'info',
                        relatedId: taskId
                    });
                    
                    return this.tasks[index];
                }
                return null;
            },
            // Delete task
            deleteTask(taskId) {
                // Save current state for undo/redo
                this.saveHistoryState();
                
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    const deletedTask = this.tasks[index];
                    this.tasks.splice(index, 1);
                    this.saveDataToLocalStorage();
                    
                    // Add notification
                    this.addNotification({
                        title: 'Task deleted',
                        message: `Task "${deletedTask.title}" was deleted.`,
                        type: 'danger',
                        relatedId: taskId
                    });
                    
                    return deletedTask;
                }
                return null;
            },
            // Toggle task completion
            toggleTaskCompletion(taskId) {
                // Save current state for undo/redo
                this.saveHistoryState();
                
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    const task = this.tasks[index];
                    task.completed = !task.completed;
                    this.saveDataToLocalStorage();
                    
                    // Add notification
                    this.addNotification({
                        title: task.completed ? 'Task completed' : 'Task reopened',
                        message: `Task "${task.title}" was ${task.completed ? 'completed' : 'reopened'}.`,
                        type: task.completed ? 'success' : 'info',
                        relatedId: taskId
                    });
                    
                    return task;
                }
                return null;
            },
            // Toggle subtask completion
            toggleSubtaskCompletion(taskId, subtaskId) {
                // Save current state for undo/redo
                this.saveHistoryState();
                
                const taskIndex = this.tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    const task = this.tasks[taskIndex];
                    const subtaskIndex = task.subtasks.findIndex(subtask => subtask.id === subtaskId);
                    if (subtaskIndex !== -1) {
                        const subtask = task.subtasks[subtaskIndex];
                        subtask.completed = !subtask.completed;
                        this.saveDataToLocalStorage();
                        return subtask;
                    }
                }
                return null;
            },
            // Update task timer
            updateTaskTimer(taskId, timeSpent) {
                const index = this.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    this.tasks[index].timeSpent = timeSpent;
                    this.saveDataToLocalStorage();
                    return this.tasks[index];
                }
                return null;
            },
            // Add notification
            addNotification(notification) {
                const newNotification = {
                    id: `notif-${Date.now()}`,
                    title: notification.title,
                    message: notification.message,
                    type: notification.type || 'info',
                    read: false,
                    createdAt: new Date().toISOString(),
                    relatedId: notification.relatedId
                };
                
                this.notifications.unshift(newNotification);
                this.saveDataToLocalStorage();
                
                // Update notification badges
                UI.updateNotificationBadges();
                
                return newNotification;
            },
            // Mark notification as read
            markNotificationAsRead(notificationId) {
                const index = this.notifications.findIndex(notif => notif.id === notificationId);
                if (index !== -1) {
                    this.notifications[index].read = true;
                    this.saveDataToLocalStorage();
                    
                    // Update notification badges
                    UI.updateNotificationBadges();
                    
                    return this.notifications[index];
                }
                return null;
            },
            // Mark all notifications as read
            markAllNotificationsAsRead() {
                this.notifications.forEach(notif => {
                    notif.read = true;
                });
                this.saveDataToLocalStorage();
                
                // Update notification badges
                UI.updateNotificationBadges();
                
                return this.notifications;
            },
            // Add category
            addCategory(category) {
                const newCategory = {
                    id: category.id || category.name.toLowerCase().replace(/\s+/g, '-'),
                    name: category.name
                };
                
                this.categories.push(newCategory);
                this.saveDataToLocalStorage();
                
                return newCategory;
            },
            // Update category
            updateCategory(categoryId, updatedCategory) {
                const index = this.categories.findIndex(cat => cat.id === categoryId);
                if (index !== -1) {
                    this.categories[index] = { 
                        ...this.categories[index], 
                        ...updatedCategory,
                        id: updatedCategory.id || updatedCategory.name.toLowerCase().replace(/\s+/g, '-')
                    };
                    this.saveDataToLocalStorage();
                    
                    // Update tasks with this category
                    if (categoryId !== this.categories[index].id) {
                        this.tasks.forEach(task => {
                            if (task.category === categoryId) {
                                task.category = this.categories[index].id;
                            }
                        });
                        this.saveDataToLocalStorage();
                    }
                    
                    return this.categories[index];
                }
                return null;
            },
            // Delete category
            deleteCategory(categoryId) {
                const index = this.categories.findIndex(cat => cat.id === categoryId);
                if (index !== -1) {
                    const deletedCategory = this.categories[index];
                    this.categories.splice(index, 1);
                    
                    // Update tasks with this category (set to 'uncategorized')
                    this.tasks.forEach(task => {
                        if (task.category === categoryId) {
                            task.category = 'uncategorized';
                        }
                    });
                    
                    this.saveDataToLocalStorage();
                    return deletedCategory;
                }
                return null;
            },
            // Start task timer
            startTaskTimer(taskId) {
                if (this.activeTaskTimer) {
                    // Pause the current timer first
                    this.pauseTaskTimer();
                }
                
                this.activeTaskTimer = taskId;
                this.elapsedTime = 0;
                
                const task = this.tasks.find(task => task.id === taskId);
                if (task) {
                    this.elapsedTime = task.timeSpent || 0;
                }
                
                this.taskTimerInterval = setInterval(() => {
                    this.elapsedTime++;
                    UI.updateTaskTimerDisplay();
                    this.updateTaskTimer(taskId, this.elapsedTime);
                }, 1000);
                
                return taskId;
            },
            // Pause task timer
            pauseTaskTimer() {
                if (this.taskTimerInterval) {
                    clearInterval(this.taskTimerInterval);
                    this.taskTimerInterval = null;
                    
                    if (this.activeTaskTimer) {
                        const taskId = this.activeTaskTimer;
                        this.activeTaskTimer = null;
                        
                        return taskId;
                    }
                }
                return null;
            },
            // Format time (seconds) to HH:MM:SS
            formatTime(seconds) {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },
            // Get filtered tasks
            getFilteredTasks() {
                return this.tasks.filter(task => {
                    // Status filter
                    if (this.filters.status === 'active' && task.completed) {
                        return false;
                    }
                    if (this.filters.status === 'completed' && !task.completed) {
                        return false;
                    }
                    
                    // Category filter
                    if (this.filters.category !== 'all' && task.category !== this.filters.category) {
                        return false;
                    }
                    
                    // Priority filter
                    if (this.filters.priority !== 'all' && task.priority !== this.filters.priority) {
                        return false;
                    }
                    
                    // Due date filter
                    if (this.filters.dueDate !== 'all') {
                        const dueDate = new Date(task.dueDate);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        const weekLater = new Date(today);
                        weekLater.setDate(weekLater.getDate() + 7);
                        
                        const monthLater = new Date(today);
                        monthLater.setMonth(monthLater.getMonth() + 1);
                        
                        if (this.filters.dueDate === 'today') {
                            if (dueDate < today || dueDate >= tomorrow) {
                                return false;
                            }
                        } else if (this.filters.dueDate === 'week') {
                            if (dueDate < today || dueDate >= weekLater) {
                                return false;
                            }
                        } else if (this.filters.dueDate === 'month') {
                            if (dueDate < today || dueDate >= monthLater) {
                                return false;
                            }
                        } else if (this.filters.dueDate === 'custom' && this.filters.dateRange.start && this.filters.dateRange.end) {
                            const start = new Date(this.filters.dateRange.start);
                            start.setHours(0, 0, 0, 0);
                            
                            const end = new Date(this.filters.dateRange.end);
                            end.setHours(23, 59, 59, 999);
                            
                            if (dueDate < start || dueDate > end) {
                                return false;
                            }
                        }
                    }
                    
                    // Search filter
                    if (this.filters.search) {
                        const searchTerm = this.filters.search.toLowerCase();
                        const title = task.title.toLowerCase();
                        const description = task.description ? task.description.toLowerCase() : '';
                        
                        if (!title.includes(searchTerm) && !description.includes(searchTerm)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            },
            // Sort tasks
            getSortedTasks(tasks) {
                return [...tasks].sort((a, b) => {
                    if (this.sort.field === 'title') {
                        if (this.sort.direction === 'asc') {
                            return a.title.localeCompare(b.title);
                        } else {
                            return b.title.localeCompare(a.title);
                        }
                    } else if (this.sort.field === 'dueDate') {
                        const dateA = new Date(a.dueDate);
                        const dateB = new Date(b.dueDate);
                        
                        if (this.sort.direction === 'asc') {
                            return dateA - dateB;
                        } else {
                            return dateB - dateA;
                        }
                    } else if (this.sort.field === 'priority') {
                        const priorityMap = { high: 3, medium: 2, low: 1 };
                        const priorityA = priorityMap[a.priority] || 0;
                        const priorityB = priorityMap[b.priority] || 0;
                        
                        if (this.sort.direction === 'asc') {
                            return priorityA - priorityB;
                        } else {
                            return priorityB - priorityA;
                        }
                    }
                    
                    return 0;
                });
            },
            // Save history state for undo/redo
            saveHistoryState() {
                // If we've done some actions and then undo some of them,
                // we need to remove any actions after the current position
                if (this.historyIndex !== -1 && this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                
                // Create a deep copy of the current tasks state
                const stateCopy = JSON.stringify(this.tasks);
                
                // Add to history
                this.history.push(stateCopy);
                this.historyIndex = this.history.length - 1;
                
                // Limit history size (optional)
                if (this.history.length > 20) {
                    this.history.shift();
                    this.historyIndex--;
                }
                
                // Update UI buttons
                UI.updateUndoRedoButtons();
            },
            // Undo the last action
            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.tasks = JSON.parse(this.history[this.historyIndex]);
                    this.saveDataToLocalStorage();
                    
                    // Update UI
                    UI.updateTasksList();
                    UI.updateUndoRedoButtons();
                    UI.updateTaskSummary();
                    UI.updateInsightsData();
                    UI.updateGraphs();
                    
                    return true;
                }
                return false;
            },
            // Redo the previously undone action
            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.tasks = JSON.parse(this.history[this.historyIndex]);
                    this.saveDataToLocalStorage();
                    
                    // Update UI
                    UI.updateTasksList();
                    UI.updateUndoRedoButtons();
                    UI.updateTaskSummary();
                    UI.updateInsightsData();
                    UI.updateGraphs();
                    
                    return true;
                }
                return false;
            },
            // Get counts for all categories
            getCategoryCounts() {
                const counts = {};
                this.categories.forEach(category => {
                    counts[category.id] = 0;
                });
                
                this.tasks.forEach(task => {
                    if (counts[task.category] !== undefined) {
                        counts[task.category]++;
                    } else {
                        counts[task.category] = 1;
                    }
                });
                
                return counts;
            },
            // Get counts for all priorities
            getPriorityCounts() {
                const counts = {
                    high: 0,
                    medium: 0,
                    low: 0
                };
                
                this.tasks.forEach(task => {
                    if (counts[task.priority] !== undefined) {
                        counts[task.priority]++;
                    }
                });
                
                return counts;
            },
            // Get tasks due today
            getTasksDueToday() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                return this.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    return dueDate >= today && dueDate < tomorrow;
                });
            },
            // Get tasks due soon (within next 48 hours)
            getTasksDueSoon() {
                const now = new Date();
                const fortyEightHoursLater = new Date(now.getTime() + 48 * 60 * 60 * 1000);
                
                return this.tasks.filter(task => {
                    if (task.completed) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    return dueDate > now && dueDate <= fortyEightHoursLater;
                });
            },
            // Get expired tasks
            getExpiredTasks() {
                const now = new Date();
                
                return this.tasks.filter(task => {
                    if (task.completed) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    return dueDate < now;
                });
            },
            // Get role counts
            getRoleCounts() {
                const counts = {
                    manager: 0,
                    staff: 0,
                    customer: 0,
                    admin: 0
                };
                
                this.users.forEach(user => {
                    if (counts[user.role] !== undefined) {
                        counts[user.role]++;
                    }
                });
                
                return counts;
            },
            // Get active users count
            getActiveUsers() {
                return this.users.filter(user => user.status === 'online').length;
            }
        };

        // UI Handler
        const UI = {
            init() {
                this.bindElements();
                this.bindEvents();
                this.initFlatpickr();
                this.fetchCountries();
                
                // Start with login page
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                
                // Update theme icon based on current mode
                this.updateThemeIcon();
            },
            // Bind DOM elements to variables
            bindElements() {
                // Login/Register
                this.loginBtn = document.getElementById('loginBtn');
                this.registerLink = document.getElementById('registerLink');
                this.closeRegisterModal = document.getElementById('closeRegisterModal');
                this.cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
                this.createAccountBtn = document.getElementById('createAccountBtn');
                
                // Dashboard navigation
                this.navButtons = document.querySelectorAll('.nav-btn');
                this.viewsContent = document.querySelectorAll('.view-content');
                
                // User profile
                this.userProfile = document.getElementById('userProfile');
                this.profileDropdown = document.getElementById('profileDropdown');
                this.viewProfileBtn = document.getElementById('viewProfileBtn');
                this.statusToggleBtn = document.getElementById('statusToggleBtn');
                this.switchModeBtn = document.getElementById('switchModeBtn');
                this.logoutBtn = document.getElementById('logoutBtn');
                
                // Theme switcher
                this.themeSwitcher = document.getElementById('themeSwitcher');
                this.themeIcon = document.getElementById('themeIcon');
                this.switchModeIcon = document.getElementById('switchModeIcon');
                
                // Notification bell
                this.notificationBell = document.getElementById('notificationBell');
                this.notificationBadge = document.getElementById('notificationBadge');
                this.profileBadge = document.getElementById('profileBadge');
                
                // Task management
                this.addTaskBtn = document.getElementById('addTaskBtn');
                this.closeTaskModal = document.getElementById('closeTaskModal');
                this.cancelTaskBtn = document.getElementById('cancelTaskBtn');
                this.saveTaskBtn = document.getElementById('saveTaskBtn');
                this.addSubtaskBtn = document.getElementById('addSubtaskBtn');
                
                // Task list
                this.taskList = document.getElementById('taskList');
                
                // Filters
                this.statusFilter = document.getElementById('statusFilter');
                this.categoryFilter = document.getElementById('categoryFilter');
                this.priorityFilter = document.getElementById('priorityFilter');
                this.dueDateFilter = document.getElementById('dueDateFilter');
                this.searchTasks = document.getElementById('searchTasks');
                this.sortTasks = document.getElementById('sortTasks');
                
                // View switcher
                this.viewButtons = document.querySelectorAll('.view-btn');
                this.taskListView = document.getElementById('taskList');
                this.graphView = document.getElementById('graphView');
                
                // Undo/Redo
                this.undoBtn = document.getElementById('undoBtn');
                this.redoBtn = document.getElementById('redoBtn');
                
                // Multi-select
                this.multiSelectBar = document.getElementById('multiSelectBar');
                this.selectedCount = document.getElementById('selectedCount');
                this.completeSelectedBtn = document.getElementById('completeSelectedBtn');
                this.deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                this.cancelSelectionBtn = document.getElementById('cancelSelectionBtn');
                
                // Export/Import
                this.exportTasksBtn = document.getElementById('exportTasksBtn');
                this.importTasksBtn = document.getElementById('importTasksBtn');
                
                // Categories
                this.addCategoryBtn = document.getElementById('addCategoryBtn');
                this.categoriesList = document.getElementById('categoriesList');
                
                // Task timer
                this.taskTimer = document.getElementById('taskTimer');
            },
            // Bind events to elements
            bindEvents() {
                // Login/Register
                this.loginBtn.addEventListener('click', this.handleLogin.bind(this));
                this.registerLink.addEventListener('click', this.showRegisterModal.bind(this));
                this.closeRegisterModal.addEventListener('click', this.hideRegisterModal.bind(this));
                this.cancelRegisterBtn.addEventListener('click', this.hideRegisterModal.bind(this));
                this.createAccountBtn.addEventListener('click', this.handleRegister.bind(this));
                
                // Dashboard navigation
                this.navButtons.forEach(btn => {
                    btn.addEventListener('click', this.handleNavigation.bind(this));
                });
                
                // User profile
                this.userProfile.addEventListener('click', this.toggleProfileDropdown.bind(this));
                this.viewProfileBtn.addEventListener('click', this.showProfileModal.bind(this));
                this.statusToggleBtn.addEventListener('click', this.showStatusModal.bind(this));
                this.switchModeBtn.addEventListener('click', this.toggleTheme.bind(this));
                this.logoutBtn.addEventListener('click', this.handleLogout.bind(this));
                
                // Theme switcher
                this.themeSwitcher.addEventListener('click', this.toggleTheme.bind(this));
                
                // Notification bell
                this.notificationBell.addEventListener('click', this.showNotificationsModal.bind(this));
                
                // Task management
                this.addTaskBtn.addEventListener('click', this.showAddTaskModal.bind(this));
                this.closeTaskModal.addEventListener('click', this.hideTaskModal.bind(this));
                this.cancelTaskBtn.addEventListener('click', this.hideTaskModal.bind(this));
                this.saveTaskBtn.addEventListener('click', this.handleSaveTask.bind(this));
                this.addSubtaskBtn.addEventListener('click', this.addSubtaskInput.bind(this));
                
                // Filters
                this.statusFilter.addEventListener('change', this.applyFilters.bind(this));
                this.categoryFilter.addEventListener('change', this.applyFilters.bind(this));
                this.priorityFilter.addEventListener('change', this.applyFilters.bind(this));
                this.dueDateFilter.addEventListener('change', this.handleDueDateFilter.bind(this));
                this.searchTasks.addEventListener('input', this.debounce(this.applyFilters.bind(this), 300));
                this.sortTasks.addEventListener('change', this.applySorting.bind(this));
                
                // View switcher
                this.viewButtons.forEach(btn => {
                    btn.addEventListener('click', this.toggleView.bind(this));
                });
                
                // Undo/Redo
                this.undoBtn.addEventListener('click', this.handleUndo.bind(this));
                this.redoBtn.addEventListener('click', this.handleRedo.bind(this));
                
                // Multi-select
                this.completeSelectedBtn.addEventListener('click', this.completeSelectedTasks.bind(this));
                this.deleteSelectedBtn.addEventListener('click', this.deleteSelectedTasks.bind(this));
                this.cancelSelectionBtn.addEventListener('click', this.cancelSelection.bind(this));
                
                // Export/Import
                this.exportTasksBtn.addEventListener('click', this.showExportModal.bind(this));
                this.importTasksBtn.addEventListener('click', this.showImportModal.bind(this));
                
                // Category management
                this.addCategoryBtn.addEventListener('click', this.handleAddCategory.bind(this));
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', this.handleOutsideClick.bind(this));

                // Listener for status options
                document.querySelectorAll('.status-option').forEach(option => {
                    option.addEventListener('click', this.changeUserStatus.bind(this));
                });
                
                // Listener for mark all notifications as read
                document.getElementById('markAllReadBtn').addEventListener('click', this.markAllNotificationsAsRead.bind(this));
                
                // Date range modal
                document.getElementById('applyDateRangeBtn').addEventListener('click', this.applyDateRange.bind(this));
                document.getElementById('cancelDateRangeBtn').addEventListener('click', () => {
                    this.hideModal('dateRangeModal');
                });
                document.getElementById('closeDateRangeModal').addEventListener('click', () => {
                    this.hideModal('dateRangeModal');
                });
            },
            // Initialize Flatpickr date pickers
            initFlatpickr() {
                // Registration birthdate picker
                flatpickr('#regBirthdate', {
                    dateFormat: 'Y-m-d',
                    maxDate: 'today'
                });
                
                // Task due date picker
                flatpickr('#taskDueDate', {
                    dateFormat: 'Y-m-d',
                    minDate: 'today'
                });
                
                // Date range pickers
                flatpickr('#startDate', {
                    dateFormat: 'Y-m-d',
                    onChange: function(selectedDates, dateStr, instance) {
                        const endDatePicker = document.getElementById('endDate')._flatpickr;
                        endDatePicker.set('minDate', dateStr);
                    }
                });
                
                flatpickr('#endDate', {
                    dateFormat: 'Y-m-d'
                });
            },
            // Fetch countries for nationality dropdown
            fetchCountries() {
                fetch('https://restcountries.com/v3.1/all')
                    .then(response => response.json())
                    .then(data => {
                        // Sort countries by name
                        data.sort((a, b) => {
                            return a.name.common.localeCompare(b.name.common);
                        });
                        
                        // Populate dropdowns
                        const regNationalitySelect = document.getElementById('regNationality');
                        const editCountrySelect = document.getElementById('editCountry');
                        
                        data.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country.name.common;
                            option.textContent = country.name.common;
                            regNationalitySelect.appendChild(option.cloneNode(true));
                            editCountrySelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching countries:', error);
                        // Fallback with a few countries
                        const countries = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Japan', 'China', 'India', 'Brazil'];
                        const regNationalitySelect = document.getElementById('regNationality');
                        const editCountrySelect = document.getElementById('editCountry');
                        
                        countries.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country;
                            option.textContent = country;
                            regNationalitySelect.appendChild(option.cloneNode(true));
                            editCountrySelect.appendChild(option);
                        });
                    });
            },
            // Handle login
            handleLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    this.showToast('Please enter both email and password.', 'error');
                    return;
                }
                
                // Find user
                const user = AppState.users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Set current user
                    AppState.user = user;
                    
                    // Update profile image
                    document.getElementById('profileImage').src = user.avatar;
                    
                    // Save to local storage
                    AppState.saveDataToLocalStorage();
                    
                    // Show dashboard
                    this.showDashboard();
                    
                    // Show welcome toast
                    this.showToast(`Welcome, ${user.firstName}!`, 'success');
                } else {
                    this.showToast('Invalid email or password.', 'error');
                }
            },
            // Show register modal
            showRegisterModal() {
                this.showModal('registerModal');
            },
            // Hide register modal
            hideRegisterModal() {
                this.hideModal('registerModal');
            },
            // Handle registration
            handleRegister() {
                const firstName = document.getElementById('regFirstName').value;
                const lastName = document.getElementById('regLastName').value;
                const email = document.getElementById('regEmail').value;
                const confirmEmail = document.getElementById('regConfirmEmail').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;
                const birthdate = document.getElementById('regBirthdate').value;
                const nationality = document.getElementById('regNationality').value;
                const role = document.getElementById('regRole').value;
                
                // Validation
                if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                    this.showToast('Please fill in all fields.', 'error');
                    return;
                }
                
                if (email !== confirmEmail) {
                    this.showToast('Emails do not match.', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showToast('Passwords do not match.', 'error');
                    return;
                }
                
                // Check if email already exists
                if (AppState.users.some(u => u.email === email)) {
                    this.showToast('Email already registered.', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: `user-${Date.now()}`,
                    firstName,
                    lastName,
                    email,
                    password, // In a real app, passwords should be hashed!
                    birthdate,
                    nationality,
                    role,
                    avatar: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 50) + 1}.jpg`,
                    status: 'online',
                    joiningDate: new Date().toISOString()
                };
                
                AppState.users.push(newUser);
                AppState.saveDataToLocalStorage();
                
                this.hideRegisterModal();
                this.showToast('Account created successfully! You can now login.', 'success');
            },
            // Show dashboard
            showDashboard() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Initialize dashboard data
                this.initializeDashboard();
            },
            // Initialize dashboard data
            initializeDashboard() {
                // Update task summary
                this.updateTaskSummary();
                
                // Load tasks
                this.updateTasksList();
                
                // Load categories
                this.updateCategoriesList();
                this.updateCategoryDropdowns();
                
                // Load users
                this.updateUsersList();
                
                // Update notification badges
                this.updateNotificationBadges();
                
                // Initialize graphs
                this.initializeGraphs();
                
                // Update insights data
                this.updateInsightsData();
            },
            // Update task summary counts
            updateTaskSummary() {
                const totalTasks = AppState.tasks.length;
                const completedTasks = AppState.tasks.filter(task => task.completed).length;
                const pendingTasks = totalTasks - completedTasks;
                
                document.getElementById('totalTasksCount').textContent = totalTasks;
                document.getElementById('completedTasksCount').textContent = completedTasks;
                document.getElementById('pendingTasksCount').textContent = pendingTasks;
            },
            // Update tasks list based on current filters and sorting
            updateTasksList() {
                const filteredTasks = AppState.getFilteredTasks();
                const sortedTasks = AppState.getSortedTasks(filteredTasks);
                
                this.taskList.innerHTML = '';
                
                if (sortedTasks.length === 0) {
                    this.taskList.innerHTML = '<div class="no-tasks" style="text-align: center; padding: 20px; color: var(--secondary-color);">No tasks found.</div>';
                    return;
                }
                
                sortedTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.classList.add('task-item');
                    taskItem.dataset.id = task.id;
                    
                    if (task.completed) {
                        taskItem.classList.add('completed');
                    } else {
                        // Check if task is expired or due soon
                        const dueDate = new Date(task.dueDate);
                        const now = new Date();
                        
                        if (dueDate < now) {
                            taskItem.classList.add('expired');
                        } else if (dueDate <= new Date(now.getTime() + 48 * 60 * 60 * 1000)) {
                            taskItem.classList.add('due-soon');
                        }
                    }
                    
                    // Task checkbox for multi-select
                    const taskCheckbox = document.createElement('label');
                    taskCheckbox.classList.add('task-checkbox');
                    taskCheckbox.innerHTML = `
                        <input type="checkbox" class="task-select" data-id="${task.id}">
                        <span class="checkmark"></span>
                    `;
                    
                    // Task content
                    const taskContent = document.createElement('div');
                    taskContent.classList.add('task-content');
                    
                    const formattedDueDate = new Date(task.dueDate).toLocaleDateString();
                    const categoryName = AppState.categories.find(cat => cat.id === task.category)?.name || task.category;
                    
                    // Determine priority class
                    let priorityClass = '';
                    let priorityText = '';
                    
                    if (task.priority === 'high') {
                        priorityClass = 'task-priority-high';
                        priorityText = 'High';
                    } else if (task.priority === 'medium') {
                        priorityClass = 'task-priority-medium';
                        priorityText = 'Medium';
                    } else {
                        priorityClass = 'task-priority-low';
                        priorityText = 'Low';
                    }
                    
                    taskContent.innerHTML = `
                        <div class="task-title">${task.title}</div>
                        <div class="task-details">
                            <div class="task-due-date">
                                <i class="fa">📅</i> ${formattedDueDate}
                            </div>
                            <div class="task-category">
                                <i class="fa">🏷️</i> ${categoryName}
                            </div>
                            <div class="task-priority ${priorityClass}">
                                <i class="fa">🔔</i> ${priorityText}
                            </div>
                        </div>
                    `;
                    
                    // If task has subtasks, add them
                    if (task.subtasks && task.subtasks.length > 0) {
                        const subtasksList = document.createElement('div');
                        subtasksList.classList.add('subtasks-list');
                        
                        task.subtasks.forEach(subtask => {
                            const subtaskItem = document.createElement('div');
                            subtaskItem.classList.add('subtask-item');
                            if (subtask.completed) {
                                subtaskItem.classList.add('completed');
                            }
                            
                            subtaskItem.innerHTML = `
                                <input type="checkbox" class="subtask-checkbox" data-task-id="${task.id}" data-subtask-id="${subtask.id}" ${subtask.completed ? 'checked' : ''}>
                                <span>${subtask.title}</span>
                            `;
                            
                            subtasksList.appendChild(subtaskItem);
                        });
                        
                        taskContent.appendChild(subtasksList);
                    }
                    
                    // Task actions
                    const taskActions = document.createElement('div');
                    taskActions.classList.add('task-actions');
                    
                    taskActions.innerHTML = `
                        <button class="task-action-btn view" data-id="${task.id}" title="View">
                            <i class="fa">👁️</i>
                        </button>
                        <button class="task-action-btn edit" data-id="${task.id}" title="Edit">
                            <i class="fa">✏️</i>
                        </button>
                        <button class="task-action-btn delete" data-id="${task.id}" title="Delete">
                            <i class="fa">🗑️</i>
                        </button>
                        <button class="task-action-btn ${task.id === AppState.activeTaskTimer ? 'pause' : 'play'}" data-id="${task.id}" title="${task.id === AppState.activeTaskTimer ? 'Pause Timer' : 'Start Timer'}">
                            <i class="fa">${task.id === AppState.activeTaskTimer ? '⏸️' : '▶️'}</i>
                        </button>
                        <label class="toggle-switch">
                            <input type="checkbox" class="task-toggle" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    `;
                    
                    taskItem.appendChild(taskCheckbox);
                    taskItem.appendChild(taskContent);
                    taskItem.appendChild(taskActions);
                    
                    this.taskList.appendChild(taskItem);
                });
                
                // Add event listeners to task actions
                document.querySelectorAll('.task-action-btn.view').forEach(btn => {
                    btn.addEventListener('click', this.showViewTaskModal.bind(this));
                });
                
                document.querySelectorAll('.task-action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', this.showEditTaskModal.bind(this));
                });
                
                document.querySelectorAll('.task-action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', this.handleDeleteTask.bind(this));
                });
                
                document.querySelectorAll('.task-action-btn.play, .task-action-btn.pause').forEach(btn => {
                    btn.addEventListener('click', this.toggleTaskTimer.bind(this));
                });
                
                document.querySelectorAll('.task-toggle').forEach(toggle => {
                    toggle.addEventListener('change', this.handleToggleTaskCompletion.bind(this));
                });
                
                document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', this.handleToggleSubtaskCompletion.bind(this));
                });
                
                document.querySelectorAll('.task-select').forEach(checkbox => {
                    checkbox.addEventListener('change', this.handleTaskSelection.bind(this));
                });
            },
            // Update categories list in the Manage Categories view
            updateCategoriesList() {
                const categoriesList = document.getElementById('categoriesList');
                categoriesList.innerHTML = '';
                
                AppState.categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.classList.add('task-item');
                    categoryItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-title">${category.name}</div>
                        </div>
                        <div class="task-actions">
                            <button class="task-action-btn edit" data-id="${category.id}" title="Edit">
                                <i class="fa">✏️</i>
                            </button>
                            <button class="task-action-btn delete" data-id="${category.id}" title="Delete">
                                <i class="fa">🗑️</i>
                            </button>
                        </div>
                    `;
                    
                    categoriesList.appendChild(categoryItem);
                });
                
                // Add event listeners to category actions
                document.querySelectorAll('#categoriesList .task-action-btn.edit').forEach(btn => {
                    btn.addEventListener('click', this.showEditCategoryModal.bind(this));
                });
                
                document.querySelectorAll('#categoriesList .task-action-btn.delete').forEach(btn => {
                    btn.addEventListener('click', this.handleDeleteCategory.bind(this));
                });
            },
            // Update category dropdowns
            updateCategoryDropdowns() {
                const categoryFilter = document.getElementById('categoryFilter');
                const taskCategory = document.getElementById('taskCategory');
                
                // Save currently selected values
                const currentFilterValue = categoryFilter.value;
                const currentTaskValue = taskCategory.value;
                
                // Clear existing options (except "All" for filter)
                while (categoryFilter.options.length > 1) {
                    categoryFilter.remove(1);
                }
                
                while (taskCategory.options.length > 0) {
                    taskCategory.remove(0);
                }
                
                // Add categories to dropdowns
                AppState.categories.forEach(category => {
                    const filterOption = document.createElement('option');
                    filterOption.value = category.id;
                    filterOption.textContent = category.name;
                    categoryFilter.appendChild(filterOption);
                    
                    const taskOption = document.createElement('option');
                    taskOption.value = category.id;
                    taskOption.textContent = category.name;
                    taskCategory.appendChild(taskOption);
                });
                
                // Restore selected values if they still exist
                if (Array.from(categoryFilter.options).some(option => option.value === currentFilterValue)) {
                    categoryFilter.value = currentFilterValue;
                }
                
                if (Array.from(taskCategory.options).some(option => option.value === currentTaskValue)) {
                    taskCategory.value = currentTaskValue;
                }
            },
            // Update users list in the Users view
            updateUsersList() {
                const usersGrid = document.getElementById('usersGrid');
                usersGrid.innerHTML = '';
                
                AppState.users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.classList.add('user-card');
                    
                    userCard.innerHTML = `
                        <img src="${user.avatar}" alt="${user.firstName}" class="user-avatar">
                        <div class="user-info">
                            <div class="user-name">${user.firstName} ${user.lastName}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-role">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</div>
                        </div>
                    `;
                    
                    usersGrid.appendChild(userCard);
                });
            },
            // Handle navigation between views
            handleNavigation(event) {
                const viewName = event.target.dataset.view;
                
                // Update active button
                this.navButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Show selected view
                this.viewsContent.forEach(view => {
                    view.style.display = 'none';
                });
                document.getElementById(`${viewName}View`).style.display = 'block';
            },
            // Toggle profile dropdown
            toggleProfileDropdown(event) {
                event.stopPropagation();
                this.profileDropdown.classList.toggle('active');
            },
            // Update notification badges
            updateNotificationBadges() {
                const unreadCount = AppState.notifications.filter(notif => !notif.read).length;
                
                this.notificationBadge.textContent = unreadCount;
                this.profileBadge.textContent = unreadCount;
                
                if (unreadCount > 0) {
                    this.notificationBadge.style.display = 'flex';
                    this.profileBadge.style.display = 'flex';
                } else {
                    this.notificationBadge.style.display = 'none';
                    this.profileBadge.style.display = 'none';
                }
            },
            // Show notifications modal
            showNotificationsModal() {
                const notificationsList = document.getElementById('notificationsList');
                notificationsList.innerHTML = '';
                
                if (AppState.notifications.length === 0) {
                    notificationsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--secondary-color);">No notifications.</div>';
                } else {
                    AppState.notifications.forEach(notification => {
                        const notificationItem = document.createElement('div');
                        notificationItem.classList.add('notification-item');
                        
                        if (!notification.read) {
                            notificationItem.classList.add('unread');
                        }
                        
                        let iconClass = '';
                        let iconSymbol = '';
                        
                        if (notification.type === 'success') {
                            iconClass = 'success';
                            iconSymbol = '✓';
                        } else if (notification.type === 'warning') {
                            iconClass = 'warning';
                            iconSymbol = '⚠️';
                        } else if (notification.type === 'danger') {
                            iconClass = 'danger';
                            iconSymbol = '✕';
                        } else {
                            iconClass = 'info';
                            iconSymbol = 'ℹ️';
                        }
                        
                        const formattedTime = new Date(notification.createdAt).toLocaleString();
                        
                        notificationItem.innerHTML = `
                            <div class="notification-icon ${iconClass}">
                                ${iconSymbol}
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-message">${notification.message}</div>
                                <div class="notification-time">${formattedTime}</div>
                            </div>
                            <div class="notification-actions">
                                ${notification.read ? '' : `
                                <button class="notification-btn mark-read" data-id="${notification.id}">
                                    <i class="fa">✓</i>
                                </button>
                                `}
                                ${notification.relatedId ? `
                                <button class="notification-btn view-related" data-id="${notification.relatedId}">
                                    <i class="fa">👁️</i>
                                </button>
                                ` : ''}
                            </div>
                        `;
                        
                        notificationsList.appendChild(notificationItem);
                    });
                    
                    // Add event listeners to notification actions
                    document.querySelectorAll('.notification-btn.mark-read').forEach(btn => {
                        btn.addEventListener('click', this.markNotificationAsRead.bind(this));
                    });
                    
                    document.querySelectorAll('.notification-btn.view-related').forEach(btn => {
                        btn.addEventListener('click', this.viewRelatedItem.bind(this));
                    });
                }
                
                this.showModal('notificationsModal');
            },
            // Mark notification as read
            markNotificationAsRead(event) {
                const notificationId = event.currentTarget.dataset.id;
                AppState.markNotificationAsRead(notificationId);
                
                // Update UI
                event.currentTarget.parentElement.parentElement.classList.remove('unread');
                event.currentTarget.remove();
                
                this.updateNotificationBadges();
            },
            // Mark all notifications as read
            markAllNotificationsAsRead() {
                AppState.markAllNotificationsAsRead();
                
                // Update UI
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('unread');
                });
                
                document.querySelectorAll('.notification-btn.mark-read').forEach(btn => {
                    btn.remove();
                });
                
                this.updateNotificationBadges();
            },
            // View related item from notification
            viewRelatedItem(event) {
                const relatedId = event.currentTarget.dataset.id;
                const task = AppState.tasks.find(task => task.id === relatedId);
                
                if (task) {
                    this.hideModal('notificationsModal');
                    
                    // Ensure we're on the tasks view
                    this.navButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector('.nav-btn[data-view="tasks"]').classList.add('active');
                    
                    this.viewsContent.forEach(view => {
                        view.style.display = 'none';
                    });
                    document.getElementById('tasksView').style.display = 'block';
                    
                    // Show task details
                    this.showTaskDetails(task);
                }
            },
            // Show task details in view modal
            showTaskDetails(task) {
                document.getElementById('viewTaskTitle').textContent = task.title;
                
                const viewTaskContent = document.getElementById('viewTaskContent');
                const formattedDueDate = new Date(task.dueDate).toLocaleDateString();
                const categoryName = AppState.categories.find(cat => cat.id === task.category)?.name || task.category;
                const timeSpent = AppState.formatTime(task.timeSpent || 0);
                
                let priorityClass = '';
                let priorityText = '';
                
                if (task.priority === 'high') {
                    priorityClass = 'task-priority-high';
                    priorityText = 'High';
                } else if (task.priority === 'medium') {
                    priorityClass = 'task-priority-medium';
                    priorityText = 'Medium';
                } else {
                    priorityClass = 'task-priority-low';
                    priorityText = 'Low';
                }
                
                let subtasksHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    subtasksHtml = `
                        <div style="margin-top: 15px;">
                            <h4 style="margin-bottom: 10px;">Subtasks</h4>
                            <ul style="padding-left: 20px;">
                                ${task.subtasks.map(subtask => `
                                    <li style="${subtask.completed ? 'text-decoration: line-through; color: var(--secondary-color);' : ''}">
                                        ${subtask.title}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                viewTaskContent.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin-bottom: 5px;">Description</h4>
                        <p>${task.description || 'No description provided.'}</p>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin-bottom: 5px;">Due Date</h4>
                            <p>${formattedDueDate}</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Category</h4>
                            <p>${categoryName}</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Priority</h4>
                            <p class="${priorityClass}">${priorityText}</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Status</h4>
                            <p>${task.completed ? 'Completed' : 'Pending'}</p>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 5px;">Time Spent</h4>
                            <p>${timeSpent}</p>
                        </div>
                    </div>
                    
                    ${subtasksHtml}
                    
                    ${task.notes ? `
                        <div style="margin-top: 15px;">
                            <h4 style="margin-bottom: 5px;">Notes</h4>
                            <p>${task.notes}</p>
                        </div>
                    ` : ''}
                `;
                
                this.showModal('viewTaskModal');
            },
            // Show view task modal
            showViewTaskModal(event) {
                const taskId = event.currentTarget.dataset.id;
                const task = AppState.tasks.find(task => task.id === taskId);
                
                if (task) {
                    this.showTaskDetails(task);
                }
            },
            // Show add task modal
            showAddTaskModal() {
                document.getElementById('taskModalTitle').textContent = 'Add Task';
                document.getElementById('taskId').value = '';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskCategory').value = AppState.categories[0]?.id || '';
                document.getElementById('taskNotes').value = '';
                
                // Clear subtasks
                const subtasksContainer = document.getElementById('subtasksContainer');
                subtasksContainer.innerHTML = `
                    <div class="subtask-input" style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="form-control subtask-title" placeholder="Subtask title...">
                        <button type="button" class="btn btn-danger remove-subtask-btn">✕</button>
                    </div>
                `;
                
                // Add event listener to remove button
                subtasksContainer.querySelector('.remove-subtask-btn').addEventListener('click', function() {
                    this.parentElement.remove();
                });
                
                this.showModal('taskModal');
            },
            // Show edit task modal
            showEditTaskModal(event) {
                const taskId = event.currentTarget.dataset.id;
                const task = AppState.tasks.find(task => task.id === taskId);
                
                if (task) {
                    document.getElementById('taskModalTitle').textContent = 'Edit Task';
                    document.getElementById('taskId').value = task.id;
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskDueDate').value = task.dueDate.split('T')[0];
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskCategory').value = task.category;
                    document.getElementById('taskNotes').value = task.notes || '';
                    
                    // Clear and populate subtasks
                    const subtasksContainer = document.getElementById('subtasksContainer');
                    subtasksContainer.innerHTML = '';
                    
                    if (task.subtasks && task.subtasks.length > 0) {
                        task.subtasks.forEach(subtask => {
                            const subtaskInput = document.createElement('div');
                            subtaskInput.classList.add('subtask-input');
                            subtaskInput.style.display = 'flex';
                            subtaskInput.style.gap = '10px';
                            subtaskInput.style.marginBottom = '10px';
                            
                            subtaskInput.innerHTML = `
                                <input type="text" class="form-control subtask-title" placeholder="Subtask title..." value="${subtask.title}" data-id="${subtask.id}" data-completed="${subtask.completed}">
                                <button type="button" class="btn btn-danger remove-subtask-btn">✕</button>
                            `;
                            
                            subtasksContainer.appendChild(subtaskInput);
                        });
                    } else {
                        // Add an empty subtask input
                        const subtaskInput = document.createElement('div');
                        subtaskInput.classList.add('subtask-input');
                        subtaskInput.style.display = 'flex';
                        subtaskInput.style.gap = '10px';
                        subtaskInput.style.marginBottom = '10px';
                        
                        subtaskInput.innerHTML = `
                            <input type="text" class="form-control subtask-title" placeholder="Subtask title...">
                            <button type="button" class="btn btn-danger remove-subtask-btn">✕</button>
                        `;
                        
                        subtasksContainer.appendChild(subtaskInput);
                    }
                    
                    // Add event listeners to remove buttons
                    document.querySelectorAll('.remove-subtask-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            this.parentElement.remove();
                        });
                    });
                    
                    this.showModal('taskModal');
                }
            },
            // Hide task modal
            hideTaskModal() {
                this.hideModal('taskModal');
            },
            // Add subtask input to task modal
            addSubtaskInput() {
                const subtasksContainer = document.getElementById('subtasksContainer');
                const subtaskInput = document.createElement('div');
                subtaskInput.classList.add('subtask-input');
                subtaskInput.style.display = 'flex';
                subtaskInput.style.gap = '10px';
                subtaskInput.style.marginBottom = '10px';
                
                subtaskInput.innerHTML = `
                    <input type="text" class="form-control subtask-title" placeholder="Subtask title...">
                    <button type="button" class="btn btn-danger remove-subtask-btn">✕</button>
                `;
                
                subtasksContainer.appendChild(subtaskInput);
                
                // Add event listener to remove button
                subtaskInput.querySelector('.remove-subtask-btn').addEventListener('click', function() {
                    this.parentElement.remove();
                });
            },
            // Handle save task (create or update)
            handleSaveTask() {
                const taskId = document.getElementById('taskId').value;
                const title = document.getElementById('taskTitle').value;
                const description = document.getElementById('taskDescription').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const priority = document.getElementById('taskPriority').value;
                const category = document.getElementById('taskCategory').value;
                const notes = document.getElementById('taskNotes').value;
                
                // Validation
                if (!title || !dueDate || !priority || !category) {
                    this.showToast('Please fill in all required fields.', 'error');
                    return;
                }
                
                // Get subtasks
                const subtaskInputs = document.querySelectorAll('.subtask-title');
                const subtasks = [];
                
                subtaskInputs.forEach(input => {
                    const title = input.value.trim();
                    if (title) {
                        const subtask = {
                            id: input.dataset.id || `subtask-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                            title: title,
                            completed: input.dataset.completed === 'true'
                        };
                        subtasks.push(subtask);
                    }
                });
                
                if (taskId) {
                    // Update existing task
                    const updatedTask = {
                        title,
                        description,
                        dueDate: new Date(dueDate).toISOString(),
                        priority,
                        category,
                        notes,
                        subtasks
                    };
                    
                    AppState.updateTask(taskId, updatedTask);
                    this.showToast('Task updated successfully', 'success');
                } else {
                    // Create new task
                    const newTask = {
                        id: `task-${Date.now()}`,
                        title,
                        description,
                        completed: false,
                        dueDate: new Date(dueDate).toISOString(),
                        timeSpent: 0,
                        priority,
                        category,
                        notes,
                        subtasks,
                        createdAt: new Date().toISOString()
                    };
                    
                    AppState.addTask(newTask);
                    this.showToast('Task created successfully', 'success');
                }
                
                // Update UI
                this.hideTaskModal();
                this.updateTasksList();
                this.updateTaskSummary();
                this.updateInsightsData();
                this.updateGraphs();
            },
            // Handle delete task
            handleDeleteTask(event) {
                const taskId = event.currentTarget.dataset.id;
                const task = AppState.tasks.find(task => task.id === taskId);
                
                if (confirm(`Are you sure you want to delete the task "${task.title}"?`)) {
                    AppState.deleteTask(taskId);
                    
                    // Update UI
                    this.updateTasksList();
                    this.updateTaskSummary();
                    this.updateInsightsData();
                    this.updateGraphs();
                    
                    this.showToast('Task deleted successfully', 'success');
                }
            },
            // Handle task completion toggle
            handleToggleTaskCompletion(event) {
                const taskId = event.currentTarget.dataset.id;
                const task = AppState.toggleTaskCompletion(taskId);
                
                // Update UI
                this.updateTasksList();
                this.updateTaskSummary();
                this.updateInsightsData();
                this.updateGraphs();
                
                this.showToast(`Task ${task.completed ? 'completed' : 'reopened'} successfully`, 'success');
            },
            // Handle subtask completion toggle
            handleToggleSubtaskCompletion(event) {
                const taskId = event.currentTarget.dataset.taskId;
                const subtaskId = event.currentTarget.dataset.subtaskId;
                
                AppState.toggleSubtaskCompletion(taskId, subtaskId);
                
                // Update UI for the parent task item
                const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`);
                if (taskItem) {
                    const subtaskItem = taskItem.querySelector(`.subtask-item[data-subtask-id="${subtaskId}"]`);
                    if (subtaskItem) {
                        subtaskItem.classList.toggle('completed');
                    }
                }
            },
            // Toggle task timer
            toggleTaskTimer(event) {
                const taskId = event.currentTarget.dataset.id;
                const isPlaying = event.currentTarget.classList.contains('pause');
                
                if (isPlaying) {
                    // Pause timer
                    const pausedTaskId = AppState.pauseTaskTimer();
                    if (pausedTaskId) {
                        const task = AppState.tasks.find(task => task.id === pausedTaskId);
                        const timeSpent = AppState.formatTime(task.timeSpent || 0);
                        
                        this.showToast(`Worked on "${task.title}" for ${timeSpent}`, 'info');
                        
                        // Update UI
                        event.currentTarget.classList.remove('pause');
                        event.currentTarget.classList.add('play');
                        event.currentTarget.innerHTML = '<i class="fa">▶️</i>';
                        event.currentTarget.title = 'Start Timer';
                    }
                } else {
                    // Start timer
                    const startedTaskId = AppState.startTaskTimer(taskId);
                    if (startedTaskId) {
                        const task = AppState.tasks.find(task => task.id === startedTaskId);
                        
                        this.showToast(`Started timer for "${task.title}"`, 'info');
                        
                        // Update all play/pause buttons
                        document.querySelectorAll('.task-action-btn.pause').forEach(btn => {
                            btn.classList.remove('pause');
                            btn.classList.add('play');
                            btn.innerHTML = '<i class="fa">▶️</i>';
                            btn.title = 'Start Timer';
                        });
                        
                        // Update this button
                        event.currentTarget.classList.remove('play');
                        event.currentTarget.classList.add('pause');
                        event.currentTarget.innerHTML = '<i class="fa">⏸️</i>';
                        event.currentTarget.title = 'Pause Timer';
                    }
                }
                
                this.updateTaskTimerDisplay();
            },
            // Update task timer display
            updateTaskTimerDisplay() {
                this.taskTimer.textContent = AppState.formatTime(AppState.elapsedTime);
            },
            // Apply filters to tasks list
            applyFilters() {
                // Update filters in AppState
                AppState.filters.status = this.statusFilter.value;
                AppState.filters.category = this.categoryFilter.value;
                AppState.filters.priority = this.priorityFilter.value;
                AppState.filters.search = this.searchTasks.value;
                
                // Due date filter is handled separately in handleDueDateFilter
                
                // Update UI
                this.updateTasksList();
            },
            // Handle due date filter
            handleDueDateFilter() {
                const value = this.dueDateFilter.value;
                AppState.filters.dueDate = value;
                
                if (value === 'custom') {
                    // Show date range modal
                    this.showModal('dateRangeModal');
                } else {
                    // Apply filters
                    this.updateTasksList();
                }
            },
            // Apply date range filter
            applyDateRange() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    this.showToast('Please select both start and end dates.', 'error');
                    return;
                }
                
                AppState.filters.dateRange.start = startDate;
                AppState.filters.dateRange.end = endDate;
                
                this.hideModal('dateRangeModal');
                this.updateTasksList();
            },
            // Apply sorting to tasks list
            applySorting() {
                const [field, direction] = this.sortTasks.value.split('-');
                
                AppState.sort.field = field;
                AppState.sort.direction = direction;
                
                this.updateTasksList();
            },
            // Toggle between list and graph views
            toggleView(event) {
                const viewMode = event.currentTarget.dataset.view;
                
                if (viewMode !== AppState.viewMode) {
                    AppState.viewMode = viewMode;
                    
                    // Update buttons
                    this.viewButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    event.currentTarget.classList.add('active');
                    
                    // Update views
                    if (viewMode === 'list') {
                        this.taskListView.style.display = 'block';
                        this.graphView.style.display = 'none';
                    } else if (viewMode === 'graph') {
                        this.taskListView.style.display = 'none';
                        this.graphView.style.display = 'grid';
                        this.updateGraphs();
                    }
                }
            },
            // Initialize graphs
            initializeGraphs() {
                // Create time-based chart
                const timeChartCtx = document.getElementById('tasksTimeChart').getContext('2d');
                window.tasksTimeChart = new Chart(timeChartCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Completed',
                                backgroundColor: '#28A745',
                                data: []
                            },
                            {
                                label: 'Pending',
                                backgroundColor: '#FFC107',
                                data: []
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
                
                // Create pie chart
                const pieChartCtx = document.getElementById('tasksPieChart').getContext('2d');
                window.tasksPieChart = new Chart(pieChartCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [],
                            backgroundColor: ['#28A745', '#FFC107']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000
                        }
                    }
                });
                
                // Update graphs
                this.updateGraphs();
            },
            // Update graphs with current data
            updateGraphs() {
                if (!window.tasksTimeChart || !window.tasksPieChart) {
                    return;
                }
                
                // Prepare data for time-based chart
                const today = new Date();
                const days = [];
                const completedData = [];
                const pendingData = [];
                
                // Get data for the last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    
                    const dayLabel = date.toLocaleDateString('en-US', { weekday: 'short' });
                    days.push(dayLabel);
                    
                    const startOfDay = new Date(date);
                    startOfDay.setHours(0, 0, 0, 0);
                    
                    const endOfDay = new Date(date);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    // Count tasks due on this day
                    const tasksOnDay = AppState.tasks.filter(task => {
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= startOfDay && taskDate <= endOfDay;
                    });
                    
                    const completedCount = tasksOnDay.filter(task => task.completed).length;
                    const pendingCount = tasksOnDay.filter(task => !task.completed).length;
                    
                    completedData.push(completedCount);
                    pendingData.push(pendingCount);
                }
                
                // Update time-based chart
                window.tasksTimeChart.data.labels = days;
                window.tasksTimeChart.data.datasets[0].data = completedData;
                window.tasksTimeChart.data.datasets[1].data = pendingData;
                window.tasksTimeChart.update();
                
                // Update pie chart
                const completedTasksCount = AppState.tasks.filter(task => task.completed).length;
                const pendingTasksCount = AppState.tasks.filter(task => !task.completed).length;
                
                window.tasksPieChart.data.datasets[0].data = [completedTasksCount, pendingTasksCount];
                window.tasksPieChart.update();
            },
            // Update insights data
            updateInsightsData() {
                // Task statistics
                const totalTasks = AppState.tasks.length;
                const completedTasks = AppState.tasks.filter(task => task.completed).length;
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const tasksDueToday = AppState.getTasksDueToday().length;
                
                document.getElementById('insightTotalTasks').textContent = totalTasks;
                document.getElementById('insightCompletedTasks').textContent = completedTasks;
                document.getElementById('insightCompletionRate').textContent = `${completionRate}%`;
                document.getElementById('insightTasksDueToday').textContent = tasksDueToday;
                
                // Category breakdown
                const categoryCounts = AppState.getCategoryCounts();
                const categoriesBreakdown = document.getElementById('categoriesBreakdown');
                categoriesBreakdown.innerHTML = '';
                
                Object.entries(categoryCounts).forEach(([categoryId, count]) => {
                    if (count > 0) {
                        const categoryName = AppState.categories.find(cat => cat.id === categoryId)?.name || categoryId;
                        
                        const insightItem = document.createElement('div');
                        insightItem.classList.add('insight-item');
                        insightItem.innerHTML = `
                            <span class="insight-label">${categoryName}</span>
                            <span class="insight-value">${count}</span>
                        `;
                        
                        categoriesBreakdown.appendChild(insightItem);
                    }
                });
                
                // Priority breakdown
                const priorityCounts = AppState.getPriorityCounts();
                const priorityBreakdown = document.getElementById('priorityBreakdown');
                priorityBreakdown.innerHTML = '';
                
                Object.entries(priorityCounts).forEach(([priority, count]) => {
                    if (count > 0) {
                        const insightItem = document.createElement('div');
                        insightItem.classList.add('insight-item');
                        insightItem.innerHTML = `
                            <span class="insight-label">${priority.charAt(0).toUpperCase() + priority.slice(1)}</span>
                            <span class="insight-value">${count}</span>
                        `;
                        
                        priorityBreakdown.appendChild(insightItem);
                    }
                });
                
                // User statistics
                const totalUsers = AppState.users.length;
                const activeUsers = AppState.getActiveUsers();
                
                document.getElementById('insightTotalUsers').textContent = totalUsers;
                document.getElementById('insightActiveUsers').textContent = activeUsers;
                
                // Role distribution
                const roleCounts = AppState.getRoleCounts();
                const roleDistribution = document.getElementById('roleDistribution');
                roleDistribution.innerHTML = '';
                
                Object.entries(roleCounts).forEach(([role, count]) => {
                    if (count > 0) {
                        const insightItem = document.createElement('div');
                        insightItem.classList.add('insight-item');
                        insightItem.innerHTML = `
                            <span class="insight-label">${role.charAt(0).toUpperCase() + role.slice(1)}</span>
                            <span class="insight-value">${count}</span>
                        `;
                        
                        roleDistribution.appendChild(insightItem);
                    }
                });
            },
            // Handle undo action
            handleUndo() {
                const success = AppState.undo();
                if (success) {
                    this.showToast('Action undone', 'info');
                }
            },
            // Handle redo action
            handleRedo() {
                const success = AppState.redo();
                if (success) {
                    this.showToast('Action redone', 'info');
                }
            },
            // Update undo/redo buttons
            updateUndoRedoButtons() {
                this.undoBtn.disabled = AppState.historyIndex <= 0;
                this.redoBtn.disabled = AppState.historyIndex >= AppState.history.length - 1;
            },
            // Handle task selection for multi-select
            handleTaskSelection() {
                const selectedCheckboxes = document.querySelectorAll('.task-select:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
                
                // Update AppState
                AppState.selectedTasks = selectedIds;
                
                // Update UI
                this.selectedCount.textContent = selectedIds.length;
                
                if (selectedIds.length > 0) {
                    this.multiSelectBar.classList.add('active');
                } else {
                    this.multiSelectBar.classList.remove('active');
                }
            },
            // Mark selected tasks as complete
            completeSelectedTasks() {
                if (AppState.selectedTasks.length === 0) return;
                
                // Save history state once for batch action
                AppState.saveHistoryState();
                
                let count = 0;
                AppState.selectedTasks.forEach(taskId => {
                    const task = AppState.tasks.find(t => t.id === taskId);
                    if (task && !task.completed) {
                        task.completed = true;
                        count++;
                    }
                });
                
                AppState.saveDataToLocalStorage();
                
                if (count > 0) {
                    this.showToast(`${count} task${count === 1 ? '' : 's'} marked as complete`, 'success');
                }
                
                // Add notification
                AppState.addNotification({
                    title: 'Tasks completed',
                    message: `${count} task${count === 1 ? '' : 's'} marked as complete.`,
                    type: 'success'
                });
                
                // Update UI
                this.cancelSelection();
                this.updateTasksList();
                this.updateTaskSummary();
                this.updateInsightsData();
                this.updateGraphs();
            },
            // Delete selected tasks
            deleteSelectedTasks() {
                if (AppState.selectedTasks.length === 0) return;
                
                if (confirm(`Are you sure you want to delete ${AppState.selectedTasks.length} task${AppState.selectedTasks.length === 1 ? '' : 's'}?`)) {
                    // Save history state once for batch action
                    AppState.saveHistoryState();
                    
                    const count = AppState.selectedTasks.length;
                    AppState.tasks = AppState.tasks.filter(task => !AppState.selectedTasks.includes(task.id));
                    AppState.saveDataToLocalStorage();
                    
                    this.showToast(`${count} task${count === 1 ? '' : 's'} deleted`, 'success');
                    
                    // Add notification
                    AppState.addNotification({
                        title: 'Tasks deleted',
                        message: `${count} task${count === 1 ? '' : 's'} deleted.`,
                        type: 'danger'
                    });
                    
                    // Update UI
                    this.cancelSelection();
                    this.updateTasksList();
                    this.updateTaskSummary();
                    this.updateInsightsData();
                    this.updateGraphs();
                }
            },
            // Cancel task selection
            cancelSelection() {
                AppState.selectedTasks = [];
                this.multiSelectBar.classList.remove('active');
                
                document.querySelectorAll('.task-select').forEach(cb => {
                    cb.checked = false;
                });
            },
            // Show export modal
            showExportModal() {
                this.showModal('exportModal');
                
                // Add event listeners
                document.getElementById('closeExportModal').addEventListener('click', () => {
                    this.hideModal('exportModal');
                });
                document.getElementById('cancelExportBtn').addEventListener('click', () => {
                    this.hideModal('exportModal');
                });
                document.getElementById('confirmExportBtn').addEventListener('click', this.exportTasks.bind(this));
            },
            // Export tasks
            exportTasks() {
                const format = document.getElementById('exportFormat').value;
                const filteredTasks = AppState.getFilteredTasks();
                
                if (filteredTasks.length === 0) {
                    this.showToast('No tasks to export.', 'error');
                    return;
                }
                
                if (format === 'json') {
                    // Export as JSON
                    const jsonString = JSON.stringify(filteredTasks, null, 2);
                    this.downloadFile(jsonString, 'tasks.json', 'application/json');
                } else if (format === 'pdf') {
                    // Export as PDF
                    this.showToast('PDF export is not available in the iframe. Please use JSON or Excel format.', 'warning');
                } else if (format === 'excel') {
                    // Export as Excel
                    this.showToast('Excel export is not available in the iframe. Please use JSON format.', 'warning');
                }
                
                this.hideModal('exportModal');
            },
            // Download file (note: this doesn't work in the iframe but is kept for reference)
            downloadFile(content, fileName, contentType) {
                // Since direct downloads don't work in the iframe, show instructions instead
                const exportContent = document.getElementById('viewTaskContent');
                
                document.getElementById('viewTaskTitle').textContent = 'Export Data';
                
                exportContent.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h4>Your Exported Data:</h4>
                        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; overflow: auto; max-height: 300px; margin-top: 10px;">
                            <pre style="margin: 0; white-space: pre-wrap; word-break: break-all;">${content}</pre>
                        </div>
                    </div>
                    <div>
                        <h4>Instructions:</h4>
                        <ol style="padding-left: 20px;">
                            <li>Select all the text above (Ctrl+A or Cmd+A)</li>
                            <li>Copy it (Ctrl+C or Cmd+C)</li>
                            <li>Paste it into a text editor</li>
                            <li>Save the file with the .json extension</li>
                        </ol>
                    </div>
                `;
                
                this.showModal('viewTaskModal');
                
                this.showToast('Export completed', 'success');
            },
            // Show import modal
            showImportModal() {
                this.showModal('importModal');
                
                // Reset import sections
                document.getElementById('fileImportSection').style.display = 'none';
                document.getElementById('urlImportSection').style.display = 'none';
                
                // Add event listeners
                document.getElementById('closeImportModal').addEventListener('click', () => {
                    this.hideModal('importModal');
                });
                document.getElementById('cancelImportBtn').addEventListener('click', () => {
                    this.hideModal('importModal');
                });
                document.getElementById('fileImportBtn').addEventListener('click', () => {
                    document.getElementById('fileImportSection').style.display = 'block';
                    document.getElementById('urlImportSection').style.display = 'none';
                });
                document.getElementById('urlImportBtn').addEventListener('click', () => {
                    document.getElementById('fileImportSection').style.display = 'none';
                    document.getElementById('urlImportSection').style.display = 'block';
                });
                document.getElementById('confirmImportBtn').addEventListener('click', this.importTasks.bind(this));
            },
            // Import tasks
            importTasks() {
                const fileInput = document.getElementById('importFile');
                const urlInput = document.getElementById('importUrl');
                
                if (fileInput.files.length > 0) {
                    // Import from file
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const tasks = JSON.parse(e.target.result);
                            this.processImportedTasks(tasks);
                        } catch (error) {
                            this.showToast('Invalid JSON file.', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                } else if (urlInput.value) {
                    // Import from URL
                    fetch(urlInput.value)
                        .then(response => response.json())
                        .then(tasks => {
                            this.processImportedTasks(tasks);
                        })
                        .catch(error => {
                            this.showToast('Error importing from URL.', 'error');
                        });
                } else {
                    this.showToast('Please select a file or enter a URL.', 'error');
                    return;
                }
                
                this.hideModal('importModal');
            },
            // Process imported tasks
            processImportedTasks(importedTasks) {
                if (!Array.isArray(importedTasks)) {
                    this.showToast('Invalid tasks data format.', 'error');
                    return;
                }
                
                // Save history state
                AppState.saveHistoryState();
                
                let addedCount = 0;
                let updatedCount = 0;
                let skippedCount = 0;
                
                importedTasks.forEach(task => {
                    // Check if this is a valid task
                    if (!task.title || !task.dueDate) {
                        skippedCount++;
                        return;
                    }
                    
                    // Check if task already exists
                    const existingTaskIndex = AppState.tasks.findIndex(t => t.id === task.id);
                    
                    if (existingTaskIndex !== -1) {
                        // Update existing task
                        AppState.tasks[existingTaskIndex] = { ...AppState.tasks[existingTaskIndex], ...task };
                        updatedCount++;
                    } else {
                        // Add new task
                        const newTask = {
                            id: task.id || `task-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                            title: task.title,
                            description: task.description || '',
                            completed: task.completed || false,
                            dueDate: task.dueDate,
                            timeSpent: task.timeSpent || 0,
                            category: task.category || 'uncategorized',
                            priority: task.priority || 'medium',
                            notes: task.notes || '',
                            subtasks: task.subtasks || [],
                            createdAt: task.createdAt || new Date().toISOString()
                        };
                        
                        AppState.tasks.push(newTask);
                        addedCount++;
                    }
                });
                
                if (addedCount > 0 || updatedCount > 0) {
                    AppState.saveDataToLocalStorage();
                    
                    // Update UI
                    this.updateTasksList();
                    this.updateTaskSummary();
                    this.updateInsightsData();
                    this.updateGraphs();
                    
                    this.showToast(`Import completed: ${addedCount} added, ${updatedCount} updated, ${skippedCount} skipped.`, 'success');
                    
                    // Add notification
                    AppState.addNotification({
                        title: 'Tasks imported',
                        message: `${addedCount} tasks added, ${updatedCount} updated.`,
                        type: 'info'
                    });
                } else {
                    this.showToast('No tasks were imported.', 'warning');
                }
            },
            // Show profile modal
            showProfileModal() {
                const user = AppState.user;
                
                if (user) {
                    document.getElementById('profileModalImage').src = user.avatar;
                    
                    const profileContent = document.getElementById('profileContent');
                    const formattedJoiningDate = new Date(user.joiningDate).toLocaleDateString();
                    
                    profileContent.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Name</h4>
                            <p>${user.firstName} ${user.lastName}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Email</h4>
                            <p>${user.email}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Role</h4>
                            <p>${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Country</h4>
                            <p>${user.nationality}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Birthdate</h4>
                            <p>${user.birthdate}</p>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <h4 style="margin-bottom: 5px;">Joining Date</h4>
                            <p>${formattedJoiningDate}</p>
                        </div>
                    `;
                    
                    // Add event listener to edit button
                    document.getElementById('editProfileBtn').addEventListener('click', this.showEditProfileModal.bind(this));
                    
                    // Add event listener to image upload
                    document.getElementById('profileImageUpload').addEventListener('change', this.handleProfileImageUpload.bind(this));
                    
                    this.showModal('profileModal');
                }
            },
            // Show edit profile modal
            showEditProfileModal() {
                const user = AppState.user;
                
                if (user) {
                    document.getElementById('editFirstName').value = user.firstName;
                    document.getElementById('editLastName').value = user.lastName;
                    document.getElementById('editEmail').value = user.email;
                    document.getElementById('editPhone').value = user.phone || '';
                    
                    // Set country if it exists in the dropdown
                    const countrySelect = document.getElementById('editCountry');
                    const countryOption = Array.from(countrySelect.options).find(option => option.value === user.nationality);
                    
                    if (countryOption) {
                        countrySelect.value = user.nationality;
                    }
                    
                    // Add event listeners
                    document.getElementById('closeEditProfileModal').addEventListener('click', () => {
                        this.hideModal('editProfileModal');
                    });
                    document.getElementById('cancelEditProfileBtn').addEventListener('click', () => {
                        this.hideModal('editProfileModal');
                    });
                    document.getElementById('saveProfileBtn').addEventListener('click', this.saveProfile.bind(this));
                    
                    this.hideModal('profileModal');
                    this.showModal('editProfileModal');
                }
            },
            // Save profile
            saveProfile() {
                const firstName = document.getElementById('editFirstName').value;
                const lastName = document.getElementById('editLastName').value;
                const email = document.getElementById('editEmail').value;
                const phone = document.getElementById('editPhone').value;
                const country = document.getElementById('editCountry').value;
                
                // Validation
                if (!firstName || !lastName || !email) {
                    this.showToast('Please fill in all required fields.', 'error');
                    return;
                }
                
                // Update user
                AppState.user.firstName = firstName;
                AppState.user.lastName = lastName;
                AppState.user.email = email;
                AppState.user.phone = phone;
                AppState.user.nationality = country;
                
                // Update users array
                const userIndex = AppState.users.findIndex(u => u.id === AppState.user.id);
                if (userIndex !== -1) {
                    AppState.users[userIndex] = { ...AppState.user };
                }
                
                AppState.saveDataToLocalStorage();
                
                this.hideModal('editProfileModal');
                this.showToast('Profile updated successfully', 'success');
                
                // Refresh profile modal
                this.showProfileModal();
            },
            // Handle profile image upload
            handleProfileImageUpload(event) {
                const file = event.target.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const imageUrl = e.target.result;
                        
                        // Update user avatar
                        AppState.user.avatar = imageUrl;
                        
                        // Update profile image
                        document.getElementById('profileModalImage').src = imageUrl;
                        document.getElementById('profileImage').src = imageUrl;
                        
                        // Update users array
                        const userIndex = AppState.users.findIndex(u => u.id === AppState.user.id);
                        if (userIndex !== -1) {
                            AppState.users[userIndex].avatar = imageUrl;
                        }
                        
                        AppState.saveDataToLocalStorage();
                        
                        this.showToast('Profile image updated', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                }
            },
            // Show status modal
            showStatusModal() {
                this.hideModal('profileDropdown');
                this.showModal('statusModal');
                
                // Preselect current status
                const currentStatus = AppState.user.status;
                document.querySelectorAll('.status-option').forEach(option => {
                    if (option.dataset.status === currentStatus) {
                        option.style.backgroundColor = 'rgba(93, 92, 222, 0.1)';
                    } else {
                        option.style.backgroundColor = 'transparent';
                    }
                });
                
                // Add event listener to close button
                document.getElementById('closeStatusModal').addEventListener('click', () => {
                    this.hideModal('statusModal');
                });
            },
            // Change user status
            changeUserStatus(event) {
                const status = event.currentTarget.dataset.status;
                
                // Update user status
                AppState.user.status = status;
                
                // Update users array
                const userIndex = AppState.users.findIndex(u => u.id === AppState.user.id);
                if (userIndex !== -1) {
                    AppState.users[userIndex].status = status;
                }
                
                AppState.saveDataToLocalStorage();
                
                // Update UI
                const userProfile = document.getElementById('userProfile');
                userProfile.className = 'user-profile';
                userProfile.classList.add(`status-${status}`);
                
                document.getElementById('statusToggleBtn').innerHTML = `
                    <i class="fa">🟢</i> Status: ${status.charAt(0).toUpperCase() + status.slice(1)}
                `;
                
                this.hideModal('statusModal');
                this.showToast(`Status updated to ${status}`, 'success');
            },
            // Handle adding a new category
            handleAddCategory() {
                const newCategoryInput = document.getElementById('newCategory');
                const categoryName = newCategoryInput.value.trim();
                
                if (!categoryName) {
                    this.showToast('Please enter a category name.', 'error');
                    return;
                }
                
                // Check if category already exists
                if (AppState.categories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                    this.showToast('Category already exists.', 'error');
                    return;
                }
                
                // Add new category
                const newCategory = {
                    id: categoryName.toLowerCase().replace(/\s+/g, '-'),
                    name: categoryName
                };
                
                AppState.addCategory(newCategory);
                
                // Update UI
                this.updateCategoriesList();
                this.updateCategoryDropdowns();
                
                newCategoryInput.value = '';
                
                this.showToast('Category added successfully', 'success');
            },
            // Show edit category modal
            showEditCategoryModal(event) {
                const categoryId = event.currentTarget.dataset.id;
                const category = AppState.categories.find(cat => cat.id === categoryId);
                
                if (category) {
                    document.getElementById('categoryId').value = category.id;
                    document.getElementById('editCategoryName').value = category.name;
                    
                    // Add event listeners
                    document.getElementById('closeEditCategoryModal').addEventListener('click', () => {
                        this.hideModal('editCategoryModal');
                    });
                    document.getElementById('cancelEditCategoryBtn').addEventListener('click', () => {
                        this.hideModal('editCategoryModal');
                    });
                    document.getElementById('saveEditCategoryBtn').addEventListener('click', this.saveEditCategory.bind(this));
                    
                    this.showModal('editCategoryModal');
                }
            },
            // Save edited category
            saveEditCategory() {
                const categoryId = document.getElementById('categoryId').value;
                const categoryName = document.getElementById('editCategoryName').value.trim();
                
                if (!categoryName) {
                    this.showToast('Please enter a category name.', 'error');
                    return;
                }
                
                // Check if category already exists (excluding the current one)
                if (AppState.categories.some(cat => cat.id !== categoryId && cat.name.toLowerCase() === categoryName.toLowerCase())) {
                    this.showToast('Category already exists.', 'error');
                    return;
                }
                
                // Update category
                const updatedCategory = {
                    id: categoryName.toLowerCase().replace(/\s+/g, '-'),
                    name: categoryName
                };
                
                AppState.updateCategory(categoryId, updatedCategory);
                
                // Update UI
                this.updateCategoriesList();
                this.updateCategoryDropdowns();
                this.updateTasksList(); // Update tasks to show new category name
                
                this.hideModal('editCategoryModal');
                this.showToast('Category updated successfully', 'success');
            },
            // Handle delete category
            handleDeleteCategory(event) {
                const categoryId = event.currentTarget.dataset.id;
                const category = AppState.categories.find(cat => cat.id === categoryId);
                
                if (category) {
                    // Check if category is in use
                    const tasksUsingCategory = AppState.tasks.filter(task => task.category === categoryId);
                    
                    if (tasksUsingCategory.length > 0) {
                        this.showToast(`Cannot delete category "${category.name}" because it is being used by ${tasksUsingCategory.length} task(s).`, 'error');
                        return;
                    }
                    
                    if (confirm(`Are you sure you want to delete the category "${category.name}"?`)) {
                        AppState.deleteCategory(categoryId);
                        
                        // Update UI
                        this.updateCategoriesList();
                        this.updateCategoryDropdowns();
                        
                        this.showToast('Category deleted successfully', 'success');
                    }
                }
            },
            // Toggle theme
            toggleTheme() {
                document.documentElement.classList.toggle('dark');
                this.updateThemeIcon();
                
                // Close profile dropdown if open
                this.profileDropdown.classList.remove('active');
            },
            // Update theme icon based on current mode
            updateThemeIcon() {
                const isDark = document.documentElement.classList.contains('dark');
                this.themeIcon.textContent = isDark ? '🌙' : '☀️';
                this.switchModeIcon.textContent = isDark ? '🌙' : '☀️';
            },
            // Handle logout
            handleLogout() {
                // Clear current user
                AppState.user = null;
                AppState.saveDataToLocalStorage();
                
                // Return to login page
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                
                this.showToast('Logged out successfully', 'success');
            },
            // Handle outside click (close dropdowns)
            handleOutsideClick(event) {
                if (this.profileDropdown.classList.contains('active') && !this.userProfile.contains(event.target)) {
                    this.profileDropdown.classList.remove('active');
                }
            },
            // Show modal
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                }
            },
            // Hide modal
            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            },
            // Show toast notification
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.classList.add('toast', `toast-${type}`);
                
                let icon = '';
                switch (type) {
                    case 'success':
                        icon = '✅';
                        break;
                    case 'error':
                        icon = '❌';
                        break;
                    case 'warning':
                        icon = '⚠️';
                        break;
                    default:
                        icon = 'ℹ️';
                }
                
                toast.innerHTML = `
                    <div>${icon}</div>
                    <div>${message}</div>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 5 seconds
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            },
            // Debounce function
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            UI.init();
        });
    </script>
</body>
</html>
