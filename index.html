<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Todo App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #ffffff;
            --text-color: #212529;
            --border-radius: 0.25rem;
            --box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --primary-color: #66b0ff;
            --secondary-color: #adb5bd;
            --success-color: #55c57a;
            --danger-color: #ff6b6b;
            --warning-color: #ffca2c;
            --info-color: #4ecdc4;
            --light-color: #343a40;
            --dark-color: #f8f9fa;
            --background-color: #212529;
            --text-color: #f8f9fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .card {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .w-100 {
            width: 100%;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1.5rem;
        }

        .text-center {
            text-align: center;
        }

        .auth-toggle {
            margin-top: 1rem;
            text-align: center;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--light-color);
            box-shadow: var(--box-shadow);
        }

        .dashboard-logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .dashboard-logo i {
            margin-right: 0.5rem;
        }

        .dashboard-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .notification-badge {
            position: relative;
            font-size: 1.2rem;
        }

        .notification-badge.has-notifications::after {
            content: attr(data-count);
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--danger-color);
            color: #fff;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 50%;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            position: relative;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            min-width: 150px;
            z-index: 1000;
        }

        .user-profile-dropdown.active {
            display: block;
        }

        .profile-dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .profile-dropdown-item:hover {
            background-color: var(--background-color);
        }

        .dashboard-nav {
            display: flex;
            background-color: var(--light-color);
            padding: 0.5rem 2rem;
            box-shadow: var(--box-shadow);
        }

        .dashboard-nav-item {
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            cursor: pointer;
            border-radius: var(--border-radius);
        }

        .dashboard-nav-item.active {
            background-color: var(--primary-color);
            color: #fff;
        }

        .dashboard-content {
            flex: 1;
            padding: 2rem;
        }

        .task-list {
            display: grid;
            gap: 1rem;
        }

        .task-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .task-checkbox {
            margin-right: 1rem;
        }

        .task-details {
            flex: 1;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-container.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--secondary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--secondary-color);
            text-align: right;
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: var(--light-color);
            box-shadow: var(--box-shadow);
            transition: right 0.3s ease;
            z-index: 1000;
        }

        .notification-panel.active {
            right: 0;
        }

        .notification-list {
            padding: 1rem;
        }

        .notification-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--secondary-color);
        }

        .notification-item.unread {
            background-color: var(--background-color);
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toast-info {
            background-color: var(--info-color);
            color: #fff;
        }

        .toast-success {
            background-color: var(--success-color);
            color: #fff;
        }

        .toast-danger {
            background-color: var(--danger-color);
            color: #fff;
        }

        .toast-close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            margin-left: 1rem;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app-container"></div>
    <div id="modal-container" class="modal-container">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <button id="modal-close" class="modal-close">×</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>
    <div id="notification-panel" class="notification-panel">
        <div class="notification-list" id="notification-list"></div>
    </div>
    <div id="toast-container" class="toast-container"></div>

    <script>
        // App State Management
        const AppState = {
            currentUser: null,
            currentView: 'auth',
            currentTab: 'tasks',
            darkMode: window.matchMedia('(prefers-color-scheme: dark)').matches,
            users: [],
            tasks: [],
            categories: [],
            notifications: [],

            init() {
                this.loadState();
                if (!this.users.length) {
                    this.generateDemoData();
                }
                this.applyTheme();
                if (!this.currentUser) {
                    this.currentView = 'auth';
                } else {
                    this.currentView = 'dashboard';
                }
            },

            loadState() {
                const savedState = localStorage.getItem('todoAppState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    this.currentUser = state.currentUser || null;
                    this.users = state.users || [];
                    this.tasks = state.tasks || [];
                    this.categories = state.categories || [];
                    this.notifications = state.notifications || [];
                    this.darkMode = state.darkMode ?? this.darkMode;
                    this.currentTab = state.currentTab || 'tasks';
                }
            },

            saveState() {
                const state = {
                    currentUser: this.currentUser,
                    users: this.users,
                    tasks: this.tasks,
                    categories: this.categories,
                    notifications: this.notifications,
                    darkMode: this.darkMode,
                    currentTab: this.currentTab
                };
                localStorage.setItem('todoAppState', JSON.stringify(state));
            },

            generateDemoData() {
                this.users = [
                    {
                        id: 'user1',
                        name: 'Demo User',
                        email: 'demo@example.com',
                        password: 'password',
                        avatar: 'https://via.placeholder.com/32',
                        role: 'admin'
                    }
                ];
                this.categories = [
                    { id: 'cat1', name: 'Work', color: '#007bff' },
                    { id: 'cat2', name: 'Personal', color: '#28a745' }
                ];
                this.tasks = [
                    {
                        id: 'task1',
                        title: 'Complete Project Proposal',
                        description: 'Draft and submit the project proposal.',
                        dueDate: '2025-04-25',
                        priority: 'high',
                        status: 'pending',
                        categoryId: 'cat1',
                        assignedTo: 'user1'
                    }
                ];
                this.notifications = [
                    {
                        id: 'notif1',
                        message: 'New task assigned: Complete Project Proposal',
                        timestamp: new Date().toISOString(),
                        read: false
                    }
                ];
                this.saveState();
            },

            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.darkMode ? 'dark' : 'light');
            },

            toggleDarkMode() {
                this.darkMode = !this.darkMode;
                this.applyTheme();
                this.saveState();
            },

            login(email, password) {
                const user = this.users.find(u => u.email === email && u.password === password);
                if (user) {
                    this.currentUser = user;
                    this.currentView = 'dashboard';
                    this.saveState();
                    return true;
                }
                return false;
            },

            register(name, email, password) {
                if (this.users.find(u => u.email === email)) {
                    return { success: false, error: 'Email already exists' };
                }
                const newUser = {
                    id: `user${this.users.length + 1}`,
                    name,
                    email,
                    password,
                    avatar: 'https://via.placeholder.com/32',
                    role: 'user'
                };
                this.users.push(newUser);
                this.currentUser = newUser;
                this.currentView = 'dashboard';
                this.saveState();
                return { success: true };
            },

            logout() {
                this.currentUser = null;
                this.currentView = 'auth';
                this.currentTab = 'tasks';
                this.saveState();
            },

            addTask(task) {
                this.tasks.push(task);
                this.notify(`New task added: ${task.title}`);
                this.saveState();
            },

            updateTask(taskId, updates) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    Object.assign(task, updates);
                    this.notify(`Task updated: ${task.title}`);
                    this.saveState();
                }
            },

            deleteTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    this.tasks = this.tasks.filter(t => t.id !== taskId);
                    this.notify(`Task deleted: ${task.title}`);
                    this.saveState();
                }
            },

            addCategory(category) {
                this.categories.push(category);
                this.saveState();
            },

            updateCategory(categoryId, updates) {
                const category = this.categories.find(c => c.id === categoryId);
                if (category) {
                    Object.assign(category, updates);
                    this.saveState();
                }
            },

            deleteCategory(categoryId) {
                this.categories = this.categories.filter(c => c.id !== categoryId);
                this.tasks = this.tasks.filter(t => t.categoryId !== categoryId);
                this.saveState();
            },

            notify(message) {
                const notification = {
                    id: `notif${this.notifications.length + 1}`,
                    message,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                this.notifications.push(notification);
                this.saveState();
                NotificationPanel.render();
            },

            markNotificationAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.saveState();
                    NotificationPanel.render();
                }
            },

            getUnreadNotificationsCount() {
                return this.notifications.filter(n => !n.read).length;
            }
        };

        // Toast Notifications
        const Toast = {
            show(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    ${message}
                    <button class="toast-close">×</button>
                `;
                toastContainer.appendChild(toast);

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        };

        // Modal System
        const Modal = {
            init() {
                const modalContainer = document.getElementById('modal-container');
                const modalClose = document.getElementById('modal-close');
                if (modalClose) {
                    modalClose.addEventListener('click', () => this.hide());
                }
            },
            show(title, content, footer) {
                const modalContainer = document.getElementById('modal-container');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                const modalFooter = document.getElementById('modal-footer');

                modalTitle.textContent = title;
                modalBody.innerHTML = '';
                if (content instanceof HTMLElement) {
                    modalBody.appendChild(content);
                } else {
                    modalBody.innerHTML = content;
                }
                modalFooter.innerHTML = '';
                if (footer instanceof HTMLElement) {
                    modalFooter.appendChild(footer);
                } else {
                    modalFooter.innerHTML = footer || '';
                }

                modalContainer.classList.add('active');
            },
            hide() {
                const modalContainer = document.getElementById('modal-container');
                modalContainer.classList.remove('active');
            }
        };

        // Notification Panel
        const NotificationPanel = {
            toggle() {
                const panel = document.getElementById('notification-panel');
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    this.render();
                }
            },
            render() {
                const notificationList = document.getElementById('notification-list');
                notificationList.innerHTML = '';
                AppState.notifications.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.innerHTML = `
                        <div>${notification.message}</div>
                        <small>${new Date(notification.timestamp).toLocaleString()}</small>
                    `;
                    notificationItem.addEventListener('click', () => {
                        AppState.markNotificationAsRead(notification.id);
                    });
                    notificationList.appendChild(notificationItem);
                });
            }
        };

        // Tasks Tab
        const TasksTab = {
            render(container) {
                container.innerHTML = `
                    <div class="tasks-header">
                        <h2>Tasks</h2>
                        <button class="btn btn-primary" id="add-task">Add Task</button>
                    </div>
                    <div class="task-list" id="task-list"></div>
                `;
                this.rerenderTasks();

                document.getElementById('add-task').addEventListener('click', () => {
                    this.showTaskForm();
                });
            },
            rerenderTasks() {
                const taskList = document.getElementById('task-list');
                taskList.innerHTML = '';
                const userTasks = AppState.tasks.filter(t => t.assignedTo === AppState.currentUser.id);
                userTasks.forEach(task => {
                    const category = AppState.categories.find(c => c.id === task.categoryId);
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    taskCard.innerHTML = `
                        <input type="checkbox" class="task-checkbox" ${task.status === 'completed' ? 'checked' : ''}>
                        <div class="task-details">
                            <div>${task.title}</div>
                            <small>Due: ${task.dueDate} | Priority: ${task.priority} | Category: ${category?.name || 'None'}</small>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-primary btn-sm edit-task">Edit</button>
                            <button class="btn btn-danger btn-sm delete-task">Delete</button>
                        </div>
                    `;
                    taskCard.querySelector('.task-checkbox').addEventListener('change', (e) => {
                        AppState.updateTask(task.id, { status: e.target.checked ? 'completed' : 'pending' });
                        this.rerenderTasks();
                    });
                    taskCard.querySelector('.edit-task').addEventListener('click', () => {
                        this.showTaskForm(task);
                    });
                    taskCard.querySelector('.delete-task').addEventListener('click', () => {
                        AppState.deleteTask(task.id);
                        this.rerenderTasks();
                    });
                    taskList.appendChild(taskCard);
                });
            },
            showTaskForm(task = null) {
                const form = document.createElement('form');
                form.innerHTML = `
                    <div class="form-group">
                        <label for="task-title">Title</label>
                        <input type="text" id="task-title" class="form-control" value="${task?.title || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="task-description">Description</label>
                        <textarea id="task-description" class="form-control">${task?.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="task-due-date">Due Date</label>
                        <input type="text" id="task-due-date" class="form-control" value="${task?.dueDate || ''}">
                    </div>
                    <div class="form-group">
                        <label for="task-priority">Priority</label>
                        <select id="task-priority" class="form-control">
                            <option value="low" ${task?.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${task?.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${task?.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-category">Category</label>
                        <select id="task-category" class="form-control">
                            <option value="">None</option>
                            ${AppState.categories.map(c => `<option value="${c.id}" ${task?.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                `;
                const footer = document.createElement('div');
                footer.innerHTML = `
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancel-task">Cancel</button>
                `;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newTask = {
                        id: task?.id || `task${AppState.tasks.length + 1}`,
                        title: form.querySelector('#task-title').value,
                        description: form.querySelector('#task-description').value,
                        dueDate: form.querySelector('#task-due-date').value,
                        priority: form.querySelector('#task-priority').value,
                        status: task?.status || 'pending',
                        categoryId: form.querySelector('#task-category').value || null,
                        assignedTo: AppState.currentUser.id
                    };
                    if (task) {
                        AppState.updateTask(task.id, newTask);
                    } else {
                        AppState.addTask(newTask);
                    }
                    Modal.hide();
                    this.rerenderTasks();
                });
                footer.querySelector('#cancel-task').addEventListener('click', () => {
                    Modal.hide();
                });
                Modal.show(task ? 'Edit Task' : 'Add Task', form, footer);
                flatpickr('#task-due-date', {
                    dateFormat: 'Y-m-d',
                    minDate: 'today'
                });
            }
        };

        // Users Tab
        const UsersTab = {
            render(container) {
                container.innerHTML = `
                    <div class="users-header">
                        <h2>Users</h2>
                        ${AppState.currentUser.role === 'admin' ? '<button class="btn btn-primary" id="add-user">Add User</button>' : ''}
                    </div>
                    <div class="users-list" id="users-list"></div>
                `;
                this.rerenderUsers();

                if (AppState.currentUser.role === 'admin') {
                    document.getElementById('add-user').addEventListener('click', () => {
                        this.showUserForm();
                    });
                }
            },
            rerenderUsers() {
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = '';
                AppState.users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'card';
                    userCard.innerHTML = `
                        <div class="card-body">
                            <div><strong>Name:</strong> ${user.name}</div>
                            <div><strong>Email:</strong> ${user.email}</div>
                            <div><strong>Role:</strong> ${user.role}</div>
                            ${AppState.currentUser.role === 'admin' ? `
                                <div class="task-actions">
                                    <button class="btn btn-primary btn-sm edit-user">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-user">Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    if (AppState.currentUser.role === 'admin') {
                        userCard.querySelector('.edit-user').addEventListener('click', () => {
                            this.showUserForm(user);
                        });
                        userCard.querySelector('.delete-user').addEventListener('click', () => {
                            if (user.id !== AppState.currentUser.id) {
                                AppState.users = AppState.users.filter(u => u.id !== user.id);
                                AppState.tasks = AppState.tasks.filter(t => t.assignedTo !== user.id);
                                AppState.saveState();
                                this.rerenderUsers();
                            } else {
                                Toast.show('Cannot delete current user', 'danger');
                            }
                        });
                    }
                    usersList.appendChild(userCard);
                });
            },
            showUserForm(user = null) {
                const form = document.createElement('form');
                form.innerHTML = `
                    <div class="form-group">
                        <label for="user-name">Name</label>
                        <input type="text" id="user-name" class="form-control" value="${user?.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" class="form-control" value="${user?.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="user-password">Password</label>
                        <input type="password" id="user-password" class="form-control" ${user ? '' : 'required'}>
                    </div>
                    <div class="form-group">
                        <label for="user-role">Role</label>
                        <select id="user-role" class="form-control">
                            <option value="user" ${user?.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                `;
                const footer = document.createElement('div');
                footer.innerHTML = `
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancel-user">Cancel</button>
                `;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = form.querySelector('#user-email').value;
                    if (!user && AppState.users.find(u => u.email === email)) {
                        Toast.show('Email already exists', 'danger');
                        return;
                    }
                    const newUser = {
                        id: user?.id || `user${AppState.users.length + 1}`,
                        name: form.querySelector('#user-name').value,
                        email,
                        password: form.querySelector('#user-password').value || user?.password,
                        avatar: user?.avatar || 'https://via.placeholder.com/32',
                        role: form.querySelector('#user-role').value
                    };
                    if (user) {
                        const userIndex = AppState.users.findIndex(u => u.id === user.id);
                        AppState.users[userIndex] = newUser;
                    } else {
                        AppState.users.push(newUser);
                    }
                    AppState.saveState();
                    Modal.hide();
                    this.rerenderUsers();
                });
                footer.querySelector('#cancel-user').addEventListener('click', () => {
                    Modal.hide();
                });
                Modal.show(user ? 'Edit User' : 'Add User', form, footer);
            }
        };

        // Categories Tab
        const CategoriesTab = {
            render(container) {
                container.innerHTML = `
                    <div class="categories-header">
                        <h2>Categories</h2>
                        <button class="btn btn-primary" id="add-category">Add Category</button>
                    </div>
                    <div class="categories-list" id="categories-list"></div>
                `;
                this.rerenderCategories();

                document.getElementById('add-category').addEventListener('click', () => {
                    this.showCategoryForm();
                });
            },
            rerenderCategories() {
                const categoriesList = document.getElementById('categories-list');
                categoriesList.innerHTML = '';
                AppState.categories.forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card';
                    categoryCard.innerHTML = `
                        <div class="card-body">
                            <div><strong>Name:</strong> ${category.name}</div>
                            <div><strong>Color:</strong> <span style="background-color: ${category.color}; padding: 2px 8px; border-radius: 4px;">${category.color}</span></div>
                            <div class="task-actions">
                                <button class="btn btn-primary btn-sm edit-category">Edit</button>
                                <button class="btn btn-danger btn-sm delete-category">Delete</button>
                            </div>
                        </div>
                    `;
                    categoryCard.querySelector('.edit-category').addEventListener('click', () => {
                        this.showCategoryForm(category);
                    });
                    categoryCard.querySelector('.delete-category').addEventListener('click', () => {
                        AppState.deleteCategory(category.id);
                        this.rerenderCategories();
                        TasksTab.rerenderTasks();
                    });
                    categoriesList.appendChild(categoryCard);
                });
            },
            showCategoryForm(category = null) {
                const form = document.createElement('form');
                form.innerHTML = `
                    <div class="form-group">
                        <label for="category-name">Name</label>
                        <input type="text" id="category-name" class="form-control" value="${category?.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="category-color">Color</label>
                        <input type="color" id="category-color" class="form-control" value="${category?.color || '#007bff'}">
                    </div>
                `;
                const footer = document.createElement('div');
                footer.innerHTML = `
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancel-category">Cancel</button>
                `;
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newCategory = {
                        id: category?.id || `cat${AppState.categories.length + 1}`,
                        name: form.querySelector('#category-name').value,
                        color: form.querySelector('#category-color').value
                    };
                    if (category) {
                        AppState.updateCategory(category.id, newCategory);
                    } else {
                        AppState.addCategory(newCategory);
                    }
                    Modal.hide();
                    this.rerenderCategories();
                    TasksTab.rerenderTasks();
                });
                footer.querySelector('#cancel-category').addEventListener('click', () => {
                    Modal.hide();
                });
                Modal.show(category ? 'Edit Category' : 'Add Category', form, footer);
            }
        };

        // Insights Tab
        const InsightsTab = {
            render(container) {
                container.innerHTML = `
                    <div class="insights-header">
                        <h2>Insights</h2>
                        <button class="btn btn-primary" id="export-insights">Export Insights</button>
                    </div>
                    <div class="insights-content">
                        <canvas id="tasks-chart"></canvas>
                    </div>
                `;
                this.renderChart();
                document.getElementById('export-insights').addEventListener('click', () => {
                    this.exportInsights();
                });
            },
            renderChart() {
                const ctx = document.getElementById('tasks-chart').getContext('2d');
                const taskStatusCounts = {
                    pending: AppState.tasks.filter(t => t.status === 'pending').length,
                    completed: AppState.tasks.filter(t => t.status === 'completed').length
                };
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Pending', 'Completed'],
                        datasets: [{
                            data: [taskStatusCounts.pending, taskStatusCounts.completed],
                            backgroundColor: ['#007bff', '#28a745']
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            },
            exportInsights() {
                const data = AppState.tasks.map(task => ({
                    Title: task.title,
                    Status: task.status,
                    DueDate: task.dueDate,
                    Priority: task.priority,
                    Category: AppState.categories.find(c => c.id === task.categoryId)?.name || 'None'
                }));
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
                XLSX.writeFile(workbook, 'tasks_insights.xlsx');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Tasks Insights', 10, 10);
                let y = 20;
                data.forEach((task, index) => {
                    doc.text(`${index + 1}. ${task.Title} - ${task.Status}`, 10, y);
                    y += 10;
                });
                doc.save('tasks_insights.pdf');
            }
        };

        // Router for handling view navigation
        const Router = {
            navigate(view) {
                const appContainer = document.getElementById('app-container');
                if (!appContainer) return;

                AppState.currentView = view;

                if (view === 'auth') {
                    this.renderAuth(appContainer);
                } else if (view === 'dashboard') {
                    this.renderDashboard(appContainer);
                }
            },

            renderAuth(container) {
                container.innerHTML = `
                    <div class="auth-container">
                        <div class="card auth-card">
                            <div class="card-body">
                                <h2 class="text-center mb-4">Login</h2>
                                <form id="login-form">
                                    <div class="form-group">
                                        <label for="login-email" class="form-label">Email</label>
                                        <input type="email" id="login-email" class="form-control" placeholder="Enter email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="login-password" class="form-label">Password</label>
                                        <input type="password" id="login-password" class="form-control" placeholder="Enter password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 mt-3">Login</button>
                                </form>
                                <div class="auth-toggle">
                                    <button id="show-register">Don't have an account? Register</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;
                    if (AppState.login(email, password)) {
                        Router.navigate('dashboard');
                        Toast.show('Login successful!', 'success');
                    } else {
                        Toast.show('Invalid email or password', 'danger');
                    }
                });

                document.getElementById('show-register').addEventListener('click', () => {
                    this.renderRegister(container);
                });
            },

            renderRegister(container) {
                container.innerHTML = `
                    <div class="auth-container">
                        <div class="card auth-card">
                            <div class="card-body">
                                <h2 class="text-center mb-4">Register</h2>
                                <form id="register-form">
                                    <div class="form-group">
                                        <label for="register-name" class="form-label">Name</label>
                                        <input type="text" id="register-name" class="form-control" placeholder="Enter name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-email" class="form-label">Email</label>
                                        <input type="email" id="register-email" class="form-control" placeholder="Enter email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-password" class="form-label">Password</label>
                                        <input type="password" id="register-password" class="form-control" placeholder="Enter password" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100 mt-3">Register</button>
                                </form>
                                <div class="auth-toggle">
                                    <button id="show-login">Already have an account? Login</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('register-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('register-name').value.trim();
                    const email = document.getElementById('register-email').value.trim();
                    const password = document.getElementById('register-password').value;
                    const result = AppState.register(name, email, password);
                    if (result.success) {
                        Router.navigate('dashboard');
                        Toast.show('Registration successful!', 'success');
                    } else {
                        Toast.show(result.error || 'Registration failed', 'danger');
                    }
                });

                document.getElementById('show-login').addEventListener('click', () => {
                    this.renderAuth(container);
                });
            },

            renderDashboard(container) {
                container.innerHTML = `
                    <div class="dashboard-container">
                        <header class="dashboard-header">
                            <div class="dashboard-logo">
                                <i class="fas fa-tasks"></i>
                                Todo App
                            </div>
                            <div class="dashboard-actions">
                                <button class="theme-toggle" title="Toggle Theme">
                                    <i class="fas ${AppState.darkMode ? 'fa-sun' : 'fa-moon'}"></i>
                                </button>
                                <div class="notification-badge cursor-pointer" id="notification-toggle" data-count="${AppState.getUnreadNotificationsCount()}">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="user-profile">
                                    <img src="${AppState.currentUser.avatar}" alt="${AppState.currentUser.name}" class="user-avatar">
                                    <span>${AppState.currentUser.name}</span>
                                    <div class="user-profile-dropdown">
                                        <div class="profile-dropdown-item" id="profile-settings">Settings</div>
                                        <div class="profile-dropdown-item" id="profile-logout">Logout</div>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <nav class="dashboard-nav">
                            <div class="dashboard-nav-item ${AppState.currentTab === 'tasks' ? 'active' : ''}" data-tab="tasks">Tasks</div>
                            <div class="dashboard-nav-item ${AppState.currentTab === 'users' ? 'active' : ''}" data-tab="users">Users</div>
                            <div class="dashboard-nav-item ${AppState.currentTab === 'categories' ? 'active' : ''}" data-tab="categories">Categories</div>
                            <div class="dashboard-nav-item ${AppState.currentTab === 'insights' ? 'active' : ''}" data-tab="insights">Insights</div>
                        </nav>
                        <div class="dashboard-content" id="content-container"></div>
                    </div>
                `;

                document.getElementById('notification-toggle').addEventListener('click', () => {
                    NotificationPanel.toggle();
                });

                document.querySelector('.user-profile').addEventListener('click', (e) => {
                    const dropdown = document.querySelector('.user-profile-dropdown');
                    dropdown.classList.toggle('active');
                    e.stopPropagation();
                });

                document.getElementById('profile-logout').addEventListener('click', () => {
                    AppState.logout();
                    Router.navigate('auth');
                });

                document.getElementById('profile-settings').addEventListener('click', () => {
                    Toast.show('Settings not implemented yet', 'info');
                });

                document.querySelector('.theme-toggle').addEventListener('click', () => {
                    AppState.toggleDarkMode();
                    Router.navigate('dashboard');
                });

                document.querySelectorAll('.dashboard-nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        AppState.currentTab = item.dataset.tab;
                        this.renderDashboardContent(document.getElementById('content-container'));
                        document.querySelectorAll('.dashboard-nav-item').forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');
                    });
                });

                document.addEventListener('click', (e) => {
                    const dropdown = document.querySelector('.user-profile-dropdown');
                    if (dropdown && !dropdown.contains(e.target) && !e.target.closest('.user-profile')) {
                        dropdown.classList.remove('active');
                    }
                });

                this.renderDashboardContent(document.getElementById('content-container'));

                const notificationBadge = document.getElementById('notification-toggle');
                if (AppState.getUnreadNotificationsCount() > 0) {
                    notificationBadge.classList.add('has-notifications');
                } else {
                    notificationBadge.classList.remove('has-notifications');
                }
            },

            renderDashboardContent(container) {
                switch (AppState.currentTab) {
                    case 'tasks':
                        TasksTab.render(container);
                        break;
                    case 'users':
                        UsersTab.render(container);
                        break;
                    case 'categories':
                        CategoriesTab.render(container);
                        break;
                    case 'insights':
                        InsightsTab.render(container);
                        break;
                    default:
                        TasksTab.render(container);
                }
            }
        };

        // Initialize Modal System
        Modal.init();

        // Initialize App State
        AppState.init();

        // Start the app
        Router.navigate(AppState.currentView);

        // Add Font Awesome
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
        document.head.appendChild(fontAwesome);
    </script>
</body>
</html>
