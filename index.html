<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --info-color: #3B82F6;
            --shadow-color: #9CA3AF;
        }
        
        .dark {
            --bg-primary: #181818;
            --bg-secondary: #262626;
            --text-primary: #E5E7EB;
            --text-secondary: #D1D5DB;
            --border-color: #4B5563;
        }
        
        :root:not(.dark) {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F3F4F6;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --border-color: #E5E7EB;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            @apply px-4 py-2 rounded-md font-medium transition-all duration-200;
        }
        
        .btn-primary {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600;
        }
        
        .btn-success {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        
        .btn-warning {
            @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
        
        .btn-danger {
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        
        .form-input {
            @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 
            focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 
            dark:placeholder-gray-400 dark:text-white dark:focus:border-indigo-500 text-base;
        }
        
        .form-select {
            @apply block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none 
            focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 
            dark:text-white dark:focus:border-indigo-500 text-base;
        }
        
        .form-label {
            @apply block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1;
        }
        
        .profile-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            display: none;
            z-index: 50;
        }
        
        .profile-active .profile-dropdown {
            display: block;
        }
        
        .notification-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            display: none;
            z-index: 50;
            min-width: 320px;
        }
        
        .notification-active .notification-dropdown {
            display: block;
        }
        
        .status-dropdown {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
        }
        
        .status-item:hover .status-dropdown {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            background-color: var(--bg-primary);
            margin: 2rem auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            animation: slideIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification-toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 350px;
        }
        
        .notification-toast.active {
            opacity: 1;
            transform: translateY(0);
        }
        
        .dragging {
            opacity: 0.7;
            transform: scale(1.02);
        }
        
        .task-item {
            cursor: pointer;
        }
        
        .task-item.selected {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--primary-color);
        }
        
        .task-drag-handle {
            cursor: move;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        .slide-in {
            animation: slideIn 0.5s;
        }
        
        /* Calendar styling */
        .calendar {
            width: 300px;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background-color: var(--bg-secondary);
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-day.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }
        
        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background-color: var(--bg-secondary);
        }
    </style>
</head>
<body>
    <!-- Notification Toast Container -->
    <div id="notificationToast" class="notification-toast">
        <div class="flex items-center">
            <i class="fas fa-bell mr-3 text-indigo-500"></i>
            <div>
                <h4 class="font-bold text-sm" id="toastTitle"></h4>
                <p class="text-sm" id="toastMessage"></p>
            </div>
        </div>
    </div>

    <!-- Login/Register Page -->
    <div id="authPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <!-- Login Form -->
            <div id="loginForm" class="card p-6 mb-4">
                <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">To-Do App</h2>
                <div class="mb-4">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                </div>
                <div class="flex flex-col gap-3">
                    <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                    <button id="showRegisterBtn" class="btn btn-secondary w-full">Register</button>
                </div>
            </div>

            <!-- Registration Form -->
            <div id="registerForm" class="card p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Create Account</h2>
                <div class="mb-4">
                    <label for="regName" class="form-label">Name</label>
                    <input type="text" id="regName" class="form-input" placeholder="Enter your name">
                </div>
                <div class="mb-4">
                    <label for="regEmail" class="form-label">Email</label>
                    <input type="email" id="regEmail" class="form-input" placeholder="Enter your email">
                </div>
                <div class="mb-4">
                    <label for="regEmailConfirm" class="form-label">Confirm Email</label>
                    <input type="email" id="regEmailConfirm" class="form-input" placeholder="Confirm your email">
                </div>
                <div class="mb-4">
                    <label for="regPassword" class="form-label">Password</label>
                    <input type="password" id="regPassword" class="form-input" placeholder="Create a password">
                </div>
                <div class="mb-4">
                    <label for="regPasswordConfirm" class="form-label">Confirm Password</label>
                    <input type="password" id="regPasswordConfirm" class="form-input" placeholder="Confirm your password">
                </div>
                <div class="mb-4">
                    <label for="regPhone" class="form-label">Phone Number</label>
                    <input type="tel" id="regPhone" class="form-input" placeholder="Enter your phone number">
                </div>
                <div class="mb-4">
                    <label for="regCountry" class="form-label">Country</label>
                    <select id="regCountry" class="form-select">
                        <option value="">Select your country</option>
                        <!-- Countries will be added dynamically -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="regRole" class="form-label">Role</label>
                    <select id="regRole" class="form-select">
                        <option value="">Select your role</option>
                        <option value="Manager">Manager</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                    </select>
                </div>
                <div class="flex flex-col gap-3">
                    <button id="registerBtn" class="btn btn-primary w-full">Register</button>
                    <button id="showLoginBtn" class="btn btn-secondary w-full">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="min-h-screen flex flex-col hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow">
            <div class="container mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <!-- Logo & App Name -->
                    <div class="flex items-center">
                        <div class="text-indigo-600 text-2xl mr-2">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h1 class="text-xl font-bold">To-Do App</h1>
                    </div>

                    <!-- Right Side Elements -->
                    <div class="flex items-center space-x-4">
                        <!-- Timer -->
                        <div class="hidden md:flex items-center mr-4 p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                            <i class="fas fa-clock mr-2 text-indigo-500"></i>
                            <span id="workTimer" class="text-sm font-medium">00:00:00</span>
                        </div>

                        <!-- Toggle Light/Dark Mode -->
                        <button id="themeToggle" class="text-gray-500 hover:text-indigo-500 transition">
                            <i class="fas fa-moon text-xl"></i>
                        </button>

                        <!-- Notifications -->
                        <div class="relative" id="notificationContainer">
                            <button id="notificationBtn" class="text-gray-500 hover:text-indigo-500 transition relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span id="notificationCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                            </button>
                            <div class="notification-dropdown card shadow-lg p-3 mt-2">
                                <h3 class="font-bold mb-2 border-b pb-2">Notifications</h3>
                                <div id="notificationList" class="max-h-80 overflow-y-auto">
                                    <p class="text-gray-500 dark:text-gray-400 text-sm py-2">No notifications yet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Profile -->
                        <div class="relative" id="profileContainer">
                            <button id="profileBtn" class="flex items-center">
                                <div id="profilePic" class="w-10 h-10 rounded-full bg-cover bg-center border-2 border-green-500"></div>
                            </button>
                            <div class="profile-dropdown card shadow-lg p-3 mt-2 w-48">
                                <div class="font-bold mb-2 border-b pb-2" id="profileName">User</div>
                                <ul class="space-y-1">
                                    <li class="status-item relative">
                                        <a href="#" class="block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                                            <div class="flex items-center justify-between">
                                                <span>Status</span>
                                                <i class="fas fa-chevron-right text-xs"></i>
                                            </div>
                                        </a>
                                        <div class="status-dropdown card shadow-lg p-2 ml-2 w-32">
                                            <ul>
                                                <li><a href="#" class="status-option block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-status="login">Login</a></li>
                                                <li><a href="#" class="status-option block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-status="shadow">Shadow</a></li>
                                                <li><a href="#" class="status-option block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-status="break">Break</a></li>
                                                <li><a href="#" class="status-option block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-status="logout">Logout</a></li>
                                            </ul>
                                        </div>
                                    </li>
                                    <li><a href="#" id="viewProfileBtn" class="block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">View Profile</a></li>
                                    <li><a href="#" id="logoutBtn" class="block py-1 px-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-red-500">Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <!-- Task Summary Cards -->
            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="card p-4">
                    <h3 class="text-lg font-medium mb-2">Total Tasks</h3>
                    <div class="bg-blue-100 text-blue-800 p-3 rounded-md">
                        <div class="flex items-center">
                            <i class="fas fa-tasks mr-2"></i>
                            <span id="totalTasksCount">0</span>
                            <span class="ml-1">tasks</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h3 class="text-lg font-medium mb-2">Completed Tasks</h3>
                        <div class="bg-green-100 text-green-800 p-3 rounded-md">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle mr-2"></i>
                                <span id="completedTasksCount">0</span>
                                <span class="ml-1">tasks</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="text-lg font-medium mb-2">Pending Tasks</h3>
                        <div class="bg-yellow-100 text-yellow-800 p-3 rounded-md">
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-2"></i>
                                <span id="pendingTasksCount">0</span>
                                <span class="ml-1">tasks</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Control Panel -->
            <div class="flex flex-wrap justify-between items-center mb-6">
                <h2 class="text-2xl font-bold mb-4">Tasks</h2>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    <button id="undoBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-undo mr-1"></i> Undo
                    </button>
                    <button id="redoBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-redo mr-1"></i> Redo
                    </button>
                    <button id="importBtn" class="btn btn-secondary">
                        <i class="fas fa-file-import mr-1"></i> Import
                    </button>
                    <button id="exportBtn" class="btn btn-secondary">
                        <i class="fas fa-file-export mr-1"></i> Export
                    </button>
                    <button id="usersBtn" class="btn btn-secondary">
                        <i class="fas fa-users mr-1"></i> Users
                    </button>
                    <button id="addTaskBtn" class="btn btn-primary">
                        <i class="fas fa-plus mr-1"></i> Add Task
                    </button>
                </div>
            </div>
            
            <!-- Task View Toggle -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <span class="mr-3 font-medium">View:</span>
                    <div class="flex bg-gray-200 dark:bg-gray-700 rounded-md p-1">
                        <button id="listViewBtn" class="px-3 py-1 rounded-md bg-white dark:bg-gray-800 shadow-sm">
                            <i class="fas fa-list mr-1"></i> List
                        </button>
                        <button id="graphViewBtn" class="px-3 py-1 rounded-md">
                            <i class="fas fa-chart-pie mr-1"></i> Graph
                        </button>
                    </div>
                </div>
                
                <div id="bulkActionsContainer" class="hidden">
                    <button id="bulkCompleteBtn" class="btn btn-success mr-2">
                        <i class="fas fa-check mr-1"></i> Mark Complete
                    </button>
                    <button id="bulkDeleteBtn" class="btn btn-danger">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                </div>
            </div>
            
            <!-- Task Filters -->
            <div id="taskFiltersContainer" class="card p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label for="searchTask" class="form-label">Search</label>
                        <div class="relative">
                            <input type="text" id="searchTask" class="form-input pl-10" placeholder="Search tasks...">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label for="filterCategory" class="form-label">Category</label>
                        <select id="filterCategory" class="form-select">
                            <option value="">All Categories</option>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div>
                        <label for="filterPriority" class="form-label">Priority</label>
                        <select id="filterPriority" class="form-select">
                            <option value="">All Priorities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="filterStatus" class="form-label">Status</label>
                        <select id="filterStatus" class="form-select">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="filterDueDate" class="form-label">Due Date</label>
                        <select id="filterDueDate" class="form-select">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">In a Week</option>
                            <option value="month">In a Month</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                
                <div id="customDateFilter" class="mt-4 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="dateFrom" class="form-label">From</label>
                            <input type="date" id="dateFrom" class="form-input">
                        </div>
                        <div>
                            <label for="dateTo" class="form-label">To</label>
                            <input type="date" id="dateTo" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks List View -->
            <div id="listView" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <label for="taskSort" class="mr-2 font-medium">Sort by:</label>
                        <select id="taskSort" class="form-select w-40">
                            <option value="dueDate">Due Date</option>
                            <option value="priority">Priority</option>
                            <option value="title">Title</option>
                            <option value="created">Created Date</option>
                        </select>
                    </div>
                    <div>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="enableMultiSelect" class="form-checkbox h-5 w-5 text-indigo-600">
                            <span class="ml-2 text-sm">Multi-select</span>
                        </label>
                    </div>
                </div>
                
                <div id="tasksContainer" class="space-y-4">
                    <!-- Tasks will be rendered here -->
                    <div class="text-center py-10 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-tasks text-5xl mb-4"></i>
                        <p>No tasks found. Add your first task to get started!</p>
                    </div>
                </div>
            </div>
            
            <!-- Graph View -->
            <div id="graphView" class="mb-8 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h3 class="text-lg font-medium mb-4">Task Status Distribution</h3>
                        <div class="h-64">
                            <canvas id="taskStatusChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h3 class="text-lg font-medium mb-4">Task Priority Distribution</h3>
                        <div class="h-64">
                            <canvas id="taskPriorityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card p-4 mt-6">
                    <h3 class="text-lg font-medium mb-4">Task Completion Timeline</h3>
                    <div class="h-64">
                        <canvas id="taskTimelineChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Insights View -->
            <div class="card p-4 mb-6">
                <h2 class="text-xl font-bold mb-4">Insights</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-medium mb-2">Task Completion Rate</h3>
                        <div class="text-2xl font-bold" id="completionRate">0%</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Based on your task history</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-medium mb-2">Productivity Score</h3>
                        <div class="text-2xl font-bold" id="productivityScore">0/10</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Based on task completion time</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="font-medium mb-2">Overdue Tasks</h3>
                        <div class="text-2xl font-bold" id="overdueTasksCount">0</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">Tasks past their due date</div>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-medium mb-2">Productivity Trend</h3>
                    <div class="h-48">
                        <canvas id="productivityChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    
    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content w-full max-w-lg">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="taskModalTitle">Add New Task</h2>
                    <button class="text-gray-500 hover:text-gray-700 modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    
                    <div class="mb-4">
                        <label for="taskTitle" class="form-label">Title *</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="Enter task title" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea id="taskDescription" class="form-input" rows="3" placeholder="Enter task description"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="taskPriority" class="form-label">Priority *</label>
                            <select id="taskPriority" class="form-select" required>
                                <option value="">Select priority</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="taskDueDate" class="form-label">Due Date *</label>
                            <input type="date" id="taskDueDate" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskCategory" class="form-label">Category</label>
                        <select id="taskCategory" class="form-select">
                            <option value="">Select category</option>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskAssignee" class="form-label">Assign To</label>
                        <select id="taskAssignee" class="form-select">
                            <option value="">Select assignee</option>
                            <!-- Users will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">Subtasks</label>
                        <div id="subtasksContainer" class="space-y-2">
                            <!-- Subtasks will be added here -->
                        </div>
                        <button type="button" id="addSubtaskBtn" class="mt-2 flex items-center text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-plus-circle mr-1"></i> Add Subtask
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskNotes" class="form-label">Notes</label>
                        <textarea id="taskNotes" class="form-input" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content w-full max-w-lg">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">My Profile</h2>
                    <button class="text-gray-500 hover:text-gray-700 modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="flex flex-col md:flex-row mb-6">
                    <div class="mb-4 md:mb-0 md:mr-6 flex flex-col items-center">
                        <div class="w-24 h-24 rounded-full bg-cover bg-center border-2 border-indigo-500 mb-2" id="profileModalPic"></div>
                        <label for="profilePicUpload" class="btn btn-secondary text-xs cursor-pointer mt-2">
                            <i class="fas fa-upload mr-1"></i> Change Photo
                        </label>
                        <input type="file" id="profilePicUpload" class="hidden" accept="image/*">
                    </div>
                    
                    <div class="flex-1">
                        <form id="profileForm">
                            <div class="mb-4">
                                <label for="profileName" class="form-label">Name</label>
                                <input type="text" id="profileNameInput" class="form-input" placeholder="Your name">
                            </div>
                            
                            <div class="mb-4">
                                <label for="profileEmail" class="form-label">Email</label>
                                <input type="email" id="profileEmailInput" class="form-input" placeholder="Your email">
                            </div>
                        </form>
                    </div>
                </div>
                
                <form id="profileDetailsForm">
                    <div class="mb-4">
                        <label for="profilePhone" class="form-label">Phone Number</label>
                        <input type="tel" id="profilePhoneInput" class="form-input" placeholder="Your phone number">
                    </div>
                    
                    <div class="mb-4">
                        <label for="profileCountry" class="form-label">Country</label>
                        <select id="profileCountryInput" class="form-select">
                            <option value="">Select your country</option>
                            <!-- Countries will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="profileRole" class="form-label">Role</label>
                        <input type="text" id="profileRoleInput" class="form-input" readonly>
                    </div>
                    
                    <div class="mb-6">
                        <label for="profilePassword" class="form-label">Password</label>
                        <input type="password" id="profilePasswordInput" class="form-input" placeholder="Change password">
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div id="usersModal" class="modal">
        <div class="modal-content w-full max-w-4xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Users</h2>
                    <button class="text-gray-500 hover:text-gray-700 modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <input type="text" id="searchUsers" class="form-input" placeholder="Search users...">
                </div>
                
                <div id="usersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Users will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Export Tasks</h2>
                    <button class="text-gray-500 hover:text-gray-700 modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <p class="mb-4">Select the format to export your tasks:</p>
                
                <div class="space-y-2">
                    <button class="btn btn-secondary w-full flex items-center justify-center" data-format="json">
                        <i class="fas fa-file-code mr-2"></i> JSON Format
                    </button>
                    <button class="btn btn-secondary w-full flex items-center justify-center" data-format="pdf">
                        <i class="fas fa-file-pdf mr-2"></i> PDF Format
                    </button>
                    <button class="btn btn-secondary w-full flex items-center justify-center" data-format="docx">
                        <i class="fas fa-file-word mr-2"></i> DOCX Format
                    </button>
                    <button class="btn btn-secondary w-full flex items-center justify-center" data-format="csv">
                        <i class="fas fa-file-csv mr-2"></i> CSV Format
                    </button>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Import Tasks</h2>
                    <button class="text-gray-500 hover:text-gray-700 modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <p class="mb-4">Upload a JSON file containing your tasks:</p>
                
                <div class="mb-4">
                    <label for="importFile" class="btn btn-secondary w-full flex items-center justify-center cursor-pointer">
                        <i class="fas fa-file-upload mr-2"></i> Choose File
                    </label>
                    <input type="file" id="importFile" class="hidden" accept=".json">
                </div>
                
                <div id="importFileName" class="text-center text-sm mb-4 text-gray-500">No file selected</div>
                
                <div class="flex justify-end space-x-2">
                    <button class="btn btn-secondary modal-close">Cancel</button>
                    <button id="importTasksBtn" class="btn btn-primary" disabled>Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // App initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme based on user preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-xl"></i>';
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-xl"></i>';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon text-xl"></i>';
                }
            });

            // Initialize global variables and state
            const appState = {
                currentUser: null,
                userStatus: 'login',
                tasks: [],
                users: [],
                notifications: [],
                selectedTasks: [],
                taskTimers: {},
                workTimer: {
                    startTime: null,
                    elapsedTime: 0,
                    status: 'stopped',
                    statusStartTime: null
                },
                undoStack: [],
                redoStack: [],
                categories: ['Work', 'Personal', 'Health', 'Finance', 'Education', 'Projects', 'Meetings', 'Shopping']
            };
            
            // App initialization functions
            initApp();
            
            // Initialize random users
            function generateRandomUsers(count = 10) {
                const roles = ['Manager', 'Admin', 'Staff', 'Customer'];
                const firstNames = ['John', 'Jane', 'Michael', 'Emma', 'David', 'Sarah', 'Chris', 'Lisa', 'Robert', 'Amanda'];
                const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'];
                const domains = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'company.com'];
                
                const users = [];
                
                for (let i = 0; i < count; i++) {
                    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                    const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@${domains[Math.floor(Math.random() * domains.length)]}`;
                    const role = roles[Math.floor(Math.random() * roles.length)];
                    
                    users.push({
                        id: generateId(),
                        name: `${firstName} ${lastName}`,
                        email,
                        password: 'password123',
                        phone: `+1${Math.floor(1000000000 + Math.random() * 9000000000)}`,
                        country: getRandomCountry(),
                        role,
                        profilePic: generateAvatarUrl(firstName, lastName),
                        status: 'login'
                    });
                }
                
                return users;
            }
            
            // Generate avatar URL based on name
            function generateAvatarUrl(firstName, lastName) {
                const colors = ['1abc9c', '2ecc71', '3498db', '9b59b6', 'e67e22', 'e74c3c', 'f1c40f', '34495e'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`;
                
                // Return data URL for a circle with text (initials)
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Draw background
                ctx.fillStyle = `#${color}`;
                ctx.beginPath();
                ctx.arc(100, 100, 100, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw text
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 80px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, 100, 100);
                
                return canvas.toDataURL();
            }
            
            // Generate random tasks
            function generateRandomTasks(count = 10) {
                const titles = [
                    'Complete project proposal', 'Schedule team meeting', 'Review client feedback',
                    'Update website content', 'Prepare financial reports', 'Send follow-up emails',
                    'Plan marketing campaign', 'Research competitors', 'Organize files',
                    'Call with the client', 'Fix website bugs', 'Order office supplies'
                ];
                
                const descriptions = [
                    'This needs to be completed by the end of the week',
                    'Make sure to include all team members',
                    'Focus on the key points discussed in the last meeting',
                    'Update all sections and check for broken links',
                    'Include Q1 and Q2 figures for comparison',
                    'Follow up on pending requests and queries',
                    'Create a comprehensive strategy for the next quarter',
                    'Analyze market trends and competitor strategies',
                    'Reorganize digital and physical files for better accessibility',
                    'Discuss project timeline and deliverables',
                    'Address reported issues and test all functionality',
                    'Replenish inventory of essential office supplies'
                ];
                
                const priorities = ['high', 'medium', 'low'];
                const tasks = [];
                
                for (let i = 0; i < count; i++) {
                    const title = titles[Math.floor(Math.random() * titles.length)];
                    const description = descriptions[Math.floor(Math.random() * descriptions.length)];
                    const priority = priorities[Math.floor(Math.random() * priorities.length)];
                    const category = appState.categories[Math.floor(Math.random() * appState.categories.length)];
                    
                    // Generate random due date between today and 15 days in the future
                    const today = new Date();
                    const futureDate = new Date(today);
                    futureDate.setDate(today.getDate() + Math.floor(Math.random() * 15));
                    
                    // 30% chance of being completed
                    const completed = Math.random() < 0.3;
                    
                    // Random assignee
                    const assigneeIndex = Math.floor(Math.random() * appState.users.length);
                    const assignee = appState.users[assigneeIndex].id;
                    
                    // Generate 0-3 subtasks
                    const subtasks = [];
                    const subtaskCount = Math.floor(Math.random() * 4);
                    for (let j = 0; j < subtaskCount; j++) {
                        subtasks.push({
                            id: generateId(),
                            title: `Subtask ${j+1} for ${title}`,
                            completed: Math.random() < 0.5
                        });
                    }
                    
                    tasks.push({
                        id: generateId(),
                        title,
                        description,
                        priority,
                        dueDate: formatDateForInput(futureDate),
                        category,
                        assignee,
                        notes: '',
                        subtasks,
                        completed,
                        createdAt: new Date().toISOString(),
                        completedAt: completed ? new Date().toISOString() : null,
                        timeSpent: Math.floor(Math.random() * 3600) // Random time in seconds
                    });
                }
                
                return tasks;
            }
            
            // Initialize countries for the dropdown
            function populateCountries() {
                const countries = [
                    {code: 'US', name: 'United States'},
                    {code: 'GB', name: 'United Kingdom'},
                    {code: 'CA', name: 'Canada'},
                    {code: 'AU', name: 'Australia'},
                    {code: 'DE', name: 'Germany'},
                    {code: 'FR', name: 'France'},
                    {code: 'JP', name: 'Japan'},
                    {code: 'CN', name: 'China'},
                    {code: 'IN', name: 'India'},
                    {code: 'BR', name: 'Brazil'},
                    {code: 'MX', name: 'Mexico'},
                    {code: 'IT', name: 'Italy'},
                    {code: 'ES', name: 'Spain'},
                    {code: 'KR', name: 'South Korea'},
                    {code: 'RU', name: 'Russia'},
                    {code: 'ZA', name: 'South Africa'},
                    {code: 'SA', name: 'Saudi Arabia'},
                    {code: 'AE', name: 'United Arab Emirates'},
                    {code: 'SG', name: 'Singapore'},
                    {code: 'NZ', name: 'New Zealand'}
                ];
                
                const countrySelects = [
                    document.getElementById('regCountry'),
                    document.getElementById('profileCountryInput')
                ];
                
                countries.sort((a, b) => a.name.localeCompare(b.name));
                
                countrySelects.forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">Select your country</option>';
                        countries.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country.code;
                            option.textContent = country.name;
                            select.appendChild(option);
                        });
                    }
                });
            }
            
            function getRandomCountry() {
                const countries = ['US', 'GB', 'CA', 'AU', 'DE', 'FR', 'JP', 'CN', 'IN', 'BR'];
                return countries[Math.floor(Math.random() * countries.length)];
            }
            
            // Initialize category dropdowns
            function populateCategories() {
                const categorySelects = [
                    document.getElementById('taskCategory'),
                    document.getElementById('filterCategory')
                ];
                
                categorySelects.forEach(select => {
                    if (select) {
                        if (select.id === 'filterCategory') {
                            select.innerHTML = '<option value="">All Categories</option>';
                        } else {
                            select.innerHTML = '<option value="">Select category</option>';
                        }
                        
                        appState.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.toLowerCase();
                            option.textContent = category;
                            select.appendChild(option);
                        });
                    }
                });
            }
            
            // Initialize assignee dropdown
            function populateAssignees() {
                const assigneeSelect = document.getElementById('taskAssignee');
                
                if (assigneeSelect) {
                    assigneeSelect.innerHTML = '<option value="">Select assignee</option>';
                    
                    appState.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        assigneeSelect.appendChild(option);
                    });
                }
            }
            
            // Initialize app
            function initApp() {
                // Initialize data from localStorage or create demo data
                loadAppData();
                
                // Populate dropdown options
                populateCountries();
                populateCategories();
                populateAssignees();
                
                // Initialize auth page
                initAuthPage();
                
                // Initialize event listeners
                initEventListeners();
                
                // Check if user is logged in
                checkAuthStatus();
                
                // Update task counters
                updateTaskCounters();
                
                // Start timers
                initTimers();
            }
            
            // Check auth status and redirect accordingly
            function checkAuthStatus() {
                const currentUser = localStorage.getItem('currentUser');
                
                if (currentUser) {
                    appState.currentUser = JSON.parse(currentUser);
                    showApp();
                    updateUserInterface();
                } else {
                    showAuthPage();
                }
            }
            
            // Load app data from localStorage or initialize with demo data
            function loadAppData() {
                // Load users
                const storedUsers = localStorage.getItem('users');
                if (storedUsers) {
                    appState.users = JSON.parse(storedUsers);
                } else {
                    appState.users = generateRandomUsers(10);
                    localStorage.setItem('users', JSON.stringify(appState.users));
                }
                
                // Load tasks
                const storedTasks = localStorage.getItem('tasks');
                if (storedTasks) {
                    appState.tasks = JSON.parse(storedTasks);
                } else {
                    appState.tasks = generateRandomTasks(12);
                    localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                }
                
                // Load notifications
                const storedNotifications = localStorage.getItem('notifications');
                if (storedNotifications) {
                    appState.notifications = JSON.parse(storedNotifications);
                } else {
                    // Generate some example notifications
                    appState.notifications = [
                        { id: generateId(), title: 'Welcome!', message: 'Welcome to the To-Do App', read: false, timestamp: new Date().toISOString() },
                        { id: generateId(), title: 'Tip', message: 'Try using the dark mode for a different experience', read: false, timestamp: new Date().toISOString() }
                    ];
                    localStorage.setItem('notifications', JSON.stringify(appState.notifications));
                }
                
                // Load work timer state
                const storedWorkTimer = localStorage.getItem('workTimer');
                if (storedWorkTimer) {
                    appState.workTimer = JSON.parse(storedWorkTimer);
                    
                    // If the timer was running, update elapsed time
                    if (appState.workTimer.status !== 'stopped' && appState.workTimer.statusStartTime) {
                        const now = new Date().getTime();
                        const statusStartTime = new Date(appState.workTimer.statusStartTime).getTime();
                        const elapsedSinceLastStart = Math.floor((now - statusStartTime) / 1000);
                        appState.workTimer.elapsedTime += elapsedSinceLastStart;
                        appState.workTimer.statusStartTime = new Date().toISOString();
                    }
                }
            }
            
            // Initialize event listeners
            function initEventListeners() {
                // Auth page event listeners
                document.getElementById('showRegisterBtn').addEventListener('click', () => {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('registerForm').classList.remove('hidden');
                });
                
                document.getElementById('showLoginBtn').addEventListener('click', () => {
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                });
                
                document.getElementById('loginBtn').addEventListener('click', handleLogin);
                document.getElementById('registerBtn').addEventListener('click', handleRegister);
                
                // Header event listeners
                document.getElementById('themeToggle').addEventListener('click', toggleTheme);
                document.getElementById('profileBtn').addEventListener('click', toggleProfileDropdown);
                document.getElementById('notificationBtn').addEventListener('click', toggleNotificationDropdown);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('viewProfileBtn').addEventListener('click', openProfileModal);
                
                // Status options
                document.querySelectorAll('.status-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        updateUserStatus(e.target.dataset.status);
                    });
                });
                
                // Task control buttons
                document.getElementById('addTaskBtn').addEventListener('click', openAddTaskModal);
                document.getElementById('undoBtn').addEventListener('click', handleUndo);
                document.getElementById('redoBtn').addEventListener('click', handleRedo);
                document.getElementById('importBtn').addEventListener('click', openImportModal);
                document.getElementById('exportBtn').addEventListener('click', openExportModal);
                document.getElementById('usersBtn').addEventListener('click', openUsersModal);
                
                // View toggle
                document.getElementById('listViewBtn').addEventListener('click', () => {
                    document.getElementById('listView').classList.remove('hidden');
                    document.getElementById('graphView').classList.add('hidden');
                    document.getElementById('listViewBtn').classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm');
                    document.getElementById('graphViewBtn').classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm');
                });
                
                document.getElementById('graphViewBtn').addEventListener('click', () => {
                    document.getElementById('graphView').classList.remove('hidden');
                    document.getElementById('listView').classList.add('hidden');
                    document.getElementById('graphViewBtn').classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm');
                    document.getElementById('listViewBtn').classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm');
                    
                    // Initialize or update charts
                    initCharts();
                });
                
                // Task filters
                document.getElementById('searchTask').addEventListener('input', filterTasks);
                document.getElementById('filterCategory').addEventListener('change', filterTasks);
                document.getElementById('filterPriority').addEventListener('change', filterTasks);
                document.getElementById('filterStatus').addEventListener('change', filterTasks);
                document.getElementById('filterDueDate').addEventListener('change', function() {
                    if (this.value === 'custom') {
                        document.getElementById('customDateFilter').classList.remove('hidden');
                    } else {
                        document.getElementById('customDateFilter').classList.add('hidden');
                    }
                    filterTasks();
                });
                
                document.getElementById('dateFrom').addEventListener('change', filterTasks);
                document.getElementById('dateTo').addEventListener('change', filterTasks);
                
                // Task sorting
                document.getElementById('taskSort').addEventListener('change', filterTasks);
                
                // Multi-select
                document.getElementById('enableMultiSelect').addEventListener('change', function() {
                    const isEnabled = this.checked;
                    if (isEnabled) {
                        document.getElementById('bulkActionsContainer').classList.remove('hidden');
                    } else {
                        document.getElementById('bulkActionsContainer').classList.add('hidden');
                        appState.selectedTasks = [];
                        updateTaskSelection();
                    }
                });
                
                // Bulk actions
                document.getElementById('bulkCompleteBtn').addEventListener('click', () => {
                    if (appState.selectedTasks.length > 0) {
                        toggleTasksComplete(appState.selectedTasks, true);
                    }
                });
                
                document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
                    if (appState.selectedTasks.length > 0) {
                        deleteTasks(appState.selectedTasks);
                    }
                });
                
                // Task modal handlers
                document.getElementById('taskForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTask();
                });
                
                document.getElementById('addSubtaskBtn').addEventListener('click', addSubtaskField);
                
                // Profile modal handlers
                document.getElementById('profileDetailsForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveProfileChanges();
                });
                
                document.getElementById('profilePicUpload').addEventListener('change', handleProfileImageUpload);
                
                // Import handlers
                document.getElementById('importFile').addEventListener('change', function() {
                    const fileNameElem = document.getElementById('importFileName');
                    if (this.files.length > 0) {
                        fileNameElem.textContent = this.files[0].name;
                        document.getElementById('importTasksBtn').disabled = false;
                    } else {
                        fileNameElem.textContent = 'No file selected';
                        document.getElementById('importTasksBtn').disabled = true;
                    }
                });
                
                document.getElementById('importTasksBtn').addEventListener('click', importTasks);
                
                // Export handlers
                document.querySelectorAll('#exportModal button[data-format]').forEach(button => {
                    button.addEventListener('click', function() {
                        exportTasks(this.dataset.format);
                    });
                });
                
                // Modal close buttons
                document.querySelectorAll('.modal-close').forEach(button => {
                    button.addEventListener('click', function() {
                        closeAllModals();
                    });
                });
                
                // Close modals when clicking outside
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeAllModals();
                        }
                    });
                });
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', function(e) {
                    const profileContainer = document.getElementById('profileContainer');
                    const notificationContainer = document.getElementById('notificationContainer');
                    
                    if (!profileContainer.contains(e.target)) {
                        profileContainer.classList.remove('profile-active');
                    }
                    
                    if (!notificationContainer.contains(e.target)) {
                        notificationContainer.classList.remove('notification-active');
                    }
                });
                
                // Document keydown handler for keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    // Ctrl/Cmd + Z for Undo
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        handleUndo();
                    }
                    
                    // Ctrl/Cmd + Shift + Z or Ctrl/Cmd + Y for Redo
                    if (((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) || 
                        ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                        e.preventDefault();
                        handleRedo();
                    }
                    
                    // Escape key to close modals
                    if (e.key === 'Escape') {
                        closeAllModals();
                    }
                });
                
                // Check for daily timer reset
                checkDailyReset();
            }
            
            // Initialize auth page
            function initAuthPage() {
                // Set up login form submission
                const loginForm = document.getElementById('loginForm');
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleLogin();
                });
                
                // Set up registration form submission
                const registerForm = document.getElementById('registerForm');
                registerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleRegister();
                });
            }
            
            // Handle login
            function handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showNotification('Error', 'Please enter both email and password', 'error');
                    return;
                }
                
                const user = appState.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === password);
                
                if (user) {
                    // Update user status to login
                    user.status = 'login';
                    
                    // Save current user to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    appState.currentUser = user;
                    
                    // Update users in localStorage
                    localStorage.setItem('users', JSON.stringify(appState.users));
                    
                    // Start work timer
                    startWorkTimer();
                    
                    // Show the main app
                    showApp();
                    
                    // Update UI with user info
                    updateUserInterface();
                    
                    // Show notification
                    showNotification('Welcome', `Welcome back, ${user.name}!`, 'success');
                    
                    // Add notification
                    addNotification('Login Successful', `You logged in at ${new Date().toLocaleTimeString()}`);
                } else {
                    showNotification('Error', 'Invalid email or password', 'error');
                }
            }
            
            // Handle register
            function handleRegister() {
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const emailConfirm = document.getElementById('regEmailConfirm').value;
                const password = document.getElementById('regPassword').value;
                const passwordConfirm = document.getElementById('regPasswordConfirm').value;
                const phone = document.getElementById('regPhone').value;
                const country = document.getElementById('regCountry').value;
                const role = document.getElementById('regRole').value;
                
                // Validate form
                if (!name || !email || !emailConfirm || !password || !passwordConfirm || !phone || !country || !role) {
                    showNotification('Error', 'Please fill in all fields', 'error');
                    return;
                }
                
                if (email !== emailConfirm) {
                    showNotification('Error', 'Emails do not match', 'error');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    showNotification('Error', 'Passwords do not match', 'error');
                    return;
                }
                
                // Check if email already exists
                const existingUser = appState.users.find(u => u.email.toLowerCase() === email.toLowerCase());
                if (existingUser) {
                    showNotification('Error', 'Email already registered', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: generateId(),
                    name,
                    email,
                    password,
                    phone,
                    country,
                    role,
                    profilePic: generateAvatarUrl(name.split(' ')[0], name.split(' ')[1] || ''),
                    status: 'login'
                };
                
                // Add user to users array
                appState.users.push(newUser);
                
                // Save users to localStorage
                localStorage.setItem('users', JSON.stringify(appState.users));
                
                // Set as current user
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                appState.currentUser = newUser;
                
                // Start work timer
                startWorkTimer();
                
                // Show the main app
                showApp();
                
                // Update UI with user info
                updateUserInterface();
                
                // Show notification
                showNotification('Welcome', `Account created successfully! Welcome, ${name}!`, 'success');
                
                // Add notification
                addNotification('Registration Successful', `Your account was created at ${new Date().toLocaleTimeString()}`);
            }
            
            // Handle logout
            function handleLogout() {
                // Update user status
                updateUserStatus('logout');
                
                // Remove current user from localStorage
                localStorage.removeItem('currentUser');
                appState.currentUser = null;
                
                // Stop work timer
                stopWorkTimer();
                
                // Show auth page
                showAuthPage();
                
                // Show notification
                showNotification('Logged Out', 'You have been logged out successfully', 'info');
            }
            
            // Show auth page
            function showAuthPage() {
                document.getElementById('authPage').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                
                // Clear auth form fields
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('regName').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regEmailConfirm').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regPasswordConfirm').value = '';
                document.getElementById('regPhone').value = '';
                document.getElementById('regCountry').value = '';
                document.getElementById('regRole').value = '';
            }
            
            // Show main app
            function showApp() {
                document.getElementById('authPage').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                
                // Render tasks
                renderTasks();
                
                // Update notification counter
                updateNotificationCounter();
            }
            
            // Toggle theme
            function toggleTheme() {
                const htmlElement = document.documentElement;
                const themeToggle = document.getElementById('themeToggle');
                
                if (htmlElement.classList.contains('dark')) {
                    htmlElement.classList.remove('dark');
                    themeToggle.innerHTML = '<i class="fas fa-moon text-xl"></i>';
                } else {
                    htmlElement.classList.add('dark');
                    themeToggle.innerHTML = '<i class="fas fa-sun text-xl"></i>';
                }
            }
            
            // Toggle profile dropdown
            function toggleProfileDropdown() {
                const profileContainer = document.getElementById('profileContainer');
                profileContainer.classList.toggle('profile-active');
                
                // Close notification dropdown if open
                document.getElementById('notificationContainer').classList.remove('notification-active');
            }
            
            // Toggle notification dropdown
            function toggleNotificationDropdown() {
                const notificationContainer = document.getElementById('notificationContainer');
                notificationContainer.classList.toggle('notification-active');
                
                // Close profile dropdown if open
                document.getElementById('profileContainer').classList.remove('profile-active');
                
                // Mark notifications as read when opened
                if (notificationContainer.classList.contains('notification-active')) {
                    markAllNotificationsAsRead();
                }
            }
            
            // Mark all notifications as read
            function markAllNotificationsAsRead() {
                appState.notifications.forEach(notification => {
                    notification.read = true;
                });
                
                // Update localStorage
                localStorage.setItem('notifications', JSON.stringify(appState.notifications));
                
                // Update UI
                updateNotificationCounter();
                renderNotifications();
            }
            
            // Update notification counter
            function updateNotificationCounter() {
                const unreadCount = appState.notifications.filter(notification => !notification.read).length;
                const notificationCount = document.getElementById('notificationCount');
                
                notificationCount.textContent = unreadCount;
                
                if (unreadCount === 0) {
                    notificationCount.classList.add('hidden');
                } else {
                    notificationCount.classList.remove('hidden');
                }
                
                // Render notifications in dropdown
                renderNotifications();
            }
            
            // Render notifications in dropdown
            function renderNotifications() {
                const notificationList = document.getElementById('notificationList');
                
                if (appState.notifications.length === 0) {
                    notificationList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm py-2">No notifications yet</p>';
                    return;
                }
                
                // Sort notifications by timestamp (newest first)
                const sortedNotifications = [...appState.notifications].sort((a, b) => {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                notificationList.innerHTML = '';
                
                sortedNotifications.forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = `border-b border-gray-200 dark:border-gray-700 py-2 ${notification.read ? 'opacity-70' : 'font-semibold'}`;
                    
                    const timestamp = new Date(notification.timestamp);
                    const timeString = timestamp.toLocaleString();
                    
                    notificationElement.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <h4 class="text-sm">${notification.title}</h4>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${timeString}</span>
                        </div>
                        <p class="text-xs text-gray-600 dark:text-gray-300">${notification.message}</p>
                    `;
                    
                    notificationElement.addEventListener('click', () => {
                        // Mark this notification as read
                        notification.read = true;
                        localStorage.setItem('notifications', JSON.stringify(appState.notifications));
                        updateNotificationCounter();
                    });
                    
                    notificationList.appendChild(notificationElement);
                });
            }
            
            // Add a new notification
            function addNotification(title, message) {
                const notification = {
                    id: generateId(),
                    title,
                    message,
                    read: false,
                    timestamp: new Date().toISOString()
                };
                
                appState.notifications.push(notification);
                
                // Save to localStorage
                localStorage.setItem('notifications', JSON.stringify(appState.notifications));
                
                // Update UI
                updateNotificationCounter();
            }
            
            // Show notification toast
            function showNotification(title, message, type = 'info') {
                const toast = document.getElementById('notificationToast');
                const toastTitle = document.getElementById('toastTitle');
                const toastMessage = document.getElementById('toastMessage');
                
                // Set title and message
                toastTitle.textContent = title;
                toastMessage.textContent = message;
                
                // Set color based on type
                const iconClass = toast.querySelector('i');
                iconClass.className = 'fas mr-3 ';
                
                switch (type) {
                    case 'success':
                        iconClass.className += 'fa-check-circle text-green-500';
                        break;
                    case 'error':
                        iconClass.className += 'fa-exclamation-circle text-red-500';
                        break;
                    case 'warning':
                        iconClass.className += 'fa-exclamation-triangle text-yellow-500';
                        break;
                    default:
                        iconClass.className += 'fa-bell text-indigo-500';
                }
                
                // Show the toast
                toast.classList.add('active');
                
                // Hide after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('active');
                }, 5000);
            }
            
            // Update user status
            function updateUserStatus(status) {
                if (!appState.currentUser) return;
                
                // Update user status
                appState.currentUser.status = status;
                
                // Find user in users array and update
                const userIndex = appState.users.findIndex(u => u.id === appState.currentUser.id);
                if (userIndex !== -1) {
                    appState.users[userIndex].status = status;
                    localStorage.setItem('users', JSON.stringify(appState.users));
                }
                
                // Update localStorage
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                
                // Update UI
                updateUserInterface();
                
                // Update work timer status
                updateWorkTimerStatus(status);
                
                // Create notification
                const statusMessages = {
                    login: 'You are now logged in',
                    shadow: 'You are now in shadow mode',
                    break: 'You are now on break',
                    logout: 'You are now logged out'
                };
                
                showNotification('Status Updated', statusMessages[status], 'info');
                addNotification('Status Change', `Status changed to ${status} at ${new Date().toLocaleTimeString()}`);
            }
            
            // Update user interface with user info
            function updateUserInterface() {
                if (!appState.currentUser) return;
                
                // Update profile name
                document.getElementById('profileName').textContent = appState.currentUser.name;
                
                // Update profile picture and border color
                const profilePic = document.getElementById('profilePic');
                const profileModalPic = document.getElementById('profileModalPic');
                
                profilePic.style.backgroundImage = `url(${appState.currentUser.profilePic})`;
                if (profileModalPic) {
                    profileModalPic.style.backgroundImage = `url(${appState.currentUser.profilePic})`;
                }
                
                // Update border color based on status
                profilePic.className = profilePic.className.replace(/border-\w+-500/g, '');
                
                switch (appState.currentUser.status) {
                    case 'login':
                        profilePic.classList.add('border-green-500');
                        break;
                    case 'logout':
                        profilePic.classList.add('border-red-500');
                        break;
                    case 'break':
                        profilePic.classList.add('border-yellow-500');
                        break;
                    case 'shadow':
                        profilePic.classList.add('border-gray-500');
                        break;
                }
                
                // Refresh task display
                renderTasks();
                updateTaskCounters();
            }
            
            // Open profile modal
            function openProfileModal() {
                if (!appState.currentUser) return;
                
                const modal = document.getElementById('profileModal');
                
                // Populate form fields
                document.getElementById('profileNameInput').value = appState.currentUser.name;
                document.getElementById('profileEmailInput').value = appState.currentUser.email;
                document.getElementById('profilePhoneInput').value = appState.currentUser.phone;
                document.getElementById('profileCountryInput').value = appState.currentUser.country;
                document.getElementById('profileRoleInput').value = appState.currentUser.role;
                document.getElementById('profilePasswordInput').value = '';
                
                // Set profile picture
                document.getElementById('profileModalPic').style.backgroundImage = `url(${appState.currentUser.profilePic})`;
                
                // Close dropdowns
                document.getElementById('profileContainer').classList.remove('profile-active');
                
                // Show modal
                modal.style.display = 'block';
            }
            
            // Handle profile image upload
            function handleProfileImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file type
                if (!file.type.startsWith('image/')) {
                    showNotification('Error', 'Please select an image file', 'error');
                    return;
                }
                
                // Read file as data URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    
                    // Update preview
                    document.getElementById('profileModalPic').style.backgroundImage = `url(${imageDataUrl})`;
                    
                    // Store in temp variable for saving later
                    document.getElementById('profileModalPic').dataset.newImage = imageDataUrl;
                };
                reader.readAsDataURL(file);
            }
            
            // Save profile changes
            function saveProfileChanges() {
                if (!appState.currentUser) return;
                
                // Get form values
                const name = document.getElementById('profileNameInput').value;
                const email = document.getElementById('profileEmailInput').value;
                const phone = document.getElementById('profilePhoneInput').value;
                const country = document.getElementById('profileCountryInput').value;
                const password = document.getElementById('profilePasswordInput').value;
                
                // Validate form
                if (!name || !email || !phone || !country) {
                    showNotification('Error', 'Please fill in all required fields', 'error');
                    return;
                }
                
                // Check if email is changed and if it already exists
                if (email !== appState.currentUser.email) {
                    const existingUser = appState.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.id !== appState.currentUser.id);
                    if (existingUser) {
                        showNotification('Error', 'Email already in use', 'error');
                        return;
                    }
                }
                
                // Get new profile picture if uploaded
                const newImage = document.getElementById('profileModalPic').dataset.newImage;
                
                // Update user data
                appState.currentUser.name = name;
                appState.currentUser.email = email;
                appState.currentUser.phone = phone;
                appState.currentUser.country = country;
                
                if (password) {
                    appState.currentUser.password = password;
                }
                
                if (newImage) {
                    appState.currentUser.profilePic = newImage;
                }
                
                // Update user in users array
                const userIndex = appState.users.findIndex(u => u.id === appState.currentUser.id);
                if (userIndex !== -1) {
                    appState.users[userIndex] = {...appState.currentUser};
                    
                    // Save users to localStorage
                    localStorage.setItem('users', JSON.stringify(appState.users));
                }
                
                // Save current user to localStorage
                localStorage.setItem('currentUser', JSON.stringify(appState.currentUser));
                
                // Update UI
                updateUserInterface();
                
                // Close modal
                closeAllModals();
                
                // Show notification
                showNotification('Success', 'Profile updated successfully', 'success');
                
                // Add notification
                addNotification('Profile Updated', `Your profile was updated at ${new Date().toLocaleTimeString()}`);
            }
            
            // Open add task modal
            function openAddTaskModal() {
                const modal = document.getElementById('taskModal');
                
                // Reset form
                document.getElementById('taskForm').reset();
                document.getElementById('taskId').value = '';
                document.getElementById('taskModalTitle').textContent = 'Add New Task';
                document.getElementById('subtasksContainer').innerHTML = '';
                
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('taskDueDate').value = formatDateForInput(tomorrow);
                
                // Show modal
                modal.style.display = 'block';
            }
            
            // Open edit task modal
            function openEditTaskModal(taskId) {
                const task = appState.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const modal = document.getElementById('taskModal');
                
                // Set modal title
                document.getElementById('taskModalTitle').textContent = 'Edit Task';
                
                // Populate form fields
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskPriority').value = task.priority;
                document.getElementById('taskDueDate').value = task.dueDate;
                document.getElementById('taskCategory').value = task.category?.toLowerCase() || '';
                document.getElementById('taskAssignee').value = task.assignee || '';
                document.getElementById('taskNotes').value = task.notes || '';
                
                // Add subtasks
                const subtasksContainer = document.getElementById('subtasksContainer');
                subtasksContainer.innerHTML = '';
                
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        addSubtaskField(subtask);
                    });
                }
                
                // Show modal
                modal.style.display = 'block';
            }
            
            // Add subtask field
            function addSubtaskField(subtask = null) {
                const subtasksContainer = document.getElementById('subtasksContainer');
                const subtaskId = subtask ? subtask.id : generateId();
                
                const subtaskRow = document.createElement('div');
                subtaskRow.className = 'flex items-center space-x-2';
                subtaskRow.innerHTML = `
                    <input type="hidden" name="subtaskId" value="${subtaskId}">
                    <input type="text" class="form-input flex-1" name="subtaskTitle" placeholder="Subtask title" value="${subtask ? subtask.title : ''}">
                    <div class="flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="subtaskCompleted" class="form-checkbox h-5 w-5 text-indigo-600" ${subtask && subtask.completed ? 'checked' : ''}>
                            <span class="ml-2 text-sm">Done</span>
                        </label>
                        <button type="button" class="ml-2 text-red-500 hover:text-red-700 remove-subtask">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add event listener to remove button
                subtaskRow.querySelector('.remove-subtask').addEventListener('click', function() {
                    subtaskRow.remove();
                });
                
                subtasksContainer.appendChild(subtaskRow);
            }
            
            // Save task
            function saveTask() {
                const taskId = document.getElementById('taskId').value;
                const title = document.getElementById('taskTitle').value;
                const description = document.getElementById('taskDescription').value;
                const priority = document.getElementById('taskPriority').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const category = document.getElementById('taskCategory').value;
                const assignee = document.getElementById('taskAssignee').value;
                const notes = document.getElementById('taskNotes').value;
                
                // Validate form
                if (!title || !priority || !dueDate) {
                    showNotification('Error', 'Please fill in all required fields', 'error');
                    return;
                }
                
                // Get subtasks
                const subtasks = [];
                const subtaskRows = document.getElementById('subtasksContainer').querySelectorAll('div');
                
                subtaskRows.forEach(row => {
                    const subtaskId = row.querySelector('input[name="subtaskId"]').value;
                    const subtaskTitle = row.querySelector('input[name="subtaskTitle"]').value;
                    const subtaskCompleted = row.querySelector('input[name="subtaskCompleted"]').checked;
                    
                    if (subtaskTitle.trim()) {
                        subtasks.push({
                            id: subtaskId,
                            title: subtaskTitle,
                            completed: subtaskCompleted
                        });
                    }
                });
                
                // Save state for undo
                saveStateForUndo();
                
                // Create or update task
                if (taskId) {
                    // Update existing task
                    const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        const existingTask = appState.tasks[taskIndex];
                        
                        const updatedTask = {
                            ...existingTask,
                            title,
                            description,
                            priority,
                            dueDate,
                            category: category ? appState.categories.find(c => c.toLowerCase() === category.toLowerCase()) : '',
                            assignee,
                            notes,
                            subtasks
                        };
                        
                        appState.tasks[taskIndex] = updatedTask;
                        
                        showNotification('Success', 'Task updated successfully', 'success');
                        addNotification('Task Updated', `Task "${title}" was updated`);
                    }
                } else {
                    // Create new task
                    const newTask = {
                        id: generateId(),
                        title,
                        description,
                        priority,
                        dueDate,
                        category: category ? appState.categories.find(c => c.toLowerCase() === category.toLowerCase()) : '',
                        assignee,
                        notes,
                        subtasks,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        completedAt: null,
                        timeSpent: 0
                    };
                    
                    appState.tasks.push(newTask);
                    
                    showNotification('Success', 'Task created successfully', 'success');
                    addNotification('New Task', `New task "${title}" was created`);
                    
                    // Check for due date
                    checkTaskDueDate(newTask);
                }
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Close modal
                closeAllModals();
            }
            
            // Render tasks
            function renderTasks() {
                const tasksContainer = document.getElementById('tasksContainer');
                const filteredTasks = getFilteredTasks();
                
                if (filteredTasks.length === 0) {
                    tasksContainer.innerHTML = `
                        <div class="text-center py-10 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-tasks text-5xl mb-4"></i>
                            <p>No tasks found. Adjust your filters or add a new task.</p>
                        </div>
                    `;
                    return;
                }
                
                tasksContainer.innerHTML = '';
                
                filteredTasks.forEach(task => {
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-item card p-4 transition-all duration-200 ${task.completed ? 'border-l-4 border-green-500' : getPriorityBorderClass(task.priority)}`;
                    taskElement.dataset.id = task.id;
                    
                    // Task header
                    const taskHeader = document.createElement('div');
                    taskHeader.className = 'flex justify-between items-start mb-2';
                    
                    // Task drag handle and checkbox
                    const taskLeft = document.createElement('div');
                    taskLeft.className = 'flex items-center';
                    
                    // Task drag handle
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'task-drag-handle mr-2 cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300';
                    dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
                    taskLeft.appendChild(dragHandle);
                    
                    // Task checkbox
                    const checkbox = document.createElement('div');
                    checkbox.className = 'flex items-center mr-3';
                    checkbox.innerHTML = `
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-indigo-600 task-checkbox" ${task.completed ? 'checked' : ''}>
                    `;
                    // Add event listener to checkbox
                    checkbox.querySelector('.task-checkbox').addEventListener('change', function(e) {
                        e.stopPropagation();
                        toggleTaskComplete(task.id);
                    });
                    taskLeft.appendChild(checkbox);
                    
                    // Task title
                    const titleElement = document.createElement('h3');
                    titleElement.className = `font-medium ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : ''}`;
                    titleElement.textContent = task.title;
                    taskLeft.appendChild(titleElement);
                    
                    taskHeader.appendChild(taskLeft);
                    
                    // Task actions
                    const taskActions = document.createElement('div');
                    taskActions.className = 'flex space-x-2';
                    taskActions.innerHTML = `
                        <button class="text-gray-500 hover:text-indigo-600 task-timer-btn" title="Track time">
                            <i class="fas fa-clock"></i>
                        </button>
                        <button class="text-gray-500 hover:text-indigo-600 task-share-btn" title="Share task">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="text-gray-500 hover:text-indigo-600 task-edit-btn" title="Edit task">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-gray-500 hover:text-red-600 task-delete-btn" title="Delete task">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    // Add event listeners to buttons
                    taskActions.querySelector('.task-timer-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleTaskTimer(task.id);
                    });
                    
                    taskActions.querySelector('.task-share-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        shareTask(task.id);
                    });
                    
                    taskActions.querySelector('.task-edit-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        openEditTaskModal(task.id);
                    });
                    
                    taskActions.querySelector('.task-delete-btn').addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTask(task.id);
                    });
                    
                    taskHeader.appendChild(taskActions);
                    taskElement.appendChild(taskHeader);
                    
                    // Task details
                    const taskDetails = document.createElement('div');
                    taskDetails.className = 'ml-10';
                    
                    // Task description
                    if (task.description) {
                        const descElement = document.createElement('p');
                        descElement.className = 'text-sm text-gray-600 dark:text-gray-300 mb-2';
                        descElement.textContent = task.description;
                        taskDetails.appendChild(descElement);
                    }
                    
                    // Task metadata
                    const taskMeta = document.createElement('div');
                    taskMeta.className = 'grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-2';
                    
                    // Due date with color based on proximity
                    const dueDate = new Date(task.dueDate);
                    const today = new Date();
                    const diffTime = dueDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let dueDateClass = 'text-green-600 dark:text-green-400';
                    if (diffDays < 0) {
                        dueDateClass = 'text-red-600 dark:text-red-400';
                    } else if (diffDays <= 2) {
                        dueDateClass = 'text-yellow-600 dark:text-yellow-400';
                    }
                    
                    taskMeta.innerHTML = `
                        <div>
                            <span class="font-medium">Due:</span>
                            <span class="${dueDateClass}">${formatDate(task.dueDate)}</span>
                        </div>
                        <div>
                            <span class="font-medium">Priority:</span>
                            <span class="${getPriorityTextClass(task.priority)}">${capitalizeFirstLetter(task.priority)}</span>
                        </div>
                        <div>
                            <span class="font-medium">Category:</span>
                            <span>${task.category || 'None'}</span>
                        </div>
                        <div>
                            <span class="font-medium">Time:</span>
                            <span id="taskTime-${task.id}">${formatTimeSpent(task.timeSpent)}</span>
                        </div>
                    `;
                    taskDetails.appendChild(taskMeta);
                    
                    // Assignee
                    if (task.assignee) {
                        const assignee = appState.users.find(u => u.id === task.assignee);
                        if (assignee) {
                            const assigneeElement = document.createElement('div');
                            assigneeElement.className = 'flex items-center text-xs mb-2';
                            assigneeElement.innerHTML = `
                                <span class="font-medium mr-2">Assigned to:</span>
                                <div class="flex items-center">
                                    <div class="w-5 h-5 rounded-full bg-cover bg-center mr-1" style="background-image: url(${assignee.profilePic})"></div>
                                    <span>${assignee.name}</span>
                                </div>
                            `;
                            taskDetails.appendChild(assigneeElement);
                        }
                    }
                    
                    // Subtasks
                    if (task.subtasks && task.subtasks.length > 0) {
                        const subtasksElement = document.createElement('div');
                        subtasksElement.className = 'mt-2';
                        
                        const subtasksHeader = document.createElement('div');
                        subtasksHeader.className = 'text-xs font-medium mb-1';
                        subtasksHeader.textContent = 'Subtasks:';
                        subtasksElement.appendChild(subtasksHeader);
                        
                        const subtasksList = document.createElement('div');
                        subtasksList.className = 'space-y-1';
                        
                        task.subtasks.forEach(subtask => {
                            const subtaskItem = document.createElement('div');
                            subtaskItem.className = 'flex items-center text-xs';
                            subtaskItem.innerHTML = `
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 subtask-checkbox mr-2" 
                                    data-task-id="${task.id}" data-subtask-id="${subtask.id}" ${subtask.completed ? 'checked' : ''}>
                                <span class="${subtask.completed ? 'line-through text-gray-500 dark:text-gray-400' : ''}">${subtask.title}</span>
                            `;
                            
                            // Add event listener to subtask checkbox
                            subtaskItem.querySelector('.subtask-checkbox').addEventListener('change', function(e) {
                                e.stopPropagation();
                                toggleSubtaskComplete(task.id, subtask.id);
                            });
                            
                            subtasksList.appendChild(subtaskItem);
                        });
                        
                        subtasksElement.appendChild(subtasksList);
                        taskDetails.appendChild(subtasksElement);
                    }
                    
                    taskElement.appendChild(taskDetails);
                    
                    // Add click event to select task in multi-select mode
                    taskElement.addEventListener('click', function(e) {
                        if (document.getElementById('enableMultiSelect').checked) {
                            toggleTaskSelection(task.id);
                        }
                    });
                    
                    tasksContainer.appendChild(taskElement);
                    
                    // Initialize task drag-and-drop
                    initTaskDragDrop(taskElement);
                });
                
                // Update task selection
                updateTaskSelection();
            }
            
            // Initialize task drag and drop
            function initTaskDragDrop(taskElement) {
                taskElement.setAttribute('draggable', 'true');
                
                taskElement.addEventListener('dragstart', function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', this.dataset.id);
                });
                
                taskElement.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                taskElement.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const draggingElement = document.querySelector('.dragging');
                    if (draggingElement !== this) {
                        const container = document.getElementById('tasksContainer');
                        const afterElement = getDragAfterElement(container, e.clientY);
                        
                        if (afterElement) {
                            container.insertBefore(draggingElement, afterElement);
                        } else {
                            container.appendChild(draggingElement);
                        }
                    }
                });
            }
            
            // Get element to insert dragged element after
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // Get filtered tasks based on current filters
            function getFilteredTasks() {
                let tasks = [...appState.tasks];
                
                // Search filter
                const searchTerm = document.getElementById('searchTask').value.toLowerCase();
                if (searchTerm) {
                    tasks = tasks.filter(task => 
                        task.title.toLowerCase().includes(searchTerm) || 
                        (task.description && task.description.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Category filter
                const category = document.getElementById('filterCategory').value;
                if (category) {
                    tasks = tasks.filter(task => task.category && task.category.toLowerCase() === category);
                }
                
                // Priority filter
                const priority = document.getElementById('filterPriority').value;
                if (priority) {
                    tasks = tasks.filter(task => task.priority === priority);
                }
                
                // Status filter
                const status = document.getElementById('filterStatus').value;
                if (status) {
                    if (status === 'completed') {
                        tasks = tasks.filter(task => task.completed);
                    } else if (status === 'active') {
                        tasks = tasks.filter(task => !task.completed);
                    }
                }
                
                // Due date filter
                const dueDateFilter = document.getElementById('filterDueDate').value;
                if (dueDateFilter) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(today.getDate() + 7);
                    
                    const monthFromNow = new Date(today);
                    monthFromNow.setMonth(today.getMonth() + 1);
                    
                    if (dueDateFilter === 'today') {
                        tasks = tasks.filter(task => {
                            const dueDate = new Date(task.dueDate);
                            dueDate.setHours(0, 0, 0, 0);
                            return dueDate.getTime() === today.getTime();
                        });
                    } else if (dueDateFilter === 'week') {
                        tasks = tasks.filter(task => {
                            const dueDate = new Date(task.dueDate);
                            return dueDate >= today && dueDate <= weekFromNow;
                        });
                    } else if (dueDateFilter === 'month') {
                        tasks = tasks.filter(task => {
                            const dueDate = new Date(task.dueDate);
                            return dueDate >= today && dueDate <= monthFromNow;
                        });
                    } else if (dueDateFilter === 'custom') {
                        const dateFrom = document.getElementById('dateFrom').value;
                        const dateTo = document.getElementById('dateTo').value;
                        
                        if (dateFrom && dateTo) {
                            const fromDate = new Date(dateFrom);
                            fromDate.setHours(0, 0, 0, 0);
                            
                            const toDate = new Date(dateTo);
                            toDate.setHours(23, 59, 59, 999);
                            
                            tasks = tasks.filter(task => {
                                const dueDate = new Date(task.dueDate);
                                return dueDate >= fromDate && dueDate <= toDate;
                            });
                        }
                    }
                }
                
                // Sort tasks
                const sortBy = document.getElementById('taskSort').value;
                
                tasks.sort((a, b) => {
                    switch (sortBy) {
                        case 'dueDate':
                            return new Date(a.dueDate) - new Date(b.dueDate);
                        case 'priority':
                            const priorityOrder = { high: 0, medium: 1, low: 2 };
                            return priorityOrder[a.priority] - priorityOrder[b.priority];
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'created':
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        default:
                            return 0;
                    }
                });
                
                return tasks;
            }
            
            // Filter tasks
            function filterTasks() {
                renderTasks();
            }
            
            // Update task counters
            function updateTaskCounters() {
                const totalTasks = appState.tasks.length;
                const completedTasks = appState.tasks.filter(task => task.completed).length;
                const pendingTasks = totalTasks - completedTasks;
                
                document.getElementById('totalTasksCount').textContent = totalTasks;
                document.getElementById('completedTasksCount').textContent = completedTasks;
                document.getElementById('pendingTasksCount').textContent = pendingTasks;
                
                // Update completion rate
                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                document.getElementById('completionRate').textContent = `${completionRate}%`;
                
                // Update productivity score (simple calculation for demo)
                const productivity = totalTasks > 0 ? Math.min(10, Math.round((completedTasks / totalTasks) * 10)) : 0;
                document.getElementById('productivityScore').textContent = `${productivity}/10`;
                
                // Update overdue tasks count
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const overdueTasks = appState.tasks.filter(task => {
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    return !task.completed && dueDate < today;
                }).length;
                
                document.getElementById('overdueTasksCount').textContent = overdueTasks;
                
                // Update insights charts
                updateInsightsCharts();
            }
            
            // Toggle task complete status
            function toggleTaskComplete(taskId) {
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                // Save state for undo
                saveStateForUndo();
                
                // Toggle completed status
                appState.tasks[taskIndex].completed = !appState.tasks[taskIndex].completed;
                
                // Update completedAt timestamp
                if (appState.tasks[taskIndex].completed) {
                    appState.tasks[taskIndex].completedAt = new Date().toISOString();
                    
                    // Show notification
                    showNotification('Task Completed', `Task "${appState.tasks[taskIndex].title}" marked as complete`, 'success');
                    addNotification('Task Completed', `Task "${appState.tasks[taskIndex].title}" marked as complete`);
                } else {
                    appState.tasks[taskIndex].completedAt = null;
                    
                    // Show notification
                    showNotification('Task Reopened', `Task "${appState.tasks[taskIndex].title}" marked as incomplete`, 'info');
                    addNotification('Task Reopened', `Task "${appState.tasks[taskIndex].title}" marked as incomplete`);
                }
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Update UI
                renderTasks();
                updateTaskCounters();
            }
            
            // Toggle multiple tasks complete status
            function toggleTasksComplete(taskIds, completed) {
                if (!taskIds || taskIds.length === 0) return;
                
                // Save state for undo
                saveStateForUndo();
                
                taskIds.forEach(taskId => {
                    const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        appState.tasks[taskIndex].completed = completed;
                        
                        // Update completedAt timestamp
                        if (completed) {
                            appState.tasks[taskIndex].completedAt = new Date().toISOString();
                        } else {
                            appState.tasks[taskIndex].completedAt = null;
                        }
                    }
                });
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Clear selection
                appState.selectedTasks = [];
                
                // Show notification
                const action = completed ? 'completed' : 'reopened';
                showNotification('Tasks Updated', `${taskIds.length} tasks ${action}`, 'success');
                addNotification('Bulk Action', `${taskIds.length} tasks marked as ${completed ? 'complete' : 'incomplete'}`);
                
                // Update UI
                renderTasks();
                updateTaskCounters();
            }
            
            // Toggle subtask complete status
            function toggleSubtaskComplete(taskId, subtaskId) {
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                const task = appState.tasks[taskIndex];
                const subtaskIndex = task.subtasks.findIndex(s => s.id === subtaskId);
                if (subtaskIndex === -1) return;
                
                // Save state for undo
                saveStateForUndo();
                
                // Toggle completed status
                task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
                
                // Check if all subtasks are completed
                const allSubtasksCompleted = task.subtasks.every(s => s.completed);
                
                // Show notification
                if (task.subtasks[subtaskIndex].completed) {
                    if (allSubtasksCompleted) {
                        showNotification('Subtasks Completed', `All subtasks for "${task.title}" are now complete`, 'success');
                    }
                }
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Update UI
                renderTasks();
            }
            
            // Delete task
            function deleteTask(taskId) {
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                const taskTitle = appState.tasks[taskIndex].title;
                
                // Save state for undo
                saveStateForUndo();
                
                // Remove task
                appState.tasks.splice(taskIndex, 1);
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Show notification
                showNotification('Task Deleted', `Task "${taskTitle}" has been deleted`, 'info');
                addNotification('Task Deleted', `Task "${taskTitle}" was deleted`);
                
                // Update UI
                renderTasks();
                updateTaskCounters();
            }
            
            // Delete multiple tasks
            function deleteTasks(taskIds) {
                if (!taskIds || taskIds.length === 0) return;
                
                // Save state for undo
                saveStateForUndo();
                
                // Remove tasks
                appState.tasks = appState.tasks.filter(task => !taskIds.includes(task.id));
                
                // Save tasks to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Clear selection
                appState.selectedTasks = [];
                
                // Show notification
                showNotification('Tasks Deleted', `${taskIds.length} tasks have been deleted`, 'info');
                addNotification('Bulk Action', `${taskIds.length} tasks were deleted`);
                
                // Update UI
                renderTasks();
                updateTaskCounters();
            }
            
            // Toggle task selection for multi-select
            function toggleTaskSelection(taskId) {
                const index = appState.selectedTasks.indexOf(taskId);
                
                if (index === -1) {
                    appState.selectedTasks.push(taskId);
                } else {
                    appState.selectedTasks.splice(index, 1);
                }
                
                updateTaskSelection();
            }
            
            // Update task selection UI
            function updateTaskSelection() {
                document.querySelectorAll('.task-item').forEach(task => {
                    if (appState.selectedTasks.includes(task.dataset.id)) {
                        task.classList.add('selected');
                    } else {
                        task.classList.remove('selected');
                    }
                });
                
                // Show/hide bulk actions container
                if (appState.selectedTasks.length > 0) {
                    document.getElementById('bulkActionsContainer').classList.remove('hidden');
                } else if (!document.getElementById('enableMultiSelect').checked) {
                    document.getElementById('bulkActionsContainer').classList.add('hidden');
                }
            }
            
            // Toggle task timer
            function toggleTaskTimer(taskId) {
                const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                const task = appState.tasks[taskIndex];
                
                // If timer is running for this task, stop it
                if (appState.taskTimers[taskId]) {
                    clearInterval(appState.taskTimers[taskId].interval);
                    
                    // Calculate elapsed time
                    const startTime = appState.taskTimers[taskId].startTime;
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    
                    // Update task time spent
                    task.timeSpent = (task.timeSpent || 0) + elapsedSeconds;
                    
                    // Remove timer
                    delete appState.taskTimers[taskId];
                    
                    // Save tasks to localStorage
                    localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                    
                    // Show notification
                    showNotification('Timer Stopped', `Timer for "${task.title}" stopped after ${formatTimeSpent(elapsedSeconds)}`, 'info');
                } else {
                    // Start timer for this task
                    const startTime = Date.now();
                    
                    // Create timer
                    const timerInterval = setInterval(() => {
                        if (!document.getElementById(`taskTime-${taskId}`)) {
                            clearInterval(timerInterval);
                            return;
                        }
                        
                        const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                        const totalTime = (task.timeSpent || 0) + elapsedSeconds;
                        
                        document.getElementById(`taskTime-${taskId}`).textContent = formatTimeSpent(totalTime);
                    }, 1000);
                    
                    // Save timer
                    appState.taskTimers[taskId] = {
                        startTime,
                        interval: timerInterval
                    };
                    
                    // Show notification
                    showNotification('Timer Started', `Timer started for "${task.title}"`, 'info');
                }
                
                // Update UI
                renderTasks();
            }
            
            // Share task
            function shareTask(taskId) {
                const task = appState.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                // For demo purposes, show a notification
                showNotification('Task Shared', `Task "${task.title}" has been shared`, 'success');
                addNotification('Task Shared', `You shared task "${task.title}"`);
            }
            
            // Open users modal
            function openUsersModal() {
                const modal = document.getElementById('usersModal');
                const usersContainer = document.getElementById('usersContainer');
                
                // Clear previous users
                usersContainer.innerHTML = '';
                
                // Render users
                appState.users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'card p-4';
                    userCard.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="w-10 h-10 rounded-full bg-cover bg-center mr-3" style="background-image: url(${user.profilePic})"></div>
                            <div>
                                <h3 class="font-medium">${user.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${user.role}</p>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-300">
                            <p><span class="font-medium">Email:</span> ${user.email}</p>
                            <p><span class="font-medium">Phone:</span> ${user.phone}</p>
                            <p><span class="font-medium">Country:</span> ${getCountryName(user.country)}</p>
                        </div>
                    `;
                    
                    usersContainer.appendChild(userCard);
                });
                
                // Show modal
                modal.style.display = 'block';
                
                // Initialize search
                document.getElementById('searchUsers').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    document.querySelectorAll('#usersContainer > div').forEach(userCard => {
                        const userName = userCard.querySelector('h3').textContent.toLowerCase();
                        const userRole = userCard.querySelector('p').textContent.toLowerCase();
                        const userEmail = userCard.querySelector('div > p:nth-child(1)').textContent.toLowerCase();
                        
                        if (userName.includes(searchTerm) || userRole.includes(searchTerm) || userEmail.includes(searchTerm)) {
                            userCard.style.display = 'block';
                        } else {
                            userCard.style.display = 'none';
                        }
                    });
                });
            }
            
            // Get country name from code
            function getCountryName(code) {
                const countries = {
                    'US': 'United States',
                    'GB': 'United Kingdom',
                    'CA': 'Canada',
                    'AU': 'Australia',
                    'DE': 'Germany',
                    'FR': 'France',
                    'JP': 'Japan',
                    'CN': 'China',
                    'IN': 'India',
                    'BR': 'Brazil',
                    'MX': 'Mexico',
                    'IT': 'Italy',
                    'ES': 'Spain',
                    'KR': 'South Korea',
                    'RU': 'Russia',
                    'ZA': 'South Africa',
                    'SA': 'Saudi Arabia',
                    'AE': 'United Arab Emirates',
                    'SG': 'Singapore',
                    'NZ': 'New Zealand'
                };
                
                return countries[code] || code;
            }
            
            // Open import modal
            function openImportModal() {
                const modal = document.getElementById('importModal');
                modal.style.display = 'block';
                
                // Reset file input
                document.getElementById('importFile').value = '';
                document.getElementById('importFileName').textContent = 'No file selected';
                document.getElementById('importTasksBtn').disabled = true;
            }
            
            // Import tasks
            function importTasks() {
                const fileInput = document.getElementById('importFile');
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    showNotification('Error', 'Please select a file to import', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                
                // Check file type
                if (file.type !== 'application/json') {
                    showNotification('Error', 'Please select a JSON file', 'error');
                    return;
                }
                
                // Read file
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedTasks = JSON.parse(e.target.result);
                        
                        // Validate imported tasks
                        if (!Array.isArray(importedTasks)) {
                            throw new Error('Invalid task data format');
                        }
                        
                        // Save state for undo
                        saveStateForUndo();
                        
                        // Add imported tasks
                        importedTasks.forEach(task => {
                            // Generate new ID to avoid conflicts
                            task.id = generateId();
                            
                            // Ensure subtasks have IDs
                            if (task.subtasks) {
                                task.subtasks.forEach(subtask => {
                                    subtask.id = subtask.id || generateId();
                                });
                            }
                            
                            appState.tasks.push(task);
                        });
                        
                        // Save tasks to localStorage
                        localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                        
                        // Show notification
                        showNotification('Import Successful', `${importedTasks.length} tasks imported successfully`, 'success');
                        addNotification('Tasks Imported', `${importedTasks.length} tasks were imported`);
                        
                        // Update UI
                        renderTasks();
                        updateTaskCounters();
                        
                        // Close modal
                        closeAllModals();
                    } catch (error) {
                        showNotification('Error', 'Invalid JSON file format', 'error');
                    }
                };
                
                reader.readAsText(file);
            }
            
            // Open export modal
            function openExportModal() {
                const modal = document.getElementById('exportModal');
                modal.style.display = 'block';
            }
            
            // Export tasks
            function exportTasks(format) {
                // For this demo, we'll only implement JSON export
                // Other formats would require server-side processing in a real app
                
                if (format === 'json') {
                    // Convert tasks to JSON
                    const tasksJson = JSON.stringify(appState.tasks, null, 2);
                    
                    // Create data URL
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(tasksJson);
                    
                    // Create fake anchor for "download"
                    const fakeLink = document.createElement('a');
                    fakeLink.setAttribute("href", dataStr);
                    fakeLink.setAttribute("download", "tasks.json");
                    
                    // Simply show instructions in browser environment
                    showNotification('Export Ready', 'In a browser, you would now download the tasks.json file', 'info');
                    addNotification('Tasks Exported', 'Tasks exported as JSON');
                } else {
                    // For other formats, show a notification
                    showNotification('Export', `Tasks would be exported as ${format.toUpperCase()}`, 'info');
                    addNotification('Tasks Exported', `Tasks exported as ${format.toUpperCase()}`);
                }
                
                // Close modal
                closeAllModals();
            }
            
            // Close all modals
            function closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Initialize timers
            function initTimers() {
                // Initialize work timer
                updateWorkTimer();
                setInterval(updateWorkTimer, 1000);
                
                // Check for daily reset periodically
                setInterval(checkDailyReset, 60000); // Check every minute
            }
            
            // Start work timer
            function startWorkTimer() {
                if (!appState.workTimer.startTime) {
                    appState.workTimer.startTime = new Date().toISOString();
                }
                
                appState.workTimer.status = 'running';
                appState.workTimer.statusStartTime = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('workTimer', JSON.stringify(appState.workTimer));
            }
            
            // Stop work timer
            function stopWorkTimer() {
                if (appState.workTimer.status === 'running' && appState.workTimer.statusStartTime) {
                    const now = new Date().getTime();
                    const statusStartTime = new Date(appState.workTimer.statusStartTime).getTime();
                    const elapsedSinceLastStart = Math.floor((now - statusStartTime) / 1000);
                    
                    appState.workTimer.elapsedTime += elapsedSinceLastStart;
                }
                
                appState.workTimer.status = 'stopped';
                
                // Save to localStorage
                localStorage.setItem('workTimer', JSON.stringify(appState.workTimer));
            }
            
            // Update work timer status when user status changes
            function updateWorkTimerStatus(status) {
                if (!appState.workTimer) return;
                
                // If timer was running, add elapsed time
                if (appState.workTimer.status === 'running' && appState.workTimer.statusStartTime) {
                    const now = new Date().getTime();
                    const statusStartTime = new Date(appState.workTimer.statusStartTime).getTime();
                    const elapsedSinceLastStart = Math.floor((now - statusStartTime) / 1000);
                    
                    appState.workTimer.elapsedTime += elapsedSinceLastStart;
                }
                
                if (status === 'login') {
                    appState.workTimer.status = 'running';
                } else {
                    appState.workTimer.status = status;
                }
                
                appState.workTimer.statusStartTime = new Date().toISOString();
                
                // Save to localStorage
                localStorage.setItem('workTimer', JSON.stringify(appState.workTimer));
            }
            
            // Update work timer display
            function updateWorkTimer() {
                if (!appState.workTimer) return;
                
                let seconds = appState.workTimer.elapsedTime;
                
                // Add current session time if timer is running
                if (appState.workTimer.status === 'running' && appState.workTimer.statusStartTime) {
                    const now = new Date().getTime();
                    const statusStartTime = new Date(appState.workTimer.statusStartTime).getTime();
                    const elapsedSinceLastStart = Math.floor((now - statusStartTime) / 1000);
                    
                    seconds += elapsedSinceLastStart;
                }
                
                // Update display
                document.getElementById('workTimer').textContent = formatTimeSpent(seconds);
            }
            
            // Check for daily timer reset
            function checkDailyReset() {
                if (!appState.workTimer) return;
                
                const now = new Date();
                const lastResetDate = localStorage.getItem('lastTimerReset');
                
                // Get current date in UTC
                const nowUTC = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
                
                if (!lastResetDate) {
                    // First time, just save current date
                    localStorage.setItem('lastTimerReset', nowUTC.toString());
                    return;
                }
                
                // Check if date has changed
                if (parseInt(lastResetDate) < nowUTC) {
                    // Reset timer
                    appState.workTimer.elapsedTime = 0;
                    
                    if (appState.workTimer.status === 'running') {
                        appState.workTimer.statusStartTime = new Date().toISOString();
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('workTimer', JSON.stringify(appState.workTimer));
                    localStorage.setItem('lastTimerReset', nowUTC.toString());
                    
                    // Show notification
                    showNotification('Timer Reset', 'Daily timer has been reset', 'info');
                    addNotification('Daily Reset', 'Work timer has been reset for the new day');
                }
            }
            
            // Check task due dates for notifications
            function checkTaskDueDate(task) {
                if (!task || task.completed) return;
                
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const diffTime = dueDate - now;
                const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
                
                if (diffHours <= 48 && diffHours > 0) {
                    showNotification('Task Due Soon', `Task "${task.title}" is due in ${diffHours} hours`, 'warning');
                    addNotification('Due Soon', `Task "${task.title}" is due in ${diffHours} hours`);
                } else if (diffHours <= 0) {
                    showNotification('Task Overdue', `Task "${task.title}" is overdue`, 'error');
                    addNotification('Overdue', `Task "${task.title}" is now overdue`);
                }
            }
            
            // Initialize charts for graph view
            function initCharts() {
                // Get chart contexts
                const statusChartCtx = document.getElementById('taskStatusChart').getContext('2d');
                const priorityChartCtx = document.getElementById('taskPriorityChart').getContext('2d');
                const timelineChartCtx = document.getElementById('taskTimelineChart').getContext('2d');
                const productivityChartCtx = document.getElementById('productivityChart').getContext('2d');
                
                // Prepare data for status chart
                const completedCount = appState.tasks.filter(task => task.completed).length;
                const pendingCount = appState.tasks.length - completedCount;
                
                // Prepare data for priority chart
                const highPriorityCount = appState.tasks.filter(task => task.priority === 'high').length;
                const mediumPriorityCount = appState.tasks.filter(task => task.priority === 'medium').length;
                const lowPriorityCount = appState.tasks.filter(task => task.priority === 'low').length;
                
                // Destroy existing charts if they exist
                if (window.taskStatusChart) window.taskStatusChart.destroy();
                if (window.taskPriorityChart) window.taskPriorityChart.destroy();
                if (window.taskTimelineChart) window.taskTimelineChart.destroy();
                if (window.productivityChart) window.productivityChart.destroy();
                
                // Create status chart
                window.taskStatusChart = new Chart(statusChartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completedCount, pendingCount],
                            backgroundColor: ['#10B981', '#F59E0B'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
                
                // Create priority chart
                window.taskPriorityChart = new Chart(priorityChartCtx, {
                    type: 'bar',
                    data: {
                        labels: ['High', 'Medium', 'Low'],
                        datasets: [{
                            label: 'Tasks by Priority',
                            data: [highPriorityCount, mediumPriorityCount, lowPriorityCount],
                            backgroundColor: ['#EF4444', '#F59E0B', '#6B7280'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
                
                // Prepare data for timeline chart
                const last7Days = [];
                const completedByDay = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    
                    last7Days.push(date.toLocaleDateString(undefined, { weekday: 'short' }));
                    
                    // Count tasks completed on this day
                    const completedOnDay = appState.tasks.filter(task => {
                        if (!task.completedAt) return false;
                        
                        const completedDate = new Date(task.completedAt);
                        completedDate.setHours(0, 0, 0, 0);
                        
                        return completedDate.getTime() === date.getTime();
                    }).length;
                    
                    completedByDay.push(completedOnDay);
                }
                
                // Create timeline chart
                window.taskTimelineChart = new Chart(timelineChartCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Tasks Completed',
                            data: completedByDay,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3B82F6',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
                
                // Create productivity trend chart
                window.productivityChart = new Chart(productivityChartCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Productivity Score',
                            data: completedByDay.map(count => Math.min(10, count * 2)), // Simple calculation for demo
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10B981',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            x: {
                                ticks: {
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
            }
            
            // Update insights charts
            function updateInsightsCharts() {
                // Only update if we're currently viewing the graph view
                if (!document.getElementById('graphView').classList.contains('hidden')) {
                    initCharts();
                }
            }
            
            // Save app state for undo
            function saveStateForUndo() {
                // Add current state to undo stack
                appState.undoStack.push(JSON.stringify(appState.tasks));
                
                // Clear redo stack
                appState.redoStack = [];
                
                // Enable/disable undo/redo buttons
                updateUndoRedoButtons();
                
                // Limit undo stack size
                if (appState.undoStack.length > 20) {
                    appState.undoStack.shift();
                }
            }
            
            // Handle undo
            function handleUndo() {
                if (appState.undoStack.length === 0) return;
                
                // Save current state to redo stack
                appState.redoStack.push(JSON.stringify(appState.tasks));
                
                // Restore previous state
                const previousState = appState.undoStack.pop();
                appState.tasks = JSON.parse(previousState);
                
                // Save to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Enable/disable undo/redo buttons
                updateUndoRedoButtons();
                
                // Show notification
                showNotification('Undo', 'Previous action undone', 'info');
            }
            
            // Handle redo
            function handleRedo() {
                if (appState.redoStack.length === 0) return;
                
                // Save current state to undo stack
                appState.undoStack.push(JSON.stringify(appState.tasks));
                
                // Restore next state
                const nextState = appState.redoStack.pop();
                appState.tasks = JSON.parse(nextState);
                
                // Save to localStorage
                localStorage.setItem('tasks', JSON.stringify(appState.tasks));
                
                // Update UI
                renderTasks();
                updateTaskCounters();
                
                // Enable/disable undo/redo buttons
                updateUndoRedoButtons();
                
                // Show notification
                showNotification('Redo', 'Action redone', 'info');
            }
            
            // Update undo/redo buttons
            function updateUndoRedoButtons() {
                const undoBtn = document.getElementById('undoBtn');
                const redoBtn = document.getElementById('redoBtn');
                
                if (appState.undoStack.length === 0) {
                    undoBtn.disabled = true;
                    undoBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    undoBtn.disabled = false;
                    undoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                if (appState.redoStack.length === 0) {
                    redoBtn.disabled = true;
                    redoBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    redoBtn.disabled = false;
                    redoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // Utility function to generate a unique ID
            function generateId() {
                return Math.random().toString(36).substr(2, 9);
            }
            
            // Utility function to format date for display
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString();
            }
            
            // Utility function to format date for input
            function formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }
            
            // Utility function to format time spent
            function formatTimeSpent(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            
            // Utility function to get priority border class
            function getPriorityBorderClass(priority) {
                switch (priority) {
                    case 'high':
                        return 'border-l-4 border-red-500';
                    case 'medium':
                        return 'border-l-4 border-yellow-500';
                    case 'low':
                        return 'border-l-4 border-gray-500';
                    default:
                        return 'border-l-4 border-gray-300';
                }
            }
            
            // Utility function to get priority text class
            function getPriorityTextClass(priority) {
                switch (priority) {
                    case 'high':
                        return 'text-red-600 dark:text-red-400';
                    case 'medium':
                        return 'text-yellow-600 dark:text-yellow-400';
                    case 'low':
                        return 'text-gray-600 dark:text-gray-400';
                    default:
                        return '';
                }
            }
            
            // Utility function to capitalize first letter
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        });
    </script>
</body>
</html>
