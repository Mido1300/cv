<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --high-priority: #ef4444;
            --medium-priority: #f59e0b;
            --low-priority: #9ca3af;
            --completed-color: #10b981;
            --login-color: #10b981;
            --shadow-color: #9ca3af;
            --break-color: #f59e0b;
            --logout-color: #ef4444;
        }
        
        .dark {
            --bg-color: #181818;
            --text-color: #f3f4f6;
            --card-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --border-color: #4b5563;
        }
        
        :root:not(.dark) {
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --card-bg: #f9fafb;
            --input-bg: #ffffff;
            --border-color: #e5e7eb;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        input, select, textarea {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .status-green { border-color: var(--login-color); }
        .status-grey { border-color: var(--shadow-color); }
        .status-yellow { border-color: var(--break-color); }
        .status-red { border-color: var(--logout-color); }
        
        .timer-green { color: var(--login-color); }
        .timer-grey { color: var(--shadow-color); }
        .timer-yellow { color: var(--break-color); }
        .timer-red { color: var(--logout-color); }
        
        .priority-high { background-color: var(--high-priority); }
        .priority-medium { background-color: var(--medium-priority); }
        .priority-low { background-color: var(--shadow-color); }
        
        .due-expired { color: var(--high-priority); }
        .due-soon { color: var(--medium-priority); }
        .due-future { color: var(--completed-color); }
        
        .completed-task { 
            text-decoration: line-through; 
            color: var(--completed-color);
        }
        
        .modal {
            background-color: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Ensure mobile-friendly inputs */
        input, select, textarea, button {
            font-size: 16px;
        }
        
        /* Drag and drop styles */
        .task-dragging {
            opacity: 0.5;
        }
        
        /* Transition effects */
        .fade-enter {
            opacity: 0;
        }
        .fade-enter-active {
            opacity: 1;
            transition: opacity 0.3s;
        }
        .fade-exit {
            opacity: 1;
        }
        .fade-exit-active {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Custom toggle switch for dark mode */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 28px;
            transition: .3s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .3s;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        /* Add task animation */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .new-task {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="relative">
    <!-- Login/Register Page -->
    <div id="auth-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-6 rounded-lg shadow-lg">
            <div class="tabs flex mb-6">
                <button id="login-tab" class="flex-1 py-2 font-medium text-center border-b-2 border-primary-500 text-primary-600">Login</button>
                <button id="register-tab" class="flex-1 py-2 font-medium text-center border-b-2 border-gray-200 text-gray-500">Register</button>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block mb-1 font-medium">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="login-password" class="block mb-1 font-medium">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 rounded-lg" required>
                </div>
                <button type="submit" class="w-full py-3 px-4 bg-primary-600 text-white rounded-lg font-medium" style="background-color: var(--primary-color);">Login</button>
                
                <!-- Demo login button -->
                <button type="button" id="demo-login" class="w-full py-3 px-4 bg-gray-600 text-white rounded-lg font-medium">Try Demo</button>
            </form>
            
            <!-- Registration Form -->
            <form id="register-form" class="space-y-4 hidden">
                <div>
                    <label for="register-name" class="block mb-1 font-medium">Name</label>
                    <input type="text" id="register-name" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-email" class="block mb-1 font-medium">Email</label>
                    <input type="email" id="register-email" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-confirm-email" class="block mb-1 font-medium">Confirm Email</label>
                    <input type="email" id="register-confirm-email" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-password" class="block mb-1 font-medium">Password</label>
                    <input type="password" id="register-password" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-confirm-password" class="block mb-1 font-medium">Confirm Password</label>
                    <input type="password" id="register-confirm-password" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-phone" class="block mb-1 font-medium">Phone Number</label>
                    <input type="tel" id="register-phone" class="w-full p-3 rounded-lg" required>
                </div>
                <div>
                    <label for="register-country" class="block mb-1 font-medium">Country</label>
                    <select id="register-country" class="w-full p-3 rounded-lg" required>
                        <option value="">Select Country</option>
                        <!-- Countries will be populated by JavaScript -->
                    </select>
                </div>
                <div>
                    <label for="register-role" class="block mb-1 font-medium">Role</label>
                    <select id="register-role" class="w-full p-3 rounded-lg" required>
                        <option value="">Select Role</option>
                        <option value="Manager">Manager</option>
                        <option value="Admin">Admin</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                    </select>
                </div>
                <button type="submit" class="w-full py-3 px-4 rounded-lg font-medium text-white" style="background-color: var(--primary-color);">Register</button>
            </form>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="hidden flex flex-col min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 shadow-md p-3">
            <div class="container mx-auto flex items-center justify-between">
                <!-- Logo and App Name (Left) -->
                <div class="flex items-center">
                    <div class="text-primary-600 text-2xl mr-2" style="color: var(--primary-color);">
                        <i class="fas fa-check-double"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold">To-Do App</h1>
                </div>
                
                <!-- Mobile Menu Toggle -->
                <button id="mobile-menu-toggle" class="md:hidden p-2 rounded-md">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                
                <!-- Right Side Options (Desktop) -->
                <div id="header-menu" class="hidden md:flex items-center space-x-4">
                    <!-- Working Hours Timer -->
                    <div class="timer-container border-r pr-4 mr-1">
                        <div id="work-timer" class="text-sm timer-green">00:00:00</div>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    
                    <!-- Notification Icon -->
                    <div class="relative">
                        <button id="notification-btn" class="p-2 relative">
                            <i class="fas fa-bell text-lg"></i>
                            <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center">3</span>
                        </button>
                        
                        <!-- Notification Dropdown (Hidden by default) -->
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-72 card rounded-lg shadow-lg p-2 z-20">
                            <h3 class="font-medium p-2 border-b">Notifications</h3>
                            <div id="notification-list" class="max-h-60 overflow-y-auto">
                                <div class="p-2 border-b cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <p class="text-sm">Task "Project Presentation" is due in 1 hour</p>
                                    <span class="text-xs text-gray-500">Just now</span>
                                </div>
                                <div class="p-2 border-b cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <p class="text-sm">John assigned you a new task</p>
                                    <span class="text-xs text-gray-500">2 hours ago</span>
                                </div>
                                <div class="p-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <p class="text-sm">You completed 5 tasks today!</p>
                                    <span class="text-xs text-gray-500">5 hours ago</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile Picture with Status -->
                    <div class="relative">
                        <button id="profile-btn" class="relative">
                            <img id="profile-picture" src="" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 status-green">
                        </button>
                        
                        <!-- Profile Dropdown (Hidden by default) -->
                        <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 card rounded-lg shadow-lg z-20">
                            <div class="p-2 border-b">
                                <p id="profile-name" class="font-medium"></p>
                                <p id="profile-role" class="text-sm text-gray-500"></p>
                            </div>
                            <div class="p-2">
                                <p class="font-medium mb-1">Status</p>
                                <div class="space-y-1">
                                    <button class="status-btn w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="login">
                                        <i class="fas fa-circle text-green-500 mr-2"></i> Login
                                    </button>
                                    <button class="status-btn w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="shadow">
                                        <i class="fas fa-circle text-gray-500 mr-2"></i> Shadow
                                    </button>
                                    <button class="status-btn w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="break">
                                        <i class="fas fa-circle text-yellow-500 mr-2"></i> Break
                                    </button>
                                    <button class="status-btn w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="logout">
                                        <i class="fas fa-circle text-red-500 mr-2"></i> Logout
                                    </button>
                                </div>
                            </div>
                            <div class="p-2 border-t">
                                <button id="view-profile-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-user mr-2"></i> View Profile
                                </button>
                                <button id="logout-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu (Hidden by default) -->
            <div id="mobile-menu" class="hidden mt-3 md:hidden">
                <div class="flex items-center justify-between p-2 border-b">
                    <div id="mobile-work-timer" class="text-sm timer-green">00:00:00</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mobile-dark-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="p-2 border-b">
                    <button id="mobile-notification-btn" class="flex items-center w-full p-2">
                        <i class="fas fa-bell mr-2"></i>
                        <span>Notifications</span>
                        <span id="mobile-notification-count" class="ml-auto bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center">3</span>
                    </button>
                </div>
                <div class="p-2 border-b">
                    <p class="font-medium mb-1">Status</p>
                    <div class="space-y-1">
                        <button class="mobile-status-btn w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="login">
                            <i class="fas fa-circle text-green-500 mr-2"></i> Login
                        </button>
                        <button class="mobile-status-btn w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="shadow">
                            <i class="fas fa-circle text-gray-500 mr-2"></i> Shadow
                        </button>
                        <button class="mobile-status-btn w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="break">
                            <i class="fas fa-circle text-yellow-500 mr-2"></i> Break
                        </button>
                        <button class="mobile-status-btn w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700" data-status="logout">
                            <i class="fas fa-circle text-red-500 mr-2"></i> Logout
                        </button>
                    </div>
                </div>
                <div class="p-2">
                    <button id="mobile-view-profile-btn" class="w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-user mr-2"></i> View Profile
                    </button>
                    <button id="mobile-logout-btn" class="w-full text-left text-sm p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-6 flex-grow">
            <div class="lg:flex gap-6">
                <!-- Main Content Area -->
                <div class="lg:w-3/4">
                    <!-- Task Overview Section -->
                    <section class="mb-8">
                        <div class="card rounded-lg p-4 mb-4">
                            <h2 class="text-xl font-bold mb-2">Total Tasks</h2>
                            <div class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-4 py-2 rounded-md">
                                <p id="total-task-count" class="text-lg font-medium">0 Tasks</p>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="card rounded-lg p-4">
                                <h2 class="text-lg font-bold mb-2">Completed Tasks</h2>
                                <div class="bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-4 py-2 rounded-md">
                                    <p id="completed-task-count" class="text-lg font-medium">0 Tasks</p>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg p-4">
                                <h2 class="text-lg font-bold mb-2">Pending Tasks</h2>
                                <div class="bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-4 py-2 rounded-md">
                                    <p id="pending-task-count" class="text-lg font-medium">0 Tasks</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Tasks Section -->
                    <section>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Tasks</h2>
                            <div class="flex items-center">
                                <button id="list-view-btn" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-l-md active">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button id="graph-view-btn" class="p-2 bg-gray-100 dark:bg-gray-600 rounded-r-md">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Task Filtering Section -->
                        <div class="card rounded-lg p-4 mb-6">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <div class="flex-grow">
                                    <input type="text" id="task-search" placeholder="Search tasks..." class="w-full p-2 rounded-md">
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <button id="filter-toggle-btn" class="p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                        <i class="fas fa-filter"></i>
                                    </button>
                                    
                                    <button id="sort-btn" class="p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                        <i class="fas fa-sort"></i>
                                    </button>
                                    
                                    <div class="relative">
                                        <button id="bulk-actions-btn" class="p-2 rounded-md bg-gray-100 dark:bg-gray-700">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        
                                        <!-- Bulk Actions Dropdown -->
                                        <div id="bulk-actions-dropdown" class="hidden absolute right-0 mt-2 w-48 card rounded-lg shadow-lg z-20">
                                            <div class="p-2">
                                                <button id="select-all-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-check-square mr-2"></i> Select All
                                                </button>
                                                <button id="deselect-all-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-square mr-2"></i> Deselect All
                                                </button>
                                                <button id="complete-selected-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-check mr-2"></i> Complete Selected
                                                </button>
                                                <button id="delete-selected-btn" class="w-full text-left text-sm p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-trash mr-2"></i> Delete Selected
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Advanced Filtering (Hidden by default) -->
                            <div id="advanced-filters" class="hidden pt-4 border-t">
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Priority</label>
                                        <select id="filter-priority" class="w-full p-2 rounded-md">
                                            <option value="all">All Priorities</option>
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Status</label>
                                        <select id="filter-status" class="w-full p-2 rounded-md">
                                            <option value="all">All Tasks</option>
                                            <option value="active">Active</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Due Date</label>
                                        <select id="filter-due-date" class="w-full p-2 rounded-md">
                                            <option value="all">All Dates</option>
                                            <option value="today">Today</option>
                                            <option value="week">This Week</option>
                                            <option value="month">This Month</option>
                                            <option value="custom">Custom Range</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Category</label>
                                        <select id="filter-category" class="w-full p-2 rounded-md">
                                            <option value="all">All Categories</option>
                                            <option value="work">Work</option>
                                            <option value="personal">Personal</option>
                                            <option value="shopping">Shopping</option>
                                            <option value="health">Health</option>
                                            <option value="finance">Finance</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Custom Date Range (Hidden by default) -->
                                <div id="custom-date-range" class="hidden mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">From</label>
                                        <input type="date" id="filter-date-from" class="w-full p-2 rounded-md">
                                    </div>
                                    
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">To</label>
                                        <input type="date" id="filter-date-to" class="w-full p-2 rounded-md">
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex justify-end space-x-2">
                                    <button id="reset-filters-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Reset</button>
                                    <button id="apply-filters-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Apply Filters</button>
                                </div>
                            </div>
                            
                            <!-- Sort Options (Hidden by default) -->
                            <div id="sort-options" class="hidden pt-4 border-t">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Sort By</label>
                                        <select id="sort-by" class="w-full p-2 rounded-md">
                                            <option value="date-created">Date Created</option>
                                            <option value="due-date">Due Date</option>
                                            <option value="priority">Priority</option>
                                            <option value="title">Title</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block mb-1 text-sm font-medium">Order</label>
                                        <select id="sort-order" class="w-full p-2 rounded-md">
                                            <option value="asc">Ascending</option>
                                            <option value="desc">Descending</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex justify-end">
                                    <button id="apply-sort-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Apply Sort</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Undo/Redo Buttons -->
                        <div class="flex mb-4 space-x-2">
                            <button id="undo-btn" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md" disabled>
                                <i class="fas fa-undo"></i>
                            </button>
                            <button id="redo-btn" class="p-2 bg-gray-200 dark:bg-gray-700 rounded-md" disabled>
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <!-- List View (default) -->
                        <div id="list-view" class="space-y-4">
                            <div class="task-container" id="task-list">
                                <!-- Tasks will be inserted here by JavaScript -->
                                <div class="text-center p-8 text-gray-500">
                                    <i class="fas fa-tasks text-4xl mb-4"></i>
                                    <p>No tasks found. Add a task to get started!</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Graph View (hidden by default) -->
                        <div id="graph-view" class="hidden">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="card rounded-lg p-4">
                                    <h3 class="text-lg font-bold mb-4">Task Status</h3>
                                    <div class="w-full aspect-square">
                                        <canvas id="status-chart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="card rounded-lg p-4">
                                    <h3 class="text-lg font-bold mb-4">Task Priority</h3>
                                    <div class="w-full aspect-square">
                                        <canvas id="priority-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card rounded-lg p-4 mt-6">
                                <h3 class="text-lg font-bold mb-4">Weekly Completion Trend</h3>
                                <div class="w-full h-64">
                                    <canvas id="trend-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Insights Section -->
                    <section class="mt-8">
                        <h2 class="text-2xl font-bold mb-4">Insights</h2>
                        
                        <div class="card rounded-lg p-4">
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="p-4 border rounded-lg">
                                    <h3 class="text-lg font-bold mb-2">Productivity Score</h3>
                                    <div class="flex items-end">
                                        <span id="productivity-score" class="text-4xl font-bold" style="color: var(--primary-color);">0%</span>
                                        <span id="productivity-trend" class="ml-2 text-green-500"><i class="fas fa-arrow-up"></i> 0%</span>
                                    </div>
                                    <p class="text-sm mt-2 text-gray-500">Based on tasks completed on time</p>
                                </div>
                                
                                <div class="p-4 border rounded-lg">
                                    <h3 class="text-lg font-bold mb-2">Focus Areas</h3>
                                    <ul id="focus-areas" class="space-y-2">
                                        <li class="flex justify-between">
                                            <span>Work</span>
                                            <span class="font-bold">0%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>Personal</span>
                                            <span class="font-bold">0%</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>Other</span>
                                            <span class="font-bold">0%</span>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div class="p-4 border rounded-lg">
                                    <h3 class="text-lg font-bold mb-2">Time Analytics</h3>
                                    <ul class="space-y-2">
                                        <li class="flex justify-between">
                                            <span>Avg. Completion Time</span>
                                            <span id="avg-completion-time" class="font-bold">0h</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>Most Productive Day</span>
                                            <span id="productive-day" class="font-bold">-</span>
                                        </li>
                                        <li class="flex justify-between">
                                            <span>Tasks Per Day</span>
                                            <span id="tasks-per-day" class="font-bold">0</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- Sidebar (Right) -->
                <div class="lg:w-1/4 mt-8 lg:mt-0">
                    <div class="card rounded-lg p-4">
                        <div class="space-y-4">
                            <button id="add-task-btn" class="w-full flex items-center justify-center space-x-2 p-3 text-white rounded-md" style="background-color: var(--primary-color);">
                                <i class="fas fa-plus"></i>
                                <span>Add Task</span>
                            </button>
                            
                            <button id="import-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-gray-200 dark:bg-gray-700 rounded-md">
                                <i class="fas fa-upload"></i>
                                <span>Import</span>
                            </button>
                            
                            <button id="export-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-gray-200 dark:bg-gray-700 rounded-md">
                                <i class="fas fa-download"></i>
                                <span>Export</span>
                            </button>
                            
                            <button id="users-btn" class="w-full flex items-center justify-center space-x-2 p-3 bg-gray-200 dark:bg-gray-700 rounded-md">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Task Categories Card -->
                    <div class="card rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-bold mb-4">Task Categories</h3>
                        
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-2 bg-blue-100 dark:bg-blue-900 rounded-md">
                                <span>Work</span>
                                <span id="work-count" class="font-bold">0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-green-100 dark:bg-green-900 rounded-md">
                                <span>Personal</span>
                                <span id="personal-count" class="font-bold">0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-yellow-100 dark:bg-yellow-900 rounded-md">
                                <span>Shopping</span>
                                <span id="shopping-count" class="font-bold">0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-red-100 dark:bg-red-900 rounded-md">
                                <span>Health</span>
                                <span id="health-count" class="font-bold">0</span>
                            </div>
                            
                            <div class="flex justify-between items-center p-2 bg-purple-100 dark:bg-purple-900 rounded-md">
                                <span>Finance</span>
                                <span id="finance-count" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Deadlines -->
                    <div class="card rounded-lg p-4 mt-6">
                        <h3 class="text-lg font-bold mb-4">Upcoming Deadlines</h3>
                        
                        <div id="upcoming-deadlines" class="space-y-2">
                            <!-- Will be populated by JavaScript -->
                            <p class="text-gray-500 text-center p-2">No upcoming deadlines</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 id="task-modal-title" class="text-xl font-bold">Add New Task</h3>
                    <button id="close-task-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <form id="task-form" class="space-y-4">
                    <input type="hidden" id="task-id">
                    
                    <div>
                        <label for="task-title" class="block mb-1 font-medium">Title <span class="text-red-500">*</span></label>
                        <input type="text" id="task-title" class="w-full p-3 rounded-lg" required>
                    </div>
                    
                    <div>
                        <label for="task-description" class="block mb-1 font-medium">Description</label>
                        <textarea id="task-description" class="w-full p-3 rounded-lg" rows="3"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="task-priority" class="block mb-1 font-medium">Priority</label>
                            <select id="task-priority" class="w-full p-3 rounded-lg">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="task-due-date" class="block mb-1 font-medium">Due Date</label>
                            <input type="datetime-local" id="task-due-date" class="w-full p-3 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="task-category" class="block mb-1 font-medium">Category</label>
                            <select id="task-category" class="w-full p-3 rounded-lg">
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="shopping">Shopping</option>
                                <option value="health">Health</option>
                                <option value="finance">Finance</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="task-assign" class="block mb-1 font-medium">Assign To</label>
                            <select id="task-assign" class="w-full p-3 rounded-lg">
                                <option value="">Select User</option>
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block mb-1 font-medium">Subtasks</label>
                        <div id="subtasks-container" class="space-y-2">
                            <!-- Subtasks will be added here -->
                        </div>
                        
                        <button id="add-subtask-btn" type="button" class="mt-2 px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md text-sm">
                            <i class="fas fa-plus mr-1"></i> Add Subtask
                        </button>
                    </div>
                    
                    <div>
                        <label for="task-notes" class="block mb-1 font-medium">Notes</label>
                        <textarea id="task-notes" class="w-full p-3 rounded-lg" rows="2"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="p-4 border-t flex justify-end space-x-2">
                <button id="cancel-task-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Cancel</button>
                <button id="save-task-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Task</button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-lg">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">User Profile</h3>
                    <button id="close-profile-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <div class="flex flex-col md:flex-row items-center mb-6">
                    <div class="relative mb-4 md:mb-0 md:mr-6">
                        <img id="profile-pic-preview" src="" alt="Profile" class="w-24 h-24 rounded-full object-cover border-2">
                        <label for="profile-pic-upload" class="absolute bottom-0 right-0 bg-gray-200 dark:bg-gray-700 rounded-full p-1 cursor-pointer">
                            <i class="fas fa-camera"></i>
                            <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                        </label>
                    </div>
                    
                    <div class="text-center md:text-left">
                        <h4 id="profile-modal-name" class="text-xl font-bold">John Doe</h4>
                        <p id="profile-modal-role" class="text-gray-500">Admin</p>
                    </div>
                </div>
                
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label for="profile-name" class="block mb-1 font-medium">Name</label>
                        <input type="text" id="profile-name" class="w-full p-3 rounded-lg">
                    </div>
                    
                    <div>
                        <label for="profile-email" class="block mb-1 font-medium">Email</label>
                        <input type="email" id="profile-email" class="w-full p-3 rounded-lg">
                    </div>
                    
                    <div>
                        <label for="profile-phone" class="block mb-1 font-medium">Phone</label>
                        <input type="tel" id="profile-phone" class="w-full p-3 rounded-lg">
                    </div>
                    
                    <div>
                        <label for="profile-password" class="block mb-1 font-medium">Password</label>
                        <input type="password" id="profile-password" class="w-full p-3 rounded-lg" placeholder="••••••••">
                    </div>
                    
                    <div>
                        <label for="profile-country" class="block mb-1 font-medium">Country</label>
                        <select id="profile-country" class="w-full p-3 rounded-lg">
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div>
                        <label for="profile-role" class="block mb-1 font-medium">Role</label>
                        <select id="profile-role" class="w-full p-3 rounded-lg" disabled>
                            <option value="Manager">Manager</option>
                            <option value="Admin">Admin</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                        </select>
                    </div>
                </form>
            </div>
            
            <div class="p-4 border-t flex justify-end space-x-2">
                <button id="cancel-profile-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Cancel</button>
                <button id="save-profile-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-md">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Export Tasks</h3>
                    <button id="close-export-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <p class="mb-4">Select format to export your tasks:</p>
                
                <div class="space-y-2">
                    <button data-format="json" class="export-format-btn w-full text-left p-3 border rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-file-code mr-3 text-blue-500"></i>
                        <div>
                            <p class="font-medium">JSON</p>
                            <p class="text-sm text-gray-500">Raw data format</p>
                        </div>
                    </button>
                    
                    <button data-format="text" class="export-format-btn w-full text-left p-3 border rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-file-alt mr-3 text-green-500"></i>
                        <div>
                            <p class="font-medium">Plain Text</p>
                            <p class="text-sm text-gray-500">Simple text format</p>
                        </div>
                    </button>
                    
                    <button data-format="display" class="export-format-btn w-full text-left p-3 border rounded-lg flex items-center hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-eye mr-3 text-purple-500"></i>
                        <div>
                            <p class="font-medium">Display</p>
                            <p class="text-sm text-gray-500">View formatted tasks</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-md">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Import Tasks</h3>
                    <button id="close-import-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <p class="mb-4">Upload a JSON file to import tasks:</p>
                
                <div class="border-2 border-dashed rounded-lg p-6 text-center" id="import-dropzone">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-3 text-gray-400"></i>
                    <p class="mb-2">Drag and drop your file here</p>
                    <p class="text-sm text-gray-500 mb-4">Or click to select</p>
                    <button id="select-file-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Select File</button>
                    <input type="file" id="import-file" class="hidden" accept=".json,application/json">
                    <p id="selected-filename" class="mt-3 text-sm"></p>
                </div>
                
                <div class="mt-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="import-replace" class="mr-2">
                        <label for="import-replace">Replace existing tasks</label>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">If unchecked, imported tasks will be added to your current tasks.</p>
                </div>
            </div>
            
            <div class="p-4 border-t flex justify-end space-x-2">
                <button id="cancel-import-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Cancel</button>
                <button id="import-tasks-btn" class="px-4 py-2 text-white rounded-md" style="background-color: var(--primary-color);" disabled>Import Tasks</button>
            </div>
        </div>
    </div>
    
    <!-- Users Modal -->
    <div id="users-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Users</h3>
                    <button id="close-users-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <div class="mb-4">
                    <input type="text" id="user-search" placeholder="Search users..." class="w-full p-3 rounded-lg">
                </div>
                
                <div id="users-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Display Modal -->
    <div id="export-display-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Task Export</h3>
                    <button id="close-export-display-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <pre id="export-display-content" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg max-h-96 overflow-y-auto"></pre>
            </div>
            
            <div class="p-4 border-t flex justify-end">
                <button id="close-display-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Notification Mobile Modal -->
    <div id="notification-mobile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg w-full max-w-md">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Notifications</h3>
                    <button id="close-notification-mobile-modal" class="text-lg">&times;</button>
                </div>
            </div>
            
            <div class="p-4">
                <div id="notification-mobile-list" class="max-h-80 overflow-y-auto">
                    <!-- Will clone content from notification-list -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize dark mode based on user preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Update charts if they exist
            updateCharts();
        });
        
        // Data Management
        let currentUser = null;
        let users = [];
        let tasks = [];
        let selectedTasks = new Set();
        let statusTimer = null;
        let taskTimers = {};
        let actionsHistory = [];
        let currentHistoryIndex = -1;
        
        // App State
        let appState = {
            viewMode: 'list',
            sortBy: 'date-created',
            sortOrder: 'desc',
            filters: {
                search: '',
                priority: 'all',
                status: 'all',
                dueDate: 'all',
                category: 'all',
                dateFrom: null,
                dateTo: null
            }
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage
            loadData();
            
            // Initialize UI components
            initializeAuth();
            initializeUI();
            initializeEventListeners();
            
            // Check if user is logged in
            checkLoggedInStatus();
            
            // Initialize countries dropdown
            populateCountries();
        });
        
        // Auth Functions
        function initializeAuth() {
            document.getElementById('login-tab').addEventListener('click', function() {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-tab').classList.add('border-primary-500', 'text-primary-600');
                document.getElementById('login-tab').classList.remove('border-gray-200', 'text-gray-500');
                document.getElementById('register-tab').classList.add('border-gray-200', 'text-gray-500');
                document.getElementById('register-tab').classList.remove('border-primary-500', 'text-primary-600');
            });
            
            document.getElementById('register-tab').addEventListener('click', function() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
                document.getElementById('register-tab').classList.add('border-primary-500', 'text-primary-600');
                document.getElementById('register-tab').classList.remove('border-gray-200', 'text-gray-500');
                document.getElementById('login-tab').classList.add('border-gray-200', 'text-gray-500');
                document.getElementById('login-tab').classList.remove('border-primary-500', 'text-primary-600');
            });
            
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // Validate credentials
                const user = users.find(user => user.email === email && user.password === password);
                
                if (user) {
                    loginUser(user);
                } else {
                    alert("Invalid email or password. Please try again.");
                }
            });
            
            document.getElementById('register-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const confirmEmail = document.getElementById('register-confirm-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                const phone = document.getElementById('register-phone').value;
                const country = document.getElementById('register-country').value;
                const role = document.getElementById('register-role').value;
                
                // Validate inputs
                if (email !== confirmEmail) {
                    alert("Emails do not match.");
                    return;
                }
                
                if (password !== confirmPassword) {
                    alert("Passwords do not match.");
                    return;
                }
                
                if (users.some(user => user.email === email)) {
                    alert("Email is already registered.");
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: generateId(),
                    name,
                    email,
                    password,
                    phone,
                    country,
                    role,
                    profilePic: generateRandomAvatar(name),
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                saveData();
                
                // Login the new user
                loginUser(newUser);
            });
            
            // Demo login
            document.getElementById('demo-login').addEventListener('click', function() {
                const demoUser = {
                    id: 'demo-user',
                    name: 'Demo User',
                    email: 'demo@example.com',
                    password: 'password',
                    phone: '+1234567890',
                    country: 'United States',
                    role: 'Manager',
                    profilePic: generateRandomAvatar('Demo User'),
                    createdAt: new Date().toISOString()
                };
                
                // Check if demo user already exists
                if (!users.some(user => user.id === 'demo-user')) {
                    users.push(demoUser);
                    
                    // Generate random tasks for demo
                    generateDemoTasks(demoUser.id);
                    
                    saveData();
                }
                
                loginUser(demoUser);
            });
        }
        
        function generateDemoTasks(userId) {
            const categories = ['work', 'personal', 'shopping', 'health', 'finance'];
            const priorities = ['low', 'medium', 'high'];
            const today = new Date();
            
            const demoTasks = [
                {
                    id: generateId(),
                    title: 'Complete Project Presentation',
                    description: 'Prepare slides for the quarterly project review',
                    priority: 'high',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 2).toISOString(), // 2 hours from now
                    category: 'work',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 2).toISOString(), // 2 days ago
                    assignedTo: userId,
                    subtasks: [
                        { id: generateId(), title: 'Create outline', completed: true },
                        { id: generateId(), title: 'Design slides', completed: true },
                        { id: generateId(), title: 'Practice presentation', completed: false }
                    ],
                    notes: 'Focus on Q2 achievements and Q3 goals',
                    workTime: 4500 // 1 hour 15 minutes in seconds
                },
                {
                    id: generateId(),
                    title: 'Grocery Shopping',
                    description: 'Buy weekly groceries',
                    priority: 'medium',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24).toISOString(), // 1 day from now
                    category: 'shopping',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 12).toISOString(), // 12 hours ago
                    assignedTo: userId,
                    subtasks: [
                        { id: generateId(), title: 'Fruits and vegetables', completed: false },
                        { id: generateId(), title: 'Dairy products', completed: false }
                    ],
                    notes: 'Check for discounts on cereals',
                    workTime: 0
                },
                {
                    id: generateId(),
                    title: 'Morning Workout',
                    description: '30 minutes cardio session',
                    priority: 'medium',
                    dueDate: new Date(today.setHours(0, 0, 0, 0)).toISOString(), // Today at midnight
                    category: 'health',
                    status: 'completed',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 3).toISOString(), // 3 days ago
                    completedAt: new Date(today.getTime() - 1000 * 60 * 60 * 12).toISOString(), // 12 hours ago
                    assignedTo: userId,
                    subtasks: [],
                    notes: 'Focus on stretching properly',
                    workTime: 1800 // 30 minutes in seconds
                },
                {
                    id: generateId(),
                    title: 'Review Monthly Budget',
                    description: 'Analyze expenses and update budget spreadsheet',
                    priority: 'high',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24 * 3).toISOString(), // 3 days from now
                    category: 'finance',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24).toISOString(), // 1 day ago
                    assignedTo: userId,
                    subtasks: [
                        { id: generateId(), title: 'Calculate total expenses', completed: false },
                        { id: generateId(), title: 'Compare with previous month', completed: false },
                        { id: generateId(), title: 'Update savings goal', completed: false }
                    ],
                    notes: 'Look for areas to reduce spending',
                    workTime: 1200 // 20 minutes in seconds
                },
                {
                    id: generateId(),
                    title: 'Call Parents',
                    description: 'Weekly check-in call',
                    priority: 'medium',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24 * 2).toISOString(), // 2 days from now
                    category: 'personal',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 4).toISOString(), // 4 days ago
                    assignedTo: userId,
                    subtasks: [],
                    notes: 'Ask about their weekend plans',
                    workTime: 0
                },
                {
                    id: generateId(),
                    title: 'Clean Home Office',
                    description: 'Organize desk and files',
                    priority: 'low',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24 * 5).toISOString(), // 5 days from now
                    category: 'personal',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 2).toISOString(), // 2 days ago
                    assignedTo: userId,
                    subtasks: [
                        { id: generateId(), title: 'Sort papers', completed: false },
                        { id: generateId(), title: 'Clean desk surface', completed: false }
                    ],
                    notes: 'Recycle old documents',
                    workTime: 600 // 10 minutes in seconds
                },
                {
                    id: generateId(),
                    title: 'Book Dentist Appointment',
                    description: 'Schedule regular check-up',
                    priority: 'medium',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24 * 7).toISOString(), // 7 days from now
                    category: 'health',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 1).toISOString(), // 1 day ago
                    assignedTo: userId,
                    subtasks: [],
                    notes: 'Ask about teeth whitening options',
                    workTime: 0
                },
                {
                    id: generateId(),
                    title: 'Update Resume',
                    description: 'Add recent project experience',
                    priority: 'low',
                    dueDate: new Date(today.getTime() + 1000 * 60 * 60 * 24 * 14).toISOString(), // 14 days from now
                    category: 'work',
                    status: 'active',
                    createdAt: new Date(today.getTime() - 1000 * 60 * 60 * 24 * 5).toISOString(), // 5 days ago
                    assignedTo: userId,
                    subtasks: [
                        { id: generateId(), title: 'Update skills section', completed: false },
                        { id: generateId(), title: 'Add recent projects', completed: false }
                    ],
                    notes: 'Keep it to 2 pages maximum',
                    workTime: 2700 // 45 minutes in seconds
                }
            ];
            
            tasks = [...tasks, ...demoTasks];
        }
        
        function loginUser(user) {
            currentUser = user;
            
            // Set user in localStorage
            localStorage.setItem('todoAppCurrentUser', JSON.stringify(user));
            
            // Update profile UI
            updateProfileUI();
            
            // Show main app, hide auth page
            document.getElementById('auth-page').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            // Start status timer
            startStatusTimer('login');
            
            // Refresh data display
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
        }
        
        function logoutUser() {
            // Save current user's timer data before logout
            saveUserTimerData();
            
            // Stop all timers
            if (statusTimer) {
                clearInterval(statusTimer);
                statusTimer = null;
            }
            
            // Clear task timers
            Object.values(taskTimers).forEach(timer => clearInterval(timer.interval));
            taskTimers = {};
            
            // Clear current user
            currentUser = null;
            localStorage.removeItem('todoAppCurrentUser');
            
            // Show auth page, hide main app
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('auth-page').classList.remove('hidden');
            
            // Reset auth forms
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            
            // Switch to login tab
            document.getElementById('login-tab').click();
        }
        
        function checkLoggedInStatus() {
            const savedUser = localStorage.getItem('todoAppCurrentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                
                // Verify user still exists in database
                if (users.some(user => user.id === currentUser.id)) {
                    // Update profile UI
                    updateProfileUI();
                    
                    // Show main app, hide auth page
                    document.getElementById('auth-page').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    
                    // Start status timer
                    startStatusTimer('login');
                    
                    // Refresh data display
                    refreshTasksDisplay();
                    updateTaskCounts();
                    updateCharts();
                    updateInsights();
                    updateUpcomingDeadlines();
                } else {
                    // User no longer exists, log out
                    logoutUser();
                }
            }
        }
        
        // UI Functions
        function initializeUI() {
            // Dark mode toggle
            document.getElementById('dark-mode-toggle').addEventListener('change', function() {
                document.documentElement.classList.toggle('dark', this.checked);
                updateCharts();
            });
            
            document.getElementById('mobile-dark-mode-toggle').addEventListener('change', function() {
                document.documentElement.classList.toggle('dark', this.checked);
                document.getElementById('dark-mode-toggle').checked = this.checked;
                updateCharts();
            });
            
            // Sync dark mode toggle with system preference
            if (document.documentElement.classList.contains('dark')) {
                document.getElementById('dark-mode-toggle').checked = true;
                document.getElementById('mobile-dark-mode-toggle').checked = true;
            }
            
            // Mobile menu toggle
            document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });
            
            // Notification toggle
            document.getElementById('notification-btn').addEventListener('click', function() {
                document.getElementById('notification-dropdown').classList.toggle('hidden');
            });
            
            document.getElementById('mobile-notification-btn').addEventListener('click', function() {
                // Clone notifications to mobile modal
                const mobileList = document.getElementById('notification-mobile-list');
                mobileList.innerHTML = document.getElementById('notification-list').innerHTML;
                
                // Show mobile notification modal
                document.getElementById('notification-mobile-modal').classList.remove('hidden');
            });
            
            // Profile dropdown toggle
            document.getElementById('profile-btn').addEventListener('click', function() {
                document.getElementById('profile-dropdown').classList.toggle('hidden');
            });
            
            // View type toggle (list/graph)
            document.getElementById('list-view-btn').addEventListener('click', function() {
                setViewMode('list');
            });
            
            document.getElementById('graph-view-btn').addEventListener('click', function() {
                setViewMode('graph');
                updateCharts();
            });
            
            // Filter toggle
            document.getElementById('filter-toggle-btn').addEventListener('click', function() {
                document.getElementById('advanced-filters').classList.toggle('hidden');
                document.getElementById('sort-options').classList.add('hidden');
            });
            
            // Sort toggle
            document.getElementById('sort-btn').addEventListener('click', function() {
                document.getElementById('sort-options').classList.toggle('hidden');
                document.getElementById('advanced-filters').classList.add('hidden');
            });
            
            // Bulk actions toggle
            document.getElementById('bulk-actions-btn').addEventListener('click', function() {
                document.getElementById('bulk-actions-dropdown').classList.toggle('hidden');
            });
            
            // Due date filter change
            document.getElementById('filter-due-date').addEventListener('change', function() {
                if (this.value === 'custom') {
                    document.getElementById('custom-date-range').classList.remove('hidden');
                } else {
                    document.getElementById('custom-date-range').classList.add('hidden');
                }
            });
            
            // Apply filters
            document.getElementById('apply-filters-btn').addEventListener('click', function() {
                appState.filters = {
                    search: document.getElementById('task-search').value,
                    priority: document.getElementById('filter-priority').value,
                    status: document.getElementById('filter-status').value,
                    dueDate: document.getElementById('filter-due-date').value,
                    category: document.getElementById('filter-category').value,
                    dateFrom: document.getElementById('filter-date-from').value,
                    dateTo: document.getElementById('filter-date-to').value
                };
                
                refreshTasksDisplay();
                document.getElementById('advanced-filters').classList.add('hidden');
            });
            
            // Reset filters
            document.getElementById('reset-filters-btn').addEventListener('click', function() {
                document.getElementById('task-search').value = '';
                document.getElementById('filter-priority').value = 'all';
                document.getElementById('filter-status').value = 'all';
                document.getElementById('filter-due-date').value = 'all';
                document.getElementById('filter-category').value = 'all';
                document.getElementById('filter-date-from').value = '';
                document.getElementById('filter-date-to').value = '';
                
                appState.filters = {
                    search: '',
                    priority: 'all',
                    status: 'all',
                    dueDate: 'all',
                    category: 'all',
                    dateFrom: null,
                    dateTo: null
                };
                
                refreshTasksDisplay();
                document.getElementById('advanced-filters').classList.add('hidden');
            });
            
            // Apply sort
            document.getElementById('apply-sort-btn').addEventListener('click', function() {
                appState.sortBy = document.getElementById('sort-by').value;
                appState.sortOrder = document.getElementById('sort-order').value;
                
                refreshTasksDisplay();
                document.getElementById('sort-options').classList.add('hidden');
            });
            
            // Task search
            document.getElementById('task-search').addEventListener('input', debounce(function() {
                appState.filters.search = this.value;
                refreshTasksDisplay();
            }, 300));
            
            // Bulk actions
            document.getElementById('select-all-btn').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.task-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    selectedTasks.add(checkbox.dataset.id);
                });
                document.getElementById('bulk-actions-dropdown').classList.add('hidden');
            });
            
            document.getElementById('deselect-all-btn').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.task-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectedTasks.clear();
                document.getElementById('bulk-actions-dropdown').classList.add('hidden');
            });
            
            document.getElementById('complete-selected-btn').addEventListener('click', function() {
                if (selectedTasks.size === 0) return;
                
                // Save action for undo
                saveAction({
                    type: 'complete-batch',
                    taskIds: Array.from(selectedTasks),
                    previousStates: tasks.filter(task => selectedTasks.has(task.id)).map(task => ({ ...task }))
                });
                
                // Complete selected tasks
                tasks.forEach(task => {
                    if (selectedTasks.has(task.id) && task.status !== 'completed') {
                        task.status = 'completed';
                        task.completedAt = new Date().toISOString();
                    }
                });
                
                saveData();
                refreshTasksDisplay();
                updateTaskCounts();
                updateCharts();
                updateInsights();
                selectedTasks.clear();
                document.getElementById('bulk-actions-dropdown').classList.add('hidden');
            });
            
            document.getElementById('delete-selected-btn').addEventListener('click', function() {
                if (selectedTasks.size === 0) return;
                
                // Save action for undo
                saveAction({
                    type: 'delete-batch',
                    taskIds: Array.from(selectedTasks),
                    previousStates: tasks.filter(task => selectedTasks.has(task.id)).map(task => ({ ...task }))
                });
                
                // Delete selected tasks
                tasks = tasks.filter(task => !selectedTasks.has(task.id));
                
                saveData();
                refreshTasksDisplay();
                updateTaskCounts();
                updateCharts();
                updateInsights();
                selectedTasks.clear();
                document.getElementById('bulk-actions-dropdown').classList.add('hidden');
            });
            
            // Undo/Redo
            document.getElementById('undo-btn').addEventListener('click', function() {
                undoAction();
            });
            
            document.getElementById('redo-btn').addEventListener('click', function() {
                redoAction();
            });
            
            // Add task button
            document.getElementById('add-task-btn').addEventListener('click', function() {
                openTaskModal();
            });
            
            // Save task
            document.getElementById('save-task-btn').addEventListener('click', function() {
                saveTask();
            });
            
            // Cancel task
            document.getElementById('cancel-task-btn').addEventListener('click', function() {
                closeTaskModal();
            });
            
            document.getElementById('close-task-modal').addEventListener('click', function() {
                closeTaskModal();
            });
            
            // Add subtask
            document.getElementById('add-subtask-btn').addEventListener('click', function() {
                addSubtask();
            });
            
            // Status buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const status = this.dataset.status;
                    changeStatus(status);
                    document.getElementById('profile-dropdown').classList.add('hidden');
                });
            });
            
            document.querySelectorAll('.mobile-status-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const status = this.dataset.status;
                    changeStatus(status);
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
            });
            
            // Logout buttons
            document.getElementById('logout-btn').addEventListener('click', function() {
                logoutUser();
            });
            
            document.getElementById('mobile-logout-btn').addEventListener('click', function() {
                logoutUser();
            });
            
            // View profile buttons
            document.getElementById('view-profile-btn').addEventListener('click', function() {
                openProfileModal();
                document.getElementById('profile-dropdown').classList.add('hidden');
            });
            
            document.getElementById('mobile-view-profile-btn').addEventListener('click', function() {
                openProfileModal();
                document.getElementById('mobile-menu').classList.add('hidden');
            });
            
            // Profile modal
            document.getElementById('close-profile-modal').addEventListener('click', function() {
                closeProfileModal();
            });
            
            document.getElementById('cancel-profile-btn').addEventListener('click', function() {
                closeProfileModal();
            });
            
            document.getElementById('save-profile-btn').addEventListener('click', function() {
                saveProfile();
            });
            
            // Profile picture upload
            document.getElementById('profile-pic-upload').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('profile-pic-preview').src = e.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // Import/Export buttons
            document.getElementById('import-btn').addEventListener('click', function() {
                openImportModal();
            });
            
            document.getElementById('export-btn').addEventListener('click', function() {
                openExportModal();
            });
            
            // Import modal
            document.getElementById('close-import-modal').addEventListener('click', function() {
                closeImportModal();
            });
            
            document.getElementById('cancel-import-btn').addEventListener('click', function() {
                closeImportModal();
            });
            
            document.getElementById('select-file-btn').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    document.getElementById('selected-filename').textContent = e.target.files[0].name;
                    document.getElementById('import-tasks-btn').disabled = false;
                }
            });
            
            document.getElementById('import-tasks-btn').addEventListener('click', function() {
                importTasks();
            });
            
            // Export modal
            document.getElementById('close-export-modal').addEventListener('click', function() {
                closeExportModal();
            });
            
            document.querySelectorAll('.export-format-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    exportTasks(this.dataset.format);
                });
            });
            
            // Export display modal
            document.getElementById('close-export-display-modal').addEventListener('click', function() {
                closeExportDisplayModal();
            });
            
            document.getElementById('close-display-btn').addEventListener('click', function() {
                closeExportDisplayModal();
            });
            
            // Users button
            document.getElementById('users-btn').addEventListener('click', function() {
                openUsersModal();
            });
            
            // Users modal
            document.getElementById('close-users-modal').addEventListener('click', function() {
                closeUsersModal();
            });
            
            document.getElementById('user-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const userElements = document.querySelectorAll('.user-card');
                
                userElements.forEach(el => {
                    const name = el.querySelector('.user-name').textContent.toLowerCase();
                    const email = el.querySelector('.user-email').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || email.includes(searchTerm)) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });
            });
            
            // Notification Mobile Modal
            document.getElementById('close-notification-mobile-modal').addEventListener('click', function() {
                document.getElementById('notification-mobile-modal').classList.add('hidden');
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                // Profile dropdown
                if (!e.target.closest('#profile-btn') && !e.target.closest('#profile-dropdown')) {
                    document.getElementById('profile-dropdown').classList.add('hidden');
                }
                
                // Notification dropdown
                if (!e.target.closest('#notification-btn') && !e.target.closest('#notification-dropdown')) {
                    document.getElementById('notification-dropdown').classList.add('hidden');
                }
                
                // Bulk actions dropdown
                if (!e.target.closest('#bulk-actions-btn') && !e.target.closest('#bulk-actions-dropdown')) {
                    document.getElementById('bulk-actions-dropdown').classList.add('hidden');
                }
            });
        }
        
        function initializeEventListeners() {
            // Register event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                // Task completion toggle
                if (e.target.classList.contains('task-complete-toggle')) {
                    toggleTaskCompletion(e.target.dataset.id);
                }
                
                // Task edit button
                if (e.target.closest('.task-edit-btn')) {
                    const btn = e.target.closest('.task-edit-btn');
                    openTaskModal(btn.dataset.id);
                }
                
                // Task delete button
                if (e.target.closest('.task-delete-btn')) {
                    const btn = e.target.closest('.task-delete-btn');
                    deleteTask(btn.dataset.id);
                }
                
                // Task share button
                if (e.target.closest('.task-share-btn')) {
                    const btn = e.target.closest('.task-share-btn');
                    shareTask(btn.dataset.id);
                }
                
                // Task timer button
                if (e.target.closest('.task-timer-btn')) {
                    const btn = e.target.closest('.task-timer-btn');
                    toggleTaskTimer(btn.dataset.id);
                }
                
                // Remove subtask button
                if (e.target.closest('.remove-subtask-btn')) {
                    const btn = e.target.closest('.remove-subtask-btn');
                    removeSubtask(btn.parentElement);
                }
            });
            
            // Task checkbox change
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    if (e.target.checked) {
                        selectedTasks.add(e.target.dataset.id);
                    } else {
                        selectedTasks.delete(e.target.dataset.id);
                    }
                }
            });
        }
        
        function updateProfileUI() {
            if (!currentUser) return;
            
            // Update profile picture and name in header
            const profilePic = document.getElementById('profile-picture');
            profilePic.src = currentUser.profilePic;
            
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-role').textContent = currentUser.role;
        }
        
        function refreshTasksDisplay() {
            const taskList = document.getElementById('task-list');
            const filteredTasks = filterTasks();
            
            // Clear current tasks
            taskList.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div class="text-center p-8 text-gray-500">
                        <i class="fas fa-tasks text-4xl mb-4"></i>
                        <p>No tasks found. Add a task to get started!</p>
                    </div>
                `;
                return;
            }
            
            // Add task elements
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskList.appendChild(taskElement);
            });
            
            // Initialize any task timers for displayed tasks
            filteredTasks.forEach(task => {
                if (taskTimers[task.id] && taskTimers[task.id].running) {
                    updateTaskTimeDisplay(task.id);
                }
            });
        }
        
        function updateTaskCounts() {
            if (!currentUser) return;
            
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const pendingTasks = totalTasks - completedTasks;
            
            document.getElementById('total-task-count').textContent = `${totalTasks} ${totalTasks === 1 ? 'Task' : 'Tasks'}`;
            document.getElementById('completed-task-count').textContent = `${completedTasks} ${completedTasks === 1 ? 'Task' : 'Tasks'}`;
            document.getElementById('pending-task-count').textContent = `${pendingTasks} ${pendingTasks === 1 ? 'Task' : 'Tasks'}`;
            
            // Update category counts
            document.getElementById('work-count').textContent = tasks.filter(task => task.category === 'work').length;
            document.getElementById('personal-count').textContent = tasks.filter(task => task.category === 'personal').length;
            document.getElementById('shopping-count').textContent = tasks.filter(task => task.category === 'shopping').length;
            document.getElementById('health-count').textContent = tasks.filter(task => task.category === 'health').length;
            document.getElementById('finance-count').textContent = tasks.filter(task => task.category === 'finance').length;
        }
        
        function updateUpcomingDeadlines() {
            const container = document.getElementById('upcoming-deadlines');
            container.innerHTML = '';
            
            // Get tasks that are not completed and have due dates
            const upcomingTasks = tasks
                .filter(task => task.status !== 'completed' && task.dueDate)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5); // Get top 5
            
            if (upcomingTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-2">No upcoming deadlines</p>';
                return;
            }
            
            upcomingTasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const diffTime = dueDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let dueDateClass = 'due-future';
                if (diffTime < 0) {
                    dueDateClass = 'due-expired';
                } else if (diffTime < 1000 * 60 * 60 * 48) { // Less than 48 hours
                    dueDateClass = 'due-soon';
                }
                
                let dueText = '';
                if (diffTime < 0) {
                    dueText = 'Overdue';
                } else if (diffDays === 0) {
                    dueText = 'Today';
                } else if (diffDays === 1) {
                    dueText = 'Tomorrow';
                } else {
                    dueText = `In ${diffDays} days`;
                }
                
                const taskElement = document.createElement('div');
                taskElement.className = 'p-2 border-b';
                taskElement.innerHTML = `
                    <p class="font-medium">${task.title}</p>
                    <div class="flex justify-between items-center text-sm">
                        <span class="${dueDateClass}">${dueText}</span>
                        <span class="text-xs">${formatDate(dueDate)}</span>
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }
        
        // Task Management Functions
        function openTaskModal(taskId = null) {
            const modal = document.getElementById('task-modal');
            const form = document.getElementById('task-form');
            const modalTitle = document.getElementById('task-modal-title');
            const subtasksContainer = document.getElementById('subtasks-container');
            
            // Clear form
            form.reset();
            subtasksContainer.innerHTML = '';
            
            // Populate assign to dropdown
            const assignSelect = document.getElementById('task-assign');
            assignSelect.innerHTML = '<option value="">Select User</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                assignSelect.appendChild(option);
            });
            
            if (taskId) {
                // Edit existing task
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;
                
                modalTitle.textContent = 'Edit Task';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-priority').value = task.priority || 'medium';
                
                if (task.dueDate) {
                    // Format date for datetime-local input
                    const dueDate = new Date(task.dueDate);
                    const year = dueDate.getFullYear();
                    const month = String(dueDate.getMonth() + 1).padStart(2, '0');
                    const day = String(dueDate.getDate()).padStart(2, '0');
                    const hours = String(dueDate.getHours()).padStart(2, '0');
                    const minutes = String(dueDate.getMinutes()).padStart(2, '0');
                    
                    document.getElementById('task-due-date').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                document.getElementById('task-category').value = task.category || 'work';
                document.getElementById('task-assign').value = task.assignedTo || '';
                document.getElementById('task-notes').value = task.notes || '';
                
                // Add subtasks
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        addSubtask(subtask.title, subtask.completed, subtask.id);
                    });
                }
            } else {
                // New task
                modalTitle.textContent = 'Add New Task';
                document.getElementById('task-id').value = '';
                
                // Set defaults
                document.getElementById('task-priority').value = 'medium';
                document.getElementById('task-category').value = 'work';
                
                // Default assign to current user
                if (currentUser) {
                    document.getElementById('task-assign').value = currentUser.id;
                }
            }
            
            modal.classList.remove('hidden');
        }
        
        function closeTaskModal() {
            document.getElementById('task-modal').classList.add('hidden');
        }
        
        function saveTask() {
            const taskId = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value.trim();
            
            if (!title) {
                alert('Task title is required');
                return;
            }
            
            // Get form data
            const description = document.getElementById('task-description').value.trim();
            const priority = document.getElementById('task-priority').value;
            const dueDateInput = document.getElementById('task-due-date').value;
            const category = document.getElementById('task-category').value;
            const assignedTo = document.getElementById('task-assign').value;
            const notes = document.getElementById('task-notes').value.trim();
            
            // Parse due date
            let dueDate = null;
            if (dueDateInput) {
                dueDate = new Date(dueDateInput).toISOString();
            }
            
            // Get subtasks
            const subtasks = [];
            document.querySelectorAll('.subtask-item').forEach(item => {
                const subtaskTitle = item.querySelector('.subtask-title').value.trim();
                if (subtaskTitle) {
                    subtasks.push({
                        id: item.dataset.id || generateId(),
                        title: subtaskTitle,
                        completed: item.querySelector('.subtask-completed').checked
                    });
                }
            });
            
            if (taskId) {
                // Edit existing task
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex === -1) return;
                
                // Save original task for undo
                const originalTask = { ...tasks[taskIndex] };
                
                // Update task
                tasks[taskIndex] = {
                    ...tasks[taskIndex],
                    title,
                    description,
                    priority,
                    dueDate,
                    category,
                    assignedTo,
                    notes,
                    subtasks,
                    updatedAt: new Date().toISOString()
                };
                
                // Save action for undo
                saveAction({
                    type: 'edit',
                    taskId,
                    previousState: originalTask,
                    newState: { ...tasks[taskIndex] }
                });
            } else {
                // Create new task
                const newTask = {
                    id: generateId(),
                    title,
                    description,
                    priority,
                    dueDate,
                    category,
                    assignedTo,
                    notes,
                    subtasks,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    workTime: 0
                };
                
                tasks.push(newTask);
                
                // Save action for undo
                saveAction({
                    type: 'add',
                    taskId: newTask.id,
                    newState: { ...newTask }
                });
            }
            
            saveData();
            closeTaskModal();
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
        }
        
        function deleteTask(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Save original task for undo
            const originalTask = { ...tasks[taskIndex] };
            
            // Save action for undo
            saveAction({
                type: 'delete',
                taskId,
                previousState: originalTask
            });
            
            // Remove task
            tasks.splice(taskIndex, 1);
            
            saveData();
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
        }
        
        function toggleTaskCompletion(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Save original task for undo
            const originalTask = { ...tasks[taskIndex] };
            
            // Toggle completion
            if (tasks[taskIndex].status === 'completed') {
                tasks[taskIndex].status = 'active';
                tasks[taskIndex].completedAt = null;
            } else {
                tasks[taskIndex].status = 'completed';
                tasks[taskIndex].completedAt = new Date().toISOString();
            }
            
            // Save action for undo
            saveAction({
                type: 'toggle-completion',
                taskId,
                previousState: originalTask,
                newState: { ...tasks[taskIndex] }
            });
            
            saveData();
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
        }
        
        function toggleTaskTimer(taskId) {
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            const timerButton = document.querySelector(`.task-timer-btn[data-id="${taskId}"]`);
            
            if (!taskTimers[taskId]) {
                taskTimers[taskId] = {
                    running: false,
                    time: task.workTime || 0,
                    interval: null
                };
            }
            
            if (taskTimers[taskId].running) {
                // Stop timer
                clearInterval(taskTimers[taskId].interval);
                taskTimers[taskId].running = false;
                task.workTime = taskTimers[taskId].time;
                
                // Update button
                timerButton.innerHTML = '<i class="fas fa-play"></i>';
                timerButton.classList.remove('bg-red-500');
                timerButton.classList.add('bg-green-500');
            } else {
                // Start timer
                taskTimers[taskId].running = true;
                const startTime = Date.now() - taskTimers[taskId].time * 1000;
                
                taskTimers[taskId].interval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                    taskTimers[taskId].time = elapsedSeconds;
                    updateTaskTimeDisplay(taskId);
                }, 1000);
                
                // Update button
                timerButton.innerHTML = '<i class="fas fa-pause"></i>';
                timerButton.classList.remove('bg-green-500');
                timerButton.classList.add('bg-red-500');
                
                // Initial update
                updateTaskTimeDisplay(taskId);
            }
            
            // Save timer state
            saveData();
        }
        
        function updateTaskTimeDisplay(taskId) {
            if (!taskTimers[taskId]) return;
            
            const timerDisplay = document.querySelector(`.task-timer-display[data-id="${taskId}"]`);
            if (!timerDisplay) return;
            
            const time = taskTimers[taskId].time;
            timerDisplay.textContent = formatTime(time);
        }
        
        function addSubtask(title = '', completed = false, id = null) {
            const container = document.getElementById('subtasks-container');
            const subtaskId = id || generateId();
            
            const subtaskItem = document.createElement('div');
            subtaskItem.className = 'subtask-item flex items-center space-x-2';
            subtaskItem.dataset.id = subtaskId;
            
            subtaskItem.innerHTML = `
                <input type="checkbox" class="subtask-completed" ${completed ? 'checked' : ''}>
                <input type="text" class="subtask-title flex-grow p-2 rounded-md" value="${title}" placeholder="Enter subtask">
                <button type="button" class="remove-subtask-btn p-1 text-red-500">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(subtaskItem);
        }
        
        function removeSubtask(subtaskElement) {
            subtaskElement.remove();
        }
        
        function shareTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Prepare shareable text
            const shareText = `Task: ${task.title}\nDue: ${task.dueDate ? formatDate(new Date(task.dueDate)) : 'No due date'}\nPriority: ${task.priority}\nDescription: ${task.description || 'No description'}`;
            
            // Try to use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: 'Shared Task',
                    text: shareText
                }).catch(err => {
                    console.error('Error sharing:', err);
                    alert('Copied to clipboard: ' + shareText);
                });
            } else {
                // Fallback to clipboard
                try {
                    navigator.clipboard.writeText(shareText).then(() => {
                        alert('Copied to clipboard: ' + shareText);
                    });
                } catch (err) {
                    console.error('Failed to copy:', err);
                    alert('Unable to share. Please manually copy this text: ' + shareText);
                }
            }
        }
        
        // Filter and Sort Functions
        function filterTasks() {
            let filtered = [...tasks];
            const { search, priority, status, dueDate, category, dateFrom, dateTo } = appState.filters;
            
            // Text search filter
            if (search) {
                const searchLower = search.toLowerCase();
                filtered = filtered.filter(task => 
                    task.title.toLowerCase().includes(searchLower) || 
                    (task.description && task.description.toLowerCase().includes(searchLower))
                );
            }
            
            // Priority filter
            if (priority !== 'all') {
                filtered = filtered.filter(task => task.priority === priority);
            }
            
            // Status filter
            if (status !== 'all') {
                if (status === 'completed') {
                    filtered = filtered.filter(task => task.status === 'completed');
                } else {
                    filtered = filtered.filter(task => task.status !== 'completed');
                }
            }
            
            // Category filter
            if (category !== 'all') {
                filtered = filtered.filter(task => task.category === category);
            }
            
            // Due date filter
            if (dueDate !== 'all' && dueDate !== 'custom') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                if (dueDate === 'today') {
                    // Due today
                    filtered = filtered.filter(task => {
                        if (!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate.getDate() === today.getDate() &&
                               taskDate.getMonth() === today.getMonth() &&
                               taskDate.getFullYear() === today.getFullYear();
                    });
                } else if (dueDate === 'week') {
                    // Due this week
                    const weekEnd = new Date(today);
                    weekEnd.setDate(today.getDate() + 7);
                    
                    filtered = filtered.filter(task => {
                        if (!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= today && taskDate <= weekEnd;
                    });
                } else if (dueDate === 'month') {
                    // Due this month
                    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    
                    filtered = filtered.filter(task => {
                        if (!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= today && taskDate <= monthEnd;
                    });
                }
            } else if (dueDate === 'custom' && (dateFrom || dateTo)) {
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    filtered = filtered.filter(task => {
                        if (!task.dueDate) return false;
                        return new Date(task.dueDate) >= fromDate;
                    });
                }
                
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59);
                    filtered = filtered.filter(task => {
                        if (!task.dueDate) return false;
                        return new Date(task.dueDate) <= toDate;
                    });
                }
            }
            
            // Sort tasks
            filtered = sortTasks(filtered);
            
            return filtered;
        }
        
        function sortTasks(taskList) {
            const { sortBy, sortOrder } = appState;
            
            return taskList.sort((a, b) => {
                let compareResult = 0;
                
                switch (sortBy) {
                    case 'date-created':
                        compareResult = new Date(a.createdAt) - new Date(b.createdAt);
                        break;
                    case 'due-date':
                        // Handle null due dates by placing them at the end
                        if (!a.dueDate && !b.dueDate) compareResult = 0;
                        else if (!a.dueDate) compareResult = 1;
                        else if (!b.dueDate) compareResult = -1;
                        else compareResult = new Date(a.dueDate) - new Date(b.dueDate);
                        break;
                    case 'priority':
                        const priorityValues = { high: 0, medium: 1, low: 2 };
                        compareResult = priorityValues[a.priority] - priorityValues[b.priority];
                        break;
                    case 'title':
                        compareResult = a.title.localeCompare(b.title);
                        break;
                    default:
                        compareResult = new Date(a.createdAt) - new Date(b.createdAt);
                }
                
                // Apply sort order
                return sortOrder === 'asc' ? compareResult : -compareResult;
            });
        }
        
        // Element Creation Functions
        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item card rounded-lg p-4 shadow-sm';
            
            // Determine due date status
            let dueDateClass = 'due-future';
            let dueStatus = '';
            
            if (task.dueDate) {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                const diffTime = dueDate - now;
                
                if (diffTime < 0) {
                    dueDateClass = 'due-expired';
                    dueStatus = 'Overdue';
                } else if (diffTime < 1000 * 60 * 60 * 48) { // Less than 48 hours
                    dueDateClass = 'due-soon';
                    dueStatus = 'Due soon';
                } else {
                    dueStatus = 'Due';
                }
            }
            
            // Format task work time
            const workTimeDisplay = formatTime(task.workTime || 0);
            
            const taskMarkup = `
                <div class="flex items-start gap-3">
                    <!-- Checkbox for bulk operations -->
                    <div class="pt-1">
                        <input type="checkbox" class="task-checkbox" data-id="${task.id}" ${selectedTasks.has(task.id) ? 'checked' : ''}>
                    </div>
                    
                    <!-- Task main content -->
                    <div class="flex-grow">
                        <!-- Header with title and priority -->
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-bold ${task.status === 'completed' ? 'completed-task' : ''}">${task.title}</h3>
                            <div class="priority-badge px-2 py-1 text-white text-xs rounded-full priority-${task.priority}">
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </div>
                        </div>
                        
                        <!-- Description -->
                        ${task.description ? `<p class="mt-1 text-gray-600 dark:text-gray-300">${task.description}</p>` : ''}
                        
                        <!-- Subtasks -->
                        ${task.subtasks && task.subtasks.length > 0 ? `
                            <div class="mt-3">
                                <p class="text-sm font-medium mb-1">Subtasks (${task.subtasks.filter(st => st.completed).length}/${task.subtasks.length})</p>
                                <div class="space-y-1">
                                    ${task.subtasks.map(subtask => `
                                        <div class="flex items-center text-sm">
                                            <span class="mr-2">${subtask.completed ? '✓' : '○'}</span>
                                            <span class="${subtask.completed ? 'completed-task' : ''}">${subtask.title}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Footer with metadata -->
                        <div class="mt-3 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                            <!-- Category -->
                            <div>
                                <i class="fas fa-tag mr-1"></i>
                                <span>${task.category.charAt(0).toUpperCase() + task.category.slice(1)}</span>
                            </div>
                            
                            <!-- Due date -->
                            ${task.dueDate ? `
                                <div class="${dueDateClass}">
                                    <i class="far fa-calendar-alt mr-1"></i>
                                    <span>${dueStatus}: ${formatDate(new Date(task.dueDate))}</span>
                                </div>
                            ` : ''}
                            
                            <!-- Created -->
                            <div>
                                <i class="far fa-clock mr-1"></i>
                                <span>Created: ${formatRelativeDate(new Date(task.createdAt))}</span>
                            </div>
                            
                            <!-- Timer display -->
                            <div>
                                <i class="fas fa-stopwatch mr-1"></i>
                                <span class="task-timer-display" data-id="${task.id}">${workTimeDisplay}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="mt-4 pt-3 border-t flex justify-between">
                    <!-- Status toggle -->
                    <button class="task-complete-toggle px-3 py-1 rounded-md text-sm" data-id="${task.id}">
                        ${task.status === 'completed' ? 
                            '<i class="fas fa-check-circle mr-1 text-green-500"></i> Completed' : 
                            '<i class="far fa-circle mr-1"></i> Mark Complete'}
                    </button>
                    
                    <!-- Action buttons -->
                    <div class="flex space-x-2">
                        <!-- Timer button -->
                        <button class="task-timer-btn p-2 rounded-full text-white ${taskTimers[task.id]?.running ? 'bg-red-500' : 'bg-green-500'}" data-id="${task.id}">
                            <i class="fas ${taskTimers[task.id]?.running ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        
                        <!-- Share button -->
                        <button class="task-share-btn p-2 rounded-full bg-blue-500 text-white" data-id="${task.id}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        
                        <!-- Edit button -->
                        <button class="task-edit-btn p-2 rounded-full bg-yellow-500 text-white" data-id="${task.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        
                        <!-- Delete button -->
                        <button class="task-delete-btn p-2 rounded-full bg-red-500 text-white" data-id="${task.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            taskElement.innerHTML = taskMarkup;
            
            // Make the task draggable
            taskElement.draggable = true;
            taskElement.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', task.id);
                taskElement.classList.add('task-dragging');
            });
            
            taskElement.addEventListener('dragend', () => {
                taskElement.classList.remove('task-dragging');
            });
            
            return taskElement;
        }
        
        // Chart Functions
        let charts = {};
        
        function updateCharts() {
            if (appState.viewMode !== 'graph') return;
            
            // First, destroy any existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // Status pie chart
            const statusCtx = document.getElementById('status-chart').getContext('2d');
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const pendingTasks = totalTasks - completedTasks;
            
            // Get current mode for proper chart colors
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#f3f4f6' : '#1f2937';
            
            charts.statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completedTasks, pendingTasks],
                        backgroundColor: ['#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = ((value / totalTasks) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Priority chart
            const priorityCtx = document.getElementById('priority-chart').getContext('2d');
            const highPriority = tasks.filter(task => task.priority === 'high').length;
            const mediumPriority = tasks.filter(task => task.priority === 'medium').length;
            const lowPriority = tasks.filter(task => task.priority === 'low').length;
            
            charts.priorityChart = new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [highPriority, mediumPriority, lowPriority],
                        backgroundColor: ['#ef4444', '#f59e0b', '#9ca3af'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 20,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = ((value / totalTasks) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Weekly trend chart
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            
            // Get dates for the last 7 days
            const dateLabels = [];
            const completedData = [];
            const createdData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const dateLabel = formatShortDate(date);
                dateLabels.push(dateLabel);
                
                // Count tasks completed on this date
                const completedCount = tasks.filter(task => {
                    if (!task.completedAt) return false;
                    const completedDate = new Date(task.completedAt);
                    return completedDate.getDate() === date.getDate() &&
                           completedDate.getMonth() === date.getMonth() &&
                           completedDate.getFullYear() === date.getFullYear();
                }).length;
                
                // Count tasks created on this date
                const createdCount = tasks.filter(task => {
                    const createdDate = new Date(task.createdAt);
                    return createdDate.getDate() === date.getDate() &&
                           createdDate.getMonth() === date.getMonth() &&
                           createdDate.getFullYear() === date.getFullYear();
                }).length;
                
                completedData.push(completedCount);
                createdData.push(createdCount);
            }
            
            charts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: dateLabels,
                    datasets: [
                        {
                            label: 'Completed',
                            data: completedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Created',
                            data: createdData,
                            borderColor: '#5D5CDE',
                            backgroundColor: 'rgba(93, 92, 222, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor,
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: textColor,
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // Insights Functions
        function updateInsights() {
            // Calculate productivity score
            let productivityScore = 0;
            let previousScore = 0;
            
            const completedTasks = tasks.filter(task => task.status === 'completed');
            const completedOnTime = completedTasks.filter(task => {
                if (!task.dueDate || !task.completedAt) return true; // No due date or completion time
                
                return new Date(task.completedAt) <= new Date(task.dueDate);
            });
            
            if (completedTasks.length > 0) {
                productivityScore = Math.round((completedOnTime.length / completedTasks.length) * 100);
                previousScore = productivityScore - 5; // Mock previous score for demo
            }
            
            document.getElementById('productivity-score').textContent = `${productivityScore}%`;
            
            const scoreTrend = document.getElementById('productivity-trend');
            if (productivityScore > previousScore) {
                scoreTrend.innerHTML = `<i class="fas fa-arrow-up"></i> ${productivityScore - previousScore}%`;
                scoreTrend.className = 'ml-2 text-green-500';
            } else if (productivityScore < previousScore) {
                scoreTrend.innerHTML = `<i class="fas fa-arrow-down"></i> ${previousScore - productivityScore}%`;
                scoreTrend.className = 'ml-2 text-red-500';
            } else {
                scoreTrend.innerHTML = `<i class="fas fa-minus"></i> 0%`;
                scoreTrend.className = 'ml-2 text-gray-500';
            }
            
            // Calculate focus areas
            const focusAreas = document.getElementById('focus-areas');
            focusAreas.innerHTML = '';
            
            const categories = {};
            let totalCategoryTasks = 0;
            
            tasks.forEach(task => {
                if (!categories[task.category]) {
                    categories[task.category] = 0;
                }
                categories[task.category]++;
                totalCategoryTasks++;
            });
            
            // Create focus area items
            if (totalCategoryTasks > 0) {
                Object.entries(categories)
                    .sort((a, b) => b[1] - a[1]) // Sort by count
                    .slice(0, 3) // Top 3
                    .forEach(([category, count]) => {
                        const percentage = Math.round((count / totalCategoryTasks) * 100);
                        const item = document.createElement('li');
                        item.className = 'flex justify-between';
                        item.innerHTML = `
                            <span>${category.charAt(0).toUpperCase() + category.slice(1)}</span>
                            <span class="font-bold">${percentage}%</span>
                        `;
                        focusAreas.appendChild(item);
                    });
            } else {
                focusAreas.innerHTML = `
                    <li class="flex justify-between">
                        <span>No data</span>
                        <span class="font-bold">0%</span>
                    </li>
                `;
            }
            
            // Calculate time analytics
            let avgCompletionTime = 0;
            if (completedTasks.length > 0) {
                const totalWorkTime = completedTasks.reduce((sum, task) => sum + (task.workTime || 0), 0);
                avgCompletionTime = totalWorkTime / completedTasks.length;
            }
            
            document.getElementById('avg-completion-time').textContent = formatHoursMinutes(avgCompletionTime);
            
            // Calculate most productive day
            const dayCount = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            completedTasks.forEach(task => {
                if (!task.completedAt) return;
                
                const completedDay = new Date(task.completedAt).getDay();
                dayCount[completedDay]++;
            });
            
            let mostProductiveDay = 1; // Default to Monday
            let maxCompletions = 0;
            
            Object.entries(dayCount).forEach(([day, count]) => {
                if (count > maxCompletions) {
                    mostProductiveDay = parseInt(day);
                    maxCompletions = count;
                }
            });
            
            document.getElementById('productive-day').textContent = dayNames[mostProductiveDay];
            
            // Calculate tasks per day
            let tasksPerDay = 0;
            if (tasks.length > 0) {
                const oldestTask = tasks.reduce((oldest, task) => {
                    return new Date(task.createdAt) < new Date(oldest.createdAt) ? task : oldest;
                }, tasks[0]);
                
                const oldestDate = new Date(oldestTask.createdAt);
                const now = new Date();
                const daysDiff = Math.max(1, Math.ceil((now - oldestDate) / (1000 * 60 * 60 * 24)));
                
                tasksPerDay = (tasks.length / daysDiff).toFixed(1);
            }
            
            document.getElementById('tasks-per-day').textContent = tasksPerDay;
        }
        
        // Status Timer Functions
        function startStatusTimer(status) {
            // Stop existing timer
            if (statusTimer) {
                clearInterval(statusTimer);
                statusTimer = null;
            }
            
            // Update profile picture border
            updateStatusIndicator(status);
            
            // Initialize timer display
            const timerDisplay = document.getElementById('work-timer');
            const mobileTimerDisplay = document.getElementById('mobile-work-timer');
            
            // Get current time records from localStorage
            let timerData = getUserTimerData();
            
            if (!timerData[status]) {
                timerData[status] = {
                    total: 0,
                    lastStarted: new Date().getTime()
                };
            } else {
                timerData[status].lastStarted = new Date().getTime();
            }
            
            // Save initial timer data
            setUserTimerData(timerData);
            
            // Update timer display
            updateTimerDisplay(status, timerData);
            
            // Start interval
            statusTimer = setInterval(() => {
                updateTimerDisplay(status, timerData);
            }, 1000);
        }
        
        function updateStatusIndicator(status) {
            const profilePic = document.getElementById('profile-picture');
            const picPreview = document.getElementById('profile-pic-preview');
            
            // Remove existing status classes
            profilePic.classList.remove('status-green', 'status-grey', 'status-yellow', 'status-red');
            if (picPreview) {
                picPreview.classList.remove('status-green', 'status-grey', 'status-yellow', 'status-red');
            }
            
            // Add new status class
            switch (status) {
                case 'login':
                    profilePic.classList.add('status-green');
                    if (picPreview) picPreview.classList.add('status-green');
                    break;
                case 'shadow':
                    profilePic.classList.add('status-grey');
                    if (picPreview) picPreview.classList.add('status-grey');
                    break;
                case 'break':
                    profilePic.classList.add('status-yellow');
                    if (picPreview) picPreview.classList.add('status-yellow');
                    break;
                case 'logout':
                    profilePic.classList.add('status-red');
                    if (picPreview) picPreview.classList.add('status-red');
                    break;
            }
            
            // Update timer display color
            const timerDisplay = document.getElementById('work-timer');
            const mobileTimerDisplay = document.getElementById('mobile-work-timer');
            
            timerDisplay.classList.remove('timer-green', 'timer-grey', 'timer-yellow', 'timer-red');
            mobileTimerDisplay.classList.remove('timer-green', 'timer-grey', 'timer-yellow', 'timer-red');
            
            switch (status) {
                case 'login':
                    timerDisplay.classList.add('timer-green');
                    mobileTimerDisplay.classList.add('timer-green');
                    break;
                case 'shadow':
                    timerDisplay.classList.add('timer-grey');
                    mobileTimerDisplay.classList.add('timer-grey');
                    break;
                case 'break':
                    timerDisplay.classList.add('timer-yellow');
                    mobileTimerDisplay.classList.add('timer-yellow');
                    break;
                case 'logout':
                    timerDisplay.classList.add('timer-red');
                    mobileTimerDisplay.classList.add('timer-red');
                    break;
            }
        }
        
        function updateTimerDisplay(status, timerData) {
            const now = new Date().getTime();
            let elapsed = Math.floor((now - timerData[status].lastStarted) / 1000) + timerData[status].total;
            
            const hours = Math.floor(elapsed / 3600);
            elapsed %= 3600;
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            document.getElementById('work-timer').textContent = timeString;
            document.getElementById('mobile-work-timer').textContent = timeString;
        }
        
        function getUserTimerData() {
            if (!currentUser) return {};
            
            const key = `todoAppTimer_${currentUser.id}`;
            const storedData = localStorage.getItem(key);
            
            if (storedData) {
                try {
                    return JSON.parse(storedData);
                } catch (e) {
                    return {};
                }
            }
            
            return {};
        }
        
        function setUserTimerData(data) {
            if (!currentUser) return;
            
            const key = `todoAppTimer_${currentUser.id}`;
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        function saveUserTimerData() {
            if (!currentUser || !statusTimer) return;
            
            const timerData = getUserTimerData();
            const currentStatus = getCurrentStatus();
            
            if (currentStatus && timerData[currentStatus]) {
                const now = new Date().getTime();
                const elapsed = Math.floor((now - timerData[currentStatus].lastStarted) / 1000);
                
                timerData[currentStatus].total += elapsed;
                timerData[currentStatus].lastStarted = now;
                
                setUserTimerData(timerData);
            }
        }
        
        function getCurrentStatus() {
            const profilePic = document.getElementById('profile-picture');
            
            if (profilePic.classList.contains('status-green')) return 'login';
            if (profilePic.classList.contains('status-grey')) return 'shadow';
            if (profilePic.classList.contains('status-yellow')) return 'break';
            if (profilePic.classList.contains('status-red')) return 'logout';
            
            return 'login'; // Default
        }
        
        function changeStatus(status) {
            // Save current timer data
            saveUserTimerData();
            
            // Start new timer with the selected status
            startStatusTimer(status);
            
            // If status is logout, return to login page
            if (status === 'logout') {
                logoutUser();
            }
        }
        
        // Profile Functions
        function openProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('profile-modal-name').textContent = currentUser.name;
            document.getElementById('profile-modal-role').textContent = currentUser.role;
            
            document.getElementById('profile-pic-preview').src = currentUser.profilePic;
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-password').value = ''; // Don't show password
            
            const countrySelect = document.getElementById('profile-country');
            populateCountries();
            if (currentUser.country) {
                countrySelect.value = currentUser.country;
            }
            
            document.getElementById('profile-role').value = currentUser.role;
            
            document.getElementById('profile-modal').classList.remove('hidden');
        }
        
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
        }
        
        function saveProfile() {
            if (!currentUser) return;
            
            // Get form data
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            const password = document.getElementById('profile-password').value;
            const country = document.getElementById('profile-country').value;
            const profilePic = document.getElementById('profile-pic-preview').src;
            
            // Validate required fields
            if (!name || !email) {
                alert('Name and email are required');
                return;
            }
            
            // Check if email is already in use by another user
            if (email !== currentUser.email && users.some(user => user.email === email && user.id !== currentUser.id)) {
                alert('Email is already in use by another user');
                return;
            }
            
            // Update user data
            const userIndex = users.findIndex(user => user.id === currentUser.id);
            if (userIndex === -1) return;
            
            users[userIndex] = {
                ...users[userIndex],
                name,
                email,
                phone,
                country,
                profilePic
            };
            
            // Update password if provided
            if (password) {
                users[userIndex].password = password;
            }
            
            // Update current user
            currentUser = { ...users[userIndex] };
            localStorage.setItem('todoAppCurrentUser', JSON.stringify(currentUser));
            
            // Update UI
            updateProfileUI();
            
            // Save data
            saveData();
            
            // Close modal
            closeProfileModal();
        }
        
        // Import/Export Functions
        function openImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            document.getElementById('selected-filename').textContent = '';
            document.getElementById('import-replace').checked = false;
            document.getElementById('import-tasks-btn').disabled = true;
            document.getElementById('import-file').value = '';
        }
        
        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
        }
        
        function importTasks() {
            const fileInput = document.getElementById('import-file');
            const replaceExisting = document.getElementById('import-replace').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select a file to import');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedTasks = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedTasks)) {
                        throw new Error('Invalid file format');
                    }
                    
                    // Validate tasks
                    const validTasks = importedTasks.filter(task => {
                        return task && typeof task === 'object' && task.title && typeof task.title === 'string';
                    });
                    
                    if (validTasks.length === 0) {
                        alert('No valid tasks found in the file');
                        return;
                    }
                    
                    // Save action for undo
                    saveAction({
                        type: 'import',
                        previousState: [...tasks]
                    });
                    
                    // Add or replace tasks
                    if (replaceExisting) {
                        tasks = validTasks;
                    } else {
                        tasks = [...tasks, ...validTasks];
                    }
                    
                    saveData();
                    refreshTasksDisplay();
                    updateTaskCounts();
                    updateCharts();
                    updateInsights();
                    updateUpcomingDeadlines();
                    
                    alert(`Successfully imported ${validTasks.length} tasks`);
                    closeImportModal();
                } catch (error) {
                    alert('Error importing tasks: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }
        
        function openExportModal() {
            document.getElementById('export-modal').classList.remove('hidden');
        }
        
        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }
        
        function exportTasks(format) {
            if (tasks.length === 0) {
                alert('No tasks to export');
                closeExportModal();
                return;
            }
            
            if (format === 'json') {
                const jsonData = JSON.stringify(tasks, null, 2);
                
                // Display in a modal
                document.getElementById('export-display-content').textContent = jsonData;
                document.getElementById('export-display-modal').classList.remove('hidden');
                closeExportModal();
            } else if (format === 'text') {
                let textData = 'TASK LIST\n\n';
                
                tasks.forEach((task, index) => {
                    textData += `${index + 1}. ${task.title}\n`;
                    textData += `   Status: ${task.status === 'completed' ? 'Completed' : 'Active'}\n`;
                    textData += `   Priority: ${task.priority}\n`;
                    
                    if (task.dueDate) {
                        textData += `   Due Date: ${formatDate(new Date(task.dueDate))}\n`;
                    }
                    
                    if (task.description) {
                        textData += `   Description: ${task.description}\n`;
                    }
                    
                    if (task.subtasks && task.subtasks.length > 0) {
                        textData += '   Subtasks:\n';
                        task.subtasks.forEach((subtask, subIndex) => {
                            textData += `     ${subIndex + 1}. [${subtask.completed ? 'x' : ' '}] ${subtask.title}\n`;
                        });
                    }
                    
                    textData += '\n';
                });
                
                // Display in a modal
                document.getElementById('export-display-content').textContent = textData;
                document.getElementById('export-display-modal').classList.remove('hidden');
                closeExportModal();
            } else if (format === 'display') {
                let htmlData = '<div class="space-y-4">';
                
                tasks.forEach(task => {
                    htmlData += `
                        <div class="p-4 border rounded-lg">
                            <h3 class="text-lg font-bold ${task.status === 'completed' ? 'line-through text-green-500' : ''}">${task.title}</h3>
                            
                            <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <span class="font-medium">Status:</span> 
                                    <span class="${task.status === 'completed' ? 'text-green-500' : 'text-yellow-500'}">${task.status === 'completed' ? 'Completed' : 'Active'}</span>
                                </div>
                                
                                <div>
                                    <span class="font-medium">Priority:</span> 
                                    <span class="${
                                        task.priority === 'high' ? 'text-red-500' : 
                                        task.priority === 'medium' ? 'text-yellow-500' : 
                                        'text-gray-500'
                                    }">${task.priority}</span>
                                </div>
                                
                                ${task.dueDate ? `
                                <div>
                                    <span class="font-medium">Due Date:</span> 
                                    <span>${formatDate(new Date(task.dueDate))}</span>
                                </div>
                                ` : ''}
                                
                                <div>
                                    <span class="font-medium">Category:</span> 
                                    <span>${task.category}</span>
                                </div>
                            </div>
                            
                            ${task.description ? `
                            <div class="mt-2">
                                <span class="font-medium">Description:</span>
                                <p class="mt-1">${task.description}</p>
                            </div>
                            ` : ''}
                            
                            ${task.subtasks && task.subtasks.length > 0 ? `
                            <div class="mt-2">
                                <span class="font-medium">Subtasks:</span>
                                <ul class="mt-1 space-y-1">
                                    ${task.subtasks.map(subtask => `
                                        <li class="flex items-center">
                                            <span class="mr-2">${subtask.completed ? '✓' : '○'}</span>
                                            <span class="${subtask.completed ? 'line-through text-green-500' : ''}">${subtask.title}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                htmlData += '</div>';
                
                // Display in a modal
                document.getElementById('export-display-content').innerHTML = htmlData;
                document.getElementById('export-display-modal').classList.remove('hidden');
                closeExportModal();
            }
        }
        
        function closeExportDisplayModal() {
            document.getElementById('export-display-modal').classList.add('hidden');
        }
        
        // Users Modal Functions
        function openUsersModal() {
            const container = document.getElementById('users-container');
            container.innerHTML = '';
            
            // Reset search
            document.getElementById('user-search').value = '';
            
            // Get random users (excluding current user)
            let otherUsers = [...users].filter(user => user.id !== currentUser?.id);
            
            if (otherUsers.length === 0) {
                container.innerHTML = '<p class="text-center p-4">No other users found</p>';
            } else {
                otherUsers.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card flex items-center p-3 border rounded-lg';
                    
                    userCard.innerHTML = `
                        <img src="${user.profilePic}" alt="${user.name}" class="w-12 h-12 rounded-full mr-3 object-cover border">
                        <div>
                            <h4 class="user-name font-medium">${user.name}</h4>
                            <p class="user-email text-sm text-gray-500">${user.email}</p>
                            <p class="text-xs text-gray-500">${user.role}</p>
                        </div>
                    `;
                    
                    container.appendChild(userCard);
                });
            }
            
            document.getElementById('users-modal').classList.remove('hidden');
        }
        
        function closeUsersModal() {
            document.getElementById('users-modal').classList.add('hidden');
        }
        
        // Undo/Redo Functions
        function saveAction(action) {
            // Clear redo stack when a new action is performed
            if (currentHistoryIndex < actionsHistory.length - 1) {
                actionsHistory = actionsHistory.slice(0, currentHistoryIndex + 1);
            }
            
            actionsHistory.push(action);
            currentHistoryIndex = actionsHistory.length - 1;
            
            updateUndoRedoButtons();
        }
        
        function undoAction() {
            if (currentHistoryIndex < 0) return;
            
            const action = actionsHistory[currentHistoryIndex];
            
            switch (action.type) {
                case 'add':
                    // Remove the added task
                    tasks = tasks.filter(task => task.id !== action.taskId);
                    break;
                    
                case 'edit':
                    // Restore previous state
                    const editIndex = tasks.findIndex(task => task.id === action.taskId);
                    if (editIndex !== -1) {
                        tasks[editIndex] = { ...action.previousState };
                    }
                    break;
                    
                case 'delete':
                    // Restore deleted task
                    tasks.push({ ...action.previousState });
                    break;
                    
                case 'toggle-completion':
                    // Restore previous state
                    const toggleIndex = tasks.findIndex(task => task.id === action.taskId);
                    if (toggleIndex !== -1) {
                        tasks[toggleIndex] = { ...action.previousState };
                    }
                    break;
                    
                case 'complete-batch':
                    // Restore previous states for all tasks
                    action.previousStates.forEach(prevState => {
                        const taskIndex = tasks.findIndex(task => task.id === prevState.id);
                        if (taskIndex !== -1) {
                            tasks[taskIndex] = { ...prevState };
                        }
                    });
                    break;
                    
                case 'delete-batch':
                    // Restore all deleted tasks
                    tasks = [...tasks, ...action.previousStates];
                    break;
                    
                case 'import':
                    // Restore tasks before import
                    tasks = [...action.previousState];
                    break;
            }
            
            currentHistoryIndex--;
            saveData();
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
            updateUndoRedoButtons();
        }
        
        function redoAction() {
            if (currentHistoryIndex >= actionsHistory.length - 1) return;
            
            currentHistoryIndex++;
            const action = actionsHistory[currentHistoryIndex];
            
            switch (action.type) {
                case 'add':
                    // Re-add the task
                    tasks.push({ ...action.newState });
                    break;
                    
                case 'edit':
                    // Apply the edit again
                    const editIndex = tasks.findIndex(task => task.id === action.taskId);
                    if (editIndex !== -1) {
                        tasks[editIndex] = { ...action.newState };
                    }
                    break;
                    
                case 'delete':
                    // Delete the task again
                    tasks = tasks.filter(task => task.id !== action.taskId);
                    break;
                    
                case 'toggle-completion':
                    // Apply the toggle again
                    const toggleIndex = tasks.findIndex(task => task.id === action.taskId);
                    if (toggleIndex !== -1) {
                        tasks[toggleIndex] = { ...action.newState };
                    }
                    break;
                    
                case 'complete-batch':
                    // Complete tasks again
                    action.taskIds.forEach(id => {
                        const taskIndex = tasks.findIndex(task => task.id === id);
                        if (taskIndex !== -1 && tasks[taskIndex].status !== 'completed') {
                            tasks[taskIndex].status = 'completed';
                            tasks[taskIndex].completedAt = new Date().toISOString();
                        }
                    });
                    break;
                    
                case 'delete-batch':
                    // Delete tasks again
                    tasks = tasks.filter(task => !action.taskIds.includes(task.id));
                    break;
                    
                case 'import':
                    // Re-apply import (we can't actually redo this without saving the imported tasks)
                    // This is a limitation in our implementation
                    break;
            }
            
            saveData();
            refreshTasksDisplay();
            updateTaskCounts();
            updateCharts();
            updateInsights();
            updateUpcomingDeadlines();
            updateUndoRedoButtons();
        }
        
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            undoBtn.disabled = currentHistoryIndex < 0;
            redoBtn.disabled = currentHistoryIndex >= actionsHistory.length - 1;
            
            // Update button appearance
            if (undoBtn.disabled) {
                undoBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                undoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (redoBtn.disabled) {
                redoBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                redoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // View Mode Functions
        function setViewMode(mode) {
            appState.viewMode = mode;
            
            // Update buttons
            document.getElementById('list-view-btn').classList.toggle('active', mode === 'list');
            document.getElementById('list-view-btn').classList.toggle('bg-gray-200', mode === 'list');
            document.getElementById('list-view-btn').classList.toggle('bg-gray-100', mode !== 'list');
            document.getElementById('list-view-btn').classList.toggle('dark:bg-gray-700', mode === 'list');
            document.getElementById('list-view-btn').classList.toggle('dark:bg-gray-600', mode !== 'list');
            
            document.getElementById('graph-view-btn').classList.toggle('active', mode === 'graph');
            document.getElementById('graph-view-btn').classList.toggle('bg-gray-200', mode === 'graph');
            document.getElementById('graph-view-btn').classList.toggle('bg-gray-100', mode !== 'graph');
            document.getElementById('graph-view-btn').classList.toggle('dark:bg-gray-700', mode === 'graph');
            document.getElementById('graph-view-btn').classList.toggle('dark:bg-gray-600', mode !== 'graph');
            
            // Show/hide views
            document.getElementById('list-view').classList.toggle('hidden', mode !== 'list');
            document.getElementById('graph-view').classList.toggle('hidden', mode !== 'graph');
        }
        
        // Data Storage Functions
        function loadData() {
            // Load users
            const storedUsers = localStorage.getItem('todoAppUsers');
            if (storedUsers) {
                try {
                    users = JSON.parse(storedUsers);
                } catch (e) {
                    users = [];
                }
            }
            
            // Load tasks
            const storedTasks = localStorage.getItem('todoAppTasks');
            if (storedTasks) {
                try {
                    tasks = JSON.parse(storedTasks);
                } catch (e) {
                    tasks = [];
                }
            }
            
            // If no users exist, create a demo user
            if (users.length === 0) {
                users = [
                    {
                        id: 'demo-user',
                        name: 'Demo User',
                        email: 'demo@example.com',
                        password: 'password',
                        phone: '+1234567890',
                        country: 'United States',
                        role: 'Manager',
                        profilePic: generateRandomAvatar('Demo User'),
                        createdAt: new Date().toISOString()
                    }
                ];
                
                // Create demo tasks
                generateDemoTasks('demo-user');
                
                saveData();
            }
        }
        
        function saveData() {
            // Save users
            localStorage.setItem('todoAppUsers', JSON.stringify(users));
            
            // Save tasks
            localStorage.setItem('todoAppTasks', JSON.stringify(tasks));
        }
        
        // Utility Functions
        function generateId() {
            return 'id_' + Math.random().toString(36).substring(2, 11);
        }
        
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        function formatShortDate(date) {
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        
        function formatRelativeDate(date) {
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                if (diffHours === 0) {
                    const diffMinutes = Math.floor(diffTime / (1000 * 60));
                    return diffMinutes === 0 ? 'Just now' : `${diffMinutes}m ago`;
                }
                return `${diffHours}h ago`;
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return formatDate(date);
            }
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function formatHoursMinutes(seconds) {
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const minutes = Math.floor(seconds / 60);
            
            if (hours === 0) {
                return `${minutes}m`;
            } else {
                return `${hours}h ${minutes}m`;
            }
        }
        
        function debounce(func, delay) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        
        function generateRandomAvatar(name) {
            // Use the name to generate a consistent avatar
            const colors = [
                '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5',
                '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50',
                '#8BC34A', '#CDDC39', '#FFC107', '#FF9800', '#FF5722'
            ];
            
            // Use the name to select a consistent color
            const charSum = name.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0);
            const color = colors[charSum % colors.length];
            
            // Create canvas to generate avatar
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // Draw background
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw initials
            ctx.fillStyle = 'white';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Get initials (first letter of first and last name)
            const nameParts = name.split(' ');
            let initials = nameParts[0][0].toUpperCase();
            
            if (nameParts.length > 1) {
                initials += nameParts[nameParts.length - 1][0].toUpperCase();
            }
            
            ctx.fillText(initials, canvas.width / 2, canvas.height / 2);
            
            return canvas.toDataURL('image/png');
        }
        
        function populateCountries() {
            const countrySelects = document.querySelectorAll('#register-country, #profile-country');
            
            const countries = [
                'Afghanistan', 'Albania', 'Algeria', 'Andorra', 'Angola', 'Antigua and Barbuda', 'Argentina', 'Armenia', 'Australia', 'Austria',
                'Azerbaijan', 'Bahamas', 'Bahrain', 'Bangladesh', 'Barbados', 'Belarus', 'Belgium', 'Belize', 'Benin', 'Bhutan',
                'Bolivia', 'Bosnia and Herzegovina', 'Botswana', 'Brazil', 'Brunei', 'Bulgaria', 'Burkina Faso', 'Burundi', 'Cabo Verde', 'Cambodia',
                'Cameroon', 'Canada', 'Central African Republic', 'Chad', 'Chile', 'China', 'Colombia', 'Comoros', 'Congo', 'Costa Rica',
                'Croatia', 'Cuba', 'Cyprus', 'Czech Republic', 'Denmark', 'Djibouti', 'Dominica', 'Dominican Republic', 'Ecuador', 'Egypt',
                'El Salvador', 'Equatorial Guinea', 'Eritrea', 'Estonia', 'Eswatini', 'Ethiopia', 'Fiji', 'Finland', 'France', 'Gabon',
                'Gambia', 'Georgia', 'Germany', 'Ghana', 'Greece', 'Grenada', 'Guatemala', 'Guinea', 'Guinea-Bissau', 'Guyana',
                'Haiti', 'Honduras', 'Hungary', 'Iceland', 'India', 'Indonesia', 'Iran', 'Iraq', 'Ireland', 'Israel',
                'Italy', 'Jamaica', 'Japan', 'Jordan', 'Kazakhstan', 'Kenya', 'Kiribati', 'Korea, North', 'Korea, South', 'Kosovo',
                'Kuwait', 'Kyrgyzstan', 'Laos', 'Latvia', 'Lebanon', 'Lesotho', 'Liberia', 'Libya', 'Liechtenstein', 'Lithuania',
                'Luxembourg', 'Madagascar', 'Malawi', 'Malaysia', 'Maldives', 'Mali', 'Malta', 'Marshall Islands', 'Mauritania', 'Mauritius',
                'Mexico', 'Micronesia', 'Moldova', 'Monaco', 'Mongolia', 'Montenegro', 'Morocco', 'Mozambique', 'Myanmar', 'Namibia',
                'Nauru', 'Nepal', 'Netherlands', 'New Zealand', 'Nicaragua', 'Niger', 'Nigeria', 'North Macedonia', 'Norway', 'Oman',
                'Pakistan', 'Palau', 'Palestine', 'Panama', 'Papua New Guinea', 'Paraguay', 'Peru', 'Philippines', 'Poland', 'Portugal',
                'Qatar', 'Romania', 'Russia', 'Rwanda', 'Saint Kitts and Nevis', 'Saint Lucia', 'Saint Vincent and the Grenadines', 'Samoa', 'San Marino', 'Sao Tome and Principe',
                'Saudi Arabia', 'Senegal', 'Serbia', 'Seychelles', 'Sierra Leone', 'Singapore', 'Slovakia', 'Slovenia', 'Solomon Islands', 'Somalia',
                'South Africa', 'South Sudan', 'Spain', 'Sri Lanka', 'Sudan', 'Suriname', 'Sweden', 'Switzerland', 'Syria', 'Taiwan',
                'Tajikistan', 'Tanzania', 'Thailand', 'Timor-Leste', 'Togo', 'Tonga', 'Trinidad and Tobago', 'Tunisia', 'Turkey', 'Turkmenistan',
                'Tuvalu', 'Uganda', 'Ukraine', 'United Arab Emirates', 'United Kingdom', 'United States', 'Uruguay', 'Uzbekistan', 'Vanuatu', 'Vatican City',
                'Venezuela', 'Vietnam', 'Yemen', 'Zambia', 'Zimbabwe'
            ];
            
            countrySelects.forEach(select => {
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add country options
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    select.appendChild(option);
                });
            });
        }
    </script>
</body>
</html>
