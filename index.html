<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* Custom Styles */
        :root {
            --primary-light: #60a5fa; /* blue-400 */
            --primary-dark: #3b82f6;  /* blue-600 */
            --secondary-light: #f3f4f6; /* gray-100 */
            --secondary-dark: #1f2937;  /* gray-800 */
            --text-light: #111827; /* gray-900 */
            --text-dark: #f9fafb; /* gray-50 */
            --accent-green: #10b981; /* emerald-500 */
            --accent-yellow: #f59e0b; /* amber-500 */
            --accent-red: #ef4444; /* red-500 */
            --accent-gray: #6b7280; /* gray-500 */
            --border-light: #e5e7eb; /* gray-200 */
            --border-dark: #4b5563; /* gray-600 */
        }

        .light {
            --primary-bg: white;
            --secondary-bg: var(--secondary-light);
            --text-color: var(--text-light);
            --border-color: var(--border-light);
            --primary-accent: var(--primary-light);
        }

        .dark {
            --primary-bg: #111827; /* gray-900 */
            --secondary-bg: var(--secondary-dark);
            --text-color: var(--text-dark);
            --border-color: var(--border-dark);
            --primary-accent: var(--primary-dark);
        }

        body {
            font-family: 'Inter', sans-serif; /* Assuming Inter is available or loaded */
            background-color: var(--primary-bg);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: var(--primary-bg);
            color: var(--text-color);
        }

        /* Styling for Flatpickr calendar in dark mode */
        .dark .flatpickr-calendar {
            background: var(--secondary-dark);
            border-color: var(--border-dark);
            box-shadow: 0 3px 13px rgba(0, 0, 0, 0.3);
        }
        .dark .flatpickr-day {
            color: var(--text-dark);
        }
        .dark .flatpickr-day:hover,
        .dark .flatpickr-day:focus {
            background: var(--border-dark);
            color: var(--text-dark);
        }
        .dark .flatpickr-day.selected,
        .dark .flatpickr-day.startRange,
        .dark .flatpickr-day.endRange,
        .dark .flatpickr-day.selected:hover,
        .dark .flatpickr-day.startRange:hover,
        .dark .flatpickr-day.endRange:hover {
            background: var(--primary-accent);
            border-color: var(--primary-accent);
            color: white;
        }
        .dark .flatpickr-weekday {
            color: var(--accent-gray);
        }
        .dark .flatpickr-month,
        .dark .flatpickr-current-month .flatpickr-monthDropdown-months,
        .dark .numInputWrapper .numInput {
            color: var(--text-dark);
        }
        .dark .flatpickr-current-month input.cur-year {
             color: var(--text-dark);
        }
        .dark .flatpickr-prev-month,
        .dark .flatpickr-next-month {
            fill: var(--text-dark);
        }
        .dark .flatpickr-prev-month:hover svg,
        .dark .flatpickr-next-month:hover svg {
            fill: var(--primary-accent);
        }

        /* Custom scrollbar for task list (optional) */
        #task-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #task-list-container::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 10px;
        }
        #task-list-container::-webkit-scrollbar-thumb {
            background-color: var(--accent-gray);
            border-radius: 10px;
            border: 2px solid var(--secondary-bg);
        }
        .dark #task-list-container::-webkit-scrollbar-thumb {
             background-color: var(--border-dark);
             border: 2px solid var(--secondary-bg);
        }

        /* Task item hover effect */
        .task-item:hover {
            background-color: var(--secondary-bg);
        }
        .dark .task-item:hover {
             background-color: var(--secondary-dark);
        }

        /* Dragging styles */
        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--primary-accent) !important; /* Force background */
        }
        .sortable-chosen {
             cursor: grabbing;
        }

        /* Ensure icons render correctly */
        [data-lucide] {
            display: inline-block;
            vertical-align: middle;
        }

        /* Alert styles */
        .alert-blue { background-color: #bfdbfe; color: #1e40af; border-left: 4px solid #3b82f6; }
        .dark .alert-blue { background-color: #1e3a8a; color: #93c5fd; border-left: 4px solid #60a5fa; }
        .alert-green { background-color: #a7f3d0; color: #047857; border-left: 4px solid #10b981; }
        .dark .alert-green { background-color: #064e3b; color: #6ee7b7; border-left: 4px solid #34d399; }
        .alert-yellow { background-color: #fde68a; color: #92400e; border-left: 4px solid #f59e0b; }
        .dark .alert-yellow { background-color: #78350f; color: #fcd34d; border-left: 4px solid #fbbf24; }
        .alert-red { background-color: #fecaca; color: #991b1b; border-left: 4px solid #ef4444; }
        .dark .alert-red { background-color: #7f1d1d; color: #fca5a5; border-left: 4px solid #f87171; }
        .alert-gray { background-color: #e5e7eb; color: #374151; border-left: 4px solid #6b7280; }
        .dark .alert-gray { background-color: #374151; color: #d1d5db; border-left: 4px solid #9ca3af; }

        /* Task priority indicators */
        .priority-high::before { content: ''; display: inline-block; width: 10px; height: 10px; background-color: var(--accent-red); border-radius: 50%; margin-right: 8px; }
        .priority-medium::before { content: ''; display: inline-block; width: 10px; height: 10px; background-color: var(--accent-yellow); border-radius: 50%; margin-right: 8px; }
        .priority-low::before { content: ''; display: inline-block; width: 10px; height: 10px; background-color: var(--accent-gray); border-radius: 50%; margin-right: 8px; }

        /* Task completion style */
        .task-completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
         .task-completed-bg {
             background-color: rgba(16, 185, 129, 0.1); /* Light green background */
         }
        .dark .task-completed-bg {
             background-color: rgba(16, 185, 129, 0.2); /* Darker green background */
         }

        /* Ensure select dropdown arrows are visible in dark mode */
        .dark select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-color: var(--secondary-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
        .dark select option {
             background-color: var(--secondary-dark);
             color: var(--text-dark);
        }
        .dark input[type='text'],
        .dark input[type='email'],
        .dark input[type='password'],
        .dark input[type='tel'],
        .dark textarea {
            background-color: var(--secondary-dark);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }
         .dark input::placeholder,
         .dark textarea::placeholder {
             color: var(--accent-gray);
         }

         /* Profile picture status border */
        .status-login { border: 3px solid var(--accent-green); }
        .status-logout { border: 3px solid var(--accent-red); }
        .status-break { border: 3px solid var(--accent-yellow); }
        .status-shadow { border: 3px solid var(--accent-gray); }

        /* Timer border */
        .timer-border-login { border: 2px solid var(--accent-green); }
        .timer-border-logout { border: 2px solid var(--accent-red); }
        .timer-border-break { border: 2px solid var(--accent-yellow); }
        .timer-border-shadow { border: 2px solid var(--accent-gray); }

        /* Hide scrollbar for number input */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

    </style>
</head>
<body class="bg-[var(--primary-bg)] text-[var(--text-color)] transition-colors duration-300">

    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-[var(--secondary-bg)] p-8 rounded-lg shadow-lg border border-[var(--border-color)]">
            <h2 class="text-2xl font-bold mb-6 text-center text-[var(--primary-accent)]">To-Do APP - Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="login-email" name="email" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="login-password" name="password" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                 <p id="login-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <button type="submit" class="w-full bg-[var(--primary-accent)] text-white py-2 rounded-md hover:bg-opacity-90 transition duration-200">Login</button>
            </form>
            <p class="mt-6 text-center text-sm">
                Don't have an account?
                <button id="show-register-btn" class="text-[var(--primary-accent)] hover:underline">Register here</button>
            </p>
        </div>
    </div>

    <div id="register-page" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-lg bg-[var(--secondary-bg)] p-8 rounded-lg shadow-lg border border-[var(--border-color)]">
            <h2 class="text-2xl font-bold mb-6 text-center text-[var(--primary-accent)]">Register New Account</h2>
            <form id="register-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="register-name" class="block text-sm font-medium mb-1">Name</label>
                        <input type="text" id="register-name" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="register-email" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-confirm-email" class="block text-sm font-medium mb-1">Confirm Email</label>
                        <input type="email" id="register-confirm-email" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="register-password" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-confirm-password" class="block text-sm font-medium mb-1">Confirm Password</label>
                        <input type="password" id="register-confirm-password" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-phone" class="block text-sm font-medium mb-1">Phone Number</label>
                        <input type="tel" id="register-phone" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                    <div class="mb-4">
                        <label for="register-country" class="block text-sm font-medium mb-1">Country</label>
                        <select id="register-country" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] appearance-none">
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="register-role" class="block text-sm font-medium mb-1">Role</label>
                        <select id="register-role" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] appearance-none">
                            <option value="Customer">Customer</option>
                            <option value="Staff">Staff</option>
                            <option value="Manager">Manager</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <p id="register-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="mt-6 flex justify-end space-x-3">
                     <button type="button" id="cancel-register-btn" class="px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200">Cancel</button>
                     <button type="submit" class="px-4 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90 transition duration-200">Register</button>
                </div>
            </form>
        </div>
    </div>

    <div id="app-page" class="flex flex-col h-screen hidden">
        <header class="bg-[var(--secondary-bg)] shadow-md px-4 py-2 border-b border-[var(--border-color)]">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span data-lucide="check-square" class="text-[var(--primary-accent)]"></span>
                    <span class="text-lg font-bold">To-Do APP</span>
                </div>

                <div class="flex items-center space-x-4">
                     <div id="work-timer-display" class="text-sm font-medium p-2 rounded-md border-2 timer-border-logout">
                        <span id="work-timer-status" class="font-semibold">Logged Out:</span>
                        <span id="work-timer-value">00:00:00</span>
                    </div>

                    <button id="theme-switcher" class="p-2 rounded-full hover:bg-[var(--border-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-accent)] focus:ring-offset-[var(--secondary-bg)]">
                        <span id="theme-icon-sun" data-lucide="sun" class="hidden"></span>
                        <span id="theme-icon-moon" data-lucide="moon"></span>
                    </button>

                    <button class="relative p-2 rounded-full hover:bg-[var(--border-color)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-accent)] focus:ring-offset-[var(--secondary-bg)]">
                        <span data-lucide="bell"></span>
                        <span id="notification-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
                        </button>

                    <div class="relative">
                        <button id="profile-dropdown-btn" class="flex items-center focus:outline-none">
                            <img id="profile-picture" src="https://placehold.co/40x40/cccccc/ffffff?text=P" alt="Profile" class="w-10 h-10 rounded-full object-cover status-logout">
                        </button>
                        <div id="profile-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-[var(--primary-bg)] rounded-md shadow-lg py-1 border border-[var(--border-color)] hidden z-50">
                            <div class="relative group">
                                <button class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)] flex justify-between items-center">
                                    Status <span data-lucide="chevron-right" class="w-4 h-4"></span>
                                </button>
                                <div class="absolute left-full top-0 mt-[-1px] w-40 bg-[var(--primary-bg)] rounded-md shadow-lg py-1 border border-[var(--border-color)] hidden group-hover:block">
                                    <button class="status-option block w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)]" data-status="login">Login</button>
                                    <button class="status-option block w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)]" data-status="shadow">Shadow</button>
                                    <button class="status-option block w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)]" data-status="break">Break</button>
                                    <button class="status-option block w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)]" data-status="logout">Logout</button>
                                </div>
                            </div>
                            <button id="view-profile-btn" class="block w-full text-left px-4 py-2 text-sm hover:bg-[var(--secondary-bg)]">View Profile</button>
                            <div class="border-t border-[var(--border-color)] my-1"></div>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-[var(--secondary-bg)]">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-6">
            <section id="task-summary" class="space-y-4">
                <div class="p-4 rounded-lg alert-blue">
                    <h3 class="text-lg font-semibold mb-1">Total Tasks</h3>
                    <p id="total-tasks-count" class="text-2xl font-bold">0</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-lg alert-green">
                        <h3 class="text-md font-semibold mb-1">Completed Tasks</h3>
                        <p id="completed-tasks-count" class="text-xl font-bold">0</p>
                    </div>
                    <div class="p-4 rounded-lg alert-yellow">
                        <h3 class="text-md font-semibold mb-1">Pending Tasks</h3>
                        <p id="pending-tasks-count" class="text-xl font-bold">0</p>
                    </div>
                </div>
            </section>

             <section class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
                 <div class="flex flex-wrap justify-center md:justify-start gap-2">
                     <button id="add-task-btn" class="flex items-center px-4 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90 transition duration-200 text-sm">
                        <span data-lucide="plus" class="w-4 h-4 mr-1"></span> Add Task
                    </button>
                     <button id="users-btn" class="flex items-center px-3 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200 text-sm">
                        <span data-lucide="users" class="w-4 h-4 mr-1"></span> Users
                    </button>
                    <button id="export-btn" class="flex items-center px-3 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200 text-sm">
                        <span data-lucide="download" class="w-4 h-4 mr-1"></span> Export
                    </button>
                    <button id="import-btn" class="flex items-center px-3 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200 text-sm">
                        <span data-lucide="upload" class="w-4 h-4 mr-1"></span> Import
                    </button>
                </div>
                <div class="flex items-center space-x-2 bg-[var(--secondary-bg)] p-1 rounded-md border border-[var(--border-color)]">
                    <button id="list-view-btn" class="view-switch-btn px-3 py-1 rounded text-sm bg-[var(--primary-accent)] text-white" data-view="list">
                        <span data-lucide="list" class="w-4 h-4 inline-block"></span> List
                    </button>
                    <button id="graph-view-btn" class="view-switch-btn px-3 py-1 rounded text-sm hover:bg-[var(--border-color)]" data-view="graph">
                        <span data-lucide="bar-chart-2" class="w-4 h-4 inline-block"></span> Graph
                    </button>
                </div>
            </section>

            <section id="tasks-section">
                <div class="mb-4 p-4 bg-[var(--secondary-bg)] rounded-lg border border-[var(--border-color)]">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="search-tasks" class="block text-sm font-medium mb-1">Search Tasks</label>
                            <input type="text" id="search-tasks" placeholder="Search by title or description..." class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] text-sm">
                        </div>
                        <div>
                            <label for="filter-priority" class="block text-sm font-medium mb-1">Priority</label>
                            <select id="filter-priority" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] text-sm appearance-none">
                                <option value="all">All Priorities</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                         <div>
                            <label for="filter-status" class="block text-sm font-medium mb-1">Status</label>
                            <select id="filter-status" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] text-sm appearance-none">
                                <option value="all">All</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div>
                             <label for="filter-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                            <select id="filter-due-date" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] text-sm appearance-none">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                </select>
                        </div>
                         <div class="md:col-span-2 lg:col-span-1">
                            <label for="sort-tasks" class="block text-sm font-medium mb-1">Sort By</label>
                            <select id="sort-tasks" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] text-sm appearance-none">
                                <option value="default">Default Order</option>
                                <option value="priority-desc">Priority (High-Low)</option>
                                <option value="priority-asc">Priority (Low-High)</option>
                                <option value="due-date-asc">Due Date (Soonest)</option>
                                <option value="due-date-desc">Due Date (Latest)</option>
                                <option value="title-asc">Title (A-Z)</option>
                                <option value="title-desc">Title (Z-A)</option>
                            </select>
                        </div>
                        <div id="multi-select-actions" class="hidden md:col-span-2 lg:col-span-3 flex justify-end items-center space-x-2 mt-2 md:mt-0">
                             <span id="selected-count" class="text-sm font-medium mr-2">0 selected</span>
                             <button id="multi-complete-btn" class="px-3 py-1 bg-emerald-500 text-white rounded-md text-xs hover:bg-emerald-600">Mark Complete</button>
                             <button id="multi-delete-btn" class="px-3 py-1 bg-red-500 text-white rounded-md text-xs hover:bg-red-600">Delete</button>
                             <button id="clear-selection-btn" class="px-3 py-1 border border-[var(--border-color)] rounded-md text-xs hover:bg-[var(--secondary-bg)]">Clear</button>
                        </div>
                    </div>
                </div>

                <div id="list-view" class="space-y-3">
                     <h2 class="text-xl font-semibold mb-3">Tasks List</h2>
                     <div id="task-list-container" class="max-h-[50vh] overflow-y-auto pr-2">
                         <ul id="task-list" class="space-y-3">
                             <li class="p-4 border border-[var(--border-color)] rounded-lg bg-[var(--primary-bg)] text-center text-gray-500">No tasks yet. Add one!</li>
                         </ul>
                     </div>
                </div>

                <div id="graph-view" class="hidden space-y-4">
                    <h2 class="text-xl font-semibold mb-3">Tasks Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 bg-[var(--secondary-bg)] rounded-lg border border-[var(--border-color)]">
                            <h3 class="text-lg font-semibold mb-2 text-center">Task Status Distribution</h3>
                            <canvas id="taskStatusChart"></canvas>
                        </div>
                        <div class="p-4 bg-[var(--secondary-bg)] rounded-lg border border-[var(--border-color)]">
                            <h3 class="text-lg font-semibold mb-2 text-center">Tasks by Priority</h3>
                            <canvas id="taskPriorityChart"></canvas>
                        </div>
                         </div>
                </div>
            </section>

            <section id="insights-view" class="mt-8 p-4 bg-[var(--secondary-bg)] rounded-lg border border-[var(--border-color)]">
                <h2 class="text-xl font-semibold mb-3">Insights</h2>
                <p class="text-gray-500 italic">Productivity insights and task completion trends will appear here.</p>
                </section>
        </main>

    </div>

    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 modal">
        <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto modal-content border border-[var(--border-color)]">
            <h2 id="task-modal-title" class="text-xl font-bold mb-4">Add New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id"> <div class="mb-3">
                    <label for="task-title" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="task-title" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                <div class="mb-3">
                    <label for="task-description" class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="task-description" rows="3" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label for="task-priority" class="block text-sm font-medium mb-1">Priority</label>
                        <select id="task-priority" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] appearance-none">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-due-date" class="block text-sm font-medium mb-1">Due Date</label>
                        <input type="text" id="task-due-date" placeholder="Select date" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                    </div>
                </div>
                 <div class="mb-3">
                    <label for="task-subtasks" class="block text-sm font-medium mb-1">Sub-Tasks (comma-separated)</label>
                    <input type="text" id="task-subtasks" placeholder="e.g., Research, Draft, Review" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                <div class="mb-3">
                    <label for="task-assignee" class="block text-sm font-medium mb-1">Assign To</label>
                     <select id="task-assignee" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)] appearance-none">
                        <option value="self">Self</option>
                        </select>
                </div>
                <div class="mb-4">
                    <label for="task-notes" class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="task-notes" rows="2" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-task-btn" class="px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200">Cancel</button>
                    <button type="submit" id="save-task-btn" class="px-4 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90 transition duration-200">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 modal">
        <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-md modal-content border border-[var(--border-color)]">
            <h2 class="text-xl font-bold mb-4">View Profile</h2>
            <form id="profile-form">
                 <div class="flex flex-col items-center mb-4">
                     <img id="profile-modal-picture" src="https://placehold.co/100x100/cccccc/ffffff?text=P" alt="Profile" class="w-24 h-24 rounded-full object-cover mb-2 border-4 border-gray-300">
                     <input type="file" id="profile-picture-upload" class="hidden" accept="image/*">
                     <button type="button" id="change-picture-btn" class="text-sm text-[var(--primary-accent)] hover:underline">Change Picture</button>
                 </div>
                <div class="mb-3">
                    <label for="profile-name" class="block text-sm font-medium mb-1">Name</label>
                    <input type="text" id="profile-name" required class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                <div class="mb-3">
                    <label for="profile-email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="profile-email" required readonly class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md bg-gray-100 dark:bg-gray-700 text-gray-500 cursor-not-allowed">
                </div>
                 <div class="mb-3">
                    <label for="profile-phone" class="block text-sm font-medium mb-1">Phone</label>
                    <input type="tel" id="profile-phone" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                 <div class="mb-3">
                    <label for="profile-role" class="block text-sm font-medium mb-1">Role</label>
                     <input type="text" id="profile-role" readonly class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md bg-gray-100 dark:bg-gray-700 text-gray-500 cursor-not-allowed">
                 </div>
                 <div class="mb-4">
                    <label for="profile-password" class="block text-sm font-medium mb-1">New Password (optional)</label>
                    <input type="password" id="profile-password" placeholder="Leave blank to keep current password" class="w-full px-3 py-2 border border-[var(--border-color)] rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--primary-accent)] bg-[var(--primary-bg)] text-[var(--text-color)]">
                </div>
                <p id="profile-update-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-profile-btn" class="px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200">Cancel</button>
                    <button type="submit" id="save-profile-btn" class="px-4 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90 transition duration-200">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="users-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 modal">
        <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-y-auto modal-content border border-[var(--border-color)]">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold">Users</h2>
                 <button id="close-users-modal-btn" class="p-1 rounded-full hover:bg-[var(--secondary-bg)]">
                     <span data-lucide="x" class="w-5 h-5"></span>
                 </button>
            </div>
            <div id="users-list" class="space-y-3">
                <p class="text-gray-500 italic">Loading users...</p>
            </div>
        </div>
    </div>

     <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 modal">
        <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-sm modal-content border border-[var(--border-color)]">
            <h2 class="text-xl font-bold mb-4">Export Tasks</h2>
            <div class="space-y-3">
                 <p class="text-sm">Select the format to export your tasks:</p>
                 <button class="export-option w-full text-left px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)]" data-format="json">Export as JSON</button>
                 <button class="export-option w-full text-left px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)]" data-format="csv">Export as CSV</button>
                 <button class="export-option w-full text-left px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)]" data-format="txt">Export as TXT</button>
                 <button class="export-option w-full text-left px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)]" data-format="pdf">Export as PDF (Simulated)</button>
                 <button class="export-option w-full text-left px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)]" data-format="docx">Export as DOCX (Simulated)</button>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="cancel-export-btn" class="px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200">Cancel</button>
            </div>
        </div>
    </div>

     <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 modal">
        <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-md modal-content border border-[var(--border-color)]">
            <h2 class="text-xl font-bold mb-4">Import Tasks</h2>
             <form id="import-form">
                 <p class="text-sm mb-3">Select a file to import tasks (JSON format recommended).</p>
                 <input type="file" id="import-file-input" accept=".json,.csv,.txt" required class="w-full text-sm border border-[var(--border-color)] rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-l-md file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-accent)] file:text-white hover:file:bg-opacity-90">
                 <p id="import-status" class="text-sm mt-3"></p>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-import-btn" class="px-4 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] transition duration-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90 transition duration-200">Import</button>
                </div>
            </form>
        </div>
    </div>

    <div id="custom-alert" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60] modal">
         <div class="bg-[var(--primary-bg)] p-6 rounded-lg shadow-xl w-full max-w-sm modal-content border border-[var(--border-color)] text-center">
            <h3 id="custom-alert-title" class="text-lg font-semibold mb-3">Alert</h3>
            <p id="custom-alert-message" class="mb-5">Message goes here.</p>
            <div id="custom-alert-buttons" class="flex justify-center space-x-4">
                <button id="custom-alert-ok" class="px-5 py-2 bg-[var(--primary-accent)] text-white rounded-md hover:bg-opacity-90">OK</button>
                <button id="custom-alert-cancel" class="px-5 py-2 border border-[var(--border-color)] rounded-md hover:bg-[var(--secondary-bg)] hidden">Cancel</button>
            </div>
         </div>
    </div>


    <script>
        // --- Constants and State ---
        const AppState = {
            currentUser: null, // { name, email, phone, country, role, password, profilePic, status: 'logout', statusStartTime: null }
            users: [], // Array of registered user objects
            tasks: [], // Array of task objects { id, title, description, priority, dueDate, completed, createdAt, subtasks: [], assignee, notes, taskTimerRunning: false, taskTimeElapsed: 0, lastStartTime: null }
            currentView: 'list', // 'list' or 'graph'
            theme: 'light', // 'light' or 'dark'
            filters: {
                search: '',
                priority: 'all',
                status: 'all',
                dueDate: 'all'
            },
            sort: 'default',
            selectedTasks: new Set(), // Set of task IDs for multi-select
            workTimerInterval: null,
            workTimers: { // Store elapsed time for each status for the current day
                 login: 0,
                 break: 0,
                 shadow: 0
            },
            lastStatusResetDate: null // To track daily timer reset
        };

        const StatusColors = {
            login: 'var(--accent-green)',
            logout: 'var(--accent-red)',
            break: 'var(--accent-yellow)',
            shadow: 'var(--accent-gray)'
        };

        const StatusClasses = {
            login: 'status-login',
            logout: 'status-logout',
            break: 'status-break',
            shadow: 'status-shadow'
        };

        const TimerBorderClasses = {
            login: 'timer-border-login',
            logout: 'timer-border-logout',
            break: 'timer-border-break',
            shadow: 'timer-border-shadow'
        };

        const PriorityClasses = {
            High: 'priority-high',
            Medium: 'priority-medium',
            Low: 'priority-low'
        };

        const PriorityAlertClasses = {
             High: 'alert-red',
             Medium: 'alert-yellow',
             Low: 'alert-gray'
        };

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const appPage = document.getElementById('app-page');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const cancelRegisterBtn = document.getElementById('cancel-register-btn');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const registerCountrySelect = document.getElementById('register-country');
        const themeSwitcher = document.getElementById('theme-switcher');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');
        const profileDropdownBtn = document.getElementById('profile-dropdown-btn');
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
        const profilePicture = document.getElementById('profile-picture');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const notificationCount = document.getElementById('notification-count'); // Placeholder
        const workTimerDisplay = document.getElementById('work-timer-display');
        const workTimerStatus = document.getElementById('work-timer-status');
        const workTimerValue = document.getElementById('work-timer-value');
        const totalTasksCount = document.getElementById('total-tasks-count');
        const completedTasksCount = document.getElementById('completed-tasks-count');
        const pendingTasksCount = document.getElementById('pending-tasks-count');
        const addTaskBtn = document.getElementById('add-task-btn');
        const usersBtn = document.getElementById('users-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const graphViewBtn = document.getElementById('graph-view-btn');
        const tasksSection = document.getElementById('tasks-section');
        const listView = document.getElementById('list-view');
        const graphView = document.getElementById('graph-view');
        const taskListContainer = document.getElementById('task-list-container');
        const taskList = document.getElementById('task-list');
        const searchInput = document.getElementById('search-tasks');
        const filterPrioritySelect = document.getElementById('filter-priority');
        const filterStatusSelect = document.getElementById('filter-status');
        const filterDueDateSelect = document.getElementById('filter-due-date');
        const sortTasksSelect = document.getElementById('sort-tasks');
        const multiSelectActions = document.getElementById('multi-select-actions');
        const selectedCountSpan = document.getElementById('selected-count');
        const multiCompleteBtn = document.getElementById('multi-complete-btn');
        const multiDeleteBtn = document.getElementById('multi-delete-btn');
        const clearSelectionBtn = document.getElementById('clear-selection-btn');
        // Modals
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const taskModalTitle = document.getElementById('task-modal-title');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const saveTaskBtn = document.getElementById('save-task-btn');
        const taskIdInput = document.getElementById('task-id');
        const taskTitleInput = document.getElementById('task-title');
        const taskDescriptionInput = document.getElementById('task-description');
        const taskPrioritySelect = document.getElementById('task-priority');
        const taskDueDateInput = document.getElementById('task-due-date');
        const taskSubtasksInput = document.getElementById('task-subtasks');
        const taskAssigneeSelect = document.getElementById('task-assignee');
        const taskNotesInput = document.getElementById('task-notes');
        const profileModal = document.getElementById('profile-modal');
        const profileForm = document.getElementById('profile-form');
        const cancelProfileBtn = document.getElementById('cancel-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileModalPicture = document.getElementById('profile-modal-picture');
        const changePictureBtn = document.getElementById('change-picture-btn');
        const profilePictureUpload = document.getElementById('profile-picture-upload');
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileRoleInput = document.getElementById('profile-role');
        const profilePasswordInput = document.getElementById('profile-password');
        const profileUpdateError = document.getElementById('profile-update-error');
        const usersModal = document.getElementById('users-modal');
        const usersListDiv = document.getElementById('users-list');
        const closeUsersModalBtn = document.getElementById('close-users-modal-btn');
        const exportModal = document.getElementById('export-modal');
        const cancelExportBtn = document.getElementById('cancel-export-btn');
        const importModal = document.getElementById('import-modal');
        const importForm = document.getElementById('import-form');
        const importFileInput = document.getElementById('import-file-input');
        const importStatusP = document.getElementById('import-status');
        const cancelImportBtn = document.getElementById('cancel-import-btn');
        const customAlert = document.getElementById('custom-alert');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOk = document.getElementById('custom-alert-ok');
        const customAlertCancel = document.getElementById('custom-alert-cancel');
        // Chart contexts
        let taskStatusChart = null;
        let taskPriorityChart = null;
        // Date picker instance
        let dueDatePicker = null;
        // Sortable instance
        let sortableList = null;


        // --- Utility Functions ---

        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const saveState = () => {
            localStorage.setItem('todoAppState', JSON.stringify(AppState));
        };

        const loadState = () => {
            const savedState = localStorage.getItem('todoAppState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                // Merge carefully, especially nested objects/arrays
                Object.assign(AppState, {
                    ...parsedState,
                    // Ensure nested objects are properly loaded or defaulted
                    currentUser: parsedState.currentUser || null,
                    users: parsedState.users || [],
                    tasks: parsedState.tasks || [],
                    filters: parsedState.filters || { search: '', priority: 'all', status: 'all', dueDate: 'all' },
                    workTimers: parsedState.workTimers || { login: 0, break: 0, shadow: 0 },
                    selectedTasks: new Set(parsedState.selectedTasks ? Array.from(parsedState.selectedTasks) : []), // Recreate Set
                    // Reset transient state
                    workTimerInterval: null,
                    lastStatusResetDate: parsedState.lastStatusResetDate || null
                });

                // Convert date strings back to Date objects if needed (e.g., for tasks)
                 AppState.tasks = AppState.tasks.map(task => ({
                     ...task,
                     createdAt: task.createdAt ? new Date(task.createdAt) : new Date(),
                     dueDate: task.dueDate ? new Date(task.dueDate) : null,
                     // Ensure time elapsed is a number
                     taskTimeElapsed: typeof task.taskTimeElapsed === 'number' ? task.taskTimeElapsed : 0,
                     lastStartTime: task.lastStartTime ? new Date(task.lastStartTime) : null
                 }));
                 if (AppState.currentUser && AppState.currentUser.statusStartTime) {
                     AppState.currentUser.statusStartTime = new Date(AppState.currentUser.statusStartTime);
                 }
                 if (AppState.lastStatusResetDate) {
                    AppState.lastStatusResetDate = new Date(AppState.lastStatusResetDate);
                 }


            } else {
                // Initialize with some default users if state is empty
                addDefaultUsers();
            }
        };

        const formatTime = (seconds) => {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };

        const formatDate = (date) => {
            if (!date) return 'No due date';
            try {
                // Check if it's already a Date object
                const d = (date instanceof Date) ? date : new Date(date);
                 if (isNaN(d.getTime())) { // Invalid date check
                     return 'Invalid date';
                 }
                return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                console.error("Error formatting date:", date, e);
                return 'Invalid date';
            }
        };

        // Simple custom alert function
        const showAlert = (message, title = "Alert") => {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertOk.classList.remove('hidden');
            customAlertCancel.classList.add('hidden');
            customAlert.classList.remove('hidden');

            return new Promise((resolve) => {
                customAlertOk.onclick = () => {
                    customAlert.classList.add('hidden');
                    resolve(true); // Always resolves true for simple alert
                };
            });
        };

        // Simple custom confirm function
        const showConfirm = (message, title = "Confirm") => {
            customAlertTitle.textContent = title;
            customAlertMessage.textContent = message;
            customAlertOk.classList.remove('hidden');
            customAlertCancel.classList.remove('hidden');
            customAlert.classList.remove('hidden');

            return new Promise((resolve) => {
                customAlertOk.onclick = () => {
                    customAlert.classList.add('hidden');
                    resolve(true); // User clicked OK/Confirm
                };
                 customAlertCancel.onclick = () => {
                    customAlert.classList.add('hidden');
                    resolve(false); // User clicked Cancel
                };
            });
        };

        // --- UI Update Functions ---

        const updateTheme = () => {
            const html = document.documentElement;
            if (AppState.theme === 'dark') {
                html.classList.add('dark');
                html.classList.remove('light');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
            } else {
                html.classList.remove('dark');
                html.classList.add('light');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
            }
            // Update chart colors if charts exist
            updateChartThemes();
        };

        const showPage = (pageId) => {
            [loginPage, registerPage, appPage].forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                     // If showing app page, ensure elements are rendered for chart/sortable init
                     if(pageId === 'app-page') {
                         requestAnimationFrame(() => { // Ensure DOM is ready
                             renderTasks(); // Initial render might be needed
                             initializeCharts();
                             initializeSortable();
                         });
                     }
                } else {
                    page.classList.add('hidden');
                }
            });
        };

        const updateProfileDisplay = () => {
            if (!AppState.currentUser) return;

            const user = AppState.currentUser;
            profilePicture.src = user.profilePic || `https://placehold.co/40x40/cccccc/ffffff?text=${user.name ? user.name[0].toUpperCase() : 'P'}`;
            profilePicture.alt = user.name || 'Profile';

            // Update status border
            profilePicture.className = `w-10 h-10 rounded-full object-cover ${StatusClasses[user.status] || StatusClasses.logout}`;

             // Update work timer display border and status text
            workTimerDisplay.className = `text-sm font-medium p-2 rounded-md border-2 ${TimerBorderClasses[user.status] || TimerBorderClasses.logout}`;
            const statusText = user.status.charAt(0).toUpperCase() + user.status.slice(1);
            workTimerStatus.textContent = `${statusText}:`;

            // Update dropdown menu visibility (optional, could be handled by click)
            profileDropdownMenu.classList.add('hidden');
        };

         const updateTaskSummary = () => {
            const total = AppState.tasks.length;
            const completed = AppState.tasks.filter(task => task.completed).length;
            const pending = total - completed;

            totalTasksCount.textContent = total;
            completedTasksCount.textContent = completed;
            pendingTasksCount.textContent = pending;
        };

        const renderTasks = () => {
            if (AppState.currentView === 'graph') {
                updateGraphView();
                return; // Don't render list if in graph view
            }

            taskList.innerHTML = ''; // Clear existing list
            AppState.selectedTasks.clear(); // Clear selection when re-rendering
            updateMultiSelectUI();

            const filteredAndSortedTasks = getFilteredAndSortedTasks();

            if (filteredAndSortedTasks.length === 0) {
                taskList.innerHTML = '<li class="p-4 border border-[var(--border-color)] rounded-lg bg-[var(--primary-bg)] text-center text-gray-500 italic">No tasks match your filters.</li>';
                return;
            }

            filteredAndSortedTasks.forEach(task => {
                const li = document.createElement('li');
                li.classList.add('task-item', 'p-4', 'border', 'border-[var(--border-color)]', 'rounded-lg', 'bg-[var(--primary-bg)]', 'flex', 'flex-col', 'md:flex-row', 'md:items-center', 'justify-between', 'gap-3', 'transition-colors', 'duration-200');
                li.dataset.taskId = task.id; // For drag & drop and event handling

                 // Add priority alert class
                 if (PriorityAlertClasses[task.priority]) {
                     li.classList.add(PriorityAlertClasses[task.priority]);
                 }
                 // Add completed background class
                 if (task.completed) {
                     li.classList.add('task-completed-bg');
                 }


                // --- Task Content ---
                const contentDiv = document.createElement('div');
                contentDiv.classList.add('flex-grow', 'flex', 'items-start', 'gap-3');

                 // Checkbox for multi-select
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.classList.add('mt-1', 'form-checkbox', 'h-5', 'w-5', 'text-[var(--primary-accent)]', 'rounded', 'border-[var(--border-color)]', 'focus:ring-[var(--primary-accent)]');
                checkbox.dataset.taskId = task.id;
                checkbox.addEventListener('change', handleTaskSelection);
                contentDiv.appendChild(checkbox);


                // Task Details Div
                const detailsDiv = document.createElement('div');
                detailsDiv.classList.add('flex-grow');

                // Title and Priority
                const titleP = document.createElement('p');
                titleP.classList.add('font-semibold', 'text-lg', 'mb-1');
                 if (task.completed) {
                     titleP.classList.add('task-completed');
                 }
                // Add priority indicator span
                 const prioritySpan = document.createElement('span');
                 prioritySpan.classList.add(PriorityClasses[task.priority] || PriorityClasses.Low);
                 prioritySpan.title = `Priority: ${task.priority}`;
                 titleP.appendChild(prioritySpan);

                 titleP.appendChild(document.createTextNode(task.title || 'Untitled Task')); // Add title text
                 detailsDiv.appendChild(titleP);

                // Description
                if (task.description) {
                    const descP = document.createElement('p');
                    descP.classList.add('text-sm', 'text-gray-600', 'dark:text-gray-400', 'mb-2');
                     if (task.completed) {
                         descP.classList.add('task-completed');
                     }
                    descP.textContent = task.description;
                    detailsDiv.appendChild(descP);
                }

                // Due Date and Alert
                const dueDateDiv = document.createElement('div');
                dueDateDiv.classList.add('text-xs', 'text-gray-500', 'dark:text-gray-400', 'flex', 'items-center', 'gap-1', 'mb-2');
                const calendarIcon = createIcon('calendar');
                calendarIcon.classList.add('w-3', 'h-3');
                dueDateDiv.appendChild(calendarIcon);
                dueDateDiv.appendChild(document.createTextNode(formatDate(task.dueDate)));

                // Due date alert logic
                if (task.dueDate && !task.completed) {
                    const now = new Date();
                    const dueDate = new Date(task.dueDate);
                    const diffTime = dueDate.getTime() - now.getTime();
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);

                    let alertSpan = document.createElement('span');
                    alertSpan.classList.add('ml-2', 'px-1.5', 'py-0.5', 'rounded', 'text-xs', 'font-medium');

                    if (diffTime < 0) { // Expired
                        alertSpan.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                        alertSpan.textContent = 'Expired';
                        dueDateDiv.appendChild(alertSpan);
                    } else if (diffDays < 2) { // Less than 48 hours
                        alertSpan.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900', 'dark:text-yellow-200');
                        alertSpan.textContent = 'Due Soon';
                         dueDateDiv.appendChild(alertSpan);
                    } else { // More than 48 hours (optional: add green alert)
                         // alertSpan.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-200');
                         // alertSpan.textContent = 'On Track';
                         // dueDateDiv.appendChild(alertSpan);
                    }
                }
                detailsDiv.appendChild(dueDateDiv);

                // Assignee & Subtasks (Simplified display)
                 const metaDiv = document.createElement('div');
                 metaDiv.classList.add('text-xs', 'text-gray-500', 'dark:text-gray-400', 'flex', 'flex-wrap', 'gap-x-3', 'gap-y-1');
                 if (task.assignee && task.assignee !== 'self') {
                     const assigneeSpan = document.createElement('span');
                     const userIcon = createIcon('user');
                     userIcon.classList.add('w-3', 'h-3', 'mr-1');
                     assigneeSpan.appendChild(userIcon);
                     // Find user name (simplified)
                     const assignedUser = AppState.users.find(u => u.email === task.assignee); // Assuming assignee stores email
                     assigneeSpan.appendChild(document.createTextNode(assignedUser ? assignedUser.name : task.assignee));
                     metaDiv.appendChild(assigneeSpan);
                 }
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtaskSpan = document.createElement('span');
                    const listIcon = createIcon('list');
                    listIcon.classList.add('w-3', 'h-3', 'mr-1');
                    subtaskSpan.appendChild(listIcon);
                    subtaskSpan.appendChild(document.createTextNode(`${task.subtasks.length} subtask(s)`));
                    metaDiv.appendChild(subtaskSpan);
                }
                 if (metaDiv.hasChildNodes()) {
                     detailsDiv.appendChild(metaDiv);
                 }


                contentDiv.appendChild(detailsDiv);
                li.appendChild(contentDiv);


                // --- Action Buttons ---
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('flex', 'items-center', 'flex-shrink-0', 'gap-2', 'mt-2', 'md:mt-0', 'md:ml-4');

                // Task Timer Button
                const timerButton = document.createElement('button');
                timerButton.classList.add('p-1.5', 'rounded', 'hover:bg-[var(--secondary-bg)]', 'transition-colors');
                timerButton.title = task.taskTimerRunning ? `Pause Timer (${formatTime(task.taskTimeElapsed)})` : `Start Timer (${formatTime(task.taskTimeElapsed)})`;
                const timerIcon = createIcon(task.taskTimerRunning ? 'pause-circle' : 'play-circle');
                timerIcon.classList.add('w-5', 'h-5', task.taskTimerRunning ? 'text-orange-500' : 'text-green-500');
                timerButton.appendChild(timerIcon);
                timerButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent triggering edit
                    toggleTaskTimer(task.id);
                });
                 actionsDiv.appendChild(timerButton);


                 // Share Button (Placeholder)
                const shareButton = document.createElement('button');
                shareButton.classList.add('p-1.5', 'rounded', 'hover:bg-[var(--secondary-bg)]', 'transition-colors');
                shareButton.title = 'Share Task';
                const shareIcon = createIcon('share-2');
                shareIcon.classList.add('w-5', 'h-5', 'text-blue-500');
                shareButton.appendChild(shareIcon);
                shareButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showAlert(`Sharing options for task "${task.title}" would appear here.`, "Share Task");
                });
                actionsDiv.appendChild(shareButton);

                // Edit Button
                const editButton = document.createElement('button');
                editButton.classList.add('p-1.5', 'rounded', 'hover:bg-[var(--secondary-bg)]', 'transition-colors');
                editButton.title = 'Edit Task';
                const editIcon = createIcon('edit');
                editIcon.classList.add('w-5', 'h-5', 'text-yellow-600');
                editButton.appendChild(editIcon);
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openTaskModal(task.id); // Open modal for editing
                });
                actionsDiv.appendChild(editButton);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('p-1.5', 'rounded', 'hover:bg-[var(--secondary-bg)]', 'transition-colors');
                deleteButton.title = 'Delete Task';
                const deleteIcon = createIcon('trash-2');
                deleteIcon.classList.add('w-5', 'h-5', 'text-red-600');
                deleteButton.appendChild(deleteIcon);
                deleteButton.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await showConfirm(`Are you sure you want to delete the task "${task.title}"?`, "Confirm Deletion");
                    if (confirmed) {
                         deleteTask(task.id);
                    }
                });
                actionsDiv.appendChild(deleteButton);

                 // Complete Toggle Button
                const completeButton = document.createElement('button');
                completeButton.classList.add('p-1.5', 'rounded', 'hover:bg-[var(--secondary-bg)]', 'transition-colors');
                completeButton.title = task.completed ? 'Mark as Pending' : 'Mark as Complete';
                const completeIcon = createIcon(task.completed ? 'x-square' : 'check-square');
                completeIcon.classList.add('w-5', 'h-5', task.completed ? 'text-gray-500' : 'text-emerald-600');
                completeButton.appendChild(completeIcon);
                completeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTaskCompletion(task.id);
                });
                actionsDiv.appendChild(completeButton);


                li.appendChild(actionsDiv);

                // Add click listener to the whole item for potential quick edit/view (optional)
                // li.addEventListener('click', () => openTaskModal(task.id));

                taskList.appendChild(li);
            });

            // Re-initialize SortableJS after rendering tasks
            initializeSortable();
        };

        const updateGraphView = () => {
            if (!taskStatusChart || !taskPriorityChart) {
                initializeCharts(); // Initialize if not already done
            }
            updateChartData(); // Update data for existing charts
        };

        const updateView = () => {
            if (AppState.currentView === 'list') {
                listView.classList.remove('hidden');
                graphView.classList.add('hidden');
                listViewBtn.classList.add('bg-[var(--primary-accent)]', 'text-white');
                listViewBtn.classList.remove('hover:bg-[var(--border-color)]');
                graphViewBtn.classList.remove('bg-[var(--primary-accent)]', 'text-white');
                graphViewBtn.classList.add('hover:bg-[var(--border-color)]');
                renderTasks();
            } else { // Graph view
                listView.classList.add('hidden');
                graphView.classList.remove('hidden');
                graphViewBtn.classList.add('bg-[var(--primary-accent)]', 'text-white');
                graphViewBtn.classList.remove('hover:bg-[var(--border-color)]');
                listViewBtn.classList.remove('bg-[var(--primary-accent)]', 'text-white');
                listViewBtn.classList.add('hover:bg-[var(--border-color)]');
                updateGraphView();
            }
        };

        const updateMultiSelectUI = () => {
             const count = AppState.selectedTasks.size;
             selectedCountSpan.textContent = `${count} selected`;
             if (count > 0) {
                 multiSelectActions.classList.remove('hidden');
                 multiSelectActions.classList.add('flex'); // Ensure it's flex
             } else {
                 multiSelectActions.classList.add('hidden');
                 multiSelectActions.classList.remove('flex');
             }

             // Update checkbox states visually (needed if renderTasks doesn't run immediately)
             document.querySelectorAll('#task-list input[type="checkbox"]').forEach(cb => {
                 cb.checked = AppState.selectedTasks.has(cb.dataset.taskId);
             });
        };

        // --- Authentication Functions ---

        const handleLogin = (event) => {
            event.preventDefault();
            const email = loginForm.email.value.trim();
            const password = loginForm.password.value;
            loginError.classList.add('hidden'); // Hide previous errors

            const user = AppState.users.find(u => u.email === email && u.password === password);

            if (user) {
                AppState.currentUser = { ...user }; // Create a copy to avoid modifying the original in AppState.users directly
                // Reset status on login unless loading persisted state
                 if (!AppState.currentUser.status || !['login', 'break', 'shadow'].includes(AppState.currentUser.status)) {
                    AppState.currentUser.status = 'login'; // Default to login status
                    AppState.currentUser.statusStartTime = new Date();
                    resetDailyWorkTimers(); // Reset timers for the new day if needed
                 }
                saveState();
                initializeAppUI();
                showPage('app-page');
                startWorkTimer(); // Start the timer based on current status
            } else {
                loginError.textContent = 'Invalid email or password.';
                loginError.classList.remove('hidden');
            }
             loginForm.reset();
        };

        const handleRegister = (event) => {
            event.preventDefault();
            registerError.classList.add('hidden');

            const name = registerForm.querySelector('#register-name').value.trim();
            const email = registerForm.querySelector('#register-email').value.trim();
            const confirmEmail = registerForm.querySelector('#register-confirm-email').value.trim();
            const password = registerForm.querySelector('#register-password').value;
            const confirmPassword = registerForm.querySelector('#register-confirm-password').value;
            const phone = registerForm.querySelector('#register-phone').value.trim();
            const country = registerForm.querySelector('#register-country').value;
            const role = registerForm.querySelector('#register-role').value;

            // Basic Validations
            if (email !== confirmEmail) {
                registerError.textContent = 'Emails do not match.';
                registerError.classList.remove('hidden');
                return;
            }
            if (password !== confirmPassword) {
                registerError.textContent = 'Passwords do not match.';
                registerError.classList.remove('hidden');
                return;
            }
            if (AppState.users.some(u => u.email === email)) {
                registerError.textContent = 'Email already registered.';
                registerError.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                 registerError.textContent = 'Password must be at least 6 characters long.';
                 registerError.classList.remove('hidden');
                 return;
            }

            const newUser = {
                id: generateId(),
                name,
                email,
                password, // In a real app, hash this!
                phone,
                country,
                role,
                profilePic: `https://placehold.co/100x100/cccccc/ffffff?text=${name ? name[0].toUpperCase() : 'P'}`, // Default pic
                status: 'logout', // Initial status
                statusStartTime: null,
            };

            AppState.users.push(newUser);
            saveState();
            showAlert(`Registration successful for ${name}! You can now log in.`, "Success");
            registerForm.reset();
            showPage('login-page');
        };

        const handleLogout = () => {
            stopWorkTimer(); // Stop the timer interval
            if (AppState.currentUser) {
                 // Optionally save final timer values before logging out
                 updateWorkTimerValue(); // Ensure last value is calculated
                 AppState.currentUser.status = 'logout';
                 AppState.currentUser.statusStartTime = new Date(); // Mark logout time
                 saveState(); // Save the logout status
            }
            AppState.currentUser = null;
            // Clear sensitive parts of state if necessary, but keep users list
            // AppState.tasks = []; // Or decide if tasks persist across users/logins
            saveState(); // Save the logged-out state
            showPage('login-page');
        };

        // --- Task Management Functions ---

        const openTaskModal = (taskId = null) => {
            taskForm.reset();
            taskIdInput.value = ''; // Clear hidden ID field
            profileUpdateError.classList.add('hidden'); // Hide profile errors if reusing modal styles
            populateAssigneeDropdown(); // Ensure assignee dropdown is up-to-date

            if (taskId) {
                // Editing existing task
                const task = AppState.tasks.find(t => t.id === taskId);
                if (task) {
                    taskModalTitle.textContent = 'Edit Task';
                    taskIdInput.value = task.id;
                    taskTitleInput.value = task.title;
                    taskDescriptionInput.value = task.description || '';
                    taskPrioritySelect.value = task.priority;
                    if (task.dueDate) {
                         // Ensure Flatpickr is initialized before setting date
                         if (!dueDatePicker) initializeDatePicker();
                         // Use Flatpickr's API to set the date
                         dueDatePicker.setDate(task.dueDate, false); // `false` prevents triggering onChange
                    } else {
                         if (dueDatePicker) dueDatePicker.clear();
                    }
                    taskSubtasksInput.value = (task.subtasks || []).join(', ');
                    taskAssigneeSelect.value = task.assignee || 'self';
                    taskNotesInput.value = task.notes || '';
                    saveTaskBtn.textContent = 'Save Changes';
                } else {
                    showAlert("Error: Task not found.", "Error");
                    return; // Don't open modal if task not found
                }
            } else {
                // Adding new task
                taskModalTitle.textContent = 'Add New Task';
                taskPrioritySelect.value = 'Medium'; // Default priority
                if (dueDatePicker) dueDatePicker.clear(); // Clear date picker
                saveTaskBtn.textContent = 'Save Task';
            }
            taskModal.classList.remove('hidden');
             // Initialize date picker if not already done
             if (!dueDatePicker) initializeDatePicker();
        };

        const closeTaskModal = () => {
            taskModal.classList.add('hidden');
            taskForm.reset();
             if (dueDatePicker) dueDatePicker.clear();
        };

        const handleSaveTask = (event) => {
            event.preventDefault();
            const id = taskIdInput.value;
            const title = taskTitleInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const priority = taskPrioritySelect.value;
            const dueDateStr = taskDueDateInput.value; // Get string from Flatpickr input
            const subtasks = taskSubtasksInput.value.split(',').map(s => s.trim()).filter(s => s);
            const assignee = taskAssigneeSelect.value;
            const notes = taskNotesInput.value.trim();

            if (!title) {
                showAlert("Task title is required.", "Validation Error");
                return;
            }

            // Parse the date string carefully
             let dueDate = null;
             if (dueDateStr) {
                 try {
                     // Flatpickr usually provides a format parseable by Date constructor
                     dueDate = new Date(dueDateStr);
                      if (isNaN(dueDate.getTime())) { // Check if date is valid
                          dueDate = null; // Set to null if invalid
                          console.warn("Invalid date string provided:", dueDateStr);
                      }
                 } catch (e) {
                     console.error("Error parsing date:", e);
                     dueDate = null;
                 }
             }


            if (id) {
                // Update existing task
                const taskIndex = AppState.tasks.findIndex(t => t.id === id);
                if (taskIndex > -1) {
                    AppState.tasks[taskIndex] = {
                        ...AppState.tasks[taskIndex], // Keep existing properties like completed, createdAt, timer state
                        title,
                        description,
                        priority,
                        dueDate,
                        subtasks,
                        assignee,
                        notes
                    };
                }
            } else {
                // Add new task
                const newTask = {
                    id: generateId(),
                    title,
                    description,
                    priority,
                    dueDate,
                    completed: false,
                    createdAt: new Date(),
                    subtasks,
                    assignee,
                    notes,
                    taskTimerRunning: false,
                    taskTimeElapsed: 0,
                    lastStartTime: null
                };
                AppState.tasks.push(newTask);
            }

            saveState();
            renderTasks();
            updateTaskSummary();
            updateChartData(); // Update graphs if visible
            closeTaskModal();
        };

        const deleteTask = (taskId) => {
            AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
            AppState.selectedTasks.delete(taskId); // Remove from selection if present
            saveState();
            renderTasks();
            updateTaskSummary();
            updateChartData();
            updateMultiSelectUI();
        };

        const toggleTaskCompletion = (taskId) => {
            const taskIndex = AppState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex > -1) {
                AppState.tasks[taskIndex].completed = !AppState.tasks[taskIndex].completed;
                // Stop task timer if task is completed
                 if (AppState.tasks[taskIndex].completed && AppState.tasks[taskIndex].taskTimerRunning) {
                     stopIndividualTaskTimer(taskId, false); // Stop without saving state yet
                 }
                saveState();
                renderTasks(); // Re-render to update visual state (strikethrough, button icon)
                updateTaskSummary();
                updateChartData();
            }
        };

        const getFilteredAndSortedTasks = () => {
            let tasksToDisplay = [...AppState.tasks];

            // Filtering
            tasksToDisplay = tasksToDisplay.filter(task => {
                const searchLower = AppState.filters.search.toLowerCase();
                const titleMatch = task.title.toLowerCase().includes(searchLower);
                const descMatch = task.description && task.description.toLowerCase().includes(searchLower);
                const priorityMatch = AppState.filters.priority === 'all' || task.priority === AppState.filters.priority;
                const statusMatch = AppState.filters.status === 'all' || (AppState.filters.status === 'completed' && task.completed) || (AppState.filters.status === 'pending' && !task.completed);

                // Due Date Filtering
                let dateMatch = true;
                if (AppState.filters.dueDate !== 'all') {
                    if (!task.dueDate) {
                        dateMatch = false; // Tasks without due date don't match specific date filters
                    } else {
                        const today = new Date(); today.setHours(0, 0, 0, 0);
                        const taskDueDate = new Date(task.dueDate); taskDueDate.setHours(0, 0, 0, 0);
                        const oneWeekFromNow = new Date(today); oneWeekFromNow.setDate(today.getDate() + 7);
                        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);


                        switch (AppState.filters.dueDate) {
                            case 'today':
                                dateMatch = taskDueDate.getTime() === today.getTime();
                                break;
                            case 'week':
                                // Due date is between today (inclusive) and 7 days from now (exclusive)
                                dateMatch = taskDueDate >= today && taskDueDate < oneWeekFromNow;
                                break;
                            case 'month':
                                dateMatch = taskDueDate >= firstDayOfMonth && taskDueDate <= lastDayOfMonth;
                                break;
                            // Add 'custom' range logic here if implemented
                        }
                    }
                }


                return (titleMatch || descMatch) && priorityMatch && statusMatch && dateMatch;
            });

            // Sorting
            const priorityOrder = { High: 3, Medium: 2, Low: 1 };
            switch (AppState.sort) {
                case 'priority-desc':
                    tasksToDisplay.sort((a, b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0));
                    break;
                case 'priority-asc':
                     tasksToDisplay.sort((a, b) => (priorityOrder[a.priority] || 0) - (priorityOrder[b.priority] || 0));
                    break;
                case 'due-date-asc':
                    // Sort by due date, nulls/invalid dates go last
                    tasksToDisplay.sort((a, b) => {
                        const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                        const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                         if (isNaN(dateA) && isNaN(dateB)) return 0;
                         if (isNaN(dateA)) return 1; // a is invalid, goes last
                         if (isNaN(dateB)) return -1; // b is invalid, goes last
                        return dateA - dateB;
                    });
                    break;
                case 'due-date-desc':
                     // Sort by due date, nulls/invalid dates go first (or last depending on preference) - let's put them last
                     tasksToDisplay.sort((a, b) => {
                        const dateA = a.dueDate ? new Date(a.dueDate).getTime() : -Infinity; // Treat null as earliest for desc
                        const dateB = b.dueDate ? new Date(b.dueDate).getTime() : -Infinity;
                         if (isNaN(dateA) && isNaN(dateB)) return 0;
                         if (isNaN(dateA)) return 1; // a is invalid, goes last
                         if (isNaN(dateB)) return -1; // b is invalid, goes last
                        return dateB - dateA; // Descending
                    });
                    break;
                case 'title-asc':
                    tasksToDisplay.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'title-desc':
                     tasksToDisplay.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'default':
                default:
                    // Sort by creation date (newest first) or original order if createdAt is missing
                     tasksToDisplay.sort((a, b) => (b.createdAt ? new Date(b.createdAt).getTime() : 0) - (a.createdAt ? new Date(a.createdAt).getTime() : 0));
                    break;
            }

            return tasksToDisplay;
        };

        // --- Profile Management ---

        const openProfileModal = () => {
            if (!AppState.currentUser) return;
             profileForm.reset(); // Clear previous inputs/errors
             profileUpdateError.classList.add('hidden');

            const user = AppState.currentUser;
            profileModalPicture.src = user.profilePic || `https://placehold.co/100x100/cccccc/ffffff?text=${user.name ? user.name[0].toUpperCase() : 'P'}`;
            profileNameInput.value = user.name;
            profileEmailInput.value = user.email; // Email is read-only
            profilePhoneInput.value = user.phone || '';
            profileRoleInput.value = user.role; // Role is read-only for simplicity here
            profilePasswordInput.value = ''; // Clear password field

            profileModal.classList.remove('hidden');
        };

        const closeProfileModal = () => {
            profileModal.classList.add('hidden');
            profileUpdateError.classList.add('hidden');
        };

        const handleProfileUpdate = (event) => {
            event.preventDefault();
            if (!AppState.currentUser) return;
            profileUpdateError.classList.add('hidden');

            const name = profileNameInput.value.trim();
            const phone = profilePhoneInput.value.trim();
            const newPassword = profilePasswordInput.value;

            if (!name) {
                 profileUpdateError.textContent = "Name cannot be empty.";
                 profileUpdateError.classList.remove('hidden');
                 return;
            }

             // Find the user in the main users array to update persistently
             const userIndex = AppState.users.findIndex(u => u.email === AppState.currentUser.email);
             if (userIndex === -1) {
                 profileUpdateError.textContent = "Error: Could not find user data.";
                 profileUpdateError.classList.remove('hidden');
                 return;
             }

            // Update current user state
            AppState.currentUser.name = name;
            AppState.currentUser.phone = phone;
             // Update profile picture if changed (using placeholder logic)
             if (profileModalPicture.dataset.newSrc) {
                AppState.currentUser.profilePic = profileModalPicture.dataset.newSrc;
                delete profileModalPicture.dataset.newSrc; // Clear temp data attribute
             }

            // Update persistent user data in AppState.users
            AppState.users[userIndex].name = name;
            AppState.users[userIndex].phone = phone;
             AppState.users[userIndex].profilePic = AppState.currentUser.profilePic; // Ensure persistent data matches

            // Update password if provided
            if (newPassword) {
                if (newPassword.length < 6) {
                    profileUpdateError.textContent = "New password must be at least 6 characters long.";
                    profileUpdateError.classList.remove('hidden');
                    return;
                }
                AppState.currentUser.password = newPassword; // Update current session
                AppState.users[userIndex].password = newPassword; // Update persistent data (HASH in real app!)
            }

            saveState();
            updateProfileDisplay(); // Update header profile pic/name potentially
            populateAssigneeDropdown(); // Update assignee list if names changed
            showAlert("Profile updated successfully!", "Success");
            closeProfileModal();
        };

        const handlePictureChange = (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Display the new image in the modal
                    profileModalPicture.src = e.target.result;
                    // Store the new src temporarily (e.g., in a data attribute)
                    // In a real app, you'd upload this and get a new URL
                    profileModalPicture.dataset.newSrc = e.target.result; // Using data URL for demo
                }
                reader.readAsDataURL(file);
            } else if (file) {
                showAlert("Please select a valid image file.", "Invalid File");
            }
        };


        // --- Users Modal ---
        const openUsersModal = () => {
            usersListDiv.innerHTML = ''; // Clear previous list
            if (AppState.users.length === 0) {
                usersListDiv.innerHTML = '<p class="text-gray-500 italic">No registered users found.</p>';
            } else {
                AppState.users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.classList.add('flex', 'items-center', 'p-3', 'border', 'border-[var(--border-color)]', 'rounded-lg', 'bg-[var(--primary-bg)]', 'gap-3');

                    const img = document.createElement('img');
                    img.src = user.profilePic || `https://placehold.co/40x40/cccccc/ffffff?text=${user.name ? user.name[0].toUpperCase() : 'U'}`;
                    img.alt = user.name;
                    img.classList.add('w-10', 'h-10', 'rounded-full', 'object-cover', 'flex-shrink-0');
                    userDiv.appendChild(img);

                    const infoDiv = document.createElement('div');
                    infoDiv.classList.add('flex-grow');

                    const nameP = document.createElement('p');
                    nameP.classList.add('font-semibold');
                    nameP.textContent = user.name;
                    infoDiv.appendChild(nameP);

                    const emailP = document.createElement('p');
                    emailP.classList.add('text-sm', 'text-gray-500');
                    emailP.textContent = user.email;
                    infoDiv.appendChild(emailP);

                    userDiv.appendChild(infoDiv);

                    const roleSpan = document.createElement('span');
                    roleSpan.classList.add('text-xs', 'font-medium', 'px-2', 'py-1', 'rounded-full', 'bg-[var(--secondary-bg)]');
                    roleSpan.textContent = user.role;
                    userDiv.appendChild(roleSpan);

                    usersListDiv.appendChild(userDiv);
                });
            }
            usersModal.classList.remove('hidden');
        };

        const closeUsersModal = () => {
            usersModal.classList.add('hidden');
        };


        // --- Import/Export Functions ---

        const openExportModal = () => {
            exportModal.classList.remove('hidden');
        };
        const closeExportModal = () => {
            exportModal.classList.add('hidden');
        };

        const handleExport = (format) => {
            const tasksToExport = AppState.tasks; // Or could export filtered tasks
            if (tasksToExport.length === 0) {
                showAlert("No tasks to export.", "Export");
                return;
            }

            let dataStr = '';
            let filename = `todo_tasks_${new Date().toISOString().split('T')[0]}`;
            let mimeType = '';

            switch (format) {
                case 'json':
                    // Clean tasks for export (remove internal state like timer intervals)
                     const cleanTasks = tasksToExport.map(({ id, title, description, priority, dueDate, completed, createdAt, subtasks, assignee, notes, taskTimeElapsed }) => ({
                         id, title, description, priority, dueDate: dueDate ? dueDate.toISOString() : null, completed, createdAt: createdAt.toISOString(), subtasks, assignee, notes, taskTimeElapsed: formatTime(taskTimeElapsed) // Export formatted time
                     }));
                    dataStr = JSON.stringify(cleanTasks, null, 2); // Pretty print JSON
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
                case 'csv':
                    const headers = ['ID', 'Title', 'Description', 'Priority', 'Due Date', 'Completed', 'Created At', 'Subtasks', 'Assignee', 'Notes', 'Time Spent'];
                    const rows = tasksToExport.map(task => [
                        task.id,
                        `"${task.title.replace(/"/g, '""')}"`, // Escape quotes
                        `"${(task.description || '').replace(/"/g, '""')}"`,
                        task.priority,
                        task.dueDate ? task.dueDate.toISOString().split('T')[0] : '',
                        task.completed,
                        task.createdAt.toISOString(),
                        `"${(task.subtasks || []).join(', ').replace(/"/g, '""')}"`,
                        task.assignee || '',
                        `"${(task.notes || '').replace(/"/g, '""')}"`,
                        formatTime(task.taskTimeElapsed || 0)
                    ].join(','));
                    dataStr = [headers.join(','), ...rows].join('\n');
                    filename += '.csv';
                    mimeType = 'text/csv';
                    break;
                 case 'txt':
                     dataStr = tasksToExport.map(task => (
                         `Task: ${task.title}\n` +
                         `ID: ${task.id}\n` +
                         `Priority: ${task.priority}\n` +
                         `Status: ${task.completed ? 'Completed' : 'Pending'}\n` +
                         `Due: ${formatDate(task.dueDate)}\n` +
                         `Description: ${task.description || 'N/A'}\n` +
                         `Assignee: ${task.assignee || 'Self'}\n` +
                         `Time Spent: ${formatTime(task.taskTimeElapsed || 0)}\n` +
                         `--------------------`
                     )).join('\n\n');
                     filename += '.txt';
                     mimeType = 'text/plain';
                     break;
                case 'pdf':
                case 'docx':
                     showAlert(`Exporting as ${format.toUpperCase()} is simulated. In a real app, this would generate and download the file.`, "Simulated Export");
                     closeExportModal();
                     return; // Stop execution for simulated formats
                default:
                    showAlert("Invalid export format selected.", "Error");
                    return;
            }

            // Create a Blob and download link
            const blob = new Blob([dataStr], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert(`Tasks exported as ${format.toUpperCase()}.`, "Export Successful");
            closeExportModal();
        };


        const openImportModal = () => {
            importForm.reset();
            importStatusP.textContent = '';
            importModal.classList.remove('hidden');
        };
        const closeImportModal = () => {
            importModal.classList.add('hidden');
        };

        const handleImport = (event) => {
            event.preventDefault();
            const file = importFileInput.files[0];
            if (!file) {
                importStatusP.textContent = 'Please select a file.';
                importStatusP.classList.add('text-red-500');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    let importedTasks = [];

                    if (file.name.endsWith('.json')) {
                        const parsedData = JSON.parse(content);
                        // Basic validation: Check if it's an array
                        if (!Array.isArray(parsedData)) {
                            throw new Error("JSON file does not contain a valid task array.");
                        }
                        // Validate and map imported tasks
                        importedTasks = parsedData.map(item => ({
                            id: item.id || generateId(), // Generate ID if missing
                            title: item.title || 'Untitled Imported Task',
                            description: item.description || '',
                            priority: ['High', 'Medium', 'Low'].includes(item.priority) ? item.priority : 'Medium',
                            dueDate: item.dueDate ? new Date(item.dueDate) : null, // Attempt to parse date
                            completed: typeof item.completed === 'boolean' ? item.completed : false,
                            createdAt: item.createdAt ? new Date(item.createdAt) : new Date(), // Use imported or new date
                            subtasks: Array.isArray(item.subtasks) ? item.subtasks : [],
                            assignee: item.assignee || 'self',
                            notes: item.notes || '',
                             // Reset timer state for imported tasks
                             taskTimerRunning: false,
                             taskTimeElapsed: 0, // Or try to parse item.taskTimeElapsed if exported that way
                             lastStartTime: null
                        })).filter(task => !isNaN(task.dueDate?.getTime() ?? 0) && !isNaN(task.createdAt.getTime())); // Filter out tasks with invalid dates


                    } else if (file.name.endsWith('.csv')) {
                        // Basic CSV parsing (assumes comma delimiter and specific order)
                         const lines = content.split('\n').map(l => l.trim()).filter(l => l);
                         if (lines.length < 2) throw new Error("CSV file is empty or has no data rows.");
                         // Assuming headers are present and match export order
                         const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim()); // Simple header parse
                         importedTasks = lines.slice(1).map(line => {
                             // Very basic CSV parsing, doesn't handle commas within quotes well
                             const values = line.split(',');
                             return {
                                 id: values[0] || generateId(),
                                 title: values[1]?.replace(/"/g, '') || 'Untitled CSV Task',
                                 description: values[2]?.replace(/"/g, '') || '',
                                 priority: ['High', 'Medium', 'Low'].includes(values[3]) ? values[3] : 'Medium',
                                 dueDate: values[4] ? new Date(values[4]) : null,
                                 completed: values[5]?.toLowerCase() === 'true',
                                 createdAt: values[6] ? new Date(values[6]) : new Date(),
                                 subtasks: values[7]?.replace(/"/g, '').split(',').map(s => s.trim()).filter(s => s) || [],
                                 assignee: values[8] || 'self',
                                 notes: values[9]?.replace(/"/g, '') || '',
                                 taskTimerRunning: false,
                                 taskTimeElapsed: 0,
                                 lastStartTime: null
                             };
                         }).filter(task => !isNaN(task.dueDate?.getTime() ?? 0) && !isNaN(task.createdAt.getTime()));

                    } else {
                        throw new Error("Unsupported file format. Please use JSON or CSV.");
                    }

                    if (importedTasks.length > 0) {
                        // Add imported tasks, avoiding duplicates by ID if necessary
                        const existingIds = new Set(AppState.tasks.map(t => t.id));
                        const newTasks = importedTasks.filter(t => !existingIds.has(t.id));
                        AppState.tasks.push(...newTasks);
                        saveState();
                        renderTasks();
                        updateTaskSummary();
                        updateChartData();
                        importStatusP.textContent = `Successfully imported ${newTasks.length} new tasks.`;
                        importStatusP.classList.remove('text-red-500');
                        importStatusP.classList.add('text-green-500');
                        setTimeout(closeImportModal, 1500); // Close modal after success
                    } else {
                         importStatusP.textContent = 'No new tasks found in the file or all tasks already exist.';
                         importStatusP.classList.add('text-yellow-500');
                    }

                } catch (error) {
                    console.error("Import error:", error);
                    importStatusP.textContent = `Error importing file: ${error.message}`;
                    importStatusP.classList.add('text-red-500');
                }
            };

            reader.onerror = () => {
                 importStatusP.textContent = 'Error reading file.';
                 importStatusP.classList.add('text-red-500');
            };

            reader.readAsText(file);
        };

        // --- Work Timer & Status ---

        const updateWorkTimerValue = () => {
            if (!AppState.currentUser || !AppState.currentUser.statusStartTime) return;

            const now = new Date();
             // Check for daily reset
             checkAndResetDailyTimers(now);

            const currentStatus = AppState.currentUser.status;

            // Calculate elapsed time since status started
            let elapsedSinceStatusStart = 0;
            if (['login', 'break', 'shadow'].includes(currentStatus)) {
                 elapsedSinceStatusStart = (now.getTime() - AppState.currentUser.statusStartTime.getTime()) / 1000; // in seconds
            }


            // Calculate total time for the current status for today
            let totalTimeForStatusToday = (AppState.workTimers[currentStatus] || 0) + elapsedSinceStatusStart;

             // Display the formatted time for the *current* status
             workTimerValue.textContent = formatTime(totalTimeForStatusToday);

             // Persist the calculated *base* time (excluding the current interval)
             // This happens when the status changes or on logout/page close
        };

         const startWorkTimer = () => {
             if (AppState.workTimerInterval) {
                 clearInterval(AppState.workTimerInterval); // Clear existing interval
             }
             if (AppState.currentUser && ['login', 'break', 'shadow'].includes(AppState.currentUser.status)) {
                 // Ensure statusStartTime is set
                 if (!AppState.currentUser.statusStartTime) {
                     AppState.currentUser.statusStartTime = new Date();
                     saveState();
                 }
                 updateWorkTimerValue(); // Initial display
                 AppState.workTimerInterval = setInterval(updateWorkTimerValue, 1000); // Update every second
             } else {
                  // If status is 'logout' or invalid, display 0 or last known logout time
                  workTimerValue.textContent = formatTime(0); // Or display total login time for the day?
             }
         };

         const stopWorkTimer = () => {
             if (AppState.workTimerInterval) {
                 clearInterval(AppState.workTimerInterval);
                 AppState.workTimerInterval = null;
             }
             // Calculate and save the final elapsed time for the status before stopping
              if (AppState.currentUser && AppState.currentUser.statusStartTime && ['login', 'break', 'shadow'].includes(AppState.currentUser.status)) {
                 const now = new Date();
                 const elapsed = (now.getTime() - AppState.currentUser.statusStartTime.getTime()) / 1000;
                 AppState.workTimers[AppState.currentUser.status] = (AppState.workTimers[AppState.currentUser.status] || 0) + elapsed;
                 AppState.currentUser.statusStartTime = null; // Reset start time as interval is stopped
                 saveState(); // Save the accumulated time
                 // Update display one last time with the final accumulated value
                 workTimerValue.textContent = formatTime(AppState.workTimers[AppState.currentUser.status]);
              }
         };

         const changeUserStatus = (newStatus) => {
             if (!AppState.currentUser || AppState.currentUser.status === newStatus) return;

             const now = new Date();
             checkAndResetDailyTimers(now); // Check for reset before changing status

             // Stop the timer and save elapsed time for the OLD status
             stopWorkTimer(); // This calculates and saves the time for the previous status

             // Update status and start time for the NEW status
             AppState.currentUser.status = newStatus;
             AppState.currentUser.statusStartTime = new Date(); // Start time for the new status

             saveState(); // Save the new status and start time
             updateProfileDisplay(); // Update UI (profile pic border, timer border/text)
             startWorkTimer(); // Start the timer for the new status
         };

         const checkAndResetDailyTimers = (now) => {
             const today = new Date(now);
             today.setHours(0, 0, 0, 0); // Get the start of the current day

             const lastReset = AppState.lastStatusResetDate ? new Date(AppState.lastStatusResetDate) : null;

             if (!lastReset || lastReset.getTime() < today.getTime()) {
                 // It's a new day (or first run), reset timers
                 AppState.workTimers = { login: 0, break: 0, shadow: 0 };
                 AppState.lastStatusResetDate = today;
                 // If the user is currently logged in, break, or shadow, reset their start time to the beginning of today
                 // This prevents carrying over elapsed time from the previous day into the new day's calculation.
                 if (AppState.currentUser && AppState.currentUser.statusStartTime && ['login', 'break', 'shadow'].includes(AppState.currentUser.status)) {
                     AppState.currentUser.statusStartTime = now; // Reset start time to 'now' on the new day
                 }
                 console.log("Daily work timers reset.");
                 saveState(); // Save the reset state
             }
         };

         const resetDailyWorkTimers = () => {
             const now = new Date();
             checkAndResetDailyTimers(now);
         };


        // --- Individual Task Timers ---
        const toggleTaskTimer = (taskId) => {
            const taskIndex = AppState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = AppState.tasks[taskIndex];

             if (task.completed) {
                 showAlert("Cannot start timer for a completed task.", "Timer");
                 return;
             }

            if (task.taskTimerRunning) {
                // Stop the timer
                stopIndividualTaskTimer(taskId);
            } else {
                // Start the timer
                startIndividualTaskTimer(taskId);
            }
        };

        const startIndividualTaskTimer = (taskId) => {
             const taskIndex = AppState.tasks.findIndex(t => t.id === taskId);
             if (taskIndex === -1 || AppState.tasks[taskIndex].taskTimerRunning) return;

             AppState.tasks[taskIndex].taskTimerRunning = true;
             AppState.tasks[taskIndex].lastStartTime = new Date(); // Record start time
             saveState();
             renderTasks(); // Update UI to show pause icon and potentially running state
             // Note: We don't need a separate interval here. Time is calculated when stopped or viewed.
        };

        const stopIndividualTaskTimer = (taskId, shouldSaveState = true) => {
             const taskIndex = AppState.tasks.findIndex(t => t.id === taskId);
             if (taskIndex === -1 || !AppState.tasks[taskIndex].taskTimerRunning) return;

             const task = AppState.tasks[taskIndex];
             const now = new Date();
             const elapsed = (now.getTime() - (task.lastStartTime ? new Date(task.lastStartTime).getTime() : now.getTime())) / 1000; // Calculate elapsed seconds

             task.taskTimeElapsed = (task.taskTimeElapsed || 0) + elapsed;
             task.taskTimerRunning = false;
             task.lastStartTime = null;

             if (shouldSaveState) {
                saveState();
                renderTasks(); // Update UI to show play icon and updated time
             }
        };


        // --- Charting Functions ---

        const initializeCharts = () => {
            if (!graphView.offsetParent) return; // Don't initialize if graph view is hidden/not rendered

            const statusCtx = document.getElementById('taskStatusChart')?.getContext('2d');
            const priorityCtx = document.getElementById('taskPriorityChart')?.getContext('2d');

            const chartOptions = (titleText) => ({
                responsive: true,
                maintainAspectRatio: false, // Allow chart to fill container height
                plugins: {
                    legend: {
                        position: 'bottom',
                         labels: {
                             color: AppState.theme === 'dark' ? '#f9fafb' : '#111827', // Adjust label color for theme
                         }
                    },
                    title: {
                        display: false, // Title is already above canvas
                        text: titleText,
                        color: AppState.theme === 'dark' ? '#f9fafb' : '#111827',
                    }
                }
            });

            const pieChartOptions = (titleText) => ({
                ...chartOptions(titleText),
                 // Add specific options for pie/doughnut if needed
            });
            const barChartOptions = (titleText) => ({
                ...chartOptions(titleText),
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                             color: AppState.theme === 'dark' ? '#9ca3af' : '#6b7280', // Y-axis ticks color
                             stepSize: 1 // Ensure integer steps for counts
                        },
                        grid: {
                             color: AppState.theme === 'dark' ? '#4b5563' : '#e5e7eb' // Grid line color
                        }
                    },
                    x: {
                        ticks: {
                             color: AppState.theme === 'dark' ? '#9ca3af' : '#6b7280', // X-axis ticks color
                        },
                         grid: {
                             display: false // Hide vertical grid lines for cleaner look
                        }
                    }
                }
            });


            if (statusCtx && !taskStatusChart) {
                taskStatusChart = new Chart(statusCtx, {
                    type: 'doughnut', // Or 'pie'
                    data: getChartData().status,
                    options: pieChartOptions('Task Status')
                });
            }

            if (priorityCtx && !taskPriorityChart) {
                taskPriorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: getChartData().priority,
                    options: barChartOptions('Tasks by Priority')
                });
            }
             // Ensure charts are updated with current theme colors immediately
             updateChartThemes();
        };

        const getChartData = () => {
            const completed = AppState.tasks.filter(t => t.completed).length;
            const pending = AppState.tasks.length - completed;

            const highPriority = AppState.tasks.filter(t => t.priority === 'High' && !t.completed).length;
            const mediumPriority = AppState.tasks.filter(t => t.priority === 'Medium' && !t.completed).length;
            const lowPriority = AppState.tasks.filter(t => t.priority === 'Low' && !t.completed).length;

            const statusData = {
                labels: ['Pending', 'Completed'],
                datasets: [{
                    label: 'Task Status',
                    data: [pending, completed],
                    backgroundColor: [
                        StatusColors.break, // Yellow for Pending
                        StatusColors.login, // Green for Completed
                    ],
                    borderColor: [
                         AppState.theme === 'dark' ? '#111827' : '#ffffff', // Border color based on theme
                         AppState.theme === 'dark' ? '#111827' : '#ffffff',
                    ],
                    borderWidth: 2
                }]
            };

            const priorityData = {
                labels: ['High', 'Medium', 'Low'],
                datasets: [{
                    label: 'Pending Tasks by Priority',
                    data: [highPriority, mediumPriority, lowPriority],
                    backgroundColor: [
                        StatusColors.logout, // Red for High
                        StatusColors.break,  // Yellow for Medium
                        StatusColors.shadow, // Gray for Low
                    ],
                     // No border needed for bar chart, or set explicitly
                     borderColor: AppState.theme === 'dark' ? '#4b5563' : '#e5e7eb',
                     borderWidth: 1
                }]
            };

            return { status: statusData, priority: priorityData };
        };

        const updateChartData = () => {
            if (AppState.currentView !== 'graph') return; // Only update if graph view is active

            const newData = getChartData();

            if (taskStatusChart) {
                taskStatusChart.data = newData.status;
                taskStatusChart.update();
            }
            if (taskPriorityChart) {
                taskPriorityChart.data = newData.priority;
                taskPriorityChart.update();
            }
        };

         const updateChartThemes = () => {
             const textColor = AppState.theme === 'dark' ? '#f9fafb' : '#111827';
             const gridColor = AppState.theme === 'dark' ? '#4b5563' : '#e5e7eb';
             const legendLabelColor = textColor;
             const tickColor = AppState.theme === 'dark' ? '#9ca3af' : '#6b7280';
             const doughnutBorderColor = AppState.theme === 'dark' ? '#111827' : '#ffffff'; // Background color

             if (taskStatusChart) {
                 taskStatusChart.options.plugins.legend.labels.color = legendLabelColor;
                 taskStatusChart.data.datasets[0].borderColor = [doughnutBorderColor, doughnutBorderColor];
                 taskStatusChart.update();
             }
             if (taskPriorityChart) {
                 taskPriorityChart.options.plugins.legend.labels.color = legendLabelColor;
                 taskPriorityChart.options.scales.y.ticks.color = tickColor;
                 taskPriorityChart.options.scales.y.grid.color = gridColor;
                 taskPriorityChart.options.scales.x.ticks.color = tickColor;
                 taskPriorityChart.data.datasets[0].borderColor = gridColor; // Match grid color for bar border
                 taskPriorityChart.update();
             }
         };

        // --- Drag and Drop ---
        const initializeSortable = () => {
             if (sortableList) {
                 sortableList.destroy(); // Destroy previous instance if exists
             }
             if (taskList && AppState.currentView === 'list') { // Only init if list view is active and element exists
                 sortableList = new Sortable(taskList, {
                     animation: 150, // Animation duration
                     ghostClass: 'sortable-ghost', // Class for the drop placeholder
                     chosenClass: 'sortable-chosen', // Class for the chosen item
                     handle: '.task-item', // Allow dragging the entire item
                     // filter: '.task-actions', // Prevent dragging from action buttons (optional)
                     onEnd: (evt) => {
                         // evt.oldIndex, evt.newIndex contain the indices
                         const movedTask = AppState.tasks.splice(evt.oldIndex, 1)[0];
                         AppState.tasks.splice(evt.newIndex, 0, movedTask);
                         saveState();
                         // No need to re-render here, Sortable handles the visual move.
                         // However, if your sorting logic relies on `createdAt` or similar,
                         // you might want to update that or switch sort to 'default' (manual order).
                         // For simplicity, we assume manual order takes precedence after drag.
                         sortTasksSelect.value = 'default'; // Reflect that order is now manual
                         AppState.sort = 'default';
                     },
                 });
             }
        };

        // --- Multi-Select ---
         const handleTaskSelection = (event) => {
             const checkbox = event.target;
             const taskId = checkbox.dataset.taskId;

             if (checkbox.checked) {
                 AppState.selectedTasks.add(taskId);
             } else {
                 AppState.selectedTasks.delete(taskId);
             }
             updateMultiSelectUI();
         };

         const handleMultiComplete = async () => {
             const count = AppState.selectedTasks.size;
             if (count === 0) return;

             const confirmed = await showConfirm(`Mark ${count} selected task(s) as complete?`, "Confirm Action");
             if (confirmed) {
                 AppState.tasks = AppState.tasks.map(task => {
                     if (AppState.selectedTasks.has(task.id)) {
                         // Stop timer if running before marking complete
                          if (task.taskTimerRunning) {
                              stopIndividualTaskTimer(task.id, false); // Stop without saving state yet
                          }
                         return { ...task, completed: true };
                     }
                     return task;
                 });
                 AppState.selectedTasks.clear();
                 saveState();
                 renderTasks();
                 updateTaskSummary();
                 updateChartData();
                 updateMultiSelectUI();
             }
         };

         const handleMultiDelete = async () => {
             const count = AppState.selectedTasks.size;
             if (count === 0) return;

             const confirmed = await showConfirm(`Are you sure you want to delete ${count} selected task(s)?`, "Confirm Deletion");
             if (confirmed) {
                 AppState.tasks = AppState.tasks.filter(task => !AppState.selectedTasks.has(task.id));
                 AppState.selectedTasks.clear();
                 saveState();
                 renderTasks();
                 updateTaskSummary();
                 updateChartData();
                 updateMultiSelectUI();
             }
         };

         const clearSelection = () => {
             AppState.selectedTasks.clear();
             // Uncheck all checkboxes visually
             document.querySelectorAll('#task-list input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
             updateMultiSelectUI();
         };


        // --- Initialization ---

        const populateCountries = () => {
            // Source: https://gist.github.com/incredimike/1469814
            const countries = [
                { "code": "US", "name": "United States" }, { "code": "CA", "name": "Canada" }, { "code": "GB", "name": "United Kingdom" },
                { "code": "AF", "name": "Afghanistan" }, { "code": "AL", "name": "Albania" }, { "code": "DZ", "name": "Algeria" },
                { "code": "AS", "name": "American Samoa" }, { "code": "AD", "name": "Andorra" }, { "code": "AO", "name": "Angola" },
                // ... (add many more countries) ...
                 { "code": "EG", "name": "Egypt" }, { "code": "JP", "name": "Japan" }, { "code": "DE", "name": "Germany" },
                 { "code": "FR", "name": "France" }, { "code": "BR", "name": "Brazil" }, { "code": "IN", "name": "India" },
                 { "code": "CN", "name": "China" }, { "code": "AU", "name": "Australia" },
                { "code": "ZW", "name": "Zimbabwe" }
            ];
            countries.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                registerCountrySelect.appendChild(option);
            });
        };

        const populateAssigneeDropdown = () => {
             taskAssigneeSelect.innerHTML = '<option value="self">Self</option>'; // Reset and add self
             AppState.users.forEach(user => {
                 // Add option only if it's not the current user (or allow assigning to self explicitly via 'self')
                 // if (AppState.currentUser && user.email !== AppState.currentUser.email) {
                     const option = document.createElement('option');
                     option.value = user.email; // Use email as value for assignment tracking
                     option.textContent = user.name;
                     taskAssigneeSelect.appendChild(option);
                 // }
             });
        };

        const addDefaultUsers = () => {
             // Add a couple of default users if none exist (for demo purposes)
             if (AppState.users.length === 0) {
                 AppState.users.push({ id: generateId(), name: "Admin User", email: "admin@test.com", password: "password", phone: "123456", country: "US", role: "Admin", profilePic: 'https://placehold.co/100x100/A0A0FF/ffffff?text=A', status: 'logout', statusStartTime: null });
                 AppState.users.push({ id: generateId(), name: "Test Staff", email: "staff@test.com", password: "password", phone: "987654", country: "CA", role: "Staff", profilePic: 'https://placehold.co/100x100/FFA0A0/ffffff?text=T', status: 'logout', statusStartTime: null });
                 saveState();
             }
        };

        const addSampleTasks = () => {
             // Add sample tasks only if tasks array is empty
             if (AppState.tasks.length === 0 && AppState.currentUser) {
                 const today = new Date();
                 const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                 const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 7);
                 const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);

                 AppState.tasks.push(
                     { id: generateId(), title: "Review project proposal", description: "Check budget and timeline", priority: "High", dueDate: tomorrow, completed: false, createdAt: new Date(), subtasks: ["Check budget", "Verify timeline"], assignee: "self", notes: "Needs urgent review", taskTimerRunning: false, taskTimeElapsed: 3665, lastStartTime: null }, // 1h 1m 5s
                     { id: generateId(), title: "Schedule team meeting", description: "Coordinate availability for next week", priority: "Medium", dueDate: nextWeek, completed: false, createdAt: new Date(), subtasks: [], assignee: "self", notes: "", taskTimerRunning: false, taskTimeElapsed: 125, lastStartTime: null }, // 2m 5s
                     { id: generateId(), title: "Update documentation", description: "Add new API endpoints", priority: "Low", dueDate: null, completed: true, createdAt: new Date(today.setDate(today.getDate() - 2)), subtasks: [], assignee: "self", notes: "Completed yesterday", taskTimerRunning: false, taskTimeElapsed: 7200, lastStartTime: null }, // 2h
                     { id: generateId(), title: "Pay utility bills", description: "Electricity and water", priority: "High", dueDate: yesterday, completed: false, createdAt: new Date(today.setDate(today.getDate() - 5)), subtasks: [], assignee: "self", notes: "Overdue!", taskTimerRunning: false, taskTimeElapsed: 0, lastStartTime: null },
                      { id: generateId(), title: "Prepare presentation slides", description: "For the client meeting on Friday", priority: "Medium", dueDate: new Date(today.setDate(today.getDate() + 3)), completed: false, createdAt: new Date(), subtasks: ["Draft content", "Design slides", "Add charts"], assignee: AppState.users[1]?.email || 'self', notes: "Assign to Test Staff if possible", taskTimerRunning: false, taskTimeElapsed: 1500, lastStartTime: null } // 25m
                 );
                 saveState();
             }
        };

        const initializeAppUI = () => {
             if (!AppState.currentUser) return; // Should not happen if called correctly
             updateProfileDisplay();
             updateTaskSummary();
             updateView(); // Set initial view (list or graph)
             populateAssigneeDropdown();
             addSampleTasks(); // Add sample tasks if none exist
             renderTasks(); // Render initial tasks
             // Reset filters to default on login/app load
             searchInput.value = ''; AppState.filters.search = '';
             filterPrioritySelect.value = 'all'; AppState.filters.priority = 'all';
             filterStatusSelect.value = 'all'; AppState.filters.status = 'all';
             filterDueDateSelect.value = 'all'; AppState.filters.dueDate = 'all';
             sortTasksSelect.value = 'default'; AppState.sort = 'default';
             AppState.selectedTasks.clear();
             updateMultiSelectUI();
        };

        const initializeDatePicker = () => {
             if (dueDatePicker) return; // Already initialized
             dueDatePicker = flatpickr("#task-due-date", {
                 dateFormat: "Y-m-d", // Store date in a standard format
                 altInput: true, // Show user-friendly format
                 altFormat: "M j, Y", // User-friendly format
                 allowInput: false, // Prevent manual typing to ensure valid dates
                 // You might need to handle theme changes for the calendar popup
             });
        };

        // --- Event Listeners ---

        // Authentication
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        showRegisterBtn.addEventListener('click', () => showPage('register-page'));
        cancelRegisterBtn.addEventListener('click', () => showPage('login-page'));
        logoutBtn.addEventListener('click', handleLogout);

        // Theme Switcher
        themeSwitcher.addEventListener('click', () => {
            AppState.theme = AppState.theme === 'light' ? 'dark' : 'light';
            updateTheme();
            saveState();
        });

        // Profile Dropdown & Modal
        profileDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent body click from closing immediately
            profileDropdownMenu.classList.toggle('hidden');
        });
        document.body.addEventListener('click', (e) => {
            // Close dropdown if clicking outside
            if (!profileDropdownBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                profileDropdownMenu.classList.add('hidden');
            }
        });
        viewProfileBtn.addEventListener('click', () => {
             profileDropdownMenu.classList.add('hidden'); // Close dropdown first
             openProfileModal();
        });
        profileModal.addEventListener('click', (e) => { // Close modal on backdrop click
             if (e.target === profileModal) closeProfileModal();
        });
        cancelProfileBtn.addEventListener('click', closeProfileModal);
        profileForm.addEventListener('submit', handleProfileUpdate);
        changePictureBtn.addEventListener('click', () => profilePictureUpload.click());
        profilePictureUpload.addEventListener('change', handlePictureChange);

        // Status Change Buttons
        profileDropdownMenu.addEventListener('click', (e) => {
             if (e.target.classList.contains('status-option')) {
                 const newStatus = e.target.dataset.status;
                 changeUserStatus(newStatus);
                 profileDropdownMenu.classList.add('hidden'); // Close dropdown
             }
        });

        // Task Modal
        addTaskBtn.addEventListener('click', () => openTaskModal());
        cancelTaskBtn.addEventListener('click', closeTaskModal);
        taskModal.addEventListener('click', (e) => { // Close modal on backdrop click
             if (e.target === taskModal) closeTaskModal();
        });
        taskForm.addEventListener('submit', handleSaveTask);


        // View Switcher
        listViewBtn.addEventListener('click', () => {
            AppState.currentView = 'list';
            updateView();
            saveState();
        });
        graphViewBtn.addEventListener('click', () => {
            AppState.currentView = 'graph';
            updateView();
            saveState();
        });

        // Filtering and Sorting Controls
        searchInput.addEventListener('input', (e) => {
            AppState.filters.search = e.target.value;
            renderTasks(); // Re-render list view on search
            // No need to save state for every keystroke, maybe debounce later
        });
        filterPrioritySelect.addEventListener('change', (e) => {
            AppState.filters.priority = e.target.value;
            saveState();
            renderTasks();
        });
        filterStatusSelect.addEventListener('change', (e) => {
            AppState.filters.status = e.target.value;
            saveState();
            renderTasks();
        });
         filterDueDateSelect.addEventListener('change', (e) => {
            AppState.filters.dueDate = e.target.value;
            saveState();
            renderTasks();
        });
        sortTasksSelect.addEventListener('change', (e) => {
            AppState.sort = e.target.value;
            saveState();
            renderTasks();
        });

         // Multi-select Actions
         multiCompleteBtn.addEventListener('click', handleMultiComplete);
         multiDeleteBtn.addEventListener('click', handleMultiDelete);
         clearSelectionBtn.addEventListener('click', clearSelection);

        // Users Modal
        usersBtn.addEventListener('click', openUsersModal);
        closeUsersModalBtn.addEventListener('click', closeUsersModal);
        usersModal.addEventListener('click', (e) => { if (e.target === usersModal) closeUsersModal(); });

         // Export Modal
         exportBtn.addEventListener('click', openExportModal);
         cancelExportBtn.addEventListener('click', closeExportModal);
         exportModal.addEventListener('click', (e) => { if (e.target === exportModal) closeExportModal(); });
         exportModal.querySelectorAll('.export-option').forEach(button => {
             button.addEventListener('click', (e) => handleExport(e.target.dataset.format));
         });

         // Import Modal
         importBtn.addEventListener('click', openImportModal);
         cancelImportBtn.addEventListener('click', closeImportModal);
         importModal.addEventListener('click', (e) => { if (e.target === importModal) closeImportModal(); });
         importForm.addEventListener('submit', handleImport);

         // Custom Alert/Confirm Close
         customAlert.addEventListener('click', (e) => {
             // Only close if clicking the backdrop itself
             if (e.target === customAlert) {
                // Check if it's a confirm dialog with cancel shown
                if (!customAlertCancel.classList.contains('hidden')) {
                    // Simulate clicking cancel if backdrop is clicked on confirm
                    customAlertCancel.click();
                } else {
                     // Simulate clicking OK if backdrop is clicked on simple alert
                     customAlertOk.click();
                }
             }
         });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); // Initialize Lucide icons
            populateCountries();
            loadState(); // Load saved state (users, tasks, theme, loggedInUser etc.)
            updateTheme(); // Apply loaded theme

            if (AppState.currentUser) {
                initializeAppUI();
                showPage('app-page');
                startWorkTimer(); // Resume timer based on loaded status
            } else {
                addDefaultUsers(); // Ensure default users exist if none loaded
                showPage('login-page');
            }

             // Initialize date picker after DOM is ready and potentially after app page is shown
             // Delaying slightly can help if the input isn't immediately visible
             setTimeout(initializeDatePicker, 100);

             // Initialize SortableJS for the task list
             initializeSortable();
        });

        // Helper to create Lucide icons dynamically
        function createIcon(name, size = 16) {
            const i = document.createElement('i');
            i.setAttribute('data-lucide', name);
            // Lucide's createIcons function will process this later,
            // but we can add classes now for styling/sizing.
            i.classList.add(`w-${Math.round(size/4)}`, `h-${Math.round(size/4)}`); // Approximate Tailwind size
            // Call createIcons on the specific element after adding it
            setTimeout(() => lucide.createIcons({ nodes: [i] }), 0);
            return i;
        }

         // Beforeunload listener to save state, especially timer state
         window.addEventListener('beforeunload', () => {
             stopWorkTimer(); // Ensure current timer interval is saved before leaving
             // Stop any running individual task timers
              AppState.tasks.forEach(task => {
                  if (task.taskTimerRunning) {
                      stopIndividualTaskTimer(task.id, false); // Stop without re-rendering UI
                  }
              });
             saveState(); // Final save
         });

    </script>
</body>
</html>
