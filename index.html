<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Todo App</title>
    
    <!-- External CDNs -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #5D5CDE;
            --primary-hover: #4b4ab2;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --info-color: #17A2B8;
            --dark-color: #343A40;
            --light-color: #F8F9FA;
            --bg-color: #FFFFFF;
            --text-color: #333333;
            --card-bg: #FFFFFF;
            --card-border: rgba(0, 0, 0, 0.125);
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 8px 15px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .dark {
            --primary-color: #6665e7;
            --primary-hover: #5554c9;
            --bg-color: #181818;
            --text-color: #F8F9FA;
            --card-bg: #2D2D2D;
            --card-border: rgba(255, 255, 255, 0.125);
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 8px 15px rgba(0, 0, 0, 0.3);
            --shadow-dark: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* APP CONTAINER */
        #app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* BUTTONS STYLES */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #bd2130;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-dark {
            background-color: var(--dark-color);
            color: white;
        }

        .btn-dark:hover {
            background-color: #23272b;
        }

        .btn-light {
            background-color: var(--light-color);
            color: #212529;
        }

        .btn-light:hover {
            background-color: #e2e6ea;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* CARD STYLES */
        .card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-medium);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-dark);
            transform: translateY(-5px);
        }

        /* INPUT STYLES */
        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--bg-color);
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(93, 92, 222, 0.25);
        }

        .dark .form-control {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f8f9fa;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        /* LOGIN & REGISTER FORMS */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-dark);
            background-color: var(--card-bg);
            position: relative;
            overflow: hidden;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            position: relative;
            overflow: hidden;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(93, 92, 222, 0.4);
        }

        .login-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(93, 92, 222, 0.4);
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(60deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shineEffect 3s infinite;
        }

        @keyframes shineEffect {
            0% {
                left: -50%;
                top: -50%;
            }
            100% {
                left: 100%;
                top: 100%;
            }
        }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-dark);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--card-border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--card-border);
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--card-border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .logo i {
            margin-right: 0.5rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* TIMER */
        .timer-container {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            box-shadow: var(--shadow-light);
            margin-right: 1rem;
            border: 1px solid var(--card-border);
        }

        .timer {
            font-size: 1.25rem;
            font-weight: 600;
            font-family: 'Poppins', monospace;
            min-width: 80px;
            text-align: center;
        }

        .timer-btn {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: opacity 0.3s ease;
            padding: 0.25rem;
        }

        .timer-btn:hover {
            opacity: 1;
        }

        /* MODE SWITCHER */
        .mode-switcher {
            background-color: var(--card-bg);
            border-radius: 2rem;
            width: 3rem;
            height: 1.5rem;
            position: relative;
            cursor: pointer;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-light);
            margin-right: 1rem;
        }

        .mode-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: calc(1.5rem - 4px);
            height: calc(1.5rem - 4px);
            border-radius: 50%;
            background-color: var(--primary-color);
            transition: transform 0.3s ease;
        }

        .mode-switcher.dark .mode-slider {
            transform: translateX(1.5rem);
        }

        /* PROFILE BADGE */
        .profile-badge {
            position: relative;
            cursor: pointer;
        }

        .profile-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            transition: all 0.3s ease;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: var(--shadow-light);
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-medium);
            width: 200px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .profile-dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary-color);
        }

        .profile-dropdown-divider {
            height: 1px;
            background-color: var(--card-border);
            margin: 0.5rem 0;
        }

        /* STATUS INDICATOR */
        .status-indicator {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 1rem;
            box-shadow: var(--shadow-light);
        }

        .status-online {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-offline {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .status-break {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
            border: 1px solid var(--warning-color);
        }

        .status-away {
            background-color: rgba(108, 117, 125, 0.2);
            color: #6c757d;
            border: 1px solid #6c757d;
        }

        /* NOTIFICATIONS */
        .notifications-container {
            position: relative;
        }

        .notifications-icon {
            font-size: 1.25rem;
            color: var(--text-color);
            cursor: pointer;
            position: relative;
            margin-right: 1rem;
        }

        .notifications-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: var(--shadow-light);
        }

        .notifications-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-medium);
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .notifications-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.05);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .notification-text {
            font-size: 0.8125rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.6;
            margin-top: 0.25rem;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--card-border);
        }

        .notifications-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .mark-all-read {
            font-size: 0.75rem;
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        /* TASK SUMMARY */
        .task-summary {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            .task-summary {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .summary-card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        .summary-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-5px);
        }

        .summary-card:first-child {
            border: 2px solid var(--primary-color);
        }

        .summary-card:nth-child(2) {
            border: 2px solid var(--success-color);
        }

        .summary-card:nth-child(3) {
            border: 2px solid var(--warning-color);
        }

        .summary-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .summary-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-card:nth-child(2) .summary-count {
            color: var(--success-color);
        }

        .summary-card:nth-child(3) .summary-count {
            color: var(--warning-color);
        }

        /* TASKS SECTION */
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .tasks-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .tasks-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* TASKS FILTER */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-select {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .dark .filter-select {
            background-color: #3a3a3a;
            border-color: #555;
            color: #f8f9fa;
        }

        /* SEARCH BAR */
        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            border: 1px solid var(--card-border);
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-light);
        }

        .search-icon {
            margin-right: 0.5rem;
            color: var(--text-color);
            opacity: 0.5;
        }

        .search-input {
            flex: 1;
            border: none;
            background: none;
            font-size: 0.875rem;
            color: var(--text-color);
            outline: none;
        }

        /* VIEW SWITCHER */
        .view-switcher {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        .view-switch {
            display: flex;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--card-border);
            overflow: hidden;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* TASKS LIST */
        .tasks-list {
            margin-bottom: 2rem;
        }

        .task-item {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .task-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .task-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color);
            margin-right: 0.5rem;
        }

        .task-badges {
            display: flex;
            gap: 0.5rem;
        }

        .task-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-high {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .badge-medium {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }

        .badge-low {
            background-color: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        .task-description {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .task-meta i {
            margin-right: 0.25rem;
        }

        .task-actions {
            display: flex;
            gap: 0.25rem;
        }

        .task-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .task-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 0.25rem;
            border: 1px solid var(--card-border);
            outline: none;
            cursor: pointer;
            position: relative;
            background-color: var(--bg-color);
        }

        .task-checkbox:checked {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .task-checkbox:checked::after {
            content: '\2713';
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .task-checkbox:focus {
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .task-item.completed {
            opacity: 0.7;
            border-left: 5px solid var(--success-color);
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-item.expired {
            border-left: 5px solid var(--danger-color);
        }

        .task-item.due-soon {
            border-left: 5px solid var(--warning-color);
        }

        .task-item.due-later {
            border-left: 5px solid var(--success-color);
        }

        .task-time {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary-color);
        }

        .subtasks {
            margin-top: 0.5rem;
            margin-left: 1.5rem;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8125rem;
            color: var(--text-color);
        }

        /* ACTIONS BAR */
        .actions-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            z-index: 99;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .actions-bar.active {
            transform: translateY(0);
        }

        /* GRAPH VIEW */
        .graph-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            .graph-container {
                flex-direction: row;
            }
        }

        .graph-card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-medium);
            padding: 1.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--card-border);
        }

        .graph-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-color);
        }

        .chart-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 250px;
        }

        /* INSIGHTS */
        .insights-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .insights-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .insights-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .insight-card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            padding: 1.5rem;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-5px);
        }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .insight-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .insight-data {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .insight-description {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        /* TOAST NOTIFICATIONS */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 1000;
        }

        .toast {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-medium);
            padding: 1rem;
            margin-bottom: 0.5rem;
            width: 300px;
            animation: slideIn 0.3s ease forwards, fadeOut 0.3s 4.7s ease forwards;
            display: flex;
            align-items: flex-start;
            border-left: 4px solid var(--primary-color);
        }

        .toast-icon {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .toast-text {
            font-size: 0.8125rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* UNDO/REDO */
        .history-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .history-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.3s ease;
            padding: 0.25rem;
        }

        .history-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .history-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* USERS */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .users-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .users-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .user-card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-light);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .user-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-5px) scale(1.02);
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .user-name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .user-email {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 0.75rem;
        }

        .user-role {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .user-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            justify-content: center;
        }

        .user-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .user-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .user-stat-label {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Responsive fixes */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .tasks-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .tasks-actions {
                width: 100%;
                justify-content: space-between;
            }

            .filters {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-group {
                width: 100%;
            }

            .filter-select {
                flex: 1;
            }

            .task-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .task-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .profile-dropdown,
            .notifications-dropdown {
                right: -100%;
                transform: translateX(-50%);
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease forwards;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- LOGIN PAGE -->
        <div id="loginPage" class="auth-container animate-fade-in">
            <div class="auth-card">
                <h1 class="auth-title">Welcome to Task Manager</h1>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" value="123456">
                </div>
                <button id="loginBtn" class="login-btn">Login</button>
                <p class="text-center mt-4">
                    Don't have an account? <span id="registerLink" class="auth-link">Register now</span>
                </p>
            </div>
        </div>

        <!-- DASHBOARD PAGE -->
        <div id="dashboardPage" class="animate-fade-in" style="display: none;">
            <!-- HEADER -->
            <div class="header">
                <div class="logo" id="dashboardLink">
                    <i class="fas fa-tasks"></i>
                    <span>To-Do App</span>
                </div>
                <div class="header-actions">
                    <!-- TIMER -->
                    <div class="timer-container">
                        <button class="timer-btn" id="playPauseBtn">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="timer" id="timer">00:00:00</div>
                        <button class="timer-btn" id="pauseBtn">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>

                    <!-- STATUS INDICATOR -->
                    <div class="status-indicator status-online" id="statusIndicator">
                        <span id="statusText">Online</span>
                    </div>

                    <!-- MODE SWITCHER -->
                    <div class="mode-switcher" id="modeSwitcher">
                        <div class="mode-slider"></div>
                    </div>

                    <!-- NOTIFICATIONS -->
                    <div class="notifications-container">
                        <div class="notifications-icon" id="notificationsIcon">
                            <i class="fas fa-bell"></i>
                            <div class="notifications-badge" id="notificationsBadge">0</div>
                        </div>
                        <div class="notifications-dropdown" id="notificationsDropdown">
                            <div class="notifications-header">
                                <div class="notifications-title">Notifications</div>
                                <div class="mark-all-read" id="markAllRead">Mark all as read</div>
                            </div>
                            <div id="notificationsList">
                                <!-- Notifications will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- PROFILE -->
                    <div class="profile-badge" id="profileBadge">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile" class="profile-img" id="profileImg">
                        <div class="notification-badge" id="profileNotificationBadge">0</div>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-item" id="viewProfileBtn">
                                <i class="fas fa-user"></i>
                                <span>View Profile</span>
                            </div>
                            <div class="profile-dropdown-item" id="changeStatusBtn">
                                <i class="fas fa-circle"></i>
                                <span>Change Status</span>
                            </div>
                            <div class="profile-dropdown-divider"></div>
                            <div class="profile-dropdown-item" id="switchModeBtn">
                                <i class="fas fa-moon"></i>
                                <span>Switch to Dark Mode</span>
                            </div>
                            <div class="profile-dropdown-divider"></div>
                            <div class="profile-dropdown-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </div>
                        </div>
                    </div>

                    <!-- HISTORY CONTROLS (UNDO/REDO) -->
                    <div class="history-controls">
                        <button class="history-btn" id="undoBtn" disabled>
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="history-btn" id="redoBtn" disabled>
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TASKS SUMMARY -->
            <div class="task-summary animate-slide-up">
                <div class="summary-card">
                    <i class="fas fa-tasks summary-icon" style="color: var(--primary-color);"></i>
                    <div class="summary-title">Total Tasks</div>
                    <div class="summary-count" id="totalTasksCount">0</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-check-circle summary-icon" style="color: var(--success-color);"></i>
                    <div class="summary-title">Completed Tasks</div>
                    <div class="summary-count" id="completedTasksCount">0</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-hourglass-half summary-icon" style="color: var(--warning-color);"></i>
                    <div class="summary-title">Pending Tasks</div>
                    <div class="summary-count" id="pendingTasksCount">0</div>
                </div>
            </div>

            <!-- TASKS SECTION -->
            <div class="tasks-section animate-slide-up">
                <!-- TASKS HEADER -->
                <div class="tasks-header">
                    <div class="tasks-title">Tasks</div>
                    <div class="tasks-actions">
                        <button class="btn btn-success" id="addTaskBtn">
                            <i class="fas fa-plus"></i>
                            Add Task
                        </button>
                        <button class="btn btn-info" id="exportBtn">
                            <i class="fas fa-file-export"></i>
                            Export
                        </button>
                        <button class="btn btn-primary" id="importBtn">
                            <i class="fas fa-file-import"></i>
                            Import
                        </button>
                        <button class="btn btn-dark" id="categoriesBtn">
                            <i class="fas fa-tags"></i>
                            Categories
                        </button>
                        <button class="btn btn-primary" id="usersBtn">
                            <i class="fas fa-users"></i>
                            Users
                        </button>
                    </div>
                </div>

                <!-- SEARCH BAR -->
                <div class="search-bar">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search tasks...">
                </div>

                <!-- FILTERS -->
                <div class="filters">
                    <div class="filter-group">
                        <div class="filter-label">Status:</div>
                        <select class="filter-select" id="statusFilter">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Category:</div>
                        <select class="filter-select" id="categoryFilter">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Priority:</div>
                        <select class="filter-select" id="priorityFilter">
                            <option value="all">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Due Date:</div>
                        <select class="filter-select" id="dueDateFilter">
                            <option value="all">All</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">Sort By:</div>
                        <select class="filter-select" id="sortFilter">
                            <option value="dateDesc">Due Date (Newest)</option>
                            <option value="dateAsc">Due Date (Oldest)</option>
                            <option value="titleAsc">Title (A-Z)</option>
                            <option value="titleDesc">Title (Z-A)</option>
                            <option value="priorityDesc">Priority (High-Low)</option>
                            <option value="priorityAsc">Priority (Low-High)</option>
                        </select>
                    </div>
                </div>

                <!-- VIEW SWITCHER -->
                <div class="view-switcher">
                    <div class="view-switch">
                        <button class="view-btn active" id="listViewBtn">List View</button>
                        <button class="view-btn" id="graphViewBtn">Graph View</button>
                    </div>
                </div>

                <!-- TASKS LIST VIEW -->
                <div id="listView" class="tasks-list animate-fade-in">
                    <!-- Tasks will be added here -->
                </div>

                <!-- GRAPH VIEW -->
                <div id="graphView" class="graph-container animate-fade-in" style="display: none;">
                    <div class="graph-card">
                        <div class="graph-title">Task Progress</div>
                        <div class="chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                    <div class="graph-card">
                        <div class="graph-title">Task Distribution</div>
                        <div class="chart-container">
                            <canvas id="tasksPieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- INSIGHTS SECTION -->
                <div class="insights-container animate-slide-up">
                    <div class="insights-title">Insights</div>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Productivity Score</div>
                                <div class="insight-icon" style="background-color: var(--primary-color);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="productivityScore">0%</div>
                            <div class="insight-description">Based on completed vs. total tasks</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Expired Tasks</div>
                                <div class="insight-icon" style="background-color: var(--danger-color);">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="expiredTasksCount">0</div>
                            <div class="insight-description">Tasks beyond their due date</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Due Soon</div>
                                <div class="insight-icon" style="background-color: var(--warning-color);">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="dueSoonTasksCount">0</div>
                            <div class="insight-description">Tasks due within 48 hours</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Average Completion Time</div>
                                <div class="insight-icon" style="background-color: var(--info-color);">
                                    <i class="fas fa-stopwatch"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="avgCompletionTime">0h</div>
                            <div class="insight-description">Average time to complete tasks</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Most Common Category</div>
                                <div class="insight-icon" style="background-color: var(--success-color);">
                                    <i class="fas fa-tag"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="commonCategory">-</div>
                            <div class="insight-description">Most used task category</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-header">
                                <div class="insight-title">Task Completion Rate</div>
                                <div class="insight-icon" style="background-color: var(--primary-color);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="insight-data" id="completionRate">0%</div>
                            <div class="insight-description">Weekly completion rate trend</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTIONS BAR -->
            <div class="actions-bar" id="actionsBar">
                <button class="btn btn-success" id="completeSelectedBtn">
                    <i class="fas fa-check"></i>
                    Complete Selected
                </button>
                <button class="btn btn-danger" id="deleteSelectedBtn">
                    <i class="fas fa-trash"></i>
                    Delete Selected
                </button>
                <button class="btn btn-dark" id="cancelSelectionBtn">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>

            <!-- TOAST CONTAINER -->
            <div class="toast-container" id="toastContainer">
                <!-- Toasts will be added here -->
            </div>
        </div>

        <!-- MODALS -->
        <!-- REGISTER MODAL -->
        <div class="modal-overlay" id="registerModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Create an Account</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="regFirstName">First Name</label>
                        <input type="text" id="regFirstName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regLastName">Last Name</label>
                        <input type="text" id="regLastName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regConfirmEmail">Confirm Email</label>
                        <input type="email" id="regConfirmEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password</label>
                        <input type="password" id="regPassword" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regBirthdate">Birthdate</label>
                        <input type="text" id="regBirthdate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="regNationality">Nationality</label>
                        <select id="regNationality" class="form-control">
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="regRole">Role</label>
                        <select id="regRole" class="form-control">
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="createAccountBtn">Create</button>
                    <button class="btn btn-dark" id="cancelRegisterBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- PROFILE MODAL -->
        <div class="modal-overlay" id="profileModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">User Profile</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile" id="profileModalImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color);">
                        <div style="margin-top: 1rem;">
                            <label for="profileImgUpload" class="btn btn-sm btn-primary">
                                <i class="fas fa-camera"></i>
                                Change Photo
                            </label>
                            <input type="file" id="profileImgUpload" style="display: none;" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profileFirstName">First Name</label>
                        <input type="text" id="profileFirstName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileLastName">Last Name</label>
                        <input type="text" id="profileLastName" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileRole">Role</label>
                        <input type="text" id="profileRole" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileJoiningDate">Joining Date</label>
                        <input type="text" id="profileJoiningDate" class="form-control" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                    <button class="btn btn-dark" id="closeProfileBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- EDIT PROFILE MODAL -->
        <div class="modal-overlay" id="editProfileModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Edit Profile</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile" id="editProfileImg" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color);">
                        <div style="margin-top: 1rem;">
                            <label for="editProfileImgUpload" class="btn btn-sm btn-primary">
                                <i class="fas fa-camera"></i>
                                Change Photo
                            </label>
                            <input type="file" id="editProfileImgUpload" style="display: none;" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editProfileFirstName">First Name</label>
                        <input type="text" id="editProfileFirstName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editProfileLastName">Last Name</label>
                        <input type="text" id="editProfileLastName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editProfileEmail">Email</label>
                        <input type="email" id="editProfileEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editProfilePhone">Phone</label>
                        <input type="text" id="editProfilePhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editProfileCountry">Country</label>
                        <select id="editProfileCountry" class="form-control">
                            <option value="">Select Country</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="saveProfileBtn">Save Changes</button>
                    <button class="btn btn-dark" id="cancelEditProfileBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- STATUS MODAL -->
        <div class="modal-overlay" id="statusModal">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">Change Status</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="statusSelect">Select Status</label>
                        <select id="statusSelect" class="form-control">
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="break">On Break</option>
                            <option value="offline">Offline</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="saveStatusBtn">Save</button>
                    <button class="btn btn-dark" id="cancelStatusBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div class="modal-overlay" id="addTaskModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Add New Task</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sub-Tasks</label>
                        <div id="subtasksContainer">
                            <div class="subtask-input" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" class="form-control subtask-text" placeholder="Enter sub-task">
                                <button class="btn btn-sm btn-danger remove-subtask"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary" id="addSubtaskBtn" style="margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i> Add Subtask
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="form-control">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" class="form-control">
                            <option value="Work">Work</option>
                            <option value="Personal">Personal</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                            <option value="Finance">Finance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskNotes">Notes</label>
                        <textarea id="taskNotes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="createTaskBtn">Create</button>
                    <button class="btn btn-dark" id="cancelTaskBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- VIEW TASK MODAL -->
        <div class="modal-overlay" id="viewTaskModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title" id="viewTaskTitle">Task Details</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <span class="task-badge" id="viewTaskPriority">Medium</span>
                            <span class="task-badge" style="background-color: rgba(93, 92, 222, 0.1); color: var(--primary-color);" id="viewTaskCategory">Work</span>
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-color); opacity: 0.8;">
                            <i class="far fa-calendar"></i>
                            <span id="viewTaskDueDate">N/A</span>
                        </div>
                    </div>
                    <p id="viewTaskDescription" style="margin-bottom: 1.5rem;">Task description</p>
                    <div id="viewTaskSubtasksContainer" style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Sub-Tasks</h4>
                        <div id="viewSubtasksList">
                            <!-- Subtasks will be added here -->
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Notes</h4>
                        <p id="viewTaskNotes" style="font-size: 0.875rem; color: var(--text-color); opacity: 0.8;">Task notes</p>
                    </div>
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Time Spent</h4>
                        <p id="viewTaskTimeSpent" style="font-size: 0.875rem; color: var(--text-color);">00:00:00</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="editTaskBtn">Edit</button>
                    <button class="btn btn-info" id="shareTaskBtn">Share</button>
                    <button class="btn btn-dark" id="closeViewTaskBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- EDIT TASK MODAL -->
        <div class="modal-overlay" id="editTaskModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Edit Task</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    <div class="form-group">
                        <label for="editTaskTitle">Title</label>
                        <input type="text" id="editTaskTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editTaskDescription">Description</label>
                        <textarea id="editTaskDescription" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sub-Tasks</label>
                        <div id="editSubtasksContainer">
                            <!-- Subtasks will be added here -->
                        </div>
                        <button class="btn btn-sm btn-primary" id="editAddSubtaskBtn" style="margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i> Add Subtask
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="editTaskDueDate">Due Date</label>
                        <input type="text" id="editTaskDueDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="editTaskPriority">Priority</label>
                        <select id="editTaskPriority" class="form-control">
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskCategory">Category</label>
                        <select id="editTaskCategory" class="form-control">
                            <option value="Work">Work</option>
                            <option value="Personal">Personal</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Health">Health</option>
                            <option value="Education">Education</option>
                            <option value="Finance">Finance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTaskNotes">Notes</label>
                        <textarea id="editTaskNotes" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="saveTaskBtn">Save Changes</button>
                    <button class="btn btn-dark" id="cancelEditTaskBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- SHARE TASK MODAL -->
        <div class="modal-overlay" id="shareTaskModal">
            <div class="modal-container" style="max-width: 500px;">
                <div class="modal-header">
                    <div class="modal-title">Share Task</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="shareTaskTitle">Task</label>
                        <input type="text" id="shareTaskTitle" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="shareMethod">Share Via</label>
                        <select id="shareMethod" class="form-control">
                            <option value="email">Email</option>
                            <option value="link">Generate Link</option>
                            <option value="user">Share with User</option>
                        </select>
                    </div>
                    <div id="emailShareSection">
                        <div class="form-group">
                            <label for="shareEmail">Email Address</label>
                            <input type="email" id="shareEmail" class="form-control" placeholder="Enter email address">
                        </div>
                        <div class="form-group">
                            <label for="shareMessage">Message (Optional)</label>
                            <textarea id="shareMessage" class="form-control" rows="2" placeholder="Add a message..."></textarea>
                        </div>
                    </div>
                    <div id="linkShareSection" style="display: none;">
                        <div class="form-group">
                            <label for="shareLink">Shareable Link</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="shareLink" class="form-control" readonly>
                                <button class="btn btn-primary" id="copyLinkBtn">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="userShareSection" style="display: none;">
                        <div class="form-group">
                            <label for="shareUser">Select User</label>
                            <select id="shareUser" class="form-control">
                                <!-- Users will be added here -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sharePermission">Permission</label>
                            <select id="sharePermission" class="form-control">
                                <option value="view">View Only</option>
                                <option value="edit">Edit</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="sendShareBtn">Share</button>
                    <button class="btn btn-dark" id="cancelShareBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- EXPORT MODAL -->
        <div class="modal-overlay" id="exportModal">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">Export Tasks</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="exportFormat">Select Format</label>
                        <select id="exportFormat" class="form-control">
                            <option value="json">JSON</option>
                            <option value="pdf">PDF</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Options</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="exportCompleted" checked>
                            <label for="exportCompleted" style="margin-bottom: 0;">Include completed tasks</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="exportIncludeNotes" checked>
                            <label for="exportIncludeNotes" style="margin-bottom: 0;">Include notes and subtasks</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="downloadExportBtn">Export</button>
                    <button class="btn btn-dark" id="cancelExportBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- IMPORT MODAL -->
        <div class="modal-overlay" id="importModal">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">Import Tasks</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="importMethod">Import Method</label>
                        <select id="importMethod" class="form-control">
                            <option value="file">Upload File</option>
                            <option value="url">Import from URL</option>
                        </select>
                    </div>
                    <div id="fileImportSection">
                        <div class="form-group">
                            <label for="importFile">Select File</label>
                            <input type="file" id="importFile" class="form-control" accept=".json">
                            <small style="display: block; margin-top: 0.25rem; color: var(--text-color); opacity: 0.8;">Supported format: JSON</small>
                        </div>
                    </div>
                    <div id="urlImportSection" style="display: none;">
                        <div class="form-group">
                            <label for="importUrl">Enter URL</label>
                            <input type="text" id="importUrl" class="form-control" placeholder="https://example.com/tasks.json">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Options</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="importReplace">
                            <label for="importReplace" style="margin-bottom: 0;">Replace existing tasks</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="confirmImportBtn">Import</button>
                    <button class="btn btn-dark" id="cancelImportBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- CATEGORIES MODAL -->
        <div class="modal-overlay" id="categoriesModal">
            <div class="modal-container">
                <div class="modal-header">
                    <div class="modal-title">Manage Categories</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <input type="text" id="newCategoryInput" class="form-control" placeholder="New category name">
                        <button class="btn btn-success" id="addCategoryBtn">Add</button>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--card-border);">
                                    <th style="padding: 0.75rem; text-align: left;">Category</th>
                                    <th style="padding: 0.75rem; text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesList">
                                <!-- Categories will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dark" id="closeCategoriesBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- EDIT CATEGORY MODAL -->
        <div class="modal-overlay" id="editCategoryModal">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">Edit Category</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editCategoryInput">Category Name</label>
                        <input type="text" id="editCategoryInput" class="form-control">
                        <input type="hidden" id="editCategoryId">
                    </div>
                    <div class="form-group">
                        <label for="categoryColor">Color</label>
                        <input type="color" id="categoryColor" class="form-control" value="#5D5CDE">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="saveCategoryBtn">Save</button>
                    <button class="btn btn-dark" id="cancelEditCategoryBtn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- USERS MODAL -->
        <div class="modal-overlay" id="usersModal">
            <div class="modal-container" style="max-width: 800px;">
                <div class="modal-header">
                    <div class="modal-title">Users</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="users-grid" id="usersGrid">
                        <!-- Users will be added here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dark" id="closeUsersBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- DATE RANGE PICKER MODAL -->
        <div class="modal-overlay" id="dateRangeModal">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header">
                    <div class="modal-title">Select Date Range</div>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="text" id="startDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="text" id="endDate" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" id="applyDateRangeBtn">Apply</button>
                    <button class="btn btn-dark" id="cancelDateRangeBtn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LIBRARIES -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // APP STATE
        const appState = {
            users: [],
            tasks: [],
            categories: ['Work', 'Personal', 'Shopping', 'Health', 'Education', 'Finance', 'Other'],
            categoriesColors: {
                'Work': '#5D5CDE',
                'Personal': '#28A745',
                'Shopping': '#FFC107',
                'Health': '#DC3545',
                'Education': '#17A2B8',
                'Finance': '#FD7E14',
                'Other': '#6C757D'
            },
            notifications: [],
            currentUser: null,
            selectedTasks: [],
            taskTimers: {},
            activeTimerTaskId: null,
            globalTimer: {
                seconds: 0,
                minutes: 0,
                hours: 0,
                intervalId: null,
                active: false
            },
            actionHistory: {
                past: [],
                future: []
            },
            isDarkMode: false
        };

        // Sample users data
        const sampleUsers = [
            { id: 1, firstName: 'John', lastName: 'Doe', email: 'john@example.com', role: 'Manager', avatar: 'https://randomuser.me/api/portraits/men/32.jpg', taskCount: 8, completedCount: 5 },
            { id: 2, firstName: 'Jane', lastName: 'Smith', email: 'jane@example.com', role: 'Staff', avatar: 'https://randomuser.me/api/portraits/women/44.jpg', taskCount: 12, completedCount: 9 },
            { id: 3, firstName: 'Robert', lastName: 'Johnson', email: 'robert@example.com', role: 'Customer', avatar: 'https://randomuser.me/api/portraits/men/46.jpg', taskCount: 5, completedCount: 2 },
            { id: 4, firstName: 'Emily', lastName: 'Williams', email: 'emily@example.com', role: 'Admin', avatar: 'https://randomuser.me/api/portraits/women/67.jpg', taskCount: 15, completedCount: 10 },
            { id: 5, firstName: 'Michael', lastName: 'Brown', email: 'michael@example.com', role: 'Staff', avatar: 'https://randomuser.me/api/portraits/men/75.jpg', taskCount: 7, completedCount: 3 },
            { id: 6, firstName: 'Sarah', lastName: 'Davis', email: 'sarah@example.com', role: 'Manager', avatar: 'https://randomuser.me/api/portraits/women/90.jpg', taskCount: 9, completedCount: 8 }
        ];

        // Sample tasks data
        const sampleTasks = [
            {
                id: 1,
                title: 'Prepare Project Presentation',
                description: 'Create slides and prepare notes for the quarterly project presentation to stakeholders.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 5)),
                priority: 'high',
                category: 'Work',
                completed: false,
                subtasks: [
                    { id: 101, title: 'Gather project metrics', completed: true },
                    { id: 102, title: 'Create slide deck', completed: false },
                    { id: 103, title: 'Prepare speaking notes', completed: false }
                ],
                notes: 'Focus on highlighting the major achievements and challenges',
                timeSpent: 3600, // in seconds
                createdAt: new Date(new Date().setDate(new Date().getDate() - 3))
            },
            {
                id: 2,
                title: 'Grocery Shopping',
                description: 'Buy groceries for the week including fruits, vegetables, and pantry items.',
                dueDate: new Date(new Date().setHours(new Date().getHours() + 12)),
                priority: 'medium',
                category: 'Shopping',
                completed: false,
                subtasks: [
                    { id: 201, title: 'Fruits & Vegetables', completed: false },
                    { id: 202, title: 'Dairy Products', completed: false },
                    { id: 203, title: 'Meat & Poultry', completed: false },
                    { id: 204, title: 'Pantry Items', completed: false }
                ],
                notes: 'Check for sales and coupons before going',
                timeSpent: 1800,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 1))
            },
            {
                id: 3,
                title: 'Complete Annual Health Checkup',
                description: 'Schedule and complete annual health examination and tests.',
                dueDate: new Date(new Date().setDate(new Date().getDate() - 2)),
                priority: 'high',
                category: 'Health',
                completed: true,
                subtasks: [
                    { id: 301, title: 'Book appointment', completed: true },
                    { id: 302, title: 'Complete blood work', completed: true },
                    { id: 303, title: 'Follow-up consultation', completed: true }
                ],
                notes: 'Bring previous medical records',
                timeSpent: 7200,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 10))
            },
            {
                id: 4,
                title: 'Review Financial Budget',
                description: 'Review monthly expenses and update budget for the next quarter.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 2)),
                priority: 'medium',
                category: 'Finance',
                completed: false,
                subtasks: [
                    { id: 401, title: 'Gather expense reports', completed: true },
                    { id: 402, title: 'Analyze spending patterns', completed: false },
                    { id: 403, title: 'Adjust budget allocations', completed: false }
                ],
                notes: 'Consider upcoming vacation expenses',
                timeSpent: 5400,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 5))
            },
            {
                id: 5,
                title: 'Complete Online Course',
                description: 'Finish remaining modules of JavaScript Advanced course.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 10)),
                priority: 'low',
                category: 'Education',
                completed: false,
                subtasks: [
                    { id: 501, title: 'Module 5: Async Programming', completed: true },
                    { id: 502, title: 'Module 6: Advanced DOM', completed: false },
                    { id: 503, title: 'Module 7: Design Patterns', completed: false },
                    { id: 504, title: 'Final Project', completed: false }
                ],
                notes: 'Allocate at least 2 hours daily',
                timeSpent: 14400,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 15))
            },
            {
                id: 6,
                title: 'Call Parents',
                description: 'Weekly call with parents to catch up.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 1)),
                priority: 'high',
                category: 'Personal',
                completed: false,
                subtasks: [],
                notes: 'Ask about their upcoming trip',
                timeSpent: 0,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 2))
            },
            {
                id: 7,
                title: 'Prepare Tax Documents',
                description: 'Gather and organize documents needed for tax filing.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 20)),
                priority: 'medium',
                category: 'Finance',
                completed: false,
                subtasks: [
                    { id: 701, title: 'Collect income statements', completed: true },
                    { id: 702, title: 'Organize receipts', completed: false },
                    { id: 703, title: 'Review deductions', completed: false }
                ],
                notes: 'Consult with tax advisor if needed',
                timeSpent: 2700,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 8))
            },
            {
                id: 8,
                title: 'Team Building Event Planning',
                description: 'Coordinate and plan quarterly team building activity.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 15)),
                priority: 'medium',
                category: 'Work',
                completed: false,
                subtasks: [
                    { id: 801, title: 'Research activity options', completed: true },
                    { id: 802, title: 'Get team preferences', completed: true },
                    { id: 803, title: 'Book venue/service', completed: false },
                    { id: 804, title: 'Send invitations', completed: false }
                ],
                notes: 'Budget approved: $50 per person',
                timeSpent: 9000,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 12))
            },
            {
                id: 9,
                title: 'Home Office Setup',
                description: 'Set up an ergonomic home office workspace.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 7)),
                priority: 'low',
                category: 'Personal',
                completed: false,
                subtasks: [
                    { id: 901, title: 'Purchase desk and chair', completed: false },
                    { id: 902, title: 'Set up computer and peripherals', completed: false },
                    { id: 903, title: 'Organize cables and lighting', completed: false }
                ],
                notes: 'Check online reviews before purchasing equipment',
                timeSpent: 3600,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 6))
            },
            {
                id: 10,
                title: 'Dentist Appointment',
                description: 'Routine dental checkup and cleaning.',
                dueDate: new Date(new Date().setHours(new Date().getHours() + 36)),
                priority: 'high',
                category: 'Health',
                completed: false,
                subtasks: [
                    { id: 1001, title: 'Confirm appointment', completed: true },
                    { id: 1002, title: 'Fill out new patient forms', completed: false }
                ],
                notes: 'Bring insurance card',
                timeSpent: 900,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 4))
            },
            {
                id: 11,
                title: 'Update Resume',
                description: 'Refresh resume with recent projects and skills.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 30)),
                priority: 'low',
                category: 'Personal',
                completed: false,
                subtasks: [
                    { id: 1101, title: 'Update work experience', completed: false },
                    { id: 1102, title: 'Add new skills', completed: false },
                    { id: 1103, title: 'Review and proofread', completed: false }
                ],
                notes: 'Consider getting professional feedback',
                timeSpent: 1800,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 9))
            },
            {
                id: 12,
                title: 'Research Vacation Destinations',
                description: 'Research and compare potential vacation spots for summer trip.',
                dueDate: new Date(new Date().setDate(new Date().getDate() + 45)),
                priority: 'medium',
                category: 'Personal',
                completed: false,
                subtasks: [
                    { id: 1201, title: 'List top 5 destinations', completed: true },
                    { id: 1202, title: 'Compare costs', completed: false },
                    { id: 1203, title: 'Check travel restrictions', completed: false },
                    { id: 1204, title: 'Read reviews', completed: false }
                ],
                notes: 'Consider weather patterns for each location',
                timeSpent: 4500,
                createdAt: new Date(new Date().setDate(new Date().getDate() - 20))
            }
        ];

        // DOM ELEMENTS
        const elements = {
            // Pages
            loginPage: document.getElementById('loginPage'),
            dashboardPage: document.getElementById('dashboardPage'),

            // Login Elements
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            loginBtn: document.getElementById('loginBtn'),
            registerLink: document.getElementById('registerLink'),

            // Dashboard Elements
            dashboardLink: document.getElementById('dashboardLink'),
            totalTasksCount: document.getElementById('totalTasksCount'),
            completedTasksCount: document.getElementById('completedTasksCount'),
            pendingTasksCount: document.getElementById('pendingTasksCount'),
            
            // Header Elements
            profileImg: document.getElementById('profileImg'),
            profileBadge: document.getElementById('profileBadge'),
            profileDropdown: document.getElementById('profileDropdown'),
            notificationsIcon: document.getElementById('notificationsIcon'),
            notificationsBadge: document.getElementById('notificationsBadge'),
            notificationsDropdown: document.getElementById('notificationsDropdown'),
            notificationsList: document.getElementById('notificationsList'),
            markAllRead: document.getElementById('markAllRead'),
            profileNotificationBadge: document.getElementById('profileNotificationBadge'),
            viewProfileBtn: document.getElementById('viewProfileBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            switchModeBtn: document.getElementById('switchModeBtn'),
            changeStatusBtn: document.getElementById('changeStatusBtn'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            modeSwitcher: document.getElementById('modeSwitcher'),
            
            // Timer Elements
            timer: document.getElementById('timer'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            
            // Tasks Elements
            addTaskBtn: document.getElementById('addTaskBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            categoriesBtn: document.getElementById('categoriesBtn'),
            usersBtn: document.getElementById('usersBtn'),
            searchInput: document.getElementById('searchInput'),
            statusFilter: document.getElementById('statusFilter'),
            categoryFilter: document.getElementById('categoryFilter'),
            priorityFilter: document.getElementById('priorityFilter'),
            dueDateFilter: document.getElementById('dueDateFilter'),
            sortFilter: document.getElementById('sortFilter'),
            listViewBtn: document.getElementById('listViewBtn'),
            graphViewBtn: document.getElementById('graphViewBtn'),
            listView: document.getElementById('listView'),
            graphView: document.getElementById('graphView'),
            
            // Multi-select Action Bar
            actionsBar: document.getElementById('actionsBar'),
            completeSelectedBtn: document.getElementById('completeSelectedBtn'),
            deleteSelectedBtn: document.getElementById('deleteSelectedBtn'),
            cancelSelectionBtn: document.getElementById('cancelSelectionBtn'),
            
            // History Controls
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            
            // Insights Elements
            productivityScore: document.getElementById('productivityScore'),
            expiredTasksCount: document.getElementById('expiredTasksCount'),
            dueSoonTasksCount: document.getElementById('dueSoonTasksCount'),
            avgCompletionTime: document.getElementById('avgCompletionTime'),
            commonCategory: document.getElementById('commonCategory'),
            completionRate: document.getElementById('completionRate'),
            
            // Toast Container
            toastContainer: document.getElementById('toastContainer'),
            
            // Modals
            registerModal: document.getElementById('registerModal'),
            profileModal: document.getElementById('profileModal'),
            editProfileModal: document.getElementById('editProfileModal'),
            addTaskModal: document.getElementById('addTaskModal'),
            viewTaskModal: document.getElementById('viewTaskModal'),
            editTaskModal: document.getElementById('editTaskModal'),
            shareTaskModal: document.getElementById('shareTaskModal'),
            exportModal: document.getElementById('exportModal'),
            importModal: document.getElementById('importModal'),
            categoriesModal: document.getElementById('categoriesModal'),
            editCategoryModal: document.getElementById('editCategoryModal'),
            usersModal: document.getElementById('usersModal'),
            statusModal: document.getElementById('statusModal'),
            dateRangeModal: document.getElementById('dateRangeModal')
        };

        // UTILITY FUNCTIONS
        function formatDate(date) {
            if (!date) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(date).toLocaleDateString(undefined, options);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }

        function generateId() {
            return Date.now() + Math.floor(Math.random() * 1000);
        }

        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let iconClass;
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    toast.style.borderLeftColor = 'var(--success-color)';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle';
                    toast.style.borderLeftColor = 'var(--danger-color)';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    toast.style.borderLeftColor = 'var(--warning-color)';
                    break;
                default:
                    iconClass = 'fas fa-info-circle';
                    toast.style.borderLeftColor = 'var(--primary-color)';
            }
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-text">${message}</div>
                </div>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            // Remove toast after animation completes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function showModal(modal) {
            modal.classList.add('active');
        }

        function hideModal(modal) {
            modal.classList.remove('active');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            appState.isDarkMode = document.documentElement.classList.contains('dark');
            
            // Update switch mode button text
            elements.switchModeBtn.innerHTML = `
                <i class="fas ${appState.isDarkMode ? 'fa-sun' : 'fa-moon'}"></i>
                <span>Switch to ${appState.isDarkMode ? 'Light' : 'Dark'} Mode</span>
            `;
            
            // Save preference to localStorage
            localStorage.setItem('darkMode', appState.isDarkMode);
            
            // Update any chart colors
            updateCharts();
        }

        function addToHistory(action, data) {
            appState.actionHistory.past.push({ action, data });
            appState.actionHistory.future = [];
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            elements.undoBtn.disabled = appState.actionHistory.past.length === 0;
            elements.redoBtn.disabled = appState.actionHistory.future.length === 0;
        }

        function undo() {
            if (appState.actionHistory.past.length === 0) return;
            
            const lastAction = appState.actionHistory.past.pop();
            appState.actionHistory.future.push(lastAction);
            
            switch (lastAction.action) {
                case 'addTask':
                    const taskId = lastAction.data.id;
                    appState.tasks = appState.tasks.filter(task => task.id !== taskId);
                    break;
                    
                case 'deleteTask':
                    appState.tasks.push(lastAction.data);
                    break;
                    
                case 'editTask':
                    const editIndex = appState.tasks.findIndex(task => task.id === lastAction.data.newTask.id);
                    if (editIndex !== -1) {
                        appState.tasks[editIndex] = lastAction.data.oldTask;
                    }
                    break;
                    
                case 'completeTask':
                    const completeIndex = appState.tasks.findIndex(task => task.id === lastAction.data.id);
                    if (completeIndex !== -1) {
                        appState.tasks[completeIndex].completed = !lastAction.data.completed;
                    }
                    break;
                    
                case 'batchComplete':
                    lastAction.data.forEach(taskId => {
                        const index = appState.tasks.findIndex(task => task.id === taskId);
                        if (index !== -1) {
                            appState.tasks[index].completed = !appState.tasks[index].completed;
                        }
                    });
                    break;
                    
                case 'batchDelete':
                    appState.tasks = [...appState.tasks, ...lastAction.data];
                    break;
            }
            
            saveTasksToLocalStorage();
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
            updateHistoryButtons();
        }

        function redo() {
            if (appState.actionHistory.future.length === 0) return;
            
            const nextAction = appState.actionHistory.future.pop();
            appState.actionHistory.past.push(nextAction);
            
            switch (nextAction.action) {
                case 'addTask':
                    appState.tasks.push(nextAction.data);
                    break;
                    
                case 'deleteTask':
                    const taskId = nextAction.data.id;
                    appState.tasks = appState.tasks.filter(task => task.id !== taskId);
                    break;
                    
                case 'editTask':
                    const editIndex = appState.tasks.findIndex(task => task.id === nextAction.data.oldTask.id);
                    if (editIndex !== -1) {
                        appState.tasks[editIndex] = nextAction.data.newTask;
                    }
                    break;
                    
                case 'completeTask':
                    const completeIndex = appState.tasks.findIndex(task => task.id === nextAction.data.id);
                    if (completeIndex !== -1) {
                        appState.tasks[completeIndex].completed = nextAction.data.completed;
                    }
                    break;
                    
                case 'batchComplete':
                    nextAction.data.forEach(taskId => {
                        const index = appState.tasks.findIndex(task => task.id === taskId);
                        if (index !== -1) {
                            appState.tasks[index].completed = !appState.tasks[index].completed;
                        }
                    });
                    break;
                    
                case 'batchDelete':
                    appState.tasks = appState.tasks.filter(task => !nextAction.data.some(t => t.id === task.id));
                    break;
            }
            
            saveTasksToLocalStorage();
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
            updateHistoryButtons();
        }

        // TIMER FUNCTIONS
        function startGlobalTimer() {
            if (appState.globalTimer.intervalId) return;
            
            appState.globalTimer.active = true;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            
            appState.globalTimer.intervalId = setInterval(() => {
                appState.globalTimer.seconds++;
                if (appState.globalTimer.seconds >= 60) {
                    appState.globalTimer.seconds = 0;
                    appState.globalTimer.minutes++;
                    if (appState.globalTimer.minutes >= 60) {
                        appState.globalTimer.minutes = 0;
                        appState.globalTimer.hours++;
                    }
                }
                
                elements.timer.textContent = [
                    appState.globalTimer.hours.toString().padStart(2, '0'),
                    appState.globalTimer.minutes.toString().padStart(2, '0'),
                    appState.globalTimer.seconds.toString().padStart(2, '0')
                ].join(':');
                
                // If there's an active task timer, increment it as well
                if (appState.activeTimerTaskId) {
                    const task = appState.tasks.find(t => t.id === appState.activeTimerTaskId);
                    if (task) {
                        task.timeSpent = (task.timeSpent || 0) + 1;
                        saveTasksToLocalStorage();
                    }
                }
            }, 1000);
        }

        function pauseGlobalTimer() {
            if (!appState.globalTimer.intervalId) return;
            
            appState.globalTimer.active = false;
            elements.playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            
            clearInterval(appState.globalTimer.intervalId);
            appState.globalTimer.intervalId = null;
            
            // If there's an active task timer, pause it as well
            if (appState.activeTimerTaskId) {
                pauseTaskTimer(appState.activeTimerTaskId);
            }
        }

        function resetGlobalTimer() {
            pauseGlobalTimer();
            
            appState.globalTimer.seconds = 0;
            appState.globalTimer.minutes = 0;
            appState.globalTimer.hours = 0;
            
            elements.timer.textContent = '00:00:00';
        }

        function startTaskTimer(taskId) {
            pauseTaskTimer(); // Pause any active timer
            
            appState.activeTimerTaskId = taskId;
            startGlobalTimer();
            
            // Update UI for the task
            const timerBtn = document.querySelector(`#task-${taskId} .task-timer-btn`);
            if (timerBtn) {
                timerBtn.innerHTML = '<i class="fas fa-pause"></i>';
                timerBtn.classList.add('active');
            }
            
            showToast('Timer Started', `Timer started for task "${appState.tasks.find(t => t.id === taskId).title}"`, 'info');
        }

        function pauseTaskTimer(taskId = appState.activeTimerTaskId) {
            if (!taskId) return;
            
            pauseGlobalTimer();
            
            // Update UI for the task
            const timerBtn = document.querySelector(`#task-${taskId} .task-timer-btn`);
            if (timerBtn) {
                timerBtn.innerHTML = '<i class="fas fa-play"></i>';
                timerBtn.classList.remove('active');
            }
            
            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                showToast('Timer Paused', `Time spent on "${task.title}": ${formatTime(task.timeSpent || 0)}`, 'info');
            }
            
            appState.activeTimerTaskId = null;
        }

        // TASK MANAGEMENT FUNCTIONS
        function addTask(task) {
            const newTask = {
                id: task.id || generateId(),
                title: task.title,
                description: task.description,
                dueDate: task.dueDate,
                priority: task.priority,
                category: task.category,
                completed: task.completed || false,
                subtasks: task.subtasks || [],
                notes: task.notes || '',
                timeSpent: task.timeSpent || 0,
                createdAt: task.createdAt || new Date()
            };
            
            appState.tasks.push(newTask);
            addToHistory('addTask', newTask);
            saveTasksToLocalStorage();
            
            // Add notification
            addNotification(`Task Added: ${newTask.title}`, `A new task has been added to your list.`);
            
            return newTask;
        }

        function editTask(taskId, updatedTask) {
            const index = appState.tasks.findIndex(task => task.id === taskId);
            if (index !== -1) {
                const oldTask = { ...appState.tasks[index] };
                
                appState.tasks[index] = {
                    ...oldTask,
                    title: updatedTask.title,
                    description: updatedTask.description,
                    dueDate: updatedTask.dueDate,
                    priority: updatedTask.priority,
                    category: updatedTask.category,
                    subtasks: updatedTask.subtasks,
                    notes: updatedTask.notes
                };
                
                addToHistory('editTask', { oldTask, newTask: { ...appState.tasks[index] } });
                saveTasksToLocalStorage();
                
                // Add notification
                addNotification(`Task Updated: ${updatedTask.title}`, `The task has been modified.`);
                
                return appState.tasks[index];
            }
            return null;
        }

        function deleteTask(taskId) {
            const index = appState.tasks.findIndex(task => task.id === taskId);
            if (index !== -1) {
                const deletedTask = appState.tasks[index];
                appState.tasks.splice(index, 1);
                
                addToHistory('deleteTask', deletedTask);
                saveTasksToLocalStorage();
                
                // Add notification
                addNotification(`Task Deleted: ${deletedTask.title}`, `The task has been removed from your list.`);
                
                return true;
            }
            return false;
        }

        function toggleTaskCompletion(taskId) {
            const index = appState.tasks.findIndex(task => task.id === taskId);
            if (index !== -1) {
                const completed = !appState.tasks[index].completed;
                appState.tasks[index].completed = completed;
                
                addToHistory('completeTask', { id: taskId, completed });
                saveTasksToLocalStorage();
                
                // Add notification
                const task = appState.tasks[index];
                addNotification(
                    `Task ${completed ? 'Completed' : 'Reopened'}: ${task.title}`,
                    `The task has been marked as ${completed ? 'completed' : 'incomplete'}.`
                );
                
                return true;
            }
            return false;
        }

        function batchCompleteSelected() {
            if (appState.selectedTasks.length === 0) return;
            
            const taskIds = [...appState.selectedTasks];
            
            taskIds.forEach(taskId => {
                const index = appState.tasks.findIndex(task => task.id === taskId);
                if (index !== -1) {
                    appState.tasks[index].completed = true;
                }
            });
            
            addToHistory('batchComplete', taskIds);
            saveTasksToLocalStorage();
            
            // Add notification
            addNotification(
                `Tasks Completed: ${taskIds.length} items`,
                `Multiple tasks have been marked as completed.`
            );
            
            // Clear selection
            appState.selectedTasks = [];
            elements.actionsBar.classList.remove('active');
            
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
        }

        function batchDeleteSelected() {
            if (appState.selectedTasks.length === 0) return;
            
            const deletedTasks = appState.tasks.filter(task => appState.selectedTasks.includes(task.id));
            
            appState.tasks = appState.tasks.filter(task => !appState.selectedTasks.includes(task.id));
            
            addToHistory('batchDelete', deletedTasks);
            saveTasksToLocalStorage();
            
            // Add notification
            addNotification(
                `Tasks Deleted: ${deletedTasks.length} items`,
                `Multiple tasks have been removed from your list.`
            );
            
            // Clear selection
            appState.selectedTasks = [];
            elements.actionsBar.classList.remove('active');
            
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
        }

        // NOTIFICATION MANAGEMENT
        function addNotification(title, text) {
            const notification = {
                id: generateId(),
                title,
                text,
                time: new Date(),
                read: false
            };
            
            appState.notifications.unshift(notification);
            
            // Limit to 50 notifications
            if (appState.notifications.length > 50) {
                appState.notifications.pop();
            }
            
            updateNotificationBadges();
            renderNotifications();
            saveNotificationsToLocalStorage();
            
            return notification;
        }

        function markNotificationAsRead(notificationId) {
            const notification = appState.notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadges();
                renderNotifications();
                saveNotificationsToLocalStorage();
            }
        }

        function markAllNotificationsAsRead() {
            appState.notifications.forEach(notification => {
                notification.read = true;
            });
            
            updateNotificationBadges();
            renderNotifications();
            saveNotificationsToLocalStorage();
        }

        function updateNotificationBadges() {
            const unreadCount = appState.notifications.filter(n => !n.read).length;
            
            elements.notificationsBadge.textContent = unreadCount;
            elements.profileNotificationBadge.textContent = unreadCount;
            
            if (unreadCount > 0) {
                elements.notificationsBadge.style.display = 'flex';
                elements.profileNotificationBadge.style.display = 'flex';
            } else {
                elements.notificationsBadge.style.display = 'none';
                elements.profileNotificationBadge.style.display = 'none';
            }
        }

        // LOCAL STORAGE MANAGEMENT
        function loadFromLocalStorage() {
            try {
                // Load users
                const storedUsers = localStorage.getItem('todoAppUsers');
                if (storedUsers) {
                    appState.users = JSON.parse(storedUsers);
                } else {
                    appState.users = sampleUsers;
                    localStorage.setItem('todoAppUsers', JSON.stringify(sampleUsers));
                }
                
                // Load tasks
                const storedTasks = localStorage.getItem('todoAppTasks');
                if (storedTasks) {
                    const parsedTasks = JSON.parse(storedTasks);
                    appState.tasks = parsedTasks.map(task => ({
                        ...task,
                        dueDate: task.dueDate ? new Date(task.dueDate) : null,
                        createdAt: task.createdAt ? new Date(task.createdAt) : new Date()
                    }));
                } else {
                    appState.tasks = sampleTasks;
                    saveTasksToLocalStorage();
                }
                
                // Load categories
                const storedCategories = localStorage.getItem('todoAppCategories');
                if (storedCategories) {
                    appState.categories = JSON.parse(storedCategories);
                }
                
                const storedCategoriesColors = localStorage.getItem('todoAppCategoriesColors');
                if (storedCategoriesColors) {
                    appState.categoriesColors = JSON.parse(storedCategoriesColors);
                }
                
                // Load notifications
                const storedNotifications = localStorage.getItem('todoAppNotifications');
                if (storedNotifications) {
                    const parsedNotifications = JSON.parse(storedNotifications);
                    appState.notifications = parsedNotifications.map(notification => ({
                        ...notification,
                        time: new Date(notification.time)
                    }));
                } else {
                    // Sample notification
                    appState.notifications = [
                        {
                            id: generateId(),
                            title: 'Welcome to Task Manager',
                            text: 'Start organizing your tasks effectively!',
                            time: new Date(),
                            read: false
                        }
                    ];
                    saveNotificationsToLocalStorage();
                }
                
                // Load current user
                const storedCurrentUser = localStorage.getItem('todoAppCurrentUser');
                if (storedCurrentUser) {
                    appState.currentUser = JSON.parse(storedCurrentUser);
                }
                
                // Load dark mode preference
                const darkMode = localStorage.getItem('darkMode');
                if (darkMode === 'true') {
                    document.documentElement.classList.add('dark');
                    appState.isDarkMode = true;
                    elements.switchModeBtn.innerHTML = `<i class="fas fa-sun"></i><span>Switch to Light Mode</span>`;
                } else {
                    elements.switchModeBtn.innerHTML = `<i class="fas fa-moon"></i><span>Switch to Dark Mode</span>`;
                }
                
                // Load timer state
                const storedTimer = localStorage.getItem('todoAppTimer');
                if (storedTimer) {
                    const parsedTimer = JSON.parse(storedTimer);
                    appState.globalTimer.seconds = parsedTimer.seconds;
                    appState.globalTimer.minutes = parsedTimer.minutes;
                    appState.globalTimer.hours = parsedTimer.hours;
                    elements.timer.textContent = [
                        appState.globalTimer.hours.toString().padStart(2, '0'),
                        appState.globalTimer.minutes.toString().padStart(2, '0'),
                        appState.globalTimer.seconds.toString().padStart(2, '0')
                    ].join(':');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                showToast('Error', 'There was a problem loading your data.', 'error');
            }
        }

        function saveTasksToLocalStorage() {
            try {
                localStorage.setItem('todoAppTasks', JSON.stringify(appState.tasks));
            } catch (error) {
                console.error('Error saving tasks to localStorage:', error);
                showToast('Error', 'There was a problem saving your tasks.', 'error');
            }
        }

        function saveUsersToLocalStorage() {
            try {
                localStorage.setItem('todoAppUsers', JSON.stringify(appState.users));
            } catch (error) {
                console.error('Error saving users to localStorage:', error);
                showToast('Error', 'There was a problem saving user data.', 'error');
            }
        }

        function saveCurrentUserToLocalStorage() {
            try {
                localStorage.setItem('todoAppCurrentUser', JSON.stringify(appState.currentUser));
            } catch (error) {
                console.error('Error saving current user to localStorage:', error);
                showToast('Error', 'There was a problem saving your user data.', 'error');
            }
        }

        function saveCategoriesToLocalStorage() {
            try {
                localStorage.setItem('todoAppCategories', JSON.stringify(appState.categories));
                localStorage.setItem('todoAppCategoriesColors', JSON.stringify(appState.categoriesColors));
            } catch (error) {
                console.error('Error saving categories to localStorage:', error);
                showToast('Error', 'There was a problem saving your categories.', 'error');
            }
        }

        function saveNotificationsToLocalStorage() {
            try {
                localStorage.setItem('todoAppNotifications', JSON.stringify(appState.notifications));
            } catch (error) {
                console.error('Error saving notifications to localStorage:', error);
                showToast('Error', 'There was a problem saving notifications.', 'error');
            }
        }

        function saveTimerToLocalStorage() {
            try {
                localStorage.setItem('todoAppTimer', JSON.stringify({
                    seconds: appState.globalTimer.seconds,
                    minutes: appState.globalTimer.minutes,
                    hours: appState.globalTimer.hours
                }));
            } catch (error) {
                console.error('Error saving timer to localStorage:', error);
            }
        }

        // RENDERS & UPDATES
        function renderTasks() {
            // Apply filters
            let filteredTasks = [...appState.tasks];
            
            // Status filter
            const statusFilter = elements.statusFilter.value;
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    if (statusFilter === 'active') return !task.completed;
                    if (statusFilter === 'completed') return task.completed;
                    return true;
                });
            }
            
            // Category filter
            const categoryFilter = elements.categoryFilter.value;
            if (categoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilter);
            }
            
            // Priority filter
            const priorityFilter = elements.priorityFilter.value;
            if (priorityFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.priority === priorityFilter);
            }
            
            // Due date filter
            const dueDateFilter = elements.dueDateFilter.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (dueDateFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => {
                    if (!task.dueDate) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    
                    if (dueDateFilter === 'today') {
                        return dueDate.getTime() === today.getTime();
                    }
                    
                    if (dueDateFilter === 'week') {
                        const endOfWeek = new Date(today);
                        endOfWeek.setDate(today.getDate() + 7);
                        return dueDate >= today && dueDate <= endOfWeek;
                    }
                    
                    if (dueDateFilter === 'month') {
                        const endOfMonth = new Date(today);
                        endOfMonth.setMonth(today.getMonth() + 1);
                        return dueDate >= today && dueDate <= endOfMonth;
                    }
                    
                    if (dueDateFilter === 'custom' && window.customDateRange) {
                        return dueDate >= window.customDateRange.start && dueDate <= window.customDateRange.end;
                    }
                    
                    return true;
                });
            }
            
            // Search filter
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) || 
                    task.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort tasks
            const sortBy = elements.sortFilter.value;
            filteredTasks.sort((a, b) => {
                switch (sortBy) {
                    case 'dateAsc':
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    case 'dateDesc':
                        return new Date(b.dueDate) - new Date(a.dueDate);
                    case 'titleAsc':
                        return a.title.localeCompare(b.title);
                    case 'titleDesc':
                        return b.title.localeCompare(a.title);
                    case 'priorityDesc':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    case 'priorityAsc':
                        const priorityOrderAsc = { high: 3, medium: 2, low: 1 };
                        return priorityOrderAsc[a.priority] - priorityOrderAsc[b.priority];
                    default:
                        return new Date(b.dueDate) - new Date(a.dueDate);
                }
            });
            
            // Render the tasks
            elements.listView.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                elements.listView.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.7;">
                        <i class="fas fa-tasks" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>No tasks found. Try adjusting your filters or add a new task.</p>
                    </div>
                `;
                return;
            }
            
            filteredTasks.forEach(task => {
                const now = new Date();
                const dueDate = new Date(task.dueDate);
                const hoursUntilDue = (dueDate - now) / (1000 * 60 * 60);
                
                let statusClass = '';
                if (task.completed) {
                    statusClass = 'completed';
                } else if (hoursUntilDue < 0) {
                    statusClass = 'expired';
                } else if (hoursUntilDue <= 48) {
                    statusClass = 'due-soon';
                } else {
                    statusClass = 'due-later';
                }
                
                const priorityClass = `badge-${task.priority}`;
                const isSelected = appState.selectedTasks.includes(task.id);
                
                const taskElement = document.createElement('div');
                taskElement.id = `task-${task.id}`;
                taskElement.className = `task-item ${statusClass} ${isSelected ? 'selected' : ''}`;
                taskElement.setAttribute('draggable', 'true');
                
                if (task.timeSpent > 0) {
                    taskElement.innerHTML += `
                        <div class="task-time">
                            <i class="fas fa-stopwatch"></i> ${formatTime(task.timeSpent)}
                        </div>
                    `;
                }
                
                taskElement.innerHTML += `
                    <div class="task-header">
                        <div style="display: flex; align-items: center;">
                            <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} aria-label="Mark task as ${task.completed ? 'incomplete' : 'complete'}">
                            <h3 class="task-title" style="margin-left: 0.75rem;">${task.title}</h3>
                        </div>
                        <div class="task-badges">
                            <span class="task-badge ${priorityClass}">${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                            <span class="task-badge" style="background-color: rgba(93, 92, 222, 0.1); color: var(--primary-color);">${task.category}</span>
                        </div>
                    </div>
                    <div class="task-description">${task.description}</div>
                `;
                
                // Add subtasks if they exist
                if (task.subtasks && task.subtasks.length > 0) {
                    const subtasksHtml = task.subtasks.map(subtask => `
                        <div class="subtask-item">
                            <input type="checkbox" ${subtask.completed ? 'checked' : ''} disabled>
                            <span ${subtask.completed ? 'style="text-decoration: line-through;"' : ''}>${subtask.title}</span>
                        </div>
                    `).join('');
                    
                    taskElement.innerHTML += `
                        <div class="subtasks">
                            ${subtasksHtml}
                        </div>
                    `;
                }
                
                taskElement.innerHTML += `
                    <div class="task-footer">
                        <div class="task-meta">
                            <span><i class="far fa-calendar"></i> ${formatDate(task.dueDate)}</span>
                            ${task.notes ? `<span><i class="far fa-sticky-note"></i> Has notes</span>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-sm btn-primary task-timer-btn" aria-label="Track time for this task">
                                <i class="fas ${appState.activeTimerTaskId === task.id ? 'fa-pause' : 'fa-play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-info view-task-btn" aria-label="View task details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary edit-task-btn" aria-label="Edit task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-task-btn" aria-label="Delete task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                elements.listView.appendChild(taskElement);
                
                // Add event listeners
                const checkbox = taskElement.querySelector('.task-checkbox');
                checkbox.addEventListener('change', () => {
                    toggleTaskCompletion(task.id);
                    renderTasks();
                    updateTaskCounts();
                    updateInsights();
                    updateCharts();
                });
                
                const viewBtn = taskElement.querySelector('.view-task-btn');
                viewBtn.addEventListener('click', () => {
                    openViewTaskModal(task);
                });
                
                const editBtn = taskElement.querySelector('.edit-task-btn');
                editBtn.addEventListener('click', () => {
                    openEditTaskModal(task);
                });
                
                const deleteBtn = taskElement.querySelector('.delete-task-btn');
                deleteBtn.addEventListener('click', () => {
                    deleteTask(task.id);
                    renderTasks();
                    updateTaskCounts();
                    updateInsights();
                    updateCharts();
                });
                
                const timerBtn = taskElement.querySelector('.task-timer-btn');
                timerBtn.addEventListener('click', () => {
                    if (appState.activeTimerTaskId === task.id) {
                        pauseTaskTimer(task.id);
                    } else {
                        startTaskTimer(task.id);
                    }
                });
                
                // Add drag and drop event listeners
                taskElement.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', task.id);
                    setTimeout(() => {
                        taskElement.classList.add('dragging');
                    }, 0);
                });
                
                taskElement.addEventListener('dragend', () => {
                    taskElement.classList.remove('dragging');
                });
                
                taskElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    taskElement.classList.add('drag-over');
                });
                
                taskElement.addEventListener('dragleave', () => {
                    taskElement.classList.remove('drag-over');
                });
                
                taskElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    taskElement.classList.remove('drag-over');
                    
                    const draggedTaskId = parseInt(e.dataTransfer.getData('text/plain'));
                    if (draggedTaskId === task.id) return;
                    
                    // Reorder tasks
                    const draggedIndex = appState.tasks.findIndex(t => t.id === draggedTaskId);
                    const targetIndex = appState.tasks.findIndex(t => t.id === task.id);
                    
                    if (draggedIndex !== -1 && targetIndex !== -1) {
                        const [removed] = appState.tasks.splice(draggedIndex, 1);
                        appState.tasks.splice(targetIndex, 0, removed);
                        saveTasksToLocalStorage();
                        renderTasks();
                    }
                });
                
                // Enable multi-select with checkbox or task item click
                taskElement.addEventListener('click', (e) => {
                    // Ignore clicks on specific elements
                    if (
                        e.target.closest('.task-checkbox') ||
                        e.target.closest('.task-timer-btn') ||
                        e.target.closest('.view-task-btn') ||
                        e.target.closest('.edit-task-btn') ||
                        e.target.closest('.delete-task-btn')
                    ) {
                        return;
                    }
                    
                    // Toggle selection
                    if (e.ctrlKey || e.metaKey) {
                        if (isSelected) {
                            appState.selectedTasks = appState.selectedTasks.filter(id => id !== task.id);
                        } else {
                            appState.selectedTasks.push(task.id);
                        }
                        
                        taskElement.classList.toggle('selected');
                        
                        // Toggle actions bar
                        if (appState.selectedTasks.length > 0) {
                            elements.actionsBar.classList.add('active');
                        } else {
                            elements.actionsBar.classList.remove('active');
                        }
                    }
                });
            });
        }

        function updateTaskCounts() {
            const totalCount = appState.tasks.length;
            const completedCount = appState.tasks.filter(task => task.completed).length;
            const pendingCount = totalCount - completedCount;
            
            elements.totalTasksCount.textContent = totalCount;
            elements.completedTasksCount.textContent = completedCount;
            elements.pendingTasksCount.textContent = pendingCount;
        }

        function updateInsights() {
            // Productivity Score
            const totalCount = appState.tasks.length;
            const completedCount = appState.tasks.filter(task => task.completed).length;
            const productivityScore = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            elements.productivityScore.textContent = `${productivityScore}%`;
            
            // Expired Tasks
            const now = new Date();
            const expiredCount = appState.tasks.filter(task => {
                if (task.completed) return false;
                return new Date(task.dueDate) < now;
            }).length;
            elements.expiredTasksCount.textContent = expiredCount;
            
            // Due Soon Tasks
            const in48Hours = new Date(now);
            in48Hours.setHours(now.getHours() + 48);
            
            const dueSoonCount = appState.tasks.filter(task => {
                if (task.completed) return false;
                const dueDate = new Date(task.dueDate);
                return dueDate >= now && dueDate <= in48Hours;
            }).length;
            elements.dueSoonTasksCount.textContent = dueSoonCount;
            
            // Average Completion Time
            const completedTasks = appState.tasks.filter(task => task.completed);
            let totalTime = 0;
            completedTasks.forEach(task => {
                totalTime += task.timeSpent || 0;
            });
            
            const avgTime = completedTasks.length > 0 ? Math.round(totalTime / completedTasks.length / 3600) : 0;
            elements.avgCompletionTime.textContent = `${avgTime}h`;
            
            // Most Common Category
            const categoryCounts = {};
            appState.tasks.forEach(task => {
                categoryCounts[task.category] = (categoryCounts[task.category] || 0) + 1;
            });
            
            let maxCount = 0;
            let commonCategory = '-';
            
            for (const [category, count] of Object.entries(categoryCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    commonCategory = category;
                }
            }
            
            elements.commonCategory.textContent = commonCategory;
            
            // Completion Rate
            const weeklyCompletionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
            elements.completionRate.textContent = `${weeklyCompletionRate}%`;
        }

        function updateCharts() {
            const ctx = document.getElementById('tasksChart').getContext('2d');
            const pieCtx = document.getElementById('tasksPieChart').getContext('2d');
            
            // Prepare data
            const completedTasks = appState.tasks.filter(task => task.completed).length;
            const pendingTasks = appState.tasks.filter(task => !task.completed).length;
            
            // Group tasks by category
            const categoryCounts = {};
            appState.tasks.forEach(task => {
                if (!categoryCounts[task.category]) {
                    categoryCounts[task.category] = { completed: 0, pending: 0 };
                }
                
                if (task.completed) {
                    categoryCounts[task.category].completed += 1;
                } else {
                    categoryCounts[task.category].pending += 1;
                }
            });
            
            const categories = Object.keys(categoryCounts);
            const completedByCategory = categories.map(cat => categoryCounts[cat].completed);
            const pendingByCategory = categories.map(cat => categoryCounts[cat].pending);
            
            // Define dark mode colors
            const gridColor = appState.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = appState.isDarkMode ? '#F8F9FA' : '#333333';
            
            // Destroy existing charts if they exist
            if (window.tasksChart) window.tasksChart.destroy();
            if (window.tasksPieChart) window.tasksPieChart.destroy();
            
            // Create bar chart
            window.tasksChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [
                        {
                            label: 'Completed',
                            data: completedByCategory,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending',
                            data: pendingByCategory,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
            
            // Create pie chart
            window.tasksPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [
                        {
                            data: [completedTasks, pendingTasks],
                            backgroundColor: ['rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)'],
                            borderColor: ['rgba(40, 167, 69, 1)', 'rgba(255, 193, 7, 1)'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
        }

        function renderNotifications() {
            elements.notificationsList.innerHTML = '';
            
            if (appState.notifications.length === 0) {
                elements.notificationsList.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-color); opacity: 0.7;">
                        No notifications
                    </div>
                `;
                return;
            }
            
            appState.notifications.forEach(notification => {
                const time = formatDate(notification.time);
                
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationElement.setAttribute('data-id', notification.id);
                
                notificationElement.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-text">${notification.text}</div>
                    <div class="notification-time">${time}</div>
                `;
                
                elements.notificationsList.appendChild(notificationElement);
                
                notificationElement.addEventListener('click', () => {
                    markNotificationAsRead(notification.id);
                });
            });
        }

        function renderCategories() {
            // Populate category dropdowns
            const categoryFilters = [
                elements.categoryFilter,
                elements.taskCategory,
                elements.editTaskCategory
            ];
            
            categoryFilters.forEach(dropdown => {
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = `<option value="all">All</option>`;
                
                appState.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    
                    if (dropdown !== elements.categoryFilter) {
                        option.value = category;
                        option.textContent = category;
                    }
                    
                    dropdown.appendChild(option);
                });
                
                if (currentValue) {
                    dropdown.value = currentValue;
                }
            });
            
            // Render categories list in the categories modal
            const categoriesList = document.getElementById('categoriesList');
            if (categoriesList) {
                categoriesList.innerHTML = '';
                
                appState.categories.forEach(category => {
                    if (category === 'Work' || category === 'Personal' || category === 'Shopping' || 
                        category === 'Health' || category === 'Education' || category === 'Finance' || 
                        category === 'Other') {
                        // Don't allow editing default categories
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${appState.categoriesColors[category] || '#5D5CDE'}; margin-right: 0.5rem;"></span>
                                ${category}
                            </td>
                            <td style="padding: 0.75rem; text-align: right;">
                                <span style="color: var(--text-color); opacity: 0.5; font-size: 0.875rem;">Default</span>
                            </td>
                        `;
                        categoriesList.appendChild(row);
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 0.75rem;">
                                <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${appState.categoriesColors[category] || '#5D5CDE'}; margin-right: 0.5rem;"></span>
                                ${category}
                            </td>
                            <td style="padding: 0.75rem; text-align: right;">
                                <button class="btn btn-sm btn-primary edit-category-btn" data-category="${category}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-category-btn" data-category="${category}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        categoriesList.appendChild(row);
                        
                        // Add event listeners for edit and delete
                        const editBtn = row.querySelector('.edit-category-btn');
                        editBtn.addEventListener('click', () => {
                            openEditCategoryModal(category);
                        });
                        
                        const deleteBtn = row.querySelector('.delete-category-btn');
                        deleteBtn.addEventListener('click', () => {
                            deleteCategory(category);
                        });
                    }
                });
            }
        }

        function renderUsers() {
            const usersGrid = document.getElementById('usersGrid');
            if (usersGrid) {
                usersGrid.innerHTML = '';
                
                appState.users.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    
                    userCard.innerHTML = `
                        <img src="${user.avatar}" alt="${user.firstName}" class="user-avatar">
                        <div class="user-name">${user.firstName} ${user.lastName}</div>
                        <div class="user-email">${user.email}</div>
                        <div class="user-role">${user.role}</div>
                        <div class="user-stats">
                            <div class="user-stat">
                                <div class="user-stat-value">${user.taskCount || 0}</div>
                                <div class="user-stat-label">Tasks</div>
                            </div>
                            <div class="user-stat">
                                <div class="user-stat-value">${user.completedCount || 0}</div>
                                <div class="user-stat-label">Completed</div>
                            </div>
                        </div>
                    `;
                    
                    usersGrid.appendChild(userCard);
                });
            }
            
            // Also populate user dropdown in share modal
            const shareUserDropdown = document.getElementById('shareUser');
            if (shareUserDropdown) {
                shareUserDropdown.innerHTML = '';
                
                appState.users.forEach(user => {
                    if (user.id === (appState.currentUser && appState.currentUser.id)) return;
                    
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.firstName} ${user.lastName} (${user.role})`;
                    shareUserDropdown.appendChild(option);
                });
            }
        }

        // MODALS
        function openRegisterModal() {
            resetRegisterForm();
            showModal(elements.registerModal);
            
            // Initialize Flatpickr for birthdate
            if (!window.regBirthdatePicker) {
                window.regBirthdatePicker = flatpickr('#regBirthdate', {
                    dateFormat: 'Y-m-d',
                    maxDate: 'today'
                });
            }
            
            // Fetch countries if not already loaded
            if (!document.getElementById('regNationality').options.length > 1) {
                fetchCountries();
            }
        }

        function resetRegisterForm() {
            document.getElementById('regFirstName').value = '';
            document.getElementById('regLastName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regConfirmEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
            document.getElementById('regBirthdate').value = '';
            document.getElementById('regNationality').value = '';
            document.getElementById('regRole').value = 'Manager';
        }

        function openViewTaskModal(task) {
            document.getElementById('viewTaskTitle').textContent = task.title;
            document.getElementById('viewTaskDescription').textContent = task.description;
            document.getElementById('viewTaskDueDate').textContent = formatDate(task.dueDate);
            
            // Set priority badge
            const priorityBadge = document.getElementById('viewTaskPriority');
            priorityBadge.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
            priorityBadge.className = 'task-badge';
            
            if (task.priority === 'high') {
                priorityBadge.classList.add('badge-high');
            } else if (task.priority === 'medium') {
                priorityBadge.classList.add('badge-medium');
            } else {
                priorityBadge.classList.add('badge-low');
            }
            
            // Set category badge
            document.getElementById('viewTaskCategory').textContent = task.category;
            
            // Render subtasks
            const subtasksList = document.getElementById('viewSubtasksList');
            if (task.subtasks && task.subtasks.length > 0) {
                document.getElementById('viewTaskSubtasksContainer').style.display = 'block';
                
                subtasksList.innerHTML = '';
                task.subtasks.forEach(subtask => {
                    const subtaskItem = document.createElement('div');
                    subtaskItem.className = 'subtask-item';
                    subtaskItem.innerHTML = `
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} disabled>
                        <span ${subtask.completed ? 'style="text-decoration: line-through;"' : ''}>${subtask.title}</span>
                    `;
                    subtasksList.appendChild(subtaskItem);
                });
            } else {
                document.getElementById('viewTaskSubtasksContainer').style.display = 'none';
            }
            
            // Set notes and time spent
            document.getElementById('viewTaskNotes').textContent = task.notes || 'No notes available';
            document.getElementById('viewTaskTimeSpent').textContent = formatTime(task.timeSpent || 0);
            
            // Set up edit button
            document.getElementById('editTaskBtn').onclick = () => {
                hideModal(elements.viewTaskModal);
                openEditTaskModal(task);
            };
            
            // Set up share button
            document.getElementById('shareTaskBtn').onclick = () => {
                hideModal(elements.viewTaskModal);
                openShareTaskModal(task);
            };
            
            showModal(elements.viewTaskModal);
        }

        function openEditTaskModal(task) {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description;
            document.getElementById('editTaskPriority').value = task.priority;
            document.getElementById('editTaskCategory').value = task.category;
            document.getElementById('editTaskNotes').value = task.notes || '';
            
            // Initialize Flatpickr for due date
            if (!window.editTaskDueDatePicker) {
                window.editTaskDueDatePicker = flatpickr('#editTaskDueDate', {
                    dateFormat: 'Y-m-d',
                    minDate: 'today'
                });
            }
            
            window.editTaskDueDatePicker.setDate(task.dueDate);
            
            // Render subtasks
            const subtasksContainer = document.getElementById('editSubtasksContainer');
            subtasksContainer.innerHTML = '';
            
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const subtaskDiv = document.createElement('div');
                    subtaskDiv.className = 'subtask-input';
                    subtaskDiv.style.display = 'flex';
                    subtaskDiv.style.gap = '0.5rem';
                    subtaskDiv.style.marginBottom = '0.5rem';
                    
                    subtaskDiv.innerHTML = `
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} class="subtask-completed">
                        <input type="text" class="form-control subtask-text" value="${subtask.title}">
                        <input type="hidden" class="subtask-id" value="${subtask.id}">
                        <button class="btn btn-sm btn-danger remove-subtask"><i class="fas fa-times"></i></button>
                    `;
                    
                    subtasksContainer.appendChild(subtaskDiv);
                    
                    // Add event listener for remove button
                    subtaskDiv.querySelector('.remove-subtask').addEventListener('click', function() {
                        subtaskDiv.remove();
                    });
                });
            }
            
            // Add event listener for add subtask button
            document.getElementById('editAddSubtaskBtn').onclick = function() {
                const subtaskDiv = document.createElement('div');
                subtaskDiv.className = 'subtask-input';
                subtaskDiv.style.display = 'flex';
                subtaskDiv.style.gap = '0.5rem';
                subtaskDiv.style.marginBottom = '0.5rem';
                
                subtaskDiv.innerHTML = `
                    <input type="checkbox" class="subtask-completed">
                    <input type="text" class="form-control subtask-text" placeholder="Enter sub-task">
                    <input type="hidden" class="subtask-id" value="new-${Date.now()}">
                    <button class="btn btn-sm btn-danger remove-subtask"><i class="fas fa-times"></i></button>
                `;
                
                subtasksContainer.appendChild(subtaskDiv);
                
                // Add event listener for remove button
                subtaskDiv.querySelector('.remove-subtask').addEventListener('click', function() {
                    subtaskDiv.remove();
                });
                
                // Focus on the new input
                subtaskDiv.querySelector('.subtask-text').focus();
            };
            
            showModal(elements.editTaskModal);
        }

        function openAddTaskModal() {
            // Reset form
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskCategory').value = 'Work';
            document.getElementById('taskNotes').value = '';
            
            // Clear subtasks
            const subtasksContainer = document.getElementById('subtasksContainer');
            subtasksContainer.innerHTML = `
                <div class="subtask-input" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="checkbox" class="subtask-completed">
                    <input type="text" class="form-control subtask-text" placeholder="Enter sub-task">
                    <button class="btn btn-sm btn-danger remove-subtask"><i class="fas fa-times"></i></button>
                </div>
            `;
            
            // Add event listener for remove button
            subtasksContainer.querySelector('.remove-subtask').addEventListener('click', function() {
                if (subtasksContainer.children.length > 1) {
                    this.closest('.subtask-input').remove();
                }
            });
            
            // Add event listener for add subtask button
            document.getElementById('addSubtaskBtn').onclick = function() {
                const subtaskDiv = document.createElement('div');
                subtaskDiv.className = 'subtask-input';
                subtaskDiv.style.display = 'flex';
                subtaskDiv.style.gap = '0.5rem';
                subtaskDiv.style.marginBottom = '0.5rem';
                
                subtaskDiv.innerHTML = `
                    <input type="checkbox" class="subtask-completed">
                    <input type="text" class="form-control subtask-text" placeholder="Enter sub-task">
                    <button class="btn btn-sm btn-danger remove-subtask"><i class="fas fa-times"></i></button>
                `;
                
                subtasksContainer.appendChild(subtaskDiv);
                
                // Add event listener for remove button
                subtaskDiv.querySelector('.remove-subtask').addEventListener('click', function() {
                    subtaskDiv.remove();
                });
                
                // Focus on the new input
                subtaskDiv.querySelector('.subtask-text').focus();
            };
            
            // Initialize Flatpickr for due date
            if (!window.taskDueDatePicker) {
                window.taskDueDatePicker = flatpickr('#taskDueDate', {
                    dateFormat: 'Y-m-d',
                    minDate: 'today'
                });
            }
            
            window.taskDueDatePicker.setDate(new Date());
            
            showModal(elements.addTaskModal);
        }

        function openShareTaskModal(task) {
            document.getElementById('shareTaskTitle').value = task.title;
            document.getElementById('shareTaskTitle').dataset.taskId = task.id;
            
            // Reset form
            document.getElementById('shareMethod').value = 'email';
            document.getElementById('shareEmail').value = '';
            document.getElementById('shareMessage').value = '';
            document.getElementById('shareLink').value = `https://example.com/task/${task.id}`;
            document.getElementById('shareUser').value = '';
            document.getElementById('sharePermission').value = 'view';
            
            // Show/hide appropriate sections
            document.getElementById('emailShareSection').style.display = 'block';
            document.getElementById('linkShareSection').style.display = 'none';
            document.getElementById('userShareSection').style.display = 'none';
            
            // Event listener for share method change
            document.getElementById('shareMethod').onchange = function() {
                const method = this.value;
                
                document.getElementById('emailShareSection').style.display = method === 'email' ? 'block' : 'none';
                document.getElementById('linkShareSection').style.display = method === 'link' ? 'block' : 'none';
                document.getElementById('userShareSection').style.display = method === 'user' ? 'block' : 'none';
            };
            
            // Event listener for copy link button
            document.getElementById('copyLinkBtn').onclick = function() {
                const linkInput = document.getElementById('shareLink');
                linkInput.select();
                document.execCommand('copy');
                
                this.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-copy"></i>';
                }, 1500);
                
                showToast('Link Copied', 'The task link has been copied to clipboard.', 'success');
            };
            
            showModal(elements.shareTaskModal);
        }

        function openExportModal() {
            // Reset form
            document.getElementById('exportFormat').value = 'json';
            document.getElementById('exportCompleted').checked = true;
            document.getElementById('exportIncludeNotes').checked = true;
            
            showModal(elements.exportModal);
        }

        function openImportModal() {
            // Reset form
            document.getElementById('importMethod').value = 'file';
            document.getElementById('importFile').value = '';
            document.getElementById('importUrl').value = '';
            document.getElementById('importReplace').checked = false;
            
            // Show/hide appropriate sections
            document.getElementById('fileImportSection').style.display = 'block';
            document.getElementById('urlImportSection').style.display = 'none';
            
            // Event listener for import method change
            document.getElementById('importMethod').onchange = function() {
                const method = this.value;
                
                document.getElementById('fileImportSection').style.display = method === 'file' ? 'block' : 'none';
                document.getElementById('urlImportSection').style.display = method === 'url' ? 'block' : 'none';
            };
            
            showModal(elements.importModal);
        }

        function openCategoriesModal() {
            document.getElementById('newCategoryInput').value = '';
            renderCategories();
            showModal(elements.categoriesModal);
        }

        function openEditCategoryModal(category) {
            document.getElementById('editCategoryInput').value = category;
            document.getElementById('editCategoryId').value = category;
            document.getElementById('categoryColor').value = appState.categoriesColors[category] || '#5D5CDE';
            
            showModal(elements.editCategoryModal);
        }

        function openUsersModal() {
            renderUsers();
            showModal(elements.usersModal);
        }

        function openStatusModal() {
            // Get current status
            const currentStatus = elements.statusIndicator.classList.contains('status-online') ? 'online' :
                                 elements.statusIndicator.classList.contains('status-offline') ? 'offline' :
                                 elements.statusIndicator.classList.contains('status-break') ? 'break' : 'away';
            
            document.getElementById('statusSelect').value = currentStatus;
            
            showModal(elements.statusModal);
        }

        function openDateRangeModal() {
            // Initialize Flatpickr for date range
            if (!window.startDatePicker) {
                window.startDatePicker = flatpickr('#startDate', {
                    dateFormat: 'Y-m-d'
                });
            }
            
            if (!window.endDatePicker) {
                window.endDatePicker = flatpickr('#endDate', {
                    dateFormat: 'Y-m-d'
                });
            }
            
            // Set default dates
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            window.startDatePicker.setDate(today);
            window.endDatePicker.setDate(nextWeek);
            
            showModal(elements.dateRangeModal);
        }

        // DATA MANAGEMENT
        function addCategory(categoryName, color = '#5D5CDE') {
            if (!categoryName || categoryName.trim() === '') return false;
            
            categoryName = categoryName.trim();
            
            if (appState.categories.includes(categoryName)) {
                showToast('Error', 'Category already exists.', 'error');
                return false;
            }
            
            appState.categories.push(categoryName);
            appState.categoriesColors[categoryName] = color;
            saveCategoriesToLocalStorage();
            renderCategories();
            
            showToast('Category Added', `Category "${categoryName}" has been added.`, 'success');
            
            return true;
        }

        function editCategory(oldName, newName, color) {
            if (!newName || newName.trim() === '') return false;
            
            newName = newName.trim();
            
            if (oldName === newName && appState.categoriesColors[oldName] === color) {
                return true; // No changes
            }
            
            if (oldName !== newName && appState.categories.includes(newName)) {
                showToast('Error', 'Category name already exists.', 'error');
                return false;
            }
            
            const index = appState.categories.indexOf(oldName);
            if (index !== -1) {
                // Update category name
                appState.categories[index] = newName;
                
                // Update category color
                appState.categoriesColors[newName] = color;
                if (oldName !== newName) {
                    delete appState.categoriesColors[oldName];
                }
                
                // Update tasks with this category
                appState.tasks.forEach(task => {
                    if (task.category === oldName) {
                        task.category = newName;
                    }
                });
                
                saveCategoriesToLocalStorage();
                saveTasksToLocalStorage();
                renderCategories();
                renderTasks();
                
                showToast('Category Updated', `Category "${oldName}" has been updated to "${newName}".`, 'success');
                
                return true;
            }
            
            return false;
        }

        function deleteCategory(categoryName) {
            // Check if any tasks use this category
            const tasksWithCategory = appState.tasks.filter(task => task.category === categoryName);
            
            if (tasksWithCategory.length > 0) {
                const confirmed = confirm(`There are ${tasksWithCategory.length} tasks with this category. Do you want to reassign them to "Other"?`);
                
                if (!confirmed) return false;
                
                // Reassign tasks to "Other" category
                tasksWithCategory.forEach(task => {
                    task.category = 'Other';
                });
                
                saveTasksToLocalStorage();
            }
            
            const index = appState.categories.indexOf(categoryName);
            if (index !== -1) {
                appState.categories.splice(index, 1);
                delete appState.categoriesColors[categoryName];
                
                saveCategoriesToLocalStorage();
                renderCategories();
                renderTasks();
                
                showToast('Category Deleted', `Category "${categoryName}" has been deleted.`, 'success');
                
                return true;
            }
            
            return false;
        }

        function exportTasks(format) {
            let tasksToExport = [...appState.tasks];
            
            // Filter completed tasks if needed
            if (!document.getElementById('exportCompleted').checked) {
                tasksToExport = tasksToExport.filter(task => !task.completed);
            }
            
            // Remove notes and subtasks if needed
            if (!document.getElementById('exportIncludeNotes').checked) {
                tasksToExport = tasksToExport.map(task => {
                    const { notes, subtasks, ...rest } = task;
                    return rest;
                });
            }
            
            let fileContent;
            let fileName;
            let mimeType;
            
            switch (format) {
                case 'json':
                    fileContent = JSON.stringify(tasksToExport, null, 2);
                    fileName = 'tasks.json';
                    mimeType = 'application/json';
                    break;
                    
                case 'csv':
                    // Basic CSV export
                    const headers = ['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Completed'];
                    
                    const rows = tasksToExport.map(task => [
                        `"${task.title.replace(/"/g, '""')}"`,
                        `"${task.description.replace(/"/g, '""')}"`,
                        formatDate(task.dueDate),
                        task.priority,
                        task.category,
                        task.completed ? 'Yes' : 'No'
                    ].join(','));
                    
                    fileContent = [headers.join(','), ...rows].join('\n');
                    fileName = 'tasks.csv';
                    mimeType = 'text/csv';
                    break;
                    
                case 'pdf':
                    // Use jsPDF to generate PDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(18);
                    doc.text('Tasks List', 14, 20);
                    
                    doc.setFontSize(12);
                    doc.setTextColor(100);
                    doc.text(`Exported on ${formatDate(new Date())}`, 14, 30);
                    
                    doc.setTextColor(0);
                    let yOffset = 40;
                    
                    tasksToExport.forEach((task, index) => {
                        if (yOffset > 270) {
                            doc.addPage();
                            yOffset = 20;
                        }
                        
                        doc.setFontSize(14);
                        doc.text(`${index + 1}. ${task.title}`, 14, yOffset);
                        yOffset += 7;
                        
                        doc.setFontSize(10);
                        doc.text(`Description: ${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}`, 20, yOffset);
                        yOffset += 6;
                        
                        doc.text(`Due: ${formatDate(task.dueDate)} | Priority: ${task.priority} | Category: ${task.category} | Status: ${task.completed ? 'Completed' : 'Pending'}`, 20, yOffset);
                        yOffset += 10;
                    });
                    
                    fileContent = doc.output('blob');
                    fileName = 'tasks.pdf';
                    mimeType = 'application/pdf';
                    break;
                    
                case 'excel':
                    // Use xlsx library to generate Excel file
                    const worksheet = XLSX.utils.json_to_sheet(tasksToExport.map(task => ({
                        Title: task.title,
                        Description: task.description,
                        'Due Date': formatDate(task.dueDate),
                        Priority: task.priority,
                        Category: task.category,
                        Status: task.completed ? 'Completed' : 'Pending',
                        'Time Spent': formatTime(task.timeSpent || 0),
                        Notes: task.notes || '',
                        'Created Date': formatDate(task.createdAt)
                    })));
                    
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Tasks');
                    
                    fileContent = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    fileName = 'tasks.xlsx';
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                    break;
            }
            
            // Create a download link
            const blob = new Blob([fileContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showToast('Export Complete', `Tasks exported as ${format.toUpperCase()}.`, 'success');
        }

        function importTasks(tasks, replace = false) {
            if (!tasks || !Array.isArray(tasks)) {
                showToast('Import Error', 'Invalid tasks data format.', 'error');
                return false;
            }
            
            try {
                // Process imported tasks
                const processedTasks = tasks.map(task => ({
                    id: task.id || generateId(),
                    title: task.title || 'Untitled Task',
                    description: task.description || '',
                    dueDate: task.dueDate ? new Date(task.dueDate) : new Date(),
                    priority: ['high', 'medium', 'low'].includes(task.priority) ? task.priority : 'medium',
                    category: task.category && appState.categories.includes(task.category) ? task.category : 'Other',
                    completed: Boolean(task.completed),
                    subtasks: Array.isArray(task.subtasks) ? task.subtasks.map(st => ({
                        id: st.id || generateId(),
                        title: st.title || '',
                        completed: Boolean(st.completed)
                    })) : [],
                    notes: task.notes || '',
                    timeSpent: task.timeSpent || 0,
                    createdAt: task.createdAt ? new Date(task.createdAt) : new Date()
                }));
                
                if (replace) {
                    appState.tasks = processedTasks;
                } else {
                    // Merge tasks, avoiding duplicates by ID
                    const existingIds = appState.tasks.map(task => task.id);
                    const newTasks = processedTasks.filter(task => !existingIds.includes(task.id));
                    appState.tasks = [...appState.tasks, ...newTasks];
                }
                
                saveTasksToLocalStorage();
                renderTasks();
                updateTaskCounts();
                updateInsights();
                updateCharts();
                
                showToast('Import Complete', `${processedTasks.length} tasks imported successfully.`, 'success');
                return true;
            } catch (error) {
                console.error('Error importing tasks:', error);
                showToast('Import Error', 'There was a problem processing the imported tasks.', 'error');
                return false;
            }
        }

        // UTILITIES
        function fetchCountries() {
            const countriesSelect = document.getElementById('regNationality');
            const editCountriesSelect = document.getElementById('editProfileCountry');
            
            // Sample countries (since we can't fetch from restcountries.com due to CSP)
            const countries = [
                { name: 'United States', code: 'US' },
                { name: 'United Kingdom', code: 'GB' },
                { name: 'Canada', code: 'CA' },
                { name: 'Australia', code: 'AU' },
                { name: 'Germany', code: 'DE' },
                { name: 'France', code: 'FR' },
                { name: 'Japan', code: 'JP' },
                { name: 'China', code: 'CN' },
                { name: 'India', code: 'IN' },
                { name: 'Brazil', code: 'BR' },
                { name: 'Mexico', code: 'MX' },
                { name: 'South Africa', code: 'ZA' },
                { name: 'Egypt', code: 'EG' },
                { name: 'Russia', code: 'RU' },
                { name: 'Italy', code: 'IT' },
                { name: 'Spain', code: 'ES' },
                { name: 'Netherlands', code: 'NL' },
                { name: 'Sweden', code: 'SE' },
                { name: 'Norway', code: 'NO' },
                { name: 'Finland', code: 'FI' }
            ];
            
            // Sort countries by name
            countries.sort((a, b) => a.name.localeCompare(b.name));
            
            // Populate registration select
            if (countriesSelect) {
                countriesSelect.innerHTML = '<option value="">Select Country</option>';
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = country.name;
                    countriesSelect.appendChild(option);
                });
            }
            
            // Populate edit profile select
            if (editCountriesSelect) {
                editCountriesSelect.innerHTML = '<option value="">Select Country</option>';
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = country.name;
                    editCountriesSelect.appendChild(option);
                });
            }
        }

        // EVENT LISTENERS
        function setupEventListeners() {
            // Login
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.registerLink.addEventListener('click', openRegisterModal);
            
            // Register
            document.getElementById('createAccountBtn').addEventListener('click', handleRegister);
            document.getElementById('cancelRegisterBtn').addEventListener('click', () => hideModal(elements.registerModal));
            elements.registerModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.registerModal));
            
            // Header
            elements.dashboardLink.addEventListener('click', () => {
                elements.listViewBtn.click(); // Switch to list view
            });
            
            elements.profileBadge.addEventListener('click', () => {
                elements.profileDropdown.classList.toggle('active');
            });
            
            elements.notificationsIcon.addEventListener('click', () => {
                elements.notificationsDropdown.classList.toggle('active');
            });
            
            elements.markAllRead.addEventListener('click', markAllNotificationsAsRead);
            
            // Profile Dropdown
            elements.logoutBtn.addEventListener('click', handleLogout);
            elements.viewProfileBtn.addEventListener('click', () => {
                elements.profileDropdown.classList.remove('active');
                openProfileModal();
            });
            elements.switchModeBtn.addEventListener('click', () => {
                elements.profileDropdown.classList.remove('active');
                toggleDarkMode();
            });
            elements.changeStatusBtn.addEventListener('click', () => {
                elements.profileDropdown.classList.remove('active');
                openStatusModal();
            });
            
            // Profile Modal
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                hideModal(elements.profileModal);
                openEditProfileModal();
            });
            document.getElementById('closeProfileBtn').addEventListener('click', () => hideModal(elements.profileModal));
            elements.profileModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.profileModal));
            
            // Upload profile picture
            document.getElementById('profileImgUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('profileModalImg');
                        img.src = event.target.result;
                        
                        // Also update header profile image
                        elements.profileImg.src = event.target.result;
                        
                        // Save to user profile
                        if (appState.currentUser) {
                            appState.currentUser.avatar = event.target.result;
                            saveCurrentUserToLocalStorage();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Edit Profile Modal
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
            document.getElementById('cancelEditProfileBtn').addEventListener('click', () => hideModal(elements.editProfileModal));
            elements.editProfileModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.editProfileModal));
            
            // Upload profile picture in edit mode
            document.getElementById('editProfileImgUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('editProfileImg');
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Status Modal
            document.getElementById('saveStatusBtn').addEventListener('click', saveStatusChanges);
            document.getElementById('cancelStatusBtn').addEventListener('click', () => hideModal(elements.statusModal));
            elements.statusModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.statusModal));
            
            // Tasks
            elements.addTaskBtn.addEventListener('click', openAddTaskModal);
            elements.exportBtn.addEventListener('click', openExportModal);
            elements.importBtn.addEventListener('click', openImportModal);
            elements.categoriesBtn.addEventListener('click', openCategoriesModal);
            elements.usersBtn.addEventListener('click', openUsersModal);
            
            // Create Task
            document.getElementById('createTaskBtn').addEventListener('click', createTask);
            document.getElementById('cancelTaskBtn').addEventListener('click', () => hideModal(elements.addTaskModal));
            elements.addTaskModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.addTaskModal));
            
            // View Task Modal
            document.getElementById('closeViewTaskBtn').addEventListener('click', () => hideModal(elements.viewTaskModal));
            elements.viewTaskModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.viewTaskModal));
            
            // Edit Task Modal
            document.getElementById('saveTaskBtn').addEventListener('click', saveTaskChanges);
            document.getElementById('cancelEditTaskBtn').addEventListener('click', () => hideModal(elements.editTaskModal));
            elements.editTaskModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.editTaskModal));
            
            // Share Task Modal
            document.getElementById('sendShareBtn').addEventListener('click', handleShareTask);
            document.getElementById('cancelShareBtn').addEventListener('click', () => hideModal(elements.shareTaskModal));
            elements.shareTaskModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.shareTaskModal));
            
            // Export Modal
            document.getElementById('downloadExportBtn').addEventListener('click', () => {
                const format = document.getElementById('exportFormat').value;
                exportTasks(format);
                hideModal(elements.exportModal);
            });
            document.getElementById('cancelExportBtn').addEventListener('click', () => hideModal(elements.exportModal));
            elements.exportModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.exportModal));
            
            // Import Modal
            document.getElementById('confirmImportBtn').addEventListener('click', handleImportTasks);
            document.getElementById('cancelImportBtn').addEventListener('click', () => hideModal(elements.importModal));
            elements.importModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.importModal));
            
            // Categories Modal
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                const categoryName = document.getElementById('newCategoryInput').value.trim();
                addCategory(categoryName);
                document.getElementById('newCategoryInput').value = '';
            });
            document.getElementById('closeCategoriesBtn').addEventListener('click', () => hideModal(elements.categoriesModal));
            elements.categoriesModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.categoriesModal));
            
            // Edit Category Modal
            document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
            document.getElementById('cancelEditCategoryBtn').addEventListener('click', () => hideModal(elements.editCategoryModal));
            elements.editCategoryModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.editCategoryModal));
            
            // Users Modal
            document.getElementById('closeUsersBtn').addEventListener('click', () => hideModal(elements.usersModal));
            elements.usersModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.usersModal));
            
            // Date Range Modal
            document.getElementById('applyDateRangeBtn').addEventListener('click', applyDateRange);
            document.getElementById('cancelDateRangeBtn').addEventListener('click', () => hideModal(elements.dateRangeModal));
            elements.dateRangeModal.querySelector('.modal-close').addEventListener('click', () => hideModal(elements.dateRangeModal));
            
            // Timer
            elements.playPauseBtn.addEventListener('click', () => {
                if (appState.globalTimer.active) {
                    pauseGlobalTimer();
                } else {
                    startGlobalTimer();
                }
            });
            
            elements.pauseBtn.addEventListener('click', pauseGlobalTimer);
            
            // View Switcher
            elements.listViewBtn.addEventListener('click', () => {
                elements.listViewBtn.classList.add('active');
                elements.graphViewBtn.classList.remove('active');
                elements.listView.style.display = 'block';
                elements.graphView.style.display = 'none';
            });
            
            elements.graphViewBtn.addEventListener('click', () => {
                elements.listViewBtn.classList.remove('active');
                elements.graphViewBtn.classList.add('active');
                elements.listView.style.display = 'none';
                elements.graphView.style.display = 'flex';
                updateCharts();
            });
            
            // Filters
            elements.searchInput.addEventListener('input', debounce(() => {
                renderTasks();
            }, 300));
            
            elements.statusFilter.addEventListener('change', renderTasks);
            elements.categoryFilter.addEventListener('change', renderTasks);
            elements.priorityFilter.addEventListener('change', renderTasks);
            elements.sortFilter.addEventListener('change', renderTasks);
            
            elements.dueDateFilter.addEventListener('change', function() {
                if (this.value === 'custom') {
                    openDateRangeModal();
                } else {
                    renderTasks();
                }
            });
            
            // Mode Switcher
            elements.modeSwitcher.addEventListener('click', toggleDarkMode);
            
            // Actions Bar
            elements.completeSelectedBtn.addEventListener('click', batchCompleteSelected);
            elements.deleteSelectedBtn.addEventListener('click', batchDeleteSelected);
            elements.cancelSelectionBtn.addEventListener('click', () => {
                appState.selectedTasks = [];
                elements.actionsBar.classList.remove('active');
                renderTasks();
            });
            
            // History Controls
            elements.undoBtn.addEventListener('click', undo);
            elements.redoBtn.addEventListener('click', redo);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.profileBadge.contains(e.target)) {
                    elements.profileDropdown.classList.remove('active');
                }
                
                if (!elements.notificationsIcon.contains(e.target) && !elements.notificationsDropdown.contains(e.target)) {
                    elements.notificationsDropdown.classList.remove('active');
                }
            });
            
            // Detect preferred color scheme
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                appState.isDarkMode = true;
                elements.switchModeBtn.innerHTML = `<i class="fas fa-sun"></i><span>Switch to Light Mode</span>`;
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    appState.isDarkMode = true;
                    elements.switchModeBtn.innerHTML = `<i class="fas fa-sun"></i><span>Switch to Light Mode</span>`;
                } else {
                    document.documentElement.classList.remove('dark');
                    appState.isDarkMode = false;
                    elements.switchModeBtn.innerHTML = `<i class="fas fa-moon"></i><span>Switch to Dark Mode</span>`;
                }
                
                updateCharts();
            });
        }

        // HANDLERS
        function handleLogin() {
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            
            if (!email || !password) {
                showToast('Error', 'Please enter both email and password.', 'error');
                return;
            }
            
            // For demo, we're using test@example.com/123456
            if (email === 'test@example.com' && password === '123456') {
                // Find or create user
                let user = appState.users.find(u => u.email === email);
                
                if (!user) {
                    user = {
                        id: generateId(),
                        firstName: 'Test',
                        lastName: 'User',
                        email: email,
                        role: 'Admin',
                        avatar: 'https://randomuser.me/api/portraits/men/32.jpg',
                        joiningDate: new Date()
                    };
                    appState.users.push(user);
                    saveUsersToLocalStorage();
                }
                
                appState.currentUser = user;
                saveCurrentUserToLocalStorage();
                
                // Show dashboard
                elements.loginPage.style.display = 'none';
                elements.dashboardPage.style.display = 'block';
                
                // Set status to online
                elements.statusIndicator.className = 'status-indicator status-online';
                elements.statusText.textContent = 'Online';
                
                // Init
                renderTasks();
                updateTaskCounts();
                updateInsights();
                renderNotifications();
                updateNotificationBadges();
                
                showToast('Welcome', `Welcome back, ${user.firstName}!`, 'success');
                
                // Add notification for login
                addNotification('Login Successful', `You logged in at ${new Date().toLocaleTimeString()}.`);
            } else {
                showToast('Error', 'Invalid email or password.', 'error');
            }
        }

        function handleLogout() {
            // Show login page
            elements.loginPage.style.display = 'flex';
            elements.dashboardPage.style.display = 'none';
            
            // Reset UI
            elements.profileDropdown.classList.remove('active');
            
            // Pause any active timers
            pauseGlobalTimer();
            saveTimerToLocalStorage();
            
            // Add notification for logout
            addNotification('Logout', `You logged out at ${new Date().toLocaleTimeString()}.`);
            
            showToast('Goodbye', 'You have been logged out.', 'info');
        }

        function handleRegister() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const confirmEmail = document.getElementById('regConfirmEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const birthdate = document.getElementById('regBirthdate').value;
            const nationality = document.getElementById('regNationality').value;
            const role = document.getElementById('regRole').value;
            
            // Validation
            if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                showToast('Error', 'Please fill in all fields.', 'error');
                return;
            }
            
            if (email !== confirmEmail) {
                showToast('Error', 'Email addresses do not match.', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Error', 'Passwords do not match.', 'error');
                return;
            }
            
            // Check if email already exists
            if (appState.users.some(u => u.email === email)) {
                showToast('Error', 'Email address already registered.', 'error');
                return;
            }
            
            // Create user
            const newUser = {
                id: generateId(),
                firstName,
                lastName,
                email,
                password, // In a real app, this would be hashed
                birthdate,
                nationality,
                role,
                avatar: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 100)}.jpg`,
                joiningDate: new Date()
            };
            
            appState.users.push(newUser);
            saveUsersToLocalStorage();
            
            // Hide modal
            hideModal(elements.registerModal);
            
            showToast('Success', 'Account created successfully. You can now log in.', 'success');
        }

        function saveProfileChanges() {
            const firstName = document.getElementById('editProfileFirstName').value.trim();
            const lastName = document.getElementById('editProfileLastName').value.trim();
            const email = document.getElementById('editProfileEmail').value.trim();
            const phone = document.getElementById('editProfilePhone').value.trim();
            const country = document.getElementById('editProfileCountry').value;
            
            // Validation
            if (!firstName || !lastName || !email) {
                showToast('Error', 'Please fill in all required fields.', 'error');
                return;
            }
            
            // Update user
            if (appState.currentUser) {
                appState.currentUser.firstName = firstName;
                appState.currentUser.lastName = lastName;
                appState.currentUser.email = email;
                appState.currentUser.phone = phone;
                appState.currentUser.country = country;
                
                // Update avatar if changed
                appState.currentUser.avatar = document.getElementById('editProfileImg').src;
                
                // Update in users array
                const userIndex = appState.users.findIndex(u => u.id === appState.currentUser.id);
                if (userIndex !== -1) {
                    appState.users[userIndex] = { ...appState.currentUser };
                }
                
                saveUsersToLocalStorage();
                saveCurrentUserToLocalStorage();
                
                // Update UI
                elements.profileImg.src = appState.currentUser.avatar;
                
                // Hide modal
                hideModal(elements.editProfileModal);
                
                showToast('Success', 'Profile updated successfully.', 'success');
            }
        }

        function openProfileModal() {
            if (appState.currentUser) {
                document.getElementById('profileFirstName').value = appState.currentUser.firstName || '';
                document.getElementById('profileLastName').value = appState.currentUser.lastName || '';
                document.getElementById('profileEmail').value = appState.currentUser.email || '';
                document.getElementById('profileRole').value = appState.currentUser.role || '';
                document.getElementById('profileJoiningDate').value = formatDate(appState.currentUser.joiningDate) || formatDate(new Date());
                document.getElementById('profileModalImg').src = appState.currentUser.avatar || elements.profileImg.src;
            }
            
            showModal(elements.profileModal);
        }

        function openEditProfileModal() {
            if (appState.currentUser) {
                document.getElementById('editProfileFirstName').value = appState.currentUser.firstName || '';
                document.getElementById('editProfileLastName').value = appState.currentUser.lastName || '';
                document.getElementById('editProfileEmail').value = appState.currentUser.email || '';
                document.getElementById('editProfilePhone').value = appState.currentUser.phone || '';
                document.getElementById('editProfileCountry').value = appState.currentUser.country || '';
                document.getElementById('editProfileImg').src = appState.currentUser.avatar || elements.profileImg.src;
            }
            
            // Fetch countries if needed
            if (!document.getElementById('editProfileCountry').options.length > 1) {
                fetchCountries();
            }
            
            showModal(elements.editProfileModal);
        }

        function saveStatusChanges() {
            const status = document.getElementById('statusSelect').value;
            
            // Update UI
            elements.statusIndicator.className = `status-indicator status-${status}`;
            
            let statusText;
            switch (status) {
                case 'online':
                    statusText = 'Online';
                    elements.profileImg.style.borderColor = 'var(--success-color)';
                    break;
                case 'offline':
                    statusText = 'Offline';
                    elements.profileImg.style.borderColor = 'var(--danger-color)';
                    break;
                case 'break':
                    statusText = 'On Break';
                    elements.profileImg.style.borderColor = 'var(--warning-color)';
                    break;
                case 'away':
                    statusText = 'Away';
                    elements.profileImg.style.borderColor = '#6c757d';
                    break;
            }
            
            elements.statusText.textContent = statusText;
            
            // Hide modal
            hideModal(elements.statusModal);
        }

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;
            const category = document.getElementById('taskCategory').value;
            const notes = document.getElementById('taskNotes').value.trim();
            
            // Validation
            if (!title) {
                showToast('Error', 'Please enter a task title.', 'error');
                return;
            }
            
            // Get subtasks
            const subtasks = [];
            const subtaskInputs = document.querySelectorAll('#subtasksContainer .subtask-input');
            
            subtaskInputs.forEach(input => {
                const subtaskTitle = input.querySelector('.subtask-text').value.trim();
                const subtaskCompleted = input.querySelector('.subtask-completed').checked;
                
                if (subtaskTitle) {
                    subtasks.push({
                        id: generateId(),
                        title: subtaskTitle,
                        completed: subtaskCompleted
                    });
                }
            });
            
            // Create task
            const task = {
                id: generateId(),
                title,
                description,
                dueDate: new Date(dueDate),
                priority,
                category,
                completed: false,
                subtasks,
                notes,
                timeSpent: 0,
                createdAt: new Date()
            };
            
            addTask(task);
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
            
            // Hide modal
            hideModal(elements.addTaskModal);
        }

        function saveTaskChanges() {
            const taskId = parseInt(document.getElementById('editTaskId').value);
            const title = document.getElementById('editTaskTitle').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();
            const dueDate = document.getElementById('editTaskDueDate').value;
            const priority = document.getElementById('editTaskPriority').value;
            const category = document.getElementById('editTaskCategory').value;
            const notes = document.getElementById('editTaskNotes').value.trim();
            
            // Validation
            if (!title) {
                showToast('Error', 'Please enter a task title.', 'error');
                return;
            }
            
            // Get subtasks
            const subtasks = [];
            const subtaskInputs = document.querySelectorAll('#editSubtasksContainer .subtask-input');
            
            subtaskInputs.forEach(input => {
                const subtaskTitle = input.querySelector('.subtask-text').value.trim();
                const subtaskCompleted = input.querySelector('.subtask-completed').checked;
                const subtaskId = input.querySelector('.subtask-id').value;
                
                if (subtaskTitle) {
                    subtasks.push({
                        id: subtaskId.startsWith('new-') ? generateId() : parseInt(subtaskId),
                        title: subtaskTitle,
                        completed: subtaskCompleted
                    });
                }
            });
            
            // Update task
            const updatedTask = {
                title,
                description,
                dueDate: new Date(dueDate),
                priority,
                category,
                subtasks,
                notes
            };
            
            editTask(taskId, updatedTask);
            renderTasks();
            updateTaskCounts();
            updateInsights();
            updateCharts();
            
            // Hide modal
            hideModal(elements.editTaskModal);
        }

        function handleShareTask() {
            const taskId = parseInt(document.getElementById('shareTaskTitle').dataset.taskId);
            const method = document.getElementById('shareMethod').value;
            
            // Simulate sharing
            let message;
            
            switch (method) {
                case 'email':
                    const email = document.getElementById('shareEmail').value.trim();
                    if (!email) {
                        showToast('Error', 'Please enter an email address.', 'error');
                        return;
                    }
                    message = `Task shared via email to ${email}`;
                    break;
                    
                case 'link':
                    message = 'Link copied to clipboard';
                    break;
                    
                case 'user':
                    const userId = document.getElementById('shareUser').value;
                    const permission = document.getElementById('sharePermission').value;
                    
                    if (!userId) {
                        showToast('Error', 'Please select a user.', 'error');
                        return;
                    }
                    
                    const user = appState.users.find(u => u.id === parseInt(userId));
                    if (user) {
                        message = `Task shared with ${user.firstName} ${user.lastName} (${permission} access)`;
                    } else {
                        message = 'Task shared with selected user';
                    }
                    break;
            }
            
            // Hide modal
            hideModal(elements.shareTaskModal);
            
            showToast('Task Shared', message, 'success');
            
            // Add notification
            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                addNotification('Task Shared', `You shared task "${task.title}" using ${method}.`);
            }
        }

        function handleImportTasks() {
            const method = document.getElementById('importMethod').value;
            const replace = document.getElementById('importReplace').checked;
            
            if (method === 'file') {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('Error', 'Please select a file to import.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const tasks = JSON.parse(e.target.result);
                        importTasks(tasks, replace);
                        hideModal(elements.importModal);
                    } catch (error) {
                        showToast('Error', 'Invalid JSON file format.', 'error');
                    }
                };
                reader.readAsText(file);
            } else if (method === 'url') {
                const url = document.getElementById('importUrl').value.trim();
                
                if (!url) {
                    showToast('Error', 'Please enter a URL.', 'error');
                    return;
                }
                
                // In a real app, we'd fetch from URL
                // For this demo, we'll just show a toast
                showToast('Import Error', 'URL import is not available in this demo.', 'error');
            }
        }

        function saveCategory() {
            const oldName = document.getElementById('editCategoryId').value;
            const newName = document.getElementById('editCategoryInput').value.trim();
            const color = document.getElementById('categoryColor').value;
            
            if (editCategory(oldName, newName, color)) {
                hideModal(elements.editCategoryModal);
            }
        }

        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showToast('Error', 'Please select both start and end dates.', 'error');
                return;
            }
            
            window.customDateRange = {
                start: new Date(startDate),
                end: new Date(endDate)
            };
            
            hideModal(elements.dateRangeModal);
            renderTasks();
        }
        
        // HELPERS
        function debounce(func, delay) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // INITIALIZATION
        function init() {
            // Initialize data from local storage
            loadFromLocalStorage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize chart
            window.Chart.defaults.font.family = "'Poppins', sans-serif";
            
            // Save timer state periodically
            setInterval(saveTimerToLocalStorage, 10000); // Every 10 seconds
        }

        // Start the app
        init();
    </script>
</body>
</html>
