<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced To-Do App</title>
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --primary: #5D5CDE;
            --primary-light: #7e7dee;
            --primary-dark: #4140b0;
            --secondary: #6c757d;
            --success: #28A745;
            --danger: #DC3545;
            --warning: #FFC107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --dark-blue: #00008B;
            --white: #FFFFFF;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --body-bg: #FFFFFF;
            --body-color: #212529;
            --card-bg: #FFFFFF;
            --card-border: rgba(0, 0, 0, 0.125);
            --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
            --shadow: 0 .5rem 1rem rgba(0, 0, 0, .15);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .175);
            --border-radius: 0.5rem;
            --btn-border-radius: 50px;
            --transition: all 0.3s ease;
            --font-family: 'Poppins', sans-serif;
            --task-completed-opacity: 0.7;
        }

        .dark {
            --primary: #6363ec;
            --primary-light: #8282f1;
            --primary-dark: #4444be;
            --body-bg: #181818;
            --body-color: #e9ecef;
            --card-bg: #242526;
            --card-border: rgba(255, 255, 255, 0.125);
            --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .2);
            --shadow: 0 .5rem 1rem rgba(0, 0, 0, .3);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .4);
            --gray-100: #212529;
            --gray-200: #343a40;
            --gray-300: #495057;
            --gray-400: #6c757d;
            --gray-500: #adb5bd;
            --gray-600: #ced4da;
            --gray-700: #dee2e6;
            --gray-800: #e9ecef;
            --gray-900: #f8f9fa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            background-color: var(--body-bg);
            color: var(--body-color);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            transition: var(--transition);
        }

        /* Login/Register Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
            transition: var(--transition);
        }

        .auth-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 400px;
            max-width: 90%;
            padding: 40px;
            text-align: center;
            transition: var(--transition);
            animation: fadeIn 0.5s ease;
        }

        .auth-header {
            margin-bottom: 30px;
        }

        .auth-header h2 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .auth-form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--body-color);
        }

        .auth-form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--body-color);
            transition: var(--transition);
            outline: none;
        }

        .auth-form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.2);
        }

        .auth-btn {
            position: relative;
            display: block;
            width: 80%;
            margin: 0 auto;
            padding: 12px 20px;
            border: none;
            border-radius: var(--btn-border-radius);
            background: linear-gradient(to right, var(--primary-light), var(--primary), var(--primary-dark));
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow);
        }

        .auth-btn:hover {
            transform: translateY(-3px);
        }

        .auth-btn:active {
            transform: scale(0.98);
        }

        /* Animated border light effect */
        .auth-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 20%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 80%
            );
            transform: rotate(30deg);
            animation: movingLight 3s infinite linear;
        }

        @keyframes movingLight {
            0% {
                transform: translateX(-100%) rotate(30deg);
            }
            100% {
                transform: translateX(100%) rotate(30deg);
            }
        }

        .auth-link {
            display: inline-block;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--body-color);
        }

        .auth-link a {
            color: var(--dark-blue);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        /* Dashboard Styles */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-300);
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
        }

        .app-title:hover {
            transform: scale(1.05);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .task-timer {
            display: flex;
            align-items: center;
            padding: 5px 15px;
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            border: 1px solid var(--gray-300);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            margin-right: 15px;
        }

        .timer-display {
            font-size: 1.1rem;
            font-weight: 600;
            margin-right: 10px;
            color: var(--primary);
        }

        .timer-btns {
            display: flex;
            gap: 5px;
        }

        .timer-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--gray-200);
            color: var(--body-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .timer-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .theme-switch {
            position: relative;
            width: 50px;
            height: 25px;
            border-radius: 25px;
            background-color: var(--gray-300);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-switch::after {
            content: '‚òÄÔ∏è';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 23px;
            height: 23px;
            border-radius: 50%;
            background-color: white;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
        }

        .dark .theme-switch {
            background-color: var(--primary);
        }

        .dark .theme-switch::after {
            content: 'üåô';
            transform: translateX(25px);
            background-color: var(--gray-100);
        }

        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .user-status {
            margin-right: 15px;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            font-weight: 600;
            background-color: var(--success);
            color: white;
            transition: var(--transition);
        }

        .profile-img-container {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--success);
            cursor: pointer;
            transition: var(--transition);
        }

        .profile-img-container:hover {
            transform: scale(1.1);
        }

        .profile-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--danger);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-badge:hover {
            transform: scale(1.2);
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 250px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            padding: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
            transition: var(--transition);
        }

        .profile-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 10px;
            color: var(--body-color);
            display: flex;
            align-items: center;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .dropdown-item i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .dropdown-item:hover {
            background-color: var(--gray-100);
        }

        /* Notifications Dropdown */
        .notifications-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            padding: 15px;
            display: none;
            animation: fadeIn 0.3s ease;
            transition: var(--transition);
        }

        .notifications-dropdown.active {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-300);
            margin-bottom: 10px;
        }

        .notification-header h3 {
            font-size: 1.1rem;
            color: var(--body-color);
        }

        .notification-header button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .notification-header button:hover {
            text-decoration: underline;
        }

        .notification-item {
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item.read {
            opacity: 0.6;
        }

        .notification-item:hover {
            background-color: var(--gray-200);
        }

        .notification-content {
            flex: 1;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray-600);
        }

        .notification-text {
            font-size: 0.9rem;
            color: var(--body-color);
        }

        .notification-read {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--primary);
            margin-left: 10px;
        }

        .notification-item.read .notification-read {
            background-color: var(--gray-400);
        }

        /* Main Content */
        .main-content {
            padding: 20px 0;
        }

        /* Dashboard */
        .main-dashboard {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .main-dashboard.active {
            display: block;
        }

        /* Task Summary Section */
        .task-summary {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .total-tasks-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 2px solid var(--gray-900);
            transition: var(--transition);
        }

        .status-cards {
            display: flex;
            gap: 20px;
        }

        .status-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: var(--transition);
        }

        .card-completed {
            border-left: 5px solid var(--success);
        }

        .card-pending {
            border-left: 5px solid var(--warning);
        }

        .card-title {
            font-size: 1.1rem;
            color: var(--body-color);
            margin-bottom: 15px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Tasks Section */
        .tasks-section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--body-color);
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--btn-border-radius);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon i {
            font-size: 1.2rem;
        }

        /* Task Filters */
        .task-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-300);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-size: 0.9rem;
            color: var(--body-color);
            font-weight: 500;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--body-color);
            font-size: 0.9rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .filter-select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .search-container {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 35px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            background-color: var(--card-bg);
            color: var(--body-color);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        .view-switcher {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .view-btn {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            background-color: var(--card-bg);
            color: var(--body-color);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .view-btn:first-child {
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
            border-right: none;
        }

        .view-btn:last-child {
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }

        .view-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Task List */
        .task-list-container {
            display: block;
        }

        .task-list-container.hidden {
            display: none;
        }

        .task-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .task-item {
            position: relative;
            background-color: var(--card-bg);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: grab;
            transition: var(--transition);
        }

        .task-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .task-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .task-item.task-completed {
            opacity: var(--task-completed-opacity);
            background-color: rgba(40, 167, 69, 0.1);
        }

        .task-item.task-expired {
            border-left: 5px solid var(--danger);
        }

        .task-item.task-warning {
            border-left: 5px solid var(--warning);
        }

        .task-item.task-good {
            border-left: 5px solid var(--success);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            background-color: var(--card-bg);
            border: 2px solid var(--gray-400);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .task-item.task-completed .task-checkbox {
            background-color: var(--success);
            border-color: var(--success);
        }

        .task-item.task-completed .task-checkbox::after {
            content: "‚úì";
            color: white;
            font-size: 1rem;
            font-weight: bold;
        }

        .task-checkbox:hover {
            border-color: var(--primary);
        }

        .task-select {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .task-name {
            font-weight: 600;
            color: var(--body-color);
            font-size: 1.1rem;
            margin: 0;
        }

        .task-item.task-completed .task-name {
            text-decoration: line-through;
        }

        .task-badges {
            display: flex;
            gap: 8px;
        }

        .task-badge {
            padding: 3px 8px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-priority-high {
            background-color: var(--danger);
            color: white;
        }

        .badge-priority-medium {
            background-color: var(--warning);
            color: var(--dark);
        }

        .badge-priority-low {
            background-color: var(--secondary);
            color: white;
        }

        .badge-category {
            background-color: var(--primary);
            color: white;
        }

        .badge-date {
            background-color: var(--info);
            color: white;
        }

        .task-description {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .task-actions-container {
            display: flex;
            gap: 5px;
        }

        .task-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: var(--gray-200);
            color: var(--gray-700);
            cursor: pointer;
            transition: var(--transition);
        }

        .task-btn:hover {
            transform: scale(1.1);
        }

        .task-btn-view:hover {
            background-color: var(--primary);
            color: white;
        }

        .task-btn-edit:hover {
            background-color: var(--warning);
            color: white;
        }

        .task-btn-delete:hover {
            background-color: var(--danger);
            color: white;
        }

        .task-btn-play {
            background-color: var(--success);
            color: white;
        }

        .task-btn-pause {
            background-color: var(--warning);
            color: var(--dark);
        }

        .task-btn-share:hover {
            background-color: var(--info);
            color: white;
        }

        /* Multi-select Action Bar */
        .multi-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to right, var(--primary-dark), var(--primary));
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .multi-actions.active {
            transform: translateY(0);
        }

        .multi-actions-left {
            color: white;
            font-weight: 500;
        }

        .multi-actions-right {
            display: flex;
            gap: 10px;
        }

        /* Graph View */
        .graph-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .graph-container.active {
            display: block;
        }

        .graphs-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .graph-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            flex: 1;
            transition: var(--transition);
        }

        .graph-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--body-color);
            text-align: center;
        }

        /* Undo/Redo */
        .history-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Users Page */
        .users-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .users-container.active {
            display: block;
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .user-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .user-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .user-card-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .user-card-content {
            padding: 15px;
        }

        .user-card-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--body-color);
        }

        .user-card-email {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .user-card-role {
            font-size: 0.8rem;
            color: white;
            background-color: var(--primary);
            display: inline-block;
            padding: 3px 8px;
            border-radius: 50px;
        }

        /* Insights Section */
        .insights-section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .insights-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--body-color);
            margin-bottom: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .insight-card {
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
        }

        .insight-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .insight-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--body-color);
        }

        /* Expired Tasks Section */
        .expired-tasks-section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid var(--danger);
            transition: var(--transition);
        }

        .expired-tasks-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--body-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expired-tasks-header i {
            color: var(--danger);
        }

        .expired-tasks-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .expired-task-item {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .expired-task-item:hover {
            background-color: var(--gray-200);
        }

        .expired-task-name {
            font-weight: 500;
            color: var(--body-color);
        }

        .expired-task-date {
            font-size: 0.9rem;
            color: var(--danger);
        }

        /* About to Expire Section */
        .warning-tasks-section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid var(--warning);
            transition: var(--transition);
        }

        .warning-tasks-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--body-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-tasks-header i {
            color: var(--warning);
        }

        .warning-tasks-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .warning-task-item {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            background-color: var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .warning-task-item:hover {
            background-color: var(--gray-200);
        }

        .warning-task-name {
            font-weight: 500;
            color: var(--body-color);
        }

        .warning-task-date {
            font-size: 0.9rem;
            color: var(--warning);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 25px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--body-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: scale(1.1);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-form-group {
            margin-bottom: 15px;
        }

        .modal-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--body-color);
        }

        .modal-input,
        .modal-select,
        .modal-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--card-bg);
            color: var(--body-color);
            transition: var(--transition);
        }

        .modal-input:focus,
        .modal-select:focus,
        .modal-textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        .modal-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Subtasks styles */
        .subtasks-container {
            margin-top: 10px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .subtask-input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background-color: var(--card-bg);
            color: var(--body-color);
        }

        .subtask-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .subtask-remove {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: var(--gray-200);
            color: var(--danger);
            cursor: pointer;
            transition: var(--transition);
        }

        .subtask-remove:hover {
            background-color: var(--danger);
            color: white;
        }

        .add-subtask-btn {
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border: 1px dashed var(--gray-400);
            border-radius: var(--border-radius);
            background: none;
            color: var(--primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-subtask-btn:hover {
            background-color: var(--gray-100);
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(-100%);
            animation: slideIn 0.3s forwards, slideOut 0.3s 4.7s forwards;
            max-width: 300px;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-success .toast-icon {
            color: var(--success);
        }

        .toast-error .toast-icon {
            color: var(--danger);
        }

        .toast-warning .toast-icon {
            color: var(--warning);
        }

        .toast-info .toast-icon {
            color: var(--info);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--body-color);
            margin-bottom: 3px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-100%);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .users-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-right {
                gap: 10px;
            }

            .app-title {
                font-size: 1.5rem;
            }

            .status-cards {
                flex-direction: column;
            }

            .graphs-row {
                flex-direction: column;
            }

            .task-filters {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .search-container {
                width: 100%;
            }

            .view-switcher {
                margin-left: 0;
                margin-top: 10px;
            }

            .users-grid {
                grid-template-columns: 1fr;
            }

            .task-timer {
                display: none;
            }

            .timer-display-mobile {
                display: block;
            }

            .task-header {
                flex-direction: column;
                gap: 10px;
            }

            .task-badges {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .auth-card {
                padding: 20px;
            }

            .task-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 10px;
            }

            .task-checkbox {
                align-self: flex-start;
            }

            .task-content {
                width: 100%;
            }

            .task-actions-container {
                align-self: flex-end;
                margin-top: 10px;
            }

            .modal {
                padding: 15px;
            }
        }

        /* Custom styles for flatpickr */
        .flatpickr-calendar {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
        }

        .flatpickr-day {
            color: var(--body-color);
        }

        .flatpickr-day.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .flatpickr-day:hover {
            background: var(--primary-light);
        }

        .flatpickr-months .flatpickr-month,
        .flatpickr-weekdays,
        .flatpickr-weekday {
            background: var(--card-bg);
            color: var(--body-color);
        }

        .flatpickr-months .flatpickr-prev-month, 
        .flatpickr-months .flatpickr-next-month {
            color: var(--body-color);
        }

        .flatpickr-day.today {
            border-color: var(--primary);
        }

        /* Custom styles for Chart.js */
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>To-Do App</h2>
                <p>Please login to continue</p>
            </div>
            <form id="loginForm">
                <div class="auth-form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="auth-form-input" value="test@example.com" required>
                </div>
                <div class="auth-form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="auth-form-input" value="123456" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
                <div class="auth-link">
                    Don't have an account? <a href="#" id="showRegister">Register now</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="container" style="display: none;">
        <header class="app-header">
            <a href="#" class="app-title">To-Do App</a>
            <div class="header-right">
                <div class="task-timer">
                    <div class="timer-display" id="timerDisplay">00:00:00</div>
                    <div class="timer-btns">
                        <button id="timerPlayBtn" class="timer-btn"><i class="bi bi-play-fill"></i></button>
                        <button id="timerPauseBtn" class="timer-btn" style="display: none;"><i class="bi bi-pause-fill"></i></button>
                    </div>
                </div>
                <div id="themeSwitch" class="theme-switch"></div>
                <div class="user-status" id="userStatus">Login</div>
                <div class="user-profile">
                    <div class="profile-img-container">
                        <img id="profileImage" src="https://randomuser.me/api/portraits/men/1.jpg" alt="User" class="profile-img">
                        <div id="notificationBadge" class="notification-badge">0</div>
                    </div>
                    <div id="profileDropdown" class="profile-dropdown">
                        <div class="dropdown-item" id="viewProfile">
                            <i class="bi bi-person-circle"></i>
                            View Profile
                        </div>
                        <div class="dropdown-item" id="changeStatus">
                            <i class="bi bi-toggle-on"></i>
                            Change Status
                        </div>
                        <div class="dropdown-item" id="viewUsers">
                            <i class="bi bi-people-fill"></i>
                            Users
                        </div>
                        <div class="dropdown-item" id="switchMode">
                            <i class="bi bi-moon"></i>
                            Switch Mode
                        </div>
                        <div class="dropdown-item" id="logoutBtn">
                            <i class="bi bi-box-arrow-right"></i>
                            Logout
                        </div>
                    </div>
                    <div id="notificationsDropdown" class="notifications-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button id="markAllRead">Mark all as read</button>
                        </div>
                        <div id="notificationsList"></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Dashboard View -->
            <div id="dashboardView" class="main-dashboard active">
                <!-- Task Summary -->
                <div class="task-summary">
                    <div class="total-tasks-card">
                        <div class="card-title">Total Tasks</div>
                        <div class="card-value" id="totalTasksCount">0</div>
                    </div>
                    <div class="status-cards">
                        <div class="status-card card-completed">
                            <div class="card-title">Completed Tasks</div>
                            <div class="card-value" id="completedTasksCount">0</div>
                        </div>
                        <div class="status-card card-pending">
                            <div class="card-title">Pending Tasks</div>
                            <div class="card-value" id="pendingTasksCount">0</div>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="tasks-section">
                    <div class="tasks-header">
                        <h2 class="task-title">Tasks</h2>
                        <div class="task-actions">
                            <div class="history-actions">
                                <button id="undoBtn" class="btn btn-outline btn-icon" title="Undo">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button id="redoBtn" class="btn btn-outline btn-icon" title="Redo">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                            <button id="addTaskBtn" class="btn btn-success">
                                <i class="bi bi-plus-lg"></i> Add Task
                            </button>
                            <button id="exportBtn" class="btn btn-info">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button id="importBtn" class="btn btn-secondary">
                                <i class="bi bi-upload"></i> Import
                            </button>
                            <button id="manageCategories" class="btn btn-primary">
                                <i class="bi bi-tags"></i> Categories
                            </button>
                        </div>
                    </div>

                    <!-- Task Filters -->
                    <div class="task-filters">
                        <div class="filter-group">
                            <span class="filter-label">Status:</span>
                            <select id="statusFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Category:</span>
                            <select id="categoryFilter" class="filter-select">
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Priority:</span>
                            <select id="priorityFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Due Date:</span>
                            <select id="dueDateFilter" class="filter-select">
                                <option value="all">All</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Sort By:</span>
                            <select id="sortFilter" class="filter-select">
                                <option value="dueDate-asc">Due Date (Earliest)</option>
                                <option value="dueDate-desc">Due Date (Latest)</option>
                                <option value="name-asc">Title (A-Z)</option>
                                <option value="name-desc">Title (Z-A)</option>
                                <option value="priority-asc">Priority (Low-High)</option>
                                <option value="priority-desc">Priority (High-Low)</option>
                            </select>
                        </div>
                        <div class="search-container">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input" placeholder="Search tasks...">
                        </div>
                        <div class="view-switcher">
                            <button id="listViewBtn" class="view-btn active">List</button>
                            <button id="graphViewBtn" class="view-btn">Graph</button>
                        </div>
                    </div>

                    <!-- Task List View -->
                    <div id="taskListContainer" class="task-list-container">
                        <ul id="taskList" class="task-list"></ul>
                    </div>

                    <!-- Graph View -->
                    <div id="graphContainer" class="graph-container">
                        <div class="graphs-row">
                            <div class="graph-card">
                                <h3 class="graph-title">Tasks Over Time</h3>
                                <div class="chart-container">
                                    <canvas id="tasksChart"></canvas>
                                </div>
                            </div>
                            <div class="graph-card">
                                <h3 class="graph-title">Task Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="taskDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Multi-select Action Bar -->
                    <div id="multiActions" class="multi-actions">
                        <div class="multi-actions-left">
                            <span id="selectedCount">0</span> tasks selected
                        </div>
                        <div class="multi-actions-right">
                            <button id="completeSelectedBtn" class="btn btn-success">Mark as Complete</button>
                            <button id="deleteSelectedBtn" class="btn btn-danger">Delete Selected</button>
                            <button id="cancelSelectionBtn" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Insights Section -->
                <div class="insights-section">
                    <h2 class="insights-header">Insights</h2>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Completion Rate</div>
                                <div class="insight-value" id="completionRate">0%</div>
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Average Time Spent</div>
                                <div class="insight-value" id="avgTimeSpent">0h 0m</div>
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Most Productive Day</div>
                                <div class="insight-value" id="productiveDay">-</div>
                            </div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                            </div>
                            <div class="insight-content">
                                <div class="insight-title">Overdue Rate</div>
                                <div class="insight-value" id="overdueRate">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expired Tasks Section -->
                <div class="expired-tasks-section">
                    <h3 class="expired-tasks-header">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Expired Tasks
                    </h3>
                    <ul id="expiredTasksList" class="expired-tasks-list"></ul>
                </div>

                <!-- About to Expire Tasks Section -->
                <div class="warning-tasks-section">
                    <h3 class="warning-tasks-header">
                        <i class="bi bi-exclamation-circle-fill"></i>
                        Tasks Due Soon (Next 48 Hours)
                    </h3>
                    <ul id="warningTasksList" class="warning-tasks-list"></ul>
                </div>
            </div>

            <!-- Users View (Initially Hidden) -->
            <div id="usersView" class="users-container">
                <!-- Will be populated dynamically -->
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Modals -->
    <!-- Register Modal -->
    <div id="registerModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create an Account</h3>
                <button class="modal-close" id="closeRegisterModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="modal-form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="confirmEmail">Confirm Email</label>
                        <input type="email" id="confirmEmail" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="birthdate">Birthdate</label>
                        <input type="text" id="birthdate" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="nationality">Nationality</label>
                        <select id="nationality" class="modal-select" required></select>
                    </div>
                    <div class="modal-form-group">
                        <label for="role">Role</label>
                        <select id="role" class="modal-select" required>
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="createAccountBtn" class="btn btn-success">Create</button>
                <button id="cancelRegisterBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="modal-close" id="closeAddTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="modal-form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="taskDescription">Description</label>
                        <textarea id="taskDescription" class="modal-textarea" required></textarea>
                    </div>
                    <div class="modal-form-group">
                        <label for="taskDueDate">Due Date</label>
                        <input type="text" id="taskDueDate" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority" class="modal-select" required>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="modal-form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory" class="modal-select" required></select>
                    </div>
                    <div class="modal-form-group">
                        <label>Subtasks</label>
                        <div id="subtasksContainer" class="subtasks-container"></div>
                        <button type="button" id="addSubtaskBtn" class="add-subtask-btn">
                            <i class="bi bi-plus"></i> Add Subtask
                        </button>
                    </div>
                    <div class="modal-form-group">
                        <label for="taskNotes">Notes</label>
                        <textarea id="taskNotes" class="modal-textarea"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="createTaskBtn" class="btn btn-success">Create</button>
                <button id="cancelAddTaskBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- View Task Modal -->
    <div id="viewTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="viewTaskTitle">Task Details</h3>
                <button class="modal-close" id="closeViewTaskModal">&times;</button>
            </div>
            <div class="modal-body" id="viewTaskDetails">
                <!-- Task details will be filled dynamically -->
            </div>
            <div class="modal-footer">
                <button id="closeViewTaskBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="editTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Task</h3>
                <button class="modal-close" id="closeEditTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="modal-form-group">
                        <label for="editTaskTitle">Title</label>
                        <input type="text" id="editTaskTitle" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editTaskDescription">Description</label>
                        <textarea id="editTaskDescription" class="modal-textarea" required></textarea>
                    </div>
                    <div class="modal-form-group">
                        <label for="editTaskDueDate">Due Date</label>
                        <input type="text" id="editTaskDueDate" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editTaskPriority">Priority</label>
                        <select id="editTaskPriority" class="modal-select" required>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="modal-form-group">
                        <label for="editTaskCategory">Category</label>
                        <select id="editTaskCategory" class="modal-select" required></select>
                    </div>
                    <div class="modal-form-group">
                        <label>Subtasks</label>
                        <div id="editSubtasksContainer" class="subtasks-container"></div>
                        <button type="button" id="editAddSubtaskBtn" class="add-subtask-btn">
                            <i class="bi bi-plus"></i> Add Subtask
                        </button>
                    </div>
                    <div class="modal-form-group">
                        <label for="editTaskNotes">Notes</label>
                        <textarea id="editTaskNotes" class="modal-textarea"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveTaskBtn" class="btn btn-success">Save</button>
                <button id="cancelEditTaskBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">User Profile</h3>
                <button class="modal-close" id="closeProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="profileDetails"></div>
            </div>
            <div class="modal-footer">
                <button id="editProfileBtn" class="btn btn-primary">Edit Profile</button>
                <button id="closeProfileBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" id="closeEditProfileModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="modal-form-group">
                        <label for="editProfileLastName">Last Name</label>
                        <input type="text" id="editProfileLastName" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfileFirstName">First Name</label>
                        <input type="text" id="editProfileFirstName" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfileEmail">Email</label>
                        <input type="email" id="editProfileEmail" class="modal-input" required>
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfilePhone">Phone</label>
                        <input type="tel" id="editProfilePhone" class="modal-input">
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfileCountry">Country</label>
                        <select id="editProfileCountry" class="modal-select" required></select>
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfileRole">Role</label>
                        <select id="editProfileRole" class="modal-select" required>
                            <option value="Manager">Manager</option>
                            <option value="Staff">Staff</option>
                            <option value="Customer">Customer</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="modal-form-group">
                        <label for="editProfilePicture">Profile Picture</label>
                        <input type="file" id="editProfilePicture" class="modal-input" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveProfileBtn" class="btn btn-success">Save</button>
                <button id="cancelEditProfileBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Tasks</h3>
                <button class="modal-close" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="exportFormat">Choose Format</label>
                    <select id="exportFormat" class="modal-select">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="doExportBtn" class="btn btn-success">Export</button>
                <button id="cancelExportBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Import Tasks</h3>
                <button class="modal-close" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="importFile">Upload JSON File</label>
                    <input type="file" id="importFile" class="modal-input" accept=".json">
                </div>
                <div class="modal-form-group">
                    <label for="importUrl">Or Import from URL</label>
                    <input type="url" id="importUrl" class="modal-input" placeholder="https://example.com/tasks.json">
                </div>
            </div>
            <div class="modal-footer">
                <button id="doImportBtn" class="btn btn-success">Import</button>
                <button id="cancelImportBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Users Modal -->
    <div id="usersModal" class="modal-overlay">
        <div class="modal" style="width: 700px; max-width: 90%;">
            <div class="modal-header">
                <h3 class="modal-title">Users</h3>
                <button class="modal-close" id="closeUsersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersGrid" class="users-grid"></div>
            </div>
            <div class="modal-footer">
                <button id="closeUsersBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="categoriesModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Manage Categories</h3>
                <button class="modal-close" id="closeCategoriesModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="newCategory">New Category</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newCategory" class="modal-input" placeholder="Category name">
                        <button id="addCategoryBtn" class="btn btn-success">Add</button>
                    </div>
                </div>
                <div class="modal-form-group">
                    <label>Existing Categories</label>
                    <ul id="categoriesList" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeCategoriesBtn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Change Status Modal -->
    <div id="statusModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Change Status</h3>
                <button class="modal-close" id="closeStatusModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="userStatusSelect">Select Status</label>
                    <select id="userStatusSelect" class="modal-select">
                        <option value="Login" style="color: green;">Login</option>
                        <option value="Logout" style="color: red;">Logout</option>
                        <option value="Break" style="color: orange;">Break</option>
                        <option value="Shadow" style="color: gray;">Shadow</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveStatusBtn" class="btn btn-success">Save</button>
                <button id="cancelStatusBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Date Range Modal -->
    <div id="dateRangeModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Date Range</h3>
                <button class="modal-close" id="closeDateRangeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="startDate">Start Date</label>
                    <input type="text" id="startDate" class="modal-input">
                </div>
                <div class="modal-form-group">
                    <label for="endDate">End Date</label>
                    <input type="text" id="endDate" class="modal-input">
                </div>
            </div>
            <div class="modal-footer">
                <button id="applyDateRangeBtn" class="btn btn-success">Apply</button>
                <button id="cancelDateRangeBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Share Task Modal -->
    <div id="shareTaskModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Task</h3>
                <button class="modal-close" id="closeShareTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-form-group">
                    <label for="shareTaskWith">Share with</label>
                    <select id="shareTaskWith" class="modal-select" multiple></select>
                </div>
                <div class="modal-form-group">
                    <label for="shareMessage">Message (optional)</label>
                    <textarea id="shareMessage" class="modal-textarea" placeholder="Add a message..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="doShareTaskBtn" class="btn btn-success">Share</button>
                <button id="cancelShareTaskBtn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // DOM Elements
        const authPage = document.getElementById('authPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const dashboardView = document.getElementById('dashboardView');
        const usersView = document.getElementById('usersView');
        
        // Forms
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const addTaskForm = document.getElementById('addTaskForm');
        const editTaskForm = document.getElementById('editTaskForm');
        const editProfileForm = document.getElementById('editProfileForm');
        
        // Buttons and Interactive Elements
        const showRegisterBtn = document.getElementById('showRegister');
        const profileImage = document.getElementById('profileImage');
        const notificationBadge = document.getElementById('notificationBadge');
        const themeSwitch = document.getElementById('themeSwitch');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const manageCategoriesBtn = document.getElementById('manageCategories');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const graphViewBtn = document.getElementById('graphViewBtn');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerPlayBtn = document.getElementById('timerPlayBtn');
        const timerPauseBtn = document.getElementById('timerPauseBtn');
        const userStatus = document.getElementById('userStatus');
        
        // Counters
        const totalTasksCount = document.getElementById('totalTasksCount');
        const completedTasksCount = document.getElementById('completedTasksCount');
        const pendingTasksCount = document.getElementById('pendingTasksCount');
        
        // Lists and Containers
        const taskList = document.getElementById('taskList');
        const notificationsList = document.getElementById('notificationsList');
        const taskListContainer = document.getElementById('taskListContainer');
        const graphContainer = document.getElementById('graphContainer');
        const multiActions = document.getElementById('multiActions');
        const selectedCount = document.getElementById('selectedCount');
        const expiredTasksList = document.getElementById('expiredTasksList');
        const warningTasksList = document.getElementById('warningTasksList');
        
        // Dropdowns and Selectable Elements
        const profileDropdown = document.getElementById('profileDropdown');
        const notificationsDropdown = document.getElementById('notificationsDropdown');
        const statusFilter = document.getElementById('statusFilter');
        const categoryFilter = document.getElementById('categoryFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        const dueDateFilter = document.getElementById('dueDateFilter');
        const sortFilter = document.getElementById('sortFilter');
        const searchInput = document.getElementById('searchInput');
        
        // Insight Elements
        const completionRate = document.getElementById('completionRate');
        const avgTimeSpent = document.getElementById('avgTimeSpent');
        const productiveDay = document.getElementById('productiveDay');
        const overdueRate = document.getElementById('overdueRate');
        
        // Chart Canvases
        const tasksChart = document.getElementById('tasksChart');
        const taskDistributionChart = document.getElementById('taskDistributionChart');
        
        // Global Variables
        let currentUser = null;
        let currentTasks = [];
        let allUsers = [];
        let taskCategories = ['Work', 'Personal', 'Shopping', 'Health', 'Education'];
        let notifications = [];
        let taskHistory = {
            past: [],
            future: []
        };
        let activeTaskTimer = null;
        let globalTimer = {
            seconds: 0,
            interval: null,
            isRunning: false
        };
        let tasksChartInstance = null;
        let taskDistributionChartInstance = null;
        let selectedTasks = new Set();
        let dateRangeFilter = {
            start: null,
            end: null
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // Listen for changes in color scheme preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Initialize the application
        function initApp() {
            loadDataFromStorage();
            setupEventListeners();
            initializeFlatpickr();
            loadCountriesList();
            
            // Create default categories if none exist
            if (!localStorage.getItem('taskCategories')) {
                localStorage.setItem('taskCategories', JSON.stringify(taskCategories));
            } else {
                taskCategories = JSON.parse(localStorage.getItem('taskCategories'));
            }
            
            updateCategorySelects();
            generateRandomUsers();
            
            // If there are no sample tasks, generate them
            if (currentTasks.length === 0) {
                generateSampleTasks();
            }
        }
        
        // Load data from local storage
        function loadDataFromStorage() {
            if (localStorage.getItem('currentUser')) {
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
            }
            
            if (localStorage.getItem('tasks')) {
                currentTasks = JSON.parse(localStorage.getItem('tasks'));
            }
            
            if (localStorage.getItem('users')) {
                allUsers = JSON.parse(localStorage.getItem('users'));
            }
            
            if (localStorage.getItem('notifications')) {
                notifications = JSON.parse(localStorage.getItem('notifications'));
            }
            
            if (localStorage.getItem('globalTimer')) {
                globalTimer = JSON.parse(localStorage.getItem('globalTimer'));
                updateTimerDisplay();
            }
        }
        
        // Set up event listeners for all interactive elements
        function setupEventListeners() {
            // Login and Registration
            loginForm.addEventListener('submit', handleLogin);
            showRegisterBtn.addEventListener('click', showRegisterModal);
            document.getElementById('closeRegisterModal').addEventListener('click', closeRegisterModal);
            document.getElementById('cancelRegisterBtn').addEventListener('click', closeRegisterModal);
            document.getElementById('createAccountBtn').addEventListener('click', handleRegistration);
            
            // User Profile
            profileImage.addEventListener('click', toggleProfileDropdown);
            document.getElementById('viewProfile').addEventListener('click', showProfileModal);
            document.getElementById('changeStatus').addEventListener('click', showStatusModal);
            document.getElementById('viewUsers').addEventListener('click', showUsersModal);
            document.getElementById('switchMode').addEventListener('click', toggleDarkMode);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('closeProfileModal').addEventListener('click', closeProfileModal);
            document.getElementById('closeProfileBtn').addEventListener('click', closeProfileModal);
            document.getElementById('editProfileBtn').addEventListener('click', showEditProfileModal);
            document.getElementById('closeEditProfileModal').addEventListener('click', closeEditProfileModal);
            document.getElementById('cancelEditProfileBtn').addEventListener('click', closeEditProfileModal);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            
            // Status Change
            document.getElementById('closeStatusModal').addEventListener('click', closeStatusModal);
            document.getElementById('cancelStatusBtn').addEventListener('click', closeStatusModal);
            document.getElementById('saveStatusBtn').addEventListener('click', saveStatus);
            
            // Notifications
            notificationBadge.addEventListener('click', toggleNotificationsDropdown);
            document.getElementById('markAllRead').addEventListener('click', markAllNotificationsAsRead);
            
            // Task Management
            addTaskBtn.addEventListener('click', showAddTaskModal);
            document.getElementById('closeAddTaskModal').addEventListener('click', closeAddTaskModal);
            document.getElementById('cancelAddTaskBtn').addEventListener('click', closeAddTaskModal);
            document.getElementById('createTaskBtn').addEventListener('click', createTask);
            document.getElementById('addSubtaskBtn').addEventListener('click', addSubtaskField);
            
            document.getElementById('closeViewTaskModal').addEventListener('click', closeViewTaskModal);
            document.getElementById('closeViewTaskBtn').addEventListener('click', closeViewTaskModal);
            
            document.getElementById('closeEditTaskModal').addEventListener('click', closeEditTaskModal);
            document.getElementById('cancelEditTaskBtn').addEventListener('click', closeEditTaskModal);
            document.getElementById('saveTaskBtn').addEventListener('click', saveEditedTask);
            document.getElementById('editAddSubtaskBtn').addEventListener('click', addEditSubtaskField);
            
            // Task Filtering and Sorting
            statusFilter.addEventListener('change', applyFilters);
            categoryFilter.addEventListener('change', applyFilters);
            priorityFilter.addEventListener('change', applyFilters);
            dueDateFilter.addEventListener('change', handleDueDateFilter);
            sortFilter.addEventListener('change', applyFilters);
            searchInput.addEventListener('input', applyFilters);
            
            // View Switching
            listViewBtn.addEventListener('click', switchToListView);
            graphViewBtn.addEventListener('click', switchToGraphView);
            
            // Export/Import
            exportBtn.addEventListener('click', showExportModal);
            document.getElementById('closeExportModal').addEventListener('click', closeExportModal);
            document.getElementById('cancelExportBtn').addEventListener('click', closeExportModal);
            document.getElementById('doExportBtn').addEventListener('click', exportTasks);
            
            importBtn.addEventListener('click', showImportModal);
            document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
            document.getElementById('cancelImportBtn').addEventListener('click', closeImportModal);
            document.getElementById('doImportBtn').addEventListener('click', importTasks);
            
            // Categories Management
            manageCategoriesBtn.addEventListener('click', showCategoriesModal);
            document.getElementById('closeCategoriesModal').addEventListener('click', closeCategoriesModal);
            document.getElementById('closeCategoriesBtn').addEventListener('click', closeCategoriesModal);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            
            // Multi-select Actions
            document.getElementById('completeSelectedBtn').addEventListener('click', completeSelectedTasks);
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedTasks);
            document.getElementById('cancelSelectionBtn').addEventListener('click', cancelSelection);
            
            // History Actions (Undo/Redo)
            undoBtn.addEventListener('click', undoAction);
            redoBtn.addEventListener('click', redoAction);
            
            // Timer Controls
            timerPlayBtn.addEventListener('click', startGlobalTimer);
            timerPauseBtn.addEventListener('click', pauseGlobalTimer);
            
            // Date Range Modal
            document.getElementById('closeDateRangeModal').addEventListener('click', closeDateRangeModal);
            document.getElementById('cancelDateRangeBtn').addEventListener('click', closeDateRangeModal);
            document.getElementById('applyDateRangeBtn').addEventListener('click', applyDateRange);
            
            // Users Modal
            document.getElementById('closeUsersModal').addEventListener('click', closeUsersModal);
            document.getElementById('closeUsersBtn').addEventListener('click', closeUsersModal);
            
            // Share Task Modal
            document.getElementById('closeShareTaskModal').addEventListener('click', closeShareTaskModal);
            document.getElementById('cancelShareTaskBtn').addEventListener('click', closeShareTaskModal);
            document.getElementById('doShareTaskBtn').addEventListener('click', shareTask);
            
            // App Title (for dashboard navigation)
            document.querySelector('.app-title').addEventListener('click', function() {
                showDashboard();
            });
            
            // Theme Switch
            themeSwitch.addEventListener('click', toggleDarkMode);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!profileDropdown.contains(event.target) && !profileImage.contains(event.target)) {
                    profileDropdown.classList.remove('active');
                }
                
                if (!notificationsDropdown.contains(event.target) && !notificationBadge.contains(event.target)) {
                    notificationsDropdown.classList.remove('active');
                }
            });
        }
        
        // Initialize Flatpickr date pickers
        function initializeFlatpickr() {
            // Registration birthdate picker
            flatpickr("#birthdate", {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
            
            // Task due date pickers
            flatpickr("#taskDueDate", {
                dateFormat: "Y-m-d H:i",
                enableTime: true,
                minDate: "today",
                time_24hr: true
            });
            
            flatpickr("#editTaskDueDate", {
                dateFormat: "Y-m-d H:i",
                enableTime: true,
                time_24hr: true
            });
            
            // Date range pickers for filter
            flatpickr("#startDate", {
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr) {
                    document.getElementById('endDate')._flatpickr.set('minDate', dateStr);
                }
            });
            
            flatpickr("#endDate", {
                dateFormat: "Y-m-d"
            });
        }
        
        // Load countries list for nationality dropdown
        function loadCountriesList() {
            const countries = [
                { code: "US", name: "United States" },
                { code: "GB", name: "United Kingdom" },
                { code: "CA", name: "Canada" },
                { code: "AU", name: "Australia" },
                { code: "DE", name: "Germany" },
                { code: "FR", name: "France" },
                { code: "JP", name: "Japan" },
                { code: "CN", name: "China" },
                { code: "IN", name: "India" },
                { code: "BR", name: "Brazil" },
                { code: "RU", name: "Russia" },
                { code: "ZA", name: "South Africa" },
                { code: "MX", name: "Mexico" },
                { code: "IT", name: "Italy" },
                { code: "ES", name: "Spain" },
                { code: "KR", name: "South Korea" },
                { code: "NG", name: "Nigeria" },
                { code: "EG", name: "Egypt" },
                { code: "SA", name: "Saudi Arabia" },
                { code: "AE", name: "United Arab Emirates" }
            ];
            
            const nationalitySelect = document.getElementById('nationality');
            const editProfileCountry = document.getElementById('editProfileCountry');
            
            // Clear existing options
            nationalitySelect.innerHTML = '';
            editProfileCountry.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select country';
            nationalitySelect.appendChild(defaultOption.cloneNode(true));
            editProfileCountry.appendChild(defaultOption);
            
            // Add country options
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                
                nationalitySelect.appendChild(option.cloneNode(true));
                editProfileCountry.appendChild(option);
            });
        }
        
        // Generate random users
        function generateRandomUsers() {
            if (allUsers.length > 0) return;
            
            const randomUserNames = [
                { first: "John", last: "Doe" },
                { first: "Jane", last: "Smith" },
                { first: "Mike", last: "Johnson" },
                { first: "Emma", last: "Williams" },
                { first: "James", last: "Brown" },
                { first: "Olivia", last: "Miller" },
                { first: "William", last: "Davis" },
                { first: "Sophia", last: "Garcia" },
                { first: "Benjamin", last: "Rodriguez" },
                { first: "Isabella", last: "Wilson" }
            ];
            
            const roles = ["Manager", "Staff", "Customer", "Admin"];
            const countries = ["US", "GB", "CA", "AU", "DE", "FR", "JP"];
            
            randomUserNames.forEach((name, index) => {
                const email = `${name.first.toLowerCase()}.${name.last.toLowerCase()}@example.com`;
                const role = roles[Math.floor(Math.random() * roles.length)];
                const country = countries[Math.floor(Math.random() * countries.length)];
                
                allUsers.push({
                    id: generateId(),
                    firstName: name.first,
                    lastName: name.last,
                    email: email,
                    password: "123456", // Simple password for demo
                    birthdate: "1990-01-01",
                    nationality: country,
                    role: role,
                    phone: `+1${Math.floor(1000000000 + Math.random() * 9000000000)}`,
                    profilePicture: `https://randomuser.me/api/portraits/${index % 2 ? 'women' : 'men'}/${index + 1}.jpg`,
                    joinDate: new Date().toISOString()
                });
            });
            
            // Add test user if not already present
            if (!allUsers.find(user => user.email === "test@example.com")) {
                allUsers.push({
                    id: generateId(),
                    firstName: "Test",
                    lastName: "User",
                    email: "test@example.com",
                    password: "123456",
                    birthdate: "1995-05-15",
                    nationality: "US",
                    role: "Admin",
                    phone: "+11234567890",
                    profilePicture: "https://randomuser.me/api/portraits/men/0.jpg",
                    joinDate: new Date().toISOString()
                });
            }
            
            localStorage.setItem('users', JSON.stringify(allUsers));
        }
        
        // Generate sample tasks
        function generateSampleTasks() {
            const tasks = [
                {
                    id: generateId(),
                    title: "Complete Project Proposal",
                    description: "Draft and finalize the project proposal for the client meeting.",
                    dueDate: addDays(new Date(), 2).toISOString(),
                    priority: "high",
                    category: "Work",
                    completed: false,
                    createdAt: subtractDays(new Date(), 3).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Research industry trends", completed: true },
                        { id: generateId(), title: "Create outline", completed: true },
                        { id: generateId(), title: "Write executive summary", completed: false }
                    ],
                    notes: "Make sure to include the budget section and timeline.",
                    timeSpent: 7200 // 2 hours in seconds
                },
                {
                    id: generateId(),
                    title: "Schedule Doctor's Appointment",
                    description: "Call Dr. Smith's office to schedule annual check-up.",
                    dueDate: addDays(new Date(), 5).toISOString(),
                    priority: "medium",
                    category: "Health",
                    completed: false,
                    createdAt: subtractDays(new Date(), 1).toISOString(),
                    subtasks: [],
                    notes: "Remember to bring insurance card and list of medications.",
                    timeSpent: 0
                },
                {
                    id: generateId(),
                    title: "Grocery Shopping",
                    description: "Buy groceries for the week.",
                    dueDate: addHours(new Date(), 20).toISOString(),
                    priority: "low",
                    category: "Shopping",
                    completed: false,
                    createdAt: subtractDays(new Date(), 1).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Vegetables", completed: false },
                        { id: generateId(), title: "Fruits", completed: false },
                        { id: generateId(), title: "Meat", completed: false },
                        { id: generateId(), title: "Bread", completed: false }
                    ],
                    notes: "Check for sales on pasta and rice.",
                    timeSpent: 1800 // 30 minutes in seconds
                },
                {
                    id: generateId(),
                    title: "Team Meeting Preparation",
                    description: "Prepare agenda and materials for weekly team meeting.",
                    dueDate: subtractHours(new Date(), 5).toISOString(),
                    priority: "high",
                    category: "Work",
                    completed: false,
                    createdAt: subtractDays(new Date(), 7).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Create agenda", completed: true },
                        { id: generateId(), title: "Prepare slides", completed: false }
                    ],
                    notes: "Include project status updates and upcoming deadlines.",
                    timeSpent: 5400 // 1.5 hours in seconds
                },
                {
                    id: generateId(),
                    title: "Gym Workout",
                    description: "Complete weekly workout routine.",
                    dueDate: addDays(new Date(), 1).toISOString(),
                    priority: "medium",
                    category: "Health",
                    completed: true,
                    createdAt: subtractDays(new Date(), 10).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Cardio - 30 min", completed: true },
                        { id: generateId(), title: "Strength training", completed: true },
                        { id: generateId(), title: "Stretching", completed: true }
                    ],
                    notes: "Don't forget to bring water bottle and towel.",
                    timeSpent: 3600 // 1 hour in seconds
                },
                {
                    id: generateId(),
                    title: "Pay Bills",
                    description: "Pay monthly utility bills and rent.",
                    dueDate: addDays(new Date(), 10).toISOString(),
                    priority: "high",
                    category: "Personal",
                    completed: false,
                    createdAt: new Date().toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Electricity bill", completed: false },
                        { id: generateId(), title: "Water bill", completed: false },
                        { id: generateId(), title: "Internet bill", completed: false },
                        { id: generateId(), title: "Rent", completed: false }
                    ],
                    notes: "Set up auto-pay for future bills.",
                    timeSpent: 0
                },
                {
                    id: generateId(),
                    title: "Review Online Course",
                    description: "Complete week 3 of JavaScript advanced course.",
                    dueDate: addDays(new Date(), 3).toISOString(),
                    priority: "medium",
                    category: "Education",
                    completed: false,
                    createdAt: subtractDays(new Date(), 14).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Watch video lectures", completed: true },
                        { id: generateId(), title: "Complete assignments", completed: false },
                        { id: generateId(), title: "Take quiz", completed: false }
                    ],
                    notes: "Review notes on closures and promises.",
                    timeSpent: 10800 // 3 hours in seconds
                },
                {
                    id: generateId(),
                    title: "Clean Apartment",
                    description: "Deep clean the apartment.",
                    dueDate: addHours(new Date(), 36).toISOString(),
                    priority: "low",
                    category: "Personal",
                    completed: false,
                    createdAt: subtractDays(new Date(), 2).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Vacuum floors", completed: false },
                        { id: generateId(), title: "Clean bathroom", completed: false },
                        { id: generateId(), title: "Dust furniture", completed: false },
                        { id: generateId(), title: "Clean kitchen", completed: false },
                        { id: generateId(), title: "Change bed sheets", completed: false }
                    ],
                    notes: "Buy cleaning supplies if needed.",
                    timeSpent: 0
                },
                {
                    id: generateId(),
                    title: "Prepare Quarterly Report",
                    description: "Compile data and prepare quarterly financial report.",
                    dueDate: subtractDays(new Date(), 2).toISOString(),
                    priority: "high",
                    category: "Work",
                    completed: false,
                    createdAt: subtractDays(new Date(), 30).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Gather data", completed: true },
                        { id: generateId(), title: "Create charts", completed: false },
                        { id: generateId(), title: "Write analysis", completed: false },
                        { id: generateId(), title: "Format document", completed: false }
                    ],
                    notes: "Include comparison with previous quarters.",
                    timeSpent: 14400 // 4 hours in seconds
                },
                {
                    id: generateId(),
                    title: "Birthday Gift Shopping",
                    description: "Buy birthday gift for Mom.",
                    dueDate: addDays(new Date(), 7).toISOString(),
                    priority: "medium",
                    category: "Shopping",
                    completed: false,
                    createdAt: subtractDays(new Date(), 5).toISOString(),
                    subtasks: [
                        { id: generateId(), title: "Research gift ideas", completed: true },
                        { id: generateId(), title: "Check online stores", completed: false },
                        { id: generateId(), title: "Visit local shops", completed: false }
                    ],
                    notes: "She mentioned wanting a new cookbook or gardening tools.",
                    timeSpent: 3600 // 1 hour in seconds
                }
            ];
            
            currentTasks = tasks;
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Add notifications for tasks that are expired or due soon
            tasks.forEach(task => {
                const dueDate = new Date(task.dueDate);
                const now = new Date();
                
                if (dueDate < now && !task.completed) {
                    addNotification(`Task '${task.title}' is overdue!`, 'danger');
                } else if (isWithin48Hours(dueDate, now) && !task.completed) {
                    addNotification(`Task '${task.title}' is due soon (within 48 hours).`, 'warning');
                }
            });
        }
        
        // Handle login form submission
        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Find user with matching credentials
            const user = allUsers.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Update profile display
                updateProfileDisplay();
                
                // Show dashboard and update task list
                showDashboard();
                renderAllTasks();
                updateTaskCounts();
                updateInsights();
                renderExpiredAndWarningTasks();
                
                // Show success toast
                showToast('Success', 'Logged in successfully!', 'success');
            } else {
                showToast('Error', 'Invalid email or password', 'error');
            }
        }
        
        // Show registration modal
        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('active');
        }
        
        // Close registration modal
        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
            document.getElementById('registerForm').reset();
        }
        
        // Handle registration form submission
        function handleRegistration() {
            const lastName = document.getElementById('lastName').value;
            const firstName = document.getElementById('firstName').value;
            const email = document.getElementById('registerEmail').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthdate = document.getElementById('birthdate').value;
            const nationality = document.getElementById('nationality').value;
            const role = document.getElementById('role').value;
            
            // Validate inputs
            if (!lastName || !firstName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                showToast('Error', 'All fields are required', 'error');
                return;
            }
            
            // Validate email format
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                showToast('Error', 'Please enter a valid email address', 'error');
                return;
            }
            
            // Check if email and confirmed email match
            if (email !== confirmEmail) {
                showToast('Error', 'Emails do not match', 'error');
                return;
            }
            
            // Check if password and confirmed password match
            if (password !== confirmPassword) {
                showToast('Error', 'Passwords do not match', 'error');
                return;
            }
            
            // Check if email already exists
            if (allUsers.some(user => user.email === email)) {
                showToast('Error', 'Email already registered', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                id: generateId(),
                lastName,
                firstName,
                email,
                password,
                birthdate,
                nationality,
                role,
                profilePicture: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${Math.floor(Math.random() * 70)}.jpg`,
                joinDate: new Date().toISOString(),
                phone: ''
            };
            
            // Add user to all users array
            allUsers.push(newUser);
            localStorage.setItem('users', JSON.stringify(allUsers));
            
            // Close register modal
            closeRegisterModal();
            
            // Show success toast
            showToast('Success', 'Account created successfully! You can now log in.', 'success');
        }
        
        // Toggle profile dropdown
        function toggleProfileDropdown(e) {
            e.stopPropagation();
            profileDropdown.classList.toggle('active');
            notificationsDropdown.classList.remove('active');
        }
        
        // Toggle notifications dropdown
        function toggleNotificationsDropdown(e) {
            e.stopPropagation();
            notificationsDropdown.classList.toggle('active');
            profileDropdown.classList.remove('active');
            renderNotifications();
        }
        
        // Show profile modal
        function showProfileModal() {
            profileDropdown.classList.remove('active');
            
            // Populate profile details
            const profileDetails = document.getElementById('profileDetails');
            
            const profileHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="${currentUser.profilePicture}" alt="${currentUser.firstName}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
                    <h2 style="margin: 0; color: var(--body-color);">${currentUser.firstName} ${currentUser.lastName}</h2>
                    <p style="margin: 5px 0; color: var(--primary);">${currentUser.role}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Email</p>
                        <p style="margin: 0 0 15px 0; color: var(--body-color);">${currentUser.email}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Phone</p>
                        <p style="margin: 0 0 15px 0; color: var(--body-color);">${currentUser.phone || 'Not provided'}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Country</p>
                        <p style="margin: 0 0 15px 0; color: var(--body-color);">${getCountryName(currentUser.nationality)}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Joining Date</p>
                        <p style="margin: 0 0 15px 0; color: var(--body-color);">${formatDate(currentUser.joinDate)}</p>
                    </div>
                </div>
            `;
            
            profileDetails.innerHTML = profileHTML;
            
            document.getElementById('profileModal').classList.add('active');
        }
        
        // Close profile modal
        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }
        
        // Show edit profile modal
        function showEditProfileModal() {
            closeProfileModal();
            
            // Populate form with current user data
            document.getElementById('editProfileLastName').value = currentUser.lastName;
            document.getElementById('editProfileFirstName').value = currentUser.firstName;
            document.getElementById('editProfileEmail').value = currentUser.email;
            document.getElementById('editProfilePhone').value = currentUser.phone || '';
            document.getElementById('editProfileCountry').value = currentUser.nationality;
            document.getElementById('editProfileRole').value = currentUser.role;
            
            document.getElementById('editProfileModal').classList.add('active');
        }
        
        // Close edit profile modal
        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('active');
            document.getElementById('editProfileForm').reset();
        }
        
        // Save edited profile
        function saveProfile() {
            const lastName = document.getElementById('editProfileLastName').value;
            const firstName = document.getElementById('editProfileFirstName').value;
            const email = document.getElementById('editProfileEmail').value;
            const phone = document.getElementById('editProfilePhone').value;
            const country = document.getElementById('editProfileCountry').value;
            const role = document.getElementById('editProfileRole').value;
            const profilePicture = document.getElementById('editProfilePicture').files[0];
            
            // Validate inputs
            if (!lastName || !firstName || !email || !country || !role) {
                showToast('Error', 'Required fields cannot be empty', 'error');
                return;
            }
            
            // Validate email format
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                showToast('Error', 'Please enter a valid email address', 'error');
                return;
            }
            
            // Check if new email already exists and is not the current user's email
            if (email !== currentUser.email && allUsers.some(user => user.email === email)) {
                showToast('Error', 'Email already in use by another account', 'error');
                return;
            }
            
            // Update current user data
            currentUser.lastName = lastName;
            currentUser.firstName = firstName;
            currentUser.email = email;
            currentUser.phone = phone;
            currentUser.nationality = country;
            currentUser.role = role;
            
            // Handle profile picture upload
            if (profilePicture) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profilePicture = e.target.result;
                    completeProfileUpdate();
                };
                reader.readAsDataURL(profilePicture);
            } else {
                completeProfileUpdate();
            }
        }
        
        // Complete profile update after handling picture upload
        function completeProfileUpdate() {
            // Update user in allUsers array
            const userIndex = allUsers.findIndex(user => user.id === currentUser.id);
            if (userIndex !== -1) {
                allUsers[userIndex] = currentUser;
            }
            
            // Update local storage
            localStorage.setItem('users', JSON.stringify(allUsers));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update profile display
            updateProfileDisplay();
            
            // Close edit profile modal
            closeEditProfileModal();
            
            // Show success toast
            showToast('Success', 'Profile updated successfully!', 'success');
            
            // Add notification
            addNotification('Your profile has been updated.', 'info');
        }
        
        // Show status modal
        function showStatusModal() {
            profileDropdown.classList.remove('active');
            document.getElementById('userStatusSelect').value = userStatus.textContent;
            document.getElementById('statusModal').classList.add('active');
        }
        
        // Close status modal
        function closeStatusModal() {
            document.getElementById('statusModal').classList.remove('active');
        }
        
        // Save status
        function saveStatus() {
            const status = document.getElementById('userStatusSelect').value;
            userStatus.textContent = status;
            
            // Update profile picture border color based on status
            const profileImgContainer = document.querySelector('.profile-img-container');
            
            if (status === 'Login') {
                profileImgContainer.style.borderColor = 'var(--success)';
            } else if (status === 'Logout') {
                profileImgContainer.style.borderColor = 'var(--danger)';
            } else if (status === 'Break') {
                profileImgContainer.style.borderColor = 'var(--warning)';
            } else if (status === 'Shadow') {
                profileImgContainer.style.borderColor = 'var(--secondary)';
            }
            
            closeStatusModal();
            showToast('Success', 'Status updated successfully!', 'success');
        }
        
        // Show users modal
        function showUsersModal() {
            profileDropdown.classList.remove('active');
            
            // Populate users grid
            const usersGrid = document.getElementById('usersGrid');
            
            let usersHTML = '';
            allUsers.forEach(user => {
                usersHTML += `
                    <div class="user-card">
                        <img src="${user.profilePicture}" alt="${user.firstName}" class="user-card-img">
                        <div class="user-card-content">
                            <h3 class="user-card-name">${user.firstName} ${user.lastName}</h3>
                            <p class="user-card-email">${user.email}</p>
                            <span class="user-card-role">${user.role}</span>
                        </div>
                    </div>
                `;
            });
            
            usersGrid.innerHTML = usersHTML;
            
            document.getElementById('usersModal').classList.add('active');
        }
        
        // Close users modal
        function closeUsersModal() {
            document.getElementById('usersModal').classList.remove('active');
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            
            // If graphs are initialized, update them
            updateCharts();
        }
        
        // Handle logout
        function handleLogout() {
            // Stop any running timers
            if (globalTimer.isRunning) {
                pauseGlobalTimer();
            }
            
            if (activeTaskTimer) {
                const activeTask = currentTasks.find(task => task.id === activeTaskTimer.taskId);
                if (activeTask) {
                    pauseTaskTimer(activeTask.id);
                }
            }
            
            // Clear current user
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            // Reset form fields
            document.getElementById('loginForm').reset();
            
            // Show auth page
            authPage.style.display = 'flex';
            dashboardPage.style.display = 'none';
            
            showToast('Success', 'Logged out successfully!', 'success');
        }
        
        // Show add task modal
        function showAddTaskModal() {
            // Clear form
            document.getElementById('addTaskForm').reset();
            document.getElementById('subtasksContainer').innerHTML = '';
            
            // Add initial subtask field
            addSubtaskField();
            
            // Populate category select
            updateCategorySelects();
            
            document.getElementById('addTaskModal').classList.add('active');
        }
        
        // Close add task modal
        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
        }
        
        // Add a subtask field to the add task form
        function addSubtaskField() {
            const subtasksContainer = document.getElementById('subtasksContainer');
            const subtaskItem = document.createElement('div');
            subtaskItem.className = 'subtask-item';
            
            subtaskItem.innerHTML = `
                <input type="text" class="subtask-input" placeholder="Enter subtask">
                <button type="button" class="subtask-remove">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            subtasksContainer.appendChild(subtaskItem);
            
            // Add event listener to remove button
            const removeBtn = subtaskItem.querySelector('.subtask-remove');
            removeBtn.addEventListener('click', function() {
                subtasksContainer.removeChild(subtaskItem);
            });
        }
        
        // Add a subtask field to the edit task form
        function addEditSubtaskField() {
            const subtasksContainer = document.getElementById('editSubtasksContainer');
            const subtaskItem = document.createElement('div');
            subtaskItem.className = 'subtask-item';
            
            subtaskItem.innerHTML = `
                <input type="text" class="subtask-input" placeholder="Enter subtask">
                <button type="button" class="subtask-remove">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            
            subtasksContainer.appendChild(subtaskItem);
            
            // Add event listener to remove button
            const removeBtn = subtaskItem.querySelector('.subtask-remove');
            removeBtn.addEventListener('click', function() {
                subtasksContainer.removeChild(subtaskItem);
            });
        }
        
        // Create a new task
        function createTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;
            const category = document.getElementById('taskCategory').value;
            const notes = document.getElementById('taskNotes').value;
            
            // Validate inputs
            if (!title || !description || !dueDate || !priority || !category) {
                showToast('Error', 'Please fill in all required fields', 'error');
                return;
            }
            
            // Get subtasks
            const subtaskElements = document.querySelectorAll('#subtasksContainer .subtask-input');
            const subtasks = [];
            
            subtaskElements.forEach(element => {
                if (element.value.trim()) {
                    subtasks.push({
                        id: generateId(),
                        title: element.value.trim(),
                        completed: false
                    });
                }
            });
            
            // Create new task
            const newTask = {
                id: generateId(),
                title,
                description,
                dueDate: new Date(dueDate).toISOString(),
                priority,
                category,
                completed: false,
                createdAt: new Date().toISOString(),
                subtasks,
                notes,
                timeSpent: 0
            };
            
            // Save action to history for undo
            saveToHistory();
            
            // Add task to list
            currentTasks.push(newTask);
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Close modal
            closeAddTaskModal();
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            showToast('Success', 'Task created successfully!', 'success');
            
            // Add notification
            addNotification(`New task created: ${title}`, 'success');
        }
        
        // Show the view task modal
        function viewTask(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            const viewTaskTitle = document.getElementById('viewTaskTitle');
            const viewTaskDetails = document.getElementById('viewTaskDetails');
            
            viewTaskTitle.textContent = task.title;
            
            // Calculate time spent in hours and minutes
            const hours = Math.floor(task.timeSpent / 3600);
            const minutes = Math.floor((task.timeSpent % 3600) / 60);
            const timeSpentText = hours > 0 ? 
                                  `${hours} hour${hours !== 1 ? 's' : ''} ${minutes} minute${minutes !== 1 ? 's' : ''}` : 
                                  `${minutes} minute${minutes !== 1 ? 's' : ''}`;
            
            // Prepare subtasks HTML
            let subtasksHTML = '';
            if (task.subtasks.length > 0) {
                subtasksHTML = '<div style="margin-top: 15px;"><h4 style="margin-bottom: 10px; color: var(--body-color);">Subtasks:</h4><ul>';
                
                task.subtasks.forEach(subtask => {
                    subtasksHTML += `
                        <li style="margin-bottom: 8px; display: flex; align-items: center;">
                            <div style="width: 18px; height: 18px; border-radius: 3px; border: 2px solid ${subtask.completed ? 'var(--success)' : 'var(--gray-400)'}; 
                                  background-color: ${subtask.completed ? 'var(--success)' : 'transparent'}; margin-right: 8px; 
                                  display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                ${subtask.completed ? '‚úì' : ''}
                            </div>
                            <span style="color: var(--body-color); ${subtask.completed ? 'text-decoration: line-through;' : ''}">${subtask.title}</span>
                        </li>
                    `;
                });
                
                subtasksHTML += '</ul></div>';
            }
            
            // Build details HTML
            const taskDetailsHTML = `
                <div style="border-left: 5px solid ${getTaskStatusColor(task)}; padding-left: 15px; margin-bottom: 20px;">
                    <p style="font-size: 1.1rem; color: var(--body-color);">${task.description}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Due Date</p>
                        <p style="margin: 0; color: ${isTaskExpired(task) ? 'var(--danger)' : 'var(--body-color)'};">
                            ${formatDateTime(task.dueDate)}
                        </p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Priority</p>
                        <p style="margin: 0;">
                            <span class="task-badge ${getPriorityClass(task.priority)}">${capitalizeFirstLetter(task.priority)}</span>
                        </p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Category</p>
                        <p style="margin: 0;">
                            <span class="task-badge badge-category">${task.category}</span>
                        </p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Status</p>
                        <p style="margin: 0;">
                            <span class="task-badge" style="background-color: ${task.completed ? 'var(--success)' : 'var(--warning)'}; color: ${task.completed ? 'white' : 'var(--dark)'};">
                                ${task.completed ? 'Completed' : 'Pending'}
                            </span>
                        </p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Created At</p>
                        <p style="margin: 0; color: var(--body-color);">${formatDateTime(task.createdAt)}</p>
                    </div>
                    <div>
                        <p style="margin: 5px 0; font-weight: 600; color: var(--gray-600);">Time Spent</p>
                        <p style="margin: 0; color: var(--body-color);">${timeSpentText}</p>
                    </div>
                </div>
                
                ${subtasksHTML}
                
                ${task.notes ? `
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--body-color);">Notes:</h4>
                        <p style="margin: 0; color: var(--body-color); background-color: var(--gray-100); padding: 15px; border-radius: var(--border-radius);">
                            ${task.notes}
                        </p>
                    </div>
                ` : ''}
            `;
            
            viewTaskDetails.innerHTML = taskDetailsHTML;
            
            document.getElementById('viewTaskModal').classList.add('active');
        }
        
        // Close view task modal
        function closeViewTaskModal() {
            document.getElementById('viewTaskModal').classList.remove('active');
        }
        
        // Show edit task modal
        function showEditTaskModal(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // Populate form with task data
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitle').value = task.title;
            document.getElementById('editTaskDescription').value = task.description;
            
            // Format date for flatpickr
            const dueDate = new Date(task.dueDate);
            const formattedDate = `${dueDate.getFullYear()}-${String(dueDate.getMonth() + 1).padStart(2, '0')}-${String(dueDate.getDate()).padStart(2, '0')} ${String(dueDate.getHours()).padStart(2, '0')}:${String(dueDate.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('editTaskDueDate')._flatpickr.setDate(formattedDate);
            document.getElementById('editTaskPriority').value = task.priority;
            
            // Populate category select
            updateCategorySelects();
            document.getElementById('editTaskCategory').value = task.category;
            
            document.getElementById('editTaskNotes').value = task.notes || '';
            
            // Populate subtasks
            const subtasksContainer = document.getElementById('editSubtasksContainer');
            subtasksContainer.innerHTML = '';
            
            if (task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const subtaskItem = document.createElement('div');
                    subtaskItem.className = 'subtask-item';
                    subtaskItem.dataset.id = subtask.id;
                    
                    subtaskItem.innerHTML = `
                        <input type="text" class="subtask-input" value="${subtask.title}" placeholder="Enter subtask">
                        <button type="button" class="subtask-remove">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    
                    subtasksContainer.appendChild(subtaskItem);
                    
                    // Add event listener to remove button
                    const removeBtn = subtaskItem.querySelector('.subtask-remove');
                    removeBtn.addEventListener('click', function() {
                        subtasksContainer.removeChild(subtaskItem);
                    });
                });
            } else {
                // Add one empty subtask field if there are no subtasks
                addEditSubtaskField();
            }
            
            document.getElementById('editTaskModal').classList.add('active');
        }
        
        // Close edit task modal
        function closeEditTaskModal() {
            document.getElementById('editTaskModal').classList.remove('active');
        }
        
        // Save edited task
        function saveEditedTask() {
            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value;
            const description = document.getElementById('editTaskDescription').value;
            const dueDate = document.getElementById('editTaskDueDate').value;
            const priority = document.getElementById('editTaskPriority').value;
            const category = document.getElementById('editTaskCategory').value;
            const notes = document.getElementById('editTaskNotes').value;
            
            // Validate inputs
            if (!title || !description || !dueDate || !priority || !category) {
                showToast('Error', 'Please fill in all required fields', 'error');
                return;
            }
            
            // Find task
            const taskIndex = currentTasks.findIndex(task => task.id === taskId);
            
            if (taskIndex === -1) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // Get subtasks
            const subtaskElements = document.querySelectorAll('#editSubtasksContainer .subtask-item');
            const subtasks = [];
            
            subtaskElements.forEach(element => {
                const input = element.querySelector('.subtask-input');
                if (input.value.trim()) {
                    // Use existing ID if available, otherwise generate a new one
                    const id = element.dataset.id || generateId();
                    
                    // Check if this subtask already exists to preserve its completed status
                    const existingSubtask = currentTasks[taskIndex].subtasks.find(s => s.id === id);
                    const completed = existingSubtask ? existingSubtask.completed : false;
                    
                    subtasks.push({
                        id,
                        title: input.value.trim(),
                        completed
                    });
                }
            });
            
            // Save action to history for undo
            saveToHistory();
            
            // Update task
            const updatedTask = {
                ...currentTasks[taskIndex],
                title,
                description,
                dueDate: new Date(dueDate).toISOString(),
                priority,
                category,
                subtasks,
                notes
            };
            
            currentTasks[taskIndex] = updatedTask;
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Close modal
            closeEditTaskModal();
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            showToast('Success', 'Task updated successfully!', 'success');
            
            // Add notification
            addNotification(`Task updated: ${title}`, 'info');
        }
        
        // Delete a task
        function deleteTask(taskId) {
            // Confirm deletion
            if (!window.confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            // Find task
            const taskIndex = currentTasks.findIndex(task => task.id === taskId);
            
            if (taskIndex === -1) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            const taskTitle = currentTasks[taskIndex].title;
            
            // Save action to history for undo
            saveToHistory();
            
            // Remove task
            currentTasks.splice(taskIndex, 1);
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            showToast('Success', 'Task deleted successfully!', 'success');
            
            // Add notification
            addNotification(`Task deleted: ${taskTitle}`, 'danger');
        }
        
        // Toggle task completion status
        function toggleTaskCompletion(taskId) {
            // Find task
            const taskIndex = currentTasks.findIndex(task => task.id === taskId);
            
            if (taskIndex === -1) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // Save action to history for undo
            saveToHistory();
            
            // Toggle completion status
            currentTasks[taskIndex].completed = !currentTasks[taskIndex].completed;
            
            // If task is now completed and the timer is running, stop it
            if (currentTasks[taskIndex].completed && activeTaskTimer && activeTaskTimer.taskId === taskId) {
                pauseTaskTimer(taskId);
            }
            
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            const status = currentTasks[taskIndex].completed ? 'completed' : 'marked as incomplete';
            showToast('Success', `Task ${status} successfully!`, 'success');
            
            // Add notification
            addNotification(`Task ${currentTasks[taskIndex].title} ${status}.`, 'info');
        }
        
        // Toggle task timer (play/pause)
        function toggleTaskTimer(taskId) {
            // If there's an active timer for another task, pause it first
            if (activeTaskTimer && activeTaskTimer.taskId !== taskId) {
                pauseTaskTimer(activeTaskTimer.taskId);
            }
            
            // Find task
            const task = currentTasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // If task is completed, show warning and don't start timer
            if (task.completed) {
                showToast('Warning', 'Cannot start timer for completed tasks', 'warning');
                return;
            }
            
            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            const playBtn = taskItem.querySelector('.task-btn-play');
            const pauseBtn = taskItem.querySelector('.task-btn-pause');
            
            // Check if timer is active for this task
            if (activeTaskTimer && activeTaskTimer.taskId === taskId) {
                // Pause timer
                pauseTaskTimer(taskId);
                
                // Swap buttons
                playBtn.style.display = 'flex';
                pauseBtn.style.display = 'none';
                
                // If global timer is running only for this task, pause it
                if (globalTimer.isRunning) {
                    pauseGlobalTimer();
                }
                
                // Show toast with time spent
                const hours = Math.floor(task.timeSpent / 3600);
                const minutes = Math.floor((task.timeSpent % 3600) / 60);
                const seconds = task.timeSpent % 60;
                
                const timeSpentText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                showToast('Timer Paused', `Time spent on this task: ${timeSpentText}`, 'info');
            } else {
                // Start timer
                startTaskTimer(taskId);
                
                // Swap buttons
                playBtn.style.display = 'none';
                pauseBtn.style.display = 'flex';
                
                // Start global timer if it's not already running
                if (!globalTimer.isRunning) {
                    startGlobalTimer();
                }
                
                showToast('Timer Started', `Tracking time for: ${task.title}`, 'success');
            }
        }
        
        // Start task timer
        function startTaskTimer(taskId) {
            // Create active timer
            activeTaskTimer = {
                taskId,
                startTime: Date.now(),
                interval: setInterval(() => {
                    // Find task
                    const taskIndex = currentTasks.findIndex(task => task.id === taskId);
                    
                    if (taskIndex === -1) {
                        clearInterval(activeTaskTimer.interval);
                        activeTaskTimer = null;
                        return;
                    }
                    
                    // Increment time spent
                    currentTasks[taskIndex].timeSpent++;
                    
                    // Update task element to show current time
                    updateTaskTimeDisplay(taskId);
                    
                    // Save to local storage every 10 seconds to avoid excessive writes
                    if (currentTasks[taskIndex].timeSpent % 10 === 0) {
                        localStorage.setItem('tasks', JSON.stringify(currentTasks));
                    }
                }, 1000)
            };
        }
        
        // Pause task timer
        function pauseTaskTimer(taskId) {
            if (activeTaskTimer && activeTaskTimer.taskId === taskId) {
                clearInterval(activeTaskTimer.interval);
                
                // Save final time to local storage
                localStorage.setItem('tasks', JSON.stringify(currentTasks));
                
                activeTaskTimer = null;
            }
        }
        
        // Update task time display in the task list
        function updateTaskTimeDisplay(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskItem) return;
            
            const timeDisplay = taskItem.querySelector('.time-spent');
            if (!timeDisplay) return;
            
            const hours = Math.floor(task.timeSpent / 3600);
            const minutes = Math.floor((task.timeSpent % 3600) / 60);
            const seconds = task.timeSpent % 60;
            
            timeDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Start global timer
        function startGlobalTimer() {
            if (globalTimer.isRunning) return;
            
            // Toggle play/pause buttons
            timerPlayBtn.style.display = 'none';
            timerPauseBtn.style.display = 'flex';
            
            globalTimer.isRunning = true;
            globalTimer.interval = setInterval(() => {
                globalTimer.seconds++;
                updateTimerDisplay();
                
                // Save to local storage every 30 seconds
                if (globalTimer.seconds % 30 === 0) {
                    localStorage.setItem('globalTimer', JSON.stringify(globalTimer));
                }
            }, 1000);
        }
        
        // Pause global timer
        function pauseGlobalTimer() {
            if (!globalTimer.isRunning) return;
            
            // Toggle play/pause buttons
            timerPlayBtn.style.display = 'flex';
            timerPauseBtn.style.display = 'none';
            
            globalTimer.isRunning = false;
            clearInterval(globalTimer.interval);
            
            // Save final time to local storage
            localStorage.setItem('globalTimer', JSON.stringify(globalTimer));
        }
        
        // Update timer display
        function updateTimerDisplay() {
            const hours = Math.floor(globalTimer.seconds / 3600);
            const minutes = Math.floor((globalTimer.seconds % 3600) / 60);
            const seconds = globalTimer.seconds % 60;
            
            timerDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        // Show export modal
        function showExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }
        
        // Close export modal
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }
        
        // Export tasks to file
        function exportTasks() {
            const format = document.getElementById('exportFormat').value;
            const fileName = `tasks_export_${formatDateForFile(new Date())}`;
            
            // Create exportable data (skip timeSpent for cleaner export)
            const exportData = currentTasks.map(task => {
                // Create a clean copy without the timeSpent property
                const { timeSpent, ...cleanTask } = task;
                return cleanTask;
            });
            
            try {
                if (format === 'json') {
                    // Export as JSON
                    const jsonContent = JSON.stringify(exportData, null, 2);
                    downloadFile(jsonContent, `${fileName}.json`, 'application/json');
                } else if (format === 'csv') {
                    // Export as CSV
                    const headers = ['Title', 'Description', 'Due Date', 'Priority', 'Category', 'Status', 'Created At'];
                    const csvContent = convertToCSV(exportData, headers);
                    downloadFile(csvContent, `${fileName}.csv`, 'text/csv');
                } else if (format === 'pdf') {
                    // Export as PDF using jsPDF
                    exportToPDF(exportData, fileName);
                } else if (format === 'excel') {
                    // Export as Excel using XLSX
                    exportToExcel(exportData, fileName);
                }
                
                closeExportModal();
                showToast('Success', `Tasks exported as ${format.toUpperCase()} successfully!`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error', `Failed to export: ${error.message}`, 'error');
            }
        }
        
        // Download file helper function
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // Convert data to CSV format
        function convertToCSV(data, headers) {
            let csv = headers.join(',') + '\n';
            
            data.forEach(task => {
                const row = [
                    `"${task.title.replace(/"/g, '""')}"`,
                    `"${task.description.replace(/"/g, '""')}"`,
                    formatDateTime(task.dueDate),
                    task.priority,
                    task.category,
                    task.completed ? 'Completed' : 'Pending',
                    formatDateTime(task.createdAt)
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }
        
        // Export to PDF using jsPDF
        function exportToPDF(data, fileName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set title
            doc.setFontSize(16);
            doc.text('Tasks Export', 15, 15);
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Exported on: ${formatDateTime(new Date().toISOString())}`, 15, 22);
            
            // Add tasks
            let y = 30;
            const pageWidth = doc.internal.pageSize.getWidth();
            
            data.forEach((task, index) => {
                // Check if we need a new page
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                
                // Task title and status
                const status = task.completed ? '(Completed)' : '(Pending)';
                doc.text(`${index + 1}. ${task.title} ${status}`, 15, y);
                y += 6;
                
                // Due date and priority
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Due: ${formatDateTime(task.dueDate)} | Priority: ${capitalizeFirstLetter(task.priority)} | Category: ${task.category}`, 20, y);
                y += 5;
                
                // Description
                doc.setTextColor(0, 0, 0);
                
                // Split long descriptions into multiple lines
                const description = doc.splitTextToSize(`Description: ${task.description}`, pageWidth - 40);
                doc.text(description, 20, y);
                y += description.length * 5 + 2;
                
                // Subtasks if any
                if (task.subtasks && task.subtasks.length > 0) {
                    doc.text('Subtasks:', 20, y);
                    y += 5;
                    
                    task.subtasks.forEach(subtask => {
                        const subtaskStatus = subtask.completed ? '‚úì' : '‚ñ°';
                        doc.text(`${subtaskStatus} ${subtask.title}`, 25, y);
                        y += 5;
                    });
                    
                    y += 2;
                }
                
                // Add spacing between tasks
                y += 5;
            });
            
            doc.save(`${fileName}.pdf`);
        }
        
        // Export to Excel using XLSX
        function exportToExcel(data, fileName) {
            // Prepare data for Excel
            const worksheetData = data.map(task => {
                return {
                    'Title': task.title,
                    'Description': task.description,
                    'Due Date': formatDateTime(task.dueDate),
                    'Priority': capitalizeFirstLetter(task.priority),
                    'Category': task.category,
                    'Status': task.completed ? 'Completed' : 'Pending',
                    'Created At': formatDateTime(task.createdAt),
                    'Subtasks': task.subtasks.map(st => `${st.completed ? '‚úì' : '‚ñ°'} ${st.title}`).join(', ')
                };
            });
            
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Convert JSON data to worksheet
            const ws = XLSX.utils.json_to_sheet(worksheetData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
            
            // Generate Excel file and trigger download
            XLSX.writeFile(wb, `${fileName}.xlsx`);
        }
        
        // Show import modal
        function showImportModal() {
            document.getElementById('importModal').classList.add('active');
        }
        
        // Close import modal
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importFile').value = '';
            document.getElementById('importUrl').value = '';
        }
        
        // Import tasks from file or URL
        function importTasks() {
            const fileInput = document.getElementById('importFile');
            const urlInput = document.getElementById('importUrl').value.trim();
            
            if (fileInput.files.length > 0) {
                // Import from file
                const file = fileInput.files[0];
                
                if (file.type !== 'application/json') {
                    showToast('Error', 'Only JSON files are supported for import', 'error');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const tasks = JSON.parse(e.target.result);
                        processImportedTasks(tasks);
                    } catch (error) {
                        showToast('Error', `Failed to parse JSON: ${error.message}`, 'error');
                    }
                };
                
                reader.readAsText(file);
            } else if (urlInput) {
                // Import from URL
                fetch(urlInput)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(tasks => {
                        processImportedTasks(tasks);
                    })
                    .catch(error => {
                        showToast('Error', `Failed to import from URL: ${error.message}`, 'error');
                    });
            } else {
                showToast('Error', 'Please select a file or enter a URL to import', 'error');
                return;
            }
        }
        
        // Process imported tasks
        function processImportedTasks(importedTasks) {
            if (!Array.isArray(importedTasks)) {
                showToast('Error', 'Invalid import data: expected an array of tasks', 'error');
                return;
            }
            
            try {
                // Validate tasks
                const validTasks = importedTasks.filter(task => {
                    return task && 
                           typeof task === 'object' && 
                           task.title && 
                           task.description && 
                           task.dueDate && 
                           task.priority && 
                           task.category;
                });
                
                if (validTasks.length === 0) {
                    showToast('Error', 'No valid tasks found in the imported data', 'error');
                    return;
                }
                
                // Save action to history for undo
                saveToHistory();
                
                // Process each task
                const newTasks = validTasks.map(task => {
                    // Generate new ID to avoid conflicts
                    const newId = generateId();
                    
                    // Process subtasks
                    const subtasks = Array.isArray(task.subtasks) 
                        ? task.subtasks.map(subtask => ({
                            id: generateId(),
                            title: subtask.title || '',
                            completed: !!subtask.completed
                        }))
                        : [];
                    
                    // Return processed task
                    return {
                        id: newId,
                        title: task.title,
                        description: task.description,
                        dueDate: task.dueDate,
                        priority: task.priority,
                        category: task.category,
                        completed: !!task.completed,
                        createdAt: task.createdAt || new Date().toISOString(),
                        subtasks: subtasks,
                        notes: task.notes || '',
                        timeSpent: task.timeSpent || 0
                    };
                });
                
                // Add tasks to current tasks
                currentTasks = [...currentTasks, ...newTasks];
                localStorage.setItem('tasks', JSON.stringify(currentTasks));
                
                // Close modal
                closeImportModal();
                
                // Render tasks and update counts
                renderAllTasks();
                updateTaskCounts();
                updateInsights();
                renderExpiredAndWarningTasks();
                updateCharts();
                
                // Show success toast
                showToast('Success', `Imported ${newTasks.length} tasks successfully!`, 'success');
                
                // Add notification
                addNotification(`Imported ${newTasks.length} tasks.`, 'info');
            } catch (error) {
                showToast('Error', `Error processing imported tasks: ${error.message}`, 'error');
            }
        }
        
        // Show categories modal
        function showCategoriesModal() {
            // Populate categories list
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            taskCategories.forEach(category => {
                const categoryItem = document.createElement('li');
                categoryItem.style.display = 'flex';
                categoryItem.style.justifyContent = 'space-between';
                categoryItem.style.alignItems = 'center';
                categoryItem.style.padding = '10px';
                categoryItem.style.marginBottom = '10px';
                categoryItem.style.backgroundColor = 'var(--gray-100)';
                categoryItem.style.borderRadius = 'var(--border-radius)';
                
                categoryItem.innerHTML = `
                    <span style="color: var(--body-color);">${category}</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="edit-category-btn" data-category="${category}" style="background: none; border: none; color: var(--warning); cursor: pointer;">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="delete-category-btn" data-category="${category}" style="background: none; border: none; color: var(--danger); cursor: pointer;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                
                categoriesList.appendChild(categoryItem);
                
                // Add event listeners
                const editBtn = categoryItem.querySelector('.edit-category-btn');
                const deleteBtn = categoryItem.querySelector('.delete-category-btn');
                
                editBtn.addEventListener('click', function() {
                    const oldCategory = this.dataset.category;
                    const newCategory = prompt('Enter new category name:', oldCategory);
                    
                    if (newCategory && newCategory !== oldCategory) {
                        editCategory(oldCategory, newCategory);
                    }
                });
                
                deleteBtn.addEventListener('click', function() {
                    const category = this.dataset.category;
                    
                    // Check if category is in use
                    const inUse = currentTasks.some(task => task.category === category);
                    
                    if (inUse) {
                        showToast('Error', `Cannot delete category "${category}" because it is in use by one or more tasks`, 'error');
                        return;
                    }
                    
                    if (confirm(`Are you sure you want to delete category "${category}"?`)) {
                        deleteCategory(category);
                    }
                });
            });
            
            document.getElementById('categoriesModal').classList.add('active');
        }
        
        // Close categories modal
        function closeCategoriesModal() {
            document.getElementById('categoriesModal').classList.remove('active');
        }
        
        // Add a new category
        function addCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            
            if (!newCategory) {
                showToast('Error', 'Please enter a category name', 'error');
                return;
            }
            
            if (taskCategories.includes(newCategory)) {
                showToast('Error', 'Category already exists', 'error');
                return;
            }
            
            // Add category
            taskCategories.push(newCategory);
            localStorage.setItem('taskCategories', JSON.stringify(taskCategories));
            
            // Update category selects
            updateCategorySelects();
            
            // Refresh categories list
            showCategoriesModal();
            
            // Clear input
            document.getElementById('newCategory').value = '';
            
            // Show success toast
            showToast('Success', `Category "${newCategory}" added successfully!`, 'success');
        }
        
        // Edit a category
        function editCategory(oldCategory, newCategory) {
            if (taskCategories.includes(newCategory)) {
                showToast('Error', 'Category already exists', 'error');
                return;
            }
            
            // Update category in taskCategories
            const categoryIndex = taskCategories.indexOf(oldCategory);
            if (categoryIndex !== -1) {
                taskCategories[categoryIndex] = newCategory;
                localStorage.setItem('taskCategories', JSON.stringify(taskCategories));
            }
            
            // Update category in tasks
            currentTasks.forEach(task => {
                if (task.category === oldCategory) {
                    task.category = newCategory;
                }
            });
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Update category selects
            updateCategorySelects();
            
            // Refresh categories list
            showCategoriesModal();
            
            // Refresh task list
            renderAllTasks();
            
            // Show success toast
            showToast('Success', `Category "${oldCategory}" renamed to "${newCategory}" successfully!`, 'success');
        }
        
        // Delete a category
        function deleteCategory(category) {
            // Check if category exists
            const categoryIndex = taskCategories.indexOf(category);
            if (categoryIndex === -1) {
                showToast('Error', 'Category not found', 'error');
                return;
            }
            
            // Remove category
            taskCategories.splice(categoryIndex, 1);
            localStorage.setItem('taskCategories', JSON.stringify(taskCategories));
            
            // Update category selects
            updateCategorySelects();
            
            // Refresh categories list
            showCategoriesModal();
            
            // Show success toast
            showToast('Success', `Category "${category}" deleted successfully!`, 'success');
        }
        
        // Update category selects
        function updateCategorySelects() {
            const taskCategory = document.getElementById('taskCategory');
            const editTaskCategory = document.getElementById('editTaskCategory');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Clear existing options
            taskCategory.innerHTML = '';
            editTaskCategory.innerHTML = '';
            
            // Keep existing filter options
            const currentFilterValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="all">All</option>';
            
            // Add category options
            taskCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                
                taskCategory.appendChild(option.cloneNode(true));
                editTaskCategory.appendChild(option.cloneNode(true));
                categoryFilter.appendChild(option.cloneNode(true));
            });
            
            // Restore filter selection if possible
            if (currentFilterValue && categoryFilter.querySelector(`option[value="${currentFilterValue}"]`)) {
                categoryFilter.value = currentFilterValue;
            }
        }
        
        // Complete selected tasks
        function completeSelectedTasks() {
            if (selectedTasks.size === 0) return;
            
            // Save action to history for undo
            saveToHistory();
            
            // Mark all selected tasks as complete
            currentTasks.forEach(task => {
                if (selectedTasks.has(task.id)) {
                    task.completed = true;
                    
                    // If task timer is running, stop it
                    if (activeTaskTimer && activeTaskTimer.taskId === task.id) {
                        pauseTaskTimer(task.id);
                    }
                }
            });
            
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Clear selection
            selectedTasks.clear();
            
            // Hide multi-actions bar
            multiActions.classList.remove('active');
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            showToast('Success', 'Selected tasks marked as complete!', 'success');
            
            // Add notification
            addNotification(`Multiple tasks marked as complete.`, 'success');
        }
        
        // Delete selected tasks
        function deleteSelectedTasks() {
            if (selectedTasks.size === 0) return;
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete ${selectedTasks.size} selected tasks?`)) {
                return;
            }
            
            // Save action to history for undo
            saveToHistory();
            
            // Loop through all tasks and keep those that aren't selected
            currentTasks = currentTasks.filter(task => {
                // If task is being deleted and its timer is running, stop it
                if (selectedTasks.has(task.id) && activeTaskTimer && activeTaskTimer.taskId === task.id) {
                    pauseTaskTimer(task.id);
                }
                
                return !selectedTasks.has(task.id);
            });
            
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Clear selection
            selectedTasks.clear();
            
            // Hide multi-actions bar
            multiActions.classList.remove('active');
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Show success toast
            showToast('Success', 'Selected tasks deleted!', 'success');
            
            // Add notification
            addNotification(`Multiple tasks deleted.`, 'danger');
        }
        
        // Cancel task selection
        function cancelSelection() {
            selectedTasks.clear();
            multiActions.classList.remove('active');
            renderAllTasks();
        }
        
        // Save current state to history for undo/redo
        function saveToHistory() {
            // Add current state to past
            taskHistory.past.push(JSON.stringify(currentTasks));
            
            // Clear future since we've created a new branch
            taskHistory.future = [];
            
            // Limit history size to 20 states
            if (taskHistory.past.length > 20) {
                taskHistory.past.shift();
            }
            
            // Update undo/redo button states
            updateHistoryButtons();
        }
        
        // Undo action
        function undoAction() {
            if (taskHistory.past.length === 0) return;
            
            // Save current state to future
            taskHistory.future.push(JSON.stringify(currentTasks));
            
            // Get previous state
            const previousState = taskHistory.past.pop();
            
            // Apply previous state
            currentTasks = JSON.parse(previousState);
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Update undo/redo button states
            updateHistoryButtons();
            
            // Show success toast
            showToast('Success', 'Action undone!', 'info');
        }
        
        // Redo action
        function redoAction() {
            if (taskHistory.future.length === 0) return;
            
            // Save current state to past
            taskHistory.past.push(JSON.stringify(currentTasks));
            
            // Get next state
            const nextState = taskHistory.future.pop();
            
            // Apply next state
            currentTasks = JSON.parse(nextState);
            localStorage.setItem('tasks', JSON.stringify(currentTasks));
            
            // Render tasks and update counts
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            updateCharts();
            
            // Update undo/redo button states
            updateHistoryButtons();
            
            // Show success toast
            showToast('Success', 'Action redone!', 'info');
        }
        
        // Update undo/redo button states
        function updateHistoryButtons() {
            undoBtn.disabled = taskHistory.past.length === 0;
            redoBtn.disabled = taskHistory.future.length === 0;
            
            undoBtn.style.opacity = undoBtn.disabled ? 0.5 : 1;
            redoBtn.style.opacity = redoBtn.disabled ? 0.5 : 1;
        }
        
        // Switch to list view
        function switchToListView() {
            listViewBtn.classList.add('active');
            graphViewBtn.classList.remove('active');
            taskListContainer.classList.remove('hidden');
            graphContainer.classList.remove('active');
        }
        
        // Switch to graph view
        function switchToGraphView() {
            listViewBtn.classList.remove('active');
            graphViewBtn.classList.add('active');
            taskListContainer.classList.add('hidden');
            graphContainer.classList.add('active');
            
            // Initialize or update charts
            initializeCharts();
        }
        
        // Initialize charts
        function initializeCharts() {
            // Destroy existing charts if they exist
            if (tasksChartInstance) {
                tasksChartInstance.destroy();
            }
            
            if (taskDistributionChartInstance) {
                taskDistributionChartInstance.destroy();
            }
            
            // Create Tasks Over Time chart
            createTasksOverTimeChart();
            
            // Create Task Distribution chart
            createTaskDistributionChart();
        }
        
        // Create Tasks Over Time chart
        function createTasksOverTimeChart() {
            const ctx = tasksChart.getContext('2d');
            
            // Get the last 7 days data
            const dates = [];
            const completedData = [];
            const pendingData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = subtractDays(new Date(), i);
                const dateString = formatDate(date.toISOString());
                dates.push(dateString);
                
                const completedCount = currentTasks.filter(task => {
                    return task.completed && isSameDay(new Date(task.dueDate), date);
                }).length;
                
                const pendingCount = currentTasks.filter(task => {
                    return !task.completed && isSameDay(new Date(task.dueDate), date);
                }).length;
                
                completedData.push(completedCount);
                pendingData.push(pendingCount);
            }
            
            // Create chart
            tasksChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Completed Tasks',
                            data: completedData,
                            backgroundColor: 'rgba(40, 167, 69, 0.6)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending Tasks',
                            data: pendingData,
                            backgroundColor: 'rgba(255, 193, 7, 0.6)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuad'
                    }
                }
            });
        }
        
        // Create Task Distribution chart
        function createTaskDistributionChart() {
            const ctx = taskDistributionChart.getContext('2d');
            
            // Count tasks by status
            const completedTasks = currentTasks.filter(task => task.completed).length;
            const pendingTasks = currentTasks.filter(task => !task.completed).length;
            
            // Create chart
            taskDistributionChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [
                        {
                            data: [completedTasks, pendingTasks],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.6)',
                                'rgba(255, 193, 7, 0.6)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(255, 193, 7, 1)'
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuad'
                    }
                }
            });
        }
        
        // Update charts with current data
        function updateCharts() {
            // Only update if charts are visible
            if (graphContainer.classList.contains('active')) {
                initializeCharts();
            }
        }
        
        // Handle due date filter
        function handleDueDateFilter() {
            const filterValue = dueDateFilter.value;
            
            if (filterValue === 'custom') {
                showDateRangeModal();
            } else {
                // Reset date range
                dateRangeFilter.start = null;
                dateRangeFilter.end = null;
                
                // Apply regular filter
                applyFilters();
            }
        }
        
        // Show date range modal
        function showDateRangeModal() {
            document.getElementById('dateRangeModal').classList.add('active');
        }
        
        // Close date range modal
        function closeDateRangeModal() {
            document.getElementById('dateRangeModal').classList.remove('active');
            
            // If no date range was selected, reset filter
            if (!dateRangeFilter.start || !dateRangeFilter.end) {
                dueDateFilter.value = 'all';
            }
        }
        
        // Apply date range
        function applyDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showToast('Error', 'Please select both start and end dates', 'error');
                return;
            }
            
            // Set date range filter
            dateRangeFilter.start = new Date(startDate);
            dateRangeFilter.end = new Date(endDate);
            
            // Close modal
            closeDateRangeModal();
            
            // Apply filters
            applyFilters();
        }
        
        // Apply all filters to tasks
        function applyFilters() {
            const statusValue = statusFilter.value;
            const categoryValue = categoryFilter.value;
            const priorityValue = priorityFilter.value;
            const dueDateValue = dueDateFilter.value;
            const sortValue = sortFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            
            // Filter tasks
            let filteredTasks = currentTasks.filter(task => {
                // Status filter
                if (statusValue === 'active' && task.completed) return false;
                if (statusValue === 'completed' && !task.completed) return false;
                
                // Category filter
                if (categoryValue !== 'all' && task.category !== categoryValue) return false;
                
                // Priority filter
                if (priorityValue !== 'all' && task.priority !== priorityValue) return false;
                
                // Due date filter
                if (dueDateValue !== 'all') {
                    const dueDate = new Date(task.dueDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    if (dueDateValue === 'today') {
                        // Due today
                        if (!isSameDay(dueDate, today)) return false;
                    } else if (dueDateValue === 'week') {
                        // Due this week
                        const weekEnd = new Date(today);
                        weekEnd.setDate(today.getDate() + 7);
                        
                        if (dueDate < today || dueDate > weekEnd) return false;
                    } else if (dueDateValue === 'month') {
                        // Due this month
                        const monthEnd = new Date(today);
                        monthEnd.setMonth(today.getMonth() + 1);
                        
                        if (dueDate < today || dueDate > monthEnd) return false;
                    } else if (dueDateValue === 'custom' && dateRangeFilter.start && dateRangeFilter.end) {
                        // Due in custom date range
                        if (dueDate < dateRangeFilter.start || dueDate > dateRangeFilter.end) return false;
                    }
                }
                
                // Search filter
                if (searchValue) {
                    const title = task.title.toLowerCase();
                    const description = task.description.toLowerCase();
                    return title.includes(searchValue) || description.includes(searchValue);
                }
                
                return true;
            });
            
            // Sort tasks
            filteredTasks = sortTasks(filteredTasks, sortValue);
            
            // Render filtered tasks
            renderTasks(filteredTasks);
        }
        
        // Sort tasks
        function sortTasks(tasks, sortValue) {
            const [field, direction] = sortValue.split('-');
            
            return tasks.slice().sort((a, b) => {
                let comparison = 0;
                
                if (field === 'name') {
                    comparison = a.title.localeCompare(b.title);
                } else if (field === 'dueDate') {
                    comparison = new Date(a.dueDate) - new Date(b.dueDate);
                } else if (field === 'priority') {
                    const priorityValues = { high: 3, medium: 2, low: 1 };
                    comparison = priorityValues[a.priority] - priorityValues[b.priority];
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
        }
        
        // Render all tasks with current filters
        function renderAllTasks() {
            applyFilters();
        }
        
        // Render tasks to the task list
        function renderTasks(tasks) {
            taskList.innerHTML = '';
            
            if (tasks.length === 0) {
                taskList.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--gray-500);">No tasks found matching your filters.</div>`;
                return;
            }
            
            tasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = `task-item ${task.completed ? 'task-completed' : ''}`;
                taskItem.dataset.taskId = task.id;
                
                // Add appropriate status class
                if (isTaskExpired(task)) {
                    taskItem.classList.add('task-expired');
                } else if (isTaskDueSoon(task)) {
                    taskItem.classList.add('task-warning');
                } else {
                    taskItem.classList.add('task-good');
                }
                
                // Calculate time spent
                const hours = Math.floor(task.timeSpent / 3600);
                const minutes = Math.floor((task.timeSpent % 3600) / 60);
                const seconds = task.timeSpent % 60;
                const timeSpent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // Check if task is selected
                const isSelected = selectedTasks.has(task.id);
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-select" ${isSelected ? 'checked' : ''}>
                    <div class="task-checkbox"></div>
                    <div class="task-content">
                        <div class="task-header">
                            <h3 class="task-name">${task.title}</h3>
                            <div class="task-badges">
                                <span class="task-badge ${getPriorityClass(task.priority)}">${capitalizeFirstLetter(task.priority)}</span>
                                <span class="task-badge badge-category">${task.category}</span>
                                <span class="task-badge badge-date">${formatDate(task.dueDate)}</span>
                                <span class="time-spent">${timeSpent}</span>
                            </div>
                        </div>
                        <p class="task-description">${task.description}</p>
                        ${task.subtasks.length > 0 ? `
                            <div style="font-size: 0.8rem; color: var(--gray-600); margin-top: 5px;">
                                <span>${task.subtasks.filter(st => st.completed).length}/${task.subtasks.length} subtasks</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="task-actions-container">
                        <button class="task-btn task-btn-view" title="View Task">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="task-btn task-btn-edit" title="Edit Task">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="task-btn task-btn-delete" title="Delete Task">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button class="task-btn task-btn-play" title="Start Timer" style="${activeTaskTimer && activeTaskTimer.taskId === task.id ? 'display: none;' : ''}">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <button class="task-btn task-btn-pause" title="Pause Timer" style="${activeTaskTimer && activeTaskTimer.taskId === task.id ? '' : 'display: none;'}">
                            <i class="bi bi-pause-fill"></i>
                        </button>
                        <button class="task-btn task-btn-share" title="Share Task">
                            <i class="bi bi-share"></i>
                        </button>
                    </div>
                `;
                
                taskList.appendChild(taskItem);
                
                // Add event listeners
                const taskCheckbox = taskItem.querySelector('.task-checkbox');
                const taskSelect = taskItem.querySelector('.task-select');
                const viewBtn = taskItem.querySelector('.task-btn-view');
                const editBtn = taskItem.querySelector('.task-btn-edit');
                const deleteBtn = taskItem.querySelector('.task-btn-delete');
                const playBtn = taskItem.querySelector('.task-btn-play');
                const pauseBtn = taskItem.querySelector('.task-btn-pause');
                const shareBtn = taskItem.querySelector('.task-btn-share');
                
                taskCheckbox.addEventListener('click', () => toggleTaskCompletion(task.id));
                
                taskSelect.addEventListener('change', function() {
                    if (this.checked) {
                        selectedTasks.add(task.id);
                    } else {
                        selectedTasks.delete(task.id);
                    }
                    
                    updateMultiActionsBar();
                });
                
                viewBtn.addEventListener('click', () => viewTask(task.id));
                editBtn.addEventListener('click', () => showEditTaskModal(task.id));
                deleteBtn.addEventListener('click', () => deleteTask(task.id));
                playBtn.addEventListener('click', () => toggleTaskTimer(task.id));
                pauseBtn.addEventListener('click', () => toggleTaskTimer(task.id));
                shareBtn.addEventListener('click', () => showShareTaskModal(task.id));
                
                // Make task draggable
                taskItem.draggable = true;
                
                taskItem.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', task.id);
                    this.classList.add('dragging');
                });
                
                taskItem.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });
            
            // Add drag and drop listeners to container
            setupDragAndDrop();
        }
        
        // Setup drag and drop functionality
        function setupDragAndDrop() {
            taskList.addEventListener('dragover', function(e) {
                e.preventDefault();
                const draggingItem = document.querySelector('.dragging');
                if (!draggingItem) return;
                
                const closestTask = getClosestTaskElement(e.clientY);
                if (closestTask) {
                    taskList.insertBefore(draggingItem, closestTask);
                } else {
                    taskList.appendChild(draggingItem);
                }
            });
            
            taskList.addEventListener('drop', function(e) {
                e.preventDefault();
                const draggedTaskId = e.dataTransfer.getData('text/plain');
                const draggedItem = document.querySelector(`[data-task-id="${draggedTaskId}"]`);
                if (!draggedItem) return;
                
                // Reorder tasks array based on new DOM order
                reorderTasksArray();
                
                // Save to local storage
                localStorage.setItem('tasks', JSON.stringify(currentTasks));
                
                // Add notification
                addNotification('Task order updated.', 'info');
            });
        }
        
        // Get closest task element to the cursor
        function getClosestTaskElement(y) {
            const taskElements = [...taskList.querySelectorAll('.task-item:not(.dragging)')];
            
            return taskElements.reduce((closest, task) => {
                const box = task.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: task };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Reorder tasks array based on DOM order
        function reorderTasksArray() {
            const taskItems = [...taskList.querySelectorAll('.task-item')];
            const newTasksOrder = [];
            
            taskItems.forEach(item => {
                const taskId = item.dataset.taskId;
                const task = currentTasks.find(t => t.id === taskId);
                if (task) {
                    newTasksOrder.push(task);
                }
            });
            
            // Add any tasks that aren't in the DOM (hidden by filters)
            currentTasks.forEach(task => {
                if (!newTasksOrder.find(t => t.id === task.id)) {
                    newTasksOrder.push(task);
                }
            });
            
            currentTasks = newTasksOrder;
        }
        
        // Update multi-actions bar based on selected tasks
        function updateMultiActionsBar() {
            selectedCount.textContent = selectedTasks.size;
            
            if (selectedTasks.size > 0) {
                multiActions.classList.add('active');
            } else {
                multiActions.classList.remove('active');
            }
        }
        
        // Show share task modal
        function showShareTaskModal(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // Populate users dropdown
            const shareTaskWith = document.getElementById('shareTaskWith');
            shareTaskWith.innerHTML = '';
            
            allUsers.forEach(user => {
                if (user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.firstName} ${user.lastName} (${user.email})`;
                    shareTaskWith.appendChild(option);
                }
            });
            
            // Store task ID for sharing
            shareTaskWith.dataset.taskId = taskId;
            
            // Clear message
            document.getElementById('shareMessage').value = '';
            
            document.getElementById('shareTaskModal').classList.add('active');
        }
        
        // Close share task modal
        function closeShareTaskModal() {
            document.getElementById('shareTaskModal').classList.remove('active');
        }
        
        // Share task with selected users
        function shareTask() {
            const shareTaskWith = document.getElementById('shareTaskWith');
            const taskId = shareTaskWith.dataset.taskId;
            const selectedOptions = [...shareTaskWith.selectedOptions].map(option => option.value);
            const message = document.getElementById('shareMessage').value.trim();
            
            if (selectedOptions.length === 0) {
                showToast('Error', 'Please select at least one user to share with', 'error');
                return;
            }
            
            const task = currentTasks.find(t => t.id === taskId);
            
            if (!task) {
                showToast('Error', 'Task not found', 'error');
                return;
            }
            
            // In a real app, this would send the task to the selected users
            // For this demo, we'll just show a success message
            
            // Close modal
            closeShareTaskModal();
            
            // Show success toast
            const userCount = selectedOptions.length;
            showToast('Success', `Task shared with ${userCount} user${userCount !== 1 ? 's' : ''}!`, 'success');
            
            // Add notification
            addNotification(`You shared task "${task.title}" with ${userCount} user${userCount !== 1 ? 's' : ''}.`, 'info');
            
            // Create "received" notifications for the shared users
            allUsers.forEach(user => {
                if (selectedOptions.includes(user.id)) {
                    // In a real app, these notifications would be sent to the users
                    // For this demo, we'll just log them
                    console.log(`Notification to ${user.firstName}: ${currentUser.firstName} shared a task with you: "${task.title}"`);
                }
            });
        }
        
        // Update task counts
        function updateTaskCounts() {
            const total = currentTasks.length;
            const completed = currentTasks.filter(task => task.completed).length;
            const pending = total - completed;
            
            totalTasksCount.textContent = total;
            completedTasksCount.textContent = completed;
            pendingTasksCount.textContent = pending;
        }
        
        // Update insights
        function updateInsights() {
            // Completion rate
            const total = currentTasks.length;
            const completed = currentTasks.filter(task => task.completed).length;
            const completionRateValue = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            completionRate.textContent = `${completionRateValue}%`;
            
            // Average time spent
            const totalTimeSpent = currentTasks.reduce((total, task) => total + task.timeSpent, 0);
            const avgTimeValue = total > 0 ? Math.round(totalTimeSpent / total) : 0;
            
            const hours = Math.floor(avgTimeValue / 3600);
            const minutes = Math.floor((avgTimeValue % 3600) / 60);
            
            avgTimeSpent.textContent = `${hours}h ${minutes}m`;
            
            // Most productive day
            const dayTasks = [0, 0, 0, 0, 0, 0, 0]; // Sun, Mon, Tue, Wed, Thu, Fri, Sat
            
            currentTasks.forEach(task => {
                if (task.completed) {
                    const dayOfWeek = new Date(task.dueDate).getDay();
                    dayTasks[dayOfWeek]++;
                }
            });
            
            const mostProductiveDayIndex = dayTasks.indexOf(Math.max(...dayTasks));
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            productiveDay.textContent = dayTasks[mostProductiveDayIndex] > 0 ? days[mostProductiveDayIndex] : '-';
            
            // Overdue rate
            const overdue = currentTasks.filter(task => isTaskExpired(task) && !task.completed).length;
            const overdueRateValue = total > 0 ? Math.round((overdue / total) * 100) : 0;
            
            overdueRate.textContent = `${overdueRateValue}%`;
        }
        
        // Render expired and warning tasks
        function renderExpiredAndWarningTasks() {
            // Expired tasks
            const expiredTasks = currentTasks.filter(task => 
                isTaskExpired(task) && !task.completed
            );
            
            expiredTasksList.innerHTML = '';
            
            if (expiredTasks.length === 0) {
                expiredTasksList.innerHTML = `<p style="color: var(--gray-500); text-align: center; padding: 10px;">No expired tasks.</p>`;
            } else {
                expiredTasks.forEach(task => {
                    const taskItem = document.createElement('li');
                    taskItem.className = 'expired-task-item';
                    
                    taskItem.innerHTML = `
                        <span class="expired-task-name">${task.title}</span>
                        <span class="expired-task-date">Due: ${formatDate(task.dueDate)}</span>
                    `;
                    
                    expiredTasksList.appendChild(taskItem);
                    
                    // Add click event to view task
                    taskItem.addEventListener('click', () => viewTask(task.id));
                });
            }
            
            // Warning tasks (due within 48 hours)
            const warningTasks = currentTasks.filter(task => 
                isTaskDueSoon(task) && !isTaskExpired(task) && !task.completed
            );
            
            warningTasksList.innerHTML = '';
            
            if (warningTasks.length === 0) {
                warningTasksList.innerHTML = `<p style="color: var(--gray-500); text-align: center; padding: 10px;">No tasks due soon.</p>`;
            } else {
                warningTasks.forEach(task => {
                    const taskItem = document.createElement('li');
                    taskItem.className = 'warning-task-item';
                    
                    taskItem.innerHTML = `
                        <span class="warning-task-name">${task.title}</span>
                        <span class="warning-task-date">Due: ${formatDate(task.dueDate)}</span>
                    `;
                    
                    warningTasksList.appendChild(taskItem);
                    
                    // Add click event to view task
                    taskItem.addEventListener('click', () => viewTask(task.id));
                });
            }
        }
        
        // Render notifications
        function renderNotifications() {
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = `<p style="color: var(--gray-500); text-align: center; padding: 10px;">No notifications.</p>`;
                return;
            }
            
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? 'read' : ''}`;
                notificationItem.dataset.id = notification.id;
                
                notificationItem.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-time">${formatRelativeTime(notification.time)}</div>
                        <div class="notification-text">${notification.message}</div>
                    </div>
                    <div class="notification-read"></div>
                `;
                
                notificationsList.appendChild(notificationItem);
                
                // Add click event to mark as read
                notificationItem.addEventListener('click', function() {
                    markNotificationAsRead(notification.id);
                });
            });
            
            // Update badge count
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount;
            
            // Hide badge if no unread notifications
            if (unreadCount === 0) {
                notificationBadge.style.display = 'none';
            } else {
                notificationBadge.style.display = 'flex';
            }
        }
        
        // Add a notification
        function addNotification(message, type) {
            const notification = {
                id: generateId(),
                message,
                type,
                time: new Date().toISOString(),
                read: false
            };
            
            notifications.unshift(notification);
            
            // Limit to 20 notifications
            if (notifications.length > 20) {
                notifications.pop();
            }
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update badge count
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = 'flex';
            
            // Render notifications if dropdown is open
            if (notificationsDropdown.classList.contains('active')) {
                renderNotifications();
            }
        }
        
        // Mark notification as read
        function markNotificationAsRead(id) {
            const notificationIndex = notifications.findIndex(n => n.id === id);
            
            if (notificationIndex !== -1) {
                notifications[notificationIndex].read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                
                // Update UI
                renderNotifications();
            }
        }
        
        // Mark all notifications as read
        function markAllNotificationsAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            
            localStorage.setItem('notifications', JSON.stringify(notifications));
            
            // Update UI
            renderNotifications();
        }
        
        // Show a toast notification
        function showToast(title, message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = '';
            if (type === 'success') icon = 'bi-check-circle-fill';
            else if (type === 'error') icon = 'bi-exclamation-circle-fill';
            else if (type === 'warning') icon = 'bi-exclamation-triangle-fill';
            else icon = 'bi-info-circle-fill';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="bi ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 5 seconds
            setTimeout(() => {
                toast.addEventListener('animationend', () => {
                    toastContainer.removeChild(toast);
                });
            }, 5000);
        }
        
        // Show dashboard view
        function showDashboard() {
            authPage.style.display = 'none';
            dashboardPage.style.display = 'block';
            dashboardView.classList.add('active');
            usersView.classList.remove('active');
            
            renderAllTasks();
            updateTaskCounts();
            updateInsights();
            renderExpiredAndWarningTasks();
            renderNotifications();
            
            // If graph view is active, initialize charts
            if (graphContainer.classList.contains('active')) {
                initializeCharts();
            }
        }
        
        // Update profile display
        function updateProfileDisplay() {
            if (!currentUser) return;
            
            profileImage.src = currentUser.profilePicture;
        }
        
        /* Utility Functions */
        
        // Generate a unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Format date (YYYY-MM-DD)
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        
        // Format date for file names (YYYYMMDD_HHMMSS)
        function formatDateForFile(date) {
            return `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}_${String(date.getHours()).padStart(2, '0')}${String(date.getMinutes()).padStart(2, '0')}${String(date.getSeconds()).padStart(2, '0')}`;
        }
        
        // Format date and time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return `${formatDate(dateString)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
        
        // Format relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffSec < 60) return 'Just now';
            if (diffMin < 60) return `${diffMin}m ago`;
            if (diffHour < 24) return `${diffHour}h ago`;
            if (diffDay < 30) return `${diffDay}d ago`;
            
            return formatDate(dateString);
        }
        
        // Add days to a date
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }
        
        // Add hours to a date
        function addHours(date, hours) {
            const result = new Date(date);
            result.setHours(result.getHours() + hours);
            return result;
        }
        
        // Subtract days from a date
        function subtractDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() - days);
            return result;
        }
        
        // Subtract hours from a date
        function subtractHours(date, hours) {
            const result = new Date(date);
            result.setHours(result.getHours() - hours);
            return result;
        }
        
        // Check if a task is expired
        function isTaskExpired(task) {
            const dueDate = new Date(task.dueDate);
            const now = new Date();
            return dueDate < now && !task.completed;
        }
        
        // Check if a task is due soon (within 48 hours)
        function isTaskDueSoon(task) {
            const dueDate = new Date(task.dueDate);
            const now = new Date();
            const within48Hours = new Date(now);
            within48Hours.setHours(now.getHours() + 48);
            
            return dueDate > now && dueDate <= within48Hours && !task.completed;
        }
        
        // Check if a date is within 48 hours
        function isWithin48Hours(date1, date2) {
            const diffMs = Math.abs(date1 - date2);
            const diffHours = diffMs / (1000 * 60 * 60);
            return diffHours <= 48;
        }
        
        // Check if two dates are the same day
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // Get priority class
        function getPriorityClass(priority) {
            if (priority === 'high') return 'badge-priority-high';
            if (priority === 'medium') return 'badge-priority-medium';
            return 'badge-priority-low';
        }
        
        // Get task status color
        function getTaskStatusColor(task) {
            if (isTaskExpired(task)) return 'var(--danger)';
            if (isTaskDueSoon(task)) return 'var(--warning)';
            return 'var(--success)';
        }
        
        // Get country name from country code
        function getCountryName(countryCode) {
            const countries = {
                'US': 'United States',
                'GB': 'United Kingdom',
                'CA': 'Canada',
                'AU': 'Australia',
                'DE': 'Germany',
                'FR': 'France',
                'JP': 'Japan',
                'CN': 'China',
                'IN': 'India',
                'BR': 'Brazil',
                'RU': 'Russia',
                'ZA': 'South Africa',
                'MX': 'Mexico',
                'IT': 'Italy',
                'ES': 'Spain',
                'KR': 'South Korea',
                'NG': 'Nigeria',
                'EG': 'Egypt',
                'SA': 'Saudi Arabia',
                'AE': 'United Arab Emirates'
            };
            
            return countries[countryCode] || countryCode;
        }
        
        // Capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>
