<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <!-- CDNs -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #fff;
            --text-color: #000;
            --card-bg: #f8f9fa;
            --green: #28A745;
            --grey: #6C757D;
            --red: #DC3545;
            --yellow: #FFC107;
            --orange: #FD7E14;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        body.dark-mode {
            --bg-color: #333;
            --text-color: #fff;
            --card-bg: #444;
        }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
        }
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 16px;
            transition: var(--transition);
        }
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }
        button:hover {
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        .btn-green { background: var(--green); color: white; }
        .btn-grey { background: var(--grey); color: white; }
        .btn-red { background: var(--red); color: white; }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
        }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        .status-frame.login { border: 2px solid var(--green); }
        .status-frame.logout { border: 2px solid var(--red); }
        .status-frame.break { border: 2px solid var(--yellow); }
        .status-frame.shadow { border: 2px solid var(--grey); }
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        .task.expired { border: 2px solid var(--red); }
        .task.due-soon { border: 2px solid var(--yellow); }
        .task.normal { border: 2px solid var(--green); }
        .task.completed { background: var(--green); color: white; }
        .priority-high { color: var(--red); }
        .priority-medium { color: var(--orange); }
        .priority-low { color: var(--grey); }
        .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .total-tasks { grid-column: span 2; }
        nav { padding: 16px; display: flex; gap: 16px; }
        @media (max-width: 768px) {
            .summary { grid-template-columns: 1fr; }
            .total-tasks { grid-column: span 1; }
            nav { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Page -->
        <div id="login-page">
            <form id="login-form" class="card" style="max-width: 400px; margin: 50px auto;">
                <h2>Login</h2>
                <input type="email" id="login-email" value="test@example.com" aria-label="Email">
                <input type="password" id="login-password" value="123456" aria-label="Password">
                <button type="submit" class="btn-green" style="width: 80%; margin: 0 auto; display: block;">Login</button>
                <p style="text-align: center;">Don't have an account? <a href="#" id="register-link" style="color: #00008B; text-decoration: underline;">Register now</a></p>
            </form>
        </div>
        <!-- Registration Popup -->
        <div id="registration-popup" class="popup" style="display: none;">
            <form id="registration-form">
                <input type="text" id="reg-lastname" placeholder="Last Name" required aria-label="Last Name">
                <input type="text" id="reg-firstname" placeholder="First Name" required aria-label="First Name">
                <input type="email" id="reg-email" placeholder="Email" required aria-label="Email">
                <input type="email" id="reg-confirm-email" placeholder="Confirm Email" required aria-label="Confirm Email">
                <input type="password" id="reg-password" placeholder="Password" required aria-label="Password">
                <input type="password" id="reg-confirm-password" placeholder="Confirm Password" required aria-label="Confirm Password">
                <input type="text" id="reg-birthdate" placeholder="Birthdate" required aria-label="Birthdate">
                <select id="reg-nationality" required aria-label="Nationality"></select>
                <select id="reg-role" required aria-label="Role">
                    <option value="Manager">Manager</option>
                    <option value="Staff">Staff</option>
                    <option value="Customer">Customer</option>
                    <option value="Admin">Admin</option>
                </select>
                <button type="submit" class="btn-green">Create</button>
                <button type="button" id="reg-cancel" class="btn-grey">Cancel</button>
            </form>
        </div>
        <!-- Dashboard -->
        <div id="dashboard" style="display: none;">
            <header>
                <h1>To-Do App</h1>
                <div class="header-right">
                    <div class="task-timer" id="task-timer">00:00:00</div>
                    <div class="notification-bell" style="position: relative;">
                        <img src="https://via.placeholder.com/24" alt="Notifications" style="cursor: pointer;">
                        <span class="badge" id="notification-badge">0</span>
                    </div>
                    <div class="mode-switcher">
                        <button id="mode-toggle">
                            <img id="mode-icon" src="https://via.placeholder.com/24" alt="Light Mode">
                        </button>
                    </div>
                    <div class="user-profile" style="position: relative;">
                        <img src="https://via.placeholder.com/40" alt="Profile" id="profile-picture" class="status-frame">
                        <select id="user-status" aria-label="User Status">
                            <option value="Login">Login</option>
                            <option value="Logout">Logout</option>
                            <option value="Break">Break</option>
                            <option value="Shadow">Shadow</option>
                        </select>
                        <span class="badge" id="profile-notification-badge">0</span>
                    </div>
                </div>
            </header>
            <nav>
                <button id="tasks-btn" class="btn-green">Tasks</button>
                <button id="users-btn" class="btn-grey">Users</button>
                <button id="categories-btn" class="btn-grey">Manage Categories</button>
            </nav>
            <!-- Tasks Section -->
            <div id="tasks-section">
                <div class="summary">
                    <div class="total-tasks card">
                        <h2>Total Tasks</h2>
                        <p id="total-tasks-count">0</p>
                    </div>
                    <div class="completed-tasks card">
                        <h2>Completed Tasks</h2>
                        <p id="completed-tasks-count">0</p>
                    </div>
                    <div class="pending-tasks card">
                        <h2>Pending Tasks</h2>
                        <p id="pending-tasks-count">0</p>
                    </div>
                </div>
                <div class="tasks-header">
                    <h2>Tasks</h2>
                    <div class="tasks-actions">
                        <button id="add-task" class="btn-green">Add Task</button>
                        <button id="export-tasks" class="btn-grey">Export</button>
                        <button id="import-tasks" class="btn-grey">Import</button>
                    </div>
                </div>
                <div class="tasks-controls">
                    <input type="text" id="search-input" placeholder="Search tasks..." aria-label="Search tasks">
                    <select id="filter-status" aria-label="Filter by status">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="filter-category" aria-label="Filter by category"></select>
                    <select id="filter-priority" aria-label="Filter by priority">
                        <option value="all">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="filter-due-date" aria-label="Filter by due date">
                        <option value="all">All Due Dates</option>
                        <option value="today">Today</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                    <div id="custom-date-range" style="display: none;">
                        <input type="text" id="date-range-picker" placeholder="Select date range" aria-label="Custom date range">
                    </div>
                    <button id="apply-filters" class="btn-green">Apply Filters</button>
                    <select id="sort-by" aria-label="Sort by">
                        <option value="title-asc">Title A-Z</option>
                        <option value="title-desc">Title Z-A</option>
                        <option value="due-date-asc">Due Date Earliest</option>
                        <option value="due-date-desc">Due Date Latest</option>
                        <option value="priority-desc">Priority High to Low</option>
                        <option value="priority-asc">Priority Low to High</option>
                    </select>
                    <button id="toggle-view" class="btn-grey">Switch to Graph View</button>
                </div>
                <div id="task-list"></div>
                <div id="graph-view" style="display: none;">
                    <canvas id="xy-chart"></canvas>
                    <canvas id="pie-chart"></canvas>
                </div>
            </div>
            <!-- Insights Layout -->
            <div id="insights" class="card" style="margin: 16px;">
                <h2>Insights</h2>
                <div id="task-stats"></div>
                <div id="user-stats"></div>
            </div>
            <!-- Popups -->
            <div id="add-task-popup" class="popup" style="display: none;">
                <form id="add-task-form">
                    <input type="text" id="task-title" placeholder="Title" required aria-label="Task Title">
                    <textarea id="task-description" placeholder="Description" aria-label="Task Description"></textarea>
                    <input type="text" id="task-due-date" placeholder="Due Date" aria-label="Task Due Date">
                    <select id="task-priority" aria-label="Task Priority">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="task-category" aria-label="Task Category"></select>
                    <textarea id="task-notes" placeholder="Notes" aria-label="Task Notes"></textarea>
                    <div id="subtasks-container">
                        <h4>Subtasks</h4>
                        <button type="button" id="add-subtask" class="btn-grey">Add Subtask</button>
                        <div id="subtasks-list"></div>
                    </div>
                    <button type="submit" class="btn-green">Create</button>
                    <button type="button" id="add-task-cancel" class="btn-grey">Cancel</button>
                </form>
            </div>
            <div id="users-popup" class="popup" style="display: none;"></div>
            <div id="categories-popup" class="popup" style="display: none;">
                <h2>Manage Categories</h2>
                <input type="text" id="new-category" placeholder="New category name" aria-label="New Category">
                <button id="add-category" class="btn-green">Add Category</button>
                <ul id="categories-list"></ul>
                <button id="categories-close" class="btn-grey">Close</button>
            </div>
            <div id="profile-dropdown" class="popup" style="display: none;">
                <ul style="list-style: none; padding: 0;">
                    <li><a href="#" id="view-profile">View Profile</a></li>
                    <li><a href="#" id="logout">Logout</a></li>
                    <li><a href="#" id="switch-mode">Switch Mode</a></li>
                </ul>
            </div>
            <div id="profile-popup" class="popup" style="display: none;">
                <h2>Profile</h2>
                <img id="popup-profile-picture" src="" alt="Profile Picture">
                <p>Name: <span id="popup-name"></span></p>
                <p>Email: <span id="popup-email"></span></p>
                <p>Country: <span id="popup-country"></span></p>
                <p>Role: <span id="popup-role"></span></p>
                <p>Joining Date: <span id="popup-joining-date"></span></p>
                <button id="edit-profile" class="btn-green">Edit Profile</button>
                <button id="close-profile" class="btn-grey">Close</button>
            </div>
            <div id="edit-profile-popup" class="popup" style="display: none;">
                <form id="edit-profile-form">
                    <input type="text" id="edit-firstname" placeholder="First Name" aria-label="First Name">
                    <input type="text" id="edit-lastname" placeholder="Last Name" aria-label="Last Name">
                    <input type="email" id="edit-email" placeholder="Email" aria-label="Email">
                    <input type="text" id="edit-birthdate" placeholder="Birthdate" aria-label="Birthdate">
                    <select id="edit-nationality" aria-label="Nationality"></select>
                    <select id="edit-role" aria-label="Role">
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <input type="file" id="edit-profile-picture" accept="image/*" aria-label="Profile Picture">
                    <button type="submit" class="btn-green">Save</button>
                    <button type="button" id="edit-cancel" class="btn-grey">Cancel</button>
                </form>
            </div>
            <div id="share-task-popup" class="popup" style="display: none;">
                <h2>Share Task</h2>
                <p id="share-task-title"></p>
                <button id="share-email" class="btn-green">Share via Email</button>
                <button id="share-link" class="btn-green">Copy Link</button>
                <button id="share-close" class="btn-grey">Close</button>
            </div>
        </div>
    </div>
    <script>
        // Data Management
        function getUsers() {
            return JSON.parse(localStorage.getItem('users')) || [];
        }
        function saveUsers(users) {
            localStorage.setItem('users', JSON.stringify(users));
        }
        function getTasks() {
            return JSON.parse(localStorage.getItem('tasks')) || [];
        }
        function saveTasks(tasks) {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        function getCategories() {
            return JSON.parse(localStorage.getItem('categories')) || [{id: 1, name: 'Work'}, {id: 2, name: 'Personal'}];
        }
        function saveCategories(categories) {
            localStorage.setItem('categories', JSON.stringify(categories));
        }
        function getNotifications() {
            return JSON.parse(localStorage.getItem('notifications')) || [];
        }
        function saveNotifications(notifications) {
            localStorage.setItem('notifications', JSON.stringify(notifications));
            updateNotificationBadge();
        }

        // Initial Data
        if (!localStorage.getItem('tasks')) {
            const randomTasks = [];
            for (let i = 0; i < 10; i++) {
                randomTasks.push({
                    id: Date.now() + i,
                    title: `Task ${i+1}`,
                    description: `Description for task ${i+1}`,
                    subtasks: i % 2 === 0 ? [{id: Date.now() + i + 1, title: 'Subtask 1', completed: false}, {id: Date.now() + i + 2, title: 'Subtask 2', completed: true}] : [],
                    dueDate: new Date(Date.now() + (i * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
                    priority: ['High', 'Medium', 'Low'][Math.floor(Math.random() * 3)],
                    category: ['Work', 'Personal'][Math.floor(Math.random() * 2)],
                    notes: `Notes for task ${i+1}`,
                    completed: Math.random() > 0.5,
                    timer: 0,
                });
            }
            saveTasks(randomTasks);
        }

        // Login and Registration
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const users = getUsers();
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
            } else {
                alert('Invalid email or password');
            }
        });
        document.getElementById('register-link').addEventListener('click', (e) => {
            e.preventDefault();
            showRegistrationPopup();
        });
        function showRegistrationPopup() {
            document.getElementById('registration-popup').style.display = 'block';
            fetch('https://restcountries.com/v3.1/all')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('reg-nationality');
                    select.innerHTML = '';
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        select.appendChild(option);
                    });
                });
            flatpickr('#reg-birthdate', { dateFormat: 'Y-m-d' });
        }
        document.getElementById('registration-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = {
                id: Date.now(),
                lastName: document.getElementById('reg-lastname').value,
                firstName: document.getElementById('reg-firstname').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                birthdate: document.getElementById('reg-birthdate').value,
                nationality: document.getElementById('reg-nationality').value,
                role: document.getElementById('reg-role').value,
                profilePicture: null,
                status: 'Login',
                notifications: [],
                joiningDate: new Date().toISOString(),
            };
            if (user.email !== document.getElementById('reg-confirm-email').value || user.password !== document.getElementById('reg-confirm-password').value) {
                alert('Email or password do not match');
                return;
            }
            const users = getUsers();
            if (users.some(u => u.email === user.email)) {
                alert('Email already exists');
                return;
            }
            users.push(user);
            saveUsers(users);
            document.getElementById('registration-popup').style.display = 'none';
            alert('Registration successful. Please login.');
        });
        document.getElementById('reg-cancel').addEventListener('click', () => {
            document.getElementById('registration-popup').style.display = 'none';
        });

        // Dashboard
        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('profile-picture').src = user.profilePicture || 'https://via.placeholder.com/40';
            document.getElementById('profile-picture').className = `status-frame ${user.status.toLowerCase()}`;
            document.getElementById('user-status').value = user.status;
            renderTasks();
            updateInsights();
        }
        document.getElementById('profile-picture').addEventListener('click', () => {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-page').style.display = 'block';
        });
        document.getElementById('mode-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('mode-icon').src = isDark ? 'https://via.placeholder.com/24' : 'https://via.placeholder.com/24';
        });
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('mode-icon').src = 'https://via.placeholder.com/24';
        }
        document.getElementById('user-status').addEventListener('change', function() {
            const status = this.value;
            const user = JSON.parse(localStorage.getItem('currentUser'));
            user.status = status;
            localStorage.setItem('currentUser', JSON.stringify(user));
            document.getElementById('profile-picture').className = `status-frame ${status.toLowerCase()}`;
            const users = getUsers();
            const index = users.findIndex(u => u.id === user.id);
            if (index !== -1) {
                users[index].status = status;
                saveUsers(users);
            }
        });
        document.getElementById('view-profile').addEventListener('click', (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('popup-profile-picture').src = user.profilePicture || 'https://via.placeholder.com/40';
            document.getElementById('popup-name').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('popup-email').textContent = user.email;
            document.getElementById('popup-country').textContent = user.nationality;
            document.getElementById('popup-role').textContent = user.role;
            document.getElementById('popup-joining-date').textContent = new Date(user.joiningDate).toLocaleDateString();
            document.getElementById('profile-popup').style.display = 'block';
        });
        document.getElementById('close-profile').addEventListener('click', () => {
            document.getElementById('profile-popup').style.display = 'none';
        });
        document.getElementById('edit-profile').addEventListener('click', () => {
            document.getElementById('profile-popup').style.display = 'none';
            const user = JSON.parse(localStorage.getItem('currentUser'));
            document.getElementById('edit-firstname').value = user.firstName;
            document.getElementById('edit-lastname').value = user.lastName;
            document.getElementById('edit-email').value = user.email;
            document.getElementById('edit-birthdate').value = user.birthdate;
            document.getElementById('edit-role').value = user.role;
            fetch('https://restcountries.com/v3.1/all')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('edit-nationality');
                    select.innerHTML = '';
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.name.common;
                        option.textContent = country.name.common;
                        if (country.name.common === user.nationality) option.selected = true;
                        select.appendChild(option);
                    });
                });
            flatpickr('#edit-birthdate', { dateFormat: 'Y-m-d', defaultDate: user.birthdate });
            document.getElementById('edit-profile-popup').style.display = 'block';
        });
        document.getElementById('edit-profile-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('currentUser'));
            user.firstName = document.getElementById('edit-firstname').value;
            user.lastName = document.getElementById('edit-lastname').value;
            user.email = document.getElementById('edit-email').value;
            user.birthdate = document.getElementById('edit-birthdate').value;
            user.nationality = document.getElementById('edit-nationality').value;
            user.role = document.getElementById('edit-role').value;
            const fileInput = document.getElementById('edit-profile-picture');
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    user.profilePicture = event.target.result;
                    saveUpdatedUser(user);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveUpdatedUser(user);
            }
        });
        function saveUpdatedUser(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
            const users = getUsers();
            const index = users.findIndex(u => u.id === user.id);
            if (index !== -1) {
                users[index] = user;
                saveUsers(users);
            }
            document.getElementById('edit-profile-popup').style.display = 'none';
            document.getElementById('profile-picture').src = user.profilePicture || 'https://via.placeholder.com/40';
        }
        document.getElementById('edit-cancel').addEventListener('click', () => {
            document.getElementById('edit-profile-popup').style.display = 'none';
        });

        // Task Management
        function renderTasks(tasks = getTasks()) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `task card ${task.completed ? 'completed' : ''} ${getDueClass(task.dueDate)}`;
                taskEl.dataset.id = task.id;
                const completedSubtasks = task.subtasks.filter(s => s.completed).length;
                taskEl.innerHTML = `
                    <input type="checkbox" class="task-select" aria-label="Select task">
                    <div class="task-info">
                        <h3>${task.title}</h3>
                        <p>${task.description}</p>
                        <p>Due: ${task.dueDate}</p>
                        <p>Priority: <span class="priority-${task.priority.toLowerCase()}">${task.priority}</span></p>
                        <p>Category: ${task.category}</p>
                        <p>Subtasks: ${completedSubtasks} / ${task.subtasks.length}</p>
                    </div>
                    <div class="task-actions">
                        <button class="view-task btn-grey">View</button>
                        <button class="edit-task btn-grey">Edit</button>
                        <button class="delete-task btn-red">Delete</button>
                        <button class="share-task btn-green">Share</button>
                        <button class="play-pause-task btn-grey">${task.timer > 0 ? 'Pause' : 'Play'}</button>
                        <label class="toggle-complete">
                            <input type="checkbox" ${task.completed ? 'checked' : ''} aria-label="Toggle complete">
                            <span>Complete</span>
                        </label>
                    </div>
                `;
                taskList.appendChild(taskEl);
            });
            addTaskEventListeners();
            updateSummary();
        }
        function getDueClass(dueDate) {
            if (!dueDate) return 'normal';
            const now = new Date();
            const due = new Date(dueDate);
            if (due < now) return 'expired';
            if (due - now < 48 * 60 * 60 * 1000) {
                addNotification(`Task due soon: ${dueDate}`);
                return 'due-soon';
            }
            return 'normal';
        }
        function addTaskEventListeners() {
            document.querySelectorAll('.delete-task').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.closest('.task').dataset.id;
                    const tasks = getTasks().filter(t => t.id != id);
                    saveTasks(tasks);
                    addNotification(`Task deleted`);
                    renderTasks();
                });
            });
            document.querySelectorAll('.toggle-complete').forEach(label => {
                label.querySelector('input').addEventListener('change', (e) => {
                    const id = label.closest('.task').dataset.id;
                    const tasks = getTasks();
                    const task = tasks.find(t => t.id == id);
                    task.completed = e.target.checked;
                    saveTasks(tasks);
                    addNotification(`Task '${task.title}' ${task.completed ? 'completed' : 'marked incomplete'}`);
                    renderTasks();
                });
            });
            document.querySelectorAll('.share-task').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.closest('.task').dataset.id;
                    const task = getTasks().find(t => t.id == id);
                    document.getElementById('share-task-title').textContent = `Sharing: ${task.title}`;
                    document.getElementById('share-task-popup').style.display = 'block';
                    document.getElementById('share-email').onclick = () => {
                        window.location.href = `mailto:?subject=Shared Task: ${task.title}&body=${encodeURIComponent(JSON.stringify(task))}`;
                    };
                    document.getElementById('share-link').onclick = () => {
                        const link = `${window.location.origin}/task/${task.id}`;
                        navigator.clipboard.writeText(link);
                        alert('Link copied to clipboard');
                    };
                    document.getElementById('share-close').onclick = () => {
                        document.getElementById('share-task-popup').style.display = 'none';
                    };
                });
            });
        }
        document.getElementById('add-task').addEventListener('click', () => {
            document.getElementById('add-task-popup').style.display = 'block';
            const categories = getCategories();
            const select = document.getElementById('task-category');
            select.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                select.appendChild(option);
            });
            flatpickr('#task-due-date', { dateFormat: 'Y-m-d' });
            document.getElementById('subtasks-list').innerHTML = '';
        });
        document.getElementById('add-subtask').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'subtask-input';
            input.placeholder = 'Subtask title';
            document.getElementById('subtasks-list').appendChild(input);
        });
        document.getElementById('add-task-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const task = {
                id: Date.now(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                subtasks: Array.from(document.querySelectorAll('.subtask-input')).map(i => ({id: Date.now() + Math.random(), title: i.value, completed: false})),
                dueDate: document.getElementById('task-due-date').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                notes: document.getElementById('task-notes').value,
                completed: false,
                timer: 0,
            };
            const tasks = getTasks();
            tasks.push(task);
            saveTasks(tasks);
            addNotification(`Task '${task.title}' created`);
            document.getElementById('add-task-popup').style.display = 'none';
            renderTasks();
        });
        document.getElementById('add-task-cancel').addEventListener('click', () => {
            document.getElementById('add-task-popup').style.display = 'none';
        });

        // Filtering and Sorting
        document.getElementById('apply-filters').addEventListener('click', () => {
            let tasks = getTasks();
            const status = document.getElementById('filter-status').value;
            const category = document.getElementById('filter-category').value;
            const priority = document.getElementById('filter-priority').value;
            const dueDate = document.getElementById('filter-due-date').value;
            if (status !== 'all') tasks = tasks.filter(t => (status === 'active' && !t.completed) || (status === 'completed' && t.completed));
            if (category !== 'all') tasks = tasks.filter(t => t.category === category);
            if (priority !== 'all') tasks = tasks.filter(t => t.priority.toLowerCase() === priority);
            if (dueDate !== 'all') {
                const now = new Date();
                if (dueDate === 'today') tasks = tasks.filter(t => new Date(t.dueDate).toDateString() === now.toDateString());
                else if (dueDate === 'this-week') tasks = tasks.filter(t => new Date(t.dueDate) <= new Date(now.setDate(now.getDate() + 7)));
                else if (dueDate === 'this-month') tasks = tasks.filter(t => new Date(t.dueDate) <= new Date(now.setMonth(now.getMonth() + 1)));
                else if (dueDate === 'custom') {
                    const range = document.getElementById('date-range-picker').value.split(' to ');
                    tasks = tasks.filter(t => new Date(t.dueDate) >= new Date(range[0]) && new Date(t.dueDate) <= new Date(range[1]));
                }
            }
            const sort = document.getElementById('sort-by').value;
            if (sort === 'title-asc') tasks.sort((a, b) => a.title.localeCompare(b.title));
            else if (sort === 'title-desc') tasks.sort((a, b) => b.title.localeCompare(a.title));
            else if (sort === 'due-date-asc') tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            else if (sort === 'due-date-desc') tasks.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
            else if (sort === 'priority-desc') tasks.sort((a, b) => ['High', 'Medium', 'Low'].indexOf(a.priority) - ['High', 'Medium', 'Low'].indexOf(b.priority));
            else if (sort === 'priority-asc') tasks.sort((a, b) => ['High', 'Medium', 'Low'].indexOf(b.priority) - ['High', 'Medium', 'Low'].indexOf(a.priority));
            renderTasks(tasks);
        });
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = e.target.value.toLowerCase();
                const tasks = getTasks().filter(t => t.title.toLowerCase().includes(query) || t.description.toLowerCase().includes(query));
                renderTasks(tasks);
            }, 300);
        });
        document.getElementById('filter-due-date').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('custom-date-range').style.display = 'block';
                flatpickr('#date-range-picker', { mode: 'range', dateFormat: 'Y-m-d' });
            } else {
                document.getElementById('custom-date-range').style.display = 'none';
            }
        });
        const categoryFilter = document.getElementById('filter-category');
        categoryFilter.innerHTML = '<option value="all">All Categories</option>' + getCategories().map(c => `<option value="${c.name}">${c.name}</option>`).join('');

        // Graph View
        let xyChart, pieChart;
        document.getElementById('toggle-view').addEventListener('click', () => {
            const isGraph = document.getElementById('task-list').style.display === 'none';
            document.getElementById('task-list').style.display = isGraph ? 'block' : 'none';
            document.getElementById('graph-view').style.display = isGraph ? 'none' : 'block';
            if (!isGraph) renderGraphs();
        });
        function renderGraphs() {
            const tasks = getTasks();
            const completed = tasks.filter(t => t.completed).length;
            const pending = tasks.length - completed;
            if (xyChart) xyChart.destroy();
            if (pieChart) pieChart.destroy();
            xyChart = new Chart(document.getElementById('xy-chart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Tasks'],
                    datasets: [
                        { label: 'Completed', data: [completed], backgroundColor: 'var(--green)' },
                        { label: 'Pending', data: [pending], backgroundColor: 'var(--yellow)' },
                    ]
                },
                options: { animation: { duration: 1000 } }
            });
            pieChart = new Chart(document.getElementById('pie-chart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{ data: [completed, pending], backgroundColor: ['var(--green)', 'var(--yellow)'] }]
                },
                options: { animation: { duration: 1000 } }
            });
        }

        // Users and Categories
        document.getElementById('users-btn').addEventListener('click', () => {
            const popup = document.getElementById('users-popup');
            popup.innerHTML = '<h2>Users</h2><button class="btn-grey" onclick="this.parentElement.style.display=\'none\'">Close</button>';
            const grid = document.createElement('div');
            grid.className = 'users-grid';
            getUsers().forEach(user => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${user.profilePicture || 'https://via.placeholder.com/40'}" alt="${user.firstName}">
                    <h3>${user.firstName} ${user.lastName}</h3>
                    <p>${user.email}</p>
                    <p>${user.role}</p>
                `;
                grid.appendChild(card);
            });
            popup.appendChild(grid);
            popup.style.display = 'block';
        });
        document.getElementById('categories-btn').addEventListener('click', () => {
            showCategoriesPopup();
        });
        function showCategoriesPopup() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            getCategories().forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat.name;
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'btn-grey';
                editBtn.onclick = () => {
                    const newName = prompt('New category name:', cat.name);
                    if (newName) {
                        const categories = getCategories();
                        categories.find(c => c.id === cat.id).name = newName;
                        saveCategories(categories);
                        showCategoriesPopup();
                    }
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'btn-red';
                deleteBtn.onclick = () => {
                    const categories = getCategories().filter(c => c.id !== cat.id);
                    saveCategories(categories);
                    showCategoriesPopup();
                };
                li.appendChild(editBtn);
                li.appendChild(deleteBtn);
                list.appendChild(li);
            });
            document.getElementById('categories-popup').style.display = 'block';
        }
        document.getElementById('add-category').addEventListener('click', () => {
            const name = document.getElementById('new-category').value;
            if (name) {
                const categories = getCategories();
                categories.push({id: Date.now(), name});
                saveCategories(categories);
                showCategoriesPopup();
                document.getElementById('new-category').value = '';
            }
        });
        document.getElementById('categories-close').addEventListener('click', () => {
            document.getElementById('categories-popup').style.display = 'none';
        });

        // Insights
        function updateInsights() {
            const tasks = getTasks();
            const completed = tasks.filter(t => t.completed).length;
            const pending = tasks.length - completed;
            document.getElementById('task-stats').innerHTML = `
                <p>Total Tasks: ${tasks.length}</p>
                <p>Completed: ${completed}</p>
                <p>Pending: ${pending}</p>
                <p>Categories: ${getCategories().length}</p>
            `;
            const users = getUsers();
            document.getElementById('user-stats').innerHTML = `
                <p>Total Users: ${users.length}</p>
                <p>Roles: ${Object.entries(users.reduce((acc, u) => { acc[u.role] = (acc[u.role] || 0) + 1; return acc; }, {})).map(([r, c]) => `${r}: ${c}`).join(', ')}</p>
            `;
        }

        // Notifications
        function addNotification(message) {
            const notifications = getNotifications();
            notifications.push({id: Date.now(), message, read: false});
            saveNotifications(notifications);
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '20px';
            toast.style.background = 'var(--card-bg)';
            toast.style.padding = '10px';
            toast.style.borderRadius = '4px';
            toast.style.boxShadow = 'var(--shadow)';
            document.body.appendChild(toast);
            setTimeout(() => document.body.removeChild(toast), 5000);
        }
        function updateNotificationBadge() {
            const unread = getNotifications().filter(n => !n.read).length;
            document.getElementById('notification-badge').textContent = unread;
            document.getElementById('profile-notification-badge').textContent = unread;
        }

        // Export/Import
        document.getElementById('export-tasks').addEventListener('click', () => {
            const tasks = getTasks();
            const blob = new Blob([JSON.stringify(tasks)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tasks.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        document.getElementById('import-tasks').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const importedTasks = JSON.parse(event.target.result);
                    saveTasks([...getTasks(), ...importedTasks]);
                    renderTasks();
                };
                reader.readAsText(file);
            };
            input.click();
        });

        // Initial Load
        if (localStorage.getItem('currentUser')) showDashboard();
    </script>
</body>
</html>
