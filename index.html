<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    
    <!-- External Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #5D5CDE;
            --positive-color: #28A745;
            --neutral-color: #6C757D;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
            --high-priority: #DC3545;
            --medium-priority: #FD7E14;
            --low-priority: #6C757D;
            --background-color: #FFFFFF;
            --card-background: #FFFFFF;
            --text-color: #333333;
            --border-color: #DDDDDD;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --animation-duration: 0.3s;
        }

        .dark {
            --primary-color: #5D5CDE;
            --background-color: #181818;
            --card-background: #282828;
            --text-color: #FFFFFF;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            transition: background-color var(--animation-duration), color var(--animation-duration);
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--background-color);
            position: relative;
            overflow: hidden;
        }

        .login-glow {
            position: absolute;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, var(--primary-color) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            opacity: 0.5;
            pointer-events: none;
            transition: transform 0.3s ease-out;
        }

        .login-form {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 25px var(--shadow-color);
            width: 90%;
            max-width: 400px;
            z-index: 1;
            position: relative;
            overflow: hidden;
        }

        .login-form h2 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-color);
            font-weight: 500;
        }

        .input-group input, 
        .input-group select, 
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus, 
        .input-group select:focus, 
        .input-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.3);
            outline: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 80%;
            margin: 0 auto;
            display: block;
        }

        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(93, 92, 222, 0.5);
        }

        .btn-success {
            background-color: var(--positive-color);
            color: white;
        }

        .btn-success:hover {
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }

        .btn-neutral {
            background-color: var(--neutral-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
            color: var(--text-color);
        }

        .register-link a {
            color: #00008B;
            cursor: pointer;
            text-decoration: none;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px var(--shadow-color);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .popup-overlay.active .popup {
            transform: translateY(0);
        }

        .popup h3 {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 20px;
            font-weight: 600;
        }

        .popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Dashboard Styles */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .header {
            background-color: var(--card-background);
            padding: 15px 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .app-title {
            color: var(--text-color);
            font-size: 24px;
            font-weight: 700;
            text-shadow: 1px 1px 3px var(--shadow-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .task-timer {
            background-color: var(--card-background);
            padding: 8px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            font-size: 24px;
            font-weight: 600;
            color: var(--text-color);
        }

        .user-profile {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .user-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--positive-color);
            border: 2px solid var(--card-background);
        }

        .status-online {
            background-color: var(--positive-color);
        }

        .status-offline {
            background-color: var(--danger-color);
        }

        .status-break {
            background-color: var(--warning-color);
        }

        .status-away {
            background-color: var(--neutral-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: var(--danger-color);
            color: white;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            font-size: 20px;
        }

        .notification-bell {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-color);
        }

        .profile-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 5px 20px var(--shadow-color);
            padding: 10px 0;
            min-width: 200px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: var(--text-color);
        }

        .profile-dropdown-item:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 0;
            background-color: var(--card-background);
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .nav-button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(93, 92, 222, 0.3);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Task Section Styles */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .total-tasks {
            grid-column: span 3;
            background-color: var(--primary-color);
            color: white;
        }

        .completed-tasks {
            background-color: var(--positive-color);
            color: white;
        }

        .pending-tasks {
            background-color: var(--warning-color);
            color: #333;
        }

        .summary-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .summary-card .count {
            font-size: 36px;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tasks-header h2 {
            font-size: 24px;
            font-weight: 600;
        }

        .tasks-actions {
            display: flex;
            gap: 10px;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-item {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            position: relative;
        }

        .task-item:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .task-item.completed {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 5px solid var(--positive-color);
        }

        .task-item.expired {
            border-left: 5px solid var(--danger-color);
        }

        .task-item.due-soon {
            border-left: 5px solid var(--warning-color);
        }

        .task-checkbox {
            margin-right: 15px;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .task-description {
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .task-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
        }

        .task-due-date, .task-priority, .task-category {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 500;
        }

        .task-due-date {
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary-color);
        }

        .task-priority {
            color: white;
        }

        .priority-high {
            background-color: var(--high-priority);
        }

        .priority-medium {
            background-color: var(--medium-priority);
        }

        .priority-low {
            background-color: var(--low-priority);
        }

        .task-category {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }

        .task-actions {
            display: flex;
            gap: 10px;
        }

        .task-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .task-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .view-btn {
            background-color: var(--primary-color);
        }

        .edit-btn {
            background-color: var(--warning-color);
            color: #333;
        }

        .delete-btn {
            background-color: var(--danger-color);
        }

        .play-btn {
            background-color: var(--positive-color);
        }
        
        .pause-btn {
            background-color: var(--warning-color);
            color: #333;
        }

        .share-btn {
            background-color: var(--primary-color);
        }

        .multi-select-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), #7a79e0);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 20;
            box-shadow: 0 -5px 15px var(--shadow-color);
        }

        .multi-select-bar.active {
            transform: translateY(0);
        }

        .multi-select-info {
            font-weight: 500;
        }

        .multi-select-actions {
            display: flex;
            gap: 10px;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            color: var(--text-color);
            min-width: 120px;
        }

        .search-input {
            flex: 1;
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: 16px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.5;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle-btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: 1px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .graph-view {
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .graph-view.active {
            display: grid;
        }

        .graph-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .list-view {
            display: block;
        }

        .list-view.hidden {
            display: none;
        }

        .insights-section {
            margin-top: 50px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .insight-card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .insight-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px 20px;
            background-color: var(--card-background);
            color: var(--text-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 100;
            max-width: 300px;
            display: flex;
            gap: 10px;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }

        .toast-notification.active {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-success .toast-icon {
            color: var(--positive-color);
        }

        .toast-error .toast-icon {
            color: var(--danger-color);
        }

        .toast-info .toast-icon {
            color: var(--primary-color);
        }

        .toast-warning .toast-icon {
            color: var(--warning-color);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--neutral-color);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--positive-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .subtask-list {
            margin-top: 10px;
            padding-left: 20px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
        }

        .subtask-title {
            flex: 1;
        }

        .add-subtask-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .add-subtask-input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--card-background);
            color: var(--text-color);
            font-size: 16px;
        }

        .icon {
            font-size: 18px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .total-tasks {
                grid-column: span 1;
            }
            
            .tasks-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .task-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .task-actions {
                margin-top: 15px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .graph-view {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notification Popup */
        .notification-popup {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 5px 20px var(--shadow-color);
            padding: 15px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .notification-popup.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item.unread {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .notification-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .notification-mark-read {
            display: block;
            text-align: center;
            margin-top: 10px;
            color: var(--primary-color);
            cursor: pointer;
        }

        /* Animation Classes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animated-fadeIn {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animated-slideUp {
            animation: slideUp 0.5s ease forwards;
        }

        /* Dragging */
        .task-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color);
        }

        /* Loading indicators */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Share styles */
        .share-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .share-option:hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .share-icon {
            font-size: 24px;
            color: var(--primary-color);
        }

        .share-label {
            font-size: 14px;
            text-align: center;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-glow" id="loginGlow"></div>
        <div class="login-form animated-fadeIn">
            <h2>Welcome Back</h2>
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" value="test@example.com">
                <div class="error-message" id="emailError">Please enter a valid email</div>
            </div>
            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" value="123456">
                <div class="error-message" id="passwordError">Password must be at least 6 characters</div>
            </div>
            <button class="btn btn-primary" id="loginBtn">Login</button>
            <div class="register-link">
                Don't have an account? <a id="registerLink">Register now</a>
            </div>
        </div>
    </div>

    <!-- Registration Popup -->
    <div class="popup-overlay" id="registerPopup">
        <div class="popup">
            <h3>Create an Account</h3>
            <div class="input-group">
                <label for="regLastName">Last Name</label>
                <input type="text" id="regLastName">
                <div class="error-message" id="lastNameError">Please enter your last name</div>
            </div>
            <div class="input-group">
                <label for="regFirstName">First Name</label>
                <input type="text" id="regFirstName">
                <div class="error-message" id="firstNameError">Please enter your first name</div>
            </div>
            <div class="input-group">
                <label for="regEmail">Email</label>
                <input type="email" id="regEmail">
                <div class="error-message" id="regEmailError">Please enter a valid email</div>
            </div>
            <div class="input-group">
                <label for="regConfirmEmail">Confirm Email</label>
                <input type="email" id="regConfirmEmail">
                <div class="error-message" id="confirmEmailError">Emails don't match</div>
            </div>
            <div class="input-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword">
                <div class="error-message" id="regPasswordError">Password must be at least 6 characters</div>
            </div>
            <div class="input-group">
                <label for="regConfirmPassword">Confirm Password</label>
                <input type="password" id="regConfirmPassword">
                <div class="error-message" id="confirmPasswordError">Passwords don't match</div>
            </div>
            <div class="input-group">
                <label for="regBirthdate">Birthdate</label>
                <input type="text" id="regBirthdate" placeholder="Select Date">
                <div class="error-message" id="birthdateError">Please select your birthdate</div>
            </div>
            <div class="input-group">
                <label for="regNationality">Nationality</label>
                <select id="regNationality">
                    <option value="">Select Country</option>
                </select>
                <div class="error-message" id="nationalityError">Please select your nationality</div>
            </div>
            <div class="input-group">
                <label for="regRole">Role</label>
                <select id="regRole">
                    <option value="">Select Role</option>
                    <option value="Manager">Manager</option>
                    <option value="Staff">Staff</option>
                    <option value="Customer">Customer</option>
                    <option value="Admin">Admin</option>
                </select>
                <div class="error-message" id="roleError">Please select your role</div>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelRegisterBtn">Cancel</button>
                <button class="btn btn-success" id="createAccountBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="header">
            <h1 class="app-title">To-Do App</h1>
            <div class="header-right">
                <div class="task-timer" id="taskTimer">00:00:00</div>
                <div class="notification-bell" id="notificationBell">
                    🔔
                    <div class="notification-badge" id="notificationBadge">0</div>
                </div>
                <button class="theme-toggle" id="themeToggle">🌙</button>
                <div class="user-profile" id="userProfile">
                    <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User">
                    <div class="status-indicator status-online" id="statusIndicator"></div>
                    <div class="notification-badge" id="profileNotificationBadge">0</div>
                </div>
            </div>
        </header>

        <!-- Profile Dropdown -->
        <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-dropdown-item" id="viewProfileBtn">View Profile</div>
            <div class="profile-dropdown-item" id="switchModeBtn">Switch Mode</div>
            <div class="profile-dropdown-item" id="logoutBtn">Logout</div>
        </div>

        <!-- Notification Popup -->
        <div class="notification-popup" id="notificationPopup">
            <h3>Notifications</h3>
            <div id="notificationList">
                <!-- Notifications will be populated here -->
            </div>
            <div class="notification-mark-read" id="markAllReadBtn">Mark All as Read</div>
        </div>

        <!-- Navigation -->
        <nav class="navigation">
            <button class="nav-button" id="tasksBtn">Tasks</button>
            <button class="nav-button" id="usersBtn">Users</button>
            <button class="nav-button" id="categoriesBtn">Manage Categories</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card total-tasks animated-slideUp">
                    <h3>Total Tasks</h3>
                    <div class="count" id="totalTasksCount">0</div>
                </div>
                <div class="summary-card completed-tasks animated-slideUp" style="animation-delay: 0.1s;">
                    <h3>Completed Tasks</h3>
                    <div class="count" id="completedTasksCount">0</div>
                </div>
                <div class="summary-card pending-tasks animated-slideUp" style="animation-delay: 0.2s;">
                    <h3>Pending Tasks</h3>
                    <div class="count" id="pendingTasksCount">0</div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="tasks-header">
                <h2>Tasks</h2>
                <div class="tasks-actions">
                    <button class="btn btn-success" id="addTaskBtn">+ Add Task</button>
                    <button class="btn btn-primary" id="exportBtn">Export</button>
                    <button class="btn btn-primary" id="importBtn">Import</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-row">
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoryFilter">Category</label>
                    <select class="filter-select" id="categoryFilter">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="priorityFilter">Priority</label>
                    <select class="filter-select" id="priorityFilter">
                        <option value="all">All Priorities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dueDateFilter">Due Date</label>
                    <select class="filter-select" id="dueDateFilter">
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Sort By</label>
                    <select class="filter-select" id="sortBy">
                        <option value="dateCreated-desc">Date Created (Newest)</option>
                        <option value="dateCreated-asc">Date Created (Oldest)</option>
                        <option value="dueDate-asc">Due Date (Earliest)</option>
                        <option value="dueDate-desc">Due Date (Latest)</option>
                        <option value="priority-desc">Priority (High to Low)</option>
                        <option value="priority-asc">Priority (Low to High)</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                    </select>
                </div>
                <div class="search-input">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="searchInput" placeholder="Search tasks...">
                </div>
            </div>

            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-toggle-btn active" id="listViewBtn">List View</button>
                <button class="view-toggle-btn" id="graphViewBtn">Graph View</button>
            </div>

            <!-- List View -->
            <div class="list-view" id="listView">
                <div class="task-list" id="taskList">
                    <!-- Tasks will be populated here -->
                </div>
            </div>

            <!-- Graph View -->
            <div class="graph-view" id="graphView">
                <div class="graph-card">
                    <canvas id="tasksChart"></canvas>
                </div>
                <div class="graph-card">
                    <canvas id="tasksPieChart"></canvas>
                </div>
            </div>

            <!-- Multi-Select Action Bar -->
            <div class="multi-select-bar" id="multiSelectBar">
                <div class="multi-select-info">
                    <span id="selectedCount">0</span> tasks selected
                </div>
                <div class="multi-select-actions">
                    <button class="btn btn-success" id="batchCompleteBtn">Mark as Complete</button>
                    <button class="btn btn-danger" id="batchDeleteBtn">Delete</button>
                    <button class="btn btn-neutral" id="cancelSelectBtn">Cancel</button>
                </div>
            </div>

            <!-- Insights Section -->
            <div class="insights-section">
                <h2>Insights</h2>
                <div class="insights-grid">
                    <div class="insight-card">
                        <h3>Tasks by Category</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="insight-card">
                        <h3>Tasks by Priority</h3>
                        <canvas id="priorityChart"></canvas>
                    </div>
                    <div class="insight-card">
                        <h3>User Statistics</h3>
                        <canvas id="userRolesChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Task Popup -->
    <div class="popup-overlay" id="addTaskPopup">
        <div class="popup">
            <h3>Add New Task</h3>
            <div class="input-group">
                <label for="taskTitle">Title</label>
                <input type="text" id="taskTitle">
                <div class="error-message" id="taskTitleError">Please enter a task title</div>
            </div>
            <div class="input-group">
                <label for="taskDescription">Description</label>
                <textarea id="taskDescription" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label>Sub-Tasks</label>
                <div id="subtasksList">
                    <!-- Subtasks will be added here -->
                </div>
                <div class="add-subtask-row">
                    <input type="text" class="add-subtask-input" id="newSubtask" placeholder="Add a subtask...">
                    <button class="btn btn-primary" id="addSubtaskBtn">+</button>
                </div>
            </div>
            <div class="input-group">
                <label for="taskDueDate">Due Date</label>
                <input type="text" id="taskDueDate" placeholder="Select Date">
                <div class="error-message" id="taskDueDateError">Please select a due date</div>
            </div>
            <div class="input-group">
                <label for="taskPriority">Priority</label>
                <select id="taskPriority">
                    <option value="high">High</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="taskCategory">Category</label>
                <select id="taskCategory">
                    <!-- Categories will be populated here -->
                </select>
            </div>
            <div class="input-group">
                <label for="taskNotes">Notes</label>
                <textarea id="taskNotes" rows="3"></textarea>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelAddTaskBtn">Cancel</button>
                <button class="btn btn-success" id="createTaskBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- View Task Popup -->
    <div class="popup-overlay" id="viewTaskPopup">
        <div class="popup">
            <h3 id="viewTaskTitle">Task Title</h3>
            <p id="viewTaskDescription">Task description will appear here.</p>
            
            <div id="viewSubtasksContainer" style="margin-top: 15px;">
                <h4>Subtasks:</h4>
                <div id="viewSubtasksList">
                    <!-- Subtasks will be added here -->
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <p><strong>Due Date:</strong> <span id="viewTaskDueDate"></span></p>
                <p><strong>Priority:</strong> <span id="viewTaskPriority"></span></p>
                <p><strong>Category:</strong> <span id="viewTaskCategory"></span></p>
                <p><strong>Status:</strong> <span id="viewTaskStatus"></span></p>
                
                <div id="viewTaskNotesContainer" style="margin-top: 15px;">
                    <h4>Notes:</h4>
                    <p id="viewTaskNotes"></p>
                </div>
            </div>
            
            <div class="popup-buttons">
                <button class="btn btn-primary" id="shareTaskBtn">Share</button>
                <button class="btn btn-neutral" id="closeViewTaskBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Popup -->
    <div class="popup-overlay" id="editTaskPopup">
        <div class="popup">
            <h3>Edit Task</h3>
            <div class="input-group">
                <label for="editTaskTitle">Title</label>
                <input type="text" id="editTaskTitle">
                <div class="error-message" id="editTaskTitleError">Please enter a task title</div>
            </div>
            <div class="input-group">
                <label for="editTaskDescription">Description</label>
                <textarea id="editTaskDescription" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label>Sub-Tasks</label>
                <div id="editSubtasksList">
                    <!-- Subtasks will be added here -->
                </div>
                <div class="add-subtask-row">
                    <input type="text" class="add-subtask-input" id="editNewSubtask" placeholder="Add a subtask...">
                    <button class="btn btn-primary" id="editAddSubtaskBtn">+</button>
                </div>
            </div>
            <div class="input-group">
                <label for="editTaskDueDate">Due Date</label>
                <input type="text" id="editTaskDueDate" placeholder="Select Date">
                <div class="error-message" id="editTaskDueDateError">Please select a due date</div>
            </div>
            <div class="input-group">
                <label for="editTaskPriority">Priority</label>
                <select id="editTaskPriority">
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskCategory">Category</label>
                <select id="editTaskCategory">
                    <!-- Categories will be populated here -->
                </select>
            </div>
            <div class="input-group">
                <label for="editTaskNotes">Notes</label>
                <textarea id="editTaskNotes" rows="3"></textarea>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelEditTaskBtn">Cancel</button>
                <button class="btn btn-success" id="saveTaskBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Export Popup -->
    <div class="popup-overlay" id="exportPopup">
        <div class="popup">
            <h3>Export Tasks</h3>
            <div class="input-group">
                <label for="exportFormat">Select Format</label>
                <select id="exportFormat">
                    <option value="pdf">PDF</option>
                    <option value="json">JSON</option>
                    <option value="excel">Excel</option>
                </select>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelExportBtn">Cancel</button>
                <button class="btn btn-success" id="confirmExportBtn">Export</button>
            </div>
        </div>
    </div>

    <!-- Import Popup -->
    <div class="popup-overlay" id="importPopup">
        <div class="popup">
            <h3>Import Tasks</h3>
            <div class="input-group">
                <label for="importMethod">Import Method</label>
                <select id="importMethod">
                    <option value="file">Upload JSON File</option>
                    <option value="url">Import from URL</option>
                </select>
            </div>
            <div class="input-group" id="fileUploadContainer">
                <label for="fileUpload">Select File</label>
                <input type="file" id="fileUpload" accept=".json">
            </div>
            <div class="input-group" id="urlImportContainer" style="display: none;">
                <label for="importUrl">URL</label>
                <input type="text" id="importUrl" placeholder="https://example.com/tasks.json">
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelImportBtn">Cancel</button>
                <button class="btn btn-success" id="confirmImportBtn">Import</button>
            </div>
        </div>
    </div>

    <!-- View Profile Popup -->
    <div class="popup-overlay" id="viewProfilePopup">
        <div class="popup">
            <h3>User Profile</h3>
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin-bottom: 15px;">
                    <img id="profilePicture" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <button class="btn btn-primary" id="uploadProfilePictureBtn" style="margin-top: 10px;">Change Picture</button>
                <input type="file" id="profilePictureUpload" accept="image/*" style="display: none;">
            </div>
            <div class="input-group">
                <label>Full Name</label>
                <p id="profileFullName" style="padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">John Doe</p>
            </div>
            <div class="input-group">
                <label>Email</label>
                <p id="profileEmail" style="padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">john.doe@example.com</p>
            </div>
            <div class="input-group">
                <label>Role</label>
                <p id="profileRole" style="padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">Manager</p>
            </div>
            <div class="input-group">
                <label>Country</label>
                <p id="profileCountry" style="padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">United States</p>
            </div>
            <div class="input-group">
                <label>Joining Date</label>
                <p id="profileJoiningDate" style="padding: 10px; background-color: rgba(0,0,0,0.05); border-radius: 8px;">January 1, 2023</p>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="closeProfileBtn">Close</button>
                <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Popup -->
    <div class="popup-overlay" id="editProfilePopup">
        <div class="popup">
            <h3>Edit Profile</h3>
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin-bottom: 15px;">
                    <img id="editProfilePicture" src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <button class="btn btn-primary" id="editUploadProfilePictureBtn" style="margin-top: 10px;">Change Picture</button>
                <input type="file" id="editProfilePictureUpload" accept="image/*" style="display: none;">
            </div>
            <div class="input-group">
                <label for="editProfileFirstName">First Name</label>
                <input type="text" id="editProfileFirstName">
            </div>
            <div class="input-group">
                <label for="editProfileLastName">Last Name</label>
                <input type="text" id="editProfileLastName">
            </div>
            <div class="input-group">
                <label for="editProfileEmail">Email</label>
                <input type="email" id="editProfileEmail">
            </div>
            <div class="input-group">
                <label for="editProfileCountry">Country</label>
                <select id="editProfileCountry">
                    <!-- Countries will be populated here -->
                </select>
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelEditProfileBtn">Cancel</button>
                <button class="btn btn-success" id="saveProfileBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Users Popup -->
    <div class="popup-overlay" id="usersPopup">
        <div class="popup" style="max-width: 800px;">
            <h3>Users</h3>
            <div id="usersList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <!-- Users will be populated here -->
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="closeUsersBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Categories Popup -->
    <div class="popup-overlay" id="categoriesPopup">
        <div class="popup">
            <h3>Manage Categories</h3>
            <div class="input-group">
                <label for="newCategory">New Category</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategory" placeholder="Category name" style="flex: 1;">
                    <button class="btn btn-success" id="addCategoryBtn">Add</button>
                </div>
            </div>
            <div id="categoriesList" style="margin-top: 20px;">
                <!-- Categories will be populated here -->
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="closeCategoriesBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Date Range Popup -->
    <div class="popup-overlay" id="dateRangePopup">
        <div class="popup">
            <h3>Select Date Range</h3>
            <div class="input-group">
                <label for="startDate">Start Date</label>
                <input type="text" id="startDate" placeholder="Select start date">
            </div>
            <div class="input-group">
                <label for="endDate">End Date</label>
                <input type="text" id="endDate" placeholder="Select end date">
            </div>
            <div class="popup-buttons">
                <button class="btn btn-neutral" id="cancelDateRangeBtn">Cancel</button>
                <button class="btn btn-success" id="applyDateRangeBtn">Apply</button>
            </div>
        </div>
    </div>

    <!-- Share Task Popup -->
    <div class="popup-overlay" id="shareTaskPopup">
        <div class="popup">
            <h3>Share Task</h3>
            <p id="shareTaskName" style="margin-bottom: 15px;"></p>
            
            <div class="share-options">
                <div class="share-option" data-platform="email">
                    <div class="share-icon">📧</div>
                    <div class="share-label">Email</div>
                </div>
                <div class="share-option" data-platform="whatsapp">
                    <div class="share-icon">📱</div>
                    <div class="share-label">WhatsApp</div>
                </div>
                <div class="share-option" data-platform="slack">
                    <div class="share-icon">💬</div>
                    <div class="share-label">Slack</div>
                </div>
                <div class="share-option" data-platform="teams">
                    <div class="share-icon">👥</div>
                    <div class="share-label">Teams</div>
                </div>
                <div class="share-option" data-platform="link">
                    <div class="share-icon">🔗</div>
                    <div class="share-label">Copy Link</div>
                </div>
                <div class="share-option" data-platform="twitter">
                    <div class="share-icon">🐦</div>
                    <div class="share-label">Twitter</div>
                </div>
                <div class="share-option" data-platform="facebook">
                    <div class="share-icon">👍</div>
                    <div class="share-label">Facebook</div>
                </div>
                <div class="share-option" data-platform="linkedin">
                    <div class="share-icon">💼</div>
                    <div class="share-label">LinkedIn</div>
                </div>
            </div>
            
            <div class="popup-buttons" style="margin-top: 20px;">
                <button class="btn btn-neutral" id="closeShareTaskBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="toastNotification">
        <div class="toast-icon" id="toastIcon">✓</div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Dark Mode Detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data Models and State Management
        const state = {
            tasks: [],
            users: [],
            categories: ['Work', 'Personal', 'Study', 'Health', 'Finance'],
            notifications: [],
            currentUser: null,
            selectedTasks: [],
            activeTaskId: null,
            timerInterval: null,
            timerRunning: false,
            timerSeconds: 0,
            editingTaskId: null,
            filters: {
                status: 'all',
                category: 'all',
                priority: 'all',
                dueDate: 'all',
                search: '',
                customDateRange: {
                    start: null,
                    end: null
                }
            },
            sort: 'dateCreated-desc',
            undoStack: [],
            redoStack: [],
            viewMode: 'list'
        };

        // Helper Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatDateTime(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            
            toast.className = 'toast-notification';
            toast.classList.add(`toast-${type}`);
            
            if (type === 'success') {
                toastIcon.innerHTML = '✓';
            } else if (type === 'error') {
                toastIcon.innerHTML = '✗';
            } else if (type === 'info') {
                toastIcon.innerHTML = 'ℹ';
            } else if (type === 'warning') {
                toastIcon.innerHTML = '⚠';
            }
            
            toastMessage.textContent = message;
            toast.classList.add('active');
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 5000);
        }

        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function pushToUndoStack(action, data) {
            state.undoStack.push({ action, data });
            // Clear redo stack when a new action is performed
            state.redoStack = [];
        }

        function addNotification(title, message, taskId = null) {
            const notification = {
                id: generateId(),
                title,
                message,
                taskId,
                timestamp: new Date(),
                read: false
            };
            
            state.notifications.unshift(notification);
            updateNotificationBadges();
            saveNotificationsToLocalStorage();
            renderNotifications();
        }

        function markNotificationAsRead(id) {
            const notification = state.notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                updateNotificationBadges();
                saveNotificationsToLocalStorage();
                renderNotifications();
            }
        }

        function markAllNotificationsAsRead() {
            state.notifications.forEach(notification => {
                notification.read = true;
            });
            updateNotificationBadges();
            saveNotificationsToLocalStorage();
            renderNotifications();
        }

        function updateNotificationBadges() {
            const unreadCount = state.notifications.filter(n => !n.read).length;
            document.getElementById('notificationBadge').textContent = unreadCount;
            document.getElementById('profileNotificationBadge').textContent = unreadCount;
            
            if (unreadCount > 0) {
                document.getElementById('notificationBadge').style.display = 'flex';
                document.getElementById('profileNotificationBadge').style.display = 'flex';
            } else {
                document.getElementById('notificationBadge').style.display = 'none';
                document.getElementById('profileNotificationBadge').style.display = 'none';
            }
        }

        // Element Selectors
        const elements = {
            // Login and Registration
            loginPage: document.getElementById('loginPage'),
            loginGlow: document.getElementById('loginGlow'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            loginBtn: document.getElementById('loginBtn'),
            registerLink: document.getElementById('registerLink'),
            registerPopup: document.getElementById('registerPopup'),
            cancelRegisterBtn: document.getElementById('cancelRegisterBtn'),
            createAccountBtn: document.getElementById('createAccountBtn'),
            
            // App Container
            appContainer: document.getElementById('appContainer'),
            
            // Header
            userProfile: document.getElementById('userProfile'),
            profileDropdown: document.getElementById('profileDropdown'),
            viewProfileBtn: document.getElementById('viewProfileBtn'),
            switchModeBtn: document.getElementById('switchModeBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            themeToggle: document.getElementById('themeToggle'),
            notificationBell: document.getElementById('notificationBell'),
            notificationPopup: document.getElementById('notificationPopup'),
            markAllReadBtn: document.getElementById('markAllReadBtn'),
            taskTimer: document.getElementById('taskTimer'),
            
            // Navigation
            tasksBtn: document.getElementById('tasksBtn'),
            usersBtn: document.getElementById('usersBtn'),
            categoriesBtn: document.getElementById('categoriesBtn'),
            
            // Summary Cards
            totalTasksCount: document.getElementById('totalTasksCount'),
            completedTasksCount: document.getElementById('completedTasksCount'),
            pendingTasksCount: document.getElementById('pendingTasksCount'),
            
            // Tasks
            addTaskBtn: document.getElementById('addTaskBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            taskList: document.getElementById('taskList'),
            
            // Filters
            statusFilter: document.getElementById('statusFilter'),
            categoryFilter: document.getElementById('categoryFilter'),
            priorityFilter: document.getElementById('priorityFilter'),
            dueDateFilter: document.getElementById('dueDateFilter'),
            sortBy: document.getElementById('sortBy'),
            searchInput: document.getElementById('searchInput'),
            
            // View Toggle
            listViewBtn: document.getElementById('listViewBtn'),
            graphViewBtn: document.getElementById('graphViewBtn'),
            listView: document.getElementById('listView'),
            graphView: document.getElementById('graphView'),
            
            // Multi-Select Action Bar
            multiSelectBar: document.getElementById('multiSelectBar'),
            selectedCount: document.getElementById('selectedCount'),
            batchCompleteBtn: document.getElementById('batchCompleteBtn'),
            batchDeleteBtn: document.getElementById('batchDeleteBtn'),
            cancelSelectBtn: document.getElementById('cancelSelectBtn'),
            
            // Add Task Popup
            addTaskPopup: document.getElementById('addTaskPopup'),
            taskTitle: document.getElementById('taskTitle'),
            taskDescription: document.getElementById('taskDescription'),
            subtasksList: document.getElementById('subtasksList'),
            newSubtask: document.getElementById('newSubtask'),
            addSubtaskBtn: document.getElementById('addSubtaskBtn'),
            taskDueDate: document.getElementById('taskDueDate'),
            taskPriority: document.getElementById('taskPriority'),
            taskCategory: document.getElementById('taskCategory'),
            taskNotes: document.getElementById('taskNotes'),
            cancelAddTaskBtn: document.getElementById('cancelAddTaskBtn'),
            createTaskBtn: document.getElementById('createTaskBtn'),
            
            // View Task Popup
            viewTaskPopup: document.getElementById('viewTaskPopup'),
            viewTaskTitle: document.getElementById('viewTaskTitle'),
            viewTaskDescription: document.getElementById('viewTaskDescription'),
            viewSubtasksContainer: document.getElementById('viewSubtasksContainer'),
            viewSubtasksList: document.getElementById('viewSubtasksList'),
            viewTaskDueDate: document.getElementById('viewTaskDueDate'),
            viewTaskPriority: document.getElementById('viewTaskPriority'),
            viewTaskCategory: document.getElementById('viewTaskCategory'),
            viewTaskStatus: document.getElementById('viewTaskStatus'),
            viewTaskNotesContainer: document.getElementById('viewTaskNotesContainer'),
            viewTaskNotes: document.getElementById('viewTaskNotes'),
            closeViewTaskBtn: document.getElementById('closeViewTaskBtn'),
            shareTaskBtn: document.getElementById('shareTaskBtn'),
            
            // Edit Task Popup
            editTaskPopup: document.getElementById('editTaskPopup'),
            editTaskTitle: document.getElementById('editTaskTitle'),
            editTaskDescription: document.getElementById('editTaskDescription'),
            editSubtasksList: document.getElementById('editSubtasksList'),
            editNewSubtask: document.getElementById('editNewSubtask'),
            editAddSubtaskBtn: document.getElementById('editAddSubtaskBtn'),
            editTaskDueDate: document.getElementById('editTaskDueDate'),
            editTaskPriority: document.getElementById('editTaskPriority'),
            editTaskCategory: document.getElementById('editTaskCategory'),
            editTaskNotes: document.getElementById('editTaskNotes'),
            cancelEditTaskBtn: document.getElementById('cancelEditTaskBtn'),
            saveTaskBtn: document.getElementById('saveTaskBtn'),
            
            // Export Popup
            exportPopup: document.getElementById('exportPopup'),
            exportFormat: document.getElementById('exportFormat'),
            cancelExportBtn: document.getElementById('cancelExportBtn'),
            confirmExportBtn: document.getElementById('confirmExportBtn'),
            
            // Import Popup
            importPopup: document.getElementById('importPopup'),
            importMethod: document.getElementById('importMethod'),
            fileUploadContainer: document.getElementById('fileUploadContainer'),
            urlImportContainer: document.getElementById('urlImportContainer'),
            fileUpload: document.getElementById('fileUpload'),
            importUrl: document.getElementById('importUrl'),
            cancelImportBtn: document.getElementById('cancelImportBtn'),
            confirmImportBtn: document.getElementById('confirmImportBtn'),
            
            // Profile Popup
            viewProfilePopup: document.getElementById('viewProfilePopup'),
            profilePicture: document.getElementById('profilePicture'),
            uploadProfilePictureBtn: document.getElementById('uploadProfilePictureBtn'),
            profilePictureUpload: document.getElementById('profilePictureUpload'),
            profileFullName: document.getElementById('profileFullName'),
            profileEmail: document.getElementById('profileEmail'),
            profileRole: document.getElementById('profileRole'),
            profileCountry: document.getElementById('profileCountry'),
            profileJoiningDate: document.getElementById('profileJoiningDate'),
            closeProfileBtn: document.getElementById('closeProfileBtn'),
            editProfileBtn: document.getElementById('editProfileBtn'),
            
            // Edit Profile Popup
            editProfilePopup: document.getElementById('editProfilePopup'),
            editProfilePicture: document.getElementById('editProfilePicture'),
            editUploadProfilePictureBtn: document.getElementById('editUploadProfilePictureBtn'),
            editProfilePictureUpload: document.getElementById('editProfilePictureUpload'),
            editProfileFirstName: document.getElementById('editProfileFirstName'),
            editProfileLastName: document.getElementById('editProfileLastName'),
            editProfileEmail: document.getElementById('editProfileEmail'),
            editProfileCountry: document.getElementById('editProfileCountry'),
            cancelEditProfileBtn: document.getElementById('cancelEditProfileBtn'),
            saveProfileBtn: document.getElementById('saveProfileBtn'),
            
            // Users Popup
            usersPopup: document.getElementById('usersPopup'),
            usersList: document.getElementById('usersList'),
            closeUsersBtn: document.getElementById('closeUsersBtn'),
            
            // Categories Popup
            categoriesPopup: document.getElementById('categoriesPopup'),
            newCategory: document.getElementById('newCategory'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            categoriesList: document.getElementById('categoriesList'),
            closeCategoriesBtn: document.getElementById('closeCategoriesBtn'),
            
            // Date Range Popup
            dateRangePopup: document.getElementById('dateRangePopup'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            cancelDateRangeBtn: document.getElementById('cancelDateRangeBtn'),
            applyDateRangeBtn: document.getElementById('applyDateRangeBtn'),
            
            // Share Task Popup
            shareTaskPopup: document.getElementById('shareTaskPopup'),
            shareTaskName: document.getElementById('shareTaskName'),
            closeShareTaskBtn: document.getElementById('closeShareTaskBtn')
        };

        // Login Page Effects
        elements.loginPage.addEventListener('mousemove', (e) => {
            const x = e.clientX;
            const y = e.clientY;
            elements.loginGlow.style.transform = `translate(${x - 75}px, ${y - 75}px)`;
        });

        // Registration Popup
        elements.registerLink.addEventListener('click', () => {
            elements.registerPopup.classList.add('active');
        });

        elements.cancelRegisterBtn.addEventListener('click', () => {
            elements.registerPopup.classList.remove('active');
        });

        // Handle Login
        elements.loginBtn.addEventListener('click', () => {
            const email = elements.email.value.trim();
            const password = elements.password.value.trim();
            let valid = true;
            
            // Simple validation
            if (!email || !email.includes('@')) {
                document.getElementById('emailError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('emailError').style.display = 'none';
            }
            
            if (!password || password.length < 6) {
                document.getElementById('passwordError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('passwordError').style.display = 'none';
            }
            
            if (valid) {
                // Check if user exists
                const users = JSON.parse(localStorage.getItem('todoAppUsers') || '[]');
                const user = users.find(u => u.email === email && u.password === password);
                
                if (user) {
                    // Login successful
                    state.currentUser = user;
                    localStorage.setItem('todoAppCurrentUser', JSON.stringify(user));
                    
                    // Show app container
                    elements.loginPage.style.display = 'none';
                    elements.appContainer.style.display = 'flex';
                    
                    // Initialize app
                    initializeApp();
                } else {
                    // Create a default user if none exists
                    if (email === "test@example.com" && password === "123456") {
                        const defaultUser = {
                            id: generateId(),
                            firstName: 'John',
                            lastName: 'Doe',
                            email: 'test@example.com',
                            password: '123456',
                            birthdate: '1990-01-01',
                            nationality: 'United States',
                            role: 'Admin',
                            joiningDate: new Date(),
                            profilePicture: 'https://randomuser.me/api/portraits/men/1.jpg'
                        };
                        
                        users.push(defaultUser);
                        localStorage.setItem('todoAppUsers', JSON.stringify(users));
                        
                        state.currentUser = defaultUser;
                        localStorage.setItem('todoAppCurrentUser', JSON.stringify(defaultUser));
                        
                        // Show app container
                        elements.loginPage.style.display = 'none';
                        elements.appContainer.style.display = 'flex';
                        
                        // Initialize app
                        initializeApp();
                    } else {
                        showToast('Invalid email or password', 'error');
                    }
                }
            }
        });

        // Handle Registration
        elements.createAccountBtn.addEventListener('click', () => {
            const lastName = document.getElementById('regLastName').value.trim();
            const firstName = document.getElementById('regFirstName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const confirmEmail = document.getElementById('regConfirmEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
            const birthdate = document.getElementById('regBirthdate').value.trim();
            const nationality = document.getElementById('regNationality').value.trim();
            const role = document.getElementById('regRole').value.trim();
            
            let valid = true;
            
            // Simple validation
            if (!lastName) {
                document.getElementById('lastNameError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('lastNameError').style.display = 'none';
            }
            
            if (!firstName) {
                document.getElementById('firstNameError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('firstNameError').style.display = 'none';
            }
            
            if (!email || !email.includes('@')) {
                document.getElementById('regEmailError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('regEmailError').style.display = 'none';
            }
            
            if (email !== confirmEmail) {
                document.getElementById('confirmEmailError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('confirmEmailError').style.display = 'none';
            }
            
            if (!password || password.length < 6) {
                document.getElementById('regPasswordError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('regPasswordError').style.display = 'none';
            }
            
            if (password !== confirmPassword) {
                document.getElementById('confirmPasswordError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('confirmPasswordError').style.display = 'none';
            }
            
            if (!birthdate) {
                document.getElementById('birthdateError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('birthdateError').style.display = 'none';
            }
            
            if (!nationality) {
                document.getElementById('nationalityError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('nationalityError').style.display = 'none';
            }
            
            if (!role) {
                document.getElementById('roleError').style.display = 'block';
                valid = false;
            } else {
                document.getElementById('roleError').style.display = 'none';
            }
            
            if (valid) {
                const users = JSON.parse(localStorage.getItem('todoAppUsers') || '[]');
                
                // Check if user already exists
                if (users.some(u => u.email === email)) {
                    showToast('Email already exists', 'error');
                    return;
                }
                
                // Create new user
                const newUser = {
                    id: generateId(),
                    firstName,
                    lastName,
                    email,
                    password,
                    birthdate,
                    nationality,
                    role,
                    joiningDate: new Date(),
                    profilePicture: 'https://randomuser.me/api/portraits/men/1.jpg'
                };
                
                users.push(newUser);
                localStorage.setItem('todoAppUsers', JSON.stringify(users));
                
                showToast('Account created successfully!', 'success');
                elements.registerPopup.classList.remove('active');
                
                // Auto-fill login form
                elements.email.value = email;
                elements.password.value = password;
            }
        });

        // Initialize Flatpickr for birthdate
        flatpickr("#regBirthdate", {
            altInput: true,
            altFormat: "F j, Y",
            dateFormat: "Y-m-d",
            maxDate: "today"
        });

        // Load countries for nationality dropdown
        async function loadCountries() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all');
                const countries = await response.json();
                
                const nationalitySelect = document.getElementById('regNationality');
                const editProfileCountrySelect = document.getElementById('editProfileCountry');
                
                // Sort countries by name
                countries.sort((a, b) => {
                    return a.name.common.localeCompare(b.name.common);
                });
                
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.name.common;
                    option.textContent = country.name.common;
                    
                    const option2 = option.cloneNode(true);
                    
                    nationalitySelect.appendChild(option);
                    editProfileCountrySelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Error loading countries:', error);
                
                // Fallback for countries in case the API fails
                const fallbackCountries = ['United States', 'United Kingdom', 'Canada', 'Australia', 'Germany', 'France', 'Japan', 'China', 'India', 'Brazil'];
                
                const nationalitySelect = document.getElementById('regNationality');
                const editProfileCountrySelect = document.getElementById('editProfileCountry');
                
                fallbackCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    
                    const option2 = option.cloneNode(true);
                    
                    nationalitySelect.appendChild(option);
                    editProfileCountrySelect.appendChild(option2);
                });
            }
        }

        loadCountries();

        // Initialize App
        function initializeApp() {
            // Load data from localStorage
            loadTasksFromLocalStorage();
            loadUsersFromLocalStorage();
            loadCategoriesFromLocalStorage();
            loadNotificationsFromLocalStorage();
            
            // Initialize UI
            initializeUI();
            
            // Render tasks
            renderTasks();
            updateTaskCounts();
            
            // Initialize charts
            initializeCharts();
            
            // Add welcome notification
            if (state.notifications.length === 0) {
                addNotification(
                    'Welcome to Todo App!',
                    `Welcome ${state.currentUser.firstName}! Start by adding your first task.`
                );
            }
        }

        // Initialize UI
        function initializeUI() {
            // Profile picture
            if (state.currentUser.profilePicture) {
                document.querySelector('#userProfile img').src = state.currentUser.profilePicture;
            }
            
            // Update profile info
            elements.profileFullName.textContent = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
            elements.profileEmail.textContent = state.currentUser.email;
            elements.profileRole.textContent = state.currentUser.role;
            elements.profileCountry.textContent = state.currentUser.nationality;
            elements.profileJoiningDate.textContent = formatDate(state.currentUser.joiningDate);
            
            // Initialize Flatpickr for task due date
            flatpickr("#taskDueDate", {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            flatpickr("#editTaskDueDate", {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d",
                minDate: "today"
            });
            
            flatpickr("#startDate", {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d"
            });
            
            flatpickr("#endDate", {
                altInput: true,
                altFormat: "F j, Y",
                dateFormat: "Y-m-d"
            });
            
            // Initialize category dropdowns
            updateCategoryDropdowns();
            
            // Set up event listeners
            setupEventListeners();
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Profile Dropdown
            elements.userProfile.addEventListener('click', () => {
                elements.profileDropdown.classList.toggle('active');
                elements.notificationPopup.classList.remove('active');
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!elements.userProfile.contains(e.target) && !elements.profileDropdown.contains(e.target)) {
                    elements.profileDropdown.classList.remove('active');
                }
                
                if (!elements.notificationBell.contains(e.target) && !elements.notificationPopup.contains(e.target)) {
                    elements.notificationPopup.classList.remove('active');
                }
            });
            
            // Theme Toggle
            elements.themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                
                if (document.documentElement.classList.contains('dark')) {
                    elements.themeToggle.textContent = '☀️';
                } else {
                    elements.themeToggle.textContent = '🌙';
                }
            });
            
            // Switch Mode from dropdown
            elements.switchModeBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                
                if (document.documentElement.classList.contains('dark')) {
                    elements.themeToggle.textContent = '☀️';
                } else {
                    elements.themeToggle.textContent = '🌙';
                }
                
                elements.profileDropdown.classList.remove('active');
            });
            
            // Logout
            elements.logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('todoAppCurrentUser');
                state.currentUser = null;
                
                // Show login page
                elements.appContainer.style.display = 'none';
                elements.loginPage.style.display = 'flex';
                elements.profileDropdown.classList.remove('active');
                
                // Reset timer
                clearInterval(state.timerInterval);
                state.timerRunning = false;
                state.timerSeconds = 0;
                elements.taskTimer.textContent = '00:00:00';
            });
            
            // View Profile
            elements.viewProfileBtn.addEventListener('click', () => {
                elements.profileDropdown.classList.remove('active');
                elements.viewProfilePopup.classList.add('active');
                
                // Update profile info
                elements.profilePicture.src = state.currentUser.profilePicture;
                elements.profileFullName.textContent = `${state.currentUser.firstName} ${state.currentUser.lastName}`;
                elements.profileEmail.textContent = state.currentUser.email;
                elements.profileRole.textContent = state.currentUser.role;
                elements.profileCountry.textContent = state.currentUser.nationality;
                elements.profileJoiningDate.textContent = formatDate(state.currentUser.joiningDate);
            });
            
            elements.closeProfileBtn.addEventListener('click', () => {
                elements.viewProfilePopup.classList.remove('active');
            });
            
            // Edit Profile
            elements.editProfileBtn.addEventListener('click', () => {
                elements.viewProfilePopup.classList.remove('active');
                elements.editProfilePopup.classList.add('active');
                
                // Populate form with current values
                elements.editProfilePicture.src = state.currentUser.profilePicture;
                elements.editProfileFirstName.value = state.currentUser.firstName;
                elements.editProfileLastName.value = state.currentUser.lastName;
                elements.editProfileEmail.value = state.currentUser.email;
                
                // Select current country in dropdown
                const countrySelect = elements.editProfileCountry;
                for (let i = 0; i < countrySelect.options.length; i++) {
                    if (countrySelect.options[i].value === state.currentUser.nationality) {
                        countrySelect.selectedIndex = i;
                        break;
                    }
                }
            });
            
            elements.cancelEditProfileBtn.addEventListener('click', () => {
                elements.editProfilePopup.classList.remove('active');
            });
            
            elements.saveProfileBtn.addEventListener('click', () => {
                // Update user info
                state.currentUser.firstName = elements.editProfileFirstName.value.trim();
                state.currentUser.lastName = elements.editProfileLastName.value.trim();
                state.currentUser.email = elements.editProfileEmail.value.trim();
                state.currentUser.nationality = elements.editProfileCountry.value;
                
                // Update localStorage
                const users = JSON.parse(localStorage.getItem('todoAppUsers') || '[]');
                const userIndex = users.findIndex(u => u.id === state.currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = state.currentUser;
                    localStorage.setItem('todoAppUsers', JSON.stringify(users));
                    localStorage.setItem('todoAppCurrentUser', JSON.stringify(state.currentUser));
                }
                
                elements.editProfilePopup.classList.remove('active');
                showToast('Profile updated successfully!', 'success');
            });
            
            // Profile Picture Upload
            elements.uploadProfilePictureBtn.addEventListener('click', () => {
                elements.profilePictureUpload.click();
            });
            
            elements.profilePictureUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        elements.profilePicture.src = e.target.result;
                        state.currentUser.profilePicture = e.target.result;
                        
                        // Update localStorage
                        const users = JSON.parse(localStorage.getItem('todoAppUsers') || '[]');
                        const userIndex = users.findIndex(u => u.id === state.currentUser.id);
                        if (userIndex !== -1) {
                            users[userIndex] = state.currentUser;
                            localStorage.setItem('todoAppUsers', JSON.stringify(users));
                            localStorage.setItem('todoAppCurrentUser', JSON.stringify(state.currentUser));
                        }
                        
                        // Update profile picture in header
                        document.querySelector('#userProfile img').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            elements.editUploadProfilePictureBtn.addEventListener('click', () => {
                elements.editProfilePictureUpload.click();
            });
            
            elements.editProfilePictureUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        elements.editProfilePicture.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Notification Bell
            elements.notificationBell.addEventListener('click', () => {
                elements.notificationPopup.classList.toggle('active');
                elements.profileDropdown.classList.remove('active');
            });
            
            // Mark All Notifications as Read
            elements.markAllReadBtn.addEventListener('click', () => {
                markAllNotificationsAsRead();
            });
            
            // Navigation
            elements.tasksBtn.addEventListener('click', () => {
                // Tasks view is the default
            });
            
            elements.usersBtn.addEventListener('click', () => {
                elements.usersPopup.classList.add('active');
                renderUsers();
            });
            
            elements.closeUsersBtn.addEventListener('click', () => {
                elements.usersPopup.classList.remove('active');
            });
            
            elements.categoriesBtn.addEventListener('click', () => {
                elements.categoriesPopup.classList.add('active');
                renderCategories();
            });
            
            elements.closeCategoriesBtn.addEventListener('click', () => {
                elements.categoriesPopup.classList.remove('active');
            });
            
            // Add Category
            elements.addCategoryBtn.addEventListener('click', () => {
                const newCategory = elements.newCategory.value.trim();
                if (newCategory && !state.categories.includes(newCategory)) {
                    state.categories.push(newCategory);
                    elements.newCategory.value = '';
                    
                    saveCategoriestoLocalStorage();
                    renderCategories();
                    updateCategoryDropdowns();
                    showToast(`Category "${newCategory}" added successfully!`, 'success');
                } else if (state.categories.includes(newCategory)) {
                    showToast('Category already exists!', 'error');
                }
            });
            
            // Add Task
            elements.addTaskBtn.addEventListener('click', () => {
                elements.addTaskPopup.classList.add('active');
                elements.taskTitle.value = '';
                elements.taskDescription.value = '';
                elements.subtasksList.innerHTML = '';
                elements.newSubtask.value = '';
                elements.taskDueDate.value = '';
                elements.taskPriority.value = 'medium';
                elements.taskNotes.value = '';
                
                // Clear any error messages
                document.getElementById('taskTitleError').style.display = 'none';
                document.getElementById('taskDueDateError').style.display = 'none';
            });
            
            elements.cancelAddTaskBtn.addEventListener('click', () => {
                elements.addTaskPopup.classList.remove('active');
            });
            
            // Add Subtask
            elements.addSubtaskBtn.addEventListener('click', () => {
                const subtaskText = elements.newSubtask.value.trim();
                if (subtaskText) {
                    const subtaskId = generateId();
                    const subtaskHtml = `
                        <div class="subtask-item" data-id="${subtaskId}">
                            <input type="checkbox" class="subtask-checkbox">
                            <span class="subtask-title">${subtaskText}</span>
                            <button class="btn btn-danger" style="padding: 2px 5px;" onclick="removeSubtask('${subtaskId}', 'add')">✕</button>
                        </div>
                    `;
                    elements.subtasksList.insertAdjacentHTML('beforeend', subtaskHtml);
                    elements.newSubtask.value = '';
                }
            });
            
            // Edit Add Subtask
            elements.editAddSubtaskBtn.addEventListener('click', () => {
                const subtaskText = elements.editNewSubtask.value.trim();
                if (subtaskText) {
                    const subtaskId = generateId();
                    const subtaskHtml = `
                        <div class="subtask-item" data-id="${subtaskId}">
                            <input type="checkbox" class="subtask-checkbox">
                            <span class="subtask-title">${subtaskText}</span>
                            <button class="btn btn-danger" style="padding: 2px 5px;" onclick="removeSubtask('${subtaskId}', 'edit')">✕</button>
                        </div>
                    `;
                    elements.editSubtasksList.insertAdjacentHTML('beforeend', subtaskHtml);
                    elements.editNewSubtask.value = '';
                }
            });
            
            // Create Task
            elements.createTaskBtn.addEventListener('click', () => {
                const title = elements.taskTitle.value.trim();
                const description = elements.taskDescription.value.trim();
                const dueDate = elements.taskDueDate.value;
                const priority = elements.taskPriority.value;
                const category = elements.taskCategory.value;
                const notes = elements.taskNotes.value.trim();
                
                let valid = true;
                
                if (!title) {
                    document.getElementById('taskTitleError').style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById('taskTitleError').style.display = 'none';
                }
                
                if (!dueDate) {
                    document.getElementById('taskDueDateError').style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById('taskDueDateError').style.display = 'none';
                }
                
                if (valid) {
                    // Get subtasks
                    const subtasks = [];
                    document.querySelectorAll('#subtasksList .subtask-item').forEach(item => {
                        subtasks.push({
                            id: item.dataset.id,
                            title: item.querySelector('.subtask-title').textContent,
                            completed: item.querySelector('.subtask-checkbox').checked
                        });
                    });
                    
                    // Create task
                    const newTask = {
                        id: generateId(),
                        title,
                        description,
                        subtasks,
                        dueDate,
                        priority,
                        category,
                        notes,
                        completed: false,
                        dateCreated: new Date(),
                        timeSpent: 0
                    };
                    
                    // Add to state and save
                    state.tasks.push(newTask);
                    saveTasksToLocalStorage();
                    
                    // Add to undo stack
                    pushToUndoStack('create', { task: newTask });
                    
                    // Close popup and render tasks
                    elements.addTaskPopup.classList.remove('active');
                    renderTasks();
                    updateTaskCounts();
                    
                    // Update charts
                    updateCharts();
                    
                    // Show notification
                    addNotification('Task Created', `"${title}" has been created.`);
                    showToast(`Task "${title}" created successfully!`, 'success');
                }
            });
            
            // View Task
            // The event listeners for view buttons are added in the renderTasks function
            elements.closeViewTaskBtn.addEventListener('click', () => {
                elements.viewTaskPopup.classList.remove('active');
            });
            
            // Share Task
            elements.shareTaskBtn.addEventListener('click', () => {
                const taskId = elements.viewTaskTitle.dataset.taskId;
                const task = state.tasks.find(t => t.id === taskId);
                
                if (task) {
                    elements.viewTaskPopup.classList.remove('active');
                    elements.shareTaskPopup.classList.add('active');
                    elements.shareTaskName.textContent = `Share "${task.title}"`;
                }
            });
            
            // Share options
            document.querySelectorAll('.share-option').forEach(option => {
                option.addEventListener('click', () => {
                    const platform = option.dataset.platform;
                    const taskId = elements.shareTaskName.dataset.taskId;
                    const task = state.tasks.find(t => t.id === taskId || elements.viewTaskTitle.dataset.taskId);
                    
                    if (task) {
                        shareTask(task, platform);
                    }
                });
            });
            
            elements.closeShareTaskBtn.addEventListener('click', () => {
                elements.shareTaskPopup.classList.remove('active');
            });
            
            // Save Edited Task
            elements.saveTaskBtn.addEventListener('click', () => {
                const title = elements.editTaskTitle.value.trim();
                const description = elements.editTaskDescription.value.trim();
                const dueDate = elements.editTaskDueDate.value;
                const priority = elements.editTaskPriority.value;
                const category = elements.editTaskCategory.value;
                const notes = elements.editTaskNotes.value.trim();
                
                let valid = true;
                
                if (!title) {
                    document.getElementById('editTaskTitleError').style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById('editTaskTitleError').style.display = 'none';
                }
                
                if (!dueDate) {
                    document.getElementById('editTaskDueDateError').style.display = 'block';
                    valid = false;
                } else {
                    document.getElementById('editTaskDueDateError').style.display = 'none';
                }
                
                if (valid && state.editingTaskId) {
                    // Get subtasks
                    const subtasks = [];
                    document.querySelectorAll('#editSubtasksList .subtask-item').forEach(item => {
                        subtasks.push({
                            id: item.dataset.id,
                            title: item.querySelector('.subtask-title').textContent,
                            completed: item.querySelector('.subtask-checkbox').checked
                        });
                    });
                    
                    // Find task to edit
                    const taskIndex = state.tasks.findIndex(t => t.id === state.editingTaskId);
                    if (taskIndex !== -1) {
                        const oldTask = { ...state.tasks[taskIndex] };
                        
                        // Update task
                        state.tasks[taskIndex].title = title;
                        state.tasks[taskIndex].description = description;
                        state.tasks[taskIndex].subtasks = subtasks;
                        state.tasks[taskIndex].dueDate = dueDate;
                        state.tasks[taskIndex].priority = priority;
                        state.tasks[taskIndex].category = category;
                        state.tasks[taskIndex].notes = notes;
                        
                        // Save changes
                        saveTasksToLocalStorage();
                        
                        // Add to undo stack
                        pushToUndoStack('edit', { oldTask, newTask: { ...state.tasks[taskIndex] } });
                        
                        // Close popup and render tasks
                        elements.editTaskPopup.classList.remove('active');
                        renderTasks();
                        updateTaskCounts();
                        
                        // Update charts
                        updateCharts();
                        
                        // Show notification
                        addNotification('Task Updated', `"${title}" has been updated.`);
                        showToast(`Task "${title}" updated successfully!`, 'success');
                    }
                }
            });
            
            elements.cancelEditTaskBtn.addEventListener('click', () => {
                elements.editTaskPopup.classList.remove('active');
            });
            
            // Export
            elements.exportBtn.addEventListener('click', () => {
                elements.exportPopup.classList.add('active');
            });
            
            elements.cancelExportBtn.addEventListener('click', () => {
                elements.exportPopup.classList.remove('active');
            });
            
            elements.confirmExportBtn.addEventListener('click', () => {
                const format = elements.exportFormat.value;
                exportTasks(format);
                elements.exportPopup.classList.remove('active');
            });
            
            // Import
            elements.importBtn.addEventListener('click', () => {
                elements.importPopup.classList.add('active');
            });
            
            elements.cancelImportBtn.addEventListener('click', () => {
                elements.importPopup.classList.remove('active');
            });
            
            elements.importMethod.addEventListener('change', () => {
                const method = elements.importMethod.value;
                if (method === 'file') {
                    elements.fileUploadContainer.style.display = 'block';
                    elements.urlImportContainer.style.display = 'none';
                } else {
                    elements.fileUploadContainer.style.display = 'none';
                    elements.urlImportContainer.style.display = 'block';
                }
            });
            
            elements.confirmImportBtn.addEventListener('click', () => {
                const method = elements.importMethod.value;
                if (method === 'file') {
                    const file = elements.fileUpload.files[0];
                    if (file) {
                        importTasksFromFile(file);
                    } else {
                        showToast('Please select a file', 'error');
                    }
                } else {
                    const url = elements.importUrl.value.trim();
                    if (url) {
                        importTasksFromUrl(url);
                    } else {
                        showToast('Please enter a valid URL', 'error');
                    }
                }
            });
            
            // Filters
            elements.statusFilter.addEventListener('change', () => {
                state.filters.status = elements.statusFilter.value;
                renderTasks();
            });
            
            elements.categoryFilter.addEventListener('change', () => {
                state.filters.category = elements.categoryFilter.value;
                renderTasks();
            });
            
            elements.priorityFilter.addEventListener('change', () => {
                state.filters.priority = elements.priorityFilter.value;
                renderTasks();
            });
            
            elements.dueDateFilter.addEventListener('change', () => {
                const value = elements.dueDateFilter.value;
                state.filters.dueDate = value;
                
                if (value === 'custom') {
                    elements.dateRangePopup.classList.add('active');
                } else {
                    renderTasks();
                }
            });
            
            elements.cancelDateRangeBtn.addEventListener('click', () => {
                elements.dateRangePopup.classList.remove('active');
                elements.dueDateFilter.value = 'all';
                state.filters.dueDate = 'all';
                renderTasks();
            });
            
            elements.applyDateRangeBtn.addEventListener('click', () => {
                const startDate = elements.startDate.value;
                const endDate = elements.endDate.value;
                
                if (startDate && endDate) {
                    state.filters.customDateRange.start = startDate;
                    state.filters.customDateRange.end = endDate;
                    elements.dateRangePopup.classList.remove('active');
                    renderTasks();
                } else {
                    showToast('Please select both start and end dates', 'warning');
                }
            });
            
            elements.sortBy.addEventListener('change', () => {
                state.sort = elements.sortBy.value;
                renderTasks();
            });
            
            // Search debounce
            let searchTimeout;
            elements.searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.filters.search = elements.searchInput.value.trim().toLowerCase();
                    renderTasks();
                }, 300);
            });
            
            // View toggle
            elements.listViewBtn.addEventListener('click', () => {
                state.viewMode = 'list';
                elements.listViewBtn.classList.add('active');
                elements.graphViewBtn.classList.remove('active');
                elements.listView.classList.remove('hidden');
                elements.graphView.classList.remove('active');
            });
            
            elements.graphViewBtn.addEventListener('click', () => {
                state.viewMode = 'graph';
                elements.graphViewBtn.classList.add('active');
                elements.listViewBtn.classList.remove('active');
                elements.listView.classList.add('hidden');
                elements.graphView.classList.add('active');
                updateCharts();
            });
            
            // Multi-select bar
            elements.batchCompleteBtn.addEventListener('click', () => {
                if (state.selectedTasks.length > 0) {
                    state.tasks.forEach(task => {
                        if (state.selectedTasks.includes(task.id)) {
                            task.completed = true;
                        }
                    });
                    
                    saveTasksToLocalStorage();
                    renderTasks();
                    updateTaskCounts();
                    updateCharts();
                    
                    showToast(`${state.selectedTasks.length} tasks marked as complete`, 'success');
                    addNotification('Tasks Updated', `${state.selectedTasks.length} tasks marked as complete.`);
                    
                    state.selectedTasks = [];
                    elements.multiSelectBar.classList.remove('active');
                }
            });
            
            elements.batchDeleteBtn.addEventListener('click', () => {
                if (state.selectedTasks.length > 0) {
                    // Store tasks before deletion for undo
                    const deletedTasks = state.tasks.filter(task => state.selectedTasks.includes(task.id));
                    
                    // Remove tasks
                    state.tasks = state.tasks.filter(task => !state.selectedTasks.includes(task.id));
                    
                    saveTasksToLocalStorage();
                    renderTasks();
                    updateTaskCounts();
                    updateCharts();
                    
                    // Add to undo stack
                    pushToUndoStack('batchDelete', { tasks: deletedTasks });
                    
                    showToast(`${state.selectedTasks.length} tasks deleted`, 'success');
                    addNotification('Tasks Deleted', `${state.selectedTasks.length} tasks were deleted.`);
                    
                    state.selectedTasks = [];
                    elements.multiSelectBar.classList.remove('active');
                }
            });
            
            elements.cancelSelectBtn.addEventListener('click', () => {
                state.selectedTasks = [];
                renderTasks();
                elements.multiSelectBar.classList.remove('active');
            });
        }

        // Task Rendering
        function renderTasks() {
            const taskList = elements.taskList;
            taskList.innerHTML = '';
            
            // Filter tasks
            let filteredTasks = filterTasks();
            
            // Sort tasks
            filteredTasks = sortTasks(filteredTasks);
            
            // Render each task
            filteredTasks.forEach(task => {
                const isExpired = new Date(task.dueDate) < new Date() && !task.completed;
                const isDueSoon = !isExpired && !task.completed && isTaskDueSoon(task);
                
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.completed ? 'completed' : ''} ${isExpired ? 'expired' : ''} ${isDueSoon ? 'due-soon' : ''}`;
                taskElement.dataset.id = task.id;
                taskElement.draggable = true;
                
                // Add multi-select checkbox
                const isSelected = state.selectedTasks.includes(task.id);
                
                taskElement.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" class="task-select-checkbox" ${isSelected ? 'checked' : ''}>
                        <div class="task-content">
                            <h3 class="task-title">${task.title}</h3>
                            <p class="task-description">${task.description}</p>
                            <div class="task-meta">
                                <span class="task-due-date">Due: ${formatDate(task.dueDate)}</span>
                                <span class="task-priority priority-${task.priority}">
                                    ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                                </span>
                                <span class="task-category">${task.category}</span>
                            </div>
                            
                            ${task.subtasks.length > 0 ? `
                                <div class="subtask-list">
                                    ${task.subtasks.map(subtask => `
                                        <div class="subtask-item">
                                            <input type="checkbox" class="subtask-checkbox" 
                                                data-task-id="${task.id}" 
                                                data-subtask-id="${subtask.id}" 
                                                ${subtask.completed ? 'checked' : ''}>
                                            <span class="subtask-title">${subtask.title}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-action-btn view-btn" title="View Task">👁️</button>
                        <button class="task-action-btn edit-btn" title="Edit Task">✏️</button>
                        <button class="task-action-btn delete-btn" title="Delete Task">🗑️</button>
                        <button class="task-action-btn ${state.activeTaskId === task.id ? 'pause-btn' : 'play-btn'}" title="${state.activeTaskId === task.id ? 'Pause Timer' : 'Start Timer'}">
                            ${state.activeTaskId === task.id ? '⏸️' : '▶️'}
                        </button>
                        <button class="task-action-btn share-btn" title="Share Task">📤</button>
                        <label class="toggle-switch">
                            <input type="checkbox" ${task.completed ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                
                taskList.appendChild(taskElement);
                
                // Add event listeners to the task item
                const viewBtn = taskElement.querySelector('.view-btn');
                const editBtn = taskElement.querySelector('.edit-btn');
                const deleteBtn = taskElement.querySelector('.delete-btn');
                const playPauseBtn = taskElement.querySelector('.play-btn, .pause-btn');
                const shareBtn = taskElement.querySelector('.share-btn');
                const toggleSwitch = taskElement.querySelector('.toggle-switch input');
                const selectCheckbox = taskElement.querySelector('.task-select-checkbox');
                
                // View task
                viewBtn.addEventListener('click', () => {
                    viewTask(task.id);
                });
                
                // Edit task
                editBtn.addEventListener('click', () => {
                    editTask(task.id);
                });
                
                // Delete task
                deleteBtn.addEventListener('click', () => {
                    deleteTask(task.id);
                });
                
                // Play/Pause task timer
                playPauseBtn.addEventListener('click', () => {
                    toggleTaskTimer(task.id);
                });
                
                // Share task
                shareBtn.addEventListener('click', () => {
                    elements.shareTaskPopup.classList.add('active');
                    elements.shareTaskName.textContent = `Share "${task.title}"`;
                    elements.shareTaskName.dataset.taskId = task.id;
                });
                
                // Toggle task completion
                toggleSwitch.addEventListener('change', () => {
                    toggleTaskCompletion(task.id);
                });
                
                // Multi-select checkbox
                selectCheckbox.addEventListener('change', () => {
                    if (selectCheckbox.checked) {
                        if (!state.selectedTasks.includes(task.id)) {
                            state.selectedTasks.push(task.id);
                        }
                    } else {
                        state.selectedTasks = state.selectedTasks.filter(id => id !== task.id);
                    }
                    
                    updateMultiSelectBar();
                });
                
                // Subtask checkboxes
                taskElement.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const taskId = checkbox.dataset.taskId;
                        const subtaskId = checkbox.dataset.subtaskId;
                        
                        const taskIndex = state.tasks.findIndex(t => t.id === taskId);
                        if (taskIndex !== -1) {
                            const subtaskIndex = state.tasks[taskIndex].subtasks.findIndex(s => s.id === subtaskId);
                            if (subtaskIndex !== -1) {
                                state.tasks[taskIndex].subtasks[subtaskIndex].completed = checkbox.checked;
                                saveTasksToLocalStorage();
                            }
                        }
                    });
                });
                
                // Drag and drop
                taskElement.addEventListener('dragstart', handleDragStart);
                taskElement.addEventListener('dragover', handleDragOver);
                taskElement.addEventListener('drop', handleDrop);
                taskElement.addEventListener('dragend', handleDragEnd);
            });
            
            // Show empty state if no tasks
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `
                    <div style="text-align: center; padding: 50px 0;">
                        <h3 style="margin-bottom: 10px; color: var(--text-color);">No tasks found</h3>
                        <p style="color: var(--text-color); opacity: 0.7;">Try adjusting your filters or add a new task</p>
                    </div>
                `;
            }
        }

        // Filter Tasks
        function filterTasks() {
            return state.tasks.filter(task => {
                // Status filter
                if (state.filters.status === 'active' && task.completed) return false;
                if (state.filters.status === 'completed' && !task.completed) return false;
                
                // Category filter
                if (state.filters.category !== 'all' && task.category !== state.filters.category) return false;
                
                // Priority filter
                if (state.filters.priority !== 'all' && task.priority !== state.filters.priority) return false;
                
                // Due date filter
                if (!passesDueDateFilter(task)) return false;
                
                // Search filter
                if (state.filters.search) {
                    const searchTerm = state.filters.search.toLowerCase();
                    const titleMatch = task.title.toLowerCase().includes(searchTerm);
                    const descMatch = task.description.toLowerCase().includes(searchTerm);
                    if (!titleMatch && !descMatch) return false;
                }
                
                return true;
            });
        }

        // Check if a task passes the due date filter
        function passesDueDateFilter(task) {
            if (state.filters.dueDate === 'all') return true;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const taskDueDate = new Date(task.dueDate);
            taskDueDate.setHours(0, 0, 0, 0);
            
            if (state.filters.dueDate === 'today') {
                return taskDueDate.getTime() === today.getTime();
            }
            
            if (state.filters.dueDate === 'week') {
                const weekFromNow = new Date(today);
                weekFromNow.setDate(today.getDate() + 7);
                return taskDueDate >= today && taskDueDate <= weekFromNow;
            }
            
            if (state.filters.dueDate === 'month') {
                const monthFromNow = new Date(today);
                monthFromNow.setMonth(today.getMonth() + 1);
                return taskDueDate >= today && taskDueDate <= monthFromNow;
            }
            
            if (state.filters.dueDate === 'custom' && state.filters.customDateRange.start && state.filters.customDateRange.end) {
                const startDate = new Date(state.filters.customDateRange.start);
                startDate.setHours(0, 0, 0, 0);
                
                const endDate = new Date(state.filters.customDateRange.end);
                endDate.setHours(23, 59, 59, 999);
                
                return taskDueDate >= startDate && taskDueDate <= endDate;
            }
            
            return true;
        }

        // Sort Tasks
        function sortTasks(tasks) {
            const [sortBy, direction] = state.sort.split('-');
            
            return [...tasks].sort((a, b) => {
                if (sortBy === 'dateCreated') {
                    return direction === 'asc'
                        ? new Date(a.dateCreated) - new Date(b.dateCreated)
                        : new Date(b.dateCreated) - new Date(a.dateCreated);
                }
                
                if (sortBy === 'dueDate') {
                    return direction === 'asc'
                        ? new Date(a.dueDate) - new Date(b.dueDate)
                        : new Date(b.dueDate) - new Date(a.dueDate);
                }
                
                if (sortBy === 'priority') {
                    const priorityMap = { high: 3, medium: 2, low: 1 };
                    return direction === 'asc'
                        ? priorityMap[a.priority] - priorityMap[b.priority]
                        : priorityMap[b.priority] - priorityMap[a.priority];
                }
                
                if (sortBy === 'title') {
                    return direction === 'asc'
                        ? a.title.localeCompare(b.title)
                        : b.title.localeCompare(a.title);
                }
                
                return 0;
            });
        }

        // Update Multi-Select Bar
        function updateMultiSelectBar() {
            const selectedCount = state.selectedTasks.length;
            elements.selectedCount.textContent = selectedCount;
            
            if (selectedCount > 0) {
                elements.multiSelectBar.classList.add('active');
            } else {
                elements.multiSelectBar.classList.remove('active');
            }
        }

        // Update Task Counts
        function updateTaskCounts() {
            const totalTasks = state.tasks.length;
            const completedTasks = state.tasks.filter(task => task.completed).length;
            const pendingTasks = totalTasks - completedTasks;
            
            elements.totalTasksCount.textContent = totalTasks;
            elements.completedTasksCount.textContent = completedTasks;
            elements.pendingTasksCount.textContent = pendingTasks;
        }

        // Task Actions
        // View Task
        function viewTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                elements.viewTaskTitle.textContent = task.title;
                elements.viewTaskTitle.dataset.taskId = task.id;
                elements.viewTaskDescription.textContent = task.description || 'No description';
                elements.viewTaskDueDate.textContent = formatDate(task.dueDate);
                elements.viewTaskPriority.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
                elements.viewTaskCategory.textContent = task.category;
                elements.viewTaskStatus.textContent = task.completed ? 'Completed' : 'Active';
                
                // Set priority color
                elements.viewTaskPriority.className = '';
                elements.viewTaskPriority.classList.add(`priority-${task.priority}`);
                elements.viewTaskPriority.style.padding = '2px 5px';
                elements.viewTaskPriority.style.borderRadius = '3px';
                elements.viewTaskPriority.style.color = 'white';
                
                // Notes
                if (task.notes) {
                    elements.viewTaskNotesContainer.style.display = 'block';
                    elements.viewTaskNotes.textContent = task.notes;
                } else {
                    elements.viewTaskNotesContainer.style.display = 'none';
                }
                
                // Subtasks
                if (task.subtasks && task.subtasks.length > 0) {
                    elements.viewSubtasksContainer.style.display = 'block';
                    elements.viewSubtasksList.innerHTML = '';
                    
                    task.subtasks.forEach(subtask => {
                        const subtaskElement = document.createElement('div');
                        subtaskElement.className = 'subtask-item';
                        subtaskElement.innerHTML = `
                            <input type="checkbox" class="subtask-checkbox" 
                                data-task-id="${task.id}" 
                                data-subtask-id="${subtask.id}" 
                                ${subtask.completed ? 'checked' : ''} disabled>
                            <span class="subtask-title">${subtask.title}</span>
                        `;
                        elements.viewSubtasksList.appendChild(subtaskElement);
                    });
                } else {
                    elements.viewSubtasksContainer.style.display = 'none';
                }
                
                elements.viewTaskPopup.classList.add('active');
            }
        }

        // Edit Task
        function editTask(taskId) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                state.editingTaskId = taskId;
                
                elements.editTaskTitle.value = task.title;
                elements.editTaskDescription.value = task.description || '';
                elements.editTaskDueDate.value = task.dueDate;
                elements.editTaskPriority.value = task.priority;
                elements.editTaskCategory.value = task.category;
                elements.editTaskNotes.value = task.notes || '';
                
                // Subtasks
                elements.editSubtasksList.innerHTML = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        const subtaskElement = document.createElement('div');
                        subtaskElement.className = 'subtask-item';
                        subtaskElement.dataset.id = subtask.id;
                        subtaskElement.innerHTML = `
                            <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
                            <span class="subtask-title">${subtask.title}</span>
                            <button class="btn btn-danger" style="padding: 2px 5px;" onclick="removeSubtask('${subtask.id}', 'edit')">✕</button>
                        `;
                        elements.editSubtasksList.appendChild(subtaskElement);
                    });
                }
                
                // Clear any error messages
                document.getElementById('editTaskTitleError').style.display = 'none';
                document.getElementById('editTaskDueDateError').style.display = 'none';
                
                elements.editTaskPopup.classList.add('active');
            }
        }

        // Delete Task
        function deleteTask(taskId) {
            const taskIndex = state.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                const deletedTask = state.tasks[taskIndex];
                
                // Remove from state
                state.tasks.splice(taskIndex, 1);
                saveTasksToLocalStorage();
                
                // Add to undo stack
                pushToUndoStack('delete', { task: deletedTask });
                
                // Re-render tasks
                renderTasks();
                updateTaskCounts();
                updateCharts();
                
                // If this was the active task, stop the timer
                if (state.activeTaskId === taskId) {
                    stopTaskTimer();
                }
                
                // Show notification
                addNotification('Task Deleted', `"${deletedTask.title}" has been deleted.`);
                showToast(`Task "${deletedTask.title}" deleted.`, 'success');
            }
        }

        // Toggle Task Completion
        function toggleTaskCompletion(taskId) {
            const taskIndex = state.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                const oldStatus = state.tasks[taskIndex].completed;
                state.tasks[taskIndex].completed = !oldStatus;
                
                // If task is active and now complete, stop the timer
                if (state.activeTaskId === taskId && state.tasks[taskIndex].completed) {
                    stopTaskTimer();
                }
                
                saveTasksToLocalStorage();
                
                // Add to undo stack
                pushToUndoStack('toggleComplete', { 
                    taskId, 
                    oldStatus, 
                    newStatus: state.tasks[taskIndex].completed 
                });
                
                // Re-render tasks
                renderTasks();
                updateTaskCounts();
                updateCharts();
                
                // Show notification
                const taskTitle = state.tasks[taskIndex].title;
                const status = state.tasks[taskIndex].completed ? 'completed' : 'active';
                addNotification('Task Updated', `"${taskTitle}" marked as ${status}.`);
                showToast(`Task "${taskTitle}" marked as ${status}.`, 'success');
            }
        }

        // Toggle Task Timer
        function toggleTaskTimer(taskId) {
            // If a different task is already active, stop that timer first
            if (state.activeTaskId && state.activeTaskId !== taskId) {
                stopTaskTimer();
            }
            
            // If this task is already active, stop the timer
            if (state.activeTaskId === taskId) {
                stopTaskTimer();
                return;
            }
            
            // Otherwise, start the timer for this task
            state.activeTaskId = taskId;
            state.timerRunning = true;
            
            // Update task and action button
            renderTasks();
            
            // Start the interval
            state.timerInterval = setInterval(() => {
                state.timerSeconds++;
                elements.taskTimer.textContent = formatTime(state.timerSeconds);
                
                // Update the active task's timeSpent
                const taskIndex = state.tasks.findIndex(task => task.id === state.activeTaskId);
                if (taskIndex !== -1) {
                    state.tasks[taskIndex].timeSpent = (state.tasks[taskIndex].timeSpent || 0) + 1;
                    saveTasksToLocalStorage();
                }
            }, 1000);
            
            // Show notification
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                showToast(`Timer started for "${task.title}".`, 'info');
            }
        }

        // Stop Task Timer
        function stopTaskTimer() {
            if (state.timerRunning) {
                clearInterval(state.timerInterval);
                
                // Show how much time was spent
                const task = state.tasks.find(t => t.id === state.activeTaskId);
                if (task) {
                    showToast(`Worked on "${task.title}" for ${formatTime(state.timerSeconds)}.`, 'info');
                    addNotification('Timer Stopped', `Worked on "${task.title}" for ${formatTime(state.timerSeconds)}.`);
                }
                
                state.timerRunning = false;
                state.activeTaskId = null;
                
                // Update UI
                renderTasks();
            }
        }

        // Is Task Due Soon (within 48 hours)
        function isTaskDueSoon(task) {
            const now = new Date();
            const dueDate = new Date(task.dueDate);
            const diffTime = dueDate - now;
            const diffHours = diffTime / (1000 * 60 * 60);
            
            return diffHours > 0 && diffHours <= 48;
        }

        // Update Category Dropdowns
        function updateCategoryDropdowns() {
            // Update category filter dropdown
            const categoryFilter = elements.categoryFilter;
            let filterOptionsHtml = '<option value="all">All Categories</option>';
            
            state.categories.forEach(category => {
                filterOptionsHtml += `<option value="${category}">${category}</option>`;
            });
            
            categoryFilter.innerHTML = filterOptionsHtml;
            
            // Update task category dropdowns
            const taskCategory = elements.taskCategory;
            const editTaskCategory = elements.editTaskCategory;
            let taskOptionsHtml = '';
            
            state.categories.forEach(category => {
                taskOptionsHtml += `<option value="${category}">${category}</option>`;
            });
            
            taskCategory.innerHTML = taskOptionsHtml;
            editTaskCategory.innerHTML = taskOptionsHtml;
        }

        // Remove Subtask
        window.removeSubtask = function(subtaskId, mode) {
            const container = mode === 'add' ? elements.subtasksList : elements.editSubtasksList;
            const subtaskItem = container.querySelector(`.subtask-item[data-id="${subtaskId}"]`);
            if (subtaskItem) {
                subtaskItem.remove();
            }
        };

        // Drag and Drop Functionality
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            e.preventDefault();
            if (draggedItem !== this) {
                // Get the task IDs
                const draggedTaskId = draggedItem.dataset.id;
                const targetTaskId = this.dataset.id;
                
                // Find the indices of the tasks in the state
                const draggedTaskIndex = state.tasks.findIndex(task => task.id === draggedTaskId);
                const targetTaskIndex = state.tasks.findIndex(task => task.id === targetTaskId);
                
                if (draggedTaskIndex !== -1 && targetTaskIndex !== -1) {
                    // Reorder tasks
                    const [draggedTask] = state.tasks.splice(draggedTaskIndex, 1);
                    state.tasks.splice(targetTaskIndex, 0, draggedTask);
                    
                    // Save changes
                    saveTasksToLocalStorage();
                    
                    // Re-render tasks
                    renderTasks();
                }
            }
            return false;
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            draggedItem = null;
        }

        // Export Tasks
        function exportTasks(format) {
            try {
                showLoadingOverlay();
                
                if (format === 'pdf') {
                    exportToPDF();
                } else if (format === 'json') {
                    exportToJSON();
                } else if (format === 'excel') {
                    exportToExcel();
                }
                
                hideLoadingOverlay();
                showToast('Tasks exported successfully!', 'success');
            } catch (error) {
                hideLoadingOverlay();
                showToast('Error exporting tasks: ' + error.message, 'error');
                console.error('Export error:', error);
            }
        }

        // Export to PDF
        function exportToPDF() {
            const { jspdf } = window.jspdf;
            const doc = new jspdf.jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.text('Tasks Export', 14, 22);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Add tasks
            doc.setFontSize(14);
            let y = 40;
            
            state.tasks.forEach((task, index) => {
                // Check if we need a new page
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${task.title} (${task.completed ? 'Completed' : 'Active'})`, 14, y);
                y += 7;
                
                doc.setFont(undefined, 'normal');
                if (task.description) {
                    const descLines = doc.splitTextToSize(task.description, 180);
                    doc.text(descLines, 20, y);
                    y += 7 * descLines.length;
                }
                
                doc.text(`Due: ${formatDate(task.dueDate)} | Priority: ${task.priority} | Category: ${task.category}`, 20, y);
                y += 7;
                
                if (task.subtasks && task.subtasks.length > 0) {
                    doc.text('Subtasks:', 20, y);
                    y += 7;
                    
                    task.subtasks.forEach(subtask => {
                        doc.text(`- ${subtask.title} ${subtask.completed ? '(Completed)' : ''}`, 25, y);
                        y += 7;
                    });
                }
                
                y += 5;
            });
            
            // Save the PDF
            doc.save('tasks-export.pdf');
        }

        // Export to JSON
        function exportToJSON() {
            const tasksJson = JSON.stringify(state.tasks, null, 2);
            const blob = new Blob([tasksJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a link to download the file
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tasks-export.json';
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export to Excel
        function exportToExcel() {
            const XLSX = window.XLSX;
            
            // Create a worksheet
            const ws = XLSX.utils.json_to_sheet(state.tasks.map(task => {
                return {
                    'Title': task.title,
                    'Description': task.description,
                    'Due Date': formatDate(task.dueDate),
                    'Priority': task.priority,
                    'Category': task.category,
                    'Status': task.completed ? 'Completed' : 'Active',
                    'Created': formatDate(task.dateCreated),
                    'Time Spent': formatTime(task.timeSpent || 0)
                };
            }));
            
            // Create a workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
            
            // Generate the file
            XLSX.writeFile(wb, 'tasks-export.xlsx');
        }

        // Import Tasks from File
        function importTasksFromFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    showLoadingOverlay();
                    
                    const content = e.target.result;
                    const importedTasks = JSON.parse(content);
                    
                    // Validate imported tasks
                    if (!Array.isArray(importedTasks)) {
                        throw new Error('Invalid import format. Expected an array of tasks.');
                    }
                    
                    // Add tasks to state
                    mergeImportedTasks(importedTasks);
                    
                    hideLoadingOverlay();
                    showToast(`${importedTasks.length} tasks imported successfully!`, 'success');
                    elements.importPopup.classList.remove('active');
                } catch (error) {
                    hideLoadingOverlay();
                    showToast('Error importing tasks: ' + error.message, 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }

        // Import Tasks from URL
        function importTasksFromUrl(url) {
            showLoadingOverlay();
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch from URL. Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(importedTasks => {
                    // Validate imported tasks
                    if (!Array.isArray(importedTasks)) {
                        throw new Error('Invalid import format. Expected an array of tasks.');
                    }
                    
                    // Add tasks to state
                    mergeImportedTasks(importedTasks);
                    
                    hideLoadingOverlay();
                    showToast(`${importedTasks.length} tasks imported successfully!`, 'success');
                    elements.importPopup.classList.remove('active');
                })
                .catch(error => {
                    hideLoadingOverlay();
                    showToast('Error importing tasks: ' + error.message, 'error');
                    console.error('Import error:', error);
                });
        }

        // Merge Imported Tasks
        function mergeImportedTasks(importedTasks) {
            // Generate unique IDs for imported tasks
            importedTasks.forEach(task => {
                const oldId = task.id;
                const newId = generateId();
                
                // Update task ID
                task.id = newId;
                
                // Update subtask references
                if (task.subtasks && task.subtasks.length > 0) {
                    task.subtasks.forEach(subtask => {
                        subtask.id = generateId();
                    });
                }
                
                // Ensure task has all required properties
                task.dateCreated = task.dateCreated || new Date();
                task.timeSpent = task.timeSpent || 0;
            });
            
            // Add tasks to state
            state.tasks = [...state.tasks, ...importedTasks];
            saveTasksToLocalStorage();
            
            // Re-render tasks
            renderTasks();
            updateTaskCounts();
            updateCharts();
            
            // Add notification
            addNotification('Tasks Imported', `${importedTasks.length} tasks have been imported.`);
        }

        // Share Task
        function shareTask(task, platform) {
            const taskDetails = `Task: ${task.title}\nDue: ${formatDate(task.dueDate)}\nPriority: ${task.priority}\nCategory: ${task.category}`;
            let shareUrl = '';
            
            switch (platform) {
                case 'email':
                    shareUrl = `mailto:?subject=Task: ${encodeURIComponent(task.title)}&body=${encodeURIComponent(taskDetails)}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(taskDetails)}`;
                    break;
                case 'slack':
                    // For demonstration purposes, we'll show a toast
                    showToast('Task copied for Slack sharing', 'success');
                    navigator.clipboard.writeText(taskDetails).catch(err => console.error('Clipboard error:', err));
                    elements.shareTaskPopup.classList.remove('active');
                    return;
                case 'teams':
                    // For demonstration purposes, we'll show a toast
                    showToast('Task copied for Teams sharing', 'success');
                    navigator.clipboard.writeText(taskDetails).catch(err => console.error('Clipboard error:', err));
                    elements.shareTaskPopup.classList.remove('active');
                    return;
                case 'link':
                    // For demonstration purposes, we'll copy to clipboard
                    showToast('Task link copied to clipboard', 'success');
                    navigator.clipboard.writeText(`${window.location.href}?task=${task.id}`).catch(err => console.error('Clipboard error:', err));
                    elements.shareTaskPopup.classList.remove('active');
                    return;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent('Check out this task: ' + task.title)}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent('Check out this task: ' + task.title)}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`;
                    break;
                default:
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank');
            }
            
            elements.shareTaskPopup.classList.remove('active');
        }

        // Charts
        function initializeCharts() {
            const categoryData = getCategoryData();
            const priorityData = getPriorityData();
            const roleData = getRoleData();
            const timelineData = getTimelineData();
            const statusData = getStatusData();
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.labels,
                    datasets: [{
                        data: categoryData.data,
                        backgroundColor: [
                            '#5D5CDE', '#28A745', '#FFC107', '#DC3545', '#6C757D',
                            '#20C997', '#17A2B8', '#FD7E14', '#6610F2', '#E83E8C'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
            
            // Priority Chart
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: priorityData.labels,
                    datasets: [{
                        label: 'Tasks by Priority',
                        data: priorityData.data,
                        backgroundColor: [
                            '#DC3545', // High - Red
                            '#FD7E14', // Medium - Orange
                            '#6C757D'  // Low - Gray
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
            
            // User Roles Chart
            const rolesCtx = document.getElementById('userRolesChart').getContext('2d');
            new Chart(rolesCtx, {
                type: 'pie',
                data: {
                    labels: roleData.labels,
                    datasets: [{
                        data: roleData.data,
                        backgroundColor: [
                            '#5D5CDE', '#28A745', '#FFC107', '#DC3545', '#6C757D'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
            
            // Timeline Chart
            const timelineCtx = document.getElementById('tasksChart').getContext('2d');
            new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: timelineData.labels,
                    datasets: [
                        {
                            label: 'Completed Tasks',
                            data: timelineData.completed,
                            borderColor: '#28A745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Pending Tasks',
                            data: timelineData.pending,
                            borderColor: '#FFC107',
                            backgroundColor: 'rgba(255, 193, 7, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        },
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
            
            // Status Pie Chart
            const statusCtx = document.getElementById('tasksPieChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [statusData.completed, statusData.pending],
                        backgroundColor: [
                            '#28A745', // Completed - Green
                            '#FFC107'  // Pending - Yellow
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-color')
                            }
                        }
                    }
                }
            });
        }

        // Update Charts
        function updateCharts() {
            // Only update if in graph view to save resources
            if (state.viewMode !== 'graph') return;
            
            // Remove old charts
            Chart.getChart('categoryChart')?.destroy();
            Chart.getChart('priorityChart')?.destroy();
            Chart.getChart('userRolesChart')?.destroy();
            Chart.getChart('tasksChart')?.destroy();
            Chart.getChart('tasksPieChart')?.destroy();
            
            // Re-initialize with updated data
            initializeCharts();
        }

        // Get Data for Charts
        function getCategoryData() {
            const categoryMap = {};
            
            state.tasks.forEach(task => {
                if (!categoryMap[task.category]) {
                    categoryMap[task.category] = 0;
                }
                categoryMap[task.category]++;
            });
            
            return {
                labels: Object.keys(categoryMap),
                data: Object.values(categoryMap)
            };
        }

        function getPriorityData() {
            const priorityMap = {
                high: 0,
                medium: 0,
                low: 0
            };
            
            state.tasks.forEach(task => {
                priorityMap[task.priority]++;
            });
            
            return {
                labels: ['High', 'Medium', 'Low'],
                data: [priorityMap.high, priorityMap.medium, priorityMap.low]
            };
        }

        function getRoleData() {
            const roleMap = {};
            
            // Include current user
            if (state.currentUser) {
                roleMap[state.currentUser.role] = 1;
            }
            
            // Add random roles for mock users
            const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
            const counts = [3, 5, 8, 2]; // Random counts for demonstration
            
            roles.forEach((role, index) => {
                if (!roleMap[role]) {
                    roleMap[role] = 0;
                }
                roleMap[role] += counts[index];
            });
            
            return {
                labels: Object.keys(roleMap),
                data: Object.values(roleMap)
            };
        }

        function getTimelineData() {
            // Generate last 7 days
            const labels = [];
            const completed = [];
            const pending = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                
                // Count tasks for this day
                let completedCount = 0;
                let pendingCount = 0;
                
                state.tasks.forEach(task => {
                    const taskDate = new Date(task.dateCreated);
                    if (taskDate.toDateString() === date.toDateString()) {
                        if (task.completed) {
                            completedCount++;
                        } else {
                            pendingCount++;
                        }
                    }
                });
                
                completed.push(completedCount);
                pending.push(pendingCount);
            }
            
            return {
                labels,
                completed,
                pending
            };
        }

        function getStatusData() {
            const completed = state.tasks.filter(task => task.completed).length;
            const pending = state.tasks.length - completed;
            
            return {
                completed,
                pending
            };
        }

        // Render Categories
        function renderCategories() {
            const categoriesList = elements.categoriesList;
            categoriesList.innerHTML = '';
            
            state.categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.style.display = 'flex';
                categoryElement.style.justifyContent = 'space-between';
                categoryElement.style.alignItems = 'center';
                categoryElement.style.padding = '10px';
                categoryElement.style.borderBottom = '1px solid var(--border-color)';
                
                categoryElement.innerHTML = `
                    <span>${category}</span>
                    <div>
                        <button class="btn btn-danger" style="padding: 5px 10px;" data-category="${category}">Delete</button>
                    </div>
                `;
                
                categoriesList.appendChild(categoryElement);
                
                // Add event listener for delete button
                const deleteButton = categoryElement.querySelector('.btn-danger');
                deleteButton.addEventListener('click', () => {
                    deleteCategory(category);
                });
            });
        }

        // Delete Category
        function deleteCategory(category) {
            // Check if category is in use
            const inUse = state.tasks.some(task => task.category === category);
            
            if (inUse) {
                showToast('Cannot delete category that is in use by tasks', 'error');
                return;
            }
            
            // Remove category
            state.categories = state.categories.filter(c => c !== category);
            saveCategoriestoLocalStorage();
            renderCategories();
            updateCategoryDropdowns();
            
            showToast(`Category "${category}" deleted successfully!`, 'success');
        }

        // Render Users
        function renderUsers() {
            const usersList = elements.usersList;
            usersList.innerHTML = '';
            
            // Add current user
            const currentUserElement = createUserCard(state.currentUser);
            usersList.appendChild(currentUserElement);
            
            // Add random users
            generateRandomUsers(8).forEach(user => {
                const userElement = createUserCard(user);
                usersList.appendChild(userElement);
            });
        }

        // Create User Card
        function createUserCard(user) {
            const userElement = document.createElement('div');
            userElement.className = 'user-card';
            userElement.style.backgroundColor = 'var(--card-background)';
            userElement.style.borderRadius = '10px';
            userElement.style.padding = '20px';
            userElement.style.boxShadow = '0 5px 15px var(--shadow-color)';
            userElement.style.transition = 'transform 0.3s, box-shadow 0.3s';
            userElement.style.cursor = 'pointer';
            
            userElement.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; margin-bottom: 15px;">
                        <img src="${user.profilePicture}" alt="${user.firstName}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <h3 style="margin: 0 0 5px; font-size: 18px; color: var(--text-color);">${user.firstName} ${user.lastName}</h3>
                    <p style="margin: 0 0 5px; font-size: 14px; color: var(--text-color); opacity: 0.8;">${user.email}</p>
                    <span style="display: inline-block; padding: 3px 10px; border-radius: 15px; background-color: var(--primary-color); color: white; font-size: 12px;">${user.role}</span>
                </div>
            `;
            
            // Add hover effect
            userElement.addEventListener('mouseenter', () => {
                userElement.style.transform = 'translateY(-5px)';
                userElement.style.boxShadow = '0 10px 25px var(--shadow-color)';
            });
            
            userElement.addEventListener('mouseleave', () => {
                userElement.style.transform = 'translateY(0)';
                userElement.style.boxShadow = '0 5px 15px var(--shadow-color)';
            });
            
            return userElement;
        }

        // Generate Random Users
        function generateRandomUsers(count) {
            const users = [];
            const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
            const firstNames = ['John', 'Emma', 'Michael', 'Sophia', 'William', 'Olivia', 'James', 'Ava', 'Robert', 'Isabella'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Jones', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor'];
            
            for (let i = 0; i < count; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                
                users.push({
                    id: generateId(),
                    firstName,
                    lastName,
                    email: `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`,
                    role: roles[Math.floor(Math.random() * roles.length)],
                    profilePicture: `https://randomuser.me/api/portraits/${Math.random() > 0.5 ? 'men' : 'women'}/${i + 2}.jpg`,
                    joiningDate: new Date(Date.now() - Math.random() * 31536000000) // Random date within the past year
                });
            }
            
            return users;
        }

        // Render Notifications
        function renderNotifications() {
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = '';
            
            if (state.notifications.length === 0) {
                notificationList.innerHTML = '<p style="text-align: center; padding: 20px 0;">No notifications</p>';
                return;
            }
            
            state.notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationElement.dataset.id = notification.id;
                
                notificationElement.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${formatDateTime(notification.timestamp)}</div>
                `;
                
                // Add click event to mark as read
                notificationElement.addEventListener('click', () => {
                    markNotificationAsRead(notification.id);
                    
                    // If notification is for a task, open the task view
                    if (notification.taskId) {
                        viewTask(notification.taskId);
                    }
                });
                
                notificationList.appendChild(notificationElement);
            });
        }

        // Local Storage Functions
        function saveTasksToLocalStorage() {
            localStorage.setItem('todoAppTasks', JSON.stringify(state.tasks));
        }

        function loadTasksFromLocalStorage() {
            const tasks = JSON.parse(localStorage.getItem('todoAppTasks') || '[]');
            
            // If no tasks in localStorage, generate random ones
            if (tasks.length === 0) {
                state.tasks = generateRandomTasks(10);
                saveTasksToLocalStorage();
            } else {
                state.tasks = tasks;
            }
        }

        function loadUsersFromLocalStorage() {
            const users = JSON.parse(localStorage.getItem('todoAppUsers') || '[]');
            state.users = users;
        }

        function saveCategoriestoLocalStorage() {
            localStorage.setItem('todoAppCategories', JSON.stringify(state.categories));
        }

        function loadCategoriesFromLocalStorage() {
            const categories = JSON.parse(localStorage.getItem('todoAppCategories') || '[]');
            if (categories.length > 0) {
                state.categories = categories;
            }
        }

        function saveNotificationsToLocalStorage() {
            localStorage.setItem('todoAppNotifications', JSON.stringify(state.notifications));
        }

        function loadNotificationsFromLocalStorage() {
            const notifications = JSON.parse(localStorage.getItem('todoAppNotifications') || '[]');
            state.notifications = notifications;
            updateNotificationBadges();
        }

        // Generate Random Tasks
        function generateRandomTasks(count) {
            const tasks = [];
            const titles = [
                'Complete project proposal',
                'Review design mockups',
                'Update documentation',
                'Fix bugs in login system',
                'Meeting with client',
                'Research new technologies',
                'Create presentation',
                'Set up development environment',
                'Code review',
                'Deploy new features',
                'User testing',
                'Update website content',
                'Create marketing materials',
                'Optimize database queries',
                'Implement security updates'
            ];
            
            const descriptions = [
                'Need to finalize the project scope and timeline',
                'Review the latest UI designs from the design team',
                'Update the technical documentation with recent changes',
                'Several bugs reported in the login system need to be fixed',
                'Weekly client meeting to discuss progress',
                'Research and evaluate new technologies for upcoming project',
                'Create presentation for the executive team',
                'Set up local development environment with all dependencies',
                'Review code submitted by junior developers',
                'Deploy recent features to production environment',
                'Organize user testing session for new features',
                'Update website content with latest information',
                'Create marketing materials for upcoming product launch',
                'Optimize slow database queries for better performance',
                'Implement critical security updates'
            ];
            
            const priorities = ['high', 'medium', 'low'];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * titles.length);
                const title = titles[randomIndex];
                const description = descriptions[randomIndex];
                
                // Random due date between today and 30 days from now
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 30) + 1);
                
                // Random creation date between 30 days ago and today
                const creationDate = new Date();
                creationDate.setDate(creationDate.getDate() - Math.floor(Math.random() * 30));
                
                // Determine if task is completed (30% chance)
                const completed = Math.random() < 0.3;
                
                // Create 0-3 subtasks
                const subtasks = [];
                const subtaskCount = Math.floor(Math.random() * 4);
                for (let j = 0; j < subtaskCount; j++) {
                    subtasks.push({
                        id: generateId(),
                        title: `Subtask ${j + 1} for ${title}`,
                        completed: Math.random() < 0.5
                    });
                }
                
                tasks.push({
                    id: generateId(),
                    title,
                    description,
                    subtasks,
                    dueDate: dueDate.toISOString().split('T')[0],
                    priority: priorities[Math.floor(Math.random() * 3)],
                    category: state.categories[Math.floor(Math.random() * state.categories.length)],
                    notes: Math.random() < 0.7 ? `Additional notes for ${title}` : '',
                    completed,
                    dateCreated: creationDate,
                    timeSpent: Math.floor(Math.random() * 3600) // Random time spent up to 1 hour (in seconds)
                });
            }
            
            return tasks;
        }

        // Initialize app if user is already logged in
        const savedUser = JSON.parse(localStorage.getItem('todoAppCurrentUser'));
        if (savedUser) {
            state.currentUser = savedUser;
            elements.loginPage.style.display = 'none';
            elements.appContainer.style.display = 'flex';
            initializeApp();
        }
    </script>
</body>
</html>
