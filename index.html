<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-light': '#7877e6',
                        'primary-dark': '#4a49b1',
                        secondary: '#6c757d',
                        success: '#28a745',
                        danger: '#dc3545',
                        warning: '#ffc107',
                        info: '#17a2b8',
                        light: '#f8f9fa',
                        dark: '#343a40',
                    },
                }
            }
        }
    </script>
    <style>
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .task-item.ghost {
            opacity: 0.5;
            background: #c8ebfb;
        }
        .dark .task-item.ghost {
            background: #2d3748;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Pulse animation for alerts */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        .dark .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300">
    <div id="app" class="flex flex-col h-screen">
        <!-- Auth Modal -->
        <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md p-6 animate-fadeIn">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-primary dark:text-primary-light" id="authTitle">Login</h2>
                    <img src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/svg/1f4cb.svg" class="w-8 h-8" alt="TaskMaster Logo">
                </div>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="mb-4">
                        <label for="loginEmail" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="mb-4">
                        <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2">
                            <span class="text-sm">Remember me</span>
                        </label>
                        <a href="#" class="text-sm text-primary dark:text-primary-light">Forgot password?</a>
                    </div>
                    <button id="loginBtn" class="w-full bg-primary hover:bg-primary-light text-white py-3 px-4 rounded-lg transition-colors duration-200">Login</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" id="showRegister" class="text-primary dark:text-primary-light">Register</a></p>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" class="hidden">
                    <div class="mb-4">
                        <label for="regName" class="block text-sm font-medium mb-1">Full Name</label>
                        <input type="text" id="regName" placeholder="Enter your full name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="mb-4">
                        <label for="regEmail" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="regEmail" placeholder="Enter your email" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="mb-4">
                        <label for="regPassword" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="regPassword" placeholder="Create a password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="mb-4">
                        <label for="regConfirmPassword" class="block text-sm font-medium mb-1">Confirm Password</label>
                        <input type="password" id="regConfirmPassword" placeholder="Confirm your password" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    <button id="registerBtn" class="w-full bg-primary hover:bg-primary-light text-white py-3 px-4 rounded-lg transition-colors duration-200">Register</button>
                    <p class="text-center mt-4">Already have an account? <a href="#" id="showLogin" class="text-primary dark:text-primary-light">Login</a></p>
                </div>
            </div>
        </div>
        
        <!-- Toast Notifications -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col items-end space-y-2"></div>
        
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md z-10">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-3">
                    <div class="flex items-center">
                        <img src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/svg/1f4cb.svg" class="w-8 h-8 mr-2" alt="TaskMaster Logo">
                        <h1 class="text-xl font-bold text-primary dark:text-primary-light">TaskMaster Pro</h1>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <!-- Color mode toggle -->
                        <button id="colorModeToggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                            <i class="fas fa-moon dark:hidden"></i>
                            <i class="fas fa-sun hidden dark:block"></i>
                        </button>
                        
                        <!-- User menu -->
                        <div class="relative">
                            <button id="userMenuBtn" class="flex items-center space-x-2">
                                <div id="userAvatar" class="w-8 h-8 rounded-full bg-gray-300 overflow-hidden"></div>
                                <span id="userName" class="font-medium hidden sm:inline">User Name</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            
                            <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-1 hidden animate-fadeIn">
                                <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-user mr-2"></i> Profile
                                </a>
                                <a href="#" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-cog mr-2"></i> Settings
                                </a>
                                <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                <a href="#" id="logoutBtn" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-red-500">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-grow flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-white dark:bg-gray-800 shadow-md hidden md:block overflow-y-auto">
                <div class="p-4">
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold mb-3">Dashboard</h2>
                        <nav>
                            <a href="#" class="flex items-center py-2 px-3 rounded-lg bg-primary bg-opacity-10 text-primary dark:text-primary-light mb-1">
                                <i class="fas fa-tasks mr-3"></i> Tasks
                            </a>
                            <a href="#" class="flex items-center py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                                <i class="fas fa-chart-pie mr-3"></i> Analytics
                            </a>
                            <a href="#" class="flex items-center py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 mb-1">
                                <i class="fas fa-calendar-alt mr-3"></i> Calendar
                            </a>
                            <a href="#" class="flex items-center py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-cog mr-3"></i> Settings
                            </a>
                        </nav>
                    </div>
                    
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold mb-3">Categories</h2>
                        <div id="categoryList">
                            <!-- Categories will be dynamically added here -->
                        </div>
                        <button id="addCategoryBtn" class="mt-2 text-sm flex items-center text-primary dark:text-primary-light">
                            <i class="fas fa-plus mr-1"></i> Add Category
                        </button>
                    </div>
                    
                    <div>
                        <h2 class="text-lg font-semibold mb-3">Task Alerts</h2>
                        <div id="taskAlerts" class="space-y-2">
                            <!-- Task alerts will be added here -->
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Mobile Nav -->
            <div id="mobileNav" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md flex justify-around py-2 md:hidden z-10">
                <button class="p-2 text-primary dark:text-primary-light">
                    <i class="fas fa-tasks"></i>
                </button>
                <button class="p-2">
                    <i class="fas fa-chart-pie"></i>
                </button>
                <button class="p-2">
                    <i class="fas fa-calendar-alt"></i>
                </button>
                <button id="mobileMenuBtn" class="p-2">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <!-- Mobile menu overlay -->
            <div id="mobileMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
            
            <!-- Mobile menu panel -->
            <div id="mobileMenuPanel" class="fixed inset-y-0 right-0 w-64 bg-white dark:bg-gray-800 shadow-md z-50 transform translate-x-full transition-transform duration-300 md:hidden">
                <div class="p-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold">Menu</h2>
                        <button id="closeMobileMenu" class="p-1">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-sm font-medium mb-2 text-gray-500 dark:text-gray-400">Categories</h3>
                        <div id="mobileCategoryList">
                            <!-- Mobile categories will be added here -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-sm font-medium mb-2 text-gray-500 dark:text-gray-400">Task Alerts</h3>
                        <div id="mobileTaskAlerts" class="space-y-2">
                            <!-- Mobile task alerts will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="flex-grow overflow-hidden flex flex-col bg-gray-50 dark:bg-gray-900">
                <!-- Action Bar -->
                <div class="bg-white dark:bg-gray-800 p-3 shadow-sm">
                    <div class="container mx-auto">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <!-- View Switcher -->
                            <div class="flex items-center space-x-2">
                                <button id="listViewBtn" class="px-3 py-2 rounded-lg bg-primary text-white flex items-center">
                                    <i class="fas fa-list mr-2"></i> List
                                </button>
                                <button id="graphViewBtn" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                    <i class="fas fa-chart-line mr-2"></i> Graph
                                </button>
                            </div>
                            
                            <!-- Sort and Undo/Redo -->
                            <div class="flex items-center space-x-2">
                                <div class="relative">
                                    <button id="sortBtn" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center">
                                        <i class="fas fa-sort mr-2"></i> Sort
                                    </button>
                                    <div id="sortDropdown" class="absolute left-0 mt-1 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-1 hidden z-10">
                                        <a href="#" data-sort="dueDate" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            Date (Newest First)
                                        </a>
                                        <a href="#" data-sort="dueDateAsc" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            Date (Oldest First)
                                        </a>
                                        <a href="#" data-sort="priority" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            Priority (High to Low)
                                        </a>
                                        <a href="#" data-sort="name" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                                            Name (A-Z)
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Undo/Redo buttons (moved next to sort as requested) -->
                                <button id="undoBtn" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button id="redoBtn" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                            
                            <!-- Search and Add Task -->
                            <div class="flex items-center space-x-2">
                                <div class="relative">
                                    <input type="text" id="searchInput" placeholder="Search tasks..." class="px-3 py-2 pl-9 rounded-lg border dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary w-44 md:w-64">
                                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                                <button id="addTaskBtn" class="px-3 py-2 rounded-lg bg-primary hover:bg-primary-light text-white flex items-center">
                                    <i class="fas fa-plus mr-2"></i> Add Task
                                </button>
                            </div>
                        </div>
                        
                        <!-- Batch Actions - Hidden by default, shown when tasks are selected -->
                        <div id="batchActions" class="mt-3 p-2 bg-gray-200 dark:bg-gray-700 rounded-lg hidden animate-fadeIn">
                            <div class="flex items-center justify-between">
                                <span id="selectedCount" class="text-sm font-medium">0 tasks selected</span>
                                <div class="flex space-x-2">
                                    <button id="completeSelectedBtn" class="px-3 py-1 rounded-lg bg-green-500 text-white text-sm">
                                        <i class="fas fa-check mr-1"></i> Complete
                                    </button>
                                    <button id="deleteSelectedBtn" class="px-3 py-1 rounded-lg bg-red-500 text-white text-sm">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                    <button id="categorySelectedBtn" class="px-3 py-1 rounded-lg bg-blue-500 text-white text-sm">
                                        <i class="fas fa-tag mr-1"></i> Set Category
                                    </button>
                                    <button id="cancelSelectBtn" class="px-3 py-1 rounded-lg bg-gray-400 text-white text-sm">
                                        <i class="fas fa-times mr-1"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tasks and Graphs Container -->
                <div class="flex-grow overflow-auto p-4">
                    <div class="container mx-auto">
                        <!-- List View -->
                        <div id="listView" class="animate-fadeIn">
                            <div id="taskList" class="space-y-2">
                                <!-- Tasks will be dynamically added here -->
                            </div>
                            
                            <!-- Empty state -->
                            <div id="emptyState" class="hidden text-center py-12">
                                <img src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/svg/1f4dd.svg" class="w-16 h-16 mx-auto mb-4" alt="No tasks">
                                <h3 class="text-xl font-bold mb-2">No tasks found</h3>
                                <p class="text-gray-500 dark:text-gray-400 mb-4">Get started by adding your first task!</p>
                                <button id="emptyStateAddBtn" class="px-4 py-2 bg-primary hover:bg-primary-light text-white rounded-lg">
                                    <i class="fas fa-plus mr-2"></i> Add Task
                                </button>
                            </div>
                        </div>
                        
                        <!-- Graph View -->
                        <div id="graphView" class="hidden animate-fadeIn">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- XY Graph Container -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                                    <h3 class="text-lg font-semibold mb-4">Tasks by Category & Due Date</h3>
                                    <canvas id="xyGraph" class="w-full"></canvas>
                                </div>
                                
                                <!-- Circular Graph Container -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
                                    <h3 class="text-lg font-semibold mb-4">Task Distribution by Category</h3>
                                    <canvas id="circularGraph" class="w-full"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Add/Edit Task Modal -->
        <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-lg p-6 animate-fadeIn">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="taskModalTitle">Add New Task</h2>
                    <button id="closeTaskModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    
                    <div class="mb-4">
                        <label for="taskName" class="block text-sm font-medium mb-1">Task Name</label>
                        <input type="text" id="taskName" placeholder="Enter task name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskDescription" class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="taskDescription" rows="3" placeholder="Enter task details" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="taskDueDate" class="block text-sm font-medium mb-1">Due Date</label>
                            <input type="datetime-local" id="taskDueDate" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                        </div>
                        
                        <div>
                            <label for="taskPriority" class="block text-sm font-medium mb-1">Priority</label>
                            <select id="taskPriority" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskCategory" class="block text-sm font-medium mb-1">Category</label>
                        <select id="taskCategory" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                            <!-- Categories will be dynamically added here -->
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" id="cancelTaskBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Cancel</button>
                        <button type="submit" id="saveTaskBtn" class="px-4 py-2 bg-primary hover:bg-primary-light text-white rounded-lg">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Add Category Modal -->
        <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-md p-6 animate-fadeIn">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Add Category</h2>
                    <button id="closeCategoryModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="categoryForm">
                    <div class="mb-4">
                        <label for="categoryName" class="block text-sm font-medium mb-1">Category Name</label>
                        <input type="text" id="categoryName" placeholder="Enter category name" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 text-base focus:ring-2 focus:ring-primary">
                    </div>
                    
                    <div class="mb-4">
                        <label for="categoryColor" class="block text-sm font-medium mb-1">Category Color</label>
                        <div class="grid grid-cols-8 gap-2">
                            <button type="button" data-color="#ef4444" class="w-8 h-8 rounded-full bg-red-500"></button>
                            <button type="button" data-color="#f97316" class="w-8 h-8 rounded-full bg-orange-500"></button>
                            <button type="button" data-color="#f59e0b" class="w-8 h-8 rounded-full bg-amber-500"></button>
                            <button type="button" data-color="#84cc16" class="w-8 h-8 rounded-full bg-lime-500"></button>
                            <button type="button" data-color="#10b981" class="w-8 h-8 rounded-full bg-emerald-500"></button>
                            <button type="button" data-color="#06b6d4" class="w-8 h-8 rounded-full bg-cyan-500"></button>
                            <button type="button" data-color="#3b82f6" class="w-8 h-8 rounded-full bg-blue-500"></button>
                            <button type="button" data-color="#8b5cf6" class="w-8 h-8 rounded-full bg-violet-500"></button>
                            <button type="button" data-color="#d946ef" class="w-8 h-8 rounded-full bg-fuchsia-500"></button>
                            <button type="button" data-color="#ec4899" class="w-8 h-8 rounded-full bg-pink-500"></button>
                            <button type="button" data-color="#f43f5e" class="w-8 h-8 rounded-full bg-rose-500"></button>
                            <button type="button" data-color="#6b7280" class="w-8 h-8 rounded-full bg-gray-500"></button>
                        </div>
                        <input type="hidden" id="categoryColor" value="#3b82f6">
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-6">
                        <button type="button" id="cancelCategoryBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Cancel</button>
                        <button type="submit" id="saveCategoryBtn" class="px-4 py-2 bg-primary hover:bg-primary-light text-white rounded-lg">Save Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // App State
            const appState = {
                user: null,
                tasks: [],
                categories: [
                    { id: 'cat1', name: 'Work', color: '#3b82f6' },
                    { id: 'cat2', name: 'Personal', color: '#10b981' },
                    { id: 'cat3', name: 'Study', color: '#f59e0b' },
                    { id: 'cat4', name: 'Health', color: '#ef4444' },
                    { id: 'cat5', name: 'Home', color: '#8b5cf6' }
                ],
                selectedTasks: new Set(),
                undoStack: [],
                redoStack: [],
                currentView: 'list', // 'list' or 'graph'
                sortBy: 'dueDate',
                searchTerm: ''
            };
            
            // Charts
            let xyChart = null;
            let circularChart = null;
            
            // Initialize Dark Mode
            function initDarkMode() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                    
                    // Update graphs if visible
                    if (appState.currentView === 'graph') {
                        updateGraphs();
                    }
                });
                
                document.getElementById('colorModeToggle').addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    
                    // Update graphs if visible
                    if (appState.currentView === 'graph') {
                        updateGraphs();
                    }
                });
            }
            
            // Generate Random User Avatar
            function generateUserAvatar() {
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Generate random color
                const hue = Math.floor(Math.random() * 360);
                const saturation = 60 + Math.floor(Math.random() * 30); // 60-90%
                const lightness = 45 + Math.floor(Math.random() * 10); // 45-55%
                
                // Background
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                ctx.fillRect(0, 0, 200, 200);
                
                // Draw pattern
                ctx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness + 20}%, 0.3)`;
                
                for (let i = 0; i < 3; i++) {
                    const size = 30 + Math.random() * 80;
                    const x = Math.random() * 200;
                    const y = Math.random() * 200;
                    
                    if (Math.random() > 0.5) {
                        // Circle
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        // Rectangle
                        ctx.fillRect(x - size/2, y - size/2, size, size);
                    }
                }
                
                // Get user initials
                const name = document.getElementById('userName').textContent || 'User Name';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Draw text
                ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness > 50 ? 20 : 90}%)`;
                ctx.font = 'bold 100px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, 100, 100);
                
                // Update avatar
                document.getElementById('userAvatar').style.backgroundImage = `url(${canvas.toDataURL()})`;
            }
            
            // Authentication
            function handleAuth() {
                // Form toggle handlers
                document.getElementById('showRegister').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('registerForm').classList.remove('hidden');
                    document.getElementById('authTitle').textContent = 'Register';
                });
                
                document.getElementById('showLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('authTitle').textContent = 'Login';
                });
                
                // Login handler
                document.getElementById('loginBtn').addEventListener('click', () => {
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    if (!email || !password) {
                        showToast('Please enter both email and password', 'error');
                        return;
                    }
                    
                    // Simulate login (in a real app, this would be an API call)
                    appState.user = {
                        id: 'user1',
                        name: email.split('@')[0].replace(/[^a-zA-Z0-9]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        email
                    };
                    
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('userName').textContent = appState.user.name;
                    
                    // Generate random avatar
                    generateUserAvatar();
                    
                    // Load app data
                    loadAppData();
                    
                    // Show success notification
                    showToast('Login successful!', 'success');
                });
                
                // Register handler
                document.getElementById('registerBtn').addEventListener('click', () => {
                    const name = document.getElementById('regName').value;
                    const email = document.getElementById('regEmail').value;
                    const password = document.getElementById('regPassword').value;
                    const confirmPassword = document.getElementById('regConfirmPassword').value;
                    
                    if (!name || !email || !password) {
                        showToast('Please fill all required fields', 'error');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showToast('Passwords do not match', 'error');
                        return;
                    }
                    
                    // Simulate registration (in a real app, this would be an API call)
                    appState.user = {
                        id: 'user1',
                        name,
                        email
                    };
                    
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('userName').textContent = appState.user.name;
                    
                    // Generate random avatar
                    generateUserAvatar();
                    
                    // Load app data with empty tasks
                    loadAppData(true);
                    
                    // Show success notification
                    showToast('Registration successful!', 'success');
                });
                
                // Logout handler
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    appState.user = null;
                    document.getElementById('authModal').classList.remove('hidden');
                    showToast('Logged out successfully', 'info');
                });
            }
            
            // Mobile Menu
            function setupMobileMenu() {
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    document.getElementById('mobileMenuOverlay').classList.remove('hidden');
                    document.getElementById('mobileMenuPanel').classList.remove('translate-x-full');
                });
                
                document.getElementById('closeMobileMenu').addEventListener('click', () => {
                    document.getElementById('mobileMenuOverlay').classList.add('hidden');
                    document.getElementById('mobileMenuPanel').classList.add('translate-x-full');
                });
                
                document.getElementById('mobileMenuOverlay').addEventListener('click', () => {
                    document.getElementById('mobileMenuOverlay').classList.add('hidden');
                    document.getElementById('mobileMenuPanel').classList.add('translate-x-full');
                });
            }
            
            // User Dropdown
            function setupUserDropdown() {
                document.getElementById('userMenuBtn').addEventListener('click', () => {
                    document.getElementById('userDropdown').classList.toggle('hidden');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('userDropdown');
                    const button = document.getElementById('userMenuBtn');
                    
                    if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            }
            
            // View Switching
            function setupViewSwitch() {
                document.getElementById('listViewBtn').addEventListener('click', () => {
                    switchView('list');
                });
                
                document.getElementById('graphViewBtn').addEventListener('click', () => {
                    switchView('graph');
                });
            }
            
            function switchView(view) {
                appState.currentView = view;
                
                if (view === 'list') {
                    document.getElementById('listViewBtn').classList.add('bg-primary', 'text-white');
                    document.getElementById('listViewBtn').classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    
                    document.getElementById('graphViewBtn').classList.remove('bg-primary', 'text-white');
                    document.getElementById('graphViewBtn').classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    
                    document.getElementById('listView').classList.remove('hidden');
                    document.getElementById('graphView').classList.add('hidden');
                } else {
                    document.getElementById('graphViewBtn').classList.add('bg-primary', 'text-white');
                    document.getElementById('graphViewBtn').classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    
                    document.getElementById('listViewBtn').classList.remove('bg-primary', 'text-white');
                    document.getElementById('listViewBtn').classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    
                    document.getElementById('listView').classList.add('hidden');
                    document.getElementById('graphView').classList.remove('hidden');
                    
                    updateGraphs();
                }
            }
            
            // Sort Menu
            function setupSortMenu() {
                document.getElementById('sortBtn').addEventListener('click', () => {
                    document.getElementById('sortDropdown').classList.toggle('hidden');
                });
                
                document.querySelectorAll('#sortDropdown a').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sortValue = e.target.dataset.sort;
                        appState.sortBy = sortValue;
                        document.getElementById('sortDropdown').classList.add('hidden');
                        
                        // Save state for undo
                        saveState();
                        
                        renderTasks();
                    });
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('sortDropdown');
                    const button = document.getElementById('sortBtn');
                    
                    if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            }
            
            // Task Modals
            function setupTaskModal() {
                document.getElementById('addTaskBtn').addEventListener('click', () => {
                    openTaskModal();
                });
                
                document.getElementById('emptyStateAddBtn').addEventListener('click', () => {
                    openTaskModal();
                });
                
                document.getElementById('closeTaskModal').addEventListener('click', () => {
                    document.getElementById('taskModal').classList.add('hidden');
                });
                
                document.getElementById('cancelTaskBtn').addEventListener('click', () => {
                    document.getElementById('taskModal').classList.add('hidden');
                });
                
                document.getElementById('taskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveTask();
                });
            }
            
            function openTaskModal(taskId = null) {
                // Reset form
                document.getElementById('taskForm').reset();
                
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                
                const dateStr = tomorrow.toISOString().slice(0, 16);
                document.getElementById('taskDueDate').value = dateStr;
                
                // Populate category select
                const categorySelect = document.getElementById('taskCategory');
                categorySelect.innerHTML = '';
                appState.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                if (taskId) {
                    // Edit existing task
                    const task = appState.tasks.find(t => t.id === taskId);
                    if (task) {
                        document.getElementById('taskModalTitle').textContent = 'Edit Task';
                        document.getElementById('taskId').value = task.id;
                        document.getElementById('taskName').value = task.name;
                        document.getElementById('taskDescription').value = task.description;
                        document.getElementById('taskDueDate').value = task.dueDate.slice(0, 16);
                        document.getElementById('taskPriority').value = task.priority;
                        document.getElementById('taskCategory').value = task.categoryId;
                    }
                } else {
                    // New task
                    document.getElementById('taskModalTitle').textContent = 'Add New Task';
                    document.getElementById('taskId').value = '';
                }
                
                document.getElementById('taskModal').classList.remove('hidden');
            }
            
            function saveTask() {
                const taskId = document.getElementById('taskId').value;
                const name = document.getElementById('taskName').value;
                const description = document.getElementById('taskDescription').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const priority = document.getElementById('taskPriority').value;
                const categoryId = document.getElementById('taskCategory').value;
                
                if (!name) {
                    showToast('Task name is required', 'error');
                    return;
                }
                
                if (!dueDate) {
                    showToast('Due date is required', 'error');
                    return;
                }
                
                // Save state for undo
                saveState();
                
                if (taskId) {
                    // Update existing task
                    const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex !== -1) {
                        appState.tasks[taskIndex] = {
                            ...appState.tasks[taskIndex],
                            name,
                            description,
                            dueDate,
                            priority,
                            categoryId,
                            lastUpdated: new Date().toISOString()
                        };
                    }
                } else {
                    // Add new task
                    const newTask = {
                        id: 'task' + Date.now(),
                        name,
                        description,
                        dueDate,
                        priority,
                        categoryId,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    appState.tasks.push(newTask);
                }
                
                document.getElementById('taskModal').classList.add('hidden');
                renderTasks();
                renderCategoriesAndAlerts();
                
                if (appState.currentView === 'graph') {
                    updateGraphs();
                }
                
                showToast(taskId ? 'Task updated successfully' : 'Task created successfully', 'success');
            }
            
            // Category Modal
            function setupCategoryModal() {
                document.getElementById('addCategoryBtn').addEventListener('click', () => {
                    document.getElementById('categoryModal').classList.remove('hidden');
                });
                
                document.getElementById('closeCategoryModal').addEventListener('click', () => {
                    document.getElementById('categoryModal').classList.add('hidden');
                });
                
                document.getElementById('cancelCategoryBtn').addEventListener('click', () => {
                    document.getElementById('categoryModal').classList.add('hidden');
                });
                
                // Color selection
                document.querySelectorAll('#categoryForm [data-color]').forEach(colorBtn => {
                    colorBtn.addEventListener('click', () => {
                        // Remove selection from all buttons
                        document.querySelectorAll('#categoryForm [data-color]').forEach(btn => {
                            btn.classList.remove('ring-2', 'ring-offset-2');
                        });
                        
                        // Add selection to clicked button
                        colorBtn.classList.add('ring-2', 'ring-offset-2');
                        document.getElementById('categoryColor').value = colorBtn.dataset.color;
                    });
                });
                
                document.getElementById('categoryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveCategory();
                });
            }
            
            function saveCategory() {
                const name = document.getElementById('categoryName').value;
                const color = document.getElementById('categoryColor').value;
                
                if (!name) {
                    showToast('Category name is required', 'error');
                    return;
                }
                
                // Save state for undo
                saveState();
                
                const newCategory = {
                    id: 'cat' + Date.now(),
                    name,
                    color
                };
                
                appState.categories.push(newCategory);
                document.getElementById('categoryModal').classList.add('hidden');
                document.getElementById('categoryForm').reset();
                
                renderCategoriesAndAlerts();
                renderTasks(); // Re-render tasks to update category dropdowns
                
                showToast('Category created successfully', 'success');
            }
            
            // Batch Actions
            function setupBatchActions() {
                document.getElementById('cancelSelectBtn').addEventListener('click', () => {
                    clearTaskSelection();
                });
                
                document.getElementById('completeSelectedBtn').addEventListener('click', () => {
                    // Save state for undo
                    saveState();
                    
                    appState.tasks.forEach(task => {
                        if (appState.selectedTasks.has(task.id)) {
                            task.completed = true;
                            task.lastUpdated = new Date().toISOString();
                        }
                    });
                    
                    clearTaskSelection();
                    renderTasks();
                    renderCategoriesAndAlerts();
                    
                    if (appState.currentView === 'graph') {
                        updateGraphs();
                    }
                    
                    showToast('Tasks completed successfully', 'success');
                });
                
                document.getElementById('deleteSelectedBtn').addEventListener('click', () => {
                    // Save state for undo
                    saveState();
                    
                    appState.tasks = appState.tasks.filter(task => !appState.selectedTasks.has(task.id));
                    
                    clearTaskSelection();
                    renderTasks();
                    renderCategoriesAndAlerts();
                    
                    if (appState.currentView === 'graph') {
                        updateGraphs();
                    }
                    
                    showToast('Tasks deleted successfully', 'success');
                });
                
                document.getElementById('categorySelectedBtn').addEventListener('click', () => {
                    const batchActions = document.getElementById('batchActions');
                    
                    // Create and append category dropdown
                    const categorySelect = document.createElement('select');
                    categorySelect.id = 'batchCategorySelect';
                    categorySelect.className = 'px-3 py-1 rounded-lg dark:bg-gray-700 dark:border-gray-600 text-sm';
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select Category';
                    categorySelect.appendChild(defaultOption);
                    
                    // Add category options
                    appState.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                    
                    // Hide all action buttons temporarily
                    document.querySelectorAll('#batchActions button').forEach(btn => {
                        btn.classList.add('hidden');
                    });
                    
                    // Add the dropdown and confirm button
                    const actionsDiv = document.createElement('div');
                    actionsDiv.id = 'categorySelectActions';
                    actionsDiv.className = 'flex space-x-2';
                    actionsDiv.appendChild(categorySelect);
                    
                    const confirmBtn = document.createElement('button');
                    confirmBtn.textContent = 'Apply';
                    confirmBtn.className = 'px-3 py-1 rounded-lg bg-green-500 text-white text-sm';
                    
                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'px-3 py-1 rounded-lg bg-gray-400 text-white text-sm';
                    
                    actionsDiv.appendChild(confirmBtn);
                    actionsDiv.appendChild(cancelBtn);
                    
                    batchActions.querySelector('div:last-child').appendChild(actionsDiv);
                    
                    // Confirm button handler
                    confirmBtn.addEventListener('click', () => {
                        const selectedCategoryId = categorySelect.value;
                        
                        if (!selectedCategoryId) {
                            showToast('Please select a category', 'error');
                            return;
                        }
                        
                        // Save state for undo
                        saveState();
                        
                        appState.tasks.forEach(task => {
                            if (appState.selectedTasks.has(task.id)) {
                                task.categoryId = selectedCategoryId;
                                task.lastUpdated = new Date().toISOString();
                            }
                        });
                        
                        clearTaskSelection();
                        renderTasks();
                        renderCategoriesAndAlerts();
                        
                        if (appState.currentView === 'graph') {
                            updateGraphs();
                        }
                        
                        showToast('Category updated successfully', 'success');
                    });
                    
                    // Cancel button handler
                    cancelBtn.addEventListener('click', () => {
                        // Remove the dropdown and buttons
                        actionsDiv.remove();
                        
                        // Show all action buttons
                        document.querySelectorAll('#batchActions button').forEach(btn => {
                            btn.classList.remove('hidden');
                        });
                    });
                });
            }
            
            // Search functionality
            function setupSearch() {
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    appState.searchTerm = e.target.value.toLowerCase();
                    renderTasks();
                });
            }
            
            // Undo/Redo functionality
            function setupUndoRedo() {
                document.getElementById('undoBtn').addEventListener('click', () => {
                    if (appState.undoStack.length > 0) {
                        // Move current state to redo stack
                        appState.redoStack.push({
                            tasks: JSON.parse(JSON.stringify(appState.tasks)),
                            categories: JSON.parse(JSON.stringify(appState.categories)),
                            sortBy: appState.sortBy
                        });
                        
                        // Get previous state
                        const previousState = appState.undoStack.pop();
                        appState.tasks = previousState.tasks;
                        appState.categories = previousState.categories;
                        appState.sortBy = previousState.sortBy;
                        
                        updateUndoRedoButtons();
                        renderTasks();
                        renderCategoriesAndAlerts();
                        
                        if (appState.currentView === 'graph') {
                            updateGraphs();
                        }
                        
                        showToast('Undo successful', 'info');
                    }
                });
                
                document.getElementById('redoBtn').addEventListener('click', () => {
                    if (appState.redoStack.length > 0) {
                        // Move current state to undo stack
                        appState.undoStack.push({
                            tasks: JSON.parse(JSON.stringify(appState.tasks)),
                            categories: JSON.parse(JSON.stringify(appState.categories)),
                            sortBy: appState.sortBy
                        });
                        
                        // Get next state
                        const nextState = appState.redoStack.pop();
                        appState.tasks = nextState.tasks;
                        appState.categories = nextState.categories;
                        appState.sortBy = nextState.sortBy;
                        
                        updateUndoRedoButtons();
                        renderTasks();
                        renderCategoriesAndAlerts();
                        
                        if (appState.currentView === 'graph') {
                            updateGraphs();
                        }
                        
                        showToast('Redo successful', 'info');
                    }
                });
            }
            
            function saveState() {
                appState.undoStack.push({
                    tasks: JSON.parse(JSON.stringify(appState.tasks)),
                    categories: JSON.parse(JSON.stringify(appState.categories)),
                    sortBy: appState.sortBy
                });
                
                // Clear redo stack on new action
                appState.redoStack = [];
                
                updateUndoRedoButtons();
            }
            
            function updateUndoRedoButtons() {
                document.getElementById('undoBtn').disabled = appState.undoStack.length === 0;
                document.getElementById('redoBtn').disabled = appState.redoStack.length === 0;
            }
            
            // Notifications
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                
                let bgColor, icon;
                
                switch(type) {
                    case 'success':
                        bgColor = 'bg-green-500';
                        icon = 'fas fa-check-circle';
                        break;
                    case 'error':
                        bgColor = 'bg-red-500';
                        icon = 'fas fa-exclamation-circle';
                        break;
                    case 'warning':
                        bgColor = 'bg-yellow-500';
                        icon = 'fas fa-exclamation-triangle';
                        break;
                    default:
                        bgColor = 'bg-blue-500';
                        icon = 'fas fa-info-circle';
                }
                
                toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 mb-3 animate-fadeIn`;
                toast.innerHTML = `
                    <i class="${icon}"></i>
                    <span>${message}</span>
                `;
                
                toastContainer.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
            
            // Task Management
            function renderTasks() {
                const taskList = document.getElementById('taskList');
                const emptyState = document.getElementById('emptyState');
                
                // First, sort and filter tasks
                let filteredTasks = [...appState.tasks];
                
                // Apply search filter
                if (appState.searchTerm) {
                    filteredTasks = filteredTasks.filter(task => 
                        task.name.toLowerCase().includes(appState.searchTerm) || 
                        task.description.toLowerCase().includes(appState.searchTerm)
                    );
                }
                
                // Apply sorting
                filteredTasks.sort((a, b) => {
                    switch(appState.sortBy) {
                        case 'dueDate':
                            return new Date(b.dueDate) - new Date(a.dueDate);
                        case 'dueDateAsc':
                            return new Date(a.dueDate) - new Date(b.dueDate);
                        case 'priority':
                            const priorityMap = { high: 3, medium: 2, low: 1 };
                            return priorityMap[b.priority] - priorityMap[a.priority];
                        case 'name':
                            return a.name.localeCompare(b.name);
                        default:
                            return new Date(b.createdAt) - new Date(a.createdAt);
                    }
                });
                
                // Check if task list is empty
                if (filteredTasks.length === 0) {
                    taskList.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                taskList.innerHTML = '';
                
                // Create task list
                filteredTasks.forEach(task => {
                    // Find category
                    const category = appState.categories.find(c => c.id === task.categoryId) || {
                        name: 'Uncategorized',
                        color: '#6b7280'
                    };
                    
                    // Calculate time left
                    const now = new Date();
                    const dueDate = new Date(task.dueDate);
                    const timeDiff = dueDate - now;
                    const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                    
                    let timeLeftClass = '';
                    let timeLeftLabel = '';
                    
                    if (task.completed) {
                        timeLeftLabel = 'Completed';
                    } else if (timeDiff < 0) {
                        timeLeftLabel = 'Overdue';
                        timeLeftClass = 'text-red-500 dark:text-red-400 pulse';
                    } else if (daysLeft === 0) {
                        timeLeftLabel = 'Due today';
                        timeLeftClass = 'text-amber-500 dark:text-amber-400';
                    } else if (daysLeft === 1) {
                        timeLeftLabel = 'Due tomorrow';
                        timeLeftClass = 'text-amber-500 dark:text-amber-400';
                    } else if (daysLeft <= 2) {
                        timeLeftLabel = `Due in ${daysLeft} days`;
                        timeLeftClass = 'text-amber-500 dark:text-amber-400';
                    } else {
                        timeLeftLabel = `Due in ${daysLeft} days`;
                    }
                    
                    const priorityClasses = {
                        high: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                        medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                        low: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                    };
                    
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 animate-slideIn transition-all duration-200 ${task.completed ? 'opacity-70' : ''}`;
                    taskItem.dataset.id = task.id;
                    
                    taskItem.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3 mt-1">
                                <div class="drag-handle cursor-grab">
                                    <i class="fas fa-grip-vertical text-gray-400"></i>
                                </div>
                            </div>
                            <div class="flex-shrink-0 mr-3">
                                <input type="checkbox" class="task-checkbox w-5 h-5 rounded text-primary focus:ring-primary" 
                                    ${task.completed ? 'checked' : ''}>
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : ''}">${task.name}</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm ${timeLeftClass}">
                                            <i class="far fa-clock mr-1"></i>
                                            ${timeLeftLabel}
                                        </span>
                                        <div class="task-actions hidden sm:flex space-x-1">
                                            <button class="edit-task p-1 text-gray-500 hover:text-primary">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="delete-task p-1 text-gray-500 hover:text-red-500">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-600 dark:text-gray-300 mt-1 ${task.completed ? 'line-through text-gray-400 dark:text-gray-500' : ''}">${task.description}</p>
                                <div class="flex flex-wrap items-center mt-3 gap-2">
                                    <span class="px-2 py-1 rounded-full text-xs" 
                                        style="background-color: ${category.color}20; color: ${category.color};">
                                        ${category.name}
                                    </span>
                                    <span class="px-2 py-1 rounded-full text-xs ${priorityClasses[task.priority]}">
                                        ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)} Priority
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400 ml-auto">
                                        ${new Date(task.dueDate).toLocaleString()}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Handle task selection
                    const checkbox = taskItem.querySelector('.task-checkbox');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked && !task.completed) {
                            // Save state for undo
                            saveState();
                            
                            task.completed = true;
                            task.lastUpdated = new Date().toISOString();
                            renderTasks();
                            renderCategoriesAndAlerts();
                            
                            showToast('Task completed!', 'success');
                            
                            if (appState.currentView === 'graph') {
                                updateGraphs();
                            }
                        } else if (!checkbox.checked && task.completed) {
                            // Save state for undo
                            saveState();
                            
                            task.completed = false;
                            task.lastUpdated = new Date().toISOString();
                            renderTasks();
                            renderCategoriesAndAlerts();
                            
                            if (appState.currentView === 'graph') {
                                updateGraphs();
                            }
                        }
                    });
                    
                    // Handle batch selection
                    taskItem.addEventListener('click', e => {
                        // Don't trigger for clicks on buttons, checkboxes or drag handles
                        if (
                            e.target.closest('.task-checkbox') || 
                            e.target.closest('.task-actions') || 
                            e.target.closest('.drag-handle')
                        ) {
                            return;
                        }
                        
                        if (e.ctrlKey || e.metaKey) {
                            if (appState.selectedTasks.has(task.id)) {
                                appState.selectedTasks.delete(task.id);
                                taskItem.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                            } else {
                                appState.selectedTasks.add(task.id);
                                taskItem.classList.add('bg-blue-50', 'dark:bg-blue-900/20');
                            }
                            
                            updateBatchActionsVisibility();
                        }
                    });
                    
                    // Edit task
                    taskItem.querySelector('.edit-task').addEventListener('click', () => {
                        openTaskModal(task.id);
                    });
                    
                    // Delete task
                    taskItem.querySelector('.delete-task').addEventListener('click', () => {
                        // Save state for undo
                        saveState();
                        
                        appState.tasks = appState.tasks.filter(t => t.id !== task.id);
                        renderTasks();
                        renderCategoriesAndAlerts();
                        
                        if (appState.currentView === 'graph') {
                            updateGraphs();
                        }
                        
                        showToast('Task deleted successfully', 'success');
                    });
                    
                    taskList.appendChild(taskItem);
                });
                
                // Initialize Sortable for drag-and-drop
                initSortable();
            }
            
            function initSortable() {
                if (window.taskSortable) {
                    window.taskSortable.destroy();
                }
                
                window.taskSortable = new Sortable(document.getElementById('taskList'), {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'ghost',
                    onEnd: function(evt) {
                        // Get task IDs in the new order
                        const taskItems = document.querySelectorAll('.task-item');
                        const taskOrder = Array.from(taskItems).map(item => item.dataset.id);
                        
                        // Save state for undo
                        saveState();
                        
                        // Reorder tasks array
                        const newTasks = [];
                        taskOrder.forEach(id => {
                            const task = appState.tasks.find(t => t.id === id);
                            if (task) {
                                newTasks.push(task);
                            }
                        });
                        
                        // Add any tasks that might be filtered out currently
                        appState.tasks.forEach(task => {
                            if (!taskOrder.includes(task.id)) {
                                newTasks.push(task);
                            }
                        });
                        
                        appState.tasks = newTasks;
                    }
                });
            }
            
            function updateBatchActionsVisibility() {
                const batchActions = document.getElementById('batchActions');
                const selectedCount = document.getElementById('selectedCount');
                
                if (appState.selectedTasks.size > 0) {
                    batchActions.classList.remove('hidden');
                    selectedCount.textContent = `${appState.selectedTasks.size} task${appState.selectedTasks.size > 1 ? 's' : ''} selected`;
                } else {
                    batchActions.classList.add('hidden');
                }
            }
            
            function clearTaskSelection() {
                appState.selectedTasks.clear();
                document.querySelectorAll('.task-item').forEach(item => {
                    item.classList.remove('bg-blue-50', 'dark:bg-blue-900/20');
                });
                document.getElementById('batchActions').classList.add('hidden');
                
                // Remove any category select dropdown if it exists
                const categorySelectActions = document.getElementById('categorySelectActions');
                if (categorySelectActions) {
                    categorySelectActions.remove();
                }
                
                // Show all action buttons
                document.querySelectorAll('#batchActions button').forEach(btn => {
                    btn.classList.remove('hidden');
                });
            }
            
            // Categories and Alerts
            function renderCategoriesAndAlerts() {
                renderCategories();
                renderTaskAlerts();
            }
            
            function renderCategories() {
                const categoryList = document.getElementById('categoryList');
                const mobileCategoryList = document.getElementById('mobileCategoryList');
                
                // Clear both lists
                categoryList.innerHTML = '';
                mobileCategoryList.innerHTML = '';
                
                // Create category list with task counts
                appState.categories.forEach(category => {
                    // Count tasks in this category
                    const totalTasks = appState.tasks.filter(task => task.categoryId === category.id).length;
                    const completedTasks = appState.tasks.filter(task => task.categoryId === category.id && task.completed).length;
                    
                    // Create the desktop category item
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 mb-1 flex items-center justify-between';
                    categoryItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></span>
                            <span>${category.name}</span>
                        </div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${completedTasks}/${totalTasks}</span>
                    `;
                    categoryList.appendChild(categoryItem);
                    
                    // Create the mobile category item (copy)
                    const mobileCategoryItem = categoryItem.cloneNode(true);
                    mobileCategoryList.appendChild(mobileCategoryItem);
                });
            }
            
            function renderTaskAlerts() {
                const taskAlerts = document.getElementById('taskAlerts');
                const mobileTaskAlerts = document.getElementById('mobileTaskAlerts');
                
                // Clear both alert areas
                taskAlerts.innerHTML = '';
                mobileTaskAlerts.innerHTML = '';
                
                const now = new Date();
                const alertTasks = appState.tasks.filter(task => {
                    if (task.completed) return false;
                    
                    const dueDate = new Date(task.dueDate);
                    const timeDiff = dueDate - now;
                    const hoursLeft = timeDiff / (1000 * 60 * 60);
                    
                    // Alert for overdue or due within 48 hours
                    return hoursLeft < 48;
                });
                
                // Sort by urgency (overdue first, then by due date)
                alertTasks.sort((a, b) => {
                    const aDueDate = new Date(a.dueDate);
                    const bDueDate = new Date(b.dueDate);
                    return aDueDate - bDueDate;
                });
                
                if (alertTasks.length === 0) {
                    const noAlerts = document.createElement('div');
                    noAlerts.className = 'text-sm text-gray-500 dark:text-gray-400 italic';
                    noAlerts.textContent = 'No urgent tasks';
                    taskAlerts.appendChild(noAlerts);
                    
                    const mobileNoAlerts = noAlerts.cloneNode(true);
                    mobileTaskAlerts.appendChild(mobileNoAlerts);
                    return;
                }
                
                alertTasks.forEach(task => {
                    const dueDate = new Date(task.dueDate);
                    const timeDiff = dueDate - now;
                    const hoursLeft = Math.ceil(timeDiff / (1000 * 60 * 60));
                    
                    let alertClass, alertIcon, timeText;
                    
                    if (timeDiff < 0) {
                        alertClass = 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-200 border-l-4 border-red-500';
                        alertIcon = 'fas fa-exclamation-circle text-red-500';
                        timeText = `Overdue by ${Math.abs(Math.floor(hoursLeft / 24))} day(s)`;
                        if (Math.abs(hoursLeft) < 24) {
                            timeText = `Overdue by ${Math.abs(hoursLeft)} hour(s)`;
                        }
                    } else if (hoursLeft <= 24) {
                        alertClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200 border-l-4 border-yellow-500';
                        alertIcon = 'fas fa-clock text-yellow-500';
                        timeText = `Due in ${hoursLeft} hour(s)`;
                    } else {
                        alertClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200 border-l-4 border-blue-500';
                        alertIcon = 'fas fa-calendar-day text-blue-500';
                        timeText = `Due in ${Math.floor(hoursLeft / 24)} day(s)`;
                    }
                    
                    // Create alert element
                    const alertEl = document.createElement('div');
                    alertEl.className = `p-2 rounded-r-lg ${alertClass}`;
                    alertEl.innerHTML = `
                        <div class="flex items-start">
                            <i class="${alertIcon} mr-2 mt-1"></i>
                            <div>
                                <p class="font-medium text-sm">${task.name}</p>
                                <p class="text-xs">${timeText}</p>
                            </div>
                        </div>
                    `;
                    
                    // Add click action to open task
                    alertEl.addEventListener('click', () => {
                        openTaskModal(task.id);
                    });
                    
                    taskAlerts.appendChild(alertEl);
                    
                    // Create clone for mobile
                    const mobileAlertEl = alertEl.cloneNode(true);
                    mobileAlertEl.addEventListener('click', () => {
                        openTaskModal(task.id);
                    });
                    mobileTaskAlerts.appendChild(mobileAlertEl);
                });
            }
            
            // Graph functionality
            function setupGraphs() {
                Chart.defaults.color = document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#4b5563';
                Chart.defaults.font.family = "'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";
            }
            
            function updateGraphs() {
                updateXYGraph();
                updateCircularGraph();
            }
            
            function updateXYGraph() {
                const ctx = document.getElementById('xyGraph').getContext('2d');
                
                // Destroy previous chart if it exists
                if (xyChart) {
                    xyChart.destroy();
                }
                
                // Get categories
                const categories = appState.categories.map(cat => cat.name);
                
                // Group tasks by category and count them
                const categoryData = {};
                const categoryColors = {};
                
                appState.categories.forEach(category => {
                    categoryData[category.name] = [];
                    categoryColors[category.name] = category.color;
                });
                
                // Group tasks by due date (using day as key)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Create date labels for the next 7 days
                const dates = [];
                const dateLabels = [];
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    
                    // Format as ISO string date part
                    const dateStr = date.toISOString().split('T')[0];
                    dates.push(dateStr);
                    
                    // Format as readable date
                    const options = { weekday: 'short', month: 'short', day: 'numeric' };
                    dateLabels.push(date.toLocaleDateString(undefined, options));
                }
                
                // Initialize task counts
                categories.forEach(category => {
                    dates.forEach(() => {
                        categoryData[category].push(0);
                    });
                });
                
                // Count tasks for each category and date
                appState.tasks.forEach(task => {
                    if (task.completed) return;
                    
                    const category = appState.categories.find(c => c.id === task.categoryId);
                    if (!category) return;
                    
                    const taskDate = new Date(task.dueDate);
                    taskDate.setHours(0, 0, 0, 0);
                    const taskDateStr = taskDate.toISOString().split('T')[0];
                    
                    const dateIndex = dates.indexOf(taskDateStr);
                    if (dateIndex !== -1) {
                        categoryData[category.name][dateIndex]++;
                    }
                });
                
                // Create datasets
                const datasets = categories.map(category => {
                    return {
                        label: category,
                        data: categoryData[category],
                        backgroundColor: categoryColors[category] + '80', // Add transparency
                        borderColor: categoryColors[category],
                        borderWidth: 1
                    };
                });
                
                // Create the chart
                xyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dateLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: false
                            },
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
            
            function updateCircularGraph() {
                const ctx = document.getElementById('circularGraph').getContext('2d');
                
                // Destroy previous chart if it exists
                if (circularChart) {
                    circularChart.destroy();
                }
                
                // Count tasks by category
                const categoryData = {};
                const categoryColors = [];
                
                appState.categories.forEach(category => {
                    categoryData[category.name] = 0;
                });
                
                appState.tasks.forEach(task => {
                    if (task.completed) return;
                    
                    const category = appState.categories.find(c => c.id === task.categoryId);
                    if (category) {
                        categoryData[category.name]++;
                    }
                });
                
                // Filter out categories with no tasks
                const labels = [];
                const data = [];
                
                appState.categories.forEach(category => {
                    if (categoryData[category.name] > 0) {
                        labels.push(category.name);
                        data.push(categoryData[category.name]);
                        categoryColors.push(category.color);
                    }
                });
                
                // Create the chart
                circularChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: categoryColors,
                            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        cutout: '65%'
                    }
                });
            }
            
            // App data and setup
            function loadAppData(isNewUser = false) {
                // Generate random tasks for demo purposes
                if (isNewUser || appState.tasks.length === 0) {
                    generateRandomTasks();
                }
                
                renderTasks();
                renderCategoriesAndAlerts();
                
                // Set up graphs
                setupGraphs();
            }
            
            function generateRandomTasks() {
                const today = new Date();
                const taskTemplates = [
                    { name: 'Project meeting', category: 'cat1', priority: 'high' },
                    { name: 'Review code', category: 'cat1', priority: 'medium' },
                    { name: 'Send weekly report', category: 'cat1', priority: 'medium' },
                    { name: 'Call client', category: 'cat1', priority: 'high' },
                    { name: 'Grocery shopping', category: 'cat2', priority: 'medium' },
                    { name: 'Pay bills', category: 'cat2', priority: 'high' },
                    { name: 'Doctor appointment', category: 'cat4', priority: 'high' },
                    { name: 'Workout', category: 'cat4', priority: 'medium' },
                    { name: 'Read book', category: 'cat3', priority: 'low' },
                    { name: 'Study for exam', category: 'cat3', priority: 'high' },
                    { name: 'Complete online course', category: 'cat3', priority: 'medium' },
                    { name: 'Clean house', category: 'cat5', priority: 'medium' },
                    { name: 'Fix leaky faucet', category: 'cat5', priority: 'low' },
                    { name: 'Organize closet', category: 'cat5', priority: 'low' },
                    { name: 'Plan weekend trip', category: 'cat2', priority: 'low' },
                    { name: 'Submit expense report', category: 'cat1', priority: 'medium' },
                    { name: 'Renew subscription', category: 'cat2', priority: 'low' },
                    { name: 'Schedule dentist', category: 'cat4', priority: 'medium' },
                    { name: 'Buy birthday gift', category: 'cat2', priority: 'medium' },
                    { name: 'Update resume', category: 'cat1', priority: 'low' }
                ];
                
                const descriptions = [
                    'Need to complete this task soon',
                    'Important for the quarterly goals',
                    'Don\'t forget to prepare all the necessary documents',
                    'This should be straightforward to complete',
                    'Make sure to follow up after completion',
                    'Check with the team before finalizing',
                    'Requires careful attention to detail',
                    'Should take about 2 hours to complete',
                    'Refer to previous examples for guidance',
                    'Might need some additional research first'
                ];
                
                // Generate tasks for the next 10 days
                appState.tasks = [];
                for (let i = 0; i < taskTemplates.length; i++) {
                    const template = taskTemplates[i];
                    const daysOffset = Math.floor(Math.random() * 10) - 2; // -2 to +7 days
                    
                    const dueDate = new Date(today);
                    dueDate.setDate(dueDate.getDate() + daysOffset);
                    dueDate.setHours(9 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60), 0, 0);
                    
                    const description = descriptions[Math.floor(Math.random() * descriptions.length)];
                    
                    const completed = daysOffset < 0 && Math.random() > 0.5; // 50% chance of completed for past tasks
                    
                    const task = {
                        id: 'task' + (i + 1),
                        name: template.name,
                        description,
                        dueDate: dueDate.toISOString(),
                        priority: template.priority,
                        categoryId: template.category,
                        completed,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    appState.tasks.push(task);
                }
            }
            
            // Initialize app
            function initApp() {
                initDarkMode();
                handleAuth();
                setupMobileMenu();
                setupUserDropdown();
                setupViewSwitch();
                setupSortMenu();
                setupTaskModal();
                setupCategoryModal();
                setupBatchActions();
                setupSearch();
                setupUndoRedo();
            }
            
            // Start the app
            initApp();
        });
    </script>
</body>
</html>
