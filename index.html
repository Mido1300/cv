<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced To-Do App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF and SheetJS for exports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#00008B',
                        success: '#28A745',
                        warning: '#FFC107',
                        danger: '#DC3545',
                        info: '#17A2B8',
                        dark: '#343A40',
                        light: '#F8F9FA',
                        muted: '#6C757D',
                    },
                    boxShadow: {
                        card: '0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05)',
                    },
                    transitionProperty: {
                        'height': 'height',
                        'spacing': 'margin, padding',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom styles that extend Tailwind */
        * {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s, color 0.3s, transform 0.3s, opacity 0.3s, box-shadow 0.3s;
        }
        
        body {
            overflow-x: hidden;
        }

        .dark body {
            background: linear-gradient(135deg, #1C2526 0%, #000000 100%);
            color: #F8F9FA;
        }
        
        body {
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            color: #343A40;
        }
        
        /* Login button glow effect */
        .login-btn {
            position: relative;
            overflow: hidden;
        }
        
        .login-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                transparent,
                rgba(93, 92, 222, 0.3),
                transparent 30%
            );
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            100% {
                transform: rotate(1turn);
            }
        }
        
        /* Glass effect for cards */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.6);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(93, 92, 222, 0.8);
        }
        
        /* Fancy Checkbox */
        .fancy-checkbox {
            position: relative;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .fancy-checkbox input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .fancy-checkbox .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid #5D5CDE;
            transition: all 0.3s ease;
        }
        
        .fancy-checkbox:hover .checkmark {
            box-shadow: 0 0 5px rgba(93, 92, 222, 0.5);
        }
        
        .fancy-checkbox input:checked ~ .checkmark {
            background-color: #5D5CDE;
        }
        
        .fancy-checkbox .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .fancy-checkbox input:checked ~ .checkmark:after {
            display: block;
        }
        
        /* Task status indicators */
        .status-expired {
            border-left: 4px solid #DC3545;
        }
        
        .status-due-soon {
            border-left: 4px solid #FFC107;
        }
        
        .status-ok {
            border-left: 4px solid #28A745;
        }
        
        /* Priority indicators */
        .priority-high {
            background-color: rgba(220, 53, 69, 0.1);
            border-right: 3px solid #DC3545;
        }
        
        .priority-medium {
            background-color: rgba(253, 126, 20, 0.1);
            border-right: 3px solid #FD7E14;
        }
        
        .priority-low {
            background-color: rgba(108, 117, 125, 0.1);
            border-right: 3px solid #6C757D;
        }
        
        /* Task completion toggle */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #28A745;
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #28A745;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 20px;
            background: rgba(93, 92, 222, 0.9);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background-color: #DC3545;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Timer styling */
        .timer {
            font-variant-numeric: tabular-nums;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Drag and drop */
        .task-dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .drag-over {
            border: 2px dashed #5D5CDE;
            background-color: rgba(93, 92, 222, 0.1);
            padding-top: 8px;
            padding-bottom: 8px;
        }
        
        /* Multi-select action bar */
        .multi-select-bar {
            background: linear-gradient(90deg, rgba(93, 92, 222, 0.95) 0%, rgba(93, 92, 222, 0.8) 100%);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s;
        }
        
        .multi-select-bar.active {
            transform: translateY(0);
        }
        
        /* User status indicator */
        .status-online {
            border: 2px solid #28A745;
        }
        
        .status-break {
            border: 2px solid #FFC107;
        }
        
        .status-offline {
            border: 2px solid #DC3545;
        }
        
        .status-shadow {
            border: 2px solid #6C757D;
        }
        
        /* Popup styling */
        .popup-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-visible {
                display: block !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-px-2 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center px-4">
        <div class="w-full max-w-md p-8 rounded-xl shadow-card bg-white dark:bg-gray-800 glass">
            <h1 class="text-3xl font-bold text-center mb-8 text-primary dark:text-white">Advanced To-Do App</h1>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" id="email" name="email" value="test@example.com" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" name="password" value="123456" class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div class="flex justify-center">
                    <button type="submit" class="login-btn w-2/3 py-3 px-4 bg-primary text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-primary relative overflow-hidden">
                        <span class="relative z-10">Login</span>
                    </button>
                </div>
            </form>
            
            <p class="text-center mt-6 text-gray-600 dark:text-gray-400">
                Don't have an account? 
                <a href="#" id="register-link" class="text-secondary hover:underline font-medium">Register now</a>
            </p>
        </div>
    </div>
    
    <!-- Registration Popup -->
    <div id="register-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Create Account</h2>
                <button id="close-register" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="register-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
                        <input type="text" id="firstName" name="firstName" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
                        <input type="text" id="lastName" name="lastName" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                </div>
                
                <div>
                    <label for="regEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                    <input type="email" id="regEmail" name="regEmail" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="confirmEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Email</label>
                    <input type="email" id="confirmEmail" name="confirmEmail" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="regPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="regPassword" name="regPassword" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="birthdate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Birthdate</label>
                    <input type="text" id="birthdate" name="birthdate" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                </div>
                
                <div>
                    <label for="nationality" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nationality</label>
                    <select id="nationality" name="nationality" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                        <option value="">Select Country</option>
                    </select>
                </div>
                
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role</label>
                    <select id="role" name="role" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                        <option value="">Select Role</option>
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Customer">Customer</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button type="button" id="cancel-register" class="w-1/2 py-2 px-4 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-gray-600 focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Cancel
                    </button>
                    <button type="submit" class="w-1/2 py-2 px-4 bg-success text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-success">
                        Create
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm fixed top-0 w-full z-30">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-primary dark:text-white">To-Do App</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Task Timer -->
                    <div class="timer bg-gray-100 dark:bg-gray-700 hidden md:flex">
                        <span id="global-timer" class="text-lg font-medium">00:00:00</span>
                        <button id="timer-play" class="text-success hover:text-opacity-80">
                            <i class="fas fa-play"></i>
                        </button>
                        <button id="timer-pause" class="text-warning hover:text-opacity-80 hidden">
                            <i class="fas fa-pause"></i>
                        </button>
                    </div>
                    
                    <!-- User Status Dropdown -->
                    <div class="relative">
                        <button id="status-dropdown-button" class="flex items-center space-x-2 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full text-sm">
                            <span class="w-2 h-2 bg-success rounded-full"></span>
                            <span id="current-status">Online</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        
                        <div id="status-dropdown" class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden z-50">
                            <a href="#" class="status-option flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-status="online">
                                <span class="w-2 h-2 bg-success rounded-full mr-2"></span>
                                <span>Online</span>
                            </a>
                            <a href="#" class="status-option flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-status="break">
                                <span class="w-2 h-2 bg-warning rounded-full mr-2"></span>
                                <span>On Break</span>
                            </a>
                            <a href="#" class="status-option flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-status="shadow">
                                <span class="w-2 h-2 bg-muted rounded-full mr-2"></span>
                                <span>Shadow</span>
                            </a>
                            <a href="#" class="status-option flex items-center px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-status="offline">
                                <span class="w-2 h-2 bg-danger rounded-full mr-2"></span>
                                <span>Offline</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i class="fas fa-sun text-yellow-400 dark:hidden"></i>
                        <i class="fas fa-moon text-blue-300 hidden dark:block"></i>
                    </button>
                    
                    <!-- Notification Icon -->
                    <div class="relative">
                        <button id="notification-button" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 relative">
                            <i class="fas fa-bell"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                        
                        <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden z-50 max-h-96 overflow-y-auto">
                            <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 class="font-semibold">Notifications</h3>
                                <button id="mark-all-read" class="text-xs text-primary hover:underline">Mark all as read</button>
                            </div>
                            <div id="notification-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <div class="notification-empty px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                                    No notifications yet
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Profile -->
                    <div class="relative">
                        <button id="profile-button" class="w-10 h-10 rounded-full overflow-hidden status-online">
                            <img id="profile-image" src="" alt="User profile" class="w-full h-full object-cover">
                        </button>
                        
                        <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden z-50">
                            <a href="#" id="view-profile" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-user mr-2"></i> View Profile
                            </a>
                            <a href="#" id="view-users" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-users mr-2"></i> Users
                            </a>
                            <a href="#" id="toggle-mode" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-adjust mr-2"></i> <span id="toggle-mode-text">Dark Mode</span>
                            </a>
                            <a href="#" id="logout" class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-grow pt-16 pb-20">
            <div class="container mx-auto px-4 py-8">
                <!-- Task Overview Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6 glass lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-3 flex items-center">
                            <i class="fas fa-chart-pie mr-2 text-primary"></i>
                            Total Tasks
                            <span id="total-task-count" class="ml-2 bg-primary text-white text-sm px-2 py-1 rounded-full">0</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-4 flex items-center transform hover:scale-105 transition-transform">
                                <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                                    <i class="fas fa-check-circle text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium opacity-80">Completed Tasks</h3>
                                    <p id="completed-task-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-4 flex items-center transform hover:scale-105 transition-transform">
                                <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                                    <i class="fas fa-clock text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium opacity-80">Pending Tasks</h3>
                                    <p id="pending-task-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Task Section -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6 mb-8 glass">
                    <!-- Task Header -->
                    <div class="flex flex-wrap items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold flex items-center">
                            <i class="fas fa-tasks mr-2 text-primary"></i>
                            Tasks
                        </h2>
                        
                        <div class="flex flex-wrap items-center space-x-2 mt-4 sm:mt-0">
                            <button id="add-task-btn" class="bg-success hover:bg-opacity-90 text-white px-4 py-2 rounded-lg flex items-center">
                                <i class="fas fa-plus mr-2"></i>
                                <span>Add Task</span>
                            </button>
                            
                            <button id="manage-categories-btn" class="bg-info hover:bg-opacity-90 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-tags mr-1"></i>
                                <span class="hidden sm:inline">Categories</span>
                            </button>
                            
                            <div class="relative">
                                <button id="export-btn" class="bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-download mr-1"></i>
                                    <span class="hidden sm:inline">Export</span>
                                </button>
                                
                                <div id="export-dropdown" class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden z-20">
                                    <a href="#" class="export-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-format="pdf">
                                        <i class="far fa-file-pdf mr-2 text-red-500"></i> PDF
                                    </a>
                                    <a href="#" class="export-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-format="excel">
                                        <i class="far fa-file-excel mr-2 text-green-500"></i> Excel
                                    </a>
                                    <a href="#" class="export-option block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-format="json">
                                        <i class="far fa-file-code mr-2 text-yellow-500"></i> JSON
                                    </a>
                                </div>
                            </div>
                            
                            <button id="import-btn" class="bg-secondary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-upload mr-1"></i>
                                <span class="hidden sm:inline">Import</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Task Filters -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="task-search" placeholder="Search tasks..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        
                        <div class="flex space-x-2">
                            <select id="status-filter" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <select id="category-filter" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <select id="due-date-filter" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="all">All Due Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Date Range Picker (hidden by default) -->
                    <div id="custom-date-range" class="mb-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="date-range-start" class="block text-sm font-medium mb-1">Start Date</label>
                                <input type="text" id="date-range-start" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label for="date-range-end" class="block text-sm font-medium mb-1">End Date</label>
                                <input type="text" id="date-range-end" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                        </div>
                        <div class="mt-2">
                            <button id="apply-date-range" class="bg-primary hover:bg-opacity-90 text-white px-4 py-2 rounded-lg">
                                Apply
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sort & View Controls -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center space-x-2">
                                <label for="sort-by" class="text-sm font-medium">Sort by:</label>
                                <select id="sort-by" class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-sm focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="dueDate-asc">Due Date (Earliest)</option>
                                    <option value="dueDate-desc">Due Date (Latest)</option>
                                    <option value="title-asc">Title (A-Z)</option>
                                    <option value="title-desc">Title (Z-A)</option>
                                    <option value="priority-asc">Priority (Low to High)</option>
                                    <option value="priority-desc">Priority (High to Low)</option>
                                </select>
                            </div>
                            
                            <!-- Undo/Redo Buttons -->
                            <div class="flex items-center space-x-1">
                                <button id="undo-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-undo"></i>
                                </button>
                                <button id="redo-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- View Switcher -->
                        <div class="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden flex">
                            <button id="list-view-btn" class="px-3 py-1 bg-primary text-white">
                                <i class="fas fa-list"></i>
                            </button>
                            <button id="graph-view-btn" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Task List View -->
                    <div id="list-view" class="overflow-hidden">
                        <div id="tasks-container" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Tasks will be inserted here -->
                            <div id="no-tasks" class="py-8 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-tasks text-4xl mb-3"></i>
                                <p>No tasks found. Add your first task!</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Graph View -->
                    <div id="graph-view" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4">
                                <h3 class="text-lg font-semibold mb-4">Tasks Over Time</h3>
                                <div class="h-64">
                                    <canvas id="tasks-timeline-chart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4">
                                <h3 class="text-lg font-semibold mb-4">Task Status Distribution</h3>
                                <div class="h-64">
                                    <canvas id="tasks-status-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4">
                                <h3 class="text-lg font-semibold mb-4">Tasks by Priority</h3>
                                <div class="h-64">
                                    <canvas id="tasks-priority-chart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm p-4">
                                <h3 class="text-lg font-semibold mb-4">Tasks by Category</h3>
                                <div class="h-64">
                                    <canvas id="tasks-category-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Insights Section -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card p-6 mb-8 glass">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-lightbulb mr-2 text-primary"></i>
                        Insights
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-5 transform hover:scale-105 transition-transform">
                            <h3 class="text-lg font-semibold mb-2">Productivity Score</h3>
                            <div class="flex items-end">
                                <span id="productivity-score" class="text-3xl font-bold">0%</span>
                                <span class="ml-2 text-sm opacity-80">(tasks completed)</span>
                            </div>
                            <div class="mt-3 bg-white bg-opacity-20 h-2 rounded-full overflow-hidden">
                                <div id="productivity-bar" class="bg-white h-full rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg p-5 transform hover:scale-105 transition-transform">
                            <h3 class="text-lg font-semibold mb-2">Time Tracked</h3>
                            <p id="total-time-tracked" class="text-3xl font-bold">00:00:00</p>
                            <p class="text-sm opacity-80 mt-2">Total time spent on tasks</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-pink-500 to-pink-600 text-white rounded-lg p-5 transform hover:scale-105 transition-transform">
                            <h3 class="text-lg font-semibold mb-2">Urgent Tasks</h3>
                            <div class="flex items-end">
                                <span id="urgent-tasks-count" class="text-3xl font-bold">0</span>
                                <span class="ml-2 text-sm opacity-80">(high priority)</span>
                            </div>
                            <p id="urgent-tasks-due" class="text-sm opacity-80 mt-2">No urgent tasks</p>
                        </div>
                        
                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 text-white rounded-lg p-5 transform hover:scale-105 transition-transform">
                            <h3 class="text-lg font-semibold mb-2">Most Active Category</h3>
                            <p id="most-active-category" class="text-3xl font-bold">-</p>
                            <p id="most-active-category-count" class="text-sm opacity-80 mt-2">No tasks yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Multi-Select Action Bar -->
        <div id="multi-select-bar" class="fixed bottom-0 left-0 w-full py-3 px-4 z-40 multi-select-bar">
            <div class="container mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <span id="selected-count" class="font-semibold text-white mr-4">0 selected</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="batch-complete" class="bg-success hover:bg-opacity-90 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-check mr-2"></i>
                        <span>Complete</span>
                    </button>
                    <button id="batch-delete" class="bg-danger hover:bg-opacity-90 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i>
                        <span>Delete</span>
                    </button>
                    <button id="batch-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Add Task Popup -->
        <div id="add-task-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass overflow-y-auto max-h-90vh">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="task-popup-title" class="text-2xl font-bold text-gray-800 dark:text-white">Add New Task</h2>
                    <button id="close-task-popup" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="task-form" class="space-y-4">
                    <input type="hidden" id="task-id">
                    
                    <div>
                        <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
                        <input type="text" id="task-title" name="task-title" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    
                    <div>
                        <label for="task-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                        <textarea id="task-description" name="task-description" rows="3" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sub-Tasks</label>
                            <button type="button" id="add-subtask" class="text-primary hover:text-opacity-80 text-sm">
                                <i class="fas fa-plus-circle"></i> Add
                            </button>
                        </div>
                        <div id="subtasks-container" class="space-y-2">
                            <!-- Sub-tasks will be added here -->
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="task-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                            <input type="text" id="task-due-date" name="task-due-date" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label for="task-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                            <select id="task-priority" name="task-priority" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="task-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                        <select id="task-category" name="task-category" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="task-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (Optional)</label>
                        <textarea id="task-notes" name="task-notes" rows="2" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-task" class="px-4 py-2 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-gray-600 focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Cancel
                        </button>
                        <button type="submit" id="save-task" class="px-4 py-2 bg-success text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-success">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- View Task Popup -->
        <div id="view-task-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass overflow-y-auto max-h-90vh">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="view-task-title" class="text-2xl font-bold text-gray-800 dark:text-white truncate">Task Details</h2>
                    <button id="close-view-task" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Description</span>
                        <p id="view-task-description" class="mt-1 text-gray-800 dark:text-gray-200"></p>
                    </div>
                    
                    <div id="view-subtasks-container" class="space-y-2 hidden">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Sub-Tasks</span>
                        <ul id="view-subtasks-list" class="mt-1 space-y-1"></ul>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Due Date</span>
                            <p id="view-task-due-date" class="mt-1 text-gray-800 dark:text-gray-200 font-medium"></p>
                        </div>
                        
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Priority</span>
                            <p id="view-task-priority" class="mt-1 flex items-center"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Category</span>
                            <p id="view-task-category" class="mt-1 bg-primary bg-opacity-10 text-primary dark:text-primary-light px-2 py-1 rounded inline-block text-sm"></p>
                        </div>
                        
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Status</span>
                            <p id="view-task-status" class="mt-1"></p>
                        </div>
                    </div>
                    
                    <div>
                        <span class="text-sm text-gray-500 dark:text-gray-400">Time Tracked</span>
                        <p id="view-task-time" class="mt-1 text-gray-800 dark:text-gray-200 font-mono">00:00:00</p>
                    </div>
                    
                    <div id="view-task-notes-container">
                        <span class="text-sm text-gray-500 dark:text-gray-400">Notes</span>
                        <p id="view-task-notes" class="mt-1 text-gray-800 dark:text-gray-200"></p>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button id="edit-task-from-view" class="px-4 py-2 bg-primary text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                        <button id="close-view-task-btn" class="px-4 py-2 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Profile Popup -->
        <div id="profile-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="profile-popup-title" class="text-2xl font-bold text-gray-800 dark:text-white">User Profile</h2>
                    <button id="close-profile" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="profile-view" class="space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-20 h-20 rounded-full overflow-hidden">
                            <img id="view-profile-image" src="" alt="Profile picture" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h3 id="view-profile-name" class="text-xl font-semibold"></h3>
                            <p id="view-profile-role" class="text-gray-600 dark:text-gray-400"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Email</span>
                            <p id="view-profile-email" class="mt-1 text-gray-800 dark:text-gray-200"></p>
                        </div>
                        
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Country</span>
                            <p id="view-profile-country" class="mt-1 text-gray-800 dark:text-gray-200"></p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">Joined</span>
                            <p id="view-profile-joined" class="mt-1 text-gray-800 dark:text-gray-200"></p>
                        </div>
                    </div>
                    
                    <div class="pt-4 flex justify-end">
                        <button id="edit-profile-btn" class="px-4 py-2 bg-primary text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                            <i class="fas fa-edit mr-1"></i> Edit Profile
                        </button>
                    </div>
                </div>
                
                <form id="profile-edit" class="space-y-4 hidden">
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-24 h-24 rounded-full overflow-hidden mb-2">
                            <img id="edit-profile-image" src="" alt="Profile picture" class="w-full h-full object-cover">
                        </div>
                        <label for="profile-image-upload" class="cursor-pointer px-3 py-1 bg-primary text-white text-sm rounded-lg hover:bg-opacity-90">
                            Change Photo
                        </label>
                        <input type="file" id="profile-image-upload" class="hidden" accept="image/*">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-first-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
                            <input type="text" id="edit-first-name" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                        
                        <div>
                            <label for="edit-last-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
                            <input type="text" id="edit-last-name" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="edit-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="edit-email" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                    </div>
                    
                    <div>
                        <label for="edit-country" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Country</label>
                        <select id="edit-country" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" required>
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancel-profile-edit" class="px-4 py-2 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-gray-600">
                            Cancel
                        </button>
                        <button type="submit" id="save-profile" class="px-4 py-2 bg-success text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Users Popup -->
        <div id="users-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-4xl mx-4 p-6 glass overflow-y-auto max-h-90vh">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Users</h2>
                    <button id="close-users" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="users-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Users will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Manage Categories Popup -->
        <div id="categories-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Manage Categories</h2>
                    <button id="close-categories" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-4 flex items-end space-x-2">
                    <div class="flex-grow">
                        <label for="new-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Category</label>
                        <input type="text" id="new-category" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <button id="add-category-btn" class="px-4 py-2 bg-success text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                        Add
                    </button>
                </div>
                
                <div class="max-h-96 overflow-y-auto">
                    <ul id="categories-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Categories will be added here -->
                        <li class="py-4 text-center text-gray-500 dark:text-gray-400" id="no-categories">
                            No categories yet. Add your first category!
                        </li>
                    </ul>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="close-categories-btn" class="px-4 py-2 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Import Popup -->
        <div id="import-popup" class="fixed inset-0 flex items-center justify-center z-50 popup-overlay hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg mx-4 p-6 glass">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Import Tasks</h2>
                    <button id="close-import" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <p class="text-gray-600 dark:text-gray-400 mb-4">Import tasks from a JSON file</p>
                    
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                        <i class="fas fa-file-upload text-4xl text-gray-400 dark:text-gray-500 mb-3"></i>
                        <p class="mb-4">Drag and drop a file or click to browse</p>
                        <label for="import-file" class="px-4 py-2 bg-primary text-white font-medium rounded-lg cursor-pointer focus:outline-none hover:bg-opacity-90">
                            Choose File
                        </label>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <p id="selected-file" class="mt-2 text-sm text-gray-500 dark:text-gray-400">No file selected</p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button id="cancel-import" class="px-4 py-2 bg-gray-500 text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90">
                        Cancel
                    </button>
                    <button id="confirm-import" class="px-4 py-2 bg-success text-white font-medium rounded-lg focus:outline-none hover:bg-opacity-90" disabled>
                        Import
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Toast Container -->
        <div id="toast-container"></div>
    </div>
    
    <script>
        // Store application data
        const appData = {
            users: [],
            tasks: [],
            categories: [],
            notifications: [],
            undoStack: [],
            redoStack: [],
            currentUser: null,
            timerActive: false,
            activeTaskId: null,
            timerInterval: null,
            globalSeconds: 0,
            lastActionTimestamp: Date.now()
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Setup dark mode
            setupDarkMode();
            
            // Load data from localStorage
            loadDataFromStorage();
            
            // Initialize flatpickr date pickers
            initDatePickers();
            
            // Fetch countries for dropdowns
            fetchCountries();
            
            // Setup event listeners
            setupEventListeners();
            
            // Generate random users if none exist
            if (appData.users.length === 0) {
                generateRandomUsers(5);
            }
            
            // Generate initial categories if none exist
            if (appData.categories.length === 0) {
                generateInitialCategories();
            }
            
            // Generate random tasks if none exist
            if (appData.tasks.length === 0) {
                generateRandomTasks(10);
            }
            
            // Update UI
            updateTaskCounts();
            updateCategoryDropdowns();
            renderTasks();
            updateInsights();
        });
        
        // Setup dark mode detection and toggle
        function setupDarkMode() {
            // Initial setup based on system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('toggle-mode-text').textContent = 'Light Mode';
            }
            
            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    document.getElementById('toggle-mode-text').textContent = 'Light Mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    document.getElementById('toggle-mode-text').textContent = 'Dark Mode';
                }
            });
        }
        
        // Load data from localStorage
        function loadDataFromStorage() {
            try {
                const users = localStorage.getItem('todoAppUsers');
                if (users) {
                    appData.users = JSON.parse(users);
                }
                
                const tasks = localStorage.getItem('todoAppTasks');
                if (tasks) {
                    appData.tasks = JSON.parse(tasks);
                }
                
                const categories = localStorage.getItem('todoAppCategories');
                if (categories) {
                    appData.categories = JSON.parse(categories);
                }
                
                const notifications = localStorage.getItem('todoAppNotifications');
                if (notifications) {
                    appData.notifications = JSON.parse(notifications);
                }
                
                const currentUser = localStorage.getItem('todoAppCurrentUser');
                if (currentUser) {
                    appData.currentUser = JSON.parse(currentUser);
                    document.getElementById('profile-image').src = appData.currentUser.profileImage;
                }
                
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading data from storage:', error);
                showToast('Error loading saved data. Starting fresh.', 'error');
            }
        }
        
        // Save data to localStorage
        function saveDataToStorage() {
            try {
                localStorage.setItem('todoAppUsers', JSON.stringify(appData.users));
                localStorage.setItem('todoAppTasks', JSON.stringify(appData.tasks));
                localStorage.setItem('todoAppCategories', JSON.stringify(appData.categories));
                localStorage.setItem('todoAppNotifications', JSON.stringify(appData.notifications));
                
                if (appData.currentUser) {
                    localStorage.setItem('todoAppCurrentUser', JSON.stringify(appData.currentUser));
                }
            } catch (error) {
                console.error('Error saving data to storage:', error);
                showToast('Error saving data. Changes may not persist.', 'error');
            }
        }
        
        // Initialize Flatpickr date pickers
        function initDatePickers() {
            // Registration birthdate picker
            flatpickr('#birthdate', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
            
            // Task due date picker
            flatpickr('#task-due-date', {
                dateFormat: 'Y-m-d H:i',
                enableTime: true,
                minDate: 'today',
                time_24hr: true
            });
            
            // Custom date range pickers
            flatpickr('#date-range-start', {
                dateFormat: 'Y-m-d',
                maxDate: 'today'
            });
            
            flatpickr('#date-range-end', {
                dateFormat: 'Y-m-d'
            });
        }
        
        // Fetch countries for dropdowns
        function fetchCountries() {
            fetch('https://restcountries.com/v3.1/all')
                .then(response => response.json())
                .then(data => {
                    // Sort countries by name
                    const countries = data.sort((a, b) => {
                        return a.name.common.localeCompare(b.name.common);
                    });
                    
                    // Get country dropdowns
                    const nationalitySelect = document.getElementById('nationality');
                    const editCountrySelect = document.getElementById('edit-country');
                    
                    // Clear existing options
                    nationalitySelect.innerHTML = '<option value="">Select Country</option>';
                    editCountrySelect.innerHTML = '<option value="">Select Country</option>';
                    
                    // Add country options
                    countries.forEach(country => {
                        const option1 = document.createElement('option');
                        option1.value = country.name.common;
                        option1.textContent = country.name.common;
                        nationalitySelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = country.name.common;
                        option2.textContent = country.name.common;
                        editCountrySelect.appendChild(option2);
                    });
                })
                .catch(error => {
                    console.error('Error fetching countries:', error);
                    // Add some default countries as fallback
                    const defaultCountries = ['USA', 'Canada', 'UK', 'Australia', 'Germany', 'France', 'Japan', 'China', 'India', 'Brazil'];
                    
                    const nationalitySelect = document.getElementById('nationality');
                    const editCountrySelect = document.getElementById('edit-country');
                    
                    nationalitySelect.innerHTML = '<option value="">Select Country</option>';
                    editCountrySelect.innerHTML = '<option value="">Select Country</option>';
                    
                    defaultCountries.forEach(country => {
                        const option1 = document.createElement('option');
                        option1.value = country;
                        option1.textContent = country;
                        nationalitySelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = country;
                        option2.textContent = country;
                        editCountrySelect.appendChild(option2);
                    });
                });
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            // Login form submission
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Register link
            document.getElementById('register-link').addEventListener('click', openRegisterPopup);
            document.getElementById('close-register').addEventListener('click', closeRegisterPopup);
            document.getElementById('cancel-register').addEventListener('click', closeRegisterPopup);
            document.getElementById('register-form').addEventListener('submit', handleRegistration);
            
            // Profile dropdown
            document.getElementById('profile-button').addEventListener('click', toggleProfileDropdown);
            document.getElementById('view-profile').addEventListener('click', openProfilePopup);
            document.getElementById('view-users').addEventListener('click', openUsersPopup);
            document.getElementById('toggle-mode').addEventListener('click', toggleDarkMode);
            document.getElementById('logout').addEventListener('click', handleLogout);
            
            // Dark mode toggle button
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
            
            // Profile popup
            document.getElementById('close-profile').addEventListener('click', closeProfilePopup);
            document.getElementById('edit-profile-btn').addEventListener('click', switchToProfileEdit);
            document.getElementById('cancel-profile-edit').addEventListener('click', switchToProfileView);
            document.getElementById('profile-edit').addEventListener('submit', saveProfileChanges);
            document.getElementById('profile-image-upload').addEventListener('change', handleProfileImageUpload);
            
            // Users popup
            document.getElementById('close-users').addEventListener('click', closeUsersPopup);
            
            // Task operations
            document.getElementById('add-task-btn').addEventListener('click', openAddTaskPopup);
            document.getElementById('close-task-popup').addEventListener('click', closeTaskPopup);
            document.getElementById('cancel-task').addEventListener('click', closeTaskPopup);
            document.getElementById('task-form').addEventListener('submit', saveTask);
            document.getElementById('add-subtask').addEventListener('click', addSubtaskField);
            
            // View task popup
            document.getElementById('close-view-task').addEventListener('click', closeViewTaskPopup);
            document.getElementById('close-view-task-btn').addEventListener('click', closeViewTaskPopup);
            document.getElementById('edit-task-from-view').addEventListener('click', editTaskFromView);
            
            // Status filter
            document.getElementById('status-filter').addEventListener('change', filterTasks);
            
            // Category filter
            document.getElementById('category-filter').addEventListener('change', filterTasks);
            
            // Due date filter
            document.getElementById('due-date-filter').addEventListener('change', handleDueDateFilter);
            document.getElementById('apply-date-range').addEventListener('click', filterTasks);
            
            // Search
            document.getElementById('task-search').addEventListener('input', debounce(filterTasks, 300));
            
            // Sort
            document.getElementById('sort-by').addEventListener('change', sortTasks);
            
            // View switcher
            document.getElementById('list-view-btn').addEventListener('click', switchToListView);
            document.getElementById('graph-view-btn').addEventListener('click', switchToGraphView);
            
            // Undo/Redo
            document.getElementById('undo-btn').addEventListener('click', undoAction);
            document.getElementById('redo-btn').addEventListener('click', redoAction);
            
            // Multi-select action bar
            document.getElementById('batch-complete').addEventListener('click', batchCompleteSelectedTasks);
            document.getElementById('batch-delete').addEventListener('click', batchDeleteSelectedTasks);
            document.getElementById('batch-cancel').addEventListener('click', cancelMultiSelect);
            
            // Categories management
            document.getElementById('manage-categories-btn').addEventListener('click', openCategoriesPopup);
            document.getElementById('close-categories').addEventListener('click', closeCategoriesPopup);
            document.getElementById('close-categories-btn').addEventListener('click', closeCategoriesPopup);
            document.getElementById('add-category-btn').addEventListener('click', addNewCategory);
            
            // Import/Export
            document.getElementById('export-btn').addEventListener('click', toggleExportDropdown);
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', handleExport);
            });
            document.getElementById('import-btn').addEventListener('click', openImportPopup);
            document.getElementById('close-import').addEventListener('click', closeImportPopup);
            document.getElementById('cancel-import').addEventListener('click', closeImportPopup);
            document.getElementById('import-file').addEventListener('change', handleImportFileSelect);
            document.getElementById('confirm-import').addEventListener('click', importTasks);
            
            // Timer controls
            document.getElementById('timer-play').addEventListener('click', startGlobalTimer);
            document.getElementById('timer-pause').addEventListener('click', pauseGlobalTimer);
            
            // Notification dropdown
            document.getElementById('notification-button').addEventListener('click', toggleNotificationDropdown);
            document.getElementById('mark-all-read').addEventListener('click', markAllNotificationsAsRead);
            
            // Status dropdown
            document.getElementById('status-dropdown-button').addEventListener('click', toggleStatusDropdown);
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', changeUserStatus);
            });
            
            // Close dropdowns and popups when clicking outside
            document.addEventListener('click', handleOutsideClick);
            
            // Add keydown listener for ESC key to close popups
            document.addEventListener('keydown', handleKeyDown);
        }
        
        // Handle login form submission
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // Find user with matching credentials
            const user = appData.users.find(u => u.email === email && u.password === password);
            
            if (user) {
                appData.currentUser = user;
                saveDataToStorage();
                showToast('Login successful!', 'success');
                
                document.getElementById('profile-image').src = user.profileImage;
                document.getElementById('profile-button').className = 'w-10 h-10 rounded-full overflow-hidden status-online';
                
                // Switch to dashboard
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Update UI with user data
                updateTaskCounts();
                renderTasks();
                updateInsights();
                
                // Add notification for login
                addNotification({
                    type: 'system',
                    message: 'Welcome back! You are now logged in.',
                    timestamp: new Date().toISOString(),
                    read: false
                });
            } else {
                showToast('Invalid email or password', 'error');
            }
        }
        
        // Open registration popup
        function openRegisterPopup(event) {
            event.preventDefault();
            document.getElementById('register-popup').classList.remove('hidden');
        }
        
        // Close registration popup
        function closeRegisterPopup() {
            document.getElementById('register-popup').classList.add('hidden');
            document.getElementById('register-form').reset();
        }
        
        // Handle registration form submission
        function handleRegistration(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('regEmail').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const birthdate = document.getElementById('birthdate').value;
            const nationality = document.getElementById('nationality').value;
            const role = document.getElementById('role').value;
            
            // Validate inputs
            if (!firstName || !lastName || !email || !confirmEmail || !password || !confirmPassword || !birthdate || !nationality || !role) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (email !== confirmEmail) {
                showToast('Emails do not match', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            // Check if email already exists
            if (appData.users.some(u => u.email === email)) {
                showToast('Email is already registered', 'error');
                return;
            }
            
            // Create new user
            const newUser = {
                id: generateId(),
                firstName,
                lastName,
                email,
                password,
                birthdate,
                nationality,
                role,
                profileImage: getRandomProfileImage(),
                joinedDate: new Date().toISOString()
            };
            
            appData.users.push(newUser);
            appData.currentUser = newUser;
            saveDataToStorage();
            
            showToast('Registration successful! You are now logged in.', 'success');
            
            // Update UI
            document.getElementById('profile-image').src = newUser.profileImage;
            document.getElementById('profile-button').className = 'w-10 h-10 rounded-full overflow-hidden status-online';
            
            // Close registration popup and switch to dashboard
            closeRegisterPopup();
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Add notification for new registration
            addNotification({
                type: 'system',
                message: 'Welcome to the To-Do App! Your account has been created.',
                timestamp: new Date().toISOString(),
                read: false
            });
        }
        
        // Toggle profile dropdown
        function toggleProfileDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close other dropdowns
            document.getElementById('notification-dropdown').classList.add('hidden');
            document.getElementById('status-dropdown').classList.add('hidden');
            document.getElementById('export-dropdown').classList.add('hidden');
        }
        
        // Toggle notification dropdown
        function toggleNotificationDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notification-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close other dropdowns
            document.getElementById('profile-dropdown').classList.add('hidden');
            document.getElementById('status-dropdown').classList.add('hidden');
            document.getElementById('export-dropdown').classList.add('hidden');
            
            renderNotifications();
        }
        
        // Toggle status dropdown
        function toggleStatusDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('status-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close other dropdowns
            document.getElementById('profile-dropdown').classList.add('hidden');
            document.getElementById('notification-dropdown').classList.add('hidden');
            document.getElementById('export-dropdown').classList.add('hidden');
        }
        
        // Toggle export dropdown
        function toggleExportDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('export-dropdown');
            dropdown.classList.toggle('hidden');
            
            // Close other dropdowns
            document.getElementById('profile-dropdown').classList.add('hidden');
            document.getElementById('notification-dropdown').classList.add('hidden');
            document.getElementById('status-dropdown').classList.add('hidden');
        }
        
        // Handle click outside of dropdowns
        function handleOutsideClick(event) {
            // Close profile dropdown if clicking outside
            const profileButton = document.getElementById('profile-button');
            const profileDropdown = document.getElementById('profile-dropdown');
            if (!profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.add('hidden');
            }
            
            // Close notification dropdown if clicking outside
            const notificationButton = document.getElementById('notification-button');
            const notificationDropdown = document.getElementById('notification-dropdown');
            if (!notificationButton.contains(event.target) && !notificationDropdown.contains(event.target)) {
                notificationDropdown.classList.add('hidden');
            }
            
            // Close status dropdown if clicking outside
            const statusButton = document.getElementById('status-dropdown-button');
            const statusDropdown = document.getElementById('status-dropdown');
            if (!statusButton.contains(event.target) && !statusDropdown.contains(event.target)) {
                statusDropdown.classList.add('hidden');
            }
            
            // Close export dropdown if clicking outside
            const exportButton = document.getElementById('export-btn');
            const exportDropdown = document.getElementById('export-dropdown');
            if (!exportButton.contains(event.target) && !exportDropdown.contains(event.target)) {
                exportDropdown.classList.add('hidden');
            }
        }
        
        // Handle keydown for ESC key to close popups
        function handleKeyDown(event) {
            if (event.key === 'Escape') {
                // Close all popups
                document.querySelectorAll('.popup-overlay').forEach(popup => {
                    popup.classList.add('hidden');
                });
                
                // Close all dropdowns
                document.getElementById('profile-dropdown').classList.add('hidden');
                document.getElementById('notification-dropdown').classList.add('hidden');
                document.getElementById('status-dropdown').classList.add('hidden');
                document.getElementById('export-dropdown').classList.add('hidden');
            }
        }
        
        // Change user status
        function changeUserStatus(event) {
            event.preventDefault();
            const status = event.currentTarget.getAttribute('data-status');
            
            // Update UI
            const statusText = document.getElementById('current-status');
            const statusIndicator = statusText.previousElementSibling;
            const profileButton = document.getElementById('profile-button');
            
            // Remove all status classes
            profileButton.classList.remove('status-online', 'status-break', 'status-offline', 'status-shadow');
            
            // Add the selected status class
            profileButton.classList.add(`status-${status}`);
            
            // Update status text
            if (status === 'online') {
                statusText.textContent = 'Online';
                statusIndicator.className = 'w-2 h-2 bg-success rounded-full';
            } else if (status === 'break') {
                statusText.textContent = 'On Break';
                statusIndicator.className = 'w-2 h-2 bg-warning rounded-full';
            } else if (status === 'shadow') {
                statusText.textContent = 'Shadow';
                statusIndicator.className = 'w-2 h-2 bg-muted rounded-full';
            } else if (status === 'offline') {
                statusText.textContent = 'Offline';
                statusIndicator.className = 'w-2 h-2 bg-danger rounded-full';
            }
            
            // Close status dropdown
            document.getElementById('status-dropdown').classList.add('hidden');
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            
            if (document.documentElement.classList.contains('dark')) {
                document.getElementById('toggle-mode-text').textContent = 'Light Mode';
            } else {
                document.getElementById('toggle-mode-text').textContent = 'Dark Mode';
            }
            
            // Close dropdown
            document.getElementById('profile-dropdown').classList.add('hidden');
            
            // Update charts if they exist
            updateGraphs();
        }
        
        // Handle logout
        function handleLogout() {
            // Clear current user
            appData.currentUser = null;
            
            // Stop any active timer
            if (appData.timerInterval) {
                clearInterval(appData.timerInterval);
                appData.timerInterval = null;
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Reset forms
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            
            // Switch back to login page
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            
            showToast('You have been logged out', 'info');
        }
        
        // Open profile popup
        function openProfilePopup() {
            if (!appData.currentUser) {
                showToast('Please login first', 'error');
                return;
            }
            
            // Fill profile view with current user data
            document.getElementById('view-profile-image').src = appData.currentUser.profileImage;
            document.getElementById('view-profile-name').textContent = `${appData.currentUser.firstName} ${appData.currentUser.lastName}`;
            document.getElementById('view-profile-role').textContent = appData.currentUser.role;
            document.getElementById('view-profile-email').textContent = appData.currentUser.email;
            document.getElementById('view-profile-country').textContent = appData.currentUser.nationality;
            
            // Format and display joined date
            const joinedDate = new Date(appData.currentUser.joinedDate);
            document.getElementById('view-profile-joined').textContent = joinedDate.toLocaleDateString();
            
            // Fill edit form with current user data
            document.getElementById('edit-profile-image').src = appData.currentUser.profileImage;
            document.getElementById('edit-first-name').value = appData.currentUser.firstName;
            document.getElementById('edit-last-name').value = appData.currentUser.lastName;
            document.getElementById('edit-email').value = appData.currentUser.email;
            
            // Set country dropdown
            const countrySelect = document.getElementById('edit-country');
            for (let i = 0; i < countrySelect.options.length; i++) {
                if (countrySelect.options[i].value === appData.currentUser.nationality) {
                    countrySelect.selectedIndex = i;
                    break;
                }
            }
            
            // Show profile view, hide edit form
            document.getElementById('profile-view').classList.remove('hidden');
            document.getElementById('profile-edit').classList.add('hidden');
            
            // Show profile popup
            document.getElementById('profile-popup').classList.remove('hidden');
            
            // Close profile dropdown
            document.getElementById('profile-dropdown').classList.add('hidden');
        }
        
        // Close profile popup
        function closeProfilePopup() {
            document.getElementById('profile-popup').classList.add('hidden');
        }
        
        // Switch to profile edit mode
        function switchToProfileEdit() {
            document.getElementById('profile-view').classList.add('hidden');
            document.getElementById('profile-edit').classList.remove('hidden');
        }
        
        // Switch to profile view mode
        function switchToProfileView() {
            document.getElementById('profile-view').classList.remove('hidden');
            document.getElementById('profile-edit').classList.add('hidden');
        }
        
        // Handle profile image upload
        function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-profile-image').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Save profile changes
        function saveProfileChanges(event) {
            event.preventDefault();
            
            if (!appData.currentUser) {
                showToast('Please login first', 'error');
                return;
            }
            
            // Get updated values
            const firstName = document.getElementById('edit-first-name').value;
            const lastName = document.getElementById('edit-last-name').value;
            const email = document.getElementById('edit-email').value;
            const country = document.getElementById('edit-country').value;
            const profileImage = document.getElementById('edit-profile-image').src;
            
            // Validate inputs
            if (!firstName || !lastName || !email || !country) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Check if email is already in use by another user
            const emailExists = appData.users.some(user => 
                user.id !== appData.currentUser.id && user.email === email
            );
            
            if (emailExists) {
                showToast('Email is already in use by another account', 'error');
                return;
            }
            
            // Save changes to current user
            appData.currentUser.firstName = firstName;
            appData.currentUser.lastName = lastName;
            appData.currentUser.email = email;
            appData.currentUser.nationality = country;
            appData.currentUser.profileImage = profileImage;
            
            // Update user in users array
            const userIndex = appData.users.findIndex(user => user.id === appData.currentUser.id);
            if (userIndex !== -1) {
                appData.users[userIndex] = { ...appData.currentUser };
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            document.getElementById('profile-image').src = profileImage;
            
            // Update profile view
            document.getElementById('view-profile-image').src = profileImage;
            document.getElementById('view-profile-name').textContent = `${firstName} ${lastName}`;
            document.getElementById('view-profile-email').textContent = email;
            document.getElementById('view-profile-country').textContent = country;
            
            // Switch back to profile view
            switchToProfileView();
            
            showToast('Profile updated successfully', 'success');
            
            // Add notification
            addNotification({
                type: 'system',
                message: 'Your profile has been updated.',
                timestamp: new Date().toISOString(),
                read: false
            });
        }
        
        // Open users popup
        function openUsersPopup() {
            renderUsers();
            document.getElementById('users-popup').classList.remove('hidden');
            document.getElementById('profile-dropdown').classList.add('hidden');
        }
        
        // Close users popup
        function closeUsersPopup() {
            document.getElementById('users-popup').classList.add('hidden');
        }
        
        // Render users
        function renderUsers() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            if (appData.users.length === 0) {
                usersList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-6">No users found</p>';
                return;
            }
            
            appData.users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'bg-white dark:bg-gray-700 rounded-lg shadow-sm p-4 flex flex-col items-center transform hover:scale-105 transition-transform glass';
                
                userCard.innerHTML = `
                    <div class="w-16 h-16 rounded-full overflow-hidden mb-3">
                        <img src="${user.profileImage}" alt="${user.firstName}" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-semibold text-lg">${user.firstName} ${user.lastName}</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-1">${user.email}</p>
                    <span class="bg-primary bg-opacity-10 text-primary dark:text-primary-light px-2 py-1 rounded text-xs">${user.role}</span>
                `;
                
                usersList.appendChild(userCard);
            });
        }
        
        // Open add task popup
        function openAddTaskPopup() {
            // Reset form
            document.getElementById('task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('subtasks-container').innerHTML = '';
            document.getElementById('task-popup-title').textContent = 'Add New Task';
            document.getElementById('save-task').textContent = 'Create';
            
            // Show popup
            document.getElementById('add-task-popup').classList.remove('hidden');
        }
        
        // Close task popup
        function closeTaskPopup() {
            document.getElementById('add-task-popup').classList.add('hidden');
        }
        
        // Add subtask field
        function addSubtaskField() {
            const subtasksContainer = document.getElementById('subtasks-container');
            const index = subtasksContainer.children.length;
            
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'flex items-center space-x-2';
            subtaskDiv.innerHTML = `
                <input type="text" class="subtask-input flex-grow px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Subtask ${index + 1}">
                <button type="button" class="remove-subtask p-2 text-danger hover:text-opacity-80">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add event listener to remove button
            subtaskDiv.querySelector('.remove-subtask').addEventListener('click', () => {
                subtaskDiv.remove();
            });
            
            subtasksContainer.appendChild(subtaskDiv);
        }
        
        // Save task
        function saveTask(event) {
            event.preventDefault();
            
            // Get task data
            const taskId = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;
            const priority = document.getElementById('task-priority').value;
            const category = document.getElementById('task-category').value;
            const notes = document.getElementById('task-notes').value;
            
            // Get subtasks
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            const subtasks = Array.from(subtaskInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
            
            // Validate inputs
            if (!title || !dueDate || !priority || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Create task object
            const taskData = {
                title,
                description,
                dueDate: new Date(dueDate).toISOString(),
                priority,
                category,
                notes,
                subtasks,
                completed: false,
                timeSpent: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Add to undo stack
            if (taskId) {
                // Editing existing task
                const oldTask = appData.tasks.find(task => task.id === taskId);
                if (oldTask) {
                    addToUndoStack({
                        type: 'edit',
                        oldData: { ...oldTask },
                        newData: { ...oldTask, ...taskData }
                    });
                }
            } else {
                // Creating new task
                addToUndoStack({
                    type: 'add',
                    newData: { ...taskData, id: generateId() }
                });
            }
            
            if (taskId) {
                // Update existing task
                const taskIndex = appData.tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex] = { 
                        ...appData.tasks[taskIndex],
                        ...taskData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    showToast('Task updated successfully', 'success');
                    
                    // Add notification
                    addNotification({
                        type: 'task',
                        message: `Task "${title}" has been updated.`,
                        timestamp: new Date().toISOString(),
                        read: false,
                        taskId: taskId
                    });
                }
            } else {
                // Create new task
                const newTask = {
                    id: generateId(),
                    ...taskData,
                    timeSpent: 0
                };
                
                appData.tasks.push(newTask);
                
                showToast('Task created successfully', 'success');
                
                // Add notification
                addNotification({
                    type: 'task',
                    message: `New task "${title}" has been created.`,
                    timestamp: new Date().toISOString(),
                    read: false,
                    taskId: newTask.id
                });
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            
            // Close popup
            closeTaskPopup();
        }
        
        // Open view task popup
        function openViewTaskPopup(taskId) {
            const task = appData.tasks.find(task => task.id === taskId);
            if (!task) return;
            
            // Fill popup with task data
            document.getElementById('view-task-title').textContent = task.title;
            document.getElementById('view-task-description').textContent = task.description || 'No description provided';
            
            // Format due date
            const dueDate = new Date(task.dueDate);
            document.getElementById('view-task-due-date').textContent = dueDate.toLocaleString();
            
            // Set priority with appropriate styling
            const priorityElement = document.getElementById('view-task-priority');
            priorityElement.innerHTML = '';
            
            const priorityBadge = document.createElement('span');
            
            if (task.priority === 'high') {
                priorityBadge.className = 'px-2 py-1 bg-danger text-white text-xs rounded';
                priorityBadge.textContent = 'High';
            } else if (task.priority === 'medium') {
                priorityBadge.className = 'px-2 py-1 bg-warning text-white text-xs rounded';
                priorityBadge.textContent = 'Medium';
            } else {
                priorityBadge.className = 'px-2 py-1 bg-muted text-white text-xs rounded';
                priorityBadge.textContent = 'Low';
            }
            
            priorityElement.appendChild(priorityBadge);
            
            // Set category
            document.getElementById('view-task-category').textContent = task.category;
            
            // Set status
            const statusElement = document.getElementById('view-task-status');
            statusElement.innerHTML = '';
            
            const statusBadge = document.createElement('span');
            
            if (task.completed) {
                statusBadge.className = 'px-2 py-1 bg-success text-white text-xs rounded';
                statusBadge.textContent = 'Completed';
            } else {
                statusBadge.className = 'px-2 py-1 bg-primary text-white text-xs rounded';
                statusBadge.textContent = 'Active';
            }
            
            statusElement.appendChild(statusBadge);
            
            // Set time tracked
            document.getElementById('view-task-time').textContent = formatTime(task.timeSpent);
            
            // Set notes
            if (task.notes) {
                document.getElementById('view-task-notes').textContent = task.notes;
                document.getElementById('view-task-notes-container').classList.remove('hidden');
            } else {
                document.getElementById('view-task-notes-container').classList.add('hidden');
            }
            
            // Set subtasks
            if (task.subtasks && task.subtasks.length > 0) {
                const subtasksList = document.getElementById('view-subtasks-list');
                subtasksList.innerHTML = '';
                
                task.subtasks.forEach(subtask => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center';
                    li.innerHTML = `
                        <i class="fas fa-circle text-xs text-primary mr-2"></i>
                        <span>${subtask}</span>
                    `;
                    subtasksList.appendChild(li);
                });
                
                document.getElementById('view-subtasks-container').classList.remove('hidden');
            } else {
                document.getElementById('view-subtasks-container').classList.add('hidden');
            }
            
            // Setup edit button
            document.getElementById('edit-task-from-view').onclick = () => {
                closeViewTaskPopup();
                openEditTaskPopup(taskId);
            };
            
            // Show popup
            document.getElementById('view-task-popup').classList.remove('hidden');
        }
        
        // Close view task popup
        function closeViewTaskPopup() {
            document.getElementById('view-task-popup').classList.add('hidden');
        }
        
        // Edit task from view
        function editTaskFromView() {
            const taskTitle = document.getElementById('view-task-title').textContent;
            const task = appData.tasks.find(task => task.title === taskTitle);
            
            if (task) {
                closeViewTaskPopup();
                openEditTaskPopup(task.id);
            }
        }
        
        // Open edit task popup
        function openEditTaskPopup(taskId) {
            const task = appData.tasks.find(task => task.id === taskId);
            if (!task) return;
            
            // Reset form
            document.getElementById('task-form').reset();
            document.getElementById('subtasks-container').innerHTML = '';
            
            // Fill form with task data
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-description').value = task.description || '';
            
            // Format due date for flatpickr
            const dueDate = new Date(task.dueDate);
            const year = dueDate.getFullYear();
            const month = String(dueDate.getMonth() + 1).padStart(2, '0');
            const day = String(dueDate.getDate()).padStart(2, '0');
            const hours = String(dueDate.getHours()).padStart(2, '0');
            const minutes = String(dueDate.getMinutes()).padStart(2, '0');
            document.getElementById('task-due-date').value = `${year}-${month}-${day} ${hours}:${minutes}`;
            
            // Set priority
            document.getElementById('task-priority').value = task.priority;
            
            // Set category
            document.getElementById('task-category').value = task.category;
            
            // Set notes
            document.getElementById('task-notes').value = task.notes || '';
            
            // Add subtasks
            if (task.subtasks && task.subtasks.length > 0) {
                task.subtasks.forEach(subtask => {
                    const subtasksContainer = document.getElementById('subtasks-container');
                    const subtaskDiv = document.createElement('div');
                    subtaskDiv.className = 'flex items-center space-x-2';
                    subtaskDiv.innerHTML = `
                        <input type="text" class="subtask-input flex-grow px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary" value="${subtask}">
                        <button type="button" class="remove-subtask p-2 text-danger hover:text-opacity-80">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Add event listener to remove button
                    subtaskDiv.querySelector('.remove-subtask').addEventListener('click', () => {
                        subtaskDiv.remove();
                    });
                    
                    subtasksContainer.appendChild(subtaskDiv);
                });
            }
            
            // Update popup title and button text
            document.getElementById('task-popup-title').textContent = 'Edit Task';
            document.getElementById('save-task').textContent = 'Save Changes';
            
            // Show popup
            document.getElementById('add-task-popup').classList.remove('hidden');
        }
        
        // Delete task
        function deleteTask(taskId) {
            const task = appData.tasks.find(task => task.id === taskId);
            if (!task) return;
            
            // Add to undo stack
            addToUndoStack({
                type: 'delete',
                oldData: { ...task }
            });
            
            // Remove task
            appData.tasks = appData.tasks.filter(task => task.id !== taskId);
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            
            showToast(`Task "${task.title}" deleted successfully`, 'success');
            
            // Add notification
            addNotification({
                type: 'task',
                message: `Task "${task.title}" has been deleted.`,
                timestamp: new Date().toISOString(),
                read: false
            });
        }
        
        // Toggle task completion
        function toggleTaskCompletion(taskId) {
            const taskIndex = appData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            const task = appData.tasks[taskIndex];
            const newCompletedValue = !task.completed;
            
            // Add to undo stack
            addToUndoStack({
                type: 'toggle',
                oldData: { ...task },
                newData: { ...task, completed: newCompletedValue }
            });
            
            // Update task
            appData.tasks[taskIndex].completed = newCompletedValue;
            appData.tasks[taskIndex].updatedAt = new Date().toISOString();
            
            // If task was being timed, stop timer
            if (appData.activeTaskId === taskId && newCompletedValue) {
                pauseTaskTimer();
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            
            showToast(`Task "${task.title}" marked as ${newCompletedValue ? 'completed' : 'active'}`, 'success');
            
            // Add notification
            addNotification({
                type: 'task',
                message: `Task "${task.title}" marked as ${newCompletedValue ? 'completed' : 'active'}.`,
                timestamp: new Date().toISOString(),
                read: false,
                taskId: taskId
            });
        }
        
        // Handle due date filter change
        function handleDueDateFilter() {
            const filter = document.getElementById('due-date-filter').value;
            const customRangeDiv = document.getElementById('custom-date-range');
            
            if (filter === 'custom') {
                customRangeDiv.classList.remove('hidden');
            } else {
                customRangeDiv.classList.add('hidden');
                filterTasks();
            }
        }
        
        // Filter tasks
        function filterTasks() {
            renderTasks();
        }
        
        // Sort tasks
        function sortTasks() {
            renderTasks();
        }
        
        // Switch to list view
        function switchToListView() {
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('graph-view').classList.add('hidden');
            
            document.getElementById('list-view-btn').classList.add('bg-primary', 'text-white');
            document.getElementById('list-view-btn').classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            
            document.getElementById('graph-view-btn').classList.remove('bg-primary', 'text-white');
            document.getElementById('graph-view-btn').classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        }
        
        // Switch to graph view
        function switchToGraphView() {
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('graph-view').classList.remove('hidden');
            
            document.getElementById('graph-view-btn').classList.add('bg-primary', 'text-white');
            document.getElementById('graph-view-btn').classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            
            document.getElementById('list-view-btn').classList.remove('bg-primary', 'text-white');
            document.getElementById('list-view-btn').classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            
            // Initialize or update graphs
            updateGraphs();
        }
        
        // Update graphs
        function updateGraphs() {
            // Tasks Timeline Chart
            const timelineCtx = document.getElementById('tasks-timeline-chart').getContext('2d');
            
            // Group tasks by date (last 7 days)
            const today = new Date();
            const dates = [];
            const completedData = [];
            const pendingData = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                const dayTasks = appData.tasks.filter(task => {
                    const taskDate = new Date(task.createdAt);
                    return taskDate.toDateString() === date.toDateString();
                });
                
                completedData.push(dayTasks.filter(task => task.completed).length);
                pendingData.push(dayTasks.filter(task => !task.completed).length);
            }
            
            // Create or update chart
            if (window.timelineChart) {
                window.timelineChart.data.labels = dates;
                window.timelineChart.data.datasets[0].data = completedData;
                window.timelineChart.data.datasets[1].data = pendingData;
                window.timelineChart.update();
            } else {
                window.timelineChart = new Chart(timelineCtx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Completed',
                                data: completedData,
                                borderColor: '#28A745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Pending',
                                data: pendingData,
                                borderColor: '#FFC107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    precision: 0,
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            }
                        }
                    }
                });
            }
            
            // Tasks Status Chart (Pie)
            const statusCtx = document.getElementById('tasks-status-chart').getContext('2d');
            
            const completed = appData.tasks.filter(task => task.completed).length;
            const pending = appData.tasks.filter(task => !task.completed).length;
            
            // Create or update chart
            if (window.statusChart) {
                window.statusChart.data.datasets[0].data = [completed, pending];
                window.statusChart.update();
            } else {
                window.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completed', 'Pending'],
                        datasets: [{
                            data: [completed, pending],
                            backgroundColor: ['#28A745', '#FFC107'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            }
                        }
                    }
                });
            }
            
            // Tasks Priority Chart
            const priorityCtx = document.getElementById('tasks-priority-chart').getContext('2d');
            
            const highPriority = appData.tasks.filter(task => task.priority === 'high').length;
            const mediumPriority = appData.tasks.filter(task => task.priority === 'medium').length;
            const lowPriority = appData.tasks.filter(task => task.priority === 'low').length;
            
            // Create or update chart
            if (window.priorityChart) {
                window.priorityChart.data.datasets[0].data = [highPriority, mediumPriority, lowPriority];
                window.priorityChart.update();
            } else {
                window.priorityChart = new Chart(priorityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['High', 'Medium', 'Low'],
                        datasets: [{
                            label: 'Tasks by Priority',
                            data: [highPriority, mediumPriority, lowPriority],
                            backgroundColor: ['#DC3545', '#FD7E14', '#6C757D']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    precision: 0,
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            }
                        }
                    }
                });
            }
            
            // Tasks Category Chart
            const categoryCtx = document.getElementById('tasks-category-chart').getContext('2d');
            
            // Group tasks by category
            const categories = {};
            appData.tasks.forEach(task => {
                if (!categories[task.category]) {
                    categories[task.category] = 0;
                }
                categories[task.category]++;
            });
            
            const categoryLabels = Object.keys(categories);
            const categoryData = Object.values(categories);
            const categoryColors = generateRandomColors(categoryLabels.length);
            
            // Create or update chart
            if (window.categoryChart) {
                window.categoryChart.data.labels = categoryLabels;
                window.categoryChart.data.datasets[0].data = categoryData;
                window.categoryChart.data.datasets[0].backgroundColor = categoryColors;
                window.categoryChart.update();
            } else {
                window.categoryChart = new Chart(categoryCtx, {
                    type: 'pie',
                    data: {
                        labels: categoryLabels,
                        datasets: [{
                            data: categoryData,
                            backgroundColor: categoryColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: document.documentElement.classList.contains('dark') ? '#F8F9FA' : '#343A40'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Generate random colors for charts
        function generateRandomColors(count) {
            const colors = [];
            const baseColors = [
                '#4BC0C0', '#FF6384', '#9966FF', '#FFCD56', '#36A2EB',
                '#FF9F40', '#4D5360', '#5D5CDE', '#00A86B', '#FF8042'
            ];
            
            for (let i = 0; i < count; i++) {
                if (i < baseColors.length) {
                    colors.push(baseColors[i]);
                } else {
                    // Generate random color if we run out of base colors
                    const r = Math.floor(Math.random() * 200) + 55;
                    const g = Math.floor(Math.random() * 200) + 55;
                    const b = Math.floor(Math.random() * 200) + 55;
                    colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
                }
            }
            
            return colors;
        }
        
        // Open categories popup
        function openCategoriesPopup() {
            renderCategories();
            document.getElementById('categories-popup').classList.remove('hidden');
        }
        
        // Close categories popup
        function closeCategoriesPopup() {
            document.getElementById('categories-popup').classList.add('hidden');
        }
        
        // Render categories
        function renderCategories() {
            const categoriesList = document.getElementById('categories-list');
            const noCategories = document.getElementById('no-categories');
            
            // Clear list
            categoriesList.innerHTML = '';
            
            if (appData.categories.length === 0) {
                categoriesList.appendChild(noCategories);
                return;
            } else {
                if (noCategories.parentNode === categoriesList) {
                    categoriesList.removeChild(noCategories);
                }
            }
            
            // Add categories
            appData.categories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'py-3 flex items-center justify-between';
                li.innerHTML = `
                    <span class="category-name">${category.name}</span>
                    <div class="flex items-center space-x-2">
                        <button class="edit-category p-1 text-primary hover:text-opacity-80" data-id="${category.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-category p-1 text-danger hover:text-opacity-80" data-id="${category.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                // Add event listeners
                li.querySelector('.edit-category').addEventListener('click', () => {
                    editCategory(category.id);
                });
                
                li.querySelector('.delete-category').addEventListener('click', () => {
                    deleteCategory(category.id);
                });
                
                categoriesList.appendChild(li);
            });
        }
        
        // Add new category
        function addNewCategory() {
            const nameInput = document.getElementById('new-category');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('Please enter a category name', 'error');
                return;
            }
            
            // Check if category already exists
            if (appData.categories.some(category => category.name.toLowerCase() === name.toLowerCase())) {
                showToast('Category already exists', 'error');
                return;
            }
            
            // Create new category
            const newCategory = {
                id: generateId(),
                name
            };
            
            appData.categories.push(newCategory);
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            nameInput.value = '';
            renderCategories();
            updateCategoryDropdowns();
            
            showToast(`Category "${name}" added successfully`, 'success');
        }
        
        // Edit category
        function editCategory(categoryId) {
            const category = appData.categories.find(category => category.id === categoryId);
            if (!category) return;
            
            const li = document.querySelector(`.edit-category[data-id="${categoryId}"]`).closest('li');
            const categoryName = li.querySelector('.category-name');
            const oldName = categoryName.textContent;
            
            // Change to input field
            categoryName.innerHTML = `
                <input type="text" class="edit-category-input px-2 py-1 border border-gray-300 dark:border-gray-600 rounded" value="${oldName}">
            `;
            
            // Change buttons
            li.querySelector('.edit-category').innerHTML = '<i class="fas fa-check"></i>';
            li.querySelector('.delete-category').innerHTML = '<i class="fas fa-times"></i>';
            
            // Update event listeners
            li.querySelector('.edit-category').addEventListener('click', () => {
                const newName = li.querySelector('.edit-category-input').value.trim();
                
                if (!newName) {
                    showToast('Category name cannot be empty', 'error');
                    return;
                }
                
                // Check if name already exists
                if (appData.categories.some(c => c.id !== categoryId && c.name.toLowerCase() === newName.toLowerCase())) {
                    showToast('Category name already exists', 'error');
                    return;
                }
                
                // Update category
                category.name = newName;
                
                // Update tasks with this category
                appData.tasks.forEach(task => {
                    if (task.category === oldName) {
                        task.category = newName;
                    }
                });
                
                // Save to storage
                saveDataToStorage();
                
                // Update UI
                renderCategories();
                updateCategoryDropdowns();
                renderTasks();
                
                showToast(`Category updated successfully`, 'success');
            }, { once: true });
            
            li.querySelector('.delete-category').addEventListener('click', () => {
                renderCategories();
            }, { once: true });
            
            // Focus input
            li.querySelector('.edit-category-input').focus();
        }
        
        // Delete category
        function deleteCategory(categoryId) {
            const category = appData.categories.find(category => category.id === categoryId);
            if (!category) return;
            
            // Check if category is in use
            const tasksUsingCategory = appData.tasks.filter(task => task.category === category.name);
            
            if (tasksUsingCategory.length > 0) {
                showToast(`Cannot delete category "${category.name}" because it is used by ${tasksUsingCategory.length} task(s)`, 'error');
                return;
            }
            
            // Remove category
            appData.categories = appData.categories.filter(c => c.id !== categoryId);
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            renderCategories();
            updateCategoryDropdowns();
            
            showToast(`Category "${category.name}" deleted successfully`, 'success');
        }
        
        // Update category dropdowns
        function updateCategoryDropdowns() {
            const categoryFilter = document.getElementById('category-filter');
            const taskCategory = document.getElementById('task-category');
            
            // Remember selected values
            const filterValue = categoryFilter.value;
            const taskValue = taskCategory.value;
            
            // Clear options
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            taskCategory.innerHTML = '<option value="">Select Category</option>';
            
            // Add categories
            appData.categories.forEach(category => {
                const filterOption = document.createElement('option');
                filterOption.value = category.name;
                filterOption.textContent = category.name;
                categoryFilter.appendChild(filterOption);
                
                const taskOption = document.createElement('option');
                taskOption.value = category.name;
                taskOption.textContent = category.name;
                taskCategory.appendChild(taskOption);
            });
            
            // Restore selected values if they still exist
            if (filterValue && categoryFilter.querySelector(`option[value="${filterValue}"]`)) {
                categoryFilter.value = filterValue;
            }
            
            if (taskValue && taskCategory.querySelector(`option[value="${taskValue}"]`)) {
                taskCategory.value = taskValue;
            }
        }
        
        // Open import popup
        function openImportPopup() {
            document.getElementById('import-popup').classList.remove('hidden');
            document.getElementById('selected-file').textContent = 'No file selected';
            document.getElementById('confirm-import').disabled = true;
        }
        
        // Close import popup
        function closeImportPopup() {
            document.getElementById('import-popup').classList.add('hidden');
            document.getElementById('import-file').value = '';
        }
        
        // Handle import file selection
        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('selected-file').textContent = file.name;
                document.getElementById('confirm-import').disabled = false;
            } else {
                document.getElementById('selected-file').textContent = 'No file selected';
                document.getElementById('confirm-import').disabled = true;
            }
        }
        
        // Import tasks
        function importTasks() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a file', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        showToast('Invalid import format. Expected an array of tasks.', 'error');
                        return;
                    }
                    
                    // Validate and import tasks
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    importedData.forEach(task => {
                        // Check if task has required fields
                        if (!task.title || !task.dueDate) {
                            skippedCount++;
                            return;
                        }
                        
                        // Check if task already exists (by title and dueDate)
                        const exists = appData.tasks.some(t => 
                            t.title === task.title && t.dueDate === task.dueDate
                        );
                        
                        if (exists) {
                            skippedCount++;
                            return;
                        }
                        
                        // Import task
                        const newTask = {
                            id: generateId(),
                            title: task.title,
                            description: task.description || '',
                            dueDate: task.dueDate,
                            priority: task.priority || 'medium',
                            category: task.category || 'Imported',
                            notes: task.notes || '',
                            subtasks: Array.isArray(task.subtasks) ? task.subtasks : [],
                            completed: task.completed || false,
                            timeSpent: task.timeSpent || 0,
                            createdAt: task.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        appData.tasks.push(newTask);
                        importedCount++;
                        
                        // Import categories if they don't exist
                        if (newTask.category && !appData.categories.some(c => c.name === newTask.category)) {
                            appData.categories.push({
                                id: generateId(),
                                name: newTask.category
                            });
                        }
                    });
                    
                    // Save to storage
                    saveDataToStorage();
                    
                    // Update UI
                    updateTaskCounts();
                    updateCategoryDropdowns();
                    renderTasks();
                    updateInsights();
                    
                    showToast(`Imported ${importedCount} tasks successfully. Skipped ${skippedCount} tasks.`, 'success');
                    
                    // Close popup
                    closeImportPopup();
                    
                    // Add notification
                    addNotification({
                        type: 'system',
                        message: `Imported ${importedCount} tasks from file.`,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                } catch (error) {
                    showToast('Error parsing import file. Please make sure it is valid JSON.', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // Handle export
        function handleExport(event) {
            event.preventDefault();
            const format = event.currentTarget.getAttribute('data-format');
            
            // Close export dropdown
            document.getElementById('export-dropdown').classList.add('hidden');
            
            // Handle different export formats
            if (format === 'pdf') {
                exportToPDF();
            } else if (format === 'excel') {
                exportToExcel();
            } else if (format === 'json') {
                exportToJSON();
            }
        }
        
        // Export to PDF
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text('Tasks Export', 14, 22);
                
                // Add date
                doc.setFontSize(11);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);
                
                // Add task count
                doc.text(`Total Tasks: ${appData.tasks.length}`, 14, 38);
                doc.text(`Completed: ${appData.tasks.filter(t => t.completed).length}`, 14, 46);
                doc.text(`Pending: ${appData.tasks.filter(t => !t.completed).length}`, 14, 54);
                
                // Add table header
                doc.setFontSize(12);
                doc.text('Title', 14, 70);
                doc.text('Due Date', 90, 70);
                doc.text('Priority', 140, 70);
                doc.text('Status', 170, 70);
                
                // Add horizontal line
                doc.line(14, 74, 196, 74);
                
                // Add tasks
                let y = 82;
                const tasksToExport = [...appData.tasks].sort((a, b) => {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
                
                tasksToExport.forEach((task, index) => {
                    // Check if we need a new page
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Add task data
                    doc.setFontSize(10);
                    
                    // Title (truncate if too long)
                    const title = task.title.length > 30 ? task.title.substring(0, 27) + '...' : task.title;
                    doc.text(title, 14, y);
                    
                    // Due date
                    const dueDate = new Date(task.dueDate).toLocaleDateString();
                    doc.text(dueDate, 90, y);
                    
                    // Priority
                    doc.text(capitalizeFirstLetter(task.priority), 140, y);
                    
                    // Status
                    doc.text(task.completed ? 'Completed' : 'Pending', 170, y);
                    
                    y += 8;
                });
                
                // Save the PDF
                doc.save('tasks-export.pdf');
                
                showToast('Tasks exported to PDF successfully', 'success');
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                showToast('Error exporting to PDF. Try again later.', 'error');
            }
        }
        
        // Export to Excel
        function exportToExcel() {
            try {
                // Prepare data
                const exportData = appData.tasks.map(task => ({
                    Title: task.title,
                    Description: task.description,
                    'Due Date': new Date(task.dueDate).toLocaleString(),
                    Priority: capitalizeFirstLetter(task.priority),
                    Category: task.category,
                    Status: task.completed ? 'Completed' : 'Pending',
                    'Time Spent': formatTime(task.timeSpent),
                    'Created At': new Date(task.createdAt).toLocaleString(),
                    'Updated At': new Date(task.updatedAt).toLocaleString()
                }));
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
                
                // Save the file
                XLSX.writeFile(wb, 'tasks-export.xlsx');
                
                showToast('Tasks exported to Excel successfully', 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showToast('Error exporting to Excel. Try again later.', 'error');
            }
        }
        
        // Export to JSON
        function exportToJSON() {
            try {
                // Create JSON string
                const jsonString = JSON.stringify(appData.tasks, null, 2);
                
                // Create blob
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // Create URL
                const url = URL.createObjectURL(blob);
                
                // Create a link and click it
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tasks-export.json';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Tasks exported to JSON successfully', 'success');
            } catch (error) {
                console.error('Error exporting to JSON:', error);
                showToast('Error exporting to JSON. Try again later.', 'error');
            }
        }
        
        // Start global timer
        function startGlobalTimer() {
            if (appData.timerActive) return;
            
            appData.timerActive = true;
            document.getElementById('timer-play').classList.add('hidden');
            document.getElementById('timer-pause').classList.remove('hidden');
            
            appData.timerInterval = setInterval(() => {
                appData.globalSeconds++;
                
                // Update active task time if there is one
                if (appData.activeTaskId) {
                    const taskIndex = appData.tasks.findIndex(task => task.id === appData.activeTaskId);
                    if (taskIndex !== -1) {
                        appData.tasks[taskIndex].timeSpent++;
                        
                        // Update task timer in the list
                        const taskTimerElement = document.querySelector(`#task-timer-${appData.activeTaskId}`);
                        if (taskTimerElement) {
                            taskTimerElement.textContent = formatTime(appData.tasks[taskIndex].timeSpent);
                        }
                    }
                }
                
                // Update global timer display
                document.getElementById('global-timer').textContent = formatTime(appData.globalSeconds);
                
                // Every minute, save data to storage
                if (appData.globalSeconds % 60 === 0) {
                    saveDataToStorage();
                }
            }, 1000);
        }
        
        // Pause global timer
        function pauseGlobalTimer() {
            if (!appData.timerActive) return;
            
            appData.timerActive = false;
            document.getElementById('timer-play').classList.remove('hidden');
            document.getElementById('timer-pause').classList.add('hidden');
            
            if (appData.timerInterval) {
                clearInterval(appData.timerInterval);
                appData.timerInterval = null;
            }
            
            // Save data to storage
            saveDataToStorage();
        }
        
        // Start task timer
        function startTaskTimer(taskId) {
            // Stop current task timer if there is one
            if (appData.activeTaskId && appData.activeTaskId !== taskId) {
                pauseTaskTimer();
            }
            
            // Set active task
            appData.activeTaskId = taskId;
            
            // Start global timer if not already running
            if (!appData.timerActive) {
                startGlobalTimer();
            }
            
            // Update UI
            const playButton = document.querySelector(`#task-play-${taskId}`);
            const pauseButton = document.querySelector(`#task-pause-${taskId}`);
            
            if (playButton && pauseButton) {
                playButton.classList.add('hidden');
                pauseButton.classList.remove('hidden');
            }
            
            // Show notification
            const task = appData.tasks.find(task => task.id === taskId);
            if (task) {
                showToast(`Timer started for task "${task.title}"`, 'info');
            }
        }
        
        // Pause task timer
        function pauseTaskTimer() {
            if (!appData.activeTaskId) return;
            
            const taskId = appData.activeTaskId;
            appData.activeTaskId = null;
            
            // Pause global timer
            pauseGlobalTimer();
            
            // Update UI
            const playButton = document.querySelector(`#task-play-${taskId}`);
            const pauseButton = document.querySelector(`#task-pause-${taskId}`);
            
            if (playButton && pauseButton) {
                playButton.classList.remove('hidden');
                pauseButton.classList.add('hidden');
            }
            
            // Show time spent
            const task = appData.tasks.find(task => task.id === taskId);
            if (task) {
                showToast(`Time spent on task "${task.title}": ${formatTime(task.timeSpent)}`, 'info');
            }
        }
        
        // Toggle task timer
        function toggleTaskTimer(taskId) {
            if (appData.activeTaskId === taskId) {
                pauseTaskTimer();
            } else {
                startTaskTimer(taskId);
            }
        }
        
        // Format time (seconds) to HH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // Add to undo stack
        function addToUndoStack(action) {
            appData.undoStack.push(action);
            appData.redoStack = [];
            updateUndoRedoButtons();
            appData.lastActionTimestamp = Date.now();
        }
        
        // Update undo/redo buttons
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            undoBtn.disabled = appData.undoStack.length === 0;
            redoBtn.disabled = appData.redoStack.length === 0;
        }
        
        // Undo action
        function undoAction() {
            if (appData.undoStack.length === 0) return;
            
            const action = appData.undoStack.pop();
            appData.redoStack.push(action);
            
            if (action.type === 'add') {
                // Remove added task
                appData.tasks = appData.tasks.filter(task => task.id !== action.newData.id);
            } else if (action.type === 'edit') {
                // Revert to old data
                const taskIndex = appData.tasks.findIndex(task => task.id === action.oldData.id);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex] = { ...action.oldData };
                }
            } else if (action.type === 'delete') {
                // Add back deleted task
                appData.tasks.push({ ...action.oldData });
            } else if (action.type === 'toggle') {
                // Revert completion status
                const taskIndex = appData.tasks.findIndex(task => task.id === action.oldData.id);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex].completed = action.oldData.completed;
                }
            } else if (action.type === 'batch-complete') {
                // Revert completion status for batch
                action.tasks.forEach(taskData => {
                    const taskIndex = appData.tasks.findIndex(task => task.id === taskData.id);
                    if (taskIndex !== -1) {
                        appData.tasks[taskIndex].completed = taskData.completed;
                    }
                });
            } else if (action.type === 'batch-delete') {
                // Add back deleted tasks
                action.tasks.forEach(taskData => {
                    appData.tasks.push({ ...taskData });
                });
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            updateUndoRedoButtons();
            
            showToast('Action undone', 'info');
        }
        
        // Redo action
        function redoAction() {
            if (appData.redoStack.length === 0) return;
            
            const action = appData.redoStack.pop();
            appData.undoStack.push(action);
            
            if (action.type === 'add') {
                // Add task again
                appData.tasks.push({ ...action.newData });
            } else if (action.type === 'edit') {
                // Apply new data
                const taskIndex = appData.tasks.findIndex(task => task.id === action.newData.id);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex] = { ...action.newData };
                }
            } else if (action.type === 'delete') {
                // Delete task again
                appData.tasks = appData.tasks.filter(task => task.id !== action.oldData.id);
            } else if (action.type === 'toggle') {
                // Apply completion status
                const taskIndex = appData.tasks.findIndex(task => task.id === action.newData.id);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex].completed = action.newData.completed;
                }
            } else if (action.type === 'batch-complete') {
                // Apply completion status for batch
                action.tasks.forEach(taskData => {
                    const taskIndex = appData.tasks.findIndex(task => task.id === taskData.id);
                    if (taskIndex !== -1) {
                        appData.tasks[taskIndex].completed = true;
                    }
                });
            } else if (action.type === 'batch-delete') {
                // Delete tasks again
                const taskIds = action.tasks.map(task => task.id);
                appData.tasks = appData.tasks.filter(task => !taskIds.includes(task.id));
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            updateUndoRedoButtons();
            
            showToast('Action redone', 'info');
        }
        
        // Batch complete selected tasks
        function batchCompleteSelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            const taskIds = Array.from(checkboxes).map(checkbox => checkbox.value);
            const tasksToUpdate = [];
            
            // Store old data for undo
            taskIds.forEach(taskId => {
                const task = appData.tasks.find(task => task.id === taskId);
                if (task && !task.completed) {
                    tasksToUpdate.push({ ...task });
                }
            });
            
            if (tasksToUpdate.length === 0) {
                showToast('All selected tasks are already completed', 'info');
                return;
            }
            
            // Add to undo stack
            addToUndoStack({
                type: 'batch-complete',
                tasks: tasksToUpdate
            });
            
            // Update tasks
            tasksToUpdate.forEach(taskData => {
                const taskIndex = appData.tasks.findIndex(task => task.id === taskData.id);
                if (taskIndex !== -1) {
                    appData.tasks[taskIndex].completed = true;
                    appData.tasks[taskIndex].updatedAt = new Date().toISOString();
                }
            });
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            
            showToast(`${tasksToUpdate.length} tasks marked as completed`, 'success');
            
            // Add notification
            addNotification({
                type: 'task',
                message: `${tasksToUpdate.length} tasks have been marked as completed.`,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            // Hide multi-select bar
            cancelMultiSelect();
        }
        
        // Batch delete selected tasks
        function batchDeleteSelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            const taskIds = Array.from(checkboxes).map(checkbox => checkbox.value);
            const tasksToDelete = [];
            
            // Store data for undo
            taskIds.forEach(taskId => {
                const task = appData.tasks.find(task => task.id === taskId);
                if (task) {
                    tasksToDelete.push({ ...task });
                }
            });
            
            // Add to undo stack
            addToUndoStack({
                type: 'batch-delete',
                tasks: tasksToDelete
            });
            
            // Delete tasks
            appData.tasks = appData.tasks.filter(task => !taskIds.includes(task.id));
            
            // If any task was being timed, stop timer
            if (appData.activeTaskId && taskIds.includes(appData.activeTaskId)) {
                pauseTaskTimer();
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            updateTaskCounts();
            renderTasks();
            updateInsights();
            
            showToast(`${tasksToDelete.length} tasks deleted`, 'success');
            
            // Add notification
            addNotification({
                type: 'task',
                message: `${tasksToDelete.length} tasks have been deleted.`,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            // Hide multi-select bar
            cancelMultiSelect();
        }
        
        // Cancel multi-select
        function cancelMultiSelect() {
            // Uncheck all checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Hide multi-select bar
            document.getElementById('multi-select-bar').classList.remove('active');
            
            // Update selected count
            document.getElementById('selected-count').textContent = '0 selected';
        }
        
        // Update selected count
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            const count = checkboxes.length;
            
            document.getElementById('selected-count').textContent = `${count} selected`;
            
            if (count > 0) {
                document.getElementById('multi-select-bar').classList.add('active');
            } else {
                document.getElementById('multi-select-bar').classList.remove('active');
            }
        }
        
        // Update task counts
        function updateTaskCounts() {
            const totalCount = appData.tasks.length;
            const completedCount = appData.tasks.filter(task => task.completed).length;
            const pendingCount = totalCount - completedCount;
            
            document.getElementById('total-task-count').textContent = totalCount;
            document.getElementById('completed-task-count').textContent = completedCount;
            document.getElementById('pending-task-count').textContent = pendingCount;
        }
        
        // Render tasks based on filters and sort
        function renderTasks() {
            const tasksContainer = document.getElementById('tasks-container');
            const noTasks = document.getElementById('no-tasks');
            
            // Get filter values
            const searchQuery = document.getElementById('task-search').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const dueDateFilter = document.getElementById('due-date-filter').value;
            const sortBy = document.getElementById('sort-by').value;
            
            // Apply filters
            let filteredTasks = [...appData.tasks];
            
            // Search filter
            if (searchQuery) {
                filteredTasks = filteredTasks.filter(task => 
                    task.title.toLowerCase().includes(searchQuery) || 
                    (task.description && task.description.toLowerCase().includes(searchQuery))
                );
            }
            
            // Status filter
            if (statusFilter === 'active') {
                filteredTasks = filteredTasks.filter(task => !task.completed);
            } else if (statusFilter === 'completed') {
                filteredTasks = filteredTasks.filter(task => task.completed);
            }
            
            // Category filter
            if (categoryFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.category === categoryFilter);
            }
            
            // Due date filter
            if (dueDateFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const nextWeek = new Date(today);
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const nextMonth = new Date(today);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                
                if (dueDateFilter === 'today') {
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= today && dueDate < tomorrow;
                    });
                } else if (dueDateFilter === 'week') {
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= today && dueDate < nextWeek;
                    });
                } else if (dueDateFilter === 'month') {
                    filteredTasks = filteredTasks.filter(task => {
                        const dueDate = new Date(task.dueDate);
                        return dueDate >= today && dueDate < nextMonth;
                    });
                } else if (dueDateFilter === 'custom') {
                    const startDateStr = document.getElementById('date-range-start').value;
                    const endDateStr = document.getElementById('date-range-end').value;
                    
                    if (startDateStr && endDateStr) {
                        const startDate = new Date(startDateStr);
                        startDate.setHours(0, 0, 0, 0);
                        
                        const endDate = new Date(endDateStr);
                        endDate.setHours(23, 59, 59, 999);
                        
                        filteredTasks = filteredTasks.filter(task => {
                            const dueDate = new Date(task.dueDate);
                            return dueDate >= startDate && dueDate <= endDate;
                        });
                    }
                }
            }
            
            // Sort tasks
            if (sortBy === 'dueDate-asc') {
                filteredTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            } else if (sortBy === 'dueDate-desc') {
                filteredTasks.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
            } else if (sortBy === 'title-asc') {
                filteredTasks.sort((a, b) => a.title.localeCompare(b.title));
            } else if (sortBy === 'title-desc') {
                filteredTasks.sort((a, b) => b.title.localeCompare(a.title));
            } else if (sortBy === 'priority-asc') {
                const priorityOrder = { low: 1, medium: 2, high: 3 };
                filteredTasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            } else if (sortBy === 'priority-desc') {
                const priorityOrder = { low: 1, medium: 2, high: 3 };
                filteredTasks.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            }
            
            // Clear tasks container
            tasksContainer.innerHTML = '';
            
            // Show no tasks message if no tasks match filters
            if (filteredTasks.length === 0) {
                tasksContainer.appendChild(noTasks);
                return;
            }
            
            // Render tasks
            filteredTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                tasksContainer.appendChild(taskElement);
            });
            
            // Setup drag and drop
            setupDragAndDrop();
        }
        
        // Create task element
        function createTaskElement(task) {
            const now = new Date();
            const dueDate = new Date(task.dueDate);
            const timeDiff = dueDate - now;
            const hoursRemaining = timeDiff / (1000 * 60 * 60);
            
            let statusClass = '';
            if (dueDate < now) {
                statusClass = 'status-expired';
            } else if (hoursRemaining <= 48) {
                statusClass = 'status-due-soon';
            } else {
                statusClass = 'status-ok';
            }
            
            let priorityClass = '';
            if (task.priority === 'high') {
                priorityClass = 'priority-high';
            } else if (task.priority === 'medium') {
                priorityClass = 'priority-medium';
            } else {
                priorityClass = 'priority-low';
            }
            
            const taskElement = document.createElement('div');
            taskElement.className = `task-item py-4 px-4 ${statusClass} ${priorityClass} ${task.completed ? 'bg-green-50 dark:bg-green-900 dark:bg-opacity-20' : ''}`;
            taskElement.setAttribute('data-id', task.id);
            taskElement.setAttribute('draggable', 'true');
            
            // Create task content
            taskElement.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 pt-1">
                        <label class="fancy-checkbox">
                            <input type="checkbox" class="task-checkbox" value="${task.id}" ${task.completed ? 'checked' : ''}>
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    
                    <div class="ml-3 flex-grow">
                        <div class="flex flex-wrap items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold mb-1 ${task.completed ? 'line-through text-gray-500 dark:text-gray-400' : ''}">${task.title}</h3>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2 ${task.completed ? 'line-through' : ''}">
                                    ${task.description ? task.description.substring(0, 100) + (task.description.length > 100 ? '...' : '') : 'No description'}
                                </div>
                                
                                <div class="flex flex-wrap items-center text-xs text-gray-500 dark:text-gray-400 gap-x-3 gap-y-1">
                                    <div class="flex items-center">
                                        <i class="far fa-clock mr-1"></i>
                                        <span class="${dueDate < now ? 'text-danger' : (hoursRemaining <= 48 ? 'text-warning' : '')}">
                                            ${formatDate(task.dueDate)}
                                        </span>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <i class="fas fa-tag mr-1"></i>
                                        <span>${task.category}</span>
                                    </div>
                                    
                                    <div class="flex items-center">
                                        <i class="fas fa-hourglass-half mr-1"></i>
                                        <span id="task-timer-${task.id}">${formatTime(task.timeSpent)}</span>
                                    </div>
                                    
                                    ${task.subtasks && task.subtasks.length > 0 ? 
                                        `<div class="flex items-center">
                                            <i class="fas fa-tasks mr-1"></i>
                                            <span>${task.subtasks.length} subtask${task.subtasks.length > 1 ? 's' : ''}</span>
                                        </div>` : ''}
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap items-center mt-1 sm:mt-0 gap-2">
                                <label class="toggle-switch">
                                    <input type="checkbox" class="task-toggle" ${task.completed ? 'checked' : ''} data-id="${task.id}">
                                    <span class="toggle-slider"></span>
                                </label>
                                
                                <div class="flex">
                                    <button class="p-2 text-info hover:text-opacity-80" onclick="openViewTaskPopup('${task.id}')">
                                        <i class="far fa-eye"></i>
                                    </button>
                                    
                                    <button class="p-2 text-primary hover:text-opacity-80" onclick="openEditTaskPopup('${task.id}')">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    
                                    <button class="p-2 text-danger hover:text-opacity-80" onclick="deleteTask('${task.id}')">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                    
                                    <button id="task-play-${task.id}" class="p-2 text-success hover:text-opacity-80 ${appData.activeTaskId === task.id ? 'hidden' : ''}" onclick="toggleTaskTimer('${task.id}')">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    
                                    <button id="task-pause-${task.id}" class="p-2 text-warning hover:text-opacity-80 ${appData.activeTaskId !== task.id ? 'hidden' : ''}" onclick="toggleTaskTimer('${task.id}')">
                                        <i class="fas fa-pause"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listeners
            taskElement.querySelector('.task-checkbox').addEventListener('change', () => {
                updateSelectedCount();
            });
            
            taskElement.querySelector('.task-toggle').addEventListener('change', (e) => {
                toggleTaskCompletion(task.id);
            });
            
            return taskElement;
        }
        
        // Setup drag and drop functionality
        function setupDragAndDrop() {
            const taskItems = document.querySelectorAll('.task-item');
            
            taskItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }
        
        // Handle drag start
        function handleDragStart(e) {
            this.classList.add('task-dragging');
            e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
        }
        
        // Handle drag over
        function handleDragOver(e) {
            e.preventDefault();
        }
        
        // Handle drag enter
        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }
        
        // Handle drag leave
        function handleDragLeave() {
            this.classList.remove('drag-over');
        }
        
        // Handle drop
        function handleDrop(e) {
            e.preventDefault();
            
            const draggedId = e.dataTransfer.getData('text/plain');
            const dropId = this.getAttribute('data-id');
            
            if (draggedId === dropId) {
                this.classList.remove('drag-over');
                return;
            }
            
            // Get task indices
            const tasks = [...appData.tasks];
            const draggedIndex = tasks.findIndex(task => task.id === draggedId);
            const dropIndex = tasks.findIndex(task => task.id === dropId);
            
            if (draggedIndex === -1 || dropIndex === -1) {
                this.classList.remove('drag-over');
                return;
            }
            
            // Remove dragged task from array
            const draggedTask = tasks.splice(draggedIndex, 1)[0];
            
            // Insert task at drop position
            tasks.splice(dropIndex, 0, draggedTask);
            
            // Update tasks array
            appData.tasks = tasks;
            
            // Update UI
            renderTasks();
            
            this.classList.remove('drag-over');
        }
        
        // Handle drag end
        function handleDragEnd() {
            this.classList.remove('task-dragging');
            document.querySelectorAll('.drag-over').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        // Update insights
        function updateInsights() {
            // Productivity score
            const totalTasks = appData.tasks.length;
            const completedTasks = appData.tasks.filter(task => task.completed).length;
            const productivityScore = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('productivity-score').textContent = `${productivityScore}%`;
            document.getElementById('productivity-bar').style.width = `${productivityScore}%`;
            
            // Total time tracked
            const totalTimeTracked = appData.tasks.reduce((total, task) => total + task.timeSpent, 0);
            document.getElementById('total-time-tracked').textContent = formatTime(totalTimeTracked);
            
            // Urgent tasks
            const highPriorityTasks = appData.tasks.filter(task => 
                task.priority === 'high' && !task.completed
            );
            
            document.getElementById('urgent-tasks-count').textContent = highPriorityTasks.length;
            
            if (highPriorityTasks.length > 0) {
                // Sort by due date
                highPriorityTasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                const nextDueDate = new Date(highPriorityTasks[0].dueDate);
                const timeRemaining = nextDueDate - new Date();
                
                if (timeRemaining < 0) {
                    document.getElementById('urgent-tasks-due').textContent = 'Overdue tasks!';
                } else {
                    const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                    
                    if (days === 0) {
                        document.getElementById('urgent-tasks-due').textContent = 'Due today!';
                    } else if (days === 1) {
                        document.getElementById('urgent-tasks-due').textContent = 'Due tomorrow';
                    } else {
                        document.getElementById('urgent-tasks-due').textContent = `Due in ${days} days`;
                    }
                }
            } else {
                document.getElementById('urgent-tasks-due').textContent = 'No urgent tasks';
            }
            
            // Most active category
            const categories = {};
            appData.tasks.forEach(task => {
                if (!categories[task.category]) {
                    categories[task.category] = 0;
                }
                categories[task.category]++;
            });
            
            if (Object.keys(categories).length > 0) {
                const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);
                const mostActiveCategory = sortedCategories[0];
                
                document.getElementById('most-active-category').textContent = mostActiveCategory[0];
                document.getElementById('most-active-category-count').textContent = `${mostActiveCategory[1]} task${mostActiveCategory[1] > 1 ? 's' : ''}`;
            } else {
                document.getElementById('most-active-category').textContent = '-';
                document.getElementById('most-active-category-count').textContent = 'No tasks yet';
            }
        }
        
        // Add notification
        function addNotification(notification) {
            appData.notifications.unshift(notification);
            
            // Limit to 50 notifications
            if (appData.notifications.length > 50) {
                appData.notifications = appData.notifications.slice(0, 50);
            }
            
            // Save to storage
            saveDataToStorage();
            
            // Update badge
            updateNotificationBadge();
            
            // Show toast for task notifications
            if (notification.type === 'task') {
                showToast(notification.message, 'info');
            }
        }
        
        // Update notification badge
        function updateNotificationBadge() {
            const unreadCount = appData.notifications.filter(notification => !notification.read).length;
            const badge = document.getElementById('notification-badge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Render notifications
        function renderNotifications() {
            const notificationList = document.getElementById('notification-list');
            const emptyNotification = document.querySelector('.notification-empty');
            
            // Clear list
            notificationList.innerHTML = '';
            
            if (appData.notifications.length === 0) {
                notificationList.appendChild(emptyNotification);
                return;
            } else {
                if (emptyNotification) {
                    notificationList.removeChild(emptyNotification);
                }
            }
            
            // Add notifications
            appData.notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-4 ${notification.read ? 'bg-gray-50 dark:bg-gray-800' : 'bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20'}`;
                
                let icon = '';
                if (notification.type === 'task') {
                    icon = '<i class="fas fa-tasks text-primary mr-2"></i>';
                } else {
                    icon = '<i class="fas fa-bell text-info mr-2"></i>';
                }
                
                const timeAgo = formatTimeAgo(new Date(notification.timestamp));
                
                notificationItem.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="ml-2 flex-grow">
                            <p class="text-sm">${notification.message}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${timeAgo}</p>
                        </div>
                        ${!notification.read ? `
                            <button class="mark-read-btn text-xs text-primary hover:underline" data-index="${appData.notifications.indexOf(notification)}">
                                Mark as read
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // Add event listener for mark as read
                const markReadBtn = notificationItem.querySelector('.mark-read-btn');
                if (markReadBtn) {
                    markReadBtn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        markNotificationAsRead(index);
                    });
                }
                
                // Make notification clickable to view task if it has a task ID
                if (notification.taskId) {
                    notificationItem.classList.add('cursor-pointer');
                    notificationItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('mark-read-btn')) {
                            openViewTaskPopup(notification.taskId);
                            
                            // Mark as read
                            const index = appData.notifications.indexOf(notification);
                            if (index !== -1) {
                                markNotificationAsRead(index);
                            }
                        }
                    });
                }
                
                notificationList.appendChild(notificationItem);
            });
        }
        
        // Mark notification as read
        function markNotificationAsRead(index) {
            if (index >= 0 && index < appData.notifications.length) {
                appData.notifications[index].read = true;
                
                // Save to storage
                saveDataToStorage();
                
                // Update UI
                renderNotifications();
                updateNotificationBadge();
            }
        }
        
        // Mark all notifications as read
        function markAllNotificationsAsRead() {
            appData.notifications.forEach(notification => {
                notification.read = true;
            });
            
            // Save to storage
            saveDataToStorage();
            
            // Update UI
            renderNotifications();
            updateNotificationBadge();
            
            showToast('All notifications marked as read', 'success');
        }
        
        // Generate initial categories
        function generateInitialCategories() {
            const defaultCategories = [
                { id: generateId(), name: 'Work' },
                { id: generateId(), name: 'Personal' },
                { id: generateId(), name: 'Shopping' },
                { id: generateId(), name: 'Health' },
                { id: generateId(), name: 'Finance' },
                { id: generateId(), name: 'Learning' }
            ];
            
            appData.categories = defaultCategories;
            saveDataToStorage();
            updateCategoryDropdowns();
        }
        
        // Generate random users
        function generateRandomUsers(count) {
            const firstNames = ['John', 'Jane', 'Mike', 'Sarah', 'David', 'Emily', 'Alex', 'Jessica', 'Chris', 'Amanda'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis', 'Garcia', 'Rodriguez', 'Wilson'];
            const roles = ['Manager', 'Staff', 'Customer', 'Admin'];
            const countries = ['USA', 'Canada', 'UK', 'Australia', 'Germany', 'France', 'Japan', 'India', 'Brazil', 'Spain'];
            
            for (let i = 0; i < count; i++) {
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`;
                const role = roles[Math.floor(Math.random() * roles.length)];
                const nationality = countries[Math.floor(Math.random() * countries.length)];
                
                appData.users.push({
                    id: generateId(),
                    firstName,
                    lastName,
                    email,
                    password: '123456',
                    birthdate: `${1970 + Math.floor(Math.random() * 30)}-${String(1 + Math.floor(Math.random() * 12)).padStart(2, '0')}-${String(1 + Math.floor(Math.random() * 28)).padStart(2, '0')}`,
                    nationality,
                    role,
                    profileImage: getRandomProfileImage(),
                    joinedDate: new Date(Date.now() - Math.floor(Math.random() * 365 * 24 * 60 * 60 * 1000)).toISOString()
                });
            }
            
            saveDataToStorage();
        }
        
        // Get random profile image
        function getRandomProfileImage() {
            // Use a consistent seed for each user to get the same image
            const seed = Math.floor(Math.random() * 1000);
            return `https://picsum.photos/seed/${seed}/200`;
        }
        
        // Generate random tasks
        function generateRandomTasks(count) {
            const titles = [
                'Complete project proposal',
                'Review marketing strategy',
                'Prepare for client meeting',
                'Update website content',
                'Fix bug in login system',
                'Schedule team building event',
                'Research new technologies',
                'Develop new feature',
                'Create weekly report',
                'Update social media profiles',
                'Organize files and documents',
                'Call customer support',
                'Pay monthly bills',
                'Schedule dentist appointment',
                'Buy groceries',
                'Clean the house',
                'Exercise for 30 minutes',
                'Read a book chapter',
                'Plan weekend trip',
                'Learn a new skill'
            ];
            
            const descriptions = [
                'This task requires careful planning and attention to detail.',
                'Coordinate with the team to ensure everyone is on the same page.',
                'Gather all necessary information before proceeding.',
                'Make sure to follow the established guidelines.',
                'This is a high-priority task that needs immediate attention.',
                'Regular updates are required for this ongoing task.',
                'Use the new tools we discussed in the last meeting.',
                'Remember to document the process for future reference.',
                'Check with the stakeholders before finalizing.',
                'This should take approximately 2-3 hours to complete.',
                'Set up a meeting to discuss the details with the team.',
                'Create a backup before making any changes.',
                'This is part of the quarterly objectives.',
                'The deadline was set by management and cannot be changed.',
                'Feel free to delegate subtasks if needed.'
            ];
            
            const priorities = ['low', 'medium', 'high'];
            
            const notes = [
                'Remember to include all stakeholders in the discussion.',
                'The client specifically requested this feature.',
                'Previous attempts to implement this were unsuccessful.',
                'This is related to the Q4 objectives.',
                'There might be some technical challenges to overcome.',
                'We already have some documentation on this.',
                'This is a recurring task that happens every month.',
                'Check previous examples for reference.',
                'Make sure to follow up after completion.',
                'This is part of the new initiative.'
            ];
            
            const subtasks = [
                'Research background information',
                'Draft initial document',
                'Get feedback from team',
                'Revise based on feedback',
                'Prepare final version',
                'Share with stakeholders',
                'Create presentation slides',
                'Test functionality',
                'Write documentation',
                'Schedule follow-up meeting',
                'Send email notification',
                'Update project tracking',
                'Archive relevant files',
                'Collect user input',
                'Monitor results',
                'Create backup',
                'Verify data integrity',
                'Run quality checks',
                'Evaluate performance',
                'Plan next steps'
            ];
            
            for (let i = 0; i < count; i++) {
                // Generate random due date between now and 30 days from now
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + Math.floor(Math.random() * 30));
                
                // Generate random created date before due date
                const createdDate = new Date(dueDate);
                createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 14) - 1);
                
                // Randomly select category
                const categoryIndex = Math.floor(Math.random() * appData.categories.length);
                const category = appData.categories[categoryIndex].name;
                
                // Randomly set completion status
                const completed = Math.random() > 0.7;
                
                // Generate random subtasks (0-3)
                const taskSubtasks = [];
                const subtaskCount = Math.floor(Math.random() * 4);
                for (let j = 0; j < subtaskCount; j++) {
                    // Avoid duplicate subtasks
                    let subtask;
                    do {
                        subtask = subtasks[Math.floor(Math.random() * subtasks.length)];
                    } while (taskSubtasks.includes(subtask));
                    
                    taskSubtasks.push(subtask);
                }
                
                // Generate random time spent (0-3 hours in seconds)
                const timeSpent = Math.floor(Math.random() * 10800);
                
                // Create task
                appData.tasks.push({
                    id: generateId(),
                    title: titles[Math.floor(Math.random() * titles.length)],
                    description: descriptions[Math.floor(Math.random() * descriptions.length)],
                    dueDate: dueDate.toISOString(),
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    category,
                    notes: Math.random() > 0.5 ? notes[Math.floor(Math.random() * notes.length)] : '',
                    subtasks: taskSubtasks,
                    completed,
                    timeSpent,
                    createdAt: createdDate.toISOString(),
                    updatedAt: createdDate.toISOString()
                });
            }
            
            saveDataToStorage();
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            // Set background color based on type
            if (type === 'success') {
                toast.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
            } else if (type === 'error') {
                toast.style.backgroundColor = 'rgba(220, 53, 69, 0.9)';
            } else if (type === 'warning') {
                toast.style.backgroundColor = 'rgba(255, 193, 7, 0.9)';
                toast.style.color = '#343a40';
            }
            
            // Set content
            toast.textContent = message;
            
            // Add to container
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide and remove toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 5000);
        }
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = date - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `Overdue (${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} ago)`;
            } else if (diffDays === 0) {
                // Check if it's today but in the future (hours remaining)
                if (diffTime > 0) {
                    const hours = Math.ceil(diffTime / (1000 * 60 * 60));
                    if (hours < 24) {
                        return `Today (${hours} hour${hours !== 1 ? 's' : ''} left)`;
                    }
                }
                return 'Today';
            } else if (diffDays === 1) {
                return 'Tomorrow';
            } else if (diffDays < 7) {
                return `In ${diffDays} days`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffTime = now - date;
            const diffSeconds = Math.floor(diffTime / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSeconds < 60) {
                return 'Just now';
            } else if (diffMinutes < 60) {
                return `${diffMinutes} minute${diffMinutes !== 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Debounce function to prevent too many executions
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Make functions available globally
        window.openViewTaskPopup = openViewTaskPopup;
        window.openEditTaskPopup = openEditTaskPopup;
        window.deleteTask = deleteTask;
        window.toggleTaskTimer = toggleTaskTimer;
    </script>
</body>
</html>
